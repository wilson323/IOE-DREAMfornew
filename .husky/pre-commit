#!/bin/sh
# Pre-commit hook
# åœ¨æäº¤å‰æ‰§è¡Œè´¨é‡æ£€æŸ¥

set -e

echo "ğŸ” Pre-commit è´¨é‡æ£€æŸ¥å¼€å§‹..."

# 1. è¿è¡Œè´¨é‡é—¨ç¦æ£€æŸ¥
node scripts/quality-gate.js

# 2. è¿è¡ŒESLint
if [ -f "package.json" ] && command -v npm &> /dev/null; then
    echo "ğŸ” è¿è¡ŒESLintæ£€æŸ¥..."
    npm run lint
fi

# 3. è¿è¡Œæ ¼å¼åŒ–æ£€æŸ¥
if command -v prettier &> /dev/null; then
    echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
    npx prettier --check .
fi

# 4. è¿è¡Œå•å…ƒæµ‹è¯•
if [ -f "package.json" ] && npm run test &> /dev/null; then
    echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    npm run test
fi

# 5. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé˜²æ­¢æ„å¤–æäº¤å¤§æ–‡ä»¶ï¼‰
echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶å¤§å°..."
MAX_FILE_SIZE=$((10 * 1024 * 1024)) # 10MB
large_files=$(find . -type f -size +${MAX_FILE_SIZE}c -not -path "./node_modules/*" -not -path "./.git/*")

if [ ! -z "$large_files" ]; then
    echo "âŒ å‘ç°å¤§æ–‡ä»¶:"
    echo "$large_files"
    echo "è¯·ç§»é™¤æˆ–æ·»åŠ åˆ°.gitignore"
    exit 1
fi

echo "âœ… Pre-commit æ£€æŸ¥é€šè¿‡ï¼"