<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.enterprise.file.dao.FileDao">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="net.lab1024.sa.enterprise.file.entity.FileEntity">
        <id column="file_id" property="fileId" />
        <result column="file_name" property="fileName" />
        <result column="original_filename" property="originalFilename" />
        <result column="file_path" property="filePath" />
        <result column="file_size" property="fileSize" />
        <result column="file_type" property="fileType" />
        <result column="file_extension" property="fileExtension" />
        <result column="file_md5" property="fileMd5" />
        <result column="storage_type" property="storageType" />
        <result column="bucket_name" property="bucketName" />
        <result column="file_url" property="fileUrl" />
        <result column="thumbnail_url" property="thumbnailUrl" />
        <result column="upload_user_id" property="uploadUserId" />
        <result column="upload_user_name" property="uploadUserName" />
        <result column="business_module" property="businessModule" />
        <result column="business_id" property="businessId" />
        <result column="file_status" property="fileStatus" />
        <result column="download_count" property="downloadCount" />
        <result column="last_download_time" property="lastDownloadTime" />
        <result column="expire_time" property="expireTime" />
        <result column="is_public" property="isPublic" />
        <result column="file_description" property="fileDescription" />
        <result column="tags" property="tags" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="create_by" property="createBy" />
        <result column="update_by" property="updateBy" />
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        file_id, file_name, original_filename, file_path, file_size, file_type, file_extension,
        file_md5, storage_type, bucket_name, file_url, thumbnail_url, upload_user_id, upload_user_name,
        business_module, business_id, file_status, download_count, last_download_time, expire_time,
        is_public, file_description, tags, create_time, update_time, create_by, update_by
    </sql>

    <!-- 根据MD5查询文件 -->
    <select id="selectByMd5" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM file_info
        WHERE file_md5 = #{fileMd5}
        AND file_status = #{fileStatus}
        LIMIT 1
    </select>

    <!-- 更新下载次数 -->
    <update id="updateDownloadCount">
        UPDATE file_info
        SET download_count = #{downloadCount},
            last_download_time = #{lastDownloadTime}
        WHERE file_id = #{fileId}
    </update>

    <!-- 根据业务模块和业务ID查询文件列表 -->
    <select id="selectByBusiness" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM file_info
        WHERE business_module = #{businessModule}
        <if test="businessId != null and businessId != ''">
            AND business_id = #{businessId}
        </if>
        AND file_status = #{fileStatus}
        ORDER BY create_time DESC
    </select>

    <!-- 根据上传用户查询文件列表 -->
    <select id="selectByUploadUser" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM file_info
        WHERE upload_user_id = #{uploadUserId}
        AND file_status = #{fileStatus}
        ORDER BY create_time DESC
    </select>

    <!-- 批量更新文件状态 -->
    <update id="batchUpdateStatus">
        UPDATE file_info
        SET file_status = #{fileStatus},
            update_time = NOW()
        WHERE file_id IN
        <foreach collection="fileIds" item="fileId" open="(" separator="," close=")">
            #{fileId}
        </foreach>
    </update>

    <!-- 查询过期文件 -->
    <select id="selectExpiredFiles" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM file_info
        WHERE expire_time &lt;= #{currentTime}
        AND file_status = 0
        ORDER BY expire_time ASC
    </select>

    <!-- 根据文件类型查询文件列表 -->
    <select id="selectByFileType" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List" />
        FROM file_info
        WHERE file_type = #{fileType}
        AND file_status = #{fileStatus}
        ORDER BY create_time DESC
    </select>

</mapper>