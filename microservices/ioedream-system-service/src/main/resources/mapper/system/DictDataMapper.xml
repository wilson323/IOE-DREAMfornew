<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.system.dict.dao.DictDataDao">

    <!-- 字典数据结果映射 -->
    <resultMap id="DictDataResult" type="net.lab1024.sa.system.dict.domain.entity.DictDataEntity">
        <id column="dict_data_id" property="dictDataId"/>
        <result column="dict_type_id" property="dictTypeId"/>
        <result column="dict_label" property="dictLabel"/>
        <result column="dict_value" property="dictValue"/>
        <result column="dict_sort" property="dictSort"/>
        <result column="is_default" property="isDefault"/>
        <result column="remark" property="remark"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="update_user_id" property="updateUserId"/>
        <result column="deleted_flag" property="deletedFlag"/>
    </resultMap>

    <!-- 字典数据关联查询结果映射 -->
    <resultMap id="DictDataWithTypeResult" type="map">
        <id column="dict_data_id" property="dictDataId"/>
        <result column="dict_type_id" property="dictTypeId"/>
        <result column="dict_type_code" property="dictTypeCode"/>
        <result column="dict_type_name" property="dictTypeName"/>
        <result column="dict_label" property="dictLabel"/>
        <result column="dict_value" property="dictValue"/>
        <result column="dict_sort" property="dictSort"/>
        <result column="is_default" property="isDefault"/>
        <result column="status" property="status"/>
    </resultMap>

    <!-- 通用查询条件 -->
    <sql id="selectDictDataVo">
        SELECT dict_data_id,
               dict_type_id,
               dict_label,
               dict_value,
               dict_sort,
               is_default,
               remark,
               status,
               create_time,
               update_time,
               create_user_id,
               update_user_id,
               deleted_flag
        FROM t_sys_dict_data
        WHERE deleted_flag = 0
    </sql>

    <!-- 分页查询字典数据 -->
    <select id="selectDictDataPage" parameterType="map" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        <if test="query.dictTypeId != null">
            AND dict_type_id = #{query.dictTypeId}
        </if>
        <if test="query.dictTypeCode != null and query.dictTypeCode != ''">
            AND EXISTS (
                SELECT 1 FROM t_sys_dict_type t
                WHERE t.dict_type_id = dict_type_id
                  AND t.dict_type_code = #{query.dictTypeCode}
                  AND t.deleted_flag = 0
            )
        </if>
        <if test="query.dictLabel != null and query.dictLabel != ''">
            AND dict_label LIKE CONCAT('%', #{query.dictLabel}, '%')
        </if>
        <if test="query.dictValue != null and query.dictValue != ''">
            AND dict_value LIKE CONCAT('%', #{query.dictValue}, '%')
        </if>
        <if test="query.status != null">
            AND status = #{query.status}
        </if>
        <if test="query.isDefault != null">
            AND is_default = #{query.isDefault}
        </if>
        <if test="query.startTime != null and query.startTime != ''">
            AND create_time >= #{query.startTime}
        </if>
        <if test="query.endTime != null and query.endTime != ''">
            AND create_time <= #{query.endTime}
        </if>
        ORDER BY dict_type_id, dict_sort ASC, create_time DESC
    </select>

    <!-- 根据条件查询字典数据列表 -->
    <select id="selectDictDataList" parameterType="map" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        <if test="query.dictTypeId != null">
            AND dict_type_id = #{query.dictTypeId}
        </if>
        <if test="query.dictTypeCode != null and query.dictTypeCode != ''">
            AND EXISTS (
                SELECT 1 FROM t_sys_dict_type t
                WHERE t.dict_type_id = dict_type_id
                  AND t.dict_type_code = #{query.dictTypeCode}
                  AND t.deleted_flag = 0
            )
        </if>
        <if test="query.dictLabel != null and query.dictLabel != ''">
            AND dict_label LIKE CONCAT('%', #{query.dictLabel}, '%')
        </if>
        <if test="query.dictValue != null and query.dictValue != ''">
            AND dict_value = #{query.dictValue}
        </if>
        <if test="query.status != null">
            AND status = #{query.status}
        </if>
        ORDER BY dict_sort ASC, create_time DESC
    </select>

    <!-- 获取所有字典数据 -->
    <select id="selectAllDictData" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        ORDER BY dict_type_id, dict_sort ASC, create_time DESC
    </select>

    <!-- 根据ID查询字典数据详情 -->
    <select id="selectDictDataDetail" parameterType="long" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        AND dict_data_id = #{dictDataId}
    </select>

    <!-- 根据字典类型ID查询字典数据 -->
    <select id="selectByDictTypeId" parameterType="long" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        AND dict_type_id = #{dictTypeId}
        ORDER BY dict_sort ASC, create_time DESC
    </select>

    <!-- 根据字典类型编码查询字典数据 -->
    <select id="selectByDictTypeCode" parameterType="string" resultMap="DictDataResult">
        SELECT d.*
        FROM t_sys_dict_data d
        INNER JOIN t_sys_dict_type t ON d.dict_type_id = t.dict_type_id
        WHERE t.dict_type_code = #{dictTypeCode}
          AND d.deleted_flag = 0
          AND t.deleted_flag = 0
        ORDER BY d.dict_sort ASC, d.create_time DESC
    </select>

    <!-- 根据字典类型编码查询启用的字典数据 -->
    <select id="selectEnabledByDictTypeCode" parameterType="string" resultMap="DictDataResult">
        SELECT d.*
        FROM t_sys_dict_data d
        INNER JOIN t_sys_dict_type t ON d.dict_type_id = t.dict_type_id
        WHERE t.dict_type_code = #{dictTypeCode}
          AND d.status = 1
          AND d.deleted_flag = 0
          AND t.deleted_flag = 0
        ORDER BY d.dict_sort ASC, d.create_time DESC
    </select>

    <!-- 检查字典值在字典类型下是否唯一 -->
    <select id="checkDictValueUnique" resultType="int">
        SELECT COUNT(1)
        FROM t_sys_dict_data
        WHERE dict_type_id = #{dictTypeId}
          AND dict_value = #{dictValue}
          AND deleted_flag = 0
        <if test="excludeId != null">
            AND dict_data_id != #{excludeId}
        </if>
    </select>

    <!-- 修改字典数据状态 -->
    <update id="updateDictDataStatus">
        UPDATE t_sys_dict_data
        SET status = #{status},
            update_time = NOW(),
            update_user_id = #{userId}
        WHERE dict_data_id = #{dictDataId}
          AND deleted_flag = 0
    </update>

    <!-- 批量修改字典数据状态 -->
    <update id="batchUpdateDictDataStatus">
        UPDATE t_sys_dict_data
        SET status = #{status},
            update_time = NOW(),
            update_user_id = #{userId}
        WHERE dict_data_id IN
        <foreach collection="dictDataIds" item="dictDataId" open="(" separator="," close=")">
            #{dictDataId}
        </foreach>
          AND deleted_flag = 0
    </update>

    <!-- 统计字典数据数量 -->
    <select id="countDictData" resultType="long">
        SELECT COUNT(1)
        FROM t_sys_dict_data
        WHERE deleted_flag = 0
        <if test="query.dictTypeId != null">
            AND dict_type_id = #{query.dictTypeId}
        </if>
        <if test="query.dictTypeCode != null and query.dictTypeCode != ''">
            AND EXISTS (
                SELECT 1 FROM t_sys_dict_type t
                WHERE t.dict_type_id = dict_type_id
                  AND t.dict_type_code = #{query.dictTypeCode}
                  AND t.deleted_flag = 0
            )
        </if>
        <if test="query.dictLabel != null and query.dictLabel != ''">
            AND dict_label LIKE CONCAT('%', #{query.dictLabel}, '%')
        </if>
        <if test="query.dictValue != null and query.dictValue != ''">
            AND dict_value LIKE CONCAT('%', #{query.dictValue}, '%')
        </if>
        <if test="query.status != null">
            AND status = #{query.status}
        </if>
    </select>

    <!-- 获取字典数据统计信息 -->
    <select id="getDictDataStatistics" resultType="map">
        SELECT COUNT(1) AS totalCount,
               SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS enabledCount,
               SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) AS disabledCount,
               SUM(CASE WHEN is_default = 1 THEN 1 ELSE 0 END) AS defaultCount,
               COUNT(DISTINCT dict_type_id) AS typeCount
        FROM t_sys_dict_data
        WHERE deleted_flag = 0
    </select>

    <!-- 根据字典类型ID获取字典数据数量 -->
    <select id="countDictDataByTypeId" resultType="long">
        SELECT COUNT(1)
        FROM t_sys_dict_data
        WHERE dict_type_id = #{dictTypeId}
          AND deleted_flag = 0
    </select>

    <!-- 获取指定字典类型的默认值 -->
    <select id="selectDefaultByTypeId" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        AND dict_type_id = #{dictTypeId}
        AND is_default = 1
        LIMIT 1
    </select>

    <!-- 根据字典类型编码获取默认值 -->
    <select id="selectDefaultByTypeCode" resultMap="DictDataResult">
        SELECT d.*
        FROM t_sys_dict_data d
        INNER JOIN t_sys_dict_type t ON d.dict_type_id = t.dict_type_id
        WHERE t.dict_type_code = #{dictTypeCode}
          AND d.is_default = 1
          AND d.deleted_flag = 0
          AND t.deleted_flag = 0
        LIMIT 1
    </select>

    <!-- 根据状态查询字典数据 -->
    <select id="selectByStatus" parameterType="int" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        AND status = #{status}
        ORDER BY dict_sort ASC, create_time DESC
    </select>

    <!-- 根据字典值查询字典数据 -->
    <select id="selectByDictValue" parameterType="string" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        AND dict_value = #{dictValue}
        ORDER BY create_time DESC
        LIMIT 50
    </select>

    <!-- 根据字典标签模糊查询字典数据 -->
    <select id="selectByDictLabel" parameterType="string" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        AND dict_label LIKE CONCAT('%', #{dictLabel}, '%')
        ORDER BY create_time DESC
        LIMIT 50
    </select>

    <!-- 获取字典数据及其类型信息 -->
    <select id="selectDictDataWithType" resultMap="DictDataWithTypeResult">
        SELECT d.dict_data_id,
               d.dict_type_id,
               t.dict_type_code,
               t.dict_type_name,
               d.dict_label,
               d.dict_value,
               d.dict_sort,
               d.is_default,
               d.status
        FROM t_sys_dict_data d
        INNER JOIN t_sys_dict_type t ON d.dict_type_id = t.dict_type_id
        WHERE d.deleted_flag = 0
          AND t.deleted_flag = 0
        ORDER BY t.sort_order ASC, d.dict_sort ASC, d.create_time DESC
    </select>

    <!-- 批量插入字典数据 -->
    <insert id="batchInsertDictData" parameterType="list">
        INSERT INTO t_sys_dict_data (
            dict_type_id,
            dict_label,
            dict_value,
            dict_sort,
            is_default,
            remark,
            status,
            create_time,
            create_user_id
        ) VALUES
        <foreach collection="dictDataList" item="item" separator=",">
            (#{item.dictTypeId},
             #{item.dictLabel},
             #{item.dictValue},
             #{item.dictSort},
             #{item.isDefault},
             #{item.remark},
             #{item.status},
             NOW(),
             #{item.createUserId})
        </foreach>
    </insert>

    <!-- 批量更新字典数据 -->
    <update id="batchUpdateDictData" parameterType="list">
        <foreach collection="dictDataList" item="item" separator=";">
            UPDATE t_sys_dict_data
            SET dict_label = #{item.dictLabel},
                dict_value = #{item.dictValue},
                dict_sort = #{item.dictSort},
                is_default = #{item.isDefault},
                remark = #{item.remark},
                status = #{item.status},
                update_time = NOW(),
                update_user_id = #{item.updateUserId}
            WHERE dict_data_id = #{item.dictDataId}
              AND deleted_flag = 0
        </foreach>
    </update>

    <!-- 批量删除字典数据（逻辑删除） -->
    <update id="batchDeleteDictData">
        UPDATE t_sys_dict_data
        SET deleted_flag = 1,
            update_time = NOW(),
            update_user_id = #{userId}
        WHERE dict_data_id IN
        <foreach collection="dictDataIds" item="dictDataId" open="(" separator="," close=")">
            #{dictDataId}
        </foreach>
          AND deleted_flag = 0
    </update>

    <!-- 根据字典类型ID删除所有字典数据 -->
    <update id="deleteDictDataByTypeId">
        UPDATE t_sys_dict_data
        SET deleted_flag = 1,
            update_time = NOW(),
            update_user_id = #{userId}
        WHERE dict_type_id = #{dictTypeId}
          AND deleted_flag = 0
    </update>

    <!-- 获取最近的字典数据 -->
    <select id="selectRecentDictData" resultMap="DictDataResult">
        <include refid="selectDictDataVo"/>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 获取字典缓存数据 -->
    <select id="selectDictCacheData" resultType="map">
        SELECT t.dict_type_code,
               d.dict_value,
               d.dict_label,
               d.is_default
        FROM t_sys_dict_type t
        INNER JOIN t_sys_dict_data d ON t.dict_type_id = d.dict_type_id
        WHERE t.status = 1
          AND d.status = 1
          AND t.deleted_flag = 0
          AND d.deleted_flag = 0
        ORDER BY t.sort_order ASC, d.dict_sort ASC
    </select>

    <!-- 根据字典类型编码获取缓存数据 -->
    <select id="selectCacheDataByTypeCode" resultType="map">
        SELECT d.dict_value,
               d.dict_label,
               d.is_default
        FROM t_sys_dict_type t
        INNER JOIN t_sys_dict_data d ON t.dict_type_id = d.dict_type_id
        WHERE t.dict_type_code = #{dictTypeCode}
          AND t.status = 1
          AND d.status = 1
          AND t.deleted_flag = 0
          AND d.deleted_flag = 0
        ORDER BY d.dict_sort ASC
    </select>

    <!-- 导出字典数据 -->
    <select id="exportDictData" resultType="map">
        SELECT t.dict_type_code,
               t.dict_type_name,
               d.dict_label,
               d.dict_value,
               d.dict_sort,
               CASE d.is_default WHEN 1 THEN '是' ELSE '否' END AS is_default_name,
               CASE d.status WHEN 1 THEN '启用' ELSE '禁用' END AS status_name,
               d.remark,
               d.create_time,
               d.update_time
        FROM t_sys_dict_data d
        INNER JOIN t_sys_dict_type t ON d.dict_type_id = t.dict_type_id
        WHERE d.deleted_flag = 0
          AND t.deleted_flag = 0
        <if test="query.dictTypeId != null">
            AND d.dict_type_id = #{query.dictTypeId}
        </if>
        <if test="query.dictTypeCode != null and query.dictTypeCode != ''">
            AND t.dict_type_code = #{query.dictTypeCode}
        </if>
        <if test="query.dictLabel != null and query.dictLabel != ''">
            AND d.dict_label LIKE CONCAT('%', #{query.dictLabel}, '%')
        </if>
        <if test="query.dictValue != null and query.dictValue != ''">
            AND d.dict_value LIKE CONCAT('%', #{query.dictValue}, '%')
        </if>
        <if test="query.status != null">
            AND d.status = #{query.status}
        </if>
        ORDER BY t.sort_order ASC, d.dict_sort ASC, d.create_time DESC
    </select>

    <!-- 获取字典数据的排序号 -->
    <select id="getMaxSortOrder" resultType="integer">
        SELECT COALESCE(MAX(dict_sort), 0)
        FROM t_sys_dict_data
        WHERE dict_type_id = #{dictTypeId}
          AND deleted_flag = 0
    </select>

    <!-- 更新字典数据排序 -->
    <update id="updateSortOrder">
        UPDATE t_sys_dict_data
        SET dict_sort = #{sortOrder},
            update_time = NOW(),
            update_user_id = #{userId}
        WHERE dict_data_id = #{dictDataId}
          AND deleted_flag = 0
    </update>

    <!-- 批量更新排序 -->
    <update id="batchUpdateSortOrder">
        <foreach collection="sortUpdates" item="item" separator=";">
            UPDATE t_sys_dict_data
            SET dict_sort = #{item.sortOrder},
                update_time = NOW(),
                update_user_id = #{userId}
            WHERE dict_data_id = #{item.dictDataId}
              AND deleted_flag = 0
        </foreach>
    </update>

</mapper>