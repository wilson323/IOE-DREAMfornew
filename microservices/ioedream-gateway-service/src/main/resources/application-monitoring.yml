# ============================================================
# APMç›‘æ§é…ç½®æ–‡ä»¶
# 
# @Author:    IOE-DREAM Team
# @Date:      2025-12-05
# @Copyright  IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°
# 
# ç›‘æ§ç»„ä»¶ï¼š
# - Prometheusï¼ˆæŒ‡æ ‡æ”¶é›†ï¼‰
# - Grafanaï¼ˆå¯è§†åŒ–ï¼‰
# - Micrometerï¼ˆåº¦é‡åº“ï¼‰
# - Spring Boot Actuatorï¼ˆå¥åº·æ£€æŸ¥ï¼‰
# ============================================================

# ==================== Spring Boot Actuator ====================
management:
  endpoints:
    web:
      exposure:
        # æš´éœ²æ‰€æœ‰ç›‘æ§ç«¯ç‚¹
        include: '*'
      base-path: /actuator
      cors:
        allowed-origins: '*'
        allowed-methods: GET,POST
  
  endpoint:
    health:
      show-details: always  # æ˜¾ç¤ºè¯¦ç»†å¥åº·ä¿¡æ¯
      probes:
        enabled: true  # å¯ç”¨Kubernetesæ¢é’ˆ
    
    metrics:
      enabled: true
    
    prometheus:
      enabled: true
    
    info:
      enabled: true
  
  # å¥åº·æ£€æŸ¥é…ç½®
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
    redis:
      enabled: true
    db:
      enabled: true

  # ==================== Micrometer Prometheus ====================
  prometheus:
    metrics:
      export:
        enabled: true
        step: 10s  # é‡‡é›†é—´éš”
        descriptions: true
  
  # ==================== Micrometer Metricsé…ç½® ====================
  metrics:
    distribution:
      # HTTPè¯·æ±‚åˆ†å¸ƒç»Ÿè®¡
      percentiles-histogram:
        http.server.requests: true
      
      # ç™¾åˆ†ä½ç»Ÿè®¡ï¼ˆP50, P90, P95, P99ï¼‰
      percentiles:
        http.server.requests: 0.5, 0.9, 0.95, 0.99
      
      # SLAè¾¹ç•Œ
      sla:
        http.server.requests: 10ms, 50ms, 100ms, 200ms, 500ms, 1s, 2s
    
    tags:
      # å…¨å±€æ ‡ç­¾
      application: ${spring.application.name}
      environment: ${spring.profiles.active:dev}
      instance: ${HOSTNAME:localhost}
      region: ${REGION:cn-north-1}

# ==================== è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡ï¼ˆæ–‡æ¡£è¯´æ˜ï¼ŒéSpring Booté…ç½®ï¼‰ ====================
# æ³¨æ„ï¼šä»¥ä¸‹é…ç½®ä»…ä½œä¸ºä¸šåŠ¡æŒ‡æ ‡å®šä¹‰çš„æ–‡æ¡£è¯´æ˜ï¼Œä¸æ˜¯Spring Bootå®é™…ä½¿ç”¨çš„é…ç½®
# å®é™…ä¸šåŠ¡æŒ‡æ ‡åº”åœ¨ä»£ç ä¸­ä½¿ç”¨Micrometer APIæ³¨å†Œ
# metrics:
#   business:
#     enabled: true
#     
#     # é—¨ç¦æŒ‡æ ‡
#     access:
#       - name: access_total_count
#         description: é—¨ç¦é€šè¡Œæ€»æ•°
#         type: counter
#       
#       - name: access_success_rate
#         description: é—¨ç¦é€šè¡ŒæˆåŠŸç‡
#         type: gauge
#       
#       - name: access_response_time
#         description: é—¨ç¦å“åº”æ—¶é—´
#         type: timer
#     
#     # è€ƒå‹¤æŒ‡æ ‡
#     attendance:
#       - name: attendance_punch_count
#         description: è€ƒå‹¤æ‰“å¡æ€»æ•°
#         type: counter
#       
#       - name: attendance_late_count
#         description: è¿Ÿåˆ°äººæ•°
#         type: counter
#       
#       - name: attendance_leave_count
#         description: è¯·å‡äººæ•°
#         type: gauge
#     
#     # æ¶ˆè´¹æŒ‡æ ‡
#     consume:
#       - name: consume_transaction_count
#         description: æ¶ˆè´¹äº¤æ˜“æ€»æ•°
#         type: counter
#       
#       - name: consume_amount_total
#         description: æ¶ˆè´¹é‡‘é¢æ€»è®¡
#         type: counter
#       
#       - name: consume_avg_amount
#         description: å¹³å‡æ¶ˆè´¹é‡‘é¢
#         type: gauge
#       
#       - name: consume_success_rate
#         description: æ¶ˆè´¹æˆåŠŸç‡
#         type: gauge
#     
#     # è®¿å®¢æŒ‡æ ‡
#     visitor:
#       - name: visitor_appointment_count
#         description: è®¿å®¢é¢„çº¦æ•°
#         type: counter
#       
#       - name: visitor_checkin_count
#         description: è®¿å®¢ç­¾åˆ°æ•°
#         type: counter
#       
#       - name: visitor_onsite_count
#         description: å½“å‰åœ¨åœºè®¿å®¢æ•°
#         type: gauge

# ==================== å‘Šè­¦è§„åˆ™é…ç½®ï¼ˆæ–‡æ¡£è¯´æ˜ï¼ŒéSpring Booté…ç½®ï¼‰ ====================
# æ³¨æ„ï¼šä»¥ä¸‹é…ç½®ä»…ä½œä¸ºPrometheuså‘Šè­¦è§„åˆ™çš„æ–‡æ¡£è¯´æ˜ï¼Œå®é™…å‘Šè­¦è§„åˆ™åº”åœ¨Prometheusé…ç½®æ–‡ä»¶ä¸­å®šä¹‰
# alerting:
#   rules:
#     # ç³»ç»Ÿçº§å‘Šè­¦
#     - name: high_cpu_usage
#       expr: system_cpu_usage > 0.8
#       duration: 5m
#       severity: warning
#       message: "CPUä½¿ç”¨ç‡è¶…è¿‡80%"
#     
#     - name: high_memory_usage
#       expr: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.85
#       duration: 5m
#       severity: warning
#       message: "å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡85%"
#     
#     - name: high_gc_time
#       expr: jvm_gc_pause_seconds_sum > 1
#       duration: 1m
#       severity: critical
#       message: "GCæš‚åœæ—¶é—´è¶…è¿‡1ç§’"
#     
#     # ä¸šåŠ¡çº§å‘Šè­¦
#     - name: low_access_success_rate
#       expr: access_success_rate < 0.95
#       duration: 10m
#       severity: warning
#       message: "é—¨ç¦é€šè¡ŒæˆåŠŸç‡ä½äº95%"
#     
#     - name: high_consume_failure_rate
#       expr: (1 - consume_success_rate) > 0.05
#       duration: 5m
#       severity: warning
#       message: "æ¶ˆè´¹å¤±è´¥ç‡è¶…è¿‡5%"
#     
#     - name: slow_api_response
#       expr: http_server_requests_seconds_p99 > 2
#       duration: 5m
#       severity: warning
#       message: "API P99å“åº”æ—¶é—´è¶…è¿‡2ç§’"
#     
#     # æ•°æ®åº“å‘Šè­¦
#     - name: high_db_connection_usage
#       expr: hikaricp_connections_active / hikaricp_connections_max > 0.9
#       duration: 5m
#       severity: critical
#       message: "æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡90%"
#     
#     - name: slow_sql_query
#       expr: spring_data_repository_invocations_seconds_max > 5
#       duration: 1m
#       severity: warning
#       message: "SQLæŸ¥è¯¢è¶…è¿‡5ç§’"
#     
#     # Rediså‘Šè­¦
#     - name: redis_connection_failure
#       expr: up{job="redis"} == 0
#       duration: 1m
#       severity: critical
#       message: "Redisè¿æ¥å¤±è´¥"

# ==================== Grafanaä»ªè¡¨ç›˜é…ç½®ï¼ˆæ–‡æ¡£è¯´æ˜ï¼ŒéSpring Booté…ç½®ï¼‰ ====================
# æ³¨æ„ï¼šä»¥ä¸‹é…ç½®ä»…ä½œä¸ºGrafanaä»ªè¡¨ç›˜è®¾è®¡çš„æ–‡æ¡£è¯´æ˜ï¼Œå®é™…ä»ªè¡¨ç›˜åº”åœ¨Grafanaä¸­é…ç½®
# grafana:
#   dashboards:
#     # ç³»ç»Ÿç›‘æ§ä»ªè¡¨ç›˜
#     - name: system-overview
#       panels:
#         - title: CPUä½¿ç”¨ç‡
#           metric: system_cpu_usage
#           type: graph
#         
#         - title: å†…å­˜ä½¿ç”¨ç‡
#           metric: jvm_memory_used_bytes
#           type: graph
#         
#         - title: GCç»Ÿè®¡
#           metric: jvm_gc_pause_seconds_count
#           type: stat
#     
#     # ä¸šåŠ¡ç›‘æ§ä»ªè¡¨ç›˜
#     - name: business-metrics
#       panels:
#         - title: ä»Šæ—¥é€šè¡Œé‡
#           metric: access_total_count
#           type: stat
#         
#         - title: ä»Šæ—¥æ¶ˆè´¹é¢
#           metric: consume_amount_total
#           type: stat
#         
#         - title: åœ¨åœºè®¿å®¢æ•°
#           metric: visitor_onsite_count
#           type: gauge
#         
#         - title: APIå“åº”æ—¶é—´åˆ†å¸ƒ
#           metric: http_server_requests_seconds
#           type: heatmap

# ==================== æ—¥å¿—èšåˆé…ç½® ====================
logging:
  pattern:
    # ç»“æ„åŒ–æ—¥å¿—æ ¼å¼ï¼ˆJSONï¼‰
    console: '{"timestamp":"%d{yyyy-MM-dd HH:mm:ss.SSS}","level":"%level","thread":"%thread","logger":"%logger{36}","message":"%msg","traceId":"%X{traceId}","userId":"%X{userId}"}%n'
  
  level:
    root: INFO
    "net.lab1024.sa": DEBUG
    "org.springframework.web": DEBUG
    "org.hibernate.SQL": DEBUG
    
    # ç¬¬ä¸‰æ–¹åº“æ—¥å¿—çº§åˆ«
    com.alibaba: WARN
    io.lettuce: WARN

# ==================== é“¾è·¯è¿½è¸ªé…ç½®ï¼ˆå¯é€‰ï¼‰ ====================
# æ³¨æ„ï¼šSpring Boot 3.x ä½¿ç”¨ Micrometer Tracing æ›¿ä»£ Spring Cloud Sleuth
# é…ç½®åº”åœ¨ management èŠ‚ç‚¹ä¸‹ï¼Œè€Œä¸æ˜¯ spring èŠ‚ç‚¹ä¸‹
# management:
#   tracing:
#     enabled: true
#     sampling:
#       probability: 1.0  # 100%é‡‡æ ·ç‡
#   zipkin:
#     tracing:
#       endpoint: http://localhost:9411/api/v2/spans
#       enabled: false  # é»˜è®¤ç¦ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒå¼€å¯

# ==================== ç”Ÿäº§ç¯å¢ƒå»ºè®® ====================
# 
# ğŸ“Š Prometheuséƒ¨ç½²ï¼š
# docker run -d -p 9090:9090 \
#   -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
#   prom/prometheus
# 
# ğŸ“ˆ Grafanaéƒ¨ç½²ï¼š
# docker run -d -p 3000:3000 \
#   -e GF_SECURITY_ADMIN_PASSWORD=admin \
#   grafana/grafana
# 
# ğŸ” Zipkinéƒ¨ç½²ï¼ˆå¯é€‰ï¼‰ï¼š
# docker run -d -p 9411:9411 openzipkin/zipkin
# 
# ğŸ“ Prometheusé…ç½®ç¤ºä¾‹ï¼ˆprometheus.ymlï¼‰ï¼š
# scrape_configs:
#   - job_name: 'ioedream-services'
#     metrics_path: '/actuator/prometheus'
#     static_configs:
#       - targets:
#         - 'gateway:8080'
#         - 'common-service:8088'
#         - 'access-service:8090'
#         - 'attendance-service:8091'
#         - 'consume-service:8094'
# 
# ğŸ¨ Grafanaä»ªè¡¨ç›˜å¯¼å…¥ï¼š
# - JVM Micrometer Dashboard: ID 4701
# - Spring Boot Dashboard: ID 12900
# - è‡ªå®šä¹‰ä¸šåŠ¡ä»ªè¡¨ç›˜ï¼šä½¿ç”¨é¡¹ç›®æä¾›çš„JSONæ¨¡æ¿
# 
# ============================================================

