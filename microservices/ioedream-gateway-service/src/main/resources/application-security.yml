# =====================================================
# IOE-DREAM 安全配置
# 适用于Spring Boot 3.5.8 + Spring Security 6.4
# 企业级安全防护配置
# =====================================================

# ===========================================
# Spring Security 核心配置
# ===========================================
spring:
  security:
    # 用户配置
    user:
      name: ${SECURITY_ADMIN_USERNAME:admin}
      password: ${SECURITY_ADMIN_PASSWORD}
      roles: ADMIN

    # OAuth2资源配置
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI:http://localhost:8080}

  # 会话配置
  session:
    store-type: redis
    timeout: 1800 # 30分钟
    cookie:
      http-only: true
      secure: true
      same-site: strict

  # CSRF配置
  csrf:
    enabled: false # API服务通常禁用CSRF，可通过Stateful Token替代

# ===========================================
# 自定义安全配置类
# ===========================================
security:
  # JWT配置
  jwt:
    secret: ${JWT_SECRET}
    expiration: ${JWT_EXPIRATION:7200} # 2小时
    refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800} # 7天
    issuer: ${JWT_ISSUER:IOE-DREAM}

  # 密码策略配置
  password:
    min-length: 8
    max-length: 128
    require-uppercase: true
    require-lowercase: true
    require-digit: true
    require-special: true
    forbidden-patterns: password,123456,admin

  # 登录限制配置
  login:
    max-attempts: 5
    lockout-duration: 900 # 15分钟
    captcha-required: false # 可根据IP和失败次数动态启用

  # IP白名单配置
  ip-whitelist:
    enabled: ${IP_WHITELIST_ENABLED:false}
    allowed-ips: ${IP_WHITELIST:127.0.0.1,192.168.1.0/24,10.0.0.0/8}
    admin-only-ips: ${ADMIN_WHITELIST:127.0.0.1,192.168.1.0/24}

# ===========================================
# HTTP安全配置
# ===========================================
server:
  # HTTPS配置
  ssl:
    enabled: ${SSL_ENABLED:false}
    key-store: ${SSL_KEYSTORE_PATH:}
    key-store-password: ${SSL_KEYSTORE_PASSWORD:}
    key-store-type: PKCS12
    key-alias: ${SSL_KEY_ALIAS:ioedream}

  # 安全Headers配置
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

  # Tomcat安全配置
  tomcat:
    # 最大请求大小
    max-http-request-size: 10MB
    # 最大参数数量
    max-http-post-size: 2MB
    # 启用压缩
    compression:
      enabled: true
      min-response-size: 1024
    # 访问日志
    accesslog:
      enabled: ${ACCESS_LOG_ENABLED:true}
      pattern: "%h %l %u %t \"%r\" %s %b %D \"%{Referer}i\" \"%{User-Agent}i\""
      directory: ${ACCESS_LOG_DIR:logs}
      prefix: access_log
      suffix: .txt
      rotate: true

# ===========================================
# 网络安全配置
# ===========================================
# CORS配置
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8080}
  allowed-methods: GET,POST,PUT,DELETE,OPTIONS
  allowed-headers: "*"
  exposed-headers: X-Total-Count,Link
  allow-credentials: true
  max-age: 3600

# 限流配置
rate-limit:
  enabled: true
  # 全局限流配置
  global:
    requests-per-minute: 1000
    burst-capacity: 100
  # API特定限流配置
  api:
    login:
      requests-per-minute: 10
      burst-capacity: 5
    register:
      requests-per-minute: 5
      burst-capacity: 2
    data-query:
      requests-per-minute: 100
      burst-capacity: 20

# ===========================================
# 数据安全配置
# ===========================================
# 敏感数据加密配置
encryption:
  # AES加密配置
  aes:
    key: ${ENCRYPTION_AES_KEY:}
    algorithm: AES/GCM/NoPadding
    key-size: 256
  # RSA加密配置（用于密钥交换）
  rsa:
    public-key: ${ENCRYPTION_RSA_PUBLIC_KEY:}
    private-key: ${ENCRYPTION_RSA_PRIVATE_KEY:}
    key-size: 2048

# 数据脱敏配置
data-masking:
  enabled: true
  # 手机号脱敏
  phone:
    pattern: (\d{3})\d{4}(\d{4})
    replacement: $1****$2
  # 身份证脱敏
  id-card:
    pattern: (\d{6})\d{8}(\d{4})
    replacement: $1********$2
  # 邮箱脱敏
  email:
    pattern: (\w{1,3})\w*@(\w+)
    replacement: $1***@$2

# SQL注入防护配置
sql-injection-protection:
  enabled: true
  # 白名单SQL模式
  allowed-patterns:
    - "SELECT\\s+[^;]+\\s+FROM\\s+[a-zA-Z_][a-zA-Z0-9_]*"
    - "INSERT\\s+INTO\\s+[a-zA-Z_][a-zA-Z0-9_]*"
    - "UPDATE\\s+[a-zA-Z_][a-zA-Z0-9_]*"
    - "DELETE\\s+FROM\\s+[a-zA-Z_][a-zA-Z0-9_]*"
  # 危险关键词
  dangerous-keywords: DROP,TRUNCATE,ALTER,EXEC,UNION,SLEEP,WAITFOR

# ===========================================
# 审计日志配置
# ===========================================
audit:
  enabled: true
  # 记录的敏感操作
  sensitive-operations:
    - USER_LOGIN
    - USER_LOGOUT
    - PASSWORD_CHANGE
    - ROLE_ASSIGNMENT
    - PERMISSION_CHANGE
    - DATA_EXPORT
    - SYSTEM_CONFIG_CHANGE
  # 不记录的操作（提高性能）
  exclude-operations:
    - HEALTH_CHECK
    - METRICS
    - STATIC_RESOURCE
  # 日志保留配置
  retention:
    days: 90
    max-size: 1GB

# ===========================================
# API安全配置
# ===========================================
api-security:
  # API Key配置
  api-key:
    enabled: ${API_KEY_ENABLED:false}
    header-name: X-API-Key
    keys: ${API_KEYS:}

  # 接口版本控制
  versioning:
    enabled: true
    type: header
    header-name: API-Version
    default-version: v1
    supported-versions: v1,v2

  # 接口文档安全
  swagger:
    enabled: ${SWAGGER_ENABLED:false}
    production-only: true
    basic-auth:
      username: ${SWAGGER_USERNAME:swagger}
      password: ${SWAGGER_PASSWORD:}

# ===========================================
# 监控和告警配置
# ===========================================
security-monitoring:
  enabled: true
  # 异常行为检测
  anomaly-detection:
    # 登录异常检测
    suspicious-login:
      enabled: true
      max-different-ips: 3 # 24小时内不同IP数量
      max-different-locations: 2 # 24小时内不同地点
    # API访问异常检测
    suspicious-api:
      enabled: true
      max-requests-per-minute: 1000
      max-failure-rate: 0.1 # 10%失败率

  # 实时告警配置
  alerts:
    # 登录失败告警
    login-failure:
      enabled: true
      threshold: 5 # 5次失败
      time-window: 300 # 5分钟内
    # 暴力破解告警
    brute-force:
      enabled: true
      threshold: 20 # 20次尝试
      time-window: 900 # 15分钟内
    # 权限提升告警
    privilege-escalation:
      enabled: true
      threshold: 3 # 3次权限变更
      time-window: 3600 # 1小时内

# ===========================================
# 环境特定配置
# ===========================================
---
spring:
  config:
    activate:
      on-profile: dev

# 开发环境安全配置（较宽松）
security:
  jwt:
    expiration: 86400 # 24小时
  login:
    max-attempts: 10
    lockout-duration: 300 # 5分钟
  password:
    min-length: 6

cors:
  allowed-origins: "*"

api-security:
  swagger:
    enabled: true
    production-only: false

---
spring:
  config:
    activate:
      on-profile: test

# 测试环境安全配置
security:
  jwt:
    expiration: 7200 # 2小时
  login:
    max-attempts: 5
    lockout-duration: 600 # 10分钟

cors:
  allowed-origins: "http://localhost:3000,http://localhost:8080"

---
spring:
  config:
    activate:
      on-profile: prod

# 生产环境安全配置（严格）
security:
  jwt:
    expiration: 3600 # 1小时
  login:
    max-attempts: 3
    lockout-duration: 1800 # 30分钟
    captcha-required: true

ip-whitelist:
  enabled: true

api-security:
  swagger:
    enabled: false

cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:}

# 生产环境强制启用HTTPS
server:
  ssl:
    enabled: true
