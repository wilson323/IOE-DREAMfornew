# ============================================================
# IOE-DREAM Gateway Service 配置文件
#
# @Author:    IOE-DREAM Team
# @Date:      2025-01-30
# @Copyright  IOE-DREAM智慧园区一卡通管理平台
#
# 服务信息:
# - 服务名称: ioedream-gateway-service
# - 服务端口: 8080
# - 服务职责: API网关服务，提供路由转发、负载均衡、限流熔断等
# ============================================================

# ==================== 服务基本信息 ====================
spring:
  application:
    name: ioedream-gateway-service
  # Spring Cloud Gateway需要WebFlux环境
  main:
    web-application-type: reactive
    allow-bean-definition-overriding: true
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  # ==================== Redis配置 ====================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:ENC(AES256:H7K8L9M0N1O2P3Q4R5S6T7U8V9W0X1Y)}
      database: ${REDIS_DATABASE:0}
      timeout: 3000
  # ==================== Redisson配置 ====================
  redis:
    redisson:
      config: |
        singleServerConfig:
          address: "redis://${REDIS_HOST:127.0.0.1}:${REDIS_PORT:6379}"
          password: ${REDIS_PASSWORD:ENC(AES256:H7K8L9M0N1O2P3Q4R5S6T7U8V9W0X1Y)}
          database: ${REDIS_DATABASE:0}
          connectionPoolSize: 10
          connectionMinimumIdleSize: 5
          connectTimeout: 3000
          timeout: 3000
  # ==================== Flyway数据库迁移配置 ====================
  flyway:
    enabled: ${FLYWAY_ENABLED:false}
    baseline-on-migrate: ${FLYWAY_BASELINE_ON_MIGRATE:false}
    baseline-version: ${FLYWAY_BASELINE_VERSION:0}
    baseline-description: ${FLYWAY_BASELINE_DESCRIPTION:Initial schema for ioedream-gateway-service}
    locations: ${FLYWAY_LOCATIONS:classpath:db/migration}
    table: ${FLYWAY_TABLE:flyway_schema_history}
    validate-on-migrate: ${FLYWAY_VALIDATE_ON_MIGRATE:false}
    clean-disabled: ${FLYWAY_CLEAN_DISABLED:true}
    placeholders:
      service.name: ${spring.application.name}
      environment: ${spring.profiles.active}
      schema.name: ${FLYWAY_SCHEMA_NAME:ioedream}

  # Spring Boot 2.4+ 要求显式声明配置导入
  # 本地开发环境不需要从Nacos加载配置，使用本地配置文件即可
  # Docker环境可以通过环境变量SPRING_CONFIG_IMPORT覆盖
  # config:
  #   import:
  #     - "optional:nacos:ioedream-gateway-service-${spring.profiles.active}.yaml"

# ==================== Nacos服务发现配置 ====================
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:IOE-DREAM}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:nacos}
        enabled: true
        register-enabled: true
      config:
        server-addr: ${NACOS_SERVER_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:IOE-DREAM}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:nacos}
        file-extension: yaml
        enabled: false  # 本地开发环境禁用配置中心，使用本地配置文件
        import-check:
          enabled: false

    # ==================== Gateway路由配置 ====================
    # 统一使用 Spring Cloud Gateway 2025.x 标准命名空间
    # Canonical API 前缀：/api/v1
    gateway:
      server:
        webflux:
          # 全局跨域配置
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOriginPatterns:
                  - "http://localhost:*"
                  - "http://127.0.0.1:*"
                  - "http://192.168.*.*:*"
                  - "http://26.26.26.*:*"
                  - "http://172.*.*.*:*"
                allowedMethods:
                  - GET
                  - POST
                  - PUT
                  - DELETE
                  - OPTIONS
                  - HEAD
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600
          # 启用服务发现路由
          discovery:
            locator:
              enabled: true
              lower-case-service-id: true
          # 路由配置 - 按照微服务边界进行匹配
          routes:
            # 设备通讯服务路由
            - id: ioedream-device-comm-service
              uri: lb://ioedream-device-comm-service
              predicates:
                - Path=/api/v1/device/**
              filters:
                - StripPrefix=0

            # 生物模板管理服务路由（端口8096）
            - id: ioedream-biometric-service
              uri: lb://ioedream-biometric-service
              predicates:
                - Path=/api/v1/biometric/**
              filters:
                - StripPrefix=0

            # 门禁管理服务路由
            - id: ioedream-access-service
              uri: lb://ioedream-access-service
              predicates:
                - Path=/api/v1/access/**,/api/v1/mobile/access/**
              filters:
                - StripPrefix=0

            # 考勤管理服务路由
            - id: ioedream-attendance-service
              uri: lb://ioedream-attendance-service
              predicates:
                - Path=/api/v1/attendance/**,/api/attendance/mobile/**,/api/attendance/mobile
              filters:
                - StripPrefix=0

            # 消费管理服务路由
            # 支持路径：/api/v1/consume/**, /api/v1/payment/**, /api/consume/**, /api/mobile/v1/consume/**
            - id: ioedream-consume-service
              uri: lb://ioedream-consume-service
              predicates:
                - Path=/api/v1/consume/**,/api/v1/payment/**,/api/consume/**,/api/mobile/v1/consume/**
              filters:
                - StripPrefix=0

            # 访客管理服务路由
            - id: ioedream-visitor-service
              uri: lb://ioedream-visitor-service
              predicates:
                - Path=/api/v1/visitor/**,/api/v1/mobile/visitor/**
              filters:
                - StripPrefix=0

            # 视频监控服务路由
            - id: ioedream-video-service
              uri: lb://ioedream-video-service
              predicates:
                - Path=/api/v1/video/**,/api/v1/mobile/video/**
              filters:
                - StripPrefix=0

            # OA办公服务路由
            - id: ioedream-oa-service
              uri: lb://ioedream-oa-service
              predicates:
                - Path=/api/v1/approval/**,/api/v1/workflow/**
              filters:
                - StripPrefix=0

            # 登录认证路由（优先级高）
            - id: ioedream-login-service
              uri: lb://ioedream-common-service
              predicates:
                - Path=/login/**,/logout/**,/captcha/**
              filters:
                - StripPrefix=0

            # 公共业务服务路由（系统/通知/组织/认证/菜单等）
            - id: ioedream-common-service
              uri: lb://ioedream-common-service
              predicates:
                - Path=/api/v1/system/**,/api/v1/notification/**,/api/v1/area-device/**,/api/v1/area-permission/**,/api/v1/auth/**,/api/v1/menu/**,/admin/**,/oa/**,/support/**,/home/**,/file/**,/goods/**,/category/**,/employee/**,/department/**,/role/**,/menu/**,/helpdoc/**,/changeLog/**,/feedback/**,/config/**,/datascope/**,/dict/**,/serial-number/**,/reload/**,/heart-beat/**,/system/**
              filters:
                - StripPrefix=0

            # 区域权限路由（门禁服务）
            - id: ioedream-access-area-permission
              uri: lb://ioedream-access-service
              predicates:
                - Path=/api/v1/area-permission/**
              filters:
                - StripPrefix=0

            # ==================== 兼容入口（legacy → canonical） ====================
            - id: legacy-access-to-api-v1
              uri: lb://ioedream-access-service
              predicates:
                - Path=/access/**
              filters:
                - RewritePath=/access(?<segment>/?.*), /api/v1/access$\{segment}

            - id: legacy-attendance-to-api-v1
              uri: lb://ioedream-attendance-service
              predicates:
                - Path=/attendance/**
              filters:
                - RewritePath=/attendance(?<segment>/?.*), /api/v1/attendance$\{segment}

            - id: legacy-consume-to-api-v1
              uri: lb://ioedream-consume-service
              predicates:
                - Path=/consume/**
              filters:
                - RewritePath=/consume(?<segment>/?.*), /api/v1/consume$\{segment}

            - id: legacy-visitor-to-api-v1
              uri: lb://ioedream-visitor-service
              predicates:
                - Path=/visitor/**
              filters:
                - RewritePath=/visitor(?<segment>/?.*), /api/v1/visitor$\{segment}

            - id: legacy-video-to-api-v1
              uri: lb://ioedream-video-service
              predicates:
                - Path=/video/**
              filters:
                - RewritePath=/video(?<segment>/?.*), /api/v1/video$\{segment}

            - id: legacy-device-to-api-v1
              uri: lb://ioedream-device-comm-service
              predicates:
                - Path=/device/**
              filters:
                - RewritePath=/device(?<segment>/?.*), /api/v1/device$\{segment}

            - id: legacy-system-to-api-v1
              uri: lb://ioedream-common-service
              predicates:
                - Path=/system/**
              filters:
                - RewritePath=/system(?<segment>/?.*), /api/v1/system$\{segment}

            - id: legacy-support-pass-through
              uri: lb://ioedream-common-service
              predicates:
                - Path=/support/**
              filters:
                - StripPrefix=0

            - id: legacy-security-pass-through
              uri: lb://ioedream-common-service
              predicates:
                - Path=/security/**
              filters:
                - StripPrefix=0

# ==================== 服务器配置 ====================
server:
  port: ${GATEWAY_SERVICE_PORT:8080}
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true

# ==================== 日志配置 ====================
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    '[net.lab1024.sa]': ${LOG_LEVEL_APP:DEBUG}
    '[org.springframework.cloud.gateway]': DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"

# ==================== 安全配置 ====================
security:
  jwt:
    secret: ${JWT_SECRET:ioedream-gateway-service-jwt-secret-key-2025-must-be-at-least-256-bits-long}
    expiration: ${JWT_EXPIRATION:86400000}
    refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000}

# ==================== Actuator监控配置 ====================
management:
  endpoints:
    web:
      exposure:
        include: ${MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE:health,info,metrics,prometheus,gateway}
      base-path: ${MANAGEMENT_ENDPOINTS_WEB_BASE_PATH:/actuator}
  endpoint:
    health:
      show-details: when-authorized
    # Spring Boot 3.5+不再需要gateway.enabled配置项
    # gateway:
    #   enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
  # 分布式追踪配置（Micrometer Tracing）
  tracing:
    enabled: false  # 禁用追踪避免Zipkin连接警告
    sampling:
      probability: ${SLEUTH_SAMPLER_PROBABILITY:1.0}
  zipkin:
    tracing:
      endpoint: ${ZIPKIN_ENDPOINT:http://localhost:9411/api/v2/spans}
