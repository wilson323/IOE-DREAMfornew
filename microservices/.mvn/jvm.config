# ============================================================
# IOE-DREAM JVM参数优化配置 - G1GC垃圾回收器
#
# @Author:    IOE-DREAM Team
# @Date:      2025-12-26
# @Version:   2.0 (P1-7.4优化版)
#
# 优化目标:
# - GC暂停时间 < 200ms
# - GC频率 < 5次/分钟
# - 内存利用率 > 85%
# - Full GC频率 < 1次/天
# ============================================================

# ============================================================
# 基础配置
# ============================================================

-Dfile.encoding=UTF-8
-Duser.timezone=Asia/Shanghai

# ============================================================
# 内存配置（适用于16GB内存服务器）
# ============================================================

# 堆内存配置（生产环境推荐）
-Xms4g                                    # 初始堆大小4GB
-Xmx8g                                    # 最大堆大小8GB
-XX:MaxMetaspaceSize=512m                  # 最大元空间512MB
-XX:CompressedClassSpaceSize=256m          # 压缩类空间大小256MB

# ============================================================
# G1GC核心配置
# ============================================================

-XX:+UseG1GC                              # 启用G1垃圾回收器
-XX:MaxGCPauseMillis=200                   # 最大GC暂停时间目标200ms
-XX:G1HeapRegionSize=16m                   # G1堆区域大小16MB
-XX:G1NewSizePercent=30                    # 新生代占比30%
-XX:G1MaxNewSizePercent=40                 # 最大新生代占比40%
-XX:InitiatingHeapOccupancyPercent=45     # 触发并发GC的堆占用率阈值45%

# ============================================================
# G1GC高级优化参数
# ============================================================

# 混合GC配置
-XX:G1MixedGCCountTarget=8                 # 混合GC目标次数
-XX:G1MixedGCLiveThresholdPercent=85       # 混合GC存活率阈值85%

# 老年代CSet配置
-XX:G1OldCSetRegionThresholdPercent=10     # 老年代CSet区域阈值10%

# 保留空间配置
-XX:G1ReservePercent=20                    # 保留空间比例20%

# Survivor配置
-XX:SurvivorRatio=8                        # Eden/Survivor比例8
-XX:MaxTenuringThreshold=15                # 对象晋升年龄阈值15

# IHOP配置（自适应IHOP）
-XX:+G1UseAdaptiveIHOP                     # 启用自适应IHOP

# 并发精细化
-XX:G1RSetUpdatingPauseTimePercent=5       # RSet更新暂停时间百分比5%

# 并发引用处理
-XX:+ParallelRefProcEnabled               # 并行处理引用对象

# 字符串去重（减少内存使用）
-XX:+UseStringDeduplication                # 启用字符串去重
-XX:StringDeduplicationAgeThreshold=3     # 字符串去重年龄阈值3

# ============================================================
# GC日志配置
# ============================================================

# 启用GC日志
-XX:+PrintGC                              # 打印GC信息
-XX:+PrintGCDetails                        # 打印GC详细信息
-XX:+PrintGCTimeStamps                     # 打印GC时间戳
-XX:+PrintGCDateStamps                    # 打印GC日期戳
-XX:+PrintGCApplicationStoppedTime        # 打印GC应用暂停时间
-XX:+PrintReferenceGC                     # 打印引用GC
-XX:+PrintHeapAtGC                        # 打印GC时堆信息
-XX:+PrintTenuringDistribution            # 打印对象年龄分布

# GC日志文件配置
-Xloggc:./logs/gc-%p.log                  # GC日志文件路径
-XX:+UseGCLogFileRotation                  # 启用GC日志文件轮转
-XX:NumberOfGCLogFiles=5                   # GC日志文件数量
-XX:GCLogFileSize=10M                      # GC日志文件大小

# ============================================================
# 性能监控配置
# ============================================================

# OOM时自动生成HeapDump
-XX:+HeapDumpOnOutOfMemoryError           # OOM时自动生成HeapDump
-XX:HeapDumpPath=./logs/heapdump.hprof      # HeapDump文件路径

# JMX远程监控（可选）
# -Dcom.sun.management.jmxremote
# -Dcom.sun.management.jmxremote.port=9999
# -Dcom.sun.management.jmxremote.authenticate=false
# -Dcom.sun.management.jmxremote.ssl=false

# ============================================================
# 性能调优参数
# ============================================================

# 编译优化
-XX:+CompileThresholdFactor=100            # 编译阈值因子
-XX:+TieredCompilation                    # 分层编译

# 优化编译
-XX:+OptimizeStringConcat                 # 优化字符串连接

# 快速验证
-XX:+UseFastAccessorMethods                # 使用快速访问方法
-XX:+UseFastEmptyNewArrays                # 使用快速空数组检查

# ============================================================
# 开发环境特定配置（可禁用）
# ============================================================

# 开发环境可禁用的优化（便于调试）
# -XX:+PrintGCTimeStamps                  # 生产环境可禁用
# -XX:+PrintGCDateStamps                 # 生产环境可禁用
# -XX:+PrintGCApplicationStoppedTime     # 生产环境可禁用

# ============================================================
# 注意事项
# ============================================================
#
# 1. 内存配置：
#    - -Xms和-Xmx建议设置为相同值，避免堆内存动态调整带来的性能损耗
#    - 最大堆大小不应超过物理内存的75%
#    - 留出足够的内存给操作系统和其他进程
#
# 2. G1GC调优：
#    - 监控GC暂停时间，如超过200ms可调整-XX:MaxGCPauseMillis
#    - 监控Full GC频率，如频繁需调整-XX:InitiatingHeapOccupancyPercent
#    - 监控老年代使用率，如持续增长需调整-XX:G1ReservePercent
#
# 3. GC日志分析：
#    - 定期分析GC日志，识别性能瓶颈
#    - 使用GCViewer、JClarity等工具分析GC日志
#    - 关注G1 Old Generation、Full GC等指标
#
# 4. 监控告警：
#    - 配置GC暂停时间告警（>200ms）
#    - 配置Full GC告警（>1次/小时）
#    - 配置堆内存使用率告警（>90%）
#
# ============================================================

# ============================================================
# 容器环境配置（Docker/Kubernetes）
# ============================================================
#
# 如需在容器环境中运行，请使用以下配置替代上面的内存配置：
#
# -XX:+UseG1GC
# -XX:MaxRAMPercentage=75.0                 # 最大堆内存占容器内存75%
# -XX:InitialRAMPercentage=50.0               # 初始堆内存占容器内存50%
# -XX:MinRAMPercentage=25.0                  # 最小堆内存占容器内存25%
# -XX:MaxGCPauseMillis=200
# -XX:+UnlockExperimentalVMOptions
# -XX:+UseCGroupMemoryLimitForHeap           # 使用CGroup内存限制
#
# Kubernetes资源限制参考：
# resources:
#   requests:
#     memory: "4Gi"
#     cpu: "2"
#   limits:
#     memory: "8Gi"
#     cpu: "4"
#
# ============================================================

# ============================================================
# 微服务差异化配置
# ============================================================
#
# 核心服务（common-service, gateway-service）:
# -Xms4g -Xmx6g -XX:MaxGCPauseMillis=150
#
# 业务服务（access-service, attendance-service, consume-service）:
# -Xms2g -Xmx4g -XX:MaxGCPauseMillis=200
#
# 轻量服务（visitor-service）:
# -Xms1g -Xmx2g -XX:MaxGCPauseMillis=100
#
# ============================================================
