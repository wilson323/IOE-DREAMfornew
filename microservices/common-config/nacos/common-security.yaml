# ============================================================
# IOE-DREAM 公共安全配置
#
# 供所有微服务使用的安全相关配置
# 包含认证授权、接口安全、加密解密、防护措施等配置
# ============================================================

# ============================================================
# JWT配置（统一：Spring Security + JwtTokenUtil）
# ============================================================
# 说明：
# - 统一使用 security.jwt.* 作为配置键
# - 过期时间单位：秒
# - JWT_SECRET 必须由环境/配置中心显式提供（无默认值）

# ============================================================
# 密码加密配置
# ============================================================
password:
  # 密码加密算法
  algorithm: ${PASSWORD_ALGORITHM:BCrypt}

  # 加密强度（4-31，默认10）
  strength: ${PASSWORD_STRENGTH:10}

  # 密码策略
  policy:
    # 最小长度
    min-length: ${PASSWORD_POLICY_MIN_LENGTH:8}
    # 最大长度
    max-length: ${PASSWORD_POLICY_MAX_LENGTH:20}
    # 是否包含大写字母
    require-uppercase: ${PASSWORD_POLICY_REQUIRE_UPPERCASE:true}
    # 是否包含小写字母
    require-lowercase: ${PASSWORD_POLICY_REQUIRE_LOWERCASE:true}
    # 是否包含数字
    require-digit: ${PASSWORD_POLICY_REQUIRE_DIGIT:true}
    # 是否包含特殊字符
    require-special: ${PASSWORD_POLICY_REQUIRE_SPECIAL:true}
    # 禁止的密码列表
    forbidden-passwords: ${PASSWORD_POLICY_FORBIDDEN:"123456,password,admin,root"}

# ============================================================
# 接口安全配置
# ============================================================
security:
  # JWT配置（单位：秒）
  jwt:
    secret: ${JWT_SECRET}
    expiration: ${JWT_EXPIRATION:7200}
    refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}
    issuer: ${JWT_ISSUER:IOE-DREAM}

  # 网关匿名/白名单（单一真源）
  whitelist:
    paths:
      - /actuator/**
      - /doc.html
      - /swagger-ui/**
      - /v3/api-docs/**
      - /swagger-resources/**
      - /webjars/**
      - /favicon.ico
      - /api/v1/auth/**
      - /login/**
      - /public/**
      - /static/**
      - /gateway/health

  # 跨域配置
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:"*"}
    allowed-methods: ${CORS_ALLOWED_METHODS:"GET,POST,PUT,DELETE,OPTIONS"}
    allowed-headers: ${CORS_ALLOWED_HEADERS:"*"}
    exposed-headers: ${CORS_EXPOSED_HEADERS:"Authorization,Content-Type,X-Total-Count"}
    allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
    max-age: ${CORS_MAX_AGE:3600}

  # CSRF保护
  csrf:
    enabled: ${CSRF_ENABLED:false}

  # XSS防护
  xss:
    enabled: ${XSS_ENABLED:true}
    # XSS过滤器
    filter-enabled: ${XSS_FILTER_ENABLED:true}

  # SQL注入防护
  sql-injection:
    enabled: ${SQL_INJECTION_ENABLED:true}

  # 接口限流
  rate-limit:
    enabled: ${RATE_LIMIT_ENABLED:true}
    # 默认限流策略
    default-limits:
      - path: ${RATE_LIMIT_DEFAULT_PATH:"/**"}
        rate: ${RATE_LIMIT_DEFAULT_RATE:100}
        interval: ${RATE_LIMIT_DEFAULT_INTERVAL:60}
        type: ${RATE_LIMIT_DEFAULT_TYPE:window}
        block-time: ${RATE_LIMIT_DEFAULT_BLOCK_TIME:300}

  # 接口签名
  signature:
    enabled: ${SIGNATURE_ENABLED:false}
    algorithm: ${SIGNATURE_ALGORITHM:HMAC-SHA256}
    secret-key: ${SIGNATURE_SECRET_KEY:ENC(J9K0L1M2N3O4P5Q6R7S8T9U0V1W2X3Y)}
    expire-time: ${SIGNATURE_EXPIRE_TIME:300}

# ============================================================
# 数据加密配置
# ============================================================
encryption:
  # AES加密配置
  aes:
    key: ${ENCRYPTION_AES_KEY:ENC(K0L1M2N3O4P5Q6R7S8T9U0V1W2X3Y4Z5)}
    iv: ${ENCRYPTION_AES_IV:ENC(L1M2N3O4P5Q6R7S8T9U0V1W2X3Y4Z5A6)}
    algorithm: ${ENCRYPTION_AES_ALGORITHM:AES/CBC/PKCS5Padding}

  # RSA加密配置
  rsa:
    private-key: ${ENCRYPTION_RSA_PRIVATE_KEY:ENC(M2N3O4P5Q6R7S8T9U0V1W2X3Y4Z5A6B7)}
    public-key: ${ENCRYPTION_RSA_PUBLIC_KEY:ENC(N3O4P5Q6R7S8T9U0V1W2X3Y4Z5A6B7C8)}
    algorithm: ${ENCRYPTION_RSA_ALGORITHM:RSA}

# ============================================================
# 安全审计配置
# ============================================================
audit:
  # 审计日志
  logging:
    enabled: ${AUDIT_LOGGING_ENABLED:true}
    # 审计日志级别
    level: ${AUDIT_LOGGING_LEVEL:INFO}
    # 审计事件类型
    events:
      - ${AUDIT_EVENT_LOGIN:login}
      - ${AUDIT_EVENT_LOGOUT:logout}
      - ${AUDIT_EVENT_PERMISSION_CHECK:permission_check}
      - ${AUDIT_EVENT_DATA_ACCESS:data_access}
      - ${AUDIT_EVENT_SYSTEM_CONFIG:system_config}
      - ${AUDIT_EVENT_SECURITY_INCIDENT:security_incident}

  # 审计存储
  storage:
    # 存储类型
    type: ${AUDIT_STORAGE_TYPE:database}
    # 存储周期（天）
    retention-days: ${AUDIT_STORAGE_RETENTION_DAYS:365}

# ============================================================
# 敏感数据处理配置
# ============================================================
sensitive-data:
  # 数据脱敏
  masking:
    enabled: ${MASKING_ENABLED:true}
    # 手机号脱敏
    phone: ${MASKING_PHONE:}
    # 身份证号脱敏
    id-card: ${MASKING_ID_CARD:}
    # 邮箱脱敏
    email: ${MASKING_EMAIL:}
    # 银行卡脱敏
    bank-card: ${MASKING_BANK_CARD:}

  # 敏感字段标识
  sensitive-fields: ${MASKING_SENSITIVE_FIELDS:"password,token,secret,key"}

# ============================================================
# HTTPS配置
# ============================================================
server:
  # SSL配置
  ssl:
    enabled: ${SERVER_SSL_ENABLED:false}
    key-store: ${SERVER_SSL_KEY_STORE:}
    key-store-password: ${SERVER_SSL_KEY_STORE_PASSWORD:ENC(O4P5Q6R7S8T9U0V1W2X3Y4Z5A6B7C8D9)}
    key-store-type: ${SERVER_SSL_KEY_STORE_TYPE:PKCS12}
    key-alias: ${SERVER_SSL_KEY_ALIAS:ioedream}

  # 安全头配置
  servlet:
    context-parameters:
      X-Content-Type-Options: nosniff
      X-Frame-Options: DENY
      X-XSS-Protection: "1; mode=block"
      Strict-Transport-Security: max-age=31536000; includeSubDomains
      Referrer-Policy: strict-origin-when-cross-origin

# ============================================================
# 环境特定配置
# ============================================================

# 开发环境
---
spring:
  config:
    activate:
      profile: dev

security:
  cors:
    allowed-origins: "*"
  rate-limit:
    enabled: false
audit:
  logging:
    level: DEBUG

# 测试环境
---
spring:
  config:
    activate:
      profile: test

security:
  rate-limit:
    default-limits:
      - path: "/**"
        rate: 50
        interval: 60
        type: window
        block-time: 180

audit:
  storage:
    retention-days: 90

# 生产环境
---
spring:
  config:
    activate:
      profile: prod

security:
  cors:
    allowed-origins: "${FRONTEND_DOMAINS:}"
  rate-limit:
    enabled: true
  signature:
    enabled: true

server:
  ssl:
    enabled: true

audit:
  storage:
    retention-days: 1825
