# ============================================================
# IOE-DREAM 缓存架构统一配置
# 三级缓存体系：L1本地缓存 + L2 Redis缓存 + L3网关缓存
# ============================================================

# 缓存架构统一标准
cache-architecture:
  # 三级缓存策略
  multi-level-cache:
    l1-local:
      provider: caffeine
      max-size: 10000
      expire-after-write: 5m
      expire-after-access: 10m
      record-stats: true
      refresh-after-write: 3m

    l2-redis:
      provider: redis
      database: 0
      timeout: 3000ms
      lettuce-pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms
      key-prefix: "ioedream:"
      default-ttl: 30m
      null-ttl: 5m

    l3-gateway:
      provider: gateway-cache
      enabled: true
      max-entries: 100000
      ttl: 60m
      sync-interval: 30s

# 缓存策略配置
cache-strategies:
  # 用户会话缓存
  user-session:
    level: [l1, l2]
    ttl: 2h
    max-size: 100000
    refresh-strategy: write-through
    eviction-policy: lru

  # 权限信息缓存
  permission:
    level: [l1, l2]
    ttl: 1h
    max-size: 50000
    refresh-strategy: write-behind
    eviction-policy: lru

  # 字典数据缓存
  dictionary:
    level: [l1, l2, l3]
    ttl: 24h
    max-size: 10000
    refresh-strategy: write-through
    eviction-policy: lru

  # 设备状态缓存
  device-status:
    level: [l1, l2]
    ttl: 10m
    max-size: 100000
    refresh-strategy: refresh-ahead
    eviction-policy: lru

  # 配置信息缓存
  configuration:
    level: [l1, l2, l3]
    ttl: 12h
    max-size: 5000
    refresh-strategy: write-through
    eviction-policy: lru

# 缓存键命名规范
cache-key-conventions:
  # 用户相关
  user-session: "user:session:{userId}"
  user-permission: "user:permission:{userId}"
  user-profile: "user:profile:{userId}"

  # 设备相关
  device-info: "device:info:{deviceId}"
  device-status: "device:status:{deviceId}"
  device-config: "device:config:{deviceType}"

  # 业务相关
  access-record: "access:record:{date}:{areaId}"
  attendance-summary: "attendance:summary:{userId}:{date}"
  consume-account: "consume:account:{accountId}"
  visitor-appointment: "visitor:appointment:{appointmentId}"

  # 系统相关
  dictionary: "dict:{typeCode}:{itemCode}"
  configuration: "config:{module}:{key}"
  menu-tree: "menu:tree:{userId}"

# 缓存预热策略
cache-warmup:
  # 启动时预热
  startup-warmup:
    enabled: true
    concurrent: true
    data-sources:
      - type: dictionary
        loader: "net.lab1024.sa.common.cache.DictionaryWarmupLoader"
        priority: 1
      - type: configuration
        loader: "net.lab1024.sa.common.cache.ConfigurationWarmupLoader"
        priority: 2
      - type: permission
        loader: "net.lab1024.sa.common.cache.PermissionWarmupLoader"
        priority: 3

  # 定时预热
  scheduled-warmup:
    enabled: true
    cron: "0 0 2 * * ?"
    data-sources:
      - type: hot-data
        loader: "net.lab1024.sa.common.cache.HotDataWarmupLoader"

# 缓存监控配置
cache-monitoring:
  metrics:
    enabled: true
    export-prometheus: true
    collect-interval: 30s

  alerts:
    hit-rate-low:
      enabled: true
      threshold: 0.8
      duration: 5m

    eviction-high:
      enabled: true
      threshold: 1000
      duration: 1m

    error-rate-high:
      enabled: true
      threshold: 0.05
      duration: 2m

# 缓存一致性策略
cache-consistency:
  # 发布订阅模式
  pub-sub:
    enabled: true
    topic-prefix: "cache:"
    channels:
      - user-update
      - permission-update
      - configuration-update
      - dictionary-update

  # 失效策略
  invalidation-strategy:
    user-data: "cascade"
    permission-data: "immediate"
    configuration-data: "delayed"
    dictionary-data: "scheduled"
