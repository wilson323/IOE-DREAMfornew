# ç¼–è¯‘é”™è¯¯ä¿®å¤å®Œæˆæ€»ç»“

**ä¿®å¤æ—¥æœŸ**: 2025-01-30
**ä¿®å¤çŠ¶æ€**: âœ… æ ¸å¿ƒé—®é¢˜å·²ä¿®å¤ï¼Œéƒ¨åˆ†ä¸šåŠ¡ç±»å¾…åˆ›å»º
**å½±å“èŒƒå›´**: æ‰€æœ‰å¾®æœåŠ¡æ¨¡å—

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. POMç»§æ‰¿å…³ç³»ä¿®å¤ âœ…

**é—®é¢˜**: æ‰€æœ‰å­æ¨¡å—POMæ–‡ä»¶æœªç»§æ‰¿çˆ¶POM

**ä¿®å¤å†…å®¹**:
- âœ… ä¿®å¤4ä¸ªå·²æœ‰POMæ–‡ä»¶çš„ç»§æ‰¿å…³ç³»
- âœ… åˆ›å»º6ä¸ªç¼ºå¤±çš„POMæ–‡ä»¶
- âœ… è¡¥å……Spring Cloud BOMå’ŒSpring Cloud Alibaba BOM

**ä¿®å¤æ–‡ä»¶**: 10ä¸ªPOMæ–‡ä»¶

### 2. @Transactionalæ³¨è§£ä¿®å¤ âœ…

**é—®é¢˜**: ä½¿ç”¨äº†`jakarta.transaction.Transactional`ï¼Œä¸æ”¯æŒSpringäº‹åŠ¡å±æ€§

**ä¿®å¤å†…å®¹**:
- âœ… `NotificationConfigDao.java` - æ”¹ä¸º`org.springframework.transaction.annotation.Transactional`
- âœ… `NotificationTemplateDao.java` - æ”¹ä¸º`org.springframework.transaction.annotation.Transactional`

**ä¿®å¤æ–‡ä»¶**: 2ä¸ª

### 3. Spring Cloudç‰ˆæœ¬ä¿®å¤ âœ…

**é—®é¢˜**: Spring Cloudç‰ˆæœ¬å·é”™è¯¯ï¼ˆ5.0.0ä¸å­˜åœ¨ï¼‰

**ä¿®å¤å†…å®¹**:
- âœ… ä¿®å¤Spring Cloudç‰ˆæœ¬ï¼šä»`5.0.0`æ”¹ä¸º`2025.0.0`
- âœ… åœ¨çˆ¶POMä¸­æ·»åŠ Spring Cloud BOM
- âœ… ç»Ÿä¸€ç®¡ç†Spring Cloudä¾èµ–ç‰ˆæœ¬

**ä¿®å¤æ–‡ä»¶**: `microservices/pom.xml`

**é‡è¦è¯´æ˜**: 
- Spring Cloudä½¿ç”¨å¹´ä»½.ç‰ˆæœ¬å·å‘½åï¼ˆå¦‚2025.0.0ï¼‰ï¼Œä¸æ˜¯5.0.0
- Spring Boot 3.5.8 å…¼å®¹ Spring Cloud 2025.0.x
- ä¿®å¤åéœ€è¦æ¸…ç†Mavenæœ¬åœ°ç¼“å­˜

### 4. Spring Cloud Commonsç‰ˆæœ¬ä¿®å¤ âœ…

**é—®é¢˜**: `spring-cloud-commons`é”™è¯¯åœ°ä½¿ç”¨äº†å¹´ä»½ç‰ˆæœ¬å·ï¼ˆ2025.0.0ï¼‰

**ä¿®å¤å†…å®¹**:
- âœ… ç§»é™¤`spring-cloud-commons`çš„æ˜¾å¼ç‰ˆæœ¬å·
- âœ… ç”±Spring Cloud BOMè‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬
- âœ… éµå¾ªSpring Cloudç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ

**ä¿®å¤æ–‡ä»¶**: `microservices/microservices-common/pom.xml`

**é‡è¦è¯´æ˜**: 
- Spring Cloudç»„ä»¶ç‰ˆæœ¬ç”±BOMè‡ªåŠ¨ç®¡ç†ï¼Œä¸åº”æ˜¾å¼æŒ‡å®š
- BOMä½¿ç”¨å¹´ä»½ç‰ˆæœ¬å·ï¼ˆ2025.0.0ï¼‰ï¼Œç»„ä»¶ä½¿ç”¨æ•°å­—ç‰ˆæœ¬å·ï¼ˆ5.0.0ï¼‰
- å­æ¨¡å—ä¸­åº”ç§»é™¤æ‰€æœ‰Spring Cloudç»„ä»¶çš„æ˜¾å¼ç‰ˆæœ¬å·

### 5. UnifiedCacheManageræ–¹æ³•è¡¥å…… âœ…

**é—®é¢˜**: ç¼ºå°‘`getWithRefresh`å’Œ`evict`æ–¹æ³•

**ä¿®å¤å†…å®¹**:
- âœ… æ·»åŠ `getWithRefresh(String key, Supplier<T> loader, Long ttl)`æ–¹æ³•
- âœ… æ·»åŠ `evict(String key)`æ–¹æ³•

**ä¿®å¤æ–‡ä»¶**: `microservices/microservices-common/src/main/java/net/lab1024/sa/common/cache/UnifiedCacheManager.java`

### 5. Quartzä¾èµ–è¡¥å…… âœ…

**é—®é¢˜**: `GenericJob.java`ä½¿ç”¨äº†Quartzç±»ï¼Œä½†ç¼ºå°‘ä¾èµ–

**ä¿®å¤å†…å®¹**:
- âœ… åœ¨microservices-commonçš„POMä¸­æ·»åŠ Quartzä¾èµ–

**ä¿®å¤æ–‡ä»¶**: `microservices/microservices-common/pom.xml`

### 6. æ”¯ä»˜å®/å¾®ä¿¡SDKç‰ˆæœ¬ä¿®å¤ âœ…

**é—®é¢˜**: ä½¿ç”¨äº†ä¸å­˜åœ¨çš„ç‰ˆæœ¬å·

**ä¿®å¤å†…å®¹**:
- âœ… æ”¯ä»˜å®SDK: `4.40.572.ALL` (åŸ: 4.41.46.ALL)
- âœ… å¾®ä¿¡æ”¯ä»˜SDK: `0.2.17` (åŸ: 0.2.22)

**ä¿®å¤æ–‡ä»¶**: `microservices/ioedream-consume-service/pom.xml`

### 7. å®ä½“ç±»åˆ›å»º âœ…

**é—®é¢˜**: 4ä¸ªå®ä½“ç±»ä¸å­˜åœ¨

**ä¿®å¤å†…å®¹**:
- âœ… `AreaEntity` - åŒºåŸŸå®ä½“ç±»
- âœ… `AreaPersonEntity` - äººå‘˜åŒºåŸŸå…³è”å®ä½“ç±»
- âœ… `ApprovalProcessEntity` - å®¡æ‰¹æµç¨‹å®ä½“ç±»
- âœ… `AreaAccessExtEntity` - åŒºåŸŸé—¨ç¦æ‰©å±•å®ä½“ç±»

**åˆ›å»ºæ–‡ä»¶**: 4ä¸ªå®ä½“ç±»æ–‡ä»¶

---

## âš ï¸ å¾…å¤„ç†é—®é¢˜ï¼ˆä¸šåŠ¡ç±»ï¼‰

### 1. Controllerå’ŒServiceç±»ç¼ºå¤±

**ç¼ºå¤±ç±»**:
- `AccessMobileController`
- `AccessDeviceService`
- `AccessEventService`
- `AdvancedAccessControlService`
- `AttendanceMobileController`

**ä½ç½®**: åº”è¯¥åœ¨`ioedream-access-service`å’Œ`ioedream-attendance-service`ä¸­

**ä¼˜å…ˆçº§**: P1ï¼ˆæµ‹è¯•ç±»ä¾èµ–ï¼Œä¸å½±å“ä¸»ä»£ç ç¼–è¯‘ï¼‰

### 2. Request/Responseç±»ç¼ºå¤±

**ç¼ºå¤±ç±»**:
- `MobileAccessCheckRequest`
- `QRCodeVerifyRequest`
- `NFCVerifyRequest`
- `BiometricVerifyRequest`
- `GpsPunchRequest`
- `LocationValidationRequest`
- `OfflinePunchData`
- `OfflinePunchRequest`

**ä½ç½®**: åº”è¯¥åœ¨ç›¸åº”æœåŠ¡çš„domainåŒ…ä¸­

**ä¼˜å…ˆçº§**: P1ï¼ˆæµ‹è¯•ç±»ä¾èµ–ï¼Œä¸å½±å“ä¸»ä»£ç ç¼–è¯‘ï¼‰

### 3. Mockitoæ³›å‹ç±»å‹é—®é¢˜

**é—®é¢˜**: Mockitoçš„`thenReturn`æ–¹æ³•å­˜åœ¨æ³›å‹ç±»å‹ä¸åŒ¹é…

**ä½ç½®**: `ioedream-visitor-service`æµ‹è¯•æ–‡ä»¶

**ä¼˜å…ˆçº§**: P2ï¼ˆè­¦å‘Šçº§åˆ«ï¼Œä¸å½±å“ç¼–è¯‘ï¼‰

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

| ä¿®å¤é¡¹ | çŠ¶æ€ | æ–‡ä»¶æ•° | ä¼˜å…ˆçº§ |
|--------|------|--------|--------|
| **POMç»§æ‰¿å…³ç³»ä¿®å¤** | âœ… å®Œæˆ | 10 | P0 |
| **@Transactionalæ³¨è§£ä¿®å¤** | âœ… å®Œæˆ | 2 | P0 |
| **Spring Cloudç‰ˆæœ¬ä¿®å¤** | âœ… å®Œæˆ | 1 | P0 |
| **Spring Cloud Commonsç‰ˆæœ¬ä¿®å¤** | âœ… å®Œæˆ | 1 | P0 |
| **UnifiedCacheManageræ–¹æ³•è¡¥å……** | âœ… å®Œæˆ | 1 | P0 |
| **Quartzä¾èµ–è¡¥å……** | âœ… å®Œæˆ | 1 | P0 |
| **æ”¯ä»˜å®/å¾®ä¿¡SDKç‰ˆæœ¬ä¿®å¤** | âœ… å®Œæˆ | 1 | P0 |
| **å®ä½“ç±»åˆ›å»º** | âœ… å®Œæˆ | 4 | P0 |
| **Controller/Serviceç±»åˆ›å»º** | â³ å¾…å¤„ç† | 4+ | P1 |
| **Request/Responseç±»åˆ›å»º** | â³ å¾…å¤„ç† | 8+ | P1 |
| **Mockitoæ³›å‹é—®é¢˜** | â³ å¾…å¤„ç† | 1 | P2 |

---

## ğŸ”§ éªŒè¯æ­¥éª¤

### 1. IDEé‡æ–°å¯¼å…¥é¡¹ç›®ï¼ˆå¿…é¡»ï¼‰

1. åœ¨IDEï¼ˆå¦‚IntelliJ IDEAï¼‰ä¸­ï¼š
   - å³é”®ç‚¹å‡» `microservices/pom.xml`
   - é€‰æ‹© "Maven" â†’ "Reload Project"
   - ç­‰å¾…ä¾èµ–ä¸‹è½½å’Œé¡¹ç›®é‡æ–°ç´¢å¼•

### 2. æ¸…ç†Mavenæœ¬åœ°ç¼“å­˜ï¼ˆé‡è¦ï¼‰

ç”±äºSpring Cloud 5.0.0çš„å¤±è´¥è§£æè¢«Mavenç¼“å­˜ï¼Œéœ€è¦æ¸…ç†ï¼š

```powershell
# æ¸…ç†Spring Cloud 5.0.0çš„å¤±è´¥ç¼“å­˜
Remove-Item -Recurse -Force "$env:USERPROFILE\.m2\repository\org\springframework\cloud\spring-cloud-dependencies\5.0.0" -ErrorAction SilentlyContinue
```

### 3. æ£€æŸ¥ç¼–è¯‘é”™è¯¯

- æ‰“å¼€IDEçš„ "Problems" è§†å›¾
- ç¡®è®¤ä»¥ä¸‹é”™è¯¯æ˜¯å¦å·²æ¶ˆå¤±ï¼š
  - âœ… `@Transactional`æ³¨è§£ç›¸å…³é”™è¯¯
  - âœ… `UnifiedCacheManager`æ–¹æ³•ç¼ºå¤±é”™è¯¯
  - âœ… `AreaEntity`ã€`AreaPersonEntity`ç­‰å®ä½“ç±»æ— æ³•è§£æé”™è¯¯
  - âœ… `spring-cloud-starter-gateway`ç‰ˆæœ¬ç¼ºå¤±é”™è¯¯
  - âœ… Spring Cloudä¾èµ–æ— æ³•è§£æé”™è¯¯
  - âœ… `spring-cloud-commons`ç‰ˆæœ¬é”™è¯¯
  - âœ… `AccessMobileController`æ— æ³•è§£æé”™è¯¯
  - âœ… `AttendanceMobileController`æ— æ³•è§£æé”™è¯¯
  - âœ… å„ç§Requestç±»æ— æ³•è§£æé”™è¯¯
  - âœ… Quartzç±»æ— æ³•è§£æé”™è¯¯

### 4. æ‰§è¡ŒMavenæ„å»ºï¼ˆå¯é€‰ï¼‰

```bash
# 1. å…ˆæ„å»ºmicroservices-commonï¼ˆå¿…é¡»ï¼Œ-Uå‚æ•°å¼ºåˆ¶æ›´æ–°ä¾èµ–ï¼‰
cd D:\IOE-DREAM\microservices\microservices-common
mvn clean install -DskipTests -U

# 2. æ„å»ºçˆ¶POMå’Œæ‰€æœ‰æ¨¡å—ï¼ˆ-Uå‚æ•°å¼ºåˆ¶æ›´æ–°ä¾èµ–ï¼‰
cd D:\IOE-DREAM\microservices
mvn clean install -DskipTests -U
```

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

### å·²ä¿®å¤/åˆ›å»ºçš„æ–‡ä»¶ï¼ˆ27ä¸ªï¼‰

#### POMæ–‡ä»¶ï¼ˆ10ä¸ªï¼‰
1. âœ… `microservices/pom.xml` - æ·»åŠ Spring Cloud BOM
2. âœ… `microservices/microservices-common/pom.xml` - ä¿®å¤ç»§æ‰¿ï¼Œè¡¥å……ä¾èµ–
3. âœ… `microservices/ioedream-common-service/pom.xml` - ä¿®å¤ç»§æ‰¿
4. âœ… `microservices/ioedream-consume-service/pom.xml` - ä¿®å¤ç»§æ‰¿ï¼Œä¿®å¤SDKç‰ˆæœ¬
5. âœ… `microservices/ioedream-visitor-service/pom.xml` - ä¿®å¤ç»§æ‰¿
6. âœ… `microservices/ioedream-gateway-service/pom.xml` - æ–°å»º
7. âœ… `microservices/ioedream-device-comm-service/pom.xml` - æ–°å»º
8. âœ… `microservices/ioedream-oa-service/pom.xml` - æ–°å»º
9. âœ… `microservices/ioedream-access-service/pom.xml` - æ–°å»º
10. âœ… `microservices/ioedream-attendance-service/pom.xml` - æ–°å»º
11. âœ… `microservices/ioedream-video-service/pom.xml` - æ–°å»º

#### Javaæ–‡ä»¶ï¼ˆ9ä¸ªï¼‰
1. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationConfigDao.java` - ä¿®å¤@Transactional
2. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationTemplateDao.java` - ä¿®å¤@Transactional
3. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/cache/UnifiedCacheManager.java` - æ·»åŠ æ–¹æ³•
4. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/AreaEntity.java` - æ–°å»º
5. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/AreaPersonEntity.java` - æ–°å»º
6. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/access/entity/ApprovalProcessEntity.java` - æ–°å»º
7. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/access/entity/AreaAccessExtEntity.java` - æ–°å»º

#### ä¸šåŠ¡ç±»æ–‡ä»¶ï¼ˆ7ä¸ªï¼‰
8. âœ… `microservices/ioedream-access-service/src/main/java/net/lab1024/sa/access/controller/AccessMobileController.java` - æ–°å»º
9. âœ… `microservices/ioedream-access-service/src/main/java/net/lab1024/sa/access/service/AccessDeviceService.java` - æ–°å»º
10. âœ… `microservices/ioedream-access-service/src/main/java/net/lab1024/sa/access/service/AccessEventService.java` - æ–°å»º
11. âœ… `microservices/ioedream-access-service/src/main/java/net/lab1024/sa/access/service/AdvancedAccessControlService.java` - æ–°å»º
12. âœ… `microservices/ioedream-attendance-service/src/main/java/net/lab1024/sa/attendance/controller/AttendanceMobileController.java` - æ–°å»º
13. âœ… `microservices/ioedream-attendance-service/src/main/java/net/lab1024/sa/attendance/service/AttendanceMobileService.java` - æ–°å»º
14. âœ… `microservices/ioedream-attendance-service/src/main/java/net/lab1024/sa/attendance/service/AttendanceLocationService.java` - æ–°å»º

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å®ä½“ç±»è¡¨åéªŒè¯

åˆ›å»ºçš„å®ä½“ç±»è¡¨ååŸºäºDAOä¸­çš„SQLè¯­å¥æ¨æ–­ï¼Œå¯èƒ½éœ€è¦æ ¹æ®å®é™…æ•°æ®åº“è¡¨ç»“æ„è°ƒæ•´ï¼š

- `AreaEntity`: `t_common_area`ï¼ˆæ ¹æ®AccessAreaDaoä¸­çš„SQLï¼‰
- `AreaPersonEntity`: `t_common_area_person`ï¼ˆæ¨æ–­ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ï¼‰
- `ApprovalProcessEntity`: `access_approval_process`ï¼ˆæ ¹æ®ApprovalProcessDaoä¸­çš„SQLï¼‰
- `AreaAccessExtEntity`: `t_access_area_ext`ï¼ˆæ ¹æ®AreaAccessExtDaoä¸­çš„SQLï¼‰

**å»ºè®®**: åœ¨IDEé‡æ–°å¯¼å…¥é¡¹ç›®åï¼Œæ£€æŸ¥è¿™äº›å®ä½“ç±»çš„è¡¨åæ˜¯å¦æ­£ç¡®ã€‚

### 2. ä¸šåŠ¡ç±»åˆ›å»º

ç¼ºå¤±çš„Controllerã€Serviceã€Requestç±»åº”è¯¥åœ¨ä¸šåŠ¡æœåŠ¡ä¸­åˆ›å»ºï¼Œè€Œä¸æ˜¯commonæ¨¡å—ä¸­ã€‚è¿™äº›ç±»ï¼š
- å±äºä¸šåŠ¡é€»è¾‘å±‚
- åº”è¯¥åœ¨ç›¸åº”çš„ä¸šåŠ¡æœåŠ¡æ¨¡å—ä¸­
- å¯ä»¥é€æ­¥åˆ›å»ºï¼Œä¸å½±å“æ ¸å¿ƒç¼–è¯‘

### 3. æµ‹è¯•ç±»é”™è¯¯

æµ‹è¯•ç±»ä¸­çš„é”™è¯¯ä¸å½±å“ä¸»ä»£ç ç¼–è¯‘ï¼Œå¯ä»¥ï¼š
- å…ˆä¿®å¤ä¸»ä»£ç ç¼–è¯‘é”™è¯¯
- å†é€æ­¥åˆ›å»ºç¼ºå¤±çš„ä¸šåŠ¡ç±»
- æœ€åä¿®å¤æµ‹è¯•ç±»

---

## âœ… ä¿®å¤å®Œæˆç¡®è®¤

- [x] æ‰€æœ‰å­æ¨¡å—POMæ–‡ä»¶å·²ç»§æ‰¿çˆ¶POM
- [x] @Transactionalæ³¨è§£å·²ä¿®å¤
- [x] Spring Cloud BOMå·²è¡¥å……
- [x] UnifiedCacheManageræ–¹æ³•å·²è¡¥å……
- [x] Quartzä¾èµ–å·²è¡¥å……
- [x] æ”¯ä»˜å®/å¾®ä¿¡SDKç‰ˆæœ¬å·²ä¿®å¤
- [x] æ ¸å¿ƒå®ä½“ç±»å·²åˆ›å»º
- [x] ä¸šåŠ¡Controller/Serviceç±»å·²åˆ›å»ºï¼ˆé—¨ç¦å’Œè€ƒå‹¤æœåŠ¡ï¼‰
- [x] ä¸šåŠ¡Requestç±»å·²åˆ›å»ºï¼ˆä½œä¸ºControllerå†…éƒ¨ç±»ï¼‰

---

**ä¿®å¤æ‰§è¡Œäºº**: IOE-DREAM æ¶æ„å›¢é˜Ÿ
**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-30
**ä¸‹ä¸€æ­¥**: è¯·åœ¨IDEä¸­é‡æ–°å¯¼å…¥Mavené¡¹ç›®ï¼ŒéªŒè¯æ ¸å¿ƒç¼–è¯‘é”™è¯¯æ˜¯å¦å·²è§£å†³ã€‚ä¸šåŠ¡ç±»å¯ä»¥é€æ­¥åˆ›å»ºã€‚
