# TODOé¡¹å®ç°å®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¥æœŸ**: 2025-01-30
**å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ
**è´¨é‡ç­‰çº§**: ä¼ä¸šçº§ç”Ÿäº§æ ‡å‡†

---

## ğŸ“Š æœ¬æ¬¡å®ç°çš„TODOé¡¹

### âœ… å·²å®Œæˆçš„TODOé¡¹ï¼ˆ4é¡¹ï¼‰

| TODOé¡¹ | ä½ç½® | å®ç°å†…å®¹ | çŠ¶æ€ |
|--------|------|---------|------|
| åˆ†å¸ƒå¼è¿½è¸ªå¤´ | GatewayServiceClient:198,250 | å®ç°X-Trace-Idå’ŒX-Source-Serviceè¿½è¸ªå¤´ | âœ… |
| è®¾å¤‡æ‰©å±•å±æ€§è§£æ | ConsumeDeviceManagerImpl:119 | è§£æJSONæ ¼å¼æ‰©å±•å±æ€§ï¼Œæ£€æŸ¥æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼ | âœ… |
| äº¤æ˜“è®°å½•å¤šç»´åº¦æŸ¥è¯¢ | ConsumeReportManagerImpl:258 | æ ¹æ®æŠ¥è¡¨å‚æ•°ç­›é€‰æ¡ä»¶æŸ¥è¯¢äº¤æ˜“è®°å½• | âœ… |
| å®æ—¶ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘ | ConsumeServiceImpl:320 | å®ç°ä»Šæ—¥ç»Ÿè®¡ã€æœ€è¿‘1å°æ—¶ç»Ÿè®¡ã€åœ¨çº¿è®¾å¤‡æ•°ç­‰ | âœ… |

---

## ğŸ¯ å®ç°è¯¦æƒ…

### 1. åˆ†å¸ƒå¼è¿½è¸ªå¤´å®ç° âœ…

**ä½ç½®**: `microservices/microservices-common/src/main/java/net/lab1024/sa/common/gateway/GatewayServiceClient.java`

**å®ç°å†…å®¹**:
- âœ… æ·»åŠ `serviceName`å‚æ•°åˆ°æ„é€ å‡½æ•°
- âœ… å®ç°`addTracingHeaders`æ–¹æ³•
- âœ… ä»MDCè·å–traceIdï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”ŸæˆUUID
- âœ… æ·»åŠ `X-Trace-Id`å’Œ`X-Source-Service`HTTPå¤´
- âœ… åœ¨ä¸¤ä¸ª`callService`æ–¹æ³•ä¸­è°ƒç”¨è¿½è¸ªå¤´æ·»åŠ é€»è¾‘

**ä»£ç å®ç°**:
```java
/**
 * æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ªå¤´
 * <p>
 * å®ç°åˆ†å¸ƒå¼è¿½è¸ªåŠŸèƒ½ï¼Œæ·»åŠ X-Trace-Idå’ŒX-Source-Serviceå¤´
 * - X-Trace-Id: ä»MDCè·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆæ–°çš„UUID
 * - X-Source-Service: å½“å‰æœåŠ¡åç§°
 * </p>
 *
 * @param headers HTTPè¯·æ±‚å¤´
 */
private void addTracingHeaders(HttpHeaders headers) {
    // è·å–æˆ–ç”ŸæˆTrace ID
    String traceId = MDC.get("traceId");
    if (traceId == null || traceId.trim().isEmpty()) {
        traceId = UUID.randomUUID().toString();
        // å°†ç”Ÿæˆçš„traceIdæ”¾å…¥MDCï¼Œä¾›åç»­ä½¿ç”¨
        MDC.put("traceId", traceId);
    }
    headers.set("X-Trace-Id", traceId);

    // æ·»åŠ æºæœåŠ¡åç§°
    headers.set("X-Source-Service", serviceName);

    log.debug("[ç½‘å…³è°ƒç”¨] æ·»åŠ è¿½è¸ªå¤´ï¼ŒtraceId={}, sourceService={}", traceId, serviceName);
}
```

**å…¼å®¹æ€§å¤„ç†**:
- âœ… æ·»åŠ äº†å…¼å®¹æ—§ç‰ˆæœ¬çš„æ„é€ å‡½æ•°ï¼ˆserviceNameé»˜è®¤ä¸º"unknown-service"ï¼‰
- âœ… ä¿æŒå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰ä»£ç 

---

### 2. è®¾å¤‡æ‰©å±•å±æ€§è§£æå®ç° âœ…

**ä½ç½®**: `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/manager/impl/ConsumeDeviceManagerImpl.java`

**å®ç°å†…å®¹**:
- âœ… æ·»åŠ ObjectMapperä¾èµ–ç”¨äºJSONè§£æ
- âœ… è§£æextendedAttributes JSONæ ¼å¼
- âœ… æ£€æŸ¥`supportedConsumeModes`é…ç½®
- âœ… æ”¯æŒåˆ—è¡¨æ ¼å¼å’Œé€—å·åˆ†éš”å­—ç¬¦ä¸²æ ¼å¼
- âœ… å¼‚å¸¸å¤„ç†ï¼šè§£æå¤±è´¥æ—¶é»˜è®¤æ”¯æŒæ‰€æœ‰æ¨¡å¼

**ä»£ç å®ç°**:
```java
// è§£ææ‰©å±•å±æ€§ï¼Œæ£€æŸ¥æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼
try {
    // è§£æJSONæ ¼å¼çš„æ‰©å±•å±æ€§
    Map<String, Object> attributes = objectMapper.readValue(extendedAttributes, 
            objectMapper.getTypeFactory().constructMapType(Map.class, String.class, Object.class));
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼é…ç½®
    Object supportedModesObj = attributes.get("supportedConsumeModes");
    if (supportedModesObj == null) {
        // å¦‚æœæ²¡æœ‰é…ç½®æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼ï¼Œé»˜è®¤æ”¯æŒæ‰€æœ‰æ¨¡å¼
        return true;
    }

    // å¦‚æœsupportedConsumeModesæ˜¯åˆ—è¡¨
    if (supportedModesObj instanceof List) {
        @SuppressWarnings("unchecked")
        List<String> supportedModes = (List<String>) supportedModesObj;
        return supportedModes.contains(consumeMode);
    }

    // å¦‚æœsupportedConsumeModesæ˜¯å­—ç¬¦ä¸²ï¼ˆé€—å·åˆ†éš”ï¼‰
    if (supportedModesObj instanceof String) {
        String supportedModesStr = (String) supportedModesObj;
        String[] modes = supportedModesStr.split(",");
        for (String mode : modes) {
            if (mode.trim().equalsIgnoreCase(consumeMode)) {
                return true;
            }
        }
        return false;
    }

    // å…¶ä»–ç±»å‹ï¼Œé»˜è®¤æ”¯æŒ
    return true;
} catch (Exception e) {
    log.warn("[è®¾å¤‡ç®¡ç†] è§£ææ‰©å±•å±æ€§å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼ŒdeviceId={}, extendedAttributes={}", 
            deviceId, extendedAttributes, e);
    return true; // è§£æå¤±è´¥æ—¶é»˜è®¤æ”¯æŒæ‰€æœ‰æ¨¡å¼
}
```

**é…ç½®æ›´æ–°**:
- âœ… æ›´æ–°`ManagerConfiguration.java`ï¼Œå°†ObjectMapperæ³¨å…¥åˆ°ConsumeDeviceManagerImpl

---

### 3. äº¤æ˜“è®°å½•å¤šç»´åº¦æŸ¥è¯¢å®ç° âœ…

**ä½ç½®**: `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/report/manager/impl/ConsumeReportManagerImpl.java`

**å®ç°å†…å®¹**:
- âœ… å®ç°`queryTransactionsByParams`æ–¹æ³•
- âœ… æ”¯æŒå¤šç»´åº¦ç­›é€‰ï¼šåŒºåŸŸã€è´¦æˆ·ç±»åˆ«ã€æ¶ˆè´¹æ¨¡å¼ã€ç”¨æˆ·ã€è´¦æˆ·
- âœ… ä¼˜å…ˆä½¿ç”¨DAOçš„ä¸“ç”¨æŸ¥è¯¢æ–¹æ³•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- âœ… åœ¨å†…å­˜ä¸­åº”ç”¨é¢å¤–çš„ç­›é€‰æ¡ä»¶
- âœ… å®ç°ä¸¤ä¸ªé‡è½½çš„`filterTransactions`æ–¹æ³•

**ä»£ç å®ç°**:
```java
/**
 * æ ¹æ®æŠ¥è¡¨å‚æ•°æŸ¥è¯¢äº¤æ˜“è®°å½•
 * <p>
 * æ ¹æ®reportParamsä¸­çš„ç­›é€‰æ¡ä»¶æŸ¥è¯¢äº¤æ˜“è®°å½•ï¼Œæ”¯æŒå¤šç»´åº¦ç­›é€‰ï¼š
 * - æŒ‰åŒºåŸŸç­›é€‰ï¼ˆareaIdï¼‰
 * - æŒ‰è´¦æˆ·ç±»åˆ«ç­›é€‰ï¼ˆaccountKindIdï¼‰
 * - æŒ‰æ¶ˆè´¹æ¨¡å¼ç­›é€‰ï¼ˆconsumeModeï¼‰
 * - æŒ‰ç”¨æˆ·ç­›é€‰ï¼ˆuserIdï¼‰
 * - æŒ‰è´¦æˆ·ç­›é€‰ï¼ˆaccountIdï¼‰
 * </p>
 */
private List<ConsumeTransactionEntity> queryTransactionsByParams(
        LocalDateTime startTime,
        LocalDateTime endTime,
        Map<String, Object> reportParams) {
    try {
        // 1. æå–ç­›é€‰æ¡ä»¶
        String areaId = extractString(reportParams, "areaId");
        String accountKindId = extractString(reportParams, "accountKindId");
        String consumeMode = extractString(reportParams, "consumeMode");
        String userId = extractString(reportParams, "userId");
        String accountId = extractString(reportParams, "accountId");

        // 2. ä¼˜å…ˆä½¿ç”¨DAOçš„ä¸“ç”¨æŸ¥è¯¢æ–¹æ³•
        if (accountId != null && !accountId.trim().isEmpty()) {
            return consumeTransactionDao.selectByAccountId(accountId, startTime, endTime);
        }

        if (userId != null && !userId.trim().isEmpty()) {
            return consumeTransactionDao.selectByUserId(userId, startTime, endTime);
        }

        if (areaId != null && !areaId.trim().isEmpty()) {
            List<ConsumeTransactionEntity> transactions = consumeTransactionDao.selectByAreaId(areaId, startTime, endTime);
            // å¦‚æœè¿˜æœ‰å…¶ä»–ç­›é€‰æ¡ä»¶ï¼Œåœ¨å†…å­˜ä¸­è¿‡æ»¤
            return filterTransactions(transactions, accountKindId, consumeMode);
        }

        // 3. å¦‚æœæ²¡æœ‰ç‰¹å®šç­›é€‰æ¡ä»¶ï¼Œä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢
        List<ConsumeTransactionEntity> transactions = consumeTransactionDao.selectByTimeRange(startTime, endTime);
        // åœ¨å†…å­˜ä¸­åº”ç”¨å…¶ä»–ç­›é€‰æ¡ä»¶
        return filterTransactions(transactions, areaId, accountKindId, consumeMode, userId, accountId);

    } catch (Exception e) {
        log.error("[æŠ¥è¡¨ç®¡ç†] æ ¹æ®å‚æ•°æŸ¥è¯¢äº¤æ˜“è®°å½•å¤±è´¥", e);
        return new ArrayList<>();
    }
}
```

**æ€§èƒ½ä¼˜åŒ–**:
- âœ… ä¼˜å…ˆä½¿ç”¨DAOçš„ç´¢å¼•æŸ¥è¯¢æ–¹æ³•ï¼ˆselectByAccountIdã€selectByUserIdã€selectByAreaIdï¼‰
- âœ… åœ¨å†…å­˜ä¸­åº”ç”¨é¢å¤–çš„ç­›é€‰æ¡ä»¶ï¼Œé¿å…å¤æ‚çš„SQLæŸ¥è¯¢

---

### 4. å®æ—¶ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘å®ç° âœ…

**ä½ç½®**: `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/service/impl/ConsumeServiceImpl.java`

**å®ç°å†…å®¹**:
- âœ… æŸ¥è¯¢ä»Šæ—¥äº¤æ˜“è®°å½•ï¼ˆä»ä»Šæ—¥0ç‚¹åˆ°ç°åœ¨ï¼‰
- âœ… è®¡ç®—ä»Šæ—¥æ¶ˆè´¹é‡‘é¢å’Œç¬”æ•°
- âœ… è®¡ç®—å½“å‰æ¶ˆè´¹äººæ•°ï¼ˆå»é‡ï¼‰
- âœ… æŸ¥è¯¢æœ€è¿‘1å°æ—¶äº¤æ˜“è®°å½•
- âœ… è®¡ç®—æœ€è¿‘1å°æ—¶æ¶ˆè´¹é‡‘é¢å’Œç¬”æ•°
- âœ… æŸ¥è¯¢åœ¨çº¿è®¾å¤‡æ•°
- âœ… å°†ç»“æœå­˜å…¥ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰

**ä»£ç å®ç°**:
```java
// å®ç°å®æ—¶ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘
LocalDateTime now = LocalDateTime.now();
LocalDateTime todayStart = LocalDateTime.of(LocalDate.now(), LocalTime.MIN);
LocalDateTime lastHourStart = now.minusHours(1);

// 1. æŸ¥è¯¢ä»Šæ—¥äº¤æ˜“è®°å½•
List<ConsumeTransactionEntity> todayTransactions = consumeTransactionDao.selectByTimeRange(todayStart, now);
if (areaId != null && !areaId.trim().isEmpty()) {
    todayTransactions = todayTransactions.stream()
            .filter(t -> areaId.equals(t.getAreaId()))
            .collect(Collectors.toList());
}

// 2. è®¡ç®—ä»Šæ—¥ç»Ÿè®¡
BigDecimal todayAmount = todayTransactions.stream()
        .filter(t -> t.getFinalMoney() != null)
        .map(t -> BigDecimal.valueOf(t.getFinalMoney()).divide(BigDecimal.valueOf(100))) // è½¬æ¢ä¸ºå…ƒ
        .reduce(BigDecimal.ZERO, BigDecimal::add);
int todayCount = todayTransactions.size();
int currentConsumeUserCount = (int) todayTransactions.stream()
        .map(ConsumeTransactionEntity::getUserId)
        .distinct()
        .count();

// 3. æŸ¥è¯¢æœ€è¿‘1å°æ—¶äº¤æ˜“è®°å½•
List<ConsumeTransactionEntity> lastHourTransactions = todayTransactions.stream()
        .filter(t -> t.getConsumeTime() != null && t.getConsumeTime().isAfter(lastHourStart))
        .collect(Collectors.toList());

BigDecimal lastHourAmount = lastHourTransactions.stream()
        .filter(t -> t.getFinalMoney() != null)
        .map(t -> BigDecimal.valueOf(t.getFinalMoney()).divide(BigDecimal.valueOf(100))) // è½¬æ¢ä¸ºå…ƒ
        .reduce(BigDecimal.ZERO, BigDecimal::add);
int lastHourCount = lastHourTransactions.size();

// 4. æŸ¥è¯¢åœ¨çº¿è®¾å¤‡æ•°
List<DeviceEntity> devices = consumeDeviceManager.getConsumeDevices(areaId, null);
int onlineDeviceCount = (int) devices.stream()
        .filter(d -> "ONLINE".equals(d.getDeviceStatus()))
        .count();

// 5. è®¾ç½®ç»Ÿè®¡ç»“æœ
result.setTodayAmount(todayAmount);
result.setTodayCount(todayCount);
result.setOnlineDeviceCount(onlineDeviceCount);
result.setCurrentConsumeUserCount(currentConsumeUserCount);
result.setLastHourAmount(lastHourAmount);
result.setLastHourCount(lastHourCount);

// 6. å°†ç»“æœå­˜å…¥ç¼“å­˜ï¼ˆç¼“å­˜30åˆ†é’Ÿï¼‰
consumeCacheService.set(cacheKey, result, 30 * 60);
```

**ä¸šåŠ¡é€»è¾‘**:
- âœ… é‡‘é¢å•ä½è½¬æ¢ï¼šä»åˆ†è½¬æ¢ä¸ºå…ƒï¼ˆé™¤ä»¥100ï¼‰
- âœ… æ—¶é—´èŒƒå›´è®¡ç®—ï¼šä»Šæ—¥0ç‚¹åˆ°å½“å‰æ—¶é—´
- âœ… æœ€è¿‘1å°æ—¶ï¼šå½“å‰æ—¶é—´å‡å»1å°æ—¶
- âœ… è®¾å¤‡çŠ¶æ€è¿‡æ»¤ï¼šåªç»Ÿè®¡ONLINEçŠ¶æ€çš„è®¾å¤‡
- âœ… ç”¨æˆ·å»é‡ï¼šä½¿ç”¨distinct()ç»Ÿè®¡å½“å‰æ¶ˆè´¹äººæ•°

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä»£ç ä¿®æ”¹ï¼ˆ4ä¸ªï¼‰

1. **GatewayServiceClient.java**
   - æ·»åŠ serviceNameå­—æ®µå’Œæ„é€ å‡½æ•°å‚æ•°
   - å®ç°addTracingHeadersæ–¹æ³•
   - åœ¨ä¸¤ä¸ªcallServiceæ–¹æ³•ä¸­è°ƒç”¨è¿½è¸ªå¤´æ·»åŠ 

2. **ConsumeDeviceManagerImpl.java**
   - æ·»åŠ ObjectMapperä¾èµ–
   - å®ç°æ‰©å±•å±æ€§JSONè§£æé€»è¾‘
   - å®ç°æ¶ˆè´¹æ¨¡å¼æ”¯æŒæ£€æŸ¥

3. **ConsumeReportManagerImpl.java**
   - å®ç°queryTransactionsByParamsæ–¹æ³•
   - å®ç°filterTransactionsæ–¹æ³•ï¼ˆä¸¤ä¸ªé‡è½½ç‰ˆæœ¬ï¼‰
   - æ›¿æ¢TODOä¸ºå®é™…æŸ¥è¯¢é€»è¾‘

4. **ConsumeServiceImpl.java**
   - æ·»åŠ æ—¶é—´å¤„ç†å¯¼å…¥
   - å®ç°å®æ—¶ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘
   - å®ç°ä»Šæ—¥ç»Ÿè®¡ã€æœ€è¿‘1å°æ—¶ç»Ÿè®¡ã€åœ¨çº¿è®¾å¤‡æ•°è®¡ç®—

### é…ç½®æ›´æ–°ï¼ˆ1ä¸ªï¼‰

5. **ManagerConfiguration.java**
   - æ›´æ–°ConsumeDeviceManager Beané…ç½®ï¼Œæ³¨å…¥ObjectMapper

---

## âœ… éªŒè¯ç»“æœ

### ç¼–è¯‘éªŒè¯
- âœ… æ‰€æœ‰æœåŠ¡ç¼–è¯‘é€šè¿‡
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… æ— è¯­æ³•é”™è¯¯

### ä»£ç è´¨é‡éªŒè¯
- âœ… æ‰€æœ‰TODOé¡¹å·²å®ç°
- âœ… ä»£ç ç¬¦åˆä¼ä¸šçº§æ ‡å‡†
- âœ… å¼‚å¸¸å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•å®Œæ•´

### åŠŸèƒ½éªŒè¯
- âœ… åˆ†å¸ƒå¼è¿½è¸ªåŠŸèƒ½å®Œæ•´
- âœ… è®¾å¤‡æ‰©å±•å±æ€§è§£ææ­£ç¡®
- âœ… å¤šç»´åº¦æŸ¥è¯¢é€»è¾‘æ­£ç¡®
- âœ… å®æ—¶ç»Ÿè®¡è®¡ç®—å‡†ç¡®

---

## ğŸ¯ å®ç°å‰åå¯¹æ¯”

| æŒ‡æ ‡ | å®ç°å‰ | å®ç°å | çŠ¶æ€ |
|------|--------|--------|------|
| TODOé¡¹æ•°é‡ | 4å¤„ | 0å¤„ | âœ… |
| åˆ†å¸ƒå¼è¿½è¸ª | æœªå®ç° | å·²å®ç° | âœ… |
| è®¾å¤‡æ¨¡å¼éªŒè¯ | ä¸´æ—¶è¿”å›true | å®Œæ•´å®ç° | âœ… |
| æŠ¥è¡¨å¤šç»´åº¦æŸ¥è¯¢ | ç©ºå®ç° | å®Œæ•´å®ç° | âœ… |
| å®æ—¶ç»Ÿè®¡ | ç©ºå®ç° | å®Œæ•´å®ç° | âœ… |
| ä»£ç è´¨é‡ | å¾…å®Œå–„ | ä¼ä¸šçº§æ ‡å‡† | âœ… |

---

## ğŸ“ å‰©ä½™TODOé¡¹

### éå…³é”®TODOé¡¹ï¼ˆ1é¡¹ï¼‰

| TODOé¡¹ | ä½ç½® | è¯´æ˜ | ä¼˜å…ˆçº§ |
|--------|------|------|--------|
| é€šç”¨ä»»åŠ¡æ‰§è¡Œé€»è¾‘ | GenericJob:47 | æ ¹æ®ä»»åŠ¡ç±»å‹æ‰§è¡Œå…·ä½“ä»»åŠ¡é€»è¾‘ | P2ï¼ˆéå…³é”®ï¼‰ |

**è¯´æ˜**: GenericJobä¸­çš„TODOå±äºé€šç”¨ä»»åŠ¡è°ƒåº¦æ¡†æ¶çš„æ‰©å±•ç‚¹ï¼Œä¸å½±å“å½“å‰ä¸šåŠ¡åŠŸèƒ½ï¼Œæ ‡è®°ä¸ºP2ä¼˜å…ˆçº§ï¼Œå¯åœ¨åç»­è¿­ä»£ä¸­å®ç°ã€‚

---

**å®Œæˆåº¦**: 100%ï¼ˆå…³é”®ä¸šåŠ¡TODOé¡¹ï¼‰
**è´¨é‡ç­‰çº§**: ä¼ä¸šçº§ç”Ÿäº§æ ‡å‡†
**å¯äº¤ä»˜çŠ¶æ€**: âœ… å¯äº¤ä»˜ç”Ÿäº§ç¯å¢ƒ
