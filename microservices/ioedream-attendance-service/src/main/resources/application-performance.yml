# ============================================================
# IOE-DREAM Attendance Service - Spring Boot 3.5.8 配置
# 考勤管理服务 - 企业级生产环境配置
#
# 技术标准: Spring Boot 3.5.8 + Jakarta EE 9.0 + Java 17
# 遵循规范: 完全兼容Spring Boot 3.x配置模式
#
# @Author: IOE-DREAM架构委员会
# @Version: v1.0.0-企业级重构版
# @Date: 2025-01-30
# ============================================================

# ==================== Spring Boot 核心配置 ====================
spring:
  application:
    name: ioedream-attendance-service

  # ==================== 数据源配置 (Spring Boot 3.x标准) ====================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # 连接池基础配置
      initial-size: 10
      min-idle: 10
      max-active: 50
      max-wait: 60000

      # 性能优化配置
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false

      # 连接池监控配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
      filter:
        stat:
          enabled: true
          slow-sql-millis: 1000
          log-slow-sql: true

  # ==================== Redis配置 (Spring Boot 3.x标准) ====================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:ENC(AES256:encrypted_password)}
      database: ${REDIS_DATABASE:0}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 2000ms

  # ==================== 缓存配置 (Spring Boot 3.x标准) ====================
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=10000,expireAfterWrite=30m,recordStats

  # ==================== MyBatis-Plus配置 (Spring Boot 3.x兼容) ====================
  mybatis-plus:
    # 全局配置
    global-config:
      db-config:
        logic-delete-field: deletedFlag
        logic-delete-value: 1
        logic-not-delete-value: 0
        id-type: ASSIGN_ID
        table-underline: true

    # 配置信息
    configuration:
      map-underscore-to-camel-case: true
      cache-enabled: true
      call-setters-on-nulls: true
      log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

  # ==================== 事务配置 ====================
  transaction:
    default-timeout: 30
    rollback-on-commit-failure: true

# ==================== 服务器配置 ====================
server:
  port: 8091
  servlet:
    context-path: /attendance
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    threads:
      max: 200
      min-spare: 20
    max-connections: 8192
    accept-count: 100
    connection-timeout: 20000

# ==================== 管理端点配置 (Spring Boot 3.x标准) ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: always
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# ==================== 日志配置 (Spring Boot 3.x标准) ====================
logging:
  level:
    root: INFO
    "net.lab1024.sa.attendance": DEBUG
    "org.springframework.web": INFO
    "com.alibaba.druid": INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/attendance-service.log
    max-size: 100MB
    max-history: 30

# ==================== 业务配置 (需要@ConfigurationProperties类支持) ====================
# 注意：以下自定义配置属性需要在对应的ConfigurationProperties类中定义
# 当前版本暂时使用Spring Boot标准配置，避免未定义的属性错误

# ==================== 环境特定配置 ====================
---
spring:
  config:
    activate:
      on-profile: dev

logging:
  level:
    root: DEBUG

---
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
  file:
    name: logs/attendance-service-prod.log
