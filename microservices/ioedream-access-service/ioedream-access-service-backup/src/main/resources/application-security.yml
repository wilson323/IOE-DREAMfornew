# =============================================
# 门禁微服务安全配置
# =============================================

# JWT安全配置
jwt:
  # JWT密钥（生产环境应使用环境变量）
  secret: ${JWT_SECRET:IOE-DREAM-ACCESS-SERVICE-SECRET-KEY-2025-JWT-SECURITY-CONFIGURATION}
  # JWT有效期（小时）
  expiration: ${JWT_EXPIRATION:24}
  # 刷新Token有效期（天）
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:7}
  # Token发行者
  issuer: ${JWT_ISSUER:IOE-DREAM-ACCESS-SERVICE}
  # Token受众
  audience: ${JWT_AUDIENCE:IOE-DREAM-USERS}
  # 算法
  algorithm: HS256
  # Base64编码
  base64-secret: false
  # 是否允许相同用户多设备登录
  allow-multi-device: true
  # 最大同时登录设备数
  max-devices-per-user: 5

# 密码安全配置
password:
  # 加密算法
  algorithm: BCrypt
  # 加密强度
  strength: 12
  # 密码最小长度
  min-length: 8
  # 密码最大长度
  max-length: 128
  # 密码复杂度要求
  complexity:
    # 是否包含数字
    require-digit: true
    # 是否包含小写字母
    require-lowercase: true
    # 是否包含大写字母
    require-uppercase: true
    # 是否包含特殊字符
    require-special-char: true
    # 特殊字符集合
    special-chars: "!@#$%^&*()_+-=[]{}|;:,.<>?"
  # 密码历史检查
  history:
    # 是否启用密码历史
    enabled: true
    # 历史密码数量
    count: 5
  # 密码过期策略
  expiration:
    # 是否启用密码过期
    enabled: true
    # 密码有效期（天）
    days: 90
    # 过期前警告天数
    warning-days: 7

# 访问控制配置
access-control:
  # IP白名单
  ip-whitelist:
    # 是否启用IP白名单
    enabled: ${IP_WHITELIST_ENABLED:false}
    # 白名单IP列表
    allowed-ips:
      - 127.0.0.1
      - 192.168.1.0/24
      - 10.0.0.0/8
    # 管理员专用IP
    admin-ips:
      - 192.168.1.100
      - 10.0.0.1

  # 黑名单配置
  blacklist:
    # 是否启用黑名单
    enabled: true
    # 黑名单类型
    types:
      - IP
      - USER
      - DEVICE
    # 黑名单更新间隔（分钟）
    update-interval: 5

  # 角色权限配置
  roles:
    # 管理员角色
    ADMIN:
      # 权限列表
      permissions:
        - ACCESS_ADMIN
        - USER_ADMIN
        - DEVICE_ADMIN
        - SYSTEM_ADMIN
      # 访问范围
      access-scopes:
        - /api/v1/access/admin/**
        - /api/v1/access/advanced/admin/**
        - /actuator/**

    # 操作员角色
    OPERATOR:
      # 权限列表
      permissions:
        - ACCESS_READ
        - ACCESS_WRITE
        - DEVICE_CONTROL
        - MONITOR_VIEW
      # 访问范围
      access-scopes:
        - /api/v1/access/**
        - /api/v1/access/advanced/**
        - /api/v1/access/mobile/**

    # 普通用户角色
    USER:
      # 权限列表
      permissions:
        - ACCESS_SELF
        - DEVICE_MOBILE_ACCESS
      # 访问范围
      access-scopes:
        - /api/v1/access/mobile/**
        - /api/v1/access/self/**

# API安全配置
api-security:
  # 请求签名验证
  signature:
    # 是否启用签名验证
    enabled: false
    # 签名算法
    algorithm: HMAC-SHA256
    # 签名密钥
    secret: ${API_SIGNATURE_SECRET:IOE-DREAM-API-SIGNATURE-SECRET}
    # 签名头部名称
    header-name: X-Signature
    # 时间戳头部名称
    timestamp-header: X-Timestamp
    # 签名有效期（秒）
    expiration: 300

  # API版本控制
  versioning:
    # 是否启用版本控制
    enabled: true
    # 版本参数名
    parameter-name: version
    # 默认版本
    default-version: v1
    # 支持的版本
    supported-versions:
      - v1

  # 敏感操作验证
  sensitive-operations:
    # 是否启用二次验证
    two-factor-enabled: true
    # 敏感操作列表
    operations:
      - DELETE_USER
      - RESET_PASSWORD
      - MODIFY_ROLES
      - EXPORT_DATA
      - SYSTEM_CONFIG
    # 二次验证方式
    two-factor-methods:
      - SMS
      - EMAIL
      - TOTP

# 数据安全配置
data-security:
  # 数据加密
  encryption:
    # 是否启用数据加密
    enabled: true
    # 加密算法
    algorithm: AES-256-GCM
    # 数据库字段加密
    field-encryption:
      # 是否启用字段级加密
      enabled: true
      # 加密字段列表
      encrypted-fields:
        - user.phone
        - user.email
        - user.idCard
        - device.secretKey

  # 数据脱敏
  data-masking:
    # 是否启用数据脱敏
    enabled: true
    # 脱敏规则
    rules:
      phone: "mask_phone"  # 手机号脱敏
      email: "mask_email"  # 邮箱脱敏
      idCard: "mask_id_card"  # 身份证脱敏
      bankCard: "mask_bank_card"  # 银行卡脱敏

  # 审计日志
  audit-log:
    # 是否启用审计日志
    enabled: true
    # 审计事件类型
    event-types:
      - LOGIN
      - LOGOUT
      - ACCESS_REQUEST
      - PERMISSION_CHANGE
      - DATA_MODIFY
      - SYSTEM_CONFIG
      - SECURITY_EVENT
    # 日志保留天数
    retention-days: 90
    # 敏感字段过滤
    sensitive-fields:
      - password
      - secretKey
      - token
      - session

# 会话安全配置
session-security:
  # 会话管理
  session:
    # 会话超时时间（分钟）
    timeout: 30
    # 是否启用会话固定保护
    fixation-protection: true
    # 会话并发控制
    concurrency-control:
      # 最大并发会话数
      max-sessions: 3
      # 是否阻止新登录
      block-new-login: false
      # 是否踢出旧会话
      expire-old-session: true

  # 防会话劫持
  session-hijacking:
    # 是否启用防劫持
    enabled: true
    # IP绑定验证
    ip-binding: true
    # User-Agent绑定验证
    ua-binding: true
    # 设备指纹验证
    device-fingerprint: true

# 网络安全配置
network-security:
  # HTTPS配置
  https:
    # 是否强制HTTPS
    force: true
    # HSTS配置
    hsts:
      # HSTS最大时间（秒）
      max-age: 31536000
      # 是否包含子域名
      include-subdomains: true
      # 是否预加载
      preload: true

  # 安全头部配置
  security-headers:
    # X-Frame-Options
    x-frame-options: DENY
    # X-Content-Type-Options
    x-content-type-options: nosniff
    # X-XSS-Protection
    x-xss-protection: "1; mode=block"
    # Referrer Policy
    referrer-policy: strict-origin-when-cross-origin
    # Content Security Policy
    content-security-policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'"

# 频率限制配置
rate-limiting:
  # 全局频率限制
  global:
    # 是否启用全局限制
    enabled: true
    # 每分钟请求数
    requests-per-minute: 1000
    # 突发容量
    burst-capacity: 2000
    # 补充速率
    replenish-rate: 1000

  # 按用户限制
  per-user:
    # 是否启用用户限制
    enabled: true
    # 普通用户限制
    normal-user:
      requests-per-minute: 100
      burst-capacity: 200
    # VIP用户限制
    vip-user:
      requests-per-minute: 500
      burst-capacity: 1000
    # 管理员用户限制
    admin-user:
      requests-per-minute: 1000
      burst-capacity: 2000

  # 按IP限制
  per-ip:
    # 是否启用IP限制
    enabled: true
    # 每分钟请求数
    requests-per-minute: 200
    # 突发容量
    burst-capacity: 400
    # 白名单IP（不受限制）
    whitelist:
      - 127.0.0.1
      - 192.168.1.0/24

  # 按接口限制
  per-endpoint:
    # 是否启用接口限制
    enabled: true
    # 接口限制配置
    endpoints:
      /api/v1/access/mobile/login:
        requests-per-minute: 10
        burst-capacity: 20
      /api/v1/access/mobile/refresh/token:
        requests-per-minute: 30
        burst-capacity: 60
      /api/v1/access/record:
        requests-per-minute: 500
        burst-capacity: 1000
      /api/v1/access/advanced/ai/**:
        requests-per-minute: 50
        burst-capacity: 100

# 环境特定配置
---
spring:
  config:
    activate:
      on-profile: dev

# 开发环境安全配置（相对宽松）
jwt:
  expiration: 168  # 7天
access-control:
  ip-whitelist:
    enabled: false
api-security:
  signature:
    enabled: false
rate-limiting:
  global:
    requests-per-minute: 5000

---
spring:
  config:
    activate:
      on-profile: test

# 测试环境安全配置
jwt:
  expiration: 2  # 2小时
access-control:
  ip-whitelist:
    enabled: false
api-security:
  signature:
    enabled: false
data-security:
  encryption:
    field-encryption:
      enabled: false

---
spring:
  config:
    activate:
      on-profile: prod

# 生产环境安全配置（最严格）
jwt:
  secret: ${JWT_SECRET}  # 必须从环境变量获取
  expiration: 8  # 8小时
access-control:
  ip-whitelist:
    enabled: true
    allowed-ips: ${ALLOWED_IPS:127.0.0.1,10.0.0.0/8}
api-security:
  signature:
    enabled: true
    secret: ${API_SIGNATURE_SECRET}
data-security:
  encryption:
    field-encryption:
      enabled: true
rate-limiting:
  global:
    requests-per-minute: 500
  per-user:
    enabled: true
  per-ip:
    enabled: true
network-security:
  https:
    force: true