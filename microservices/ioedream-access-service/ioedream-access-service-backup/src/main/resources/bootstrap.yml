# ============================================================
# IOE-DREAM Access Service Bootstrap 配置
#
# @Author:    IOE-DREAM Team
# @Date:      2025-12-09
# @Copyright:  IOE-DREAM智慧园区一卡通管理平台
#
# 服务信息:
# - 服务名称: ioedream-access-service
# - 服务端口: 8090
# - 服务职责: 门禁管理微服务，提供门禁控制、通行记录、权限管理等功能
# ============================================================

# ==================== 应用基础配置 ====================
spring:
  application:
    name: ${SERVICE_NAME:ioedream-access-service}

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # ==================== Nacos服务发现配置 ====================
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:IOE-DREAM}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD}
        enabled: true
        register-enabled: true
        # 服务注册元数据
        metadata:
          version: ${SERVICE_VERSION:1.0.0}
          zone: ${ZONE:dev}
          cluster: ${CLUSTER:default}
          environment: ${ENVIRONMENT:dev}
          access-types: "card,biometric,face,fingerprint,palm,qr-code"
          anti-passback: true
          real-time-monitoring: true

      config:
        server-addr: ${NACOS_SERVER_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:IOE-DREAM}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:nacos}
        file-extension: yaml
        enabled: ${NACOS_CONFIG_ENABLED:true}
        refresh-enabled: ${NACOS_CONFIG_REFRESH_ENABLED:true}
        # 配置文件导入顺序
        import-check:
          enabled: true
        # 共享配置 - 所有服务共享
        shared-configs:
          - data-id: common-database.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: common-redis.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: common-monitoring.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: common-security.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: access-control-config.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
        # 扩展配置 - 服务特定配置
        extension-configs:
          - data-id: ioedream-access-service-ext.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: ${spring.application.name}-${spring.profiles.active:dev}.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
  # ==================== 配置文件导入 ====================
  # 注意：Spring Cloud Alibaba 2025.0.0.0版本在config.import阶段无法解析占位符，需要直接指定dataId
  config:
    import:
      - "optional:nacos:ioedream-access-service.yaml"
      - "optional:nacos:ioedream-access-service-docker.yaml"
      - "optional:nacos:common-config.yaml"
      - "optional:nacos:access-control-config.yaml"

# ==================== 加密配置 ====================
jasypt:
  encryptor:
    password: ${JASYPT_PASSWORD}
    algorithm: PBEWITHHMACSHA512ANDAES_256
    key-obtention-iterations: 1000
    pool-size: 1
    provider-name: SunJCE
    salt-generator-classname: org.jasypt.salt.RandomSaltGenerator
    string-output-type: base64
    iv-generator-classname: org.jasypt.iv.RandomIvGenerator
    property:
      prefix: ENC(
      suffix: )

# ==================== JVM配置 ====================
# 开发环境使用较小内存配置，生产环境通过环境变量覆盖
java:
  opts:
    # 开发环境默认配置 (1GB堆内存)
    - "-server"
    - "-Xms${JVM_XMS:512m}"
    - "-Xmx${JVM_XMX:1g}"
    - "-XX:+UseG1GC"
    - "-XX:MaxGCPauseMillis=200"
    - "-XX:+UseStringDeduplication"
    - "-XX:MaxMetaspaceSize=${JVM_METASPACE:192m}"
    - "-XX:+HeapDumpOnOutOfMemoryError"
    - "-XX:HeapDumpPath=/var/log/ioedream/access-service"
    - "-Dfile.encoding=UTF-8"
    - "-Duser.timezone=Asia/Shanghai"

# ==================== 日志配置启动参数 ====================
logging:
  config: classpath:logback-spring.xml
  level:
    root: INFO
    "[net.lab1024.sa.access]": DEBUG
    "[org.springframework]": INFO

# ==================== 门禁服务特定配置 ====================
access:
  control:
    # 门禁控制配置
    door:
      # 开门时间配置（毫秒）
      open-duration: ${ACCESS_OPEN_DURATION:5000}
      # 开门超时时间
      open-timeout: ${ACCESS_OPEN_TIMEOUT:10000}
      # 强制关门时间
      force-close-timeout: ${ACCESS_FORCE_CLOSE_TIMEOUT:30000}

    # 防潜回配置
    anti-passback:
      enabled: ${ACCESS_ANTI_PASSBACK_ENABLED:true}
      strict-mode: ${ACCESS_ANTI_PASSBACK_STRICT:false}
      timeout-seconds: ${ACCESS_ANTI_PASSBACK_TIMEOUT:60}

    # 互锁配置
    interlock:
      enabled: ${ACCESS_INTERLOCK_ENABLED:false}
      groups: ${ACCESS_INTERLOCK_GROUPS:}

    # 胁胁码配置
    duress:
      enabled: ${ACCESS_DURESS_ENABLED:true}
      codes: ${ACCESS_DURESS_CODES:1234,4321,1111}

  authentication:
    # 认证方式配置
    methods:
      card:
        enabled: ${ACCESS_CARD_ENABLED:true}
        verify-luhn: ${ACCESS_CARD_VERIFY_LUHN:true}
        track-history: ${ACCESS_CARD_TRACK_HISTORY:true}

      biometric:
        face:
          enabled: ${ACCESS_FACE_ENABLED:true}
          liveness-check: ${ACCESS_FACE_LIVENESS:true}
          confidence-threshold: ${ACCESS_FACE_CONFIDENCE:0.85}
        fingerprint:
          enabled: ${ACCESS_FINGERPRINT_ENABLED:true}
          template-quality: ${ACCESS_FINGERPRINT_QUALITY:60}
          match-score: ${ACCESS_FINGERPRINT_MATCH:80}
        palm:
          enabled: ${ACCESS_PALM_ENABLED:false}
          template-quality: ${ACCESS_PALM_QUALITY:70}

      qr-code:
        enabled: ${ACCESS_QRCODE_ENABLED:true}
        encryption: ${ACCESS_QRCODE_ENCRYPTION:AES}
        expire-seconds: ${ACCESS_QRCODE_EXPIRE:60}

      password:
        enabled: ${ACCESS_PASSWORD_ENABLED:true}
        min-length: ${ACCESS_PASSWORD_MIN_LENGTH:4}
        max-length: ${ACCESS_PASSWORD_MAX_LENGTH:8}

  area:
    # 区域权限配置
    time-schedules:
      enabled: ${ACCESS_TIME_SCHEDULES_ENABLED:true}
      default-schedule: ${ACCESS_DEFAULT_SCHEDULE:default}

    access-levels:
      levels: ${ACCESS_LEVELS:1,2,3,4,5}
      default-level: ${ACCESS_DEFAULT_LEVEL:1}

    visitor:
      enabled: ${ACCESS_VISITOR_ENABLED:true}
      default-expire-hours: ${ACCESS_VISITOR_EXPIRE_HOURS:24}
      escort-required: ${ACCESS_VISITOR_ESCORT:false}

  monitoring:
    # 实时监控配置
    real-time:
      enabled: ${ACCESS_REAL_TIME_ENABLED:true}
      event-buffer-size: ${ACCESS_EVENT_BUFFER_SIZE:10000}
      batch-process-size: ${ACCESS_BATCH_PROCESS_SIZE:100}
      batch-process-interval: ${ACCESS_BATCH_PROCESS_INTERVAL:5000}

    # 异常检测配置
    anomaly:
      enabled: ${ACCESS_ANOMALY_ENABLED:true}
      multi-access-timeout: ${ACCESS_MULTI_ACCESS_TIMEOUT:5}
      tailgating-detection: ${ACCESS_TAILGATING_ENABLED:true}
      force-open-detection: ${ACCESS_FORCE_OPEN_ENABLED:true}

    # 报警配置
    alarm:
      enabled: ${ACCESS_ALARM_ENABLED:true}
      alarm-types: ${ACCESS_ALARM_TYPES:door-forced,door-open-too-long,anti-passback,duress}
      notification-channels: ${ACCESS_ALARM_CHANNELS:system,email,sms}

  integration:
    # 第三方系统集成配置
    video:
      enabled: ${ACCESS_VIDEO_INTEGRATION_ENABLED:true}
      snapshot-on-access: ${ACCESS_SNAPSHOT_ON_ACCESS:true}
      video-retention-days: ${ACCESS_VIDEO_RETENTION_DAYS:30}

    visitor:
      enabled: ${ACCESS_VISITOR_INTEGRATION_ENABLED:true}
      auto-create-access: ${ACCESS_VISITOR_AUTO_ACCESS:true}
      visitor-access-level: ${ACCESS_VISITOR_ACCESS_LEVEL:1}

    attendance:
      enabled: ${ACCESS_ATTENDANCE_INTEGRATION_ENABLED:true}
      auto-clock-in: ${ACCESS_AUTO_CLOCK_IN:false}
      clock-in-grace-minutes: ${ACCESS_CLOCK_IN_GRACE:10}

  cache:
    # 缓存配置
    user-permissions:
      ttl: ${ACCESS_USER_PERMISSIONS_TTL:300}  # 5分钟
      max-size: ${ACCESS_USER_PERMISSIONS_MAX_SIZE:10000}

    device-status:
      ttl: ${ACCESS_DEVICE_STATUS_TTL:60}      # 1分钟
      max-size: ${ACCESS_DEVICE_STATUS_MAX_SIZE:5000}

    area-access:
      ttl: ${ACCESS_AREA_ACCESS_TTL:180}       # 3分钟
      max-size: ${ACCESS_AREA_ACCESS_MAX_SIZE:8000}
