# ============================================================
# IOE-DREAM Access Service 生产环境配置
#
# @Author:    IOE-DREAM Team
# @Date:      2025-12-09
# @Copyright:  IOE-DREAM智慧园区一卡通管理平台
# ============================================================

# ==================== 服务基础配置 ====================
server:
  port: ${SERVER_PORT:8090}
  servlet:
    context-path: /
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
  tomcat:
    uri-encoding: UTF-8
    max-threads: 300
    min-spare-threads: 30
    accept-count: 200

# ==================== Spring配置 ====================
spring:
  profiles:
    active: prod

  # ==================== 数据源配置 ====================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      url: ${DATABASE_URL:ENC(AES256:encrypted_prod_db_url)}
      username: ${DATABASE_USERNAME:ENC(AES256:encrypted_prod_db_username)}
      password: ${DATABASE_PASSWORD:ENC(AES256:encrypted_prod_db_password)}
      driver-class-name: com.mysql.cj.jdbc.Driver

      # 连接池配置（高并发优化）
      initial-size: 30
      min-idle: 30
      max-active: 150
      max-wait: 60000
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      validation-query: SELECT 1 FROM DUAL
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false

      # 监控配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        login-username: ${DRUID_USERNAME:admin}
        login-password: ${DRUID_PASSWORD:ENC(AES256:encrypted_druid_password)}
        allow: ${DRUID_ALLOW:127.0.0.1,localhost}
        deny: ${DRUID_DENY:}

  # ==================== Redis配置 ====================
  redis:
    host: ${REDIS_HOST:prod-redis-cluster}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:ENC(AES256:encrypted_redis_password)}
    database: 0
    timeout: 3000
    lettuce:
      pool:
        max-active: 30
        max-idle: 15
        min-idle: 8
        max-wait: 1000
      cluster:
        refresh:
          adaptive: true
          period: 30

  # ==================== 缓存配置 ====================
  cache:
    type: redis
    redis:
      time-to-live: 300000  # 5分钟
      cache-null-values: false
      key-prefix: access_cache_

  # ==================== Zipkin分布式追踪配置 ====================
  sleuth:
    zipkin:
      base-url: ${ZIPKIN_BASE_URL:http://zipkin-prod:9411}
      enabled: ${ZIPKIN_ENABLED:true}
    sampler:
      probability: ${ZIPKIN_SAMPLE_RATE:0.1}

# ==================== MyBatis-Plus配置 ====================
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true
    lazy-loading-enabled: true
    use-column-label: true
    use-generated-keys: true
    auto-mapping-behavior: partial
    default-executor-type: reuse
    default-statement-timeout: 10
    default-fetch-size: 500

  global-config:
    db-config:
      id-type: assign_id
      table-underline: true
      logic-delete-field: deletedFlag
      logic-delete-value: 1
      logic-not-delete-value: 0

# ==================== 监控配置 ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,configprops
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    metrics:
      enabled: true
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
        step: 30s
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active}

# ==================== Resilience4j容错配置 ====================
resilience4j:
  circuitbreaker:
    instances:
      access-service:
        failure-rate-threshold: 50
        minimum-number-of-calls: 10
        wait-duration-in-open-state: 30s
        sliding-window-size: 20
        sliding-window-type: count_based

  ratelimiter:
    instances:
      access-service:
        limit-for-period: 300
        limit-refresh-period: 60s
        timeout-duration: 5s
        register-health-indicator: true

# ==================== 日志配置 ====================
logging:
  level:
    net.lab1024.sa.access: INFO
  pattern:
    console: "%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%X{traceId:-},%X{spanId:-}]){blue} %clr(%5p){magenta} %clr(${PID:- }){yellow} %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:%wEx}"

# ==================== 门禁服务特定配置 ====================
access:
  control:
    # 门禁控制
    door:
      open-duration: ${ACCESS_OPEN_DURATION:5000}
      open-timeout: ${ACCESS_OPEN_TIMEOUT:10000}
      force-close-timeout: ${ACCESS_FORCE_CLOSE_TIMEOUT:30000}
      max-concurrent-access: ${MAX_CONCURRENT_ACCESS:100}

    # 防潜回配置
    anti-passback:
      enabled: ${ACCESS_ANTI_PASSBACK_ENABLED:true}
      strict-mode: ${ACCESS_ANTI_PASSBACK_STRICT:true}
      timeout-seconds: ${ACCESS_ANTI_PASSBACK_TIMEOUT:60}
      zone-based: ${ANTI_PASSBACK_ZONE_BASED:true}

    # 互锁配置
    interlock:
      enabled: ${ACCESS_INTERLOCK_ENABLED:false}
      groups: ${ACCESS_INTERLOCK_GROUPS:}
      strict-enforcement: ${INTERLOCK_STRICT:true}

    # 胁迫码配置
    duress:
      enabled: ${ACCESS_DURESS_ENABLED:true}
      codes: ${ACCESS_DURESS_CODES:1234,4321,1111,0000}
      silent-alarm: ${DURESS_SILENT_ALARM:true}
      immediate-alert: ${DURESS_IMMEDIATE_ALERT:true}

  authentication:
    # 认证方式
    methods:
      card:
        enabled: ${ACCESS_CARD_ENABLED:true}
        verify-luhn: ${ACCESS_CARD_VERIFY_LUHN:true}
        track-history: ${ACCESS_CARD_TRACK_HISTORY:true}
        card-blacklist: ${CARD_BLACKLIST_ENABLED:true}

      biometric:
        face:
          enabled: ${ACCESS_FACE_ENABLED:true}
          liveness-check: ${ACCESS_FACE_LIVENESS:true}
          confidence-threshold: ${ACCESS_FACE_CONFIDENCE:0.85}
          anti-spoofing: ${FACE_ANTI_SPOOFING:true}
        fingerprint:
          enabled: ${ACCESS_FINGERPRINT_ENABLED:true}
          template-quality: ${ACCESS_FINGERPRINT_QUALITY:60}
          match-score: ${ACCESS_FINGERPRINT_MATCH:80}
          anti-fake: ${FINGERPRINT_ANTI_FAKE:true}
        palm:
          enabled: ${ACCESS_PALM_ENABLED:false}
          template-quality: ${ACCESS_PALM_QUALITY:70}
          match-score: ${ACCESS_PALM_MATCH:75}

      qr-code:
        enabled: ${ACCESS_QRCODE_ENABLED:true}
        encryption: ${ACCESS_QRCODE_ENCRYPTION:AES}
        expire-seconds: ${ACCESS_QRCODE_EXPIRE:60}
        dynamic-refresh: ${QRCODE_DYNAMIC_REFRESH:true}

      password:
        enabled: ${ACCESS_PASSWORD_ENABLED:true}
        min-length: ${ACCESS_PASSWORD_MIN_LENGTH:4}
        max-length: ${ACCESS_PASSWORD_MAX_LENGTH:8}
        complexity-check: ${PASSWORD_COMPLEXITY_CHECK:false}

    # 多因子认证
    multi-factor:
      enabled: ${MFA_ENABLED:false}
      required-levels: ${MFA_REQUIRED_LEVELS:2}
      timeout-seconds: ${MFA_TIMEOUT:60}

  area:
    # 区域管理
    time-schedules:
      enabled: ${ACCESS_TIME_SCHEDULES_ENABLED:true}
      default-schedule: ${ACCESS_DEFAULT_SCHEDULE:default}
      holiday-schedule: ${HOLIDAY_SCHEDULE_ENABLED:true}

    access-levels:
      levels: ${ACCESS_LEVELS:1,2,3,4,5,6,7,8,9,10}
      default-level: ${ACCESS_DEFAULT_LEVEL:1}
      inheritance: ${ACCESS_LEVEL_INHERITANCE:true}

    visitor:
      enabled: ${ACCESS_VISITOR_ENABLED:true}
      default-expire-hours: ${ACCESS_VISITOR_EXPIRE_HOURS:24}
      escort-required: ${ACCESS_VISITOR_ESCORT:false}
      area-restrictions: ${VISITOR_AREA_RESTRICTIONS:true}

    # 权限继承
    inheritance:
      enabled: ${PERMISSION_INHERITANCE_ENABLED:true}
      max-inheritance-levels: ${MAX_INHERITANCE_LEVELS:5}
      override-protection: ${INHERITANCE_OVERRIDE_PROTECTION:true}

  monitoring:
    # 实时监控
    real-time:
      enabled: ${ACCESS_REAL_TIME_ENABLED:true}
      event-buffer-size: ${ACCESS_EVENT_BUFFER_SIZE:10000}
      batch-process-size: ${ACCESS_BATCH_PROCESS_SIZE:100}
      batch-process-interval: ${ACCESS_BATCH_PROCESS_INTERVAL:5000}
      event-retention-days: ${EVENT_RETENTION_DAYS:90}

    # 异常检测
    anomaly:
      enabled: ${ACCESS_ANOMALY_ENABLED:true}
      multi-access-timeout: ${ACCESS_MULTI_ACCESS_TIMEOUT:5}
      tailgating-detection: ${ACCESS_TAILGATING_ENABLED:true}
      force-open-detection: ${ACCESS_FORCE_OPEN_ENABLED:true}
      loitering-detection: ${ACCESS_LOITERING_ENABLED:false}
      loitering-threshold-minutes: ${LOITERING_THRESHOLD:10}

    # 异常行为分析
    behavior-analysis:
      enabled: ${BEHAVIOR_ANALYSIS_ENABLED:true}
      learning-period-days: ${BEHAVIOR_LEARNING_DAYS:30}
      deviation-threshold: ${BEHAVIOR_DEVIATION_THRESHOLD:0.3}
      auto-adaptation: ${BEHAVIOR_AUTO_ADAPTATION:true}

    # 告警配置
    alarm:
      enabled: ${ACCESS_ALARM_ENABLED:true}
      alarm-types: ${ACCESS_ALARM_TYPES:door-forced,door-open-too-long,anti-passback,duress,tailgating}
      notification-channels: ${ACCESS_ALARM_CHANNELS:system,email,sms}
      escalation-rules: ${ALARM_ESCALATION_RULES:true}
      alarm-cooldown: ${ALARM_COOLDOWN:300}

  integration:
    # 第三方集成
    video:
      enabled: ${ACCESS_VIDEO_INTEGRATION_ENABLED:true}
      snapshot-on-access: ${ACCESS_SNAPSHOT_ON_ACCESS:true}
      video-retention-days: ${ACCESS_VIDEO_RETENTION_DAYS:30}
      face-recognition-integration: ${VIDEO_FACE_INTEGRATION:true}

    visitor:
      enabled: ${ACCESS_VISITOR_INTEGRATION_ENABLED:true}
      auto-create-access: ${ACCESS_VISITOR_AUTO_ACCESS:true}
      visitor-access-level: ${ACCESS_VISITOR_ACCESS_LEVEL:1}
      visitor-data-sync: ${VISITOR_DATA_SYNC:true}

    attendance:
      enabled: ${ACCESS_ATTENDANCE_INTEGRATION_ENABLED:true}
      auto-clock-in: ${ACCESS_AUTO_CLOCK_IN:false}
      clock-in-grace-minutes: ${ACCESS_CLOCK_IN_GRACE:10}
      location-verification: ${ATTENDANCE_LOCATION_VERIFY:true}

    elevator:
      enabled: ${ACCESS_ELEVATOR_INTEGRATION_ENABLED:false}
      floor-access-control: ${ELEVATOR_FLOOR_ACCESS:true}
      time-based-restrictions: ${ELEVATOR_TIME_RESTRICTIONS:true}

  performance:
    # 性能优化
    high-concurrency:
      max-concurrent-access: ${MAX_CONCURRENT_OPERATIONS:500}
      async-processing: ${ASYNC_PROCESSING_ENABLED:true}
      queue-size: ${ACCESS_QUEUE_SIZE:2000}
      thread-pool-size: ${ACCESS_THREAD_POOL:50}

    # 批量操作
    batch:
      batch-size: ${ACCESS_BATCH_SIZE:1000}
      batch-timeout: ${ACCESS_BATCH_TIMEOUT:5000}
      max-retry-attempts: ${BATCH_RETRY_ATTEMPTS:3}

  cache:
    # 缓存配置
    user-permissions:
      ttl: ${ACCESS_USER_PERMISSIONS_TTL:300}    # 5分钟
      max-size: ${ACCESS_USER_PERMISSIONS_MAX_SIZE:10000}

    device-status:
      ttl: ${ACCESS_DEVICE_STATUS_TTL:60}         # 1分钟
      max-size: ${ACCESS_DEVICE_STATUS_MAX_SIZE:5000}

    area-access:
      ttl: ${ACCESS_AREA_ACCESS_TTL:180}          # 3分钟
      max-size: ${ACCESS_AREA_ACCESS_MAX_SIZE:8000}

    time-schedules:
      ttl: ${TIME_SCHEDULES_TTL:3600}             # 1小时
      max-size: ${TIME_SCHEDULES_MAX_SIZE:1000}

    anti-passback:
      ttl: ${ANTI_PASSBACK_TTL:300}               # 5分钟
      max-size: ${ANTI_PASSBACK_MAX_SIZE:20000}

  security:
    # 安全配置
    access-control:
      ip-whitelist:
        enabled: ${IP_WHITELIST_ENABLED:false}
        allowed-ips: ${ALLOWED_IPS:127.0.0.1,localhost}

      rate-limiting:
        enabled: ${ACCESS_RATE_LIMIT_ENABLED:true}
        default-limit: ${DEFAULT_ACCESS_RATE_LIMIT:100}
        window-seconds: ${RATE_LIMIT_WINDOW:60}

      device-authentication:
        enabled: ${DEVICE_AUTH_ENABLED:true}
        certificate-validation: ${DEVICE_CERT_VALIDATION:true}
        device-whitelist: ${DEVICE_WHITELIST_ENABLED:true}

    # 数据加密
    encryption:
      sensitive-data: ${SENSITIVE_DATA_ENCRYPTION_ENABLED:true}
      encryption-algorithm: ${DATA_ENCRYPTION_ALGORITHM:AES-256}
      key-rotation-days: ${ENCRYPTION_KEY_ROTATION_DAYS:90}

    # 审计日志
    audit:
      full-logging: ${ACCESS_AUDIT_FULL_LOGGING:true}
      log-all-events: ${LOG_ALL_ACCESS_EVENTS:true}
      retention-days: ${AUDIT_LOG_RETENTION_DAYS:365}
      tamper-protection: ${AUDIT_TAMPER_PROTECTION:true}

  reporting:
    # 报表配置
    real-time:
      enabled: ${ACCESS_REAL_TIME_REPORTING_ENABLED:true}
      update-interval: ${REAL_TIME_UPDATE_INTERVAL:30}

    periodic:
      daily-report: ${ACCESS_DAILY_REPORT:true}
      weekly-summary: ${ACCESS_WEEKLY_SUMMARY:true}
      monthly-analysis: ${ACCESS_MONTHLY_ANALYSIS:true}

    # 统计维度
    dimensions:
      time-based: ${ACCESS_TIME_ANALYSIS:true}
      user-based: ${ACCESS_USER_ANALYSIS:true}
      area-based: ${ACCESS_AREA_ANALYSIS:true}
      device-based: ${ACCESS_DEVICE_ANALYSIS:true}
      access-type: ${ACCESS_TYPE_ANALYSIS:true}

  # 设备管理
  device:
    # 设备健康监控
    health-monitor:
      enabled: ${DEVICE_HEALTH_MONITOR_ENABLED:true}
      check-interval: ${DEVICE_HEALTH_CHECK_INTERVAL:60}
      offline-threshold: ${DEVICE_OFFLINE_THRESHOLD:180}
      auto-recovery: ${DEVICE_AUTO_RECOVERY:false}

    # 设备配置
    configuration:
      default-timeout: ${DEVICE_DEFAULT_TIMEOUT:10000}
      max-retry-attempts: ${DEVICE_MAX_RETRY_ATTEMPTS:3}
      heartbeat-interval: ${DEVICE_HEARTBEAT_INTERVAL:60}

    # 设备升级
    upgrade:
      enabled: ${DEVICE_UPGRADE_ENABLED:false}
      auto-upgrade: ${AUTO_UPGRADE_ENABLED:false}
      upgrade-window-start: ${UPGRADE_WINDOW_START:02:00}
      upgrade-window-end: ${UPGRADE_WINDOW_END:04:00}