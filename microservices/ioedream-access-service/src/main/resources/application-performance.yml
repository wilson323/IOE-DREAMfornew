# ============================================================
# IOE-DREAM Access Service - Spring Boot 3.5.8 配置
# 门禁管理服务 - 企业级生产环境配置
#
# 技术标准: Spring Boot 3.5.8 + Jakarta EE 9.0 + Java 17
# 遵循规范: 完全兼容Spring Boot 3.x配置模式
#
# @Author: IOE-DREAM架构委员会
# @Version: v1.0.0-企业级重构版
# @Date: 2025-01-30
# ============================================================

# ==================== Spring Boot 核心配置 ====================
spring:
  application:
    name: ioedream-access-service

  # ==================== 数据源配置 (门禁系统优化) ====================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # 门禁系统连接池配置
      # 门禁服务连接池配置（已优化内存占用）
      initial-size: ${DRUID_INITIAL_SIZE:8}   # 从15降至8（节眅47%）
      min-idle: ${DRUID_MIN_IDLE:8}           # 从15降至8（节眅47%）
      max-active: ${DRUID_MAX_ACTIVE:40}      # 从60降至40（节眅33%）
      max-wait: ${DRUID_MAX_WAIT:20000}

      # 性能优化配置
      validation-query: ${DRUID_VALIDATION_QUERY:SELECT 1}
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      time-between-eviction-runs-millis: 60000

      # 门禁系统安全配置
      remove-abandoned: true
      remove-abandoned-timeout: 120
      log-abandoned: true

      # 连接池监控配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
      filter:
        stat:
          enabled: true
          slow-sql-millis: 800
          log-slow-sql: true

  # ==================== Redis配置 (Spring Boot 3.x标准) ====================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:ENC(AES256:encrypted_password)}
      database: ${REDIS_DATABASE:2}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 30
          max-idle: 15
          min-idle: 8
          max-wait: 2000ms

  # ==================== 缓存配置 (门禁控制优化) ====================
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=20000,expireAfterWrite=10m,recordStats

  # ==================== 事务配置 ====================
  transaction:
    default-timeout: 30
    rollback-on-commit-failure: true

# ==================== MyBatis-Plus配置 (顶层配置) ====================
mybatis-plus:
  # 全局配置
  global-config:
    db-config:
      logic-delete-field: deletedFlag
      logic-delete-value: 1
      logic-not-delete-value: 0
      id-type: ASSIGN_ID
      table-underline: true
  # 配置信息
  configuration:
    map-underscore-to-camel-case: true
    cache-enabled: true
    call-setters-on-nulls: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

# ==================== 服务器配置 ====================
server:
  port: 8090
  servlet:
    context-path: /access
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    threads:
      max: 200
      min-spare: 25
    max-connections: 8000
    accept-count: 100
    connection-timeout: 15000

# ==================== 管理端点配置 (Spring Boot 3.x标准) ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: always
    metrics:
      access: read-only  # Spring Boot 3.4+: 使用access替代enabled
  prometheus:
    metrics:
      export:
        enabled: true

# ==================== 日志配置 (Spring Boot 3.x标准) ====================
logging:
  level:
    root: INFO
    "[net.lab1024.sa.access]": DEBUG
    "[org.springframework.web]": INFO
    "[com.alibaba.druid]": INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/access-service.log
    max-size: 100MB
    max-history: 30

# ==================== 环境特定配置 ====================
---
spring:
  config:
    activate:
      on-profile: dev

logging:
  level:
    root: DEBUG

---
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
  file:
    name: logs/access-service-prod.log
