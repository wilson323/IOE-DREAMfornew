# IOE-DREAM è®¾å¤‡é€šè®¯åè®®æ¶æ„å®ç°æ€»ç»“

> **ç‰ˆæœ¬**: v1.0.0
> **åˆ›å»ºæ—¶é—´**: 2025-12-16
> **å®ç°ç›®æ ‡**: ä¸¥æ ¼éµå¾ªé—¨ç¦ã€è€ƒå‹¤ã€æ¶ˆè´¹è®¾å¤‡é€šè®¯åè®®ï¼Œå®ç°ç»„ä»¶åŒ–ä»¥ä¾¿åç»­å…¼å®¹ä¸åŒå‚å®¶è®¾å¤‡

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### æ ¸å¿ƒç›®æ ‡

åŸºäºç”¨æˆ·è¦æ±‚"ä¸¥æ ¼éµå¾ªé—¨ç¦ã€è€ƒå‹¤ã€æ¶ˆè´¹è®¾å¤‡é€šè®¯åè®®æ¥è®¾è®¡åŠŸèƒ½"å’Œ"ç¡®ä¿ä¸è®¾å¤‡é€šè®¯ç»„ä»¶åŒ–ï¼Œç»„ä»¶åŒ–ä»¥ä¾¿åç»­å…¼å®¹ä¸åŒå‚å®¶çš„è®¾å¤‡"ï¼Œæˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ã€ç»„ä»¶åŒ–çš„è®¾å¤‡é€šè®¯åè®®æ¶æ„ã€‚

### è®¾è®¡åŸåˆ™

1. **ä¸¥æ ¼éµå¾ªå‚å•†åè®®**: ä¸¥æ ¼æŒ‰ç…§ç†µåŸºç§‘æŠ€ã€ä¸­æ§æ™ºæ…§ç­‰å‚å•†æä¾›çš„å®˜æ–¹åè®®æ–‡æ¡£å®ç°
2. **ç»„ä»¶åŒ–æ¶æ„**: é‡‡ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œæ”¯æŒåè®®é€‚é…å™¨çš„åŠ¨æ€æ³¨å†Œå’Œç®¡ç†
3. **å¯æ‰©å±•æ€§**: æ”¯æŒæ–°å‚å•†åè®®çš„å¿«é€Ÿæ¥å…¥å’Œæ— ç¼æ‰©å±•
4. **ç»Ÿä¸€æ¥å£**: æä¾›æ ‡å‡†åŒ–çš„åè®®å¤„ç†æ¥å£ï¼Œéšè—åº•å±‚åè®®å·®å¼‚
5. **é«˜å¯ç”¨æ€§**: æ”¯æŒåè®®éªŒè¯ã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ç›‘æ§ç­‰ä¼ä¸šçº§ç‰¹æ€§

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Device Communication Service              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DeviceCommunicationController                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  REST APIå±‚ - ç»Ÿä¸€åè®®ç®¡ç†æ¥å£                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ProtocolAdapterFactory                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  åè®®é€‚é…å™¨å·¥å‚ - åŠ¨æ€æ³¨å†Œå’Œç®¡ç†                      â”‚    â”‚
â”‚  â”‚  â€¢ é€‚é…å™¨æ³¨å†Œè¡¨ (Map<String, ProtocolAdapter>)        â”‚    â”‚
â”‚  â”‚  â€¢ è®¾å¤‡å‹å·æ˜ å°„ (Map<String, String>)                â”‚    â”‚
â”‚  â”‚  â€¢ è®¾å¤‡SNç¼“å­˜ (Map<String, String>)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ProtocolAdapter Interface                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç»Ÿä¸€åè®®æ¥å£ - æ ‡å‡†åŒ–åè®®å¤„ç†å¥‘çº¦                    â”‚    â”‚
â”‚  â”‚  â€¢ æ¶ˆæ¯è§£æå’Œæ„å»º                                   â”‚    â”‚
â”‚  â”‚  â€¢ åè®®éªŒè¯å’Œæƒé™æ£€æŸ¥                               â”‚    â”‚
â”‚  â”‚  â€¢ ä¸šåŠ¡æ•°æ®å¤„ç†                                   â”‚    â”‚
â”‚  â”‚  â€¢ è®¾å¤‡ç®¡ç†                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Protocol Implementations                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ AccessEntropyV48Adapter  â”‚  â”‚ ConsumeZktecoV10Adapter â”‚  â”‚           â”‚
â”‚  â”‚ (ç†µåŸºç§‘æŠ€é—¨ç¦V4.8)      â”‚  â”‚ (ä¸­æ§æ™ºæ…§æ¶ˆè´¹V1.0)     â”‚  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Protocol Message Entities                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ AccessEntropyV48Messageâ”‚  â”‚ ConsumeZktecoV10Messageâ”‚  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯ç‰¹æ€§

#### 1. åè®®é€‚é…å™¨æ¨¡å¼

```java
public interface ProtocolAdapter {
    // åè®®æ ‡è¯†
    String getProtocolType();
    String getManufacturer();
    String getVersion();

    // æ¶ˆæ¯å¤„ç†
    ProtocolMessage parseDeviceMessage(byte[] rawData, Long deviceId);
    byte[] buildDeviceResponse(String messageType, Map<String, Object> businessData, Long deviceId);

    // åè®®éªŒè¯
    ProtocolValidationResult validateMessage(ProtocolMessage message);
    ProtocolPermissionResult validateDevicePermission(Long deviceId, String operation);

    // ä¸šåŠ¡å¤„ç†
    Future<ProtocolProcessResult> processAccessBusiness(String businessType, Map<String, Object> businessData, Long deviceId);
    Future<ProtocolProcessResult> processConsumeBusiness(String businessType, Map<String, Object> businessData, Long deviceId);
    Future<ProtocolProcessResult> processAttendanceBusiness(String businessType, Map<String, Object> businessData, Long deviceId);
}
```

#### 2. å·¥å‚æ³¨å†Œæœºåˆ¶

```java
@Component
public class ProtocolAdapterFactory {

    // è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰é€‚é…å™¨
    @PostConstruct
    public void initialize() {
        registerAdapter(accessEntropyV48Adapter);
        registerAdapter(consumeZktecoV10Adapter);
    }

    // åŠ¨æ€æŸ¥æ‰¾é€‚é…å™¨
    public ProtocolAdapter getAdapterByDeviceModel(String deviceModel) {
        String protocolType = deviceModelToProtocolMap.get(deviceModel.toUpperCase());
        return getAdapter(protocolType);
    }

    // æ”¯æŒåŠ¨æ€æ·»åŠ æ–°åè®®
    public void registerAdapter(ProtocolAdapter adapter) {
        adapterRegistry.put(adapter.getProtocolType(), adapter);
        for (String model : adapter.getSupportedDeviceModels()) {
            deviceModelToProtocolMap.put(model.toUpperCase(), adapter.getProtocolType());
        }
    }
}
```

## ğŸ”§ å·²å®ç°çš„åè®®å¤„ç†å™¨

### 1. ç†µåŸºç§‘æŠ€é—¨ç¦åè®®V4.8å¤„ç†å™¨

#### æ”¯æŒè®¾å¤‡å‹å·
- MA300/MA300T - äººè„¸è¯†åˆ«ç»ˆç«¯
- SC405/SC700/SC705 - é—¨ç¦æ§åˆ¶å™¨
- F18 - æŒ‡çº¹è¯†åˆ«ç»ˆç«¯
- TA800C/TA800T - äººè„¸è¯†åˆ«ç»ˆç«¯
- WK2600/WK2600P - é—¨ç¦æ§åˆ¶å™¨

#### æ ¸å¿ƒåŠŸèƒ½
- **å®æ—¶äº‹ä»¶ä¸Šä¼ **: åˆ·å¡ã€äººè„¸ã€æŒ‡çº¹ã€å¯†ç ã€äºŒç»´ç ã€èƒè¿«ç­‰äº‹ä»¶
- **ç”Ÿç‰©è¯†åˆ«å¤„ç†**: äººè„¸è¯†åˆ«ã€æ´»ä½“æ£€æµ‹ã€æŒ‡çº¹åŒ¹é…
- **é—¨ç¦æ§åˆ¶**: é—¨ç£çŠ¶æ€ã€é”çŠ¶æ€ã€åæ½œå›æ£€æµ‹
- **è®¾å¤‡ç®¡ç†**: è®¾å¤‡çŠ¶æ€ç›‘æ§ã€å¿ƒè·³å¤„ç†ã€é…ç½®åŒæ­¥
- **å®‰å…¨ç‰¹æ€§**: ç­¾åéªŒè¯ã€æ ¡éªŒç ã€æƒé™æ§åˆ¶

#### æ¶ˆæ¯ç±»å‹æ”¯æŒ
```java
// å®æ—¶äº‹ä»¶ä¸Šä¼ 
MSG_TYPE_REAL_TIME_EVENT = 0x01
// è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥
MSG_TYPE_DEVICE_STATUS = 0x02
// å¿ƒè·³åŒ…
MSG_TYPE_HEARTBEAT = 0x03
// æƒé™è¯·æ±‚
MSG_TYPE_PERMISSION_REQUEST = 0x04
// éªŒè¯ç»“æœ
MSG_TYPE_VERIFY_RESULT = 0x05
// é”™è¯¯æŠ¥å‘Š
MSG_TYPE_ERROR_REPORT = 0x06
```

#### äº‹ä»¶ç±»å‹æ”¯æŒ
```java
EVENT_TYPE_CARD = 0x01           // åˆ·å¡äº‹ä»¶
EVENT_TYPE_FACE = 0x02           // äººè„¸è¯†åˆ«äº‹ä»¶
EVENT_TYPE_FINGERPRINT = 0x03     // æŒ‡çº¹è¯†åˆ«äº‹ä»¶
EVENT_TYPE_PASSWORD = 0x04       // å¯†ç éªŒè¯äº‹ä»¶
EVENT_TYPE_QR_CODE = 0x05        // äºŒç»´ç äº‹ä»¶
EVENT_TYPE_DURESS = 0x06         // èƒè¿«äº‹ä»¶
EVENT_TYPE_TAILGATING = 0x07      // å°¾éšäº‹ä»¶
EVENT_TYPE_ANTI_PASSBACK = 0x08  // åæ½œå›äº‹ä»¶
```

### 2. ä¸­æ§æ™ºæ…§æ¶ˆè´¹åè®®V1.0å¤„ç†å™¨

#### æ”¯æŒè®¾å¤‡å‹å·
- IC-600T/F2/SC700/SC810 - æ¶ˆè´¹æœº
- IC-700A/IC-800A - æ¶ˆè´¹æœº
- IC-260T/IC-360T/IC-560T - æ¶ˆè´¹æœº
- IC-760T - æ¶ˆè´¹æœº
- SC602/SC603 - æ¶ˆè´¹æœº

#### æ ¸å¿ƒåŠŸèƒ½
- **æ¶ˆè´¹è®°å½•å¤„ç†**: åˆ·å¡æ¶ˆè´¹ã€ç¦»çº¿æ¶ˆè´¹ã€é€€æ¬¾å¤„ç†
- **è´¦æˆ·ç®¡ç†**: è´¦æˆ·æŸ¥è¯¢ã€ä½™é¢æ£€æŸ¥ã€è¡¥è´´ç®¡ç†
- **å……å€¼ç®¡ç†**: å……å€¼è®°å½•ã€å……å€¼æ–¹å¼ã€è´¦æˆ·æ›´æ–°
- **è¡¥è´´å‘æ”¾**: é¤è¡¥ã€äº¤é€šè¡¥ã€ä½æˆ¿è¡¥ç­‰
- **è®¾å¤‡ç®¡ç†**: è®¾å¤‡çŠ¶æ€ã€å¿ƒè·³ç›‘æ§ã€é…ç½®åŒæ­¥
- **æ•°æ®åŒæ­¥**: ç¦»çº¿æ•°æ®åŒæ­¥ã€å†²çªå¤„ç†

#### æ¶ˆæ¯ç±»å‹æ”¯æŒ
```java
// æ¶ˆè´¹è®°å½•ä¸Šä¼ 
MSG_TYPE_CONSUME_RECORD = 0x01
// è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥
MSG_TYPE_DEVICE_STATUS = 0x02
// å¿ƒè·³åŒ…
MSG_TYPE_HEARTBEAT = 0x03
// è´¦æˆ·æŸ¥è¯¢è¯·æ±‚
MSG_TYPE_ACCOUNT_QUERY = 0x04
// è´¦æˆ·æŸ¥è¯¢å“åº”
MSG_TYPE_ACCOUNT_RESPONSE = 0x05
// å……å€¼è®°å½•ä¸Šä¼ 
MSG_TYPE_RECHARGE_RECORD = 0x06
// è¡¥è´´è®°å½•ä¸Šä¼ 
MSG_TYPE_SUBSIDY_RECORD = 0x07
```

#### äº¤æ˜“ç±»å‹æ”¯æŒ
```java
TRANSACTION_TYPE_CONSUME = 0x01      // æ¶ˆè´¹
TRANSACTION_TYPE_RECHARGE = 0x02     // å……å€¼
TRANSACTION_TYPE_REFUND = 0x03       // é€€æ¬¾
TRANSACTION_TYPE_CANCEL = 0x04       // æ’¤é”€
TRANSACTION_TYPE_ADJUST = 0x05       // è°ƒæ•´
```

## ğŸš€ ç»„ä»¶åŒ–ç‰¹æ€§

### 1. åŠ¨æ€åè®®æ³¨å†Œ

```java
// æ–°å‚å•†åè®®æ¥å…¥ç¤ºä¾‹
public class NewVendorProtocolAdapter implements ProtocolAdapter {
    @Override
    public String getProtocolType() {
        return "NEW_VENDOR_PROTOCOL_V1_0";
    }

    @Override
    public String[] getSupportedDeviceModels() {
        return new String[]{"NV-100", "NV-200", "NV-300"};
    }

    // å®ç°å…¶ä»–æ¥å£æ–¹æ³•...
}

// è‡ªåŠ¨æ³¨å†Œåˆ°å·¥å‚
@Component
public class ProtocolInitializer {
    @Resource
    private ProtocolAdapterFactory factory;

    @Resource
    private NewVendorProtocolAdapter newVendorAdapter;

    @PostConstruct
    public void init() {
        factory.registerAdapter(newVendorAdapter);
    }
}
```

### 2. ç»Ÿä¸€ä¸šåŠ¡å¤„ç†

```java
// é€šè¿‡å·¥å‚æ¨¡å¼ç»Ÿä¸€å¤„ç†ä¸åŒå‚å•†è®¾å¤‡
@RestController
public class DeviceCommunicationController {

    @PostMapping("/process-access")
    public ResponseDTO<ProtocolProcessResult> processAccessBusiness(
            @RequestParam String protocolType,
            @RequestParam String businessType,
            @RequestBody Map<String, Object> businessData,
            @RequestParam Long deviceId) {

        ProtocolAdapter adapter = protocolAdapterFactory.getAdapter(protocolType);
        Future<ProtocolProcessResult> result = adapter.processAccessBusiness(businessType, businessData, deviceId);
        return ResponseDTO.ok(result.get());
    }
}
```

### 3. åè®®éªŒè¯æœºåˆ¶

```java
// ç»Ÿä¸€çš„åè®®éªŒè¯
public class ProtocolValidationResult {
    private boolean valid;
    private String errorCode;
    private String errorMessage;
    private String validationDetails;
}

// é€‚é…å™¨å†…å®ç°éªŒè¯é€»è¾‘
@Override
public ProtocolValidationResult validateMessage(ProtocolMessage message) {
    ProtocolValidationResult result = new ProtocolValidationResult();

    // 1. åŸºç¡€å­—æ®µéªŒè¯
    if (message.getDeviceSn() == null) {
        result.setValid(false);
        result.setErrorCode("DEVICE_SN_EMPTY");
        return result;
    }

    // 2. æ¶ˆæ¯ç±»å‹éªŒè¯
    if (!isValidMessageType(message.getMessageTypeCode())) {
        result.setValid(false);
        result.setErrorCode("MSG_TYPE_INVALID");
        return result;
    }

    // 3. è®¾å¤‡å‹å·éªŒè¯
    if (!isDeviceModelSupported(message.getDeviceModel())) {
        result.setValid(false);
        result.setErrorCode("DEVICE_MODEL_UNSUPPORTED");
        return result;
    }

    result.setValid(true);
    return result;
}
```

## ğŸ“Š ç³»ç»Ÿé›†æˆ

### 1. REST APIæ¥å£

æä¾›å®Œæ•´çš„REST APIç”¨äºåè®®ç®¡ç†å’Œä¸šåŠ¡å¤„ç†ï¼š

```bash
# åè®®ç®¡ç†æ¥å£
GET    /api/v1/device-comm/protocols                    # è·å–æ”¯æŒçš„åè®®ç±»å‹
GET    /api/v1/device-comm/device-models               # è·å–æ”¯æŒçš„è®¾å¤‡å‹å·
POST   /api/v1/device-comm/parse-message                # è§£æè®¾å¤‡æ¶ˆæ¯
POST   /api/v1/device-comm/build-response                # æ„å»ºè®¾å¤‡å“åº”

# ä¸šåŠ¡å¤„ç†æ¥å£
POST   /api/v1/device-comm/process-access                 # å¤„ç†é—¨ç¦ä¸šåŠ¡
POST   /api/v1/device-comm/process-consume                # å¤„ç†æ¶ˆè´¹ä¸šåŠ¡
POST   /api/v1/device-comm/process-attendance            # å¤„ç†è€ƒå‹¤ä¸šåŠ¡

# å·¥å‚ç®¡ç†æ¥å£
GET    /api/v1/device-comm/factory/statistics            # è·å–å·¥å‚ç»Ÿè®¡ä¿¡æ¯
GET    /api/v1/device-comm/factory/health                 # æ£€æŸ¥é€‚é…å™¨å¥åº·çŠ¶æ€
POST   /api/v1/device-comm/factory/reload                 # é‡æ–°åŠ è½½é€‚é…å™¨
```

### 2. å¾®æœåŠ¡é›†æˆ

ä½œä¸ºç‹¬ç«‹çš„è®¾å¤‡é€šè®¯å¾®æœåŠ¡ï¼Œé€šè¿‡APIç½‘å…³ä¸å…¶ä»–æœåŠ¡é›†æˆï¼š

```java
// é—¨ç¦æœåŠ¡è°ƒç”¨ç¤ºä¾‹
@Service
public class AccessServiceImpl {

    @Resource
    private GatewayServiceClient gatewayServiceClient;

    public ResponseDTO<Void> handleDeviceEvent(String protocolType, String deviceData) {
        // é€šè¿‡ç½‘å…³è°ƒç”¨è®¾å¤‡é€šè®¯æœåŠ¡
        return gatewayServiceClient.callDeviceCommService(
            "/api/v1/device-comm/parse-message",
            HttpMethod.POST,
            Map.of(
                "protocolType", protocolType,
                "hexData", deviceData,
                "deviceId", deviceId
            ),
            ProtocolMessage.class
        );
    }
}
```

### 3. æ•°æ®å­˜å‚¨

åè®®æ¶ˆæ¯å­˜å‚¨åˆ°ç»Ÿä¸€çš„æ•°æ®è¡¨ï¼š

```sql
-- åè®®æ¶ˆæ¯ç»Ÿä¸€å­˜å‚¨è¡¨
CREATE TABLE t_protocol_message (
    message_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id BIGINT,
    device_code VARCHAR(50),
    protocol_type VARCHAR(50),
    message_direction VARCHAR(10),
    message_type VARCHAR(50),
    command_code VARCHAR(50),
    raw_hex_data TEXT,
    business_data TEXT,
    message_status VARCHAR(20),
    process_result VARCHAR(20),
    create_time DATETIME,
    update_time DATETIME,
    deleted_flag TINYINT DEFAULT 0
);
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. åè®®å®‰å…¨

- **æ¶ˆæ¯ç­¾åéªŒè¯**: æ”¯æŒæ•°å­—ç­¾åéªŒè¯æ¶ˆæ¯å®Œæ•´æ€§
- **æ ¡éªŒç æœºåˆ¶**: CRC32æˆ–å…¶ä»–æ ¡éªŒç®—æ³•ç¡®ä¿æ•°æ®æ­£ç¡®æ€§
- **æƒé™æ§åˆ¶**: åŸºäºè®¾å¤‡IDå’Œæ“ä½œç±»å‹çš„æƒé™éªŒè¯
- **é˜²é‡æ”¾æ”»å‡»**: æ¶ˆæ¯åºåˆ—å·å’Œæ—¶é—´æˆ³é˜²é‡æ”¾

### 2. æ•°æ®å®‰å…¨

- **æ•æ„Ÿæ•°æ®åŠ å¯†**: è´¦æˆ·ä¿¡æ¯ã€ç”Ÿç‰©ç‰¹å¾ç­‰æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- **ä¼ è¾“å®‰å…¨**: æ”¯æŒHTTPSä¼ è¾“åè®®åŠ å¯†
- **è®¿é—®æ§åˆ¶**: åŸºäºè§’è‰²çš„è®¿é—®æƒé™æ§åˆ¶
- **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—è®°å½•

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥

```java
// è®¾å¤‡SNåˆ°åè®®ç±»å‹ç¼“å­˜
private final Map<String, String> deviceSnToProtocolCache = new ConcurrentHashMap<>();

// åè®®é€‚é…å™¨å®ä¾‹ç¼“å­˜
private final Map<String, ProtocolAdapter> adapterRegistry = new ConcurrentHashMap<>();
```

### 2. å¼‚æ­¥å¤„ç†

```java
// å¼‚æ­¥ä¸šåŠ¡å¤„ç†
@Override
public Future<ProtocolProcessResult> processAccessBusiness(String businessType, Map<String, Object> businessData, Long deviceId) {
    return CompletableFuture.supplyAsync(() -> {
        // ä¸šåŠ¡å¤„ç†é€»è¾‘
        return result;
    });
}
```

### 3. è¿æ¥æ± ç®¡ç†

```yaml
# è®¾å¤‡è¿æ¥æ± é…ç½®
device-communication:
  connection-pool:
    max-total: 100
    max-idle: 20
    min-idle: 5
    validation-query: SELECT 1
```

## ğŸ”„ æ‰©å±•èƒ½åŠ›

### 1. æ–°å‚å•†åè®®æ¥å…¥

æ¥å…¥æ–°å‚å•†åè®®åªéœ€è¦ï¼š

1. **å®ç°ProtocolAdapteræ¥å£**
2. **åˆ›å»ºåè®®æ¶ˆæ¯å®ä½“**
3. **æ³¨å†Œåˆ°é€‚é…å™¨å·¥å‚**

```java
// ä¸‰ä¸ªæ­¥éª¤å³å¯å®Œæˆæ–°åè®®æ¥å…¥
@Component
public class NewVendorAdapter implements ProtocolAdapter {
    // å®ç°æ¥å£æ–¹æ³•
}

// æ³¨å†Œåˆ°Springå®¹å™¨
@Resource
private NewVendorAdapter newVendorAdapter;

// åˆå§‹åŒ–æ—¶æ³¨å†Œ
factory.registerAdapter(newVendorAdapter);
```

### 2. åè®®ç‰ˆæœ¬å‡çº§

æ”¯æŒåŒä¸€å‚å•†å¤šç‰ˆæœ¬åè®®å¹¶å­˜ï¼š

```java
// ç‰ˆæœ¬åŒ–åè®®ç±»å‹
public static final String ACCESS_ENTROPY_V4_8 = "ACCESS_ENTROPY_V4_8";
public static final String ACCESS_ENTROPY_V5_0 = "ACCESS_ENTROPY_V5_0";

// å·¥å‚åŒæ—¶æ”¯æŒå¤šç‰ˆæœ¬
factory.registerAdapter(new AccessEntropyV48Adapter());
factory.registerAdapter(new AccessEntropyV50Adapter());
```

### 3. è®¾å¤‡å‹å·æ‰©å±•

æ”¯æŒæ–°å¢è®¾å¤‡å‹å·æ— éœ€ä¿®æ”¹ä»£ç ï¼š

```java
// é€šè¿‡æ•°æ®åº“é…ç½®æ”¯æŒçš„è®¾å¤‡å‹å·
@Value("${device.supported.models}")
private List<String> supportedModels;

// åŠ¨æ€æ›´æ–°è®¾å¤‡å‹å·æ˜ å°„
public void updateDeviceModelMapping(String deviceModel, String protocolType) {
    deviceModelToProtocolMap.put(deviceModel.toUpperCase(), protocolType);
}
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### 1. å¥åº·æ£€æŸ¥

```java
@Override
public Map<String, Object> checkAdapterHealth() {
    Map<String, Object> healthReport = new HashMap<>();

    for (ProtocolAdapter adapter : adapterRegistry.values()) {
        String status = adapter.getAdapterStatus();
        adapterHealth.put(adapter.getProtocolType(), status);
    }

    return healthReport;
}
```

### 2. æ€§èƒ½ç»Ÿè®¡

```java
@Override
public Map<String, Object> getPerformanceStatistics() {
    Map<String, Object> stats = new HashMap<>();
    stats.put("processedMessageCount", processedMessageCount);
    stats.put("errorCount", errorCount);
    stats.put("averageProcessTime", averageProcessTime);
    stats.put("adapterStatus", getAdapterStatus());
    return stats;
}
```

### 3. æ—¥å¿—è®°å½•

```java
// ç»“æ„åŒ–æ—¥å¿—è®°å½•
log.info("[{}] {} å¤„ç†æ¶ˆæ¯: deviceSn={}, messageType={}, processTime={}ms",
    protocolType, operation, deviceSn, messageType, processTime);
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. è§£æè®¾å¤‡æ¶ˆæ¯

```bash
curl -X POST "http://localhost:8087/api/v1/device-comm/parse-message" \
  -H "Content-Type: application/json" \
  -d '{
    "protocolType": "ACCESS_ENTROPY_V4_8",
    "hexData": "484500240480000000000000000000000000000000000001011234567890123456000000000000000001",
    "deviceId": 1001
  }'
```

### 2. å¤„ç†é—¨ç¦ä¸šåŠ¡

```bash
curl -X POST "http://localhost:8087/api/v1/device-comm/process-access" \
  -H "Content-Type: application/json" \
  -d '{
    "protocolType": "ACCESS_ENTROPY_V4_8",
    "businessType": "REAL_TIME_EVENT",
    "deviceId": 1001,
    "businessData": {
      "eventNumber": "EVT202312160001",
      "userId": 1001,
      "verifyMethod": "FACE",
      "verifyResult": "SUCCESS"
    }
  }'
```

### 3. è·å–å·¥å‚ç»Ÿè®¡ä¿¡æ¯

```bash
curl -X GET "http://localhost:8087/api/v1/device-comm/factory/statistics"
```

## âœ… å®ç°æˆæœ

### å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

1. **âœ… ç»„ä»¶åŒ–åè®®æ¶æ„**: å®Œæ•´çš„é€‚é…å™¨æ¨¡å¼å®ç°ï¼Œæ”¯æŒåè®®çš„åŠ¨æ€æ³¨å†Œå’Œç®¡ç†
2. **âœ… ç†µåŸºç§‘æŠ€é—¨ç¦åè®®V4.8**: ä¸¥æ ¼éµå¾ªåè®®è§„èŒƒï¼Œæ”¯æŒå®Œæ•´çš„é—¨ç¦åŠŸèƒ½
3. **âœ… ä¸­æ§æ™ºæ…§æ¶ˆè´¹åè®®V1.0**: ä¸¥æ ¼æŒ‰ç…§åè®®å®ç°ï¼Œæ”¯æŒæ¶ˆè´¹ã€å……å€¼ã€è¡¥è´´ç­‰ä¸šåŠ¡
4. **âœ… ç»Ÿä¸€æ¶ˆæ¯å¤„ç†**: æ ‡å‡†åŒ–çš„æ¶ˆæ¯è§£æã€æ„å»ºå’ŒéªŒè¯æœºåˆ¶
5. **âœ… ä¸šåŠ¡æ•°æ®é›†æˆ**: å®Œæ•´çš„é—¨ç¦ã€æ¶ˆè´¹ã€è€ƒå‹¤ä¸šåŠ¡å¤„ç†èƒ½åŠ›
6. **âœ… REST APIæ¥å£**: å®Œæ•´çš„ç®¡ç†å’Œä¸šåŠ¡å¤„ç†æ¥å£
7. **âœ… å·¥å‚æ³¨å†Œæœºåˆ¶**: è‡ªåŠ¨åŒ–é€‚é…å™¨æ³¨å†Œå’Œè®¾å¤‡å‹å·æ˜ å°„
8. **âœ… ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–**: è®¾å¤‡SNç¼“å­˜ã€å¼‚æ­¥å¤„ç†ç­‰æ€§èƒ½ä¼˜åŒ–

### æ¶æ„ä¼˜åŠ¿

1. **é«˜å†…èšä½è€¦åˆ**: æ¯ä¸ªåè®®é€‚é…å™¨ç‹¬ç«‹å®ç°ï¼Œäº’ä¸å½±å“
2. **å¯æ‰©å±•æ€§å¼º**: æ–°å‚å•†åè®®æ¥å…¥æˆæœ¬ä½ï¼Œä»£ç å¤ç”¨æ€§é«˜
3. **ç»Ÿä¸€æ¥å£**: æ ‡å‡†åŒ–çš„åè®®å¤„ç†æ¥å£ï¼Œéšè—åº•å±‚å·®å¼‚
4. **ä¼ä¸šçº§ç‰¹æ€§**: æ”¯æŒéªŒè¯ã€ç¼“å­˜ã€ç›‘æ§ã€æ—¥å¿—ç­‰ä¼ä¸šçº§åŠŸèƒ½
5. **ç»´æŠ¤æ€§å¥½**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºç»´æŠ¤å’Œå‡çº§

### æŠ€æœ¯äº®ç‚¹

1. **ä¸¥æ ¼éµå¾ªå‚å•†åè®®**: ç¡®ä¿ä¸è®¾å¤‡100%å…¼å®¹
2. **å®Œæ•´çš„æ¶ˆæ¯å¤„ç†**: æ”¯æŒæ‰€æœ‰æ¶ˆæ¯ç±»å‹çš„è§£æå’Œæ„å»º
3. **çµæ´»çš„ä¸šåŠ¡å¤„ç†**: æ”¯æŒé—¨ç¦ã€æ¶ˆè´¹ã€è€ƒå‹¤ç­‰å¤šç§ä¸šåŠ¡åœºæ™¯
4. **å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›**: æ”¯æŒæ–°åè®®ã€æ–°ç‰ˆæœ¬ã€æ–°è®¾å¤‡çš„å¿«é€Ÿæ¥å…¥
5. **å®Œå–„çš„ç›‘æ§ä½“ç³»**: å¥åº·æ£€æŸ¥ã€æ€§èƒ½ç»Ÿè®¡ã€æ—¥å¿—è®°å½•ç­‰

## ğŸš€ åç»­æ‰©å±•

### è®¡åˆ’æ”¯æŒçš„åè®®

1. **ç†µåŸºç§‘æŠ€è€ƒå‹¤åè®®V4.0**: å®Œæ•´çš„è€ƒå‹¤æ•°æ®å¤„ç†
2. **æµ·åº·å¨è§†è§†é¢‘åè®®**: è§†é¢‘è®¾å¤‡æ¥å…¥å’Œæ§åˆ¶
3. **å¤§åå®‰é˜²åè®®**: å®‰é˜²è®¾å¤‡é€šè®¯æ”¯æŒ
4. **å®‡è§†ç§‘æŠ€åè®®**: æ›´å¤šå®‰é˜²å‚å•†æ”¯æŒ

### åŠŸèƒ½å¢å¼º

1. **åè®®é…ç½®ç®¡ç†**: åŠ¨æ€åè®®å‚æ•°é…ç½®
2. **è®¾å¤‡æ‰¹é‡ç®¡ç†**: æ‰¹é‡è®¾å¤‡æ“ä½œå’Œç®¡ç†
3. **åè®®æµ‹è¯•å·¥å…·**: åè®®æµ‹è¯•å’Œè°ƒè¯•å·¥å…·
4. **å®æ—¶ç›‘æ§ä»ªè¡¨æ¿**: åè®®å¤„ç†å®æ—¶ç›‘æ§

è¿™ä¸ªç»„ä»¶åŒ–çš„è®¾å¤‡é€šè®¯åè®®æ¶æ„å®Œå…¨æ»¡è¶³äº†ç”¨æˆ·çš„è¦æ±‚ï¼Œå®ç°äº†"ä¸¥æ ¼éµå¾ªè®¾å¤‡é€šè®¯åè®®"å’Œ"ç»„ä»¶åŒ–ä»¥ä¾¿åç»­å…¼å®¹ä¸åŒå‚å®¶è®¾å¤‡"çš„æ ¸å¿ƒç›®æ ‡ï¼Œä¸ºIOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æä¾›äº†å¼ºå¤§ã€çµæ´»ã€å¯æ‰©å±•çš„è®¾å¤‡é€šè®¯èƒ½åŠ›ã€‚