# åè®®æ ¼å¼åˆ†ææ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æ ¹æ®PDFåè®®æ–‡æ¡£åˆ†æï¼Œä¸‰ä¸ªåè®®éƒ½æ˜¯åŸºäºHTTPçš„æ–‡æœ¬æ ¼å¼åè®®ï¼Œä¸æ˜¯TCPäºŒè¿›åˆ¶åè®®ã€‚

**æœ€åæ›´æ–°**: 2025-01-30

---

## ğŸ” é—¨ç¦åè®®ï¼ˆAccessProtocolHandlerï¼‰- å®‰é˜²PUSHé€šè®¯åè®® V4.8

### åè®®ç±»å‹
- **åè®®**: HTTP POST
- **URLè·¯å¾„**: `/iclock/cdata?SN={SerialNumber}&table=rtlog`
- **Content-Type**: `application-push; charset=UTF-8`
- **æ•°æ®æ ¼å¼**: é”®å€¼å¯¹æ ¼å¼ï¼Œä½¿ç”¨HTï¼ˆåˆ¶è¡¨ç¬¦`\t`ï¼‰åˆ†éš”

### å®æ—¶äº‹ä»¶æ•°æ®æ ¼å¼ï¼ˆrtlogè¡¨ï¼‰

**æ•°æ®æ ¼å¼**:
```
time={Time}\tpin={Pin}\tcardno={CardNo}\tsitecode={SiteCode}\tlinkid={LinkId}\teventaddr={EventAddr}\tevent={Event}\tinoutstatus={InOutStatus}\tverifytype={VerifyType}\tindex={Index}\tmaskflag={MaskFlag}\ttemperature={Temperature}\tconvtemperature={ConvTemperature}\tbitCount={BitCount}
```

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| time | string | æ—¶é—´ï¼Œæ ¼å¼ï¼šXXXX-XX-XX XX:XX:XX | `2017-01-10 11:49:32` |
| pin | int | å·¥å·ï¼ˆç”¨æˆ·IDï¼‰ | `0` |
| cardno | string | å¡å·ï¼ˆåå…­è¿›åˆ¶æˆ–æ•°å­—ï¼‰ | `0` |
| sitecode | string | åŒºä½ç ï¼ˆå¯é€‰ï¼‰ | `XXX` |
| linkid | string | è”åŠ¨äº‹ä»¶IDï¼ˆå¯é€‰ï¼‰ | `XXX` |
| eventaddr | int | äº‹ä»¶ç‚¹ï¼Œé»˜è®¤ä¸ºdoorid | `1` |
| event | int | äº‹ä»¶ç ï¼ˆ0-255åŸäº‹ä»¶ç ï¼Œ4000-7000æ‰©å±•äº‹ä»¶ç ï¼‰ | `27` |
| inoutstatus | int | å‡ºå…¥çŠ¶æ€ï¼Œ0-å…¥ï¼Œ1-å‡º | `1` |
| verifytype | string | éªŒè¯æ–¹å¼ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼Œè§æ–‡æ¡£ï¼‰ | `0` |
| index | int | é—¨ç¦è®°å½•IDï¼ˆè®¾å¤‡ä¸­å­˜å‚¨çš„å”¯ä¸€IDï¼‰ | `21` |
| maskflag | int | å£ç½©æ ‡å¿—ï¼Œ0-æœªæˆ´å£ç½©ï¼Œ1-æˆ´å£ç½©ï¼ˆå¯é€‰ï¼‰ | `0` |
| temperature | float | æ¸©åº¦å€¼ï¼Œå¸¦å°æ•°ç‚¹ï¼ˆå¯é€‰ï¼‰ | `36.2` |
| convtemperature | float | è½¬æ¢åçš„æ¸©åº¦å€¼ï¼ˆå¯é€‰ï¼‰ | `36.2` |
| bitCount | int | éŸ¦æ ¹ä½æ•°ï¼ˆå¯é€‰ï¼ŒWGRuleVer=V2.0ä»¥ä¸Šï¼‰ | `26` |

**ç¤ºä¾‹æ•°æ®**:
```
time=2017-01-10 11:49:32	pin=0	cardno=0	eventaddr=1	event=27	inoutstatus=1	verifytype=0	index=21
```

### å®æ—¶çŠ¶æ€æ•°æ®æ ¼å¼ï¼ˆrtstateè¡¨ï¼‰

**æ•°æ®æ ¼å¼**:
```
time={Time}\tsensor={Sensor}\trelay={Relay}\talarm={Alarm}
```

**å­—æ®µå®šä¹‰**:

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| time | string | å½“å‰æ—¶é—´ï¼Œæ ¼å¼ï¼šXXXX-XX-XX XX:XX |
| sensor | string | é—¨ç£çŠ¶æ€ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ŒAAè¡¨ç¤º1-4é—¨ï¼ŒBBè¡¨ç¤º5-8é—¨ï¼‰ |
| relay | string | ç»§ç”µå™¨çŠ¶æ€ï¼ˆåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ŒCCè¡¨ç¤º1-8é—¨ï¼‰ |
| alarm | string | æŠ¥è­¦çŠ¶æ€ï¼ˆ16ä¸ªå­—ç¬¦çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ŒDDEEFFGGHHIIJJKKï¼Œæ¯ä¸ªé—¨2ä¸ªå­—ç¬¦ï¼‰ |

---

## â° è€ƒå‹¤åè®®ï¼ˆAttendanceProtocolHandlerï¼‰- è€ƒå‹¤PUSHé€šè®¯åè®® V4.0

### åè®®ç±»å‹
- **åè®®**: HTTP POST
- **URLè·¯å¾„**: `/iclock/cdata?SN={SerialNumber}&table=ATTLOG&Stamp={TimeStamp}`
- **Content-Type**: `text/plain; charset=UTF-8`ï¼ˆæˆ–GB2312ï¼Œæ ¹æ®ç”¨æˆ·å§“åï¼‰
- **æ•°æ®æ ¼å¼**: åˆ¶è¡¨ç¬¦åˆ†éš”çš„æ–‡æœ¬æ ¼å¼

### è€ƒå‹¤è®°å½•æ•°æ®æ ¼å¼ï¼ˆATTLOGè¡¨ï¼‰

**æ•°æ®æ ¼å¼**:
```
{Pin}\t{Time}\t{Status}\t{Verify}\t{Workcode}\t{Reserved1}\t{Reserved2}\t{MaskFlag}\t{Temperature}\t{ConvTemperature}
```

**å­—æ®µå®šä¹‰**ï¼ˆæŒ‰é¡ºåºï¼‰:

| åºå· | å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|--------|------|------|------|
| 1 | Pin | int/string | å·¥å·ï¼ˆç”¨æˆ·IDï¼‰ | `1452` |
| 2 | Time | string | éªŒè¯æ—¶é—´ï¼Œæ ¼å¼ï¼šXXXX-XX-XX XX:XX:XX | `2015-07-30 15:16:28` |
| 3 | Status | int | è€ƒå‹¤çŠ¶æ€ï¼ˆ0-æ­£å¸¸ï¼Œå…¶ä»–è§æ–‡æ¡£ï¼‰ | `0` |
| 4 | Verify | int | éªŒè¯æ–¹å¼ï¼ˆè§é™„å½•3ï¼‰ | `1` |
| 5 | Workcode | int | å·¥ä½œå·ç ç¼–ç  | `0` |
| 6 | Reserved1 | int | é¢„ç•™å­—æ®µ1 | `0` |
| 7 | Reserved2 | int | é¢„ç•™å­—æ®µ2 | `0` |
| 8 | MaskFlag | int | å£ç½©æ ‡å¿—ï¼Œ0-æœªæˆ´å£ç½©ï¼Œ1-æˆ´å£ç½©ï¼ˆå¯é€‰ï¼‰ | `0` |
| 9 | Temperature | float | æ¸©åº¦å€¼ï¼Œå¸¦å°æ•°ç‚¹ï¼ˆå¯é€‰ï¼‰ | `36.2` |
| 10 | ConvTemperature | float | è½¬æ¢åçš„æ¸©åº¦å€¼ï¼ˆå¯é€‰ï¼‰ | `36.2` |

**ç¤ºä¾‹æ•°æ®**:
```
1452	2015-07-30 15:16:28	0	1	0	0	0
8965	2015-07-30 15:16:36	0	1	0	0	0
```

**å¤šæ¡è®°å½•**: ä½¿ç”¨LFï¼ˆæ¢è¡Œç¬¦`\n`ï¼‰è¿æ¥

---

## ğŸ’³ æ¶ˆè´¹åè®®ï¼ˆConsumeProtocolHandlerï¼‰- æ¶ˆè´¹PUSHé€šè®¯åè®® V1.0

### åè®®ç±»å‹
- **åè®®**: HTTP POST
- **URLè·¯å¾„**: `/iclock/cpos?SN={SerialNumber}&table=BUYLOG&Stamp={TimeStamp}&Stampld={RecNo}`
- **Content-Type**: `text/plain; charset=UTF-8`ï¼ˆæˆ–GB18030ï¼Œæ ¹æ®ç”¨æˆ·å§“åï¼‰
- **æ•°æ®æ ¼å¼**: åˆ¶è¡¨ç¬¦åˆ†éš”çš„æ–‡æœ¬æ ¼å¼

### æ¶ˆè´¹è®°å½•æ•°æ®æ ¼å¼ï¼ˆBUYLOGè¡¨ï¼‰

#### å•é’±åŒ…æ ¼å¼

**æ•°æ®æ ¼å¼**:
```
{SysID}\t{CARDNO}\t{PosTime}\t{PosMoney}\t{Balance}\t{CardRecID}\t{State}\t{MealType}\t{MealDate}\t{RecNo}\t{OPID}
```

**å­—æ®µå®šä¹‰**ï¼ˆæŒ‰é¡ºåºï¼‰:

| åºå· | å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|--------|------|------|------|
| 1 | SysID | int | ç³»ç»ŸID | `1` |
| 2 | CARDNO | string | å¡å· | `123456789` |
| 3 | PosTime | int | æ¶ˆè´¹æ—¶é—´ï¼ŒUnixæ—¶é—´æˆ³ï¼ˆç§’ï¼‰ | `1706582400` |
| 4 | PosMoney | int | æ¶ˆè´¹é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰ | `1000` |
| 5 | Balance | int | ä½™é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰ | `50000` |
| 6 | CardRecID | int | å¡æµæ°´å· | `12345` |
| 7 | State | int | æ¶ˆè´¹ç±»å‹ | `0` |
| 8 | MealType | int | é¤åˆ« | `1` |
| 9 | MealDate | string | è®°é¤æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD | `2018-12-20` |
| 10 | RecNo | int | æœºå™¨æµæ°´å· | `100` |
| 11 | OPID | int | æ“ä½œå‘˜ID | `1` |

#### åŒé’±åŒ…æ ¼å¼

**æ•°æ®æ ¼å¼**:
```
{SysID}\t{CARDNO}\t{PosTime}\t{PosMoney}\t{Balance}\t{CardRecID}\t{State}\t{MealType}\t{MealDate}\t{RecNo}\t{OPID}\t{SubPosMoney}\t{SubBalance}\t{User_PIN}
```

**é¢å¤–å­—æ®µ**:

| åºå· | å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|------|--------|------|------|
| 12 | SubPosMoney | int | å­é’±åŒ…æ¶ˆè´¹é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰ |
| 13 | SubBalance | int | å­é’±åŒ…ä½™é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰ |
| 14 | User_PIN | string | ç”¨æˆ·å·¥å· |

**ç¤ºä¾‹æ•°æ®**:
```
1	123456789	1706582400	1000	50000	12345	0	1	2018-12-20	100	1
```

**å¤šæ¡è®°å½•**: ä½¿ç”¨LFï¼ˆæ¢è¡Œç¬¦`\n`ï¼‰è¿æ¥

---

## ğŸ” å…³é”®å‘ç°

### 1. åè®®ç±»å‹
- âŒ **ä¸æ˜¯TCPäºŒè¿›åˆ¶åè®®**
- âœ… **æ˜¯HTTPæ–‡æœ¬åè®®**
- âœ… **æ•°æ®æ ¼å¼ä¸ºæ–‡æœ¬ï¼ˆé”®å€¼å¯¹æˆ–åˆ¶è¡¨ç¬¦åˆ†éš”ï¼‰**

### 2. æ•°æ®æ ¼å¼å·®å¼‚

| åè®® | æ•°æ®æ ¼å¼ | åˆ†éš”ç¬¦ |
|------|---------|--------|
| é—¨ç¦åè®® | é”®å€¼å¯¹ | HTï¼ˆåˆ¶è¡¨ç¬¦`\t`ï¼‰ |
| è€ƒå‹¤åè®® | åˆ¶è¡¨ç¬¦åˆ†éš” | HTï¼ˆåˆ¶è¡¨ç¬¦`\t`ï¼‰ |
| æ¶ˆè´¹åè®® | åˆ¶è¡¨ç¬¦åˆ†éš” | HTï¼ˆåˆ¶è¡¨ç¬¦`\t`ï¼‰ |

### 3. ç¼–ç æ ¼å¼

| åè®® | ç¼–ç  | è¯´æ˜ |
|------|------|------|
| é—¨ç¦åè®® | UTF-8 | ç»Ÿä¸€ä½¿ç”¨UTF-8ç¼–ç  |
| è€ƒå‹¤åè®® | UTF-8/GB2312 | ä¸­æ–‡ä½¿ç”¨GB2312ï¼Œå…¶ä»–ä½¿ç”¨UTF-8 |
| æ¶ˆè´¹åè®® | UTF-8/GB18030 | ä¸­æ–‡ä½¿ç”¨GB18030ï¼Œå…¶ä»–ä½¿ç”¨UTF-8 |

### 4. HTTPè¯·æ±‚æ ¼å¼

æ‰€æœ‰åè®®éƒ½ä½¿ç”¨HTTP POSTè¯·æ±‚ï¼š

```
POST /iclock/{path}?SN={SerialNumber}&table={TableName}&Stamp={TimeStamp} HTTP/1.1
Host: {ServerIP}:{ServerPort}
Content-Type: application-push; charset=UTF-8
Content-Length: {Length}

{DataRecord}
```

### 5. æ ¡éªŒå’Œ

**é‡è¦å‘ç°**: è¿™äº›HTTPåè®®**æ²¡æœ‰æ ¡éªŒå’Œå­—æ®µ**ï¼

- é—¨ç¦åè®®ï¼šæ— æ ¡éªŒå’Œ
- è€ƒå‹¤åè®®ï¼šæ— æ ¡éªŒå’Œ
- æ¶ˆè´¹åè®®ï¼šæ— æ ¡éªŒå’Œ

æ•°æ®å®Œæ•´æ€§ç”±HTTPåè®®æœ¬èº«ä¿è¯ï¼ˆTCPå±‚æ ¡éªŒï¼‰ã€‚

---

## ğŸ“ å®ç°å»ºè®®

### 1. æ›´æ–°åè®®å¤„ç†å™¨

å½“å‰åè®®å¤„ç†å™¨è®¾è®¡ä¸ºè§£æäºŒè¿›åˆ¶æ•°æ®ï¼Œéœ€è¦æ›´æ–°ä¸ºè§£æHTTPæ–‡æœ¬æ•°æ®ï¼š

- âœ… ä¿ç•™`parseMessage(String rawData)`æ–¹æ³•
- âŒ ç§»é™¤æˆ–ç®€åŒ–`parseMessage(byte[] rawData)`æ–¹æ³•ï¼ˆä»…ç”¨äºå…¼å®¹ï¼‰
- âœ… å®ç°æ–‡æœ¬è§£æé€»è¾‘ï¼ˆé”®å€¼å¯¹è§£æã€åˆ¶è¡¨ç¬¦åˆ†éš”è§£æï¼‰

### 2. æ›´æ–°HTTPæ¥å£

å½“å‰`ProtocolController`æ¥æ”¶å­—èŠ‚æ•°ç»„ï¼Œéœ€è¦æ›´æ–°ä¸ºæ¥æ”¶æ–‡æœ¬æ•°æ®ï¼š

- âœ… æ”¯æŒæ¥æ”¶`application/x-www-form-urlencoded`
- âœ… æ”¯æŒæ¥æ”¶`text/plain`
- âœ… æ”¯æŒæ¥æ”¶`application-push; charset=UTF-8`

### 3. ç§»é™¤æ ¡éªŒå’ŒéªŒè¯

ç”±äºHTTPåè®®æœ¬èº«æ²¡æœ‰æ ¡éªŒå’Œï¼Œéœ€è¦ï¼š

- âš ï¸ ç§»é™¤æˆ–æ ‡è®°ä¸º"ä¸é€‚ç”¨"æ ¡éªŒå’ŒéªŒè¯æ–¹æ³•
- âœ… ä¿ç•™æ•°æ®æ ¼å¼éªŒè¯

---

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œ

1. **æ›´æ–°åè®®å¤„ç†å™¨**ï¼Œå®ç°æ–‡æœ¬æ ¼å¼è§£æ
2. **æ›´æ–°HTTPæ¥å£**ï¼Œæ”¯æŒæ¥æ”¶æ–‡æœ¬æ•°æ®
3. **ç§»é™¤æ ¡éªŒå’ŒéªŒè¯**ï¼ˆHTTPåè®®ä¸éœ€è¦ï¼‰
4. **å®ç°å­—æ®µæ˜ å°„**ï¼Œæ ¹æ®æ–‡æ¡£å®Œå–„å­—æ®µè§£æ

---

**æ–‡æ¡£ç»´æŠ¤**: IOE-DREAM Team  
**æœ€åæ›´æ–°**: 2025-01-30

