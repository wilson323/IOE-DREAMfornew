# ============================================================
# IOE-DREAM Device Communication Service - Spring Boot 3.5.8 配置
# 设备通讯服务 - 企业级生产环境配置
#
# 技术标准: Spring Boot 3.5.8 + Jakarta EE 9.0 + Java 17
# 遵循规范: 完全兼容Spring Boot 3.x配置模式
#
# @Author: IOE-DREAM架构委员会
# @Version: v1.0.0-企业级重构版
# @Date: 2025-01-30
# ============================================================

# ==================== Spring Boot 核心配置 ====================
spring:
  application:
    name: ioedream-device-comm-service

  # ==================== 数据源配置 (设备通讯优化) ====================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # 设备通讯连接池配置
      initial-size: 20
      min-idle: 20
      max-active: 100
      max-wait: 20000

      # 性能优化配置
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      time-between-eviction-runs-millis: 60000

      # 设备通讯安全配置
      remove-abandoned: true
      remove-abandoned-timeout: 150
      log-abandoned: true

      # 连接池监控配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
      filter:
        stat:
          enabled: true
          slow-sql-millis: 600
          log-slow-sql: true

  # ==================== Redis配置 (Spring Boot 3.x标准) ====================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:ENC(AES256:encrypted_password)}
      database: ${REDIS_DATABASE:6}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 40
          max-idle: 20
          min-idle: 10
          max-wait: 3000ms

  # ==================== 缓存配置 (设备通讯优化) ====================
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=35000,expireAfterWrite=25m,recordStats

  # ==================== MyBatis-Plus配置 (Spring Boot 3.x兼容) ====================
  mybatis-plus:
    # 全局配置
    global-config:
      db-config:
        logic-delete-field: deletedFlag
        logic-delete-value: 1
        logic-not-delete-value: 0
        id-type: ASSIGN_ID
        table-underline: true

    # 配置信息
    configuration:
      map-underscore-to-camel-case: true
      cache-enabled: true
      call-setters-on-nulls: true
      log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

  # ==================== 事务配置 ====================
  transaction:
    default-timeout: 30
    rollback-on-commit-failure: true

# ==================== 服务器配置 ====================
server:
  port: 8087
  servlet:
    context-path: /device-comm
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    threads:
      max: 350
      min-spare: 35
    max-connections: 15000
    accept-count: 250
    connection-timeout: 15000
    # 设备数据接收优化
    max-http-form-post-size: 50MB

# ==================== 管理端点配置 (Spring Boot 3.x标准) ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: always
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# ==================== 日志配置 (Spring Boot 3.x标准) ====================
logging:
  level:
    root: INFO
    net.lab1024.sa.device.comm: DEBUG
    org.springframework.web: INFO
    com.alibaba.druid: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/device-comm-service.log
    max-size: 400MB
    max-history: 20

# ==================== 环境特定配置 ====================
---
spring:
  config:
    activate:
      on-profile: dev

logging:
  level:
    root: DEBUG

---
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
  file:
    name: logs/device-comm-service-prod.log