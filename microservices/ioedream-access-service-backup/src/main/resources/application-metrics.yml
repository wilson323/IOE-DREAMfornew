# =============================================
# 门禁微服务性能监控配置
# =============================================

# Micrometer配置
micrometer:
  metrics:
    # 启用所有指标
    enable:
      jvm: true
      system: true
      processor: true
      memory: true
      tomcat: true
      cache: true
      data.source: true
      web.client: true
      web.server: true
      http.client: true
      logback: true

    # 指标导出配置
    export:
      # Prometheus配置
      prometheus:
        enabled: true
        step: 30s
        descriptions: true

      # JMX配置（开发环境使用）
      jmx:
        enabled: false
        step: 60s

      # InfluxDB配置（生产环境可选）
      influx:
        enabled: false
        step: 60s
        uri: http://localhost:8086
        db: access_service_metrics

    # 指标标签配置
    tags:
      application: ${spring.application.name}
      instance: ${spring.application.name}:${server.port}
      environment: ${spring.profiles.active}
      region: ${ACCESS_SERVICE_REGION:default}
      zone: ${ACCESS_SERVICE_ZONE:default}

    # 指标过滤器
    distribution:
      # HTTP请求指标百分位配置
      percentiles-histogram:
        http.server.requests: true
        http.client.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
        http.client.requests: 0.5,0.9,0.95,0.99
      # 响应时间桶配置
      sla:
        http.server.requests: 10ms,50ms,100ms,200ms,500ms,1s,2s,5s
        http.client.requests: 10ms,50ms,100ms,200ms,500ms,1s,2s,5s

# Spring Boot Actuator配置
management:
  # 端点配置
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,configprops
      base-path: /actuator
      cors:
        allowed-origins: "*"
        allowed-methods: GET,POST,PUT,DELETE,OPTIONS

  # 健康检查配置
  health:
    # 显示详细健康信息
    show-details: always
    # 组件健康检查
    components:
      db:
        enabled: true
      redis:
        enabled: true
      diskSpace:
        enabled: true
        threshold: 100MB
      livenessState:
        enabled: true
      readinessState:
        enabled: true
    # 自定义健康指示器
    probes:
      enabled: true
    # 健康检查分组
    group:
      liveness:
        include: livenessState,diskSpace
        show-details: always
      readiness:
        include: readinessState,db,redis
        show-details: always
      custom:
        include: db,redis,diskSpace,bluetooth,video
        show-details: always

  # 指标端点配置
  metrics:
    # 启用所有指标
    enable:
      jvm: true
      system: true
      processor: true
      memory: true
      tomcat: true
      cache: true
      data.source: true
      web.client: true
      web.server: true
      http.client: true
      logback: true

    # 指标导出配置
    export:
      # Prometheus配置
      prometheus:
        enabled: true
        step: 30s
        descriptions: true
        # 自定义指标注册
        registry: prometheusMeterRegistry

    # 分布式统计配置
    distribution:
      percentiles-histogram:
        http.server.requests: true
        spring.data.repository.invocations: true
        hikaricp.connections: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
        spring.data.repository.invocations: 0.5,0.9,0.95,0.99
        hikaricp.connections: 0.5,0.9,0.95,0.99
      sla:
        http.server.requests: 10ms,50ms,100ms,200ms,500ms,1s,2s,5s
        spring.data.repository.invocations: 10ms,50ms,100ms,200ms,500ms,1s,2s,5s
        hikaricp.connections: 1ms,5ms,10ms,25ms,50ms,100ms,200ms

  # 信息端点配置
  info:
    # 显示应用信息
    env:
      enabled: true
    # 显示构建信息
    build:
      enabled: true
    # 显示Git信息
    git:
      mode: full
    # 显示Java信息
    java:
      enabled: true
    # 显示操作系统信息
    os:
      enabled: true

# 日志配置
logging:
  # 记录指标相关日志
  level:
    org.springframework.boot.actuate.metrics: INFO
    io.micrometer: INFO
    net.lab1024.sa.access.metrics: DEBUG

  # 指标日志输出
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"

# 业务自定义监控配置
access-service:
  monitoring:
    # 启用业务监控
    enabled: true
    # 监控收集间隔
    collection-interval: 30s
    # 性能数据保留时间
    retention-period: 7d
    # 监控数据导出
    export:
      # 导出到文件
      file:
        enabled: true
        path: ./metrics/
        format: json
      # 导出到外部系统
      external:
        enabled: false
        endpoint: http://metrics-collector:9090/metrics
        interval: 60s

    # 业务指标阈值配置
    thresholds:
      # 访问响应时间阈值（毫秒）
      access-response-time:
        warning: 500
        critical: 2000
      # 数据库查询时间阈值（毫秒）
      database-query-time:
        warning: 100
        critical: 1000
      # AI分析时间阈值（毫秒）
      ai-analysis-time:
        warning: 5000
        critical: 30000
      # 视频流延迟阈值（毫秒）
      video-stream-delay:
        warning: 1000
        critical: 5000
      # 设备连接失败率阈值（百分比）
      device-connection-failure-rate:
        warning: 5
        critical: 20
      # 内存使用率阈值（百分比）
      memory-usage:
        warning: 80
        critical: 95
      # CPU使用率阈值（百分比）
      cpu-usage:
        warning: 70
        critical: 90
      # 磁盘使用率阈值（百分比）
      disk-usage:
        warning: 85
        critical: 95

    # 监控告警配置
    alerts:
      # 启用自动告警
      enabled: true
      # 告警检查间隔
      check-interval: 60s
      # 告警收敛时间
      suppression-time: 5m
      # 告警级别
      levels:
        - INFO
        - WARN
        - ERROR
        - CRITICAL
      # 告警通知方式
      notifications:
        # 邮件通知
        email:
          enabled: true
          recipients:
            - admin@ioe-dream.com
            - ops@ioe-dream.com
        # 钉钉通知
        dingtalk:
          enabled: false
          webhook: https://oapi.dingtalk.com/robot/send?access_token=xxx
        # 企业微信通知
        wechat:
          enabled: false
          webhook: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

# 缓存监控配置
spring:
  cache:
    # 启用缓存监控
    metrics:
      enabled: true
      # 缓存命中率统计
      cache-statistics: true
      # 缓存监控间隔
      monitor-interval: 30s

  # Redis监控配置
  redis:
    # 启用Redis监控
    metrics:
      enabled: true
      # 连接池监控
      pool:
        enabled: true
        # 连接池使用率阈值
        usage-threshold: 80
      # 命令执行监控
      commands:
        enabled: true
        # 慢命令阈值（毫秒）
        slow-threshold: 100

# 数据库连接池监控配置
spring:
  datasource:
    druid:
      # 启用连接池监控
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        reset-enable: false
        login-username: admin
        login-password: admin123
        allow: 127.0.0.1,192.168.1.0/24
      # WebStatFilter配置
      web-stat-filter:
        enabled: true
        url-pattern: /*
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"
      # 监控指标配置
      metrics:
        enabled: true
        # 监控间隔
        monitor-interval: 30s
        # 慢SQL阈值
        slow-sql-millis: 1000
        # 记录慢SQL
        log-slow-sql: true

# 业务组件监控配置
access-service:
  components:
    # 蓝牙组件监控
    bluetooth:
      enabled: true
      # 设备连接监控
      connection:
        enabled: true
        # 连接超时阈值（秒）
        timeout-threshold: 30
        # 重连次数阈值
        retry-threshold: 3
      # 设备健康监控
      health:
        enabled: true
        # 健康检查间隔（秒）
        check-interval: 60
        # 健康评分阈值
        score-threshold: 70

    # AI分析组件监控
    ai:
      enabled: true
      # 模型性能监控
      model:
        enabled: true
        # 模型准确率阈值
        accuracy-threshold: 0.8
        # 模型响应时间阈值（毫秒）
        response-time-threshold: 5000
      # 分析结果监控
      analysis:
        enabled: true
        # 异常检测阈值
        anomaly-threshold: 0.7
        # 分析失败率阈值
        failure-rate-threshold: 5

    # 视频监控组件监控
    video:
      enabled: true
      # 流媒体监控
      streaming:
        enabled: true
        # 帧率阈值（fps）
        fps-threshold: 15
        # 延迟阈值（毫秒）
        delay-threshold: 2000
        # 丢帧率阈值（百分比）
        packet-loss-threshold: 5
      # 录像监控
      recording:
        enabled: true
        # 录像文件大小阈值（MB）
        file-size-threshold: 1000
        # 录像时长阈值（小时）
        duration-threshold: 24

    # 告警组件监控
    alert:
      enabled: true
      # 告警处理监控
      processing:
        enabled: true
        # 处理时间阈值（毫秒）
        response-time-threshold: 5000
        # 处理成功率阈值（百分比）
        success-rate-threshold: 95
      # 通知发送监控
      notification:
        enabled: true
        # 发送时间阈值（毫秒）
        send-time-threshold: 3000
        # 发送成功率阈值（百分比）
        delivery-rate-threshold: 90

# 监控数据导出配置
monitoring:
  export:
    # Prometheus抓取配置
    prometheus:
      enabled: true
      # 抓取间隔
      scrape-interval: 30s
      # 抓取超时
      scrape-timeout: 10s
      # 抓取路径
      metrics-path: /actuator/prometheus

    # Grafana仪表板配置
    grafana:
      enabled: false
      # 仪表板ID列表
      dashboard-ids:
        - access-service-overview
        - access-service-performance
        - access-service-business
        - access-service-infrastructure
      # 自动导入仪表板
      auto-import: true
      # 仪表板模板路径
      template-path: ./grafana/dashboards/

# 环境特定配置
---
spring:
  config:
    activate:
      on-profile: dev

management:
  endpoints:
    web:
      exposure:
        include: "*"
  metrics:
    export:
      jmx:
        enabled: true

---
spring:
  config:
    activate:
      on-profile: test

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  metrics:
    export:
      prometheus:
        enabled: false

---
spring:
  config:
    activate:
      on-profile: prod

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
        step: 15s

monitoring:
  alerts:
    notifications:
      dingtalk:
        enabled: true
        webhook: ${DINGTALK_WEBHOOK_URL}
      wechat:
        enabled: true
        webhook: ${WECHAT_WEBHOOK_URL}