# ============================================================
# IOE-DREAM OA Service Bootstrap 配置
#
# @Author:    IOE-DREAM Team
# @Date:      2025-12-09
# @Copyright:  IOE-DREAM智慧园区一卡通管理平台
#
# 服务信息:
# - 服务名称: ioedream-oa-service
# - 服务端口: 8089
# - 服务职责: OA办公微服务，提供流程审批、文档管理、工作流等功能
# ============================================================

# ==================== 应用基础配置 ====================
spring:
  application:
    name: ${SERVICE_NAME:ioedream-oa-service}

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # ==================== Nacos服务发现配置 ====================
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_SERVER_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:IOE-DREAM}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:ENC(I2//JcHFpBc7vLPrYnCJNA==)}
        enabled: true
        register-enabled: true
        # 服务注册元数据
        metadata:
          version: ${SERVICE_VERSION:1.0.0}
          zone: ${ZONE:dev}
          cluster: ${CLUSTER:default}
          environment: ${ENVIRONMENT:dev}
          workflow-engine: "Activiti7"
          document-storage: "MinIO"

      config:
        server-addr: ${NACOS_SERVER_ADDR:127.0.0.1:8848}
        namespace: ${NACOS_NAMESPACE:dev}
        group: ${NACOS_GROUP:IOE-DREAM}
        username: ${NACOS_USERNAME:nacos}
        password: ${NACOS_PASSWORD:ENC(I2//JcHFpBc7vLPrYnCJNA==)}
        file-extension: yaml
        enabled: ${NACOS_CONFIG_ENABLED:true}
        refresh-enabled: ${NACOS_CONFIG_REFRESH_ENABLED:true}
        # 配置文件导入顺序
        import-check:
          enabled: true
        # 共享配置 - 所有服务共享
        shared-configs:
          - data-id: common-database.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: common-redis.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: common-monitoring.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: common-security.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: workflow-engine-config.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
        # 扩展配置 - 服务特定配置
        extension-configs:
          - data-id: ioedream-oa-service-ext.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
          - data-id: ${spring.application.name}-${spring.profiles.active:dev}.yaml
            group: ${NACOS_GROUP:IOE-DREAM}
            refresh: true
  # ==================== 配置文件导入 ====================
  # 注意：Spring Cloud Alibaba 2025.0.0.0版本在config.import阶段无法解析占位符，需要直接指定dataId
  config:
    import:
      - "optional:nacos:${spring.application.name}.yaml"
      - "optional:nacos:${spring.application.name}-docker.yaml"
      - "optional:nacos:common-config.yaml"

# ==================== 加密配置 ====================
# 注意: 'jasypt' 是自定义配置属性，VS Code 警告可忽略
jasypt:
  encryptor:
    password: ${JASYPT_PASSWORD}
    algorithm: PBEWITHHMACSHA512ANDAES_256
    key-obtention-iterations: 1000
    pool-size: 1
    provider-name: SunJCE
    salt-generator-classname: org.jasypt.salt.RandomSaltGenerator
    string-output-type: base64
    iv-generator-classname: org.jasypt.iv.RandomIvGenerator
    property:
      prefix: ENC(
      suffix: )

# ==================== JVM配置 ====================
# 注意: 'java' 是自定义配置属性，VS Code 警告可忽略
java:
  opts:
    # 开发环境默认配置 (1GB堆内存)
    - "-server"
    - "-Xms${JVM_XMS:512m}"
    - "-Xmx${JVM_XMX:1g}"
    - "-XX:+UseG1GC"
    - "-XX:MaxGCPauseMillis=200"
    - "-XX:+UseStringDeduplication"
    - "-XX:MaxMetaspaceSize=${JVM_METASPACE:192m}"
    - "-XX:+HeapDumpOnOutOfMemoryError"
    - "-XX:HeapDumpPath=/var/log/ioedream/oa-service"
    - "-Dfile.encoding=UTF-8"
    - "-Duser.timezone=Asia/Shanghai"

# ==================== 日志配置启动参数 ====================
logging:
  config: classpath:logback-spring.xml
  level:
    root: INFO
    "[net.lab1024.sa.oa]": DEBUG
    "[org.activiti]": INFO
    "[org.springframework]": INFO

# ==================== OA服务特定配置 ====================
# 注意: 'oa' 是自定义业务配置属性，VS Code 警告可忽略
oa:
  workflow:
    # Activiti工作流引擎配置
    activiti:
      # 数据库配置
      database-schema-update: true
      database-type: mysql
      # 历史记录级别
      history-level: audit
      # 自动部署
      auto-deployment-enabled: false
      # 异步执行器
      async-executor-activate: true
      async-executor-core-pool-size: 5
      async-executor-max-pool-size: 20
      async-executor-queue-capacity: 100

    # 流程定义配置
    process-definition:
      deployment-path: ${OA_PROCESS_DEPLOYMENT_PATH:/opt/ioedream/oa/processes}
      auto-deploy: ${OA_PROCESS_AUTO_DEPLOY:false}
      watch-changes: ${OA_PROCESS_WATCH_CHANGES:true}

  document:
    # 文档管理配置
    storage:
      type: ${OA_STORAGE_TYPE:minio}
      endpoint: ${MINIO_ENDPOINT:http://localhost:9000}
      access-key: ${MINIO_ACCESS_KEY:minioadmin}
      secret-key: ${MINIO_SECRET_KEY:minioadmin}
      bucket-name: ${MINIO_BUCKET:ioedream-oa-documents}

    # 文件处理配置
    file-processing:
      max-file-size: ${OA_MAX_FILE_SIZE:100MB}
      allowed-extensions: ${OA_ALLOWED_EXTENSIONS:pdf,doc,docx,xls,xlsx,ppt,pptx,txt,jpg,jpeg,png,gif}
      thumbnail-enabled: ${OA_THUMBNAIL_ENABLED:true}
      thumbnail-size: ${OA_THUMBNAIL_SIZE:200x200}

    # 版本控制配置
    version-control:
      enabled: ${OA_VERSION_CONTROL_ENABLED:true}
      max-versions: ${OA_MAX_VERSIONS:10}
      auto-save-interval: ${OA_AUTO_SAVE_INTERVAL:300}  # 5分钟

  approval:
    # 审批流程配置
    timeout:
      default-approval-timeout: ${OA_DEFAULT_APPROVAL_TIMEOUT:86400000}  # 24小时
      reminder-interval: ${OA_REMINDER_INTERVAL:3600000}  # 1小时
      max-reminders: ${OA_MAX_REMINDERS:3}

    delegation:
      enabled: ${OA_DELEGATION_ENABLED:true}
      auto-approve-delegated: ${OA_AUTO_APPROVE_DELEGATED:false}
      delegation-expire-days: ${OA_DELEGATION_EXPIRE_DAYS:30}

  notification:
    # 通知配置
    channels:
      email:
        enabled: ${OA_EMAIL_NOTIFICATION_ENABLED:true}
        smtp-host: ${SMTP_HOST:smtp.example.com}
        smtp-port: ${SMTP_PORT:587}
        username: ${SMTP_USERNAME:}
        password: ${SMTP_PASSWORD:}

      sms:
        enabled: ${OA_SMS_NOTIFICATION_ENABLED:false}
        provider: ${SMS_PROVIDER:aliyun}
        access-key: ${SMS_ACCESS_KEY:}
        secret-key: ${SMS_SECRET_KEY:}

      system:
        enabled: ${OA_SYSTEM_NOTIFICATION_ENABLED:true}
        max-messages: ${OA_MAX_SYSTEM_MESSAGES:100}
