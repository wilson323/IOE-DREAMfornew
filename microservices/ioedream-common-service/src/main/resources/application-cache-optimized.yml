# =====================================================
# IOE-DREAM 三级缓存优化配置（修复版）
# L1本地缓存 + L2 Redis缓存 + L3网关调用缓存
# 企业级缓存性能优化和一致性保障
# =====================================================

# ===========================================
# 生产环境缓存配置
# ===========================================
spring:
  # ===========================================
  # Redis配置
  # ===========================================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
          time-between-eviction-runs: 10s
        cluster:
          refresh:
            adaptive: true
            timeout: 1000ms

  # ===========================================
  # 缓存配置
  # ===========================================
  cache:
    # 缓存类型
    type: redis
    # 缓存键前缀
    key-prefix: ioedream
    # 缓存时间（单位：秒）
    default-ttl: 1800  # 30分钟
    # 是否允许空值
    cache-null-values: false
    # 是否使用键前缀
    use-key-prefix: true

  # ===========================================
  # Caffeine本地缓存配置
  # ===========================================
  caffeine:
    spec: maximumSize=1000,expireAfterWrite=300s,recordStats
    cache-names: user,dict,menu,permission,config

# ===========================================
# 缓存管理配置
# ===========================================
cache:
  # ===========================================
  # 缓存预热配置
  # ===========================================
  warmup:
    enabled: true
    # 预热延迟（应用启动后）
    delay: 30s
    # 预热线程数
    thread-pool-size: 4
    # 预热任务超时时间
    timeout: 30s

  # 预热数据配置
  warmup-data:
    # 用户数据预热
    user:
      enabled: true
      loader: "userLoader"
      keys: ["activeUsers", "userPermissions", "userRoles"]

    # 字典数据预热
    dict:
      enabled: true
      loader: "dictLoader"
      keys: ["dictTypes", "dictData"]

    # 菜单数据预热
    menu:
      enabled: true
      loader: "menuLoader"
      keys: ["mainMenu", "userMenu", "adminMenu"]

  # ===========================================
  # 缓存监控配置
  # ===========================================
  monitoring:
    enabled: true
    # 统计信息收集间隔
    stats-interval: 60s
    # 缓存命中率告警阈值
    hit-rate-threshold: 0.8
    # 缓存大小告警阈值
    size-threshold: 0.9
    # 是否启用实时监控
    real-time: true

# ===========================================
# 监控端点配置
# ===========================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,caches
  endpoint:
    caches:
      enabled: true
    health:
      show-details: always

---
# ===========================================
# 开发环境配置
# ===========================================
spring:
  config:
    activate:
      on-profile: dev

  # 开发环境Redis配置
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      database: 0
      timeout: 3000ms

  # 开发环境缓存配置（较宽松）
  cache:
    default-ttl: 3600  # 1小时
    cache-null-values: true

  caffeine:
    spec: maximumSize=500,expireAfterWrite=180s,recordStats

---
# ===========================================
# 测试环境配置
# ===========================================
spring:
  config:
    activate:
      on-profile: test

  # 测试环境缓存配置
  cache:
    default-ttl: 1800  # 30分钟
    cache-null-values: false

  caffeine:
    spec: maximumSize=800,expireAfterWrite=300s,recordStats

---
# ===========================================
# 生产环境特定配置
# ===========================================
spring:
  config:
    activate:
      on-profile: prod

  # 生产环境Redis配置
  data:
    redis:
      host: ${REDIS_HOST:prod-redis-cluster}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:ENC(AES256:encrypted_prod_redis_password)}
      database: 0
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 5000ms
        cluster:
          refresh:
            adaptive: true
            timeout: 2000ms

  # 生产环境缓存配置（更严格）
  cache:
    default-ttl: 900   # 15分钟
    cache-null-values: false
    use-key-prefix: true

  caffeine:
    spec: maximumSize=2000,expireAfterWrite=600s,recordStats