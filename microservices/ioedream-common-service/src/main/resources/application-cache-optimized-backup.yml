# =====================================================
# IOE-DREAM 三级缓存优化配置
# L1本地缓存 + L2 Redis缓存 + L3网关调用缓存
# 企业级缓存性能优化和一致性保障
# =====================================================

spring:
  # ===========================================
  # Redis配置
  # ===========================================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
          time-between-eviction-runs: 10s
        cluster:
          refresh:
            adaptive: true
            timeout: 1000ms

  # ===========================================
  # 缓存配置
  # ===========================================
  cache:
    # 缓存类型
    type: redis
    # 缓存键前缀
    key-prefix: ioedream
    # 缓存时间（单位：秒）
    default-ttl: 1800  # 30分钟
    # 是否允许空值
    cache-null-values: false
    # 是否使用键前缀
    use-key-prefix: true

  # ===========================================
  # Caffeine本地缓存配置
  # ===========================================
  caffeine:
    spec: maximumSize=1000,expireAfterWrite=300s,recordStats
    cache-names: user,dict,menu,permission,config

# ===========================================
  # 业务模块特定缓存配置
  # ===========================================
---
spring:
  config:
    activate:
      on-profile: dev

  # 开发环境缓存配置（较宽松）
  cache:
    default-ttl: 3600  # 1小时
    caffeine:
      # 开发环境使用较小的缓存
      spec: maximumSize=500,expireAfterWrite=180s,recordStats

---
spring:
  config:
    activate:
      on-profile: test

  # 测试环境缓存配置
  cache:
    default-ttl: 1800  # 30分钟
    caffeine:
      spec: maximumSize=800,expireAfterWrite=300s,recordStats

---
spring:
  config:
    activate:
      on-profile: prod

  # 生产环境缓存配置（严格）
  cache:
    default-ttl: 1800  # 30分钟
    caffeine:
      spec: maximumSize=2000,expireAfterWrite=600s,recordStats

# ===========================================
  # 缓存预热配置
  # ===========================================
cache:
  # 预热开关
  warmup:
    enabled: true
    # 预热延迟（应用启动后）
    delay: 30s
    # 预热线程数
    thread-pool-size: 4
    # 预热任务超时时间
    timeout: 30s

  # 预热数据配置
  warmup-data:
    # 用户数据预热
    user:
      enabled: true
      loader: "userLoader"
      keys: ["activeUsers", "userPermissions", "userRoles"]

    # 字典数据预热
    dict:
      enabled: true
      loader: "dictLoader"
      keys: ["dictTypes", "dictData"]

    # 菜单数据预热
    menu:
      enabled: true
      loader: "menuLoader"
      keys: ["mainMenu", "userMenu", "adminMenu"]

# ===========================================
  # 缓存监控配置
  # ===========================================
cache:
  # 监控开关
  monitoring:
    enabled: true
    # 统计信息收集间隔
    stats-interval: 60s
    # 缓存命中率告警阈值
    hit-rate-threshold: 0.8
    # 缓存大小告警阈值
    size-threshold: 0.9
    # 是否启用实时监控
    real-time-monitoring: true

  # 告警配置
  alerts:
    # 缓存命中率低告警
    low-hit-rate:
      enabled: true
      threshold: 0.7
      message: "缓存命中率过低，请检查缓存策略"

    # 缓存大小使用率告警
    high-usage:
      enabled: true
      threshold: 0.85
      message: "缓存使用率过高，请考虑扩容"

    # 缓存雪崩告警
    cache-avalanche:
      enabled: true
      threshold: 100
      message: "检测到可能的缓存雪崩"

# ===========================================
  # 缓存一致性配置
  # ===========================================
cache:
  # 一致性策略
  consistency:
    # 更新策略：write-through（写入时同步更新）、write-behind（异步更新）、refresh-ahead（预刷新）
    strategy: write-through

    # 失效策略
    invalidation:
      # 主动失效开关
      enable-active-invalidation: true
      # 失效通知超时时间
      notification-timeout: 5s
      # 批量失效大小限制
      batch-size: 100

    # 分布式锁配置
    distributed-lock:
      enabled: true
      lock-timeout: 30s
      lease-time: 10s
      key-prefix: "ioedream:lock:"

  # 多级缓存同步
  multi-level:
    # L1 -> L2 同步延迟
    sync-delay-l1-to-l2: 100ms
    # L2 -> L1 同步延迟
    sync-delay-l2-to-l1: 50ms
    # 同步失败重试次数
    retry-count: 3
    # 同步重试间隔
    retry-interval: 1s

# ===========================================
  # Redis Cluster配置
  # ===========================================
spring:
  data:
    redis:
      cluster:
        # 集群节点配置
        nodes: ${REDIS_CLUSTER_NODES:}
        # 最大重定向次数
        max-redirects: 3
        # 连接超时时间
        timeout: 10s
        # 连接池配置
        lettuce:
          pool:
            max-active: 16
            max-idle: 8
            min-idle: 2
            max-wait: 5s

# ===========================================
  # JPA缓存配置
  # ===========================================
spring:
  jpa:
    properties:
      hibernate:
        # 二级缓存配置
        cache:
          use_second_level_cache: true
          factory_class: org.hibernate.cache.ehcache.EhCacheRegionFactory
          hibernate:
            cache:
              provider: ehcache

        # 查询缓存配置
        query:
          cache:
            use_query_cache: true
            use_second_level_cache: true

# ===========================================
  # MyBatis-Plus缓存配置
  # ===========================================
mybatis-plus:
  # 全局缓存配置
  global-config:
    # 启用二级缓存
    enable-cache: true
    # 缓存实现类
    cache-implementation: org.mybatis.caches.ehcache.EhcacheCacheManager
    # 缓存空对象
    cache-null-values: false
    # 查询缓存
    enable-query-cache: true

  configuration:
    # 本地缓存作用域
    local-cache-scope: statement
    # 二级缓存作用域
    cache-enabled: true
    # 缓存前状态检查
    cache-prep-stmts: true
    # 缓存后状态检查
    cache-check-stmts: true

# ===========================================
  # EHCache配置
  # ===========================================
ehcache:
  # 缓存管理器配置
  cache-manager:
    factory-class: org.springframework.cache.ehcache.EhCacheCacheManager
    # 共享缓存
    shared: true

  # 默认缓存配置
  cache:
    name: default
    max-elements-in-memory: 1000
    eternal: false
    time-to-live-seconds: 1800
    overflow-to-disk: false
    memory-store-eviction-policy: LRU

  # 用户缓存配置
  caches:
    userCache:
      max-elements-in-memory: 2000
      time-to-live-seconds: 3600
      eternal: false
      overflow-to-disk: false
      memory-store-eviction-policy: LFU

    dictCache:
      max-elements-in-memory: 5000
      time-to-live-seconds: 7200
      eternal: false
      overflow-to-disk: true
      memory-store-eviction-policy: LRU

# ===========================================
  # 缓存管理Endpoint
  # ===========================================
management:
  endpoints:
    web:
      exposure:
        include: cache,metrics,health
  endpoint:
    cache:
      enabled: true
    metrics:
      enabled: true

# ===========================================
  # 性能监控指标
  # ===========================================
management:
  metrics:
    cache:
      cache.gets: cache.misses, cache.hits
      cache.puts: cache.evictions
      cache.size: cache.max.size