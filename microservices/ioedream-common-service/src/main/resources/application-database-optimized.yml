# =====================================================
# IOE-DREAM 数据库性能优化配置
# 适用于Spring Boot 3.5.8 + MyBatis-Plus 3.5.15
# =====================================================

spring:
  # 数据源配置
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # ===========================================
      # 基础连接配置
      # ===========================================
      initial-size: 10
      min-idle: 10
      max-active: 50
      max-wait: 60000

      # ===========================================
      # 连接有效性检查配置
      # ===========================================
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false
      validation-query-timeout: 3

      # ===========================================
      # 连接回收配置
      # ===========================================
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      max-evictable-idle-time-millis: 900000

      # ===========================================
      # 预编译语句缓存配置
      # ===========================================
      pool-prepared-statements: true
      max-pool-prepared-statement-per-connection-size: 20
      max-open-prepared-statements: 100

      # ===========================================
      # 性能监控配置
      # ===========================================
      # 监控页面访问路径
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        reset-enable: false
        login-username: ${DRUID_ADMIN_USERNAME:admin}
        login-password: ${DRUID_ADMIN_PASSWORD}
        allow: ${DRUID_ALLOW_IPS:127.0.0.1,192.168.1.0/24}
        deny: ${DRUID_DENY_IPS:}

      # Web监控配置
      web-stat-filter:
        enabled: true
        url-pattern: /*
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*,/actuator/*"
        session-stat-enable: true
        session-stat-max-count: 1000
        principal-session-name: userInfo
        principal-cookie-name: userInfo
        profile-enable: true

      # ===========================================
      # 慢查询监控配置
      # ===========================================
      filter:
        stat:
          enabled: true
          db-type: mysql
          log-slow-sql: true
          slow-sql-millis: 1000
          merge-sql: true

        wall:
          enabled: true
          db-type: mysql
          config:
            # 允许的SQL操作
            multi-statement-allow: false
            delete-allow: true
            update-allow: true
            insert-allow: true
            select-allow: true
            # 禁止的SQL操作
            drop-table-allow: false
            create-table-allow: false
            alter-table-allow: false
            # 其他安全配置
            none-base-statement-allow: false
            truncate-allow: false
            create-procedure-allow: false
            execute-procedure-allow: false

        slf4j:
          enabled: true
          statement-create-after-log-enabled: false
          statement-close-after-log-enabled: false
          statement-parameter-set-log-enabled: false
          statement-parameter-clear-log-enabled: false
          statement-prepare-after-log-enabled: false
          statement-execute-after-log-enabled: false
          statement-execute-error-after-log-enabled: true
          statement-execute-batch-after-log-enabled: true
          result-set-open-after-log-enabled: false
          result-set-close-after-log-enabled: false

  # ===========================================
  # MyBatis-Plus配置
  # ===========================================
  mybatis-plus:
    # 全局配置
    global-config:
      # 数据库配置
      db-config:
        # 主键类型：AUTO为自增
        id-type: AUTO
        # 逻辑删除字段
        logic-delete-field: deletedFlag
        # 逻辑删除全局值（1表示已删除）
        logic-delete-value: 1
        # 逻辑未删除全局值（0表示未删除）
        logic-not-delete-value: 0
        # 字段填充策略
        insert-strategy: NOT_NULL
        update-strategy: NOT_NULL
        select-strategy: NOT_EMPTY

    # 配置类型别名包路径
    type-aliases-package: net.lab1024.sa.**.entity

    # 配置mapper xml文件路径
    mapper-locations: classpath*:mapper/**/*Mapper.xml

    configuration:
      # 开启驼峰命名转换
      map-underscore-to-camel-case: true
      # 开启缓存
      cache-enabled: true
      # 开启延迟加载
      lazy-loading-enabled: true
      # 设置超时时间
      default-statement-timeout: 30
      # 设置获取数据的策略，FIFO为先进先出
      default-executor-type: REUSE
      # 开启SQL执行日志（生产环境建议关闭）
      log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

# ===========================================
# 数据库连接字符串配置
# ===========================================
---
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    druid:
      url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:ioedream_dev}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true
      username: ${DB_USERNAME:root}
      password: ${DB_PASSWORD:123456}
      driver-class-name: com.mysql.cj.jdbc.Driver

---
spring:
  config:
    activate:
      on-profile: test

  datasource:
    druid:
      url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:ioedream_test}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true
      username: ${DB_USERNAME:root}
      password: ${DB_PASSWORD:123456}
      driver-class-name: com.mysql.cj.jdbc.Driver

---
spring:
  config:
    activate:
      on-profile: prod

  datasource:
    druid:
      url: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true
      username: ${DB_USERNAME}
      password: ${DB_PASSWORD}
      driver-class-name: com.mysql.cj.jdbc.Driver

  # ===========================================
  # 缓存配置
  # ===========================================
  cache:
    type: redis
    redis:
      time-to-live: 1800000 # 30分钟
      cache-null-values: false
      use-key-prefix: true
      key-prefix: "ioedream:cache:"
  # ===========================================
  # Redis配置
  # ===========================================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 3000
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms

# ===========================================
# 性能监控配置
# ===========================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,druid,db
  endpoint:
    health:
      show-details: always
    druid:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
  metrics:
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99

# ===========================================
# 日志配置
# ===========================================
logging:
  level:
    # Druid SQL日志
    druid.sql.Statement: DEBUG
    druid.sql.ResultSet: DEBUG
    # MyBatis SQL日志
    net.lab1024.sa.**.dao: DEBUG
    # 数据库连接池日志
    com.alibaba.druid: INFO
  pattern:
    # 控制台日志格式
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId:-}] %logger{36} - %msg%n"
    # 文件日志格式
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{traceId:-}] %logger{36} - %msg%n"

# ===========================================
# JVM性能优化配置
# ===========================================
server:
  # 服务器连接配置
  servlet:
    context-path: /
  # Tomcat连接器配置
  tomcat:
    # 最大连接数
    max-connections: 8192
    # 最大处理线程数
    threads:
      max: 200
      min-spare: 10
    # 连接超时时间
    connection-timeout: 20000
    # 最大处理队列长度
    accept-count: 100
