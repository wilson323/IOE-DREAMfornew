# ===================================================================
# IOE-DREAM ç”Ÿäº§ç¯å¢ƒå‘Šè­¦ç®¡ç†å™¨é…ç½®
# ç‰ˆæœ¬: v2.0.0
# æ›´æ–°æ—¶é—´: 2025-11-29
# ===================================================================

# å…¨å±€é…ç½®
global:
  # SMTPé‚®ä»¶æœåŠ¡å™¨é…ç½®
  smtp_smarthost: 'smtp.exmail.qq.com:587'
  smtp_from: 'alert@ioedream.com'
  smtp_auth_username: 'alert@ioedream.com'
  smtp_auth_password: 'your-email-password'  # è¯·æ›¿æ¢ä¸ºå®é™…å¯†ç 

  # ä¼ä¸šå¾®ä¿¡æœºå™¨äººé…ç½®
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-wechat-key'  # è¯·æ›¿æ¢ä¸ºå®é™…key

  # é’‰é’‰æœºå™¨äººé…ç½®
  dingtalk_api_url: 'https://oapi.dingtalk.com/robot/send?access_token=your-dingtalk-token'  # è¯·æ›¿æ¢ä¸ºå®é™…token

  # å…¨å±€é»˜è®¤é…ç½®
  resolve_timeout: 5m        # å‘Šè­¦æ¢å¤ç­‰å¾…æ—¶é—´
  http_config:
    timeout: 10s

# è·¯ç”±é…ç½® - å‘Šè­¦åˆ†å‘ç­–ç•¥
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s          # ç­‰å¾…æ—¶é—´
  group_interval: 10s      # åˆ†ç»„é—´éš”
  repeat_interval: 1h      # é‡å¤é—´éš”
  receiver: 'default'      # é»˜è®¤æ¥æ”¶å™¨

  # è·¯ç”±è§„åˆ™
  routes:
    # ä¸¥é‡å‘Šè­¦ - ç«‹å³å‘é€å¤šæ¸ é“é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      routes:
        # åŸºç¡€è®¾æ–½ä¸¥é‡å‘Šè­¦
        - match:
            category: infrastructure
          receiver: 'infrastructure-critical'
        # å¾®æœåŠ¡ä¸¥é‡å‘Šè­¦
        - match:
            category: microservice
          receiver: 'microservice-critical'
        # æ•°æ®åº“ä¸¥é‡å‘Šè­¦
        - match:
            category: database
          receiver: 'database-critical'

    # è­¦å‘Šçº§åˆ«å‘Šè­¦
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 30m
      routes:
        # JVMè­¦å‘Šå‘Šè­¦
        - match:
            category: jvm
          receiver: 'jvm-warnings'
        # ä¸šåŠ¡è­¦å‘Šå‘Šè­¦
        - match:
            category: business
          receiver: 'business-warnings'

    # ä¿¡æ¯çº§åˆ«å‘Šè­¦
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 2m
      repeat_interval: 4h

    # å®‰å…¨å‘Šè­¦ - ç‰¹æ®Šå¤„ç†
    - match:
        category: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 15m

# æ¥æ”¶å™¨é…ç½® - å‘Šè­¦é€šçŸ¥æ–¹å¼
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: 'admin@ioedream.com'
        subject: '[IOE-DREAM] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å‘Šè­¦åˆ†ç±»: {{ .Labels.category }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .EndsAt }}ç»“æŸæ—¶é—´: {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
          æ ‡ç­¾ä¿¡æ¯:
          {{ range .Labels.SortedPairs }}  - {{ .Name }}: {{ .Value }}
          {{ end }}
          ---
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨ - å¤šæ¸ é“é€šçŸ¥
  - name: 'critical-alerts'
    email_configs:
      - to: ['admin@ioedream.com', 'ops-team@ioedream.com', 'dev-team@ioedream.com']
        subject: '[CRITICAL] IOE-DREAM ç³»ç»Ÿä¸¥é‡å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦ ğŸš¨

          å‘Šè­¦åç§°: {{ .GroupLabels.alertname }}
          å‘Šè­¦çº§åˆ«: CRITICAL

          è¯¦ç»†ä¿¡æ¯:
          {{ range .Alerts }}
          - æè¿°: {{ .Annotations.description }}
          - å®ä¾‹: {{ .Labels.instance }}
          - æœåŠ¡: {{ .Labels.service }}
          - å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

          è¯·ç«‹å³å¤„ç†æ­¤ä¸¥é‡å‘Šè­¦ï¼
    wechat_configs:
      - corp_id: 'your-corp-id'
        agent_id: 'your-agent-id'
        api_secret: 'your-api-secret'
        to_user: '@all'
        message: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦ ğŸš¨

          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
    dingtalk_configs:
      - webhook_url: 'https://oapi.dingtalk.com/robot/send?access_token=your-dingtalk-token'
        message_type: 'markdown'
        title: 'IOE-DREAM ä¸¥é‡å‘Šè­¦'
        text: |
          ## ğŸš¨ ä¸¥é‡å‘Šè­¦

          {{ range .Alerts }}
          **å‘Šè­¦åç§°**: {{ .Annotations.summary }}
          **å‘Šè­¦æè¿°**: {{ .Annotations.description }}
          **å‘Šè­¦å®ä¾‹**: {{ .Labels.instance }}
          **å¼€å§‹æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ---
          {{ end }}

          è¯·ç«‹å³å¤„ç†ï¼

  # åŸºç¡€è®¾æ–½ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'infrastructure-critical'
    email_configs:
      - to: 'ops-team@ioedream.com'
        subject: '[CRITICAL][åŸºç¡€è®¾æ–½] {{ .GroupLabels.alertname }}'
    wechat_configs:
      - corp_id: 'your-corp-id'
        agent_id: 'your-agent-id'
        api_secret: 'your-api-secret'
        to_user: 'ops-team'

  # å¾®æœåŠ¡ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'microservice-critical'
    email_configs:
      - to: ['dev-team@ioedream.com', 'ops-team@ioedream.com']
        subject: '[CRITICAL][å¾®æœåŠ¡] {{ .GroupLabels.alertname }}'
    wechat_configs:
      - corp_id: 'your-corp-id'
        agent_id: 'your-agent-id'
        api_secret: 'your-api-secret'
        to_user: 'dev-team'

  # æ•°æ®åº“ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'database-critical'
    email_configs:
      - to: ['dba-team@ioedream.com', 'ops-team@ioedream.com']
        subject: '[CRITICAL][æ•°æ®åº“] {{ .GroupLabels.alertname }}'
    wechat_configs:
      - corp_id: 'your-corp-id'
        agent_id: 'your-agent-id'
        api_secret: 'your-api-secret'
        to_user: 'dba-team'

  # è­¦å‘Šçº§åˆ«å‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning-alerts'
    email_configs:
      - to: 'ops-team@ioedream.com'
        subject: '[WARNING] IOE-DREAM ç³»ç»Ÿå‘Šè­¦ - {{ .GroupLabels.alertname }}'
    wechat_configs:
      - corp_id: 'your-corp-id'
        agent_id: 'your-agent-id'
        api_secret: 'your-api-secret'
        to_user: 'ops-team'

  # JVMè­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'jvm-warnings'
    email_configs:
      - to: 'dev-team@ioedream.com'
        subject: '[WARNING][JVM] {{ .GroupLabels.alertname }}'

  # ä¸šåŠ¡è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
  - name: 'business-warnings'
    email_configs:
      - to: ['product-team@ioedream.com', 'ops-team@ioedream.com']
        subject: '[WARNING][ä¸šåŠ¡] {{ .GroupLabels.alertname }}'

  # ä¿¡æ¯çº§åˆ«å‘Šè­¦æ¥æ”¶å™¨
  - name: 'info-alerts'
    email_configs:
      - to: 'ops-team@ioedream.com'
        subject: '[INFO] IOE-DREAM ç³»ç»Ÿä¿¡æ¯ - {{ .GroupLabels.alertname }}'

  # å®‰å…¨å‘Šè­¦æ¥æ”¶å™¨
  - name: 'security-alerts'
    email_configs:
      - to: ['security-team@ioedream.com', 'admin@ioedream.com']
        subject: '[SECURITY] IOE-DREAM å®‰å…¨å‘Šè­¦ - {{ .GroupLabels.alertname }}'
    wechat_configs:
      - corp_id: 'your-corp-id'
        agent_id: 'your-agent-id'
        api_secret: 'your-api-secret'
        to_user: 'security-team'

# æŠ‘åˆ¶è§„åˆ™ - é¿å…å‘Šè­¦é£æš´
inhibit_rules:
  # å¦‚æœæœåŠ¡å™¨å®•æœºï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡å™¨ä¸Šçš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: InstanceDown
      severity: critical
    target_match_re:
      instance: (.+)
    equal: ['instance']

  # å¦‚æœå¾®æœåŠ¡ä¸å¯ç”¨ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„æ€§èƒ½å‘Šè­¦
  - source_match:
      alertname: MicroserviceDown
    target_match_re:
      service: (.+)
    equal: ['service']

  # å¦‚æœCPUè¿‡é«˜ï¼ŒæŠ‘åˆ¶å†…å­˜å’Œç£ç›˜å‘Šè­¦
  - source_match:
      alertname: HighCpuUsage
      severity: critical
    target_match:
      category: infrastructure
    equal: ['instance']

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'