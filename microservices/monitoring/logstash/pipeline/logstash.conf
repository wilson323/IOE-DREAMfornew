# ===================================================================
# IOE-DREAM 微服务日志收集管道配置
# 版本: v2.0.0
# 更新时间: 2025-11-29
# ===================================================================

input {
  # Beats输入 - 接收来自Filebeat的日志
  beats {
    port => 5044
  }

  # TCP输入 - 接收应用直接发送的日志
  tcp {
    port => 5000
    codec => json_lines
  }

  # UDP输入 - 接收应用直接发送的日志
  udp {
    port => 5001
    codec => json
  }

  # HTTP输入 - 接收REST API发送的日志
  http {
    port => 8080
    codec => json
  }
}

filter {
  # 添加处理时间戳
  mutate {
    add_field => { "[@metadata][processed_at]" => "%{+yyyy-MM-dd'T'HH:mm:ss.SSSZ}" }
  }

  # 解析JSON格式日志
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # 解析Spring Boot应用日志格式
  if [message] =~ /^\d{4}-\d{2}-\d{2}/ {
    grok {
      match => {
        "message" => "%{TIMESTAMP_ISO8601:log_timestamp}\s+%{LOGLEVEL:log_level}\s+%{NUMBER:pid}\s+---\s+\[%{DATA:thread_name}\]\s+%{DATA:logger_name}\s*:\s*(?<log_message>.*)"
      }
    }

    # 转换时间戳
    if [log_timestamp] {
      date {
        match => [ "log_timestamp", "yyyy-MM-dd HH:mm:ss.SSS", "yyyy-MM-dd HH:mm:ss,SSS" ]
        target => "@timestamp"
      }
    }
  }

  # 解析Nginx访问日志格式
  if [fields][service] == "nginx" {
    grok {
      match => {
        "message" => "%{COMBINEDAPACHELOG}"
      }
    }

    # 解析IP地理位置 (可选)
    if [clientip] {
      geoip {
        source => "clientip"
        target => "geoip"
      }
    }

    # 解析User-Agent
    if [agent] {
      useragent {
        source => "agent"
        target => "user_agent"
      }
    }
  }

  # 解析微服务日志标签
  if [fields][service] {
    mutate {
      add_field => { "service_name" => "%{[fields][service]}" }
    }
  }

  if [fields][environment] {
    mutate {
      add_field => { "environment" => "%{[fields][environment]}" }
    }
  }

  if [fields][version] {
    mutate {
      add_field => { "service_version" => "%{[fields][version]}" }
    }
  }

  # 解析异常堆栈信息
  if [log_level] == "ERROR" and [log_message] =~ /Exception/ {
    multiline {
      pattern => "^\s+at\s+"
      what => "previous"
      negate => true
      max_lines => 50
    }
  }

  # 添加业务标签
  if [service_name] == "ioedream-auth-service" {
    mutate {
      add_field => { "business_module" => "authentication" }
    }
  } else if [service_name] == "ioedream-access-service" {
    mutate {
      add_field => { "business_module" => "access_control" }
    }
  } else if [service_name] == "ioedream-consume-service" {
    mutate {
      add_field => { "business_module" => "consumption" }
    }
  } else if [service_name] == "ioedream-attendance-service" {
    mutate {
      add_field => { "business_module" => "attendance" }
    }
  } else if [service_name] == "ioedream-video-service" {
    mutate {
      add_field => { "business_module" => "video_surveillance" }
    }
  }

  # 解析用户信息
  if [log_message] =~ /user_id[:\s=]+(\d+)/ {
    grok {
      match => {
        "log_message" => ".*user_id[:\s=]+(?<user_id>\d+).*"
      }
    }
  }

  # 解析请求ID
  if [log_message] =~ /request_id[:\s=]+([a-zA-Z0-9-]+)/ {
    grok {
      match => {
        "log_message" => ".*request_id[:\s=]+(?<request_id>[a-zA-Z0-9-]+).*"
      }
    }
  }

  # 清理字段
  mutate {
    remove_field => [ "host", "agent", "ecs", "input", "log" ]
  }

  # 字段类型转换
  if [pid] {
    mutate {
      convert => { "pid" => "integer" }
    }
  }

  if [user_id] {
    mutate {
      convert => { "user_id" => "integer" }
    }
  }
}

output {
  # 主输出到Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ioedream-logs-%{+YYYY.MM.dd}"
    template_name => "ioedream-log-template"
    template_pattern => "ioedream-*"

    # 根据业务模块创建不同的索引
    if [business_module] {
      index => "ioedream-%{business_module}-logs-%{+YYYY.MM.dd}"
    }

    # 根据环境创建不同的索引
    if [environment] == "production" {
      index => "ioedream-prod-logs-%{+YYYY.MM.dd}"
    } else if [environment] == "staging" {
      index => "ioedream-staging-logs-%{+YYYY.MM.dd}"
    }
  }

  # 错误日志单独输出
  if [log_level] == "ERROR" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "ioedream-error-logs-%{+YYYY.MM.dd}"
    }
  }

  # 审计日志单独输出
  if [log_message] =~ /AUDIT|SECURITY/ {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "ioedream-audit-logs-%{+YYYY.MM.dd}"
    }
  }

  # 输出到标准输出 (调试用)
  stdout {
    codec => rubydebug
  }
}