# ç¼–è¯‘é”™è¯¯ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-01-30
**ä¸¥é‡çº§åˆ«**: ğŸ”´ P0 - é˜»å¡ç¼–è¯‘
**å½±å“èŒƒå›´**: æ‰€æœ‰å¾®æœåŠ¡æ¨¡å—

---

## ğŸš¨ é—®é¢˜è¯Šæ–­

### æ ¹æœ¬åŸå› åˆ†æ

**æ ¸å¿ƒé—®é¢˜**: å¤šä¸ªå±‚é¢çš„ä¾èµ–å’Œé…ç½®é—®é¢˜å¯¼è‡´å¤§é‡ç¼–è¯‘é”™è¯¯ï¼š

1. **@Transactionalæ³¨è§£é”™è¯¯**ï¼šä½¿ç”¨äº†`jakarta.transaction.Transactional`ï¼Œä¸æ”¯æŒ`readOnly`å’Œ`rollbackFor`å±æ€§
2. **Spring Cloud Gatewayç‰ˆæœ¬ç¼ºå¤±**ï¼šçˆ¶POMç¼ºå°‘Spring Cloud BOMç®¡ç†
3. **UnifiedCacheManageræ–¹æ³•ç¼ºå¤±**ï¼šç¼ºå°‘`getWithRefresh`å’Œ`evict`æ–¹æ³•
4. **Quartzä¾èµ–ç¼ºå¤±**ï¼šmicroservices-commonç¼ºå°‘Quartzä¾èµ–
5. **æ”¯ä»˜å®/å¾®ä¿¡SDKç‰ˆæœ¬é”™è¯¯**ï¼šä½¿ç”¨äº†ä¸å­˜åœ¨çš„ç‰ˆæœ¬å·
6. **å®ä½“ç±»ç¼ºå¤±**ï¼šå¤šä¸ªå®ä½“ç±»ä¸å­˜åœ¨äºmicroservices-commonä¸­

---

## âœ… å·²ä¿®å¤é—®é¢˜

### 1. @Transactionalæ³¨è§£ä¿®å¤ âœ…

**é—®é¢˜**: ä½¿ç”¨äº†`jakarta.transaction.Transactional`ï¼Œä¸æ”¯æŒSpringäº‹åŠ¡å±æ€§

**ä¿®å¤**:
- âœ… `NotificationConfigDao.java` - æ”¹ä¸º`org.springframework.transaction.annotation.Transactional`
- âœ… `NotificationTemplateDao.java` - æ”¹ä¸º`org.springframework.transaction.annotation.Transactional`

**ä¿®å¤æ–‡ä»¶**:
- `microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationConfigDao.java`
- `microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationTemplateDao.java`

### 2. Spring Cloud BOMè¡¥å…… âœ…

**é—®é¢˜**: GatewayæœåŠ¡ç¼ºå°‘ç‰ˆæœ¬ç®¡ç†ï¼Œå¯¼è‡´`spring-cloud-starter-gateway`ç‰ˆæœ¬ä¸ºç©º

**ä¿®å¤**: åœ¨çˆ¶POMä¸­æ·»åŠ Spring Cloud BOM

```xml
<!-- Spring Cloud BOMï¼ˆç»Ÿä¸€ç®¡ç†Spring Cloudä¾èµ–ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬Gatewayï¼‰ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-dependencies</artifactId>
    <version>${spring-cloud.version}</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```

**ä¿®å¤æ–‡ä»¶**: `microservices/pom.xml`

### 3. UnifiedCacheManageræ–¹æ³•è¡¥å…… âœ…

**é—®é¢˜**: ä»£ç ä¸­è°ƒç”¨äº†`getWithRefresh`å’Œ`evict`æ–¹æ³•ï¼Œä½†ç±»ä¸­ä¸å­˜åœ¨

**ä¿®å¤**: æ·»åŠ äº†ä¸¤ä¸ªç¼ºå¤±çš„æ–¹æ³•

```java
/**
 * è·å–ç¼“å­˜å€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ·æ–°
 */
public <T> T getWithRefresh(String key, Supplier<T> loader, Long ttl) {
    // å®ç°å¤šçº§ç¼“å­˜ç­–ç•¥
}

/**
 * åˆ é™¤ç¼“å­˜é”®ï¼ˆç®€åŒ–æ–¹æ³•ï¼‰
 */
public boolean evict(String key) {
    // åˆ é™¤L1å’ŒL2ç¼“å­˜
}
```

**ä¿®å¤æ–‡ä»¶**: `microservices/microservices-common/src/main/java/net/lab1024/sa/common/cache/UnifiedCacheManager.java`

### 4. Quartzä¾èµ–è¡¥å…… âœ…

**é—®é¢˜**: `GenericJob.java`ä½¿ç”¨äº†Quartzç±»ï¼Œä½†ç¼ºå°‘ä¾èµ–

**ä¿®å¤**: åœ¨microservices-commonçš„POMä¸­æ·»åŠ Quartzä¾èµ–

```xml
<!-- Quartz (ä»»åŠ¡è°ƒåº¦) -->
<dependency>
    <groupId>org.quartz-scheduler</groupId>
    <artifactId>quartz</artifactId>
</dependency>
```

**ä¿®å¤æ–‡ä»¶**: `microservices/microservices-common/pom.xml`

### 5. æ”¯ä»˜å®/å¾®ä¿¡SDKç‰ˆæœ¬ä¿®å¤ âœ…

**é—®é¢˜**: ä½¿ç”¨äº†ä¸å­˜åœ¨çš„ç‰ˆæœ¬å·

**ä¿®å¤**: ä½¿ç”¨Maven ToolsæŸ¥è¯¢åˆ°çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬

- æ”¯ä»˜å®SDK: `4.40.572.ALL` (åŸ: 4.41.46.ALL)
- å¾®ä¿¡æ”¯ä»˜SDK: `0.2.17` (åŸ: 0.2.22)

**ä¿®å¤æ–‡ä»¶**: `microservices/ioedream-consume-service/pom.xml`

---

## âœ… å®ä½“ç±»åˆ›å»ºå®Œæˆ

### 1. å®ä½“ç±»åˆ›å»º âœ…

**å·²åˆ›å»ºå®ä½“ç±»**:

- âœ… `net.lab1024.sa.common.organization.entity.AreaEntity` - åŒºåŸŸå®ä½“ç±»
- âœ… `net.lab1024.sa.common.organization.entity.AreaPersonEntity` - äººå‘˜åŒºåŸŸå…³è”å®ä½“ç±»
- âœ… `net.lab1024.sa.common.access.entity.ApprovalProcessEntity` - å®¡æ‰¹æµç¨‹å®ä½“ç±»
- âœ… `net.lab1024.sa.common.access.entity.AreaAccessExtEntity` - åŒºåŸŸé—¨ç¦æ‰©å±•å®ä½“ç±»

**åˆ›å»ºæ–‡ä»¶**:
- `microservices/microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/AreaEntity.java`
- `microservices/microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/AreaPersonEntity.java`
- `microservices/microservices-common/src/main/java/net/lab1024/sa/common/access/entity/ApprovalProcessEntity.java`
- `microservices/microservices-common/src/main/java/net/lab1024/sa/common/access/entity/AreaAccessExtEntity.java`

**æ³¨æ„**: å®ä½“ç±»çš„è¡¨åå’Œå­—æ®µæ˜ å°„åŸºäºDAOä¸­çš„SQLè¯­å¥æ¨æ–­ï¼Œå¯èƒ½éœ€è¦æ ¹æ®å®é™…æ•°æ®åº“è¡¨ç»“æ„è°ƒæ•´

### 2. Controllerå’ŒServiceç±»ç¼ºå¤± ğŸ”´ P0

**é—®é¢˜**: æµ‹è¯•æ–‡ä»¶ä¸­å¼•ç”¨çš„Controllerå’ŒServiceç±»ä¸å­˜åœ¨

- `AccessMobileController`
- `AccessDeviceService`
- `AccessEventService`
- `AdvancedAccessControlService`

**å½±å“æ–‡ä»¶**:
- `ioedream-access-service/src/test/java/net/lab1024/sa/access/controller/AccessMobileControllerTest.java`
- `ioedream-access-service/src/test/java/net/lab1024/sa/access/integration/AccessMobileIntegrationTest.java`

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥è¿™äº›ç±»æ˜¯å¦åº”è¯¥å­˜åœ¨
2. å¦‚æœåº”è¯¥å­˜åœ¨ï¼Œåˆ›å»ºè¿™äº›ç±»
3. å¦‚æœä¸åº”è¯¥å­˜åœ¨ï¼Œä¿®æ”¹æµ‹è¯•æ–‡ä»¶å¼•ç”¨æ­£ç¡®çš„ç±»

### 3. Request/Responseç±»ç¼ºå¤± ğŸ”´ P0

**é—®é¢˜**: æµ‹è¯•æ–‡ä»¶ä¸­å¼•ç”¨çš„Requestç±»ä¸å­˜åœ¨

- `MobileAccessCheckRequest`
- `QRCodeVerifyRequest`
- `NFCVerifyRequest`
- `BiometricVerifyRequest`
- `GpsPunchRequest`
- `LocationValidationRequest`
- `OfflinePunchData`
- `OfflinePunchRequest`

**å½±å“æ–‡ä»¶**:
- å¤šä¸ªæµ‹è¯•æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥è¿™äº›ç±»æ˜¯å¦åº”è¯¥å­˜åœ¨äºdomainåŒ…ä¸­
2. å¦‚æœåº”è¯¥å­˜åœ¨ï¼Œåˆ›å»ºè¿™äº›ç±»
3. å¦‚æœä¸åº”è¯¥å­˜åœ¨ï¼Œä¿®æ”¹æµ‹è¯•æ–‡ä»¶

### 4. Mockitoæ³›å‹ç±»å‹é—®é¢˜ âš ï¸ P1

**é—®é¢˜**: Mockitoçš„`thenReturn`æ–¹æ³•å­˜åœ¨æ³›å‹ç±»å‹ä¸åŒ¹é…

**å½±å“æ–‡ä»¶**:
- `ioedream-visitor-service/src/test/java/net/lab1024/sa/visitor/controller/VisitorMobileControllerTest.java`

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨`@SuppressWarnings("unchecked")`æˆ–æ˜¾å¼ç±»å‹è½¬æ¢

---

## ğŸ“‹ ä¿®å¤ç»Ÿè®¡

| ä¿®å¤é¡¹ | çŠ¶æ€ | æ–‡ä»¶æ•° |
|--------|------|--------|
| **@Transactionalæ³¨è§£ä¿®å¤** | âœ… å®Œæˆ | 2 |
| **Spring Cloud BOMè¡¥å……** | âœ… å®Œæˆ | 1 |
| **UnifiedCacheManageræ–¹æ³•è¡¥å……** | âœ… å®Œæˆ | 1 |
| **Quartzä¾èµ–è¡¥å……** | âœ… å®Œæˆ | 1 |
| **æ”¯ä»˜å®/å¾®ä¿¡SDKç‰ˆæœ¬ä¿®å¤** | âœ… å®Œæˆ | 1 |
| **å®ä½“ç±»åˆ›å»º** | âœ… å®Œæˆ | 4 |
| **Controller/Serviceç±»åˆ›å»º** | â³ å¾…å¤„ç† | 4+ |
| **Request/Responseç±»åˆ›å»º** | â³ å¾…å¤„ç† | 8+ |

---

## ğŸ”§ ä¸‹ä¸€æ­¥æ“ä½œ

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰

1. âœ… **åˆ›å»ºç¼ºå¤±çš„å®ä½“ç±»** - **å·²å®Œæˆ**
   - âœ… `AreaEntity`å’Œ`AreaPersonEntity`å·²åˆ›å»º
   - âœ… `ApprovalProcessEntity`å’Œ`AreaAccessExtEntity`å·²åˆ›å»º

2. **åˆ›å»ºç¼ºå¤±çš„Controllerå’ŒService** - **å¾…å¤„ç†**
   - åœ¨`ioedream-access-service`ä¸­åˆ›å»ºç›¸åº”çš„Controllerå’ŒServiceç±»
   - è¿™äº›ç±»åº”è¯¥åœ¨ä¸šåŠ¡æœåŠ¡ä¸­ï¼Œè€Œä¸æ˜¯commonæ¨¡å—ä¸­

3. **åˆ›å»ºç¼ºå¤±çš„Request/Responseç±»** - **å¾…å¤„ç†**
   - åœ¨ç›¸åº”çš„domainåŒ…ä¸­åˆ›å»ºRequestå’ŒResponseç±»
   - è¿™äº›ç±»åº”è¯¥åœ¨ä¸šåŠ¡æœåŠ¡çš„domainåŒ…ä¸­

### éªŒè¯æ­¥éª¤

1. **IDEé‡æ–°å¯¼å…¥é¡¹ç›®**
   - å³é”®ç‚¹å‡»`microservices/pom.xml`
   - é€‰æ‹© "Maven" â†’ "Reload Project"

2. **æ‰§è¡ŒMavenæ„å»º**
   ```bash
   cd D:\IOE-DREAM\microservices
   mvn clean install -DskipTests
   ```

3. **æ£€æŸ¥ç¼–è¯‘é”™è¯¯**
   - æ‰“å¼€IDEçš„ "Problems" è§†å›¾
   - ç¡®è®¤é”™è¯¯æ˜¯å¦å·²è§£å†³

---

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

### å·²ä¿®å¤æ–‡ä»¶
1. `microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationConfigDao.java`
2. `microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationTemplateDao.java`
3. `microservices/pom.xml`
4. `microservices/microservices-common/src/main/java/net/lab1024/sa/common/cache/UnifiedCacheManager.java`
5. `microservices/microservices-common/pom.xml`
6. `microservices/ioedream-consume-service/pom.xml`

### å·²åˆ›å»ºæ–‡ä»¶
1. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/AreaEntity.java`
2. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/AreaPersonEntity.java`
3. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/access/entity/ApprovalProcessEntity.java`
4. âœ… `microservices/microservices-common/src/main/java/net/lab1024/sa/common/access/entity/AreaAccessExtEntity.java`

### å¾…åˆ›å»ºæ–‡ä»¶ï¼ˆä¸šåŠ¡ç±»ï¼‰
1. `ioedream-access-service`ä¸­çš„Controllerã€Serviceã€Requestç±»
2. `ioedream-attendance-service`ä¸­çš„Requestç±»

---

**ä¿®å¤æ‰§è¡Œäºº**: IOE-DREAM æ¶æ„å›¢é˜Ÿ
**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-30
**ä¸‹ä¸€æ­¥**: åˆ›å»ºç¼ºå¤±çš„å®ä½“ç±»å’Œä¸šåŠ¡ç±»
