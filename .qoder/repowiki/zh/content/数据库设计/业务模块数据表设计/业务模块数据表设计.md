# 业务模块数据表设计

<cite>
**本文档引用的文件**  
- [10-t_audit_log.sql](file://database-scripts/common-service/10-t_audit_log.sql)
- [11-t_common_audit_archive.sql](file://database-scripts/common-service/11-t_common_audit_archive.sql)
- [11-t_alert.sql](file://database-scripts/common-service/11-t_alert.sql)
- [12-t_alert_rule.sql](file://database-scripts/common-service/12-t_alert_rule.sql)
- [13-t_system_monitor.sql](file://database-scripts/common-service/13-t_system_monitor.sql)
- [14-t_scheduled_job.sql](file://database-scripts/common-service/14-t_scheduled_job.sql)
- [15-t_job_execution_log.sql](file://database-scripts/common-service/15-t_job_execution_log.sql)
- [logistics-tables.sql](file://database-scripts/visitor/logistics-tables.sql)
- [AUDIT_MIGRATION_FINAL_SUMMARY.md](file://documentation/archive/reports-2025-12-04/AUDIT_MIGRATION_FINAL_SUMMARY.md)
- [ALERT_RULE_IMPLEMENTATION_SUMMARY.md](file://microservices/microservices-common/docs/ALERT_RULE_IMPLEMENTATION_SUMMARY.md)
- [database_dictionary.md](file://documentation/03-业务模块/访客/database_dictionary.md)
</cite>

## 目录
1. [引言](#引言)
2. [审计日志模块](#审计日志模块)
3. [告警系统模块](#告警系统模块)
4. [定时任务模块](#定时任务模块)
5. [访客物流模块](#访客物流模块)
6. [微服务协同工作分析](#微服务协同工作分析)
7. [系统监控与业务追踪作用](#系统监控与业务追踪作用)
8. [结论](#结论)

## 引言
本文档详细说明IoE-DREAM项目中各业务模块的数据表设计，重点分析审计日志、告警系统、定时任务和访客物流模块。文档将深入解析t_audit_log的审计数据结构、t_alert和t_alert_rule的告警规则引擎设计、t_scheduled_job与t_job_execution_log的作业调度模型，以及访客模块logistics-tables.sql中的表结构及其业务流程支撑。同时，文档将解释这些表如何与对应的微服务（如common-service、visitor-service）协同工作，并阐明其在系统监控和业务追踪中的关键作用。

## 审计日志模块

### t_audit_log表结构分析
t_audit_log表是系统审计日志的核心存储表，用于记录所有关键操作的审计信息。该表设计全面，涵盖了操作的各个方面，包括操作主体、操作内容、操作结果和环境信息。

**核心字段说明**：
- **log_id**: 日志唯一标识，自增主键
- **user_id/user_name**: 操作用户信息，支持用户行为追踪
- **module_name/operation_type**: 操作的模块和类型，支持按功能维度分类
- **request_url/request_params**: 完整的请求信息，便于问题复现
- **result_status/error_message**: 操作结果和错误详情，支持故障排查
- **risk_level**: 风险等级评估，支持安全审计
- **trace_id**: 分布式追踪ID，支持跨服务调用链路追踪

该表通过多维度索引（用户ID、模块名称、操作类型、风险等级、创建时间等）优化查询性能，满足不同场景下的审计查询需求。

**Section sources**
- [10-t_audit_log.sql](file://database-scripts/common-service/10-t_audit_log.sql)

### t_common_audit_archive表结构分析
t_common_audit_archive表用于管理审计日志的归档记录，实现审计数据的生命周期管理。该表记录了每次归档操作的详细信息，包括归档时间点、归档数量、文件路径和状态等。

**核心字段说明**：
- **archive_id**: 归档记录唯一标识
- **archive_code**: 归档编号，系统唯一
- **archive_time_point**: 归档的时间点，明确归档范围
- **archive_count**: 归档的日志数量，便于统计
- **archive_file_path**: 归档文件的存储路径
- **archive_status**: 归档操作的状态（进行中、成功、失败）
- **archive_start_time/archive_end_time**: 归档操作的起止时间

该表支持审计数据的定期归档和清理，确保在线数据库的性能，同时保留完整的审计历史以满足合规要求。

**Section sources**
- [11-t_common_audit_archive.sql](file://database-scripts/common-service/11-t_common_audit_archive.sql)

### 审计服务功能实现
根据项目文档，审计服务的数据模型层已100%完成，包括完整的Form类、VO类、Entity、DAO和Service实现。这些组件共同构成了审计服务的基础。

**已实现的核心功能**：
- 分页查询审计日志（支持20+查询条件）
- 获取审计日志详情
- 记录审计日志
- 审计统计分析
- 生成合规报告
- 导出审计日志
- 清理过期日志
- 健康检查

尽管数据模型层已完整，但Controller层尚未创建，相关API端点有待实现。这为后续开发提供了明确的方向。

**Section sources**
- [AUDIT_MIGRATION_FINAL_SUMMARY.md](file://documentation/archive/reports-2025-12-04/AUDIT_MIGRATION_FINAL_SUMMARY.md)

## 告警系统模块

### t_alert表结构分析
t_alert表用于存储系统产生的告警记录，是告警系统的核心数据表。该表设计灵活，能够记录各种类型的告警信息。

**核心字段说明**：
- **alert_id**: 告警唯一标识，自增主键
- **alert_level**: 告警级别（INFO/WARNING/ERROR/CRITICAL），支持分级管理
- **alert_title/alert_message**: 告警的标题和详细消息
- **service_name/instance_id**: 告警来源的服务和实例，支持服务级监控
- **metric_name/metric_value**: 触发告警的监控指标和实际值
- **status**: 告警状态（ACTIVE/RESOLVED/SUPPRESSED），支持告警生命周期管理
- **rule_id**: 关联的告警规则ID，支持告警溯源
- **create_time/update_time**: 创建和更新时间，支持时间维度分析

该表通过多维度索引优化查询性能，支持按告警级别、服务名称、状态等条件快速检索告警信息。

**Section sources**
- [11-t_alert.sql](file://database-scripts/common-service/11-t_alert.sql)

### t_alert_rule表结构分析
t_alert_rule表用于配置告警规则，是告警规则引擎的核心。该表设计全面，支持复杂的告警规则配置。

**核心字段说明**：
- **rule_id**: 规则唯一标识，自增主键
- **rule_name/rule_description**: 规则名称和描述，支持规则管理
- **metric_name/condition_operator/threshold_value**: 告警条件的核心配置
- **alert_level**: 触发告警的级别
- **status**: 规则状态（ENABLED/DISABLED），支持规则启停
- **duration_minutes**: 持续时间，支持持续性告警检测
- **notification_channels/notification_users**: 通知配置，支持多渠道通知
- **notification_interval**: 通知频率，避免告警风暴
- **suppression_duration**: 抑制时间，防止重复告警
- **priority**: 规则优先级，支持规则排序

该表支持企业级的告警规则管理，包括规则的启用/禁用、优先级设置、通知策略配置等，能够满足复杂的监控需求。

**Section sources**
- [12-t_alert_rule.sql](file://database-scripts/common-service/12-t_alert_rule.sql)

### 告警规则引擎设计
告警规则引擎的设计遵循企业级标准，实现了完整的规则创建流程和验证逻辑。

**核心功能**：
- **参数验证**：对规则名称、监控指标、条件操作符、告警级别等进行严格验证
- **唯一性检查**：确保规则名称的唯一性
- **默认值设置**：为状态、优先级、持续时间等字段设置合理的默认值
- **优先级计算**：根据告警级别自动计算优先级（CRITICAL:1, ERROR:10, WARNING:50, INFO:100）

告警规则引擎的设计对标钉钉等竞品，支持所有核心功能，包括多条件组合、通知频率控制、告警抑制等，为企业提供了强大的监控能力。

**Section sources**
- [ALERT_RULE_IMPLEMENTATION_SUMMARY.md](file://microservices/microservices-common/docs/ALERT_RULE_IMPLEMENTATION_SUMMARY.md)

### t_system_monitor表结构分析
t_system_monitor表用于记录系统的监控数据，是监控系统的基础数据表。该表设计通用，能够存储各种类型的监控指标。

**核心字段说明**：
- **monitor_id**: 监控记录唯一标识
- **service_name/instance_id**: 监控的服务和实例
- **monitor_type/metric_name**: 监控类型和指标名称
- **metric_value**: 监控值
- **status**: 当前状态（NORMAL/WARNING/CRITICAL）
- **alert_threshold**: 告警阈值
- **monitor_time**: 监控时间点

该表与t_alert和t_alert_rule表协同工作，形成完整的监控告警闭环。监控数据写入t_system_monitor表后，由监控引擎根据t_alert_rule中的规则进行分析，当条件满足时在t_alert表中创建告警记录。

**Section sources**
- [13-t_system_monitor.sql](file://database-scripts/common-service/13-t_system_monitor.sql)

## 定时任务模块

### t_scheduled_job表结构分析
t_scheduled_job表用于配置和管理定时任务，是作业调度系统的核心配置表。

**核心字段说明**：
- **job_id**: 任务唯一标识，自增主键
- **job_name/job_group**: 任务名称和分组，支持任务分类管理
- **job_class**: 任务执行类，指定任务的具体实现
- **cron_expression**: Cron表达式，定义任务的执行计划
- **job_params**: 任务参数（JSON格式），支持参数化任务
- **status**: 任务状态（启用、暂停、停止），支持任务生命周期管理
- **max_retry/retry_interval**: 重试配置，提高任务可靠性
- **timeout**: 超时时间，防止任务长时间运行
- **concurrent**: 是否允许并发执行
- **misfire_policy**: 错过执行策略，处理任务错过执行的情况

该表设计全面，支持复杂的任务调度需求，包括任务的启停、重试、超时控制等。

**Section sources**
- [14-t_scheduled_job.sql](file://database-scripts/common-service/14-t_scheduled_job.sql)

### t_job_execution_log表结构分析
t_job_execution_log表用于记录任务的执行日志，是作业调度系统的执行记录表。

**核心字段说明**：
- **log_id**: 日志唯一标识，自增主键
- **job_id/job_name**: 关联的任务ID和名称
- **execution_status**: 执行状态（成功、失败、超时、取消）
- **start_time/end_time**: 执行的起止时间
- **execution_time**: 执行时长，用于性能分析
- **retry_count**: 重试次数，反映任务的稳定性
- **error_message/stack_trace**: 错误信息和堆栈，支持故障排查
- **execution_result**: 执行结果（JSON格式）
- **server_ip/server_hostname**: 执行的服务器信息

该表与t_scheduled_job表形成一对多关系，记录了每个任务的历次执行情况，为任务的监控和分析提供了数据支持。

**Section sources**
- [15-t_job_execution_log.sql](file://database-scripts/common-service/15-t_job_execution_log.sql)

### 作业调度模型分析
作业调度模型采用经典的配置-执行-记录模式，通过t_scheduled_job和t_job_execution_log两张表实现。

**工作流程**：
1. 管理员在系统中配置定时任务，数据写入t_scheduled_job表
2. 调度引擎定期扫描t_scheduled_job表，根据Cron表达式判断需要执行的任务
3. 调度引擎执行任务，记录执行日志到t_job_execution_log表
4. 任务执行完成后，更新t_job_execution_log表中的结束时间和执行结果
5. 如果任务失败且未达到最大重试次数，根据重试间隔进行重试

该模型支持任务的全生命周期管理，从配置、执行到结果记录，形成了完整的闭环。

**Section sources**
- [14-t_scheduled_job.sql](file://database-scripts/common-service/14-t_scheduled_job.sql)
- [15-t_job_execution_log.sql](file://database-scripts/common-service/15-t_job_execution_log.sql)

## 访客物流模块

### t_visitor_vehicle表结构分析
t_visitor_vehicle表用于管理访客车辆信息，是访客物流模块的基础数据表。

**核心字段说明**：
- **vehicle_id**: 车辆唯一标识
- **vehicle_number**: 车牌号，唯一约束
- **vehicle_type**: 车辆类型（小型车、中型车、大型车）
- **driver_id**: 关联的司机ID，建立车辆与司机的关系
- **company_name**: 所属公司，支持按公司管理
- **status**: 状态（正常、禁用），支持车辆的启用/禁用

该表通过车牌号的唯一约束确保数据的准确性，通过司机ID的外键关联实现车辆与司机的关联管理。

**Section sources**
- [logistics-tables.sql](file://database-scripts/visitor/logistics-tables.sql)

### t_visitor_driver表结构分析
t_visitor_driver表用于管理访客司机信息，是访客物流模块的另一个基础数据表。

**核心字段说明**：
- **driver_id**: 司机唯一标识
- **driver_name/phone**: 司机的基本信息
- **id_card/license_number**: 身份证号和驾照号，唯一约束
- **license_type/license_expiry_date**: 驾照类型和有效期，支持驾照管理
- **photo_url**: 司机照片URL，支持身份验证

该表通过驾照号的唯一约束确保司机信息的唯一性，通过身份证号的索引支持快速查询。

**Section sources**
- [logistics-tables.sql](file://database-scripts/visitor/logistics-tables.sql)

### t_visitor_electronic_pass表结构分析
t_visitor_electronic_pass表用于管理电子出门单，是访客物流模块的核心业务表。

**核心字段说明**：
- **pass_id**: 出门单唯一标识
- **pass_number**: 出门单编号，唯一约束
- **vehicle_id/driver_id**: 关联的车辆和司机
- **goods_list**: 物品清单（JSON格式），支持复杂数据结构
- **total_value**: 物品总价值
- **scheduled_departure_time/actual_departure_time**: 预计和实际出发时间
- **approval_status**: 审批状态（待审批、已同意、已拒绝）
- **pass_status**: 出门单状态（已创建、已审批、已出门、已返回、已取消）

该表设计全面，覆盖了电子出门单的整个生命周期，从创建、审批到实际执行，支持完整的业务流程。

**Section sources**
- [logistics-tables.sql](file://database-scripts/visitor/logistics-tables.sql)

### 业务流程支撑分析
访客物流模块的表结构设计紧密支撑了实际业务流程，包括车辆管理、司机管理和电子出门单管理。

**业务流程**：
1. 司机和车辆信息录入，分别存储在t_visitor_driver和t_visitor_vehicle表中
2. 创建电子出门单，关联车辆和司机，数据写入t_visitor_electronic_pass表
3. 审批电子出门单，更新审批状态和审批人信息
4. 车辆实际出门，更新实际出发时间和出门单状态
5. 车辆返回，更新实际返回时间和出门单状态

该模块还包含存储过程支持复杂业务逻辑，如sp_check_logistics_operation_timeout用于检查物流作业超时，sp_generate_logistics_daily_report用于生成物流日报。

**Section sources**
- [database_dictionary.md](file://documentation/03-业务模块/访客/database_dictionary.md)

## 微服务协同工作分析

### common-service微服务
common-service微服务是系统的核心公共服务，负责提供审计、告警和定时任务等通用功能。

**协同工作方式**：
- **审计功能**：其他微服务通过调用common-service的审计API记录操作日志，数据存储在t_audit_log表中
- **告警功能**：其他微服务上报监控数据到t_system_monitor表，common-service的监控引擎根据t_alert_rule中的规则生成告警，记录在t_alert表中
- **定时任务**：common-service的调度引擎根据t_scheduled_job表中的配置执行定时任务，执行日志记录在t_job_execution_log表中

common-service通过提供统一的公共服务，实现了功能的集中管理和维护，避免了代码冗余。

**Section sources**
- [10-t_audit_log.sql](file://database-scripts/common-service/10-t_audit_log.sql)
- [11-t_alert.sql](file://database-scripts/common-service/11-t_alert.sql)
- [14-t_scheduled_job.sql](file://database-scripts/common-service/14-t_scheduled_job.sql)

### visitor-service微服务
visitor-service微服务负责访客物流相关的业务功能，与访客物流模块的表结构直接对应。

**协同工作方式**：
- **数据管理**：visitor-service直接操作t_visitor_vehicle、t_visitor_driver和t_visitor_electronic_pass表，实现车辆、司机和电子出门单的CRUD操作
- **业务流程**：visitor-service实现电子出门单的审批流程，更新t_visitor_electronic_pass表中的审批状态和出门单状态
- **存储过程调用**：visitor-service调用sp_check_logistics_operation_timeout和sp_generate_logistics_daily_report等存储过程，执行复杂的业务逻辑

visitor-service通过封装访客物流的业务逻辑，为前端应用提供了简洁的API接口。

**Section sources**
- [logistics-tables.sql](file://database-scripts/visitor/logistics-tables.sql)

## 系统监控与业务追踪作用

### 系统监控作用
各模块的表结构设计在系统监控方面发挥了重要作用。

**监控能力**：
- **审计日志**：t_audit_log表记录了所有关键操作，支持操作追溯和安全审计
- **系统监控**：t_system_monitor表存储了系统的各项监控指标，支持性能监控和容量规划
- **告警管理**：t_alert和t_alert_rule表实现了告警的全生命周期管理，支持故障预警和快速响应
- **任务监控**：t_job_execution_log表记录了定时任务的执行情况，支持任务的可靠性和性能监控

这些表共同构成了系统的监控体系，为运维团队提供了全面的监控数据。

**Section sources**
- [10-t_audit_log.sql](file://database-scripts/common-service/10-t_audit_log.sql)
- [11-t_alert.sql](file://database-scripts/common-service/11-t_alert.sql)
- [13-t_system_monitor.sql](file://database-scripts/common-service/13-t_system_monitor.sql)
- [15-t_job_execution_log.sql](file://database-scripts/common-service/15-t_job_execution_log.sql)

### 业务追踪作用
各模块的表结构设计在业务追踪方面也发挥了重要作用。

**追踪能力**：
- **操作追踪**：t_audit_log表的trace_id字段支持分布式追踪，能够追踪跨服务的调用链路
- **状态追踪**：t_visitor_electronic_pass表的pass_status字段记录了电子出门单的整个生命周期，支持业务状态追踪
- **执行追踪**：t_job_execution_log表记录了定时任务的历次执行情况，支持任务执行的追踪
- **变更追踪**：各表的create_time和update_time字段记录了数据的变更时间，支持数据变更的追踪

这些追踪能力为业务分析和问题排查提供了有力支持。

**Section sources**
- [10-t_audit_log.sql](file://database-scripts/common-service/10-t_audit_log.sql)
- [logistics-tables.sql](file://database-scripts/visitor/logistics-tables.sql)
- [15-t_job_execution_log.sql](file://database-scripts/common-service/15-t_job_execution_log.sql)

## 结论
本文档详细分析了IoE-DREAM项目中审计日志、告警系统、定时任务和访客物流模块的数据表设计。各模块的表结构设计合理，功能全面，能够有效支撑系统的各项业务需求。common-service和visitor-service等微服务通过与这些表的协同工作，实现了功能的集中管理和业务的高效执行。这些表在系统监控和业务追踪方面发挥了重要作用，为系统的稳定运行和业务发展提供了有力支持。