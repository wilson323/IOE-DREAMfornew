# 运维操作

<cite>
**本文档引用的文件**  
- [start-all-services.ps1](file://scripts/start-all-services.ps1)
- [deploy-monitoring.ps1](file://scripts/deploy-monitoring.ps1)
- [docker-compose-services.yml](file://docker-compose-services.yml)
- [docker-compose-monitoring.yml](file://deployment/monitoring/docker-compose-monitoring.yml)
- [prometheus.yml](file://deployment/monitoring/prometheus/prometheus.yml)
- [alertmanager.yml](file://deployment/monitoring/alertmanager/alertmanager.yml)
- [TROUBLESHOOTING_GUIDE.md](file://documentation/guide/TROUBLESHOOTING_GUIDE.md)
- [部署指南.md](file://documentation/04-部署运维/部署指南.md)
- [DEVICE_MANAGEMENT_DEPLOYMENT.md](file://documentation/04-部署运维/DEVICE_MANAGEMENT_DEPLOYMENT.md)
- [REAL_ENV_SETUP.md](file://documentation/04-部署运维/REAL_ENV_SETUP.md)
</cite>

## 目录
1. [日常运维任务](#日常运维任务)
2. [数据备份与恢复策略](#数据备份与恢复策略)
3. [故障排查](#故障排查)
4. [性能监控与容量规划](#性能监控与容量规划)
5. [常见问题（FAQ）](#常见问题faq)

## 日常运维任务

### 服务启停与重启

#### 服务启动
系统采用微服务架构，包含多个服务组件。服务启动需按照依赖顺序进行，确保服务间的正常通信。

**启动脚本**：`scripts/start-all-services.ps1`

**启动步骤**：
1. 打开PowerShell终端
2. 导航到项目根目录
3. 执行启动脚本：
```powershell
.\scripts\start-all-services.ps1
```

**服务启动顺序**：
1. **基础设施服务**：`ioedream-config-service` (端口8888)
2. **网关服务**：`ioedream-gateway-service` (端口8080)
3. **公共模块服务**：`ioedream-common-service` (端口8088) 和 `ioedream-device-comm-service` (端口8087)
4. **核心业务服务**：`ioedream-auth-service` (端口8083)、`ioedream-identity-service` (端口8084)
5. **业务服务**：`ioedream-oa-service` (端口8089)、`ioedream-access-service` (端口8090)、`ioedream-attendance-service` (端口8091)、`ioedream-video-service` (端口8092)、`ioedream-consume-service` (端口8094)、`ioedream-visitor-service` (端口8095)

**Section sources**
- [start-all-services.ps1](file://scripts/start-all-services.ps1#L1-L99)

#### 服务状态检查
可使用启动脚本的`-CheckOnly`参数检查服务状态：

```powershell
.\scripts\start-all-services.ps1 -CheckOnly
```

该命令将检查所有服务的端口是否处于监听状态，并输出运行中和未运行的服务统计。

#### 服务停止
目前系统未提供统一的停止脚本，需手动停止各个服务进程。建议使用任务管理器或`taskkill`命令停止Java进程。

#### 服务重启
服务重启建议先停止所有服务，再按启动顺序重新启动。可结合状态检查脚本确保所有服务正常运行。

### 日志查看

#### 日志位置
系统日志存储在各个微服务的`logs`目录下，主要日志文件包括：
- `application.log`：应用主日志
- `error.log`：错误日志
- `info.log`：信息日志
- `debug.log`：调试日志

#### 日志分析方法
1. **按级别过滤**：使用`grep`或`findstr`命令按日志级别筛选
```bash
# Linux/Mac
grep ERROR logs/application.log

# Windows
findstr ERROR logs\application.log
```

2. **按时间范围查询**：
```bash
# 查询特定时间段的日志
sed -n '/2025-01-30 12:00:00/,/2025-01-30 13:00:00/p' logs/application.log
```

3. **按业务操作查询**：
```bash
# 查询特定业务操作的日志
grep "消费交易" logs/application.log
```

4. **按用户查询**：
```bash
# 查询特定用户的日志
grep "userId=1001" logs/application.log
```

**Section sources**
- [TROUBLESHOOTING_GUIDE.md](file://documentation/guide/TROUBLESHOOTING_GUIDE.md#日志分析指南)

### 版本更新

#### 版本更新流程
1. **备份当前版本**：备份数据库和配置文件
2. **停止服务**：优雅停止当前运行的所有服务
3. **部署新版本**：将新版本的JAR文件或Docker镜像部署到服务器
4. **数据库迁移**：执行必要的数据库迁移脚本
5. **启动服务**：按依赖顺序启动新版本服务
6. **功能验证**：验证核心功能是否正常
7. **监控运行**：观察系统日志和性能指标，确保稳定运行

#### 版本回滚流程
当新版本出现严重问题时，执行以下回滚流程：
1. **停止新版本服务**：立即停止有问题的新版本服务
2. **恢复备份**：恢复数据库和配置文件到上一个稳定版本的状态
3. **启动旧版本**：启动上一个稳定版本的服务
4. **功能验证**：检查核心功能是否正常
5. **通知相关人员**：告知开发团队和业务方回滚情况

**Section sources**
- [部署指南.md](file://documentation/04-部署运维/部署指南.md#版本升级与回滚流程)

## 数据备份与恢复策略

### 数据备份策略

#### 数据库备份
建议采用每日定时备份策略，保留最近7天的备份。

**备份脚本示例**：
```bash
#!/bin/bash
BACKUP_DIR="/data/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -h192.168.10.110 -P33060 -uroot -p123456 smart_admin_v3 > $BACKUP_DIR/smart_admin_v3_$DATE.sql
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
```

#### 应用备份
定期备份应用文件和配置：

```bash
tar -czf /data/backup/app/smart-admin_$(date +%Y%m%d).tar.gz \
  /data/smart-admin/web \
  /data/smart-admin/mobile \
  /data/smart-admin/scripts
```

#### 异地备份
将备份文件同步到异地存储，防止本地灾难导致数据丢失。

**Section sources**
- [DEVICE_MANAGEMENT_DEPLOYMENT.md](file://documentation/04-部署运维/DEVICE_MANAGEMENT_DEPLOYMENT.md#备份策略)

### 数据恢复流程

1. **停止服务**：停止所有正在运行的服务
2. **恢复数据库**：
```bash
mysql -h192.168.10.110 -P33060 -uroot -p smart_admin_v3 < backup_file.sql
```
3. **恢复配置文件**：将备份的配置文件复制回原位置
4. **启动服务**：按正常启动流程启动所有服务
5. **验证数据**：检查关键数据是否完整，功能是否正常

## 故障排查

### 服务无法启动

#### 排查步骤
1. **检查端口占用**：
```bash
# Windows
netstat -ano | findstr :8080

# Linux
lsof -i :8080
```

2. **检查配置文件**：
- 检查`application.yml`配置是否正确
- 检查Nacos配置中心连接是否正常
- 检查数据库连接配置是否正确

3. **检查依赖服务**：
- 检查Nacos服务是否启动
- 检查Redis服务是否启动
- 检查MySQL服务是否启动

4. **查看启动日志**：
```bash
# 查看服务启动日志
tail -f logs/application.log

# 查看错误日志
grep ERROR logs/application.log
```

**Section sources**
- [TROUBLESHOOTING_GUIDE.md](file://documentation/guide/TROUBLESHOOTING_GUIDE.md#服务启动失败)

### 接口超时

#### 排查步骤
1. **检查数据库查询**：
```sql
-- 查看慢查询日志
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 查看正在执行的查询
SHOW PROCESSLIST;
```

2. **检查缓存命中率**：
```bash
# 查看Redis缓存统计
redis-cli INFO stats
```

3. **检查JVM性能**：
```bash
# 查看JVM内存使用
jmap -heap <进程ID>

# 查看GC情况
jstat -gc <进程ID> 1000
```

#### 解决方案
- **数据库优化**：添加合适的索引，优化SQL查询
- **缓存优化**：提高缓存命中率，优化缓存过期时间
- **JVM优化**：调整堆内存大小，选择合适的GC算法

**Section sources**
- [TROUBLESHOOTING_GUIDE.md](file://documentation/guide/TROUBLESHOOTING_GUIDE.md#接口响应慢)

## 性能监控与容量规划

### 性能监控

#### 监控系统部署
系统使用Prometheus、AlertManager和Grafana构建监控告警系统。

**部署脚本**：`scripts/deploy-monitoring.ps1`

**部署命令**：
```powershell
# 启动监控系统
.\scripts\deploy-monitoring.ps1

# 停止监控系统
.\scripts\deploy-monitoring.ps1 -Stop

# 重启监控系统
.\scripts\deploy-monitoring.ps1 -Restart

# 查看状态
.\scripts\deploy-monitoring.ps1 -Status

# 查看日志
.\scripts\deploy-monitoring.ps1 -Logs
```

**访问地址**：
- Prometheus: http://localhost:9090
- AlertManager: http://localhost:9093
- Grafana: http://localhost:3000 (默认账号: admin/admin)

**Section sources**
- [deploy-monitoring.ps1](file://scripts/deploy-monitoring.ps1#L1-L193)
- [docker-compose-monitoring.yml](file://deployment/monitoring/docker-compose-monitoring.yml#L1-L109)

#### 监控指标
系统监控以下关键指标：
- **CPU使用率**：超过80%持续5分钟
- **内存使用率**：超过85%持续5分钟
- **磁盘空间**：剩余空间低于20%
- **服务可用性**：HTTP健康检查失败连续3次
- **数据库连接**：活跃连接数超过最大连接数的80%

### 容量规划建议

#### 服务器配置要求
- **CPU**：4核及以上
- **内存**：8GB及以上（建议16GB）
- **存储**：100GB SSD硬盘
- **操作系统**：CentOS 7+ 或 Ubuntu 18.04+
- **Java版本**：OpenJDK 17
- **Node.js版本**：18+

#### JVM参数配置
```bash
java -Xms2g -Xmx4g \
     -XX:MetaspaceSize=256m \
     -XX:MaxMetaspaceSize=512m \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+PrintGCDetails \
     -XX:+PrintGCTimeStamps \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/var/log/app/heapdump.hprof \
     -Dfile.encoding=UTF-8 \
     -Duser.timezone=Asia/Shanghai \
     -jar sa-admin-3.0.0.jar
```

## 常见问题（FAQ）

### Q1: 如何检查所有服务的运行状态？
使用启动脚本的`-CheckOnly`参数：
```powershell
.\scripts\start-all-services.ps1 -CheckOnly
```

### Q2: 服务启动时端口被占用怎么办？
1. 查找占用端口的进程：
```bash
# Windows
netstat -ano | findstr :8080

# Linux
lsof -i :8080
```
2. 终止占用端口的进程：
```bash
# Windows
taskkill /PID <进程ID> /F

# Linux
kill -9 <进程ID>
```

### Q3: 如何查看特定用户的操作日志？
在前端界面的"操作日志"模块中，通过用户ID或用户名进行搜索。后端日志中可使用以下命令：
```bash
grep "userId=1001" logs/application.log
```

### Q4: 数据库连接失败的可能原因有哪些？
- 数据库服务未启动
- 数据库地址、端口配置错误
- 用户名、密码错误
- 数据库用户权限不足
- 网络连接问题

### Q5: 如何优化慢查询？
1. 使用`EXPLAIN`分析查询计划
2. 为查询条件字段添加索引
3. 优化SQL语句，避免全表扫描
4. 考虑使用查询缓存