# 环境搭建

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [pom.xml](file://microservices/pom.xml)
- [vite.config.js](file://smart-admin-web-javascript/vite.config.js)
- [package.json](file://smart-admin-web-javascript/package.json)
- [application.yml](file://microservices/ioedream-gateway-service/src/main/resources/application.yml)
- [docker-compose-services.yml](file://docker-compose-services.yml)
- [docker-compose-monitoring.yml](file://deployment/monitoring/docker-compose-monitoring.yml)
- [prometheus.yml](file://deployment/monitoring/prometheus/prometheus.yml)
- [00-database-init.sql](file://database-scripts/common-service/00-database-init.sql)
- [DEVELOPMENT_GUIDE.md](file://documentation/guide/DEVELOPMENT_GUIDE.md)
- [ENVIRONMENT_VARIABLES.md](file://documentation/deployment/ENVIRONMENT_VARIABLES.md)
- [.prettierrc.cjs](file://smart-admin-web-javascript/.prettierrc.cjs)
- [.eslintrc.cjs](file://smart-admin-web-javascript/.eslintrc.cjs)
</cite>

## 目录

1. [简介](#简介)
2. [基础环境配置](#基础环境配置)
3. [开发工具配置](#开发工具配置)
4. [依赖加速配置](#依赖加速配置)
5. [中间件服务部署](#中间件服务部署)
6. [项目运行指南](#项目运行指南)
7. [常见问题排查](#常见问题排查)
8. [附录](#附录)

## 简介

本指南旨在为IOE-DREAM项目提供完整的开发环境搭建说明，涵盖前后端环境配置、开发工具设置、依赖管理优化以及本地服务部署等关键环节。通过本指南，开发者可以快速搭建符合项目要求的开发环境，确保开发工作顺利进行。

**Section sources**
- [README.md](file://README.md)

## 基础环境配置

### Java 17 安装与配置

根据项目要求，后端微服务基于Java 17构建。请按照以下步骤进行安装：

1. 下载OpenJDK 17发行版（推荐使用Adoptium或Amazon Corretto）
2. 安装JDK并配置环境变量：
   - `JAVA_HOME`: JDK安装路径
   - 将`%JAVA_HOME%\bin`添加到`PATH`环境变量
3. 验证安装：
   ```bash
   java -version
   javac -version
   ```

项目中通过`pom.xml`文件明确指定了Java版本要求，确保编译环境与运行环境一致。

### Node.js 18 安装与配置

前端项目对Node.js版本有明确要求，需安装Node.js 18+版本：

1. 从Node.js官网下载v18.x LTS版本
2. 安装Node.js，npm会随Node.js自动安装
3. 验证安装：
   ```bash
   node --version
   npm --version
   ```
4. 前端项目在`package.json`中通过`engines`字段声明了Node.js版本要求，确保使用兼容版本。

### MySQL 8.0 配置

数据库环境配置步骤如下：

1. 安装MySQL 8.0服务器
2. 创建数据库：
   ```sql
   CREATE DATABASE ioedream_common_db DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```
3. 执行数据库初始化脚本：
   - 执行`database-scripts/common-service/00-database-init.sql`创建数据库
   - 按顺序执行后续的01-18号SQL脚本创建表结构
4. 配置数据库连接参数，确保字符集为utf8mb4，时区为Asia/Shanghai

### Redis 配置

Redis作为缓存和会话存储服务，配置要求如下：

1. 安装Redis 6.0+版本
2. 确保Redis服务监听在6379端口
3. 开发环境可不设置密码，生产环境需配置强密码
4. 项目通过Spring Data Redis配置连接，支持单机和集群模式

### Nacos 配置

Nacos作为服务发现和配置中心，配置要点：

1. 使用Nacos 2.0+版本
2. 服务地址默认为`127.0.0.1:8848`
3. 配置命名空间（namespace）为`dev`，组（group）为`IOE-DREAM`
4. 设置登录凭据：用户名`nacos`，密码需在环境变量中配置
5. 微服务通过`application.yml`中的`spring.cloud.nacos`配置连接Nacos

### Prometheus 配置

Prometheus用于系统监控和指标收集：

1. 使用最新稳定版本
2. 配置文件`prometheus.yml`定义了多个监控任务
3. 监控目标包括各微服务的Actuator端点
4. 通过`/actuator/prometheus`路径暴露监控指标
5. 配置告警规则文件路径，实现异常告警

**Section sources**
- [pom.xml](file://microservices/pom.xml#L17-L21)
- [package.json](file://smart-admin-web-javascript/package.json#L68-L70)
- [00-database-init.sql](file://database-scripts/common-service/00-database-init.sql)
- [application.yml](file://microservices/ioedream-gateway-service/src/main/resources/application.yml#L21-L38)
- [prometheus.yml](file://deployment/monitoring/prometheus/prometheus.yml)

## 开发工具配置

### IntelliJ IDEA 配置

推荐的IntelliJ IDEA配置如下：

#### 必要插件

- **Lombok Plugin**: 支持Lombok注解处理
- **MyBatisX**: 增强MyBatis开发体验
- **Spring Boot Helper**: 提供Spring Boot开发辅助
- **Rainbow Brackets**: 彩虹括号增强代码可读性
- **Alibaba Java Coding Guidelines**: 阿里巴巴代码规范检查

#### 编码设置

- 字符编码：UTF-8
- 行尾符：Unix (LF)
- 缩进：4个空格
- 文件模板：使用项目提供的标准模板
- 编译器设置：启用注解处理器

#### 项目设置

- Maven版本：3.8+
- JDK版本：17
- 构建工具：使用Maven进行项目构建
- 运行配置：为各微服务创建独立的运行配置

### VS Code 配置

推荐的VS Code配置如下：

#### 必要插件

- **Prettier - Code formatter**: 代码格式化
- **ESLint**: JavaScript/TypeScript代码检查
- **Vetur/Volar**: Vue.js开发支持
- **Stylelint**: CSS/SCSS样式检查
- **GitLens**: 增强Git功能
- **Markdown All in One**: Markdown文档编辑

#### 编码设置

- 字符编码：UTF-8
- 行尾符：LF
- 缩进：2个空格（JavaScript/TypeScript）或4个空格（HTML）
- 自动保存：启用
- 文件关联：正确设置`.vue`、`.js`、`.ts`等文件类型

#### 代码格式化配置

项目提供了详细的Prettier和ESLint配置：

```javascript
// .prettierrc.cjs
module.exports = {
  printWidth: 150,
  tabWidth: 2,
  useTabs: false,
  semi: true,
  singleQuote: true,
  vueIndentScriptAndStyle: true,
  trailingComma: 'es5',
  bracketSpacing: true,
  arrowParens: 'always',
  endOfLine: 'auto'
};
```

```javascript
// .eslintrc.cjs
module.exports = {
  root: true,
  env: {
    browser: true,
    es2021: true,
    node: true,
  },
  parser: 'vue-eslint-parser',
  extends: ['plugin:vue/vue3-essential', 'eslint:recommended'],
  rules: {
    'no-unused-vars': ['error', { varsIgnorePattern: '.*', args: 'none' }],
    'vue/multi-word-component-names': ['error', { ignores: ['index'] }],
    'vue/html-self-closing': 'error'
  }
};
```

**Section sources**
- [.prettierrc.cjs](file://smart-admin-web-javascript/.prettierrc.cjs)
- [.eslintrc.cjs](file://smart-admin-web-javascript/.eslintrc.cjs)
- [DEVELOPMENT_GUIDE.md](file://documentation/guide/DEVELOPMENT_GUIDE.md#代码规范)

## 依赖加速配置

### Maven 镜像源配置

为加速Maven依赖下载，建议配置国内镜像源：

1. 在`settings.xml`中添加阿里云镜像：
```xml
<mirrors>
  <mirror>
    <id>aliyunmaven</id>
    <mirrorOf>*</mirrorOf>
    <name>阿里云公共仓库</name>
    <url>https://maven.aliyun.com/repository/public</url>
  </mirror>
</mirrors>
```

2. 配置项目级镜像（可选）：
- 在`pom.xml`中通过`<repositories>`和`<pluginRepositories>`指定镜像源
- 使用BOM（Bill of Materials）统一管理依赖版本

项目已通过父POM统一管理所有微服务的依赖版本，避免版本冲突。

### NPM 镜像源配置

为加速NPM包下载，配置淘宝镜像源：

1. 全局配置：
```bash
npm config set registry https://registry.npmmirror.com
```

2. 项目级配置：
- 在项目根目录创建`.npmrc`文件
- 添加内容：`registry=https://registry.npmmirror.com`

3. 验证配置：
```bash
npm config get registry
```

项目前端使用Vite构建，依赖管理清晰，通过`package.json`明确声明所有依赖。

**Section sources**
- [pom.xml](file://microservices/pom.xml#L84-L114)
- [package.json](file://smart-admin-web-javascript/package.json#L19-L48)

## 中间件服务部署

### Docker Compose 部署

项目提供`docker-compose-services.yml`文件，用于快速启动基础中间件服务：

```yaml
version: '3.8'

services:
  # Redis服务
  redis:
    image: redis:7-alpine
    container_name: ioedream-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - ioedream-network

  # Nacos服务
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: ioedream-nacos
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=host.docker.internal
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=root
    ports:
      - "8848:8848"
    restart: unless-stopped
    networks:
      - ioedream-network

volumes:
  redis_data:

networks:
  ioedream-network:
    external: true
    name: ioe-dream_smart-admin-network
```

启动命令：
```bash
docker-compose -f docker-compose-services.yml up -d
```

### 监控系统部署

监控系统通过`docker-compose-monitoring.yml`部署：

```yaml
version: '3.8'

services:
  # Prometheus监控
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus/rules:/etc/prometheus/rules
      - prometheus_data:/prometheus
    networks:
      - ioedream-network
    restart: unless-stopped

  # AlertManager告警管理
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
    networks:
      - ioedream-network
    restart: unless-stopped

  # Grafana可视化
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - ioedream-network
    restart: unless-stopped
    depends_on:
      - prometheus

  # Node Exporter系统监控
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    networks:
      - ioedream-network
    restart: unless-stopped

volumes:
  prometheus_data:
  alertmanager_data:
  grafana_data:

networks:
  ioedream-network:
    external: true
```

启动命令：
```bash
docker-compose -f deployment/monitoring/docker-compose-monitoring.yml up -d
```

访问地址：
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (账号: admin, 密码: admin123)
- AlertManager: http://localhost:9093

**Diagram sources**
- [docker-compose-services.yml](file://docker-compose-services.yml)
- [docker-compose-monitoring.yml](file://deployment/monitoring/docker-compose-monitoring.yml)

**Section sources**
- [docker-compose-services.yml](file://docker-compose-services.yml)
- [docker-compose-monitoring.yml](file://deployment/monitoring/docker-compose-monitoring.yml)
- [prometheus.yml](file://deployment/monitoring/prometheus/prometheus.yml)

## 项目运行指南

### 前端项目运行

前端项目位于`smart-admin-web-javascript`目录：

1. 安装依赖：
```bash
cd smart-admin-web-javascript
npm install
```

2. 配置环境变量：
- `.env.development`: 开发环境配置
- `.env.localhost`: 本地环境配置
- `.env.production`: 生产环境配置

关键配置项：
```env
VITE_APP_API_URL='http://127.0.0.1:1024'
VITE_APP_TITLE='SmartAdmin 开发环境(Dev)'
```

3. 启动开发服务器：
```bash
npm run dev
```

4. 构建生产版本：
```bash
npm run build:prod
```

5. Vite配置要点：
- 代理配置：将API请求代理到后端服务
- 端口：8081
- 别名配置：`/@/`指向`src/`目录

### 后端微服务运行

后端采用Spring Boot微服务架构，包含多个服务模块：

1. 项目结构：
```
microservices/
├── microservices-common/        # 公共模块
├── ioedream-gateway-service/    # 网关服务
├── ioedream-common-service/     # 公共业务服务
├── ioedream-consume-service/    # 消费服务
└── ...                          # 其他业务服务
```

2. 运行步骤：
- 使用IntelliJ IDEA导入Maven项目
- 确保JDK版本为17
- 配置Nacos连接参数
- 依次启动各微服务

3. 服务端口配置：
- 网关服务: 8080
- 公共服务: 8088
- 设备通讯服务: 8087
- OA服务: 8089
- 门禁服务: 8090
- 考勤服务: 8091
- 视频服务: 8092
- 消费服务: 8094
- 访客服务: 8095

4. 环境变量配置：
通过`ENVIRONMENT_VARIABLES.md`文件了解必需的环境变量，包括数据库、Redis、Nacos等连接信息。

**Section sources**
- [vite.config.js](file://smart-admin-web-javascript/vite.config.js)
- [.env.development](file://smart-admin-web-javascript/.env.development)
- [pom.xml](file://microservices/pom.xml#L116-L128)
- [ENVIRONMENT_VARIABLES.md](file://documentation/deployment/ENVIRONMENT_VARIABLES.md)

## 常见问题排查

### 环境变量问题

**问题**: 服务启动失败，提示Nacos连接超时
**解决方案**:
1. 检查Nacos服务是否正常运行
2. 验证`NACOS_SERVER_ADDR`环境变量配置
3. 确认网络连接正常
4. 检查防火墙设置

### 数据库连接问题

**问题**: 数据库连接失败
**解决方案**:
1. 验证MySQL服务是否启动
2. 检查数据库URL、用户名和密码
3. 确认数据库字符集为utf8mb4
4. 检查网络连接和端口映射

### 依赖冲突问题

**问题**: Maven依赖冲突
**解决方案**:
1. 使用`mvn dependency:tree`分析依赖树
2. 检查是否有版本冲突
3. 使用`<dependencyManagement>`统一管理版本
4. 排除冲突的传递依赖

### 前端构建问题

**问题**: Vite构建失败
**解决方案**:
1. 清理node_modules和package-lock.json
2. 重新安装依赖
3. 检查Node.js版本是否符合要求
4. 验证代理配置是否正确

### 缓存问题

**问题**: Redis连接失败
**解决方案**:
1. 检查Redis服务状态
2. 验证Redis主机和端口配置
3. 确认网络连接正常
4. 检查Redis密码配置

**Section sources**
- [ENVIRONMENT_VARIABLES.md](file://documentation/deployment/ENVIRONMENT_VARIABLES.md)
- [DEVELOPMENT_GUIDE.md](file://documentation/guide/DEVELOPMENT_GUIDE.md#常见问题解答)

## 附录

### 环境变量参考

| 环境变量 | 默认值 | 说明 |
|---------|-------|------|
| DB_URL | - | 数据库连接URL |
| DB_USERNAME | root | 数据库用户名 |
| DB_PASSWORD | - | 数据库密码 |
| REDIS_HOST | 127.0.0.1 | Redis主机 |
| REDIS_PORT | 6379 | Redis端口 |
| NACOS_SERVER_ADDR | 127.0.0.1:8848 | Nacos服务地址 |
| NACOS_NAMESPACE | dev | Nacos命名空间 |
| NACOS_GROUP | IOE-DREAM | Nacos组 |

### 服务端口分配

| 服务 | 端口 | 说明 |
|-----|-----|------|
| 网关服务 | 8080 | API网关 |
| 公共服务 | 8088 | 公共业务逻辑 |
| 设备通讯服务 | 8087 | 设备通讯 |
| OA服务 | 8089 | 办公自动化 |
| 门禁服务 | 8090 | 门禁管理 |
| 考勤服务 | 8091 | 考勤管理 |
| 视频服务 | 8092 | 视频监控 |
| 消费服务 | 8094 | 消费管理 |
| 访客服务 | 8095 | 访客管理 |

### 参考文档

- [SmartAdmin官方文档](https://smartadmin.vip)
- [Spring Boot官方文档](https://spring.io/projects/spring-boot)
- [Vue3官方文档](https://vuejs.org)
- [Docker官方文档](https://docs.docker.com)