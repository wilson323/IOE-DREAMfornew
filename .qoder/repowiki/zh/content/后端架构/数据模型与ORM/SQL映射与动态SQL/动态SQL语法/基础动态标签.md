# 基础动态标签

<cite>
**本文档引用文件**  
- [ConsumeTransactionDao.xml](file://microservices\ioedream-consume-service\src\main\resources\mapper\ConsumeTransactionDao.xml)
- [DAO模板.md](file://documentation\06-模板工具\代码模板\DAO模板.md)
</cite>

## 目录
1. [简介](#简介)
2. [if标签详解](#if标签详解)
3. [where标签详解](#where标签详解)
4. [set标签详解](#set标签详解)
5. [实际应用示例](#实际应用示例)
6. [最佳实践](#最佳实践)

## 简介
本文档详细介绍了MyBatis中最常用的动态SQL标签，包括`<if>`、`<where>`和`<set>`标签的使用方法和实际应用场景。通过这些动态标签，开发者可以构建灵活的SQL语句，根据不同的条件动态生成查询和更新语句。

**Section sources**
- [DAO模板.md](file://documentation\06-模板工具\代码模板\DAO模板.md)

## if标签详解
`<if>`标签是MyBatis中最基本的条件判断标签，用于根据条件决定是否包含某段SQL代码。其核心是`test`属性，该属性使用OGNL（Object-Graph Navigation Language）表达式进行条件判断。

### test属性表达式语法
`test`属性支持完整的OGNL表达式语法，可以进行各种条件判断：

```xml
<if test="userId != null">AND user_id = #{userId}</if>
<if test="transactionNo != null and transactionNo != ''">AND transaction_no = #{transactionNo}</if>
<if test="status != null and status != ''">AND status = #{status}</if>
```

### OGNL表达式支持的运算符
- **比较运算符**: `==`, `!=`, `<`, `>`, `<=`, `>=`
- **逻辑运算符**: `&&` (and), `||` (or), `!` (not)
- **空值判断**: `!= null`, `== null`
- **字符串判断**: `!= ''`, `length > 0`

### 常见使用模式
1. **单条件判断**: `test="userId != null"`
2. **复合条件判断**: `test="status != null and status != ''"`
3. **数值范围判断**: `test="amount >= 100"`
4. **布尔值判断**: `test="isActive"`

**Section sources**
- [ConsumeTransactionDao.xml](file://microservices\ioedream-consume-service\src\main\resources\mapper\ConsumeTransactionDao.xml#L47-L68)

## where标签详解
`<where>`标签用于智能处理WHERE子句，自动管理AND/OR前缀，解决动态SQL中常见的连接词问题。

### 智能前缀处理
`<where>`标签的主要优势在于其智能的前缀处理机制：
- 自动添加`WHERE`关键字
- 自动去除多余的`AND`或`OR`前缀
- 只有当内部至少有一个条件为真时才生成WHERE子句

### 工作原理
```xml
<where>
    <if test="userId != null">AND user_id = #{userId}</if>
    <if test="transactionNo != null and transactionNo != ''">AND transaction_no = #{transactionNo}</if>
    <if test="deviceId != null">AND device_id = #{deviceId}</if>
</where>
```

当所有条件都为假时，生成的SQL不包含WHERE子句；当有多个条件为真时，`<where>`标签会自动去除第一个条件前的AND关键字。

### 实际效果
- 所有条件为假: `SELECT * FROM table`
- 部分条件为真: `SELECT * FROM table WHERE user_id = ? AND device_id = ?`
- 自动处理: 无需担心第一个条件前的AND导致语法错误

**Section sources**
- [ConsumeTransactionDao.xml](file://microservices\ioedream-consume-service\src\main\resources\mapper\ConsumeTransactionDao.xml#L46-L72)

## set标签详解
`<set>`标签专门用于UPDATE语句，智能处理SET子句中的逗号分隔问题。

### 自动逗号管理
`<set>`标签的核心功能是自动管理字段间的逗号：
- 自动在字段间添加逗号
- 自动去除末尾多余的逗号
- 只更新非空字段

### 使用方法
```xml
<update id="updateById" parameterType="Entity">
    UPDATE t_table
    <set>
        <if test="name != null">name = #{name},</if>
        <if test="code != null">code = #{code},</if>
        <if test="status != null">status = #{status},</if>
        update_time = #{updateTime},
        <if test="updateUserId != null">update_user_id = #{updateUserId},</if>
    </set>
    WHERE id = #{id}
</set>
```

### 处理规则
1. **逗号添加**: 在每个`<if>`块的末尾添加逗号
2. **末尾去除**: 自动去除最后一个有效字段后的逗号
3. **空值跳过**: 当所有`<if>`条件都为假时，`<set>`标签不会生成任何内容

### 优势
- 避免手动管理逗号导致的语法错误
- 支持部分字段更新
- 提高代码可读性和维护性

**Section sources**
- [DAO模板.md](file://documentation\06-模板工具\代码模板\DAO模板.md#L590-L602)

## 实际应用示例
以下是在实际项目中动态SQL标签的应用示例。

### 查询操作示例
```xml
<select id="queryTransactions" resultType="ConsumeTransactionEntity">
    SELECT
        id, transaction_no, user_id, user_name, dept_id,
        account_id, account_kind_id, is_attendance_consume,
        area_id, area_name, area_manage_mode, area_sub_type,
        meal_id, meal_category_id, meal_name, device_id,
        device_name, consume_money, discount_money, final_money,
        balance_before, balance_after, allowance_used, cash_used,
        consume_mode, consume_type, fixed_value_rule_id,
        fixed_value_times, consume_time, transaction_time,
        transaction_status, status, product_id, product_name,
        create_time, update_time, create_user, update_user
    FROM consume_transaction
    <where>
        <if test="userId != null">AND user_id = #{userId}</if>
        <if test="transactionNo != null and transactionNo != ''">AND transaction_no = #{transactionNo}</if>
        <if test="deviceId != null">AND device_id = #{deviceId}</if>
        <if test="areaId != null and areaId != ''">AND area_id = #{areaId}</if>
        <if test="startTime != null">AND consume_time >= #{startTime}</if>
        <if test="endTime != null">AND consume_time <= #{endTime}</if>
        <if test="consumeMode != null and consumeMode != ''">AND consume_mode = #{consumeMode}</if>
        <if test="status != null and status != ''">AND status = #{status}</if>
    </where>
    ORDER BY consume_time DESC
</select>
```

### 更新操作示例
```xml
<update id="updateById" parameterType="Entity">
    UPDATE t_table
    <set>
        <if test="name != null">name = #{name},</if>
        <if test="code != null">code = #{code},</if>
        <if test="status != null">status = #{status},</if>
        update_time = #{updateTime},
        <if test="updateUserId != null">update_user_id = #{updateUserId},</if>
    </set>
    WHERE id = #{id} AND deleted_flag = false
</update>
```

**Section sources**
- [ConsumeTransactionDao.xml](file://microservices\ioedream-consume-service\src\main\resources\mapper\ConsumeTransactionDao.xml)
- [DAO模板.md](file://documentation\06-模板工具\代码模板\DAO模板.md)

## 最佳实践
### 1. 条件判断最佳实践
- 使用`!= null`进行空值判断
- 对字符串使用`!= null and != ''`双重判断
- 避免在`test`属性中使用复杂的逻辑表达式

### 2. where标签使用建议
- 总是使用`<where>`标签而不是手动添加WHERE
- 在`<if>`标签内部使用AND前缀，让`<where>`标签处理第一个条件
- 注意`<where>`标签只去除AND/OR前缀，不处理其他关键字

### 3. set标签使用建议
- 在`<if>`块末尾添加逗号，让`<set>`标签处理末尾逗号
- 将非条件字段（如update_time）也放在`<set>`标签内
- 注意`<set>`标签不会验证SQL语法，确保字段名正确

### 4. 性能考虑
- 为常用查询条件创建索引
- 避免在`test`表达式中调用复杂方法
- 合理使用分页查询，避免大数据量全表扫描

**Section sources**
- [ConsumeTransactionDao.xml](file://microservices\ioedream-consume-service\src\main\resources\mapper\ConsumeTransactionDao.xml)
- [DAO模板.md](file://documentation\06-模板工具\代码模板\DAO模板.md)