# 考勤系统

<cite>
**本文档引用文件**   
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)
- [考勤规则配置.md](file://documentation\03-业务模块\考勤\考勤规则配置.md)
- [AttendanceRecordController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceRecordController.java)
- [AttendanceShiftController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceShiftController.java)
- [AttendanceSupplementController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceSupplementController.java)
- [AttendanceShiftServiceImpl.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\service\impl\AttendanceShiftServiceImpl.java)
- [AttendanceShiftEntity.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\domain\entity\AttendanceShiftEntity.java)
- [AttendanceSupplementEntity.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\domain\entity\AttendanceSupplementEntity.java)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)（如有必要）

## 简介
本文档详细介绍了考勤系统的各项功能，包括排班管理、打卡记录、考勤计算和报表统计等核心功能。文档详细说明了班次、时段、考勤规则的配置方法和计算逻辑，解释了异常考勤（如迟到、早退、缺卡）的处理流程。同时，提供了考勤数据同步、补卡申请和审批流程的使用说明，并包含了考勤系统与门禁系统的集成方式和数据流转机制。

## 项目结构
考勤系统是IOE-DREAM七微服务架构中的一个独立微服务，负责处理所有与考勤相关的业务逻辑。系统采用四层架构模式，包括Controller层、Service层、Manager层和DAO层，严格遵循企业级微服务规范。

```mermaid
erDiagram
clock_records {
bigint id PK "主键ID，自增长"
bigint employee_id FK "员工ID，关联employees表"
bigint device_id FK "设备ID，关联devices表"
datetime clock_time "打卡时间，如：2024-01-15 09:00:00"
varchar clock_type "打卡类型：上班/下班/外出/返回"
varchar clock_location "打卡地点，如：一楼大厅"
decimal longitude "经度坐标，用于GPS定位"
decimal latitude "纬度坐标，用于GPS定位"
varchar photo_url "打卡照片URL，用于验证和记录"
tinyint status "状态：0-异常，1-正常"
datetime create_time "创建时间，记录打卡记录创建时间"
datetime update_time "更新时间，记录最后修改时间"
}
attendance_results {
bigint id PK "主键ID，自增长"
bigint employee_id FK "员工ID，关联employees表"
date attendance_date "考勤日期，如：2024-01-15"
bigint shift_id FK "班次ID，关联shifts表"
datetime clock_in_time "上班打卡时间，如：09:00:00"
datetime clock_out_time "下班打卡时间，如：18:00:00"
decimal work_duration "工作时长(小时)，如：8.0小时"
int late_minutes "迟到分钟数，如：15分钟"
int early_minutes "早退分钟数，如：10分钟"
int absent_minutes "旷工分钟数，如：480分钟"
decimal overtime_minutes "加班分钟数，如：120.0分钟"
decimal weekend_overtime "周末加班时长(小时)，如：4.0小时"
varchar attendance_status "考勤状态：正常/迟到/早退/旷工/请假"
int exception_count "异常次数，如：2次"
tinyint status "状态：0-删除，1-正常"
datetime create_time "创建时间，记录考勤结果创建时间"
datetime update_time "更新时间，记录最后修改时间"
}
attendance_summaries {
bigint id PK "主键ID，自增长"
bigint employee_id FK "员工ID，关联employees表"
varchar summary_month "汇总月份，如：2024-01"
int work_days "应工作天数，如：22天"
int actual_days "实际出勤天数，如：20天"
int absent_days "旷工天数，如：2天"
int late_count "迟到次数，如：3次"
int early_count "早退次数，如：1次"
decimal overtime_hours "加班时长(小时)，如：16.0小时"
decimal weekend_overtime_hours "周末加班时长(小时)，如：8.0小时"
decimal leave_days "请假天数，如：1.5天"
decimal attendance_rate "出勤率，如：0.95表示95%"
tinyint status "状态：0-删除，1-正常"
datetime create_time "创建时间，记录汇总创建时间"
datetime update_time "更新时间，记录最后修改时间"
}
attendance_warning_records {
bigint id PK "主键ID，自增长"
bigint employee_id FK "员工ID，关联employees表"
bigint rule_id FK "考勤规则ID，关联attendance_rules表"
varchar warning_type "预警类型：未打卡/考勤异常/频繁迟到"
int consecutive_days "连续天数，如：3天"
varchar warning_level "预警级别：high/medium/low"
date warning_date "预警日期，如：2024-01-15"
text warning_content "预警内容，详细说明预警原因"
varchar notification_status "通知状态：0-未通知，1-已通知，2-通知失败"
datetime notification_time "通知时间，记录通知发送时间"
tinyint is_handled "是否已处理：0-未处理，1-已处理"
text handle_comment "处理意见，处理人的处理说明"
datetime handle_time "处理时间，记录处理完成时间"
bigint handler_id FK "处理人ID，关联employees表"
tinyint status "状态：0-删除，1-正常"
datetime create_time "创建时间，记录预警创建时间"
datetime update_time "更新时间，记录最后修改时间"
}
employees {
bigint id PK "主键ID，自增长"
varchar employee_no UK "工号，员工唯一标识，如：EMP001"
varchar name "员工姓名"
bigint department_id FK "所属部门ID，关联departments表"
bigint position_id FK "岗位ID，关联positions表"
varchar phone "手机号码，用于通知和验证"
varchar email "邮箱地址，用于通知和登录"
tinyint status "状态：0-离职，1-在职"
date hire_date "入职日期，用于计算工龄"
datetime create_time "创建时间，记录员工信息创建时间"
datetime update_time "更新时间，记录最后修改时间"
}
devices {
bigint id PK "主键ID，自增长"
varchar device_no UK "设备编号，唯一标识，如：DEV001"
varchar device_name "设备名称，如：一楼门禁机"
varchar device_type "设备类型：考勤机/门禁/摄像头/移动端"
varchar ip_address "设备IP地址，用于网络通信"
varchar mac_address "设备MAC地址，用于设备识别"
tinyint status "状态：0-离线，1-在线"
varchar install_location "安装位置，如：一楼大厅"
datetime create_time "创建时间，记录设备注册时间"
datetime update_time "更新时间，记录最后修改时间"
}
shifts {
bigint id PK "主键ID，自增长"
varchar shift_name "班次名称，如：标准班、夜班、弹性班"
varchar shift_code "班次编码，唯一标识，如：SHIFT001"
varchar shift_type "班次类型：规律班次/弹性班次/三班倒/四班三倒"
varchar cycle_unit "周期单位：天/周/月，用于轮班计算"
int cycle_count "周期数，如：7天一个周期"
decimal flexible_hours "弹性工作时间(小时)，如：2.0小时"
decimal core_hours "核心工作时间(小时)，如：6.0小时"
json shift_config_json "班次配置JSON，包含详细班次规则"
tinyint status "状态：0-禁用，1-启用"
datetime create_time "创建时间，记录班次创建时间"
datetime update_time "更新时间，记录最后修改时间"
}
%% 考勤数据模块关联关系
employees ||--o{ clock_records : "employee_id"
employees ||--o{ attendance_results : "employee_id"
employees ||--o{ attendance_summaries : "employee_id"
employees ||--o{ attendance_warning_records : "employee_id"
employees ||--o{ attendance_warning_records : "handler_id"
devices ||--o{ clock_records : "device_id"
shifts ||--o{ attendance_results : "shift_id"
attendance_rules ||--o{ attendance_warning_records : "rule_id"
```

**图表来源**
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)

**章节来源**
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)

## 核心组件
考勤系统的核心组件包括排班管理、打卡记录、考勤计算和报表统计等模块。系统通过RESTful API提供服务，支持与门禁系统、移动端应用等外部系统的集成。

**章节来源**
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)
- [考勤规则配置.md](file://documentation\03-业务模块\考勤\考勤规则配置.md)

## 架构概述
考勤系统采用微服务架构，与其他系统通过API网关进行通信。系统内部采用四层架构模式，确保业务逻辑的清晰分离和可维护性。

```mermaid
graph TB
subgraph "前端"
UI[用户界面]
MobileApp[移动应用]
end
subgraph "API网关"
Gateway[API Gateway]
end
subgraph "考勤服务"
AttendanceService[Attendance Service]
AttendanceController[Controller]
AttendanceServiceLayer[Service]
AttendanceManager[Manager]
AttendanceDAO[DAO]
end
subgraph "数据存储"
MySQL[(MySQL)]
Redis[(Redis)]
end
UI --> Gateway
MobileApp --> Gateway
Gateway --> AttendanceService
AttendanceService --> MySQL
AttendanceService --> Redis
```

**图表来源**
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)

## 详细组件分析
### 排班管理分析
排班管理模块负责处理员工的班次安排和调班申请。系统支持多种班次类型，包括规律班次、弹性班次、三班倒和四班三倒等。

#### 排班管理类图
```mermaid
classDiagram
class AttendanceShiftEntity {
+Long id
+String shiftNo
+Long employeeId
+String employeeName
+LocalDate shiftDate
+Long originalShiftId
+Long targetShiftId
+String reason
+String status
+String approvalComment
+LocalDateTime approvalTime
+String remark
+Long workflowInstanceId
}
class AttendanceShiftForm {
+Long employeeId
+LocalDate shiftDate
+Long originalShiftId
+Long targetShiftId
+String reason
+String remark
}
class AttendanceShiftService {
+AttendanceShiftEntity submitShiftApplication(AttendanceShiftForm form)
+void updateShiftStatus(String shiftNo, String status, String approvalComment)
}
class AttendanceShiftController {
-AttendanceShiftService attendanceShiftService
+ResponseDTO<AttendanceShiftEntity> submitShiftApplication(AttendanceShiftForm form)
+ResponseDTO<Void> updateShiftStatus(String shiftNo, Map<String, Object> requestParams)
}
AttendanceShiftController --> AttendanceShiftService : "依赖"
AttendanceShiftService --> AttendanceShiftEntity : "创建"
AttendanceShiftController --> AttendanceShiftForm : "使用"
```

**图表来源**
- [AttendanceShiftEntity.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\domain\entity\AttendanceShiftEntity.java)
- [AttendanceShiftController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceShiftController.java)
- [AttendanceShiftServiceImpl.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\service\impl\AttendanceShiftServiceImpl.java)

**章节来源**
- [AttendanceShiftEntity.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\domain\entity\AttendanceShiftEntity.java)
- [AttendanceShiftController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceShiftController.java)
- [AttendanceShiftServiceImpl.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\service\impl\AttendanceShiftServiceImpl.java)

### 打卡记录分析
打卡记录模块负责处理员工的打卡数据，支持多种打卡方式，包括考勤机、门禁系统和移动端应用。

#### 打卡记录序列图
```mermaid
sequenceDiagram
participant Device as "考勤设备"
participant Controller as "AttendanceRecordController"
participant Service as "AttendanceRecordService"
participant DAO as "AttendanceRecordDao"
participant DB as "数据库"
Device->>Controller : POST /api/v1/attendance/record/create
Controller->>Controller : 验证请求参数
Controller->>Service : createAttendanceRecord(form)
Service->>Service : 处理打卡记录
Service->>DAO : insert(record)
DAO->>DB : 执行插入操作
DB-->>DAO : 返回结果
DAO-->>Service : 返回结果
Service-->>Controller : 返回结果
Controller-->>Device : 返回成功响应
```

**图表来源**
- [AttendanceRecordController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceRecordController.java)

**章节来源**
- [AttendanceRecordController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceRecordController.java)

### 补卡申请分析
补卡申请模块处理员工的补卡请求，支持完整的审批流程。

#### 补卡申请类图
```mermaid
classDiagram
class AttendanceSupplementEntity {
+Long id
+String supplementNo
+Long employeeId
+String employeeName
+LocalDate supplementDate
+LocalTime punchTime
+String punchType
+String reason
+String status
+String approvalComment
+LocalDateTime approvalTime
+String remark
+Long workflowInstanceId
}
class AttendanceSupplementForm {
+Long employeeId
+LocalDate supplementDate
+LocalTime punchTime
+String punchType
+String reason
+String remark
}
class AttendanceSupplementService {
+AttendanceSupplementEntity submitSupplementApplication(AttendanceSupplementForm form)
+void updateSupplementStatus(String supplementNo, String status, String approvalComment)
}
class AttendanceSupplementController {
-AttendanceSupplementService attendanceSupplementService
+ResponseDTO<AttendanceSupplementEntity> submitSupplementApplication(AttendanceSupplementForm form)
+ResponseDTO<Void> updateSupplementStatus(String supplementNo, Map<String, Object> requestParams)
}
AttendanceSupplementController --> AttendanceSupplementService : "依赖"
AttendanceSupplementService --> AttendanceSupplementEntity : "创建"
AttendanceSupplementController --> AttendanceSupplementForm : "使用"
```

**图表来源**
- [AttendanceSupplementEntity.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\domain\entity\AttendanceSupplementEntity.java)
- [AttendanceSupplementController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceSupplementController.java)

**章节来源**
- [AttendanceSupplementEntity.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\domain\entity\AttendanceSupplementEntity.java)
- [AttendanceSupplementController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceSupplementController.java)

## 依赖分析
考勤系统依赖于多个外部系统和内部组件，包括员工信息管理、门禁系统、通知系统等。

```mermaid
graph TD
AttendanceService[考勤服务] --> CommonService[公共服务]
AttendanceService --> DeviceCommService[设备通讯服务]
AttendanceService --> AccessService[门禁服务]
AttendanceService --> NotificationService[通知服务]
AttendanceService --> WorkflowService[工作流服务]
AttendanceService --> MySQL[MySQL数据库]
AttendanceService --> Redis[Redis缓存]
```

**图表来源**
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)

**章节来源**
- [考勤系统数据库ER图设计.md](file://documentation\03-业务模块\各业务模块文档\考勤\考勤系统数据库ER图设计.md)

## 性能考虑
考勤系统在设计时考虑了高性能和高可用性，采用了多种优化策略，包括缓存机制、异步处理和数据库优化等。

## 故障排除指南
当考勤系统出现问题时，可以按照以下步骤进行排查：
1. 检查API网关是否正常运行
2. 检查考勤服务的健康状态
3. 检查数据库连接是否正常
4. 查看系统日志，定位具体问题

**章节来源**
- [AttendanceRecordController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceRecordController.java)
- [AttendanceShiftController.java](file://microservices\ioedream-attendance-service\src\main\java\net\lab1024\sa\attendance\controller\AttendanceShiftController.java)

## 结论
考勤系统是一个功能完整、架构清晰的微服务，能够满足企业对考勤管理的各种需求。系统通过灵活的规则配置和强大的集成能力，为企业提供了高效的考勤解决方案。