# 存储架构设计

<cite>
**本文档引用文件**   
- [VideoDeviceController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoDeviceController.java)
- [VideoDeviceServiceImpl.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\service\impl\VideoDeviceServiceImpl.java)
- [VideoPlayController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoPlayController.java)
- [VideoPlayServiceImpl.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\service\impl\VideoPlayServiceImpl.java)
- [application.yml](file://microservices\ioedream-video-service\src\main\resources\application.yml)
- [video_index_optimization.sql](file://microservices\ioedream-video-service\src\main\resources\sql\video_index_optimization.sql)
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)
- [PROTOCOL_ARCHITECTURE.md](file://microservices\ioedream-device-comm-service\docs\PROTOCOL_ARCHITECTURE.md)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档详细描述了视频存储架构的设计，包括分布式存储集群的拓扑结构、主从节点配置、数据分片策略、多副本冗余机制、高可用设计、故障转移流程、元数据管理方案、索引结构、存储容量规划计算公式、扩展策略以及与视频编码和传输协议的集成设计。

## 项目结构
项目结构包括多个微服务，其中`ioedream-video-service`负责视频监控和录像回放等业务API，`ioedream-device-comm-service`负责设备通讯和协议处理。

```mermaid
graph TB
subgraph "前端"
Web[Web前端]
end
subgraph "应用服务"
Gateway[API网关]
VideoService[视频服务]
DeviceCommService[设备通讯服务]
end
subgraph "数据存储"
PrimaryDB[主数据库]
SecondaryDB[从数据库]
CacheCluster[缓存集群]
ObjectStorage[对象存储]
end
Web --> Gateway
Gateway --> VideoService
Gateway --> DeviceCommService
VideoService --> PrimaryDB
VideoService --> SecondaryDB
VideoService --> CacheCluster
DeviceCommService --> PrimaryDB
DeviceCommService --> SecondaryDB
DeviceCommService --> CacheCluster
PrimaryDB --> ObjectStorage
SecondaryDB --> ObjectStorage
```

**图表来源**
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)

**章节来源**
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)

## 核心组件
核心组件包括视频设备管理、视频播放管理、设备通讯服务等。视频设备管理提供设备的CRUD操作、状态管理和查询统计，视频播放管理提供实时视频流播放、录像回放和视频截图，设备通讯服务处理设备协议和连接管理。

**章节来源**
- [VideoDeviceController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoDeviceController.java)
- [VideoPlayController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoPlayController.java)
- [PROTOCOL_ARCHITECTURE.md](file://microservices\ioedream-device-comm-service\docs\PROTOCOL_ARCHITECTURE.md)

## 架构概述
系统采用微服务架构，视频服务和设备通讯服务通过Nacos进行服务发现和配置管理。视频服务提供视频监控和录像回放API，设备通讯服务处理设备协议和连接管理。数据存储层采用主从数据库架构，支持读写分离和故障转移。

```mermaid
graph TB
subgraph "负载均衡层"
Nginx[Nginx]
HAProxy[HAProxy]
F5[F5]
end
subgraph "应用服务层"
WebFrontend[Web前端]
APIGateway[API网关]
MicroserviceCluster[微服务集群]
AIService[AI服务]
MessageQueue[RabbitMQ]
ScheduledTask[Quartz]
end
subgraph "数据存储层"
PrimaryDatabase[主数据库]
SecondaryDatabase[从数据库]
CacheCluster[缓存集群]
ObjectStorage[HDFS]
FileSystem[NAS]
SearchEngine[Elastic]
end
subgraph "设备接入层"
VideoSurveillance[视频监控]
RecordingStorage[录像存储]
DisplaySplicing[显示拼接]
ManagementNetwork[管理网]
IoTNetwork[物联网]
WirelessNetwork[无线网]
end
Nginx --> WebFrontend
HAProxy --> APIGateway
F5 --> MicroserviceCluster
WebFrontend --> APIGateway
APIGateway --> MicroserviceCluster
MicroserviceCluster --> AIService
MicroserviceCluster --> MessageQueue
MicroserviceCluster --> ScheduledTask
MicroserviceCluster --> PrimaryDatabase
MicroserviceCluster --> SecondaryDatabase
MicroserviceCluster --> CacheCluster
PrimaryDatabase --> ObjectStorage
PrimaryDatabase --> FileSystem
PrimaryDatabase --> SearchEngine
SecondaryDatabase --> ObjectStorage
SecondaryDatabase --> FileSystem
SecondaryDatabase --> SearchEngine
VideoSurveillance --> PrimaryDatabase
RecordingStorage --> ObjectStorage
DisplaySplicing --> FileSystem
ManagementNetwork --> WebFrontend
IoTNetwork --> MessageQueue
WirelessNetwork --> APIGateway
```

**图表来源**
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)

## 详细组件分析
### 视频设备管理分析
视频设备管理组件负责设备的CRUD操作、状态管理和查询统计。通过`VideoDeviceController`提供API接口，`VideoDeviceServiceImpl`实现业务逻辑。

#### 类图
```mermaid
classDiagram
class VideoDeviceController {
+videoDeviceService : VideoDeviceService
+queryDevices(pageNum, pageSize, keyword, areaId, status) : ResponseDTO~PageResult~VideoDeviceVO~~
+getDeviceDetail(deviceId) : ResponseDTO~VideoDeviceVO~
}
class VideoDeviceService {
<<interface>>
+queryDevices(queryForm : VideoDeviceQueryForm) : PageResult~VideoDeviceVO~
+getDeviceDetail(deviceId : Long) : VideoDeviceVO
}
class VideoDeviceServiceImpl {
+deviceDao : DeviceDao
+queryDevices(queryForm : VideoDeviceQueryForm) : PageResult~VideoDeviceVO~
+getDeviceDetail(deviceId : Long) : VideoDeviceVO
+convertToVO(entity : DeviceEntity) : VideoDeviceVO
}
class DeviceDao {
<<interface>>
+selectPage(page : Page, wrapper : LambdaQueryWrapper) : Page~DeviceEntity~
+selectById(id : Long) : DeviceEntity
}
VideoDeviceController --> VideoDeviceService : "依赖"
VideoDeviceServiceImpl --> DeviceDao : "依赖"
VideoDeviceServiceImpl --> VideoDeviceService : "实现"
VideoDeviceController --> VideoDeviceServiceImpl : "使用"
```

**图表来源**
- [VideoDeviceController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoDeviceController.java)
- [VideoDeviceServiceImpl.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\service\impl\VideoDeviceServiceImpl.java)

**章节来源**
- [VideoDeviceController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoDeviceController.java)
- [VideoDeviceServiceImpl.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\service\impl\VideoDeviceServiceImpl.java)

### 视频播放管理分析
视频播放管理组件负责实时视频流播放、录像回放和视频截图。通过`VideoPlayController`提供API接口，`VideoPlayServiceImpl`实现业务逻辑。

#### 类图
```mermaid
classDiagram
class VideoPlayController {
+videoPlayService : VideoPlayService
+getVideoStream(deviceId, channelId, streamType) : ResponseDTO~Map~String, Object~~
+getSnapshot(deviceId, channelId) : ResponseDTO~Map~String, Object~~
}
class VideoPlayService {
<<interface>>
+getVideoStream(deviceId : Long, channelId : Long, streamType : String) : Map~String, Object~
+getSnapshot(deviceId : Long, channelId : Long) : Map~String, Object~
+getMobileDeviceList(areaId : String, deviceType : String, status : Integer) : VideoDeviceVO[]
}
class VideoPlayServiceImpl {
+deviceDao : DeviceDao
+videoDeviceService : VideoDeviceService
+getVideoStream(deviceId : Long, channelId : Long, streamType : String) : Map~String, Object~
+getSnapshot(deviceId : Long, channelId : Long) : Map~String, Object~
+getMobileDeviceList(areaId : String, deviceType : String, status : Integer) : VideoDeviceVO[]
+buildStreamUrl(device : DeviceEntity, channelId : Long, streamType : String, protocol : String) : String
+buildSnapshotUrl(device : DeviceEntity, channelId : Long) : String
+convertToVO(entity : DeviceEntity) : VideoDeviceVO
}
class DeviceDao {
<<interface>>
+selectById(id : Long) : DeviceEntity
+selectList(wrapper : LambdaQueryWrapper) : DeviceEntity[]
}
class VideoDeviceService {
<<interface>>
+getDeviceDetail(deviceId : Long) : VideoDeviceVO
}
VideoPlayController --> VideoPlayService : "依赖"
VideoPlayServiceImpl --> DeviceDao : "依赖"
VideoPlayServiceImpl --> VideoDeviceService : "依赖"
VideoPlayServiceImpl --> VideoPlayService : "实现"
VideoPlayController --> VideoPlayServiceImpl : "使用"
```

**图表来源**
- [VideoPlayController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoPlayController.java)
- [VideoPlayServiceImpl.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\service\impl\VideoPlayServiceImpl.java)

**章节来源**
- [VideoPlayController.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\controller\VideoPlayController.java)
- [VideoPlayServiceImpl.java](file://microservices\ioedream-video-service\src\main\java\net\lab1024\sa\video\service\impl\VideoPlayServiceImpl.java)

### 设备通讯服务分析
设备通讯服务处理设备协议和连接管理，支持多种设备厂商的PUSH协议，包括考勤、门禁和消费协议。

#### 序列图
```mermaid
sequenceDiagram
participant Device as "设备"
participant TcpPushServer as "TcpPushServer"
participant MessageRouter as "MessageRouter"
participant ProtocolAdapterFactory as "ProtocolAdapterFactory"
participant ProtocolHandler as "ProtocolHandler"
Device->>TcpPushServer : 发送协议数据
TcpPushServer->>MessageRouter : 转发消息
MessageRouter->>ProtocolAdapterFactory : 获取协议处理器
ProtocolAdapterFactory->>ProtocolHandler : 返回处理器
MessageRouter->>ProtocolHandler : 处理协议数据
ProtocolHandler-->>MessageRouter : 返回处理结果
MessageRouter-->>TcpPushServer : 返回结果
TcpPushServer-->>Device : 返回响应
```

**图表来源**
- [PROTOCOL_ARCHITECTURE.md](file://microservices\ioedream-device-comm-service\docs\PROTOCOL_ARCHITECTURE.md)

**章节来源**
- [PROTOCOL_ARCHITECTURE.md](file://microservices\ioedream-device-comm-service\docs\PROTOCOL_ARCHITECTURE.md)

## 依赖分析
系统依赖于Nacos进行服务发现和配置管理，RabbitMQ进行消息队列处理，PostgreSQL作为主从数据库，Redis作为缓存集群，HDFS作为对象存储，NAS作为文件系统，Elastic作为搜索引擎。

```mermaid
graph TD
VideoService --> Nacos
VideoService --> RabbitMQ
VideoService --> PostgreSQL
VideoService --> Redis
VideoService --> HDFS
VideoService --> NAS
VideoService --> Elastic
DeviceCommService --> Nacos
DeviceCommService --> RabbitMQ
DeviceCommService --> PostgreSQL
DeviceCommService --> Redis
DeviceCommService --> HDFS
DeviceCommService --> NAS
DeviceCommService --> Elastic
```

**图表来源**
- [application.yml](file://microservices\ioedream-video-service\src\main\resources\application.yml)
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)

**章节来源**
- [application.yml](file://microservices\ioedream-video-service\src\main\resources\application.yml)

## 性能考虑
系统通过多级缓存、读写分离、分库分表、异步处理等策略提升性能。多级缓存包括本地缓存、分布式缓存和数据库缓存，读写分离采用主从架构，分库分表支持海量数据，异步处理使用消息队列处理耗时任务。

**章节来源**
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)

## 故障排除指南
故障排除包括服务启动失败、数据库连接失败、缓存失效、消息队列阻塞等问题。通过日志分析、监控告警、服务熔断等机制进行故障排查和恢复。

**章节来源**
- [01-项目概述与系统架构.md](file://documentation\03-业务模块\智能视频\01-项目概述与系统架构.md)

## 结论
本文档详细描述了视频存储架构的设计，包括分布式存储集群的拓扑结构、主从节点配置、数据分片策略、多副本冗余机制、高可用设计、故障转移流程、元数据管理方案、索引结构、存储容量规划计算公式、扩展策略以及与视频编码和传输协议的集成设计。系统采用微服务架构，通过Nacos进行服务发现和配置管理，RabbitMQ进行消息队列处理，PostgreSQL作为主从数据库，Redis作为缓存集群，HDFS作为对象存储，NAS作为文件系统，Elastic作为搜索引擎，实现了高可用、高性能、可扩展的视频存储系统。