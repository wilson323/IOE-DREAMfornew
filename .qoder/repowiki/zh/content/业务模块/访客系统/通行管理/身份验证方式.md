# 身份验证方式

<cite>
**本文档引用的文件**   
- [verification.vue](file://smart-admin-web-javascript\src\views\business\visitor\verification.vue)
- [VisitorMobileController.java](file://microservices\ioedream-visitor-service\src\main\java\net\lab1024\sa\visitor\controller\VisitorMobileController.java)
- [VisitorController.java](file://microservices\ioedream-visitor-service\src\main\java\net\lab1024\sa\visitor\controller\VisitorController.java)
- [VisitorAppointmentEntity.java](file://microservices\ioedream-visitor-service\src\main\java\net\lab1024\sa\visitor\domain\entity\VisitorAppointmentEntity.java)
- [visitor-api.js](file://smart-app\src\api\business\visitor\visitor-api.js)
- [12-前端API接口设计.md](file://documentation\03-业务模块\访客\12-前端API接口设计.md)
- [13-前端移动端组件设计.md](file://documentation\03-业务模块\访客\13-前端移动端组件设计.md)
- [BiometricMobileController.java](file://restful_refactor_backup_20251202_014224\microservices_ioedream-access-service_src_main_java_net_lab1024_sa_access_controller_BiometricMobileController.java)
- [门禁系统\功能概述.md](file://documentation\03-业务模块\门禁系统\功能概述.md)
- [pom.xml](file://microservices\ioedream-visitor-service\pom.xml)
</cite>

## 目录
1. [二维码验证方式](#二维码验证方式)
2. [人脸识别验证方式](#人脸识别验证方式)
3. [身份证验证方式](#身份证验证方式)
4. [性能指标对比与适用场景](#性能指标对比与适用场景)
5. [多因素认证组合使用](#多因素认证组合使用)

## 二维码验证方式

二维码验证是访客身份验证的主要方式之一，通过扫描访客预约生成的二维码来完成身份核验。系统为每位预约的访客生成唯一的访客码（visitCode），该码在预约创建时生成，并与访客的预约信息绑定。

### 二维码生成算法
系统采用标准的QR Code编码算法生成二维码。二维码内容包含访客的唯一预约编号（visitCode），该编号由系统自动生成，遵循`VCYYYYMMDDXXXXX`的格式，其中`YYYYMMDD`代表预约日期，`XXXXX`为当日的序列号。二维码生成过程在访客预约成功后触发，通过后端服务生成，并通过移动端或PC端展示给访客。

### 有效期控制
二维码的有效期与访客预约的有效期严格绑定。预约信息中包含`appointmentStartTime`和`appointmentEndTime`两个时间戳，二维码仅在该时间段内有效。系统在验证时会检查当前时间是否在有效期内，超出有效期的二维码将被拒绝。此外，二维码在访客完成签到（check-in）后即失效，防止重复使用。

### 防伪机制
为了防止二维码被伪造或滥用，系统实施了多重防伪机制：
1.  **唯一性**：每个访客码（visitCode）在系统中全局唯一，且与特定的预约记录关联。
2.  **状态绑定**：二维码的状态与预约状态（status）绑定，如“待审批”、“已通过”、“已签到”等。只有状态为“已通过”且未签到的预约，其二维码才能通过验证。
3.  **设备信息校验**：验证请求中包含设备信息（如设备ID、名称、位置），用于审计和追踪。
4.  **黑名单机制**：系统维护一个黑名单，对于被取消或拒绝的预约，其对应的访客码会被加入黑名单，无法再使用。

**Section sources**
- [VisitorAppointmentEntity.java](file://microservices\ioedream-visitor-service\src\main\java\net\lab1024\sa\visitor\domain\entity\VisitorAppointmentEntity.java#L73-L78)
- [12-前端API接口设计.md](file://documentation\03-业务模块\访客\12-前端API接口设计.md#L195-L203)
- [verification.vue](file://smart-admin-web-javascript\src\views\business\visitor\verification.vue#L119-L147)

## 人脸识别验证方式

人脸识别验证是一种高安全性的生物特征验证方式，利用访客的面部特征进行身份核验。该功能主要在移动端和自助终端上使用。

### 调用流程
人脸识别的调用流程如下：
1.  **前端采集**：移动端或终端设备通过摄像头采集访客的实时人脸图像。
2.  **上传验证**：前端将采集到的人脸图像文件（`MultipartFile`）和访客码（`visitCode`）通过HTTP POST请求发送至后端API。
3.  **后端处理**：后端服务（`BiometricMobileController`）接收请求，调用生物特征服务（`biometricService`）进行人脸识别。
4.  **结果返回**：生物特征服务将比对结果（包含匹配分数、是否通过等信息）返回给前端。

核心API端点为`/biometric/mobile/face/verify`，接收`faceImage`和`userId`（可选）作为参数。

### 比对阈值设置
人脸识别的准确性通过设置比对阈值（match threshold）来控制。系统会计算访客实时人脸与系统中预存人脸特征的相似度得分（matchScore），该得分是一个0到1之间的浮点数。系统设定一个阈值（例如0.85），当`matchScore`大于或等于该阈值时，判定为验证通过。阈值的设置需要在安全性和用户体验之间取得平衡，过高的阈值可能导致合法访客被拒绝（拒真率高），过低的阈值则可能增加冒用风险（认假率高）。

### 活体检测策略
为防止使用照片、视频等非活体方式进行欺骗，系统集成了活体检测（Liveness Detection）策略。活体检测通常采用以下一种或多种方式：
1.  **动作指令**：要求访客完成特定动作，如眨眼、点头、微笑或转头。系统通过分析连续帧中的人脸变化来判断是否为活体。
2.  **挑战-响应**：系统生成一个随机的挑战（如“请向左转头”），并检测访客是否按要求执行。
3.  **反欺骗算法**：利用深度学习模型分析图像的纹理、深度、光流等特征，区分真实人脸与照片、屏幕等平面介质。

在验证结果的响应数据中，会包含`livenessCheck`字段，明确标识活体检测是否通过。

**Section sources**
- [BiometricMobileController.java](file://restful_refactor_backup_20251202_014224\microservices_ioedream-access-service_src_main_java_net_lab1024_sa_access_controller_BiometricMobileController.java#L55-L63)
- [13-前端移动端组件设计.md](file://documentation\03-业务模块\访客\13-前端移动端组件设计.md#L2790-L2833)
- [门禁系统\功能概述.md](file://documentation\03-业务模块\门禁系统\功能概述.md#L491-L505)

## 身份证验证方式

身份证验证通过读取和识别访客的身份证信息来完成身份核验，通常与手机号结合使用以确保信息的准确性。

### 集成方法
身份证验证的集成主要依赖于腾讯云OCR SDK。具体流程如下：
1.  **前端采集**：访客在移动端或自助终端上拍摄身份证正反面照片。
2.  **OCR识别**：前端将身份证图片上传至后端的`/api/v1/mobile/visitor/ocr/idcard`接口。
3.  **后端调用**：后端服务（`VisitorMobileController`）接收到图片后，调用`OcrService`，该服务内部使用腾讯云OCR SDK的API进行文字识别。
4.  **信息比对**：OCR服务返回识别出的姓名、身份证号等信息，后端服务将这些信息与数据库中预约的访客信息进行比对，验证其一致性。

### 数据加密传输方案
为确保身份证等敏感个人信息在传输过程中的安全，系统采用了以下加密传输方案：
1.  **HTTPS协议**：所有涉及身份证信息的API接口均通过HTTPS协议进行通信，利用SSL/TLS加密通道，防止数据在传输过程中被窃听或篡改。
2.  **数据脱敏**：在日志记录和非必要场景下，对身份证号等敏感信息进行脱敏处理（如显示为`110101********1234`）。
3.  **最小化原则**：系统仅在必要时传输完整的身份证信息，且信息在完成验证后不会在前端或中间件中长期存储。

**Section sources**
- [VisitorMobileController.java](file://microservices\ioedream-visitor-service\src\main\java\net\lab1024\sa\visitor\controller\VisitorMobileController.java#L220-L232)
- [pom.xml](file://microservices\ioedream-visitor-service\pom.xml#L92-L97)
- [12-前端API接口设计.md](file://documentation\03-业务模块\访客\12-前端API接口设计.md#L1002-L1010)

## 性能指标对比与适用场景

下表对比了三种主要验证方式的性能指标和适用场景：

| 验证方式 | 平均响应时间 | 准确率 | 支持并发 | 适用场景 | 优点 | 缺点 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **二维码验证** | <100ms | 100% | 高 | 通用认证、快速通行 | 实现简单、速度快、成本低 | 依赖手机或打印件，易丢失或被他人使用 |
| **人脸识别** | <300ms | 99.99% | 中 | 主要出入口、高安全区域 | 无接触、便捷、安全性高 | 受光线、角度、遮挡物影响，需活体检测 |
| **身份证验证** | <500ms | 99.5% | 中 | 实名核验、前台登记 | 信息权威、可验证身份真实性 | 依赖OCR识别准确率，需拍摄清晰照片 |

**Section sources**
- [门禁系统\功能概述.md](file://documentation\03-业务模块\门禁系统\功能概述.md#L1349-L1356)

## 多因素认证组合使用

为满足不同安全等级区域的需求，系统支持多因素认证（Multi-Factor Authentication, MFA）的组合使用。多因素认证结合了“你知道的”（如密码）、“你拥有的”（如手机、二维码）和“你本身的”（如人脸、指纹）三种因素中的两种或以上。

### 组合策略
系统根据区域的安全级别（Security Level）自动配置认证策略：
*   **低安全级别**：仅需一种方式，如刷卡或二维码。
*   **中安全级别**：一种主要方式（如刷卡）加一种可选方式（如人脸识别）。
*   **高安全级别**：必需人脸识别，并可选指纹作为补充。
*   **最高安全级别**：必需人脸识别和指纹识别，且必须通过活体检测，不允许降级。

### 实现方式
多因素认证的实现通常采用**顺序验证**或**多模态融合**：
1.  **顺序验证**：系统按预设顺序依次要求访客完成多种验证。例如，先扫描二维码，再进行人脸识别。任一环节失败，整个认证过程即告失败。
2.  **多模态融合**：系统同时或在短时间内收集多种生物特征（如人脸和指纹），然后通过融合算法计算一个综合的认证分数。只有当综合分数超过阈值时，才判定为通过。这种方式能有效提高系统的鲁棒性和安全性。

**Section sources**
- [门禁系统\功能概述.md](file://documentation\03-业务模块\门禁系统\功能概述.md#L758-L815)