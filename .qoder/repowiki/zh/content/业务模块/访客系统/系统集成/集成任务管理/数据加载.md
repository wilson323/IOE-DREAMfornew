# 数据加载

<cite>
**本文档引用的文件**   
- [00-database-init.sql](file://database-scripts/common-service/00-database-init.sql)
- [02-t_user.sql](file://database-scripts/common-service/02-t_user.sql)
- [03-t_role.sql](file://database-scripts/common-service/03-t_role.sql)
- [04-t_permission.sql](file://database-scripts/common-service/04-t_permission.sql)
- [05-t_user_role.sql](file://database-scripts/common-service/05-t_user_role.sql)
- [06-t_role_permission.sql](file://database-scripts/common-service/06-t_role_permission.sql)
- [07-t_notification_message.sql](file://database-scripts/common-service/07-t_notification_message.sql)
- [08-t_notification_template.sql](file://database-scripts/common-service/08-t_notification_template.sql)
- [09-t_notification_config.sql](file://database-scripts/common-service/09-t_notification_config.sql)
- [10-t_audit_log.sql](file://database-scripts/common-service/10-t_audit_log.sql)
- [11-t_alert.sql](file://database-scripts/common-service/11-t_alert.sql)
- [12-t_alert_rule.sql](file://database-scripts/common-service/12-t_alert_rule.sql)
- [13-t_system_monitor.sql](file://database-scripts/common-service/13-t_system_monitor.sql)
- [14-t_scheduled_job.sql](file://database-scripts/common-service/14-t_scheduled_job.sql)
- [15-t_job_execution_log.sql](file://database-scripts/common-service/15-t_job_execution_log.sql)
- [16-t_system_config.sql](file://database-scripts/common-service/16-t_system_config.sql)
- [17-t_system_dict.sql](file://database-scripts/common-service/17-t_system_dict.sql)
- [18-t_employee.sql](file://database-scripts/common-service/18-t_employee.sql)
- [DAO模板.md](file://documentation/06-模板工具/代码模板/DAO模板.md)
- [Service模板.md](file://documentation/06-模板工具/代码模板/Service模板.md)
- [ARCHITECTURE_REFACTORING_PLAN.md](file://documentation/architecture/ARCHITECTURE_REFACTORING_PLAN.md)
- [MANAGER_TRANSACTION_FIX_FINAL_COMPLETE.md](file://documentation/archive/reports-2025-12-04/MANAGER_TRANSACTION_FIX_FINAL_COMPLETE.md)
</cite>

## 目录
1. [引言](#引言)
2. [数据库表结构映射机制](#数据库表结构映射机制)
3. [数据写入策略](#数据写入策略)
4. [事务管理机制](#事务管理机制)
5. [性能优化建议](#性能优化建议)
6. [数据完整性校验](#数据完整性校验)
7. [结论](#结论)

## 引言
本文档详细阐述了IOE-DREAM系统中数据加载模块的设计与实现。该模块负责将数据从源系统加载到目标数据库，确保数据的一致性、完整性和性能。文档涵盖了目标数据库表结构的映射机制、数据写入策略、事务管理、性能优化以及数据完整性校验等关键方面。

## 数据库表结构映射机制

### 目标数据库表结构
IOE-DREAM系统的数据库表结构遵循统一的命名和设计规范。所有表均以`t_`为前缀，后跟模块名称和实体名称。例如，用户表命名为`t_user`，角色表命名为`t_role`。每个表都包含标准的审计字段，如`create_time`、`update_time`、`create_user_id`、`update_user_id`和`deleted_flag`，以支持数据的创建、更新和软删除操作。

### 表结构定义
数据库脚本位于`database-scripts/common-service/`目录下，按顺序编号执行。每个SQL文件定义了一个表的结构，包括字段、数据类型、约束和索引。以下是部分核心表的结构定义：

```sql
-- 用户表
CREATE TABLE IF NOT EXISTS `t_user` (
    `user_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名（登录用）',
    `password` VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
    `email` VARCHAR(100) NOT NULL COMMENT '邮箱',
    -- ... 其他字段
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted_flag` TINYINT NOT NULL DEFAULT 0 COMMENT '删除标记：0-未删除 1-已删除',
    PRIMARY KEY (`user_id`),
    UNIQUE KEY `uk_username` (`username`),
    UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表-系统账户管理';
```

```sql
-- 角色表
CREATE TABLE IF NOT EXISTS `t_role` (
    `role_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '角色ID',
    `role_code` VARCHAR(50) NOT NULL COMMENT '角色编码',
    `role_name` VARCHAR(100) NOT NULL COMMENT '角色名称',
    -- ... 其他字段
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted_flag` TINYINT NOT NULL DEFAULT 0 COMMENT '删除标记：0-未删除 1-已删除',
    PRIMARY KEY (`role_id`),
    UNIQUE KEY `uk_role_code` (`role_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色表';
```

```sql
-- 权限表
CREATE TABLE IF NOT EXISTS `t_permission` (
    `permission_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '权限ID',
    `permission_code` VARCHAR(100) NOT NULL COMMENT '权限编码',
    `permission_name` VARCHAR(100) NOT NULL COMMENT '权限名称',
    -- ... 其他字段
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted_flag` TINYINT NOT NULL DEFAULT 0 COMMENT '删除标记：0-未删除 1-已删除',
    PRIMARY KEY (`permission_id`),
    UNIQUE KEY `uk_permission_code` (`permission_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='权限表';
```

### 自动建表与字段同步
系统支持通过数据库初始化脚本自动创建表结构。`00-database-init.sql`脚本负责创建数据库并设置字符集，后续的SQL脚本按顺序创建各个表。这种设计确保了表结构的一致性和可重复性。对于字段同步，系统通过DAO层的MyBatis-Plus框架实现。DAO接口继承`BaseMapper<Entity>`，利用MyBatis-Plus的自动映射功能，将Java实体类的字段与数据库表的列进行映射。当实体类字段发生变化时，需要手动更新SQL脚本以保持同步。

**Section sources**
- [00-database-init.sql](file://database-scripts/common-service/00-database-init.sql#L1-L51)
- [02-t_user.sql](file://database-scripts/common-service/02-t_user.sql#L1-L41)
- [03-t_role.sql](file://database-scripts/common-service/03-t_role.sql#L1-L29)
- [04-t_permission.sql](file://database-scripts/common-service/04-t_permission.sql#L1-L38)

## 数据写入策略

### 写入模式
系统支持多种数据写入模式，以满足不同的业务需求：

#### 全量覆盖
全量覆盖模式用于完全替换目标表中的数据。该模式通常在数据源发生重大变更或需要重新初始化数据时使用。实现方式是先删除目标表中的所有数据，然后插入新的数据集。

#### 增量追加
增量追加模式用于将新数据添加到目标表中，而不影响现有数据。该模式通过比较数据的创建时间或更新时间来识别新数据，并将其插入到目标表中。增量追加适用于日志、审计记录等持续增长的数据。

#### 更新插入（Upsert）
更新插入模式结合了更新和插入操作。当数据存在时，更新其内容；当数据不存在时，插入新记录。该模式通过唯一键（如`username`、`role_code`）来判断数据是否存在，并使用`ON DUPLICATE KEY UPDATE`语句实现。

### DAO层实现
DAO层使用MyBatis-Plus框架提供的`insert`、`updateById`和`insertOrUpdate`方法来实现不同的写入策略。例如，`insertBatch`方法用于批量插入数据，`batchUpdateStatus`方法用于批量更新状态。

```java
// 批量插入
int insertCount = {entity}Dao.insertBatch(entityList);

// 批量更新状态
int updateCount = {entity}Dao.batchUpdateStatus(ids, status, updateUserId);
```

**Section sources**
- [DAO模板.md](file://documentation/06-模板工具/代码模板/DAO模板.md#L13-L728)
- [Service模板.md](file://documentation/06-模板工具/代码模板/Service模板.md#L420-L730)

## 事务管理机制

### 事务边界
系统的事务管理遵循严格的规范。事务边界定义在Service层，而不是Manager层。Service层的方法使用`@Transactional(rollbackFor = Exception.class)`注解来管理事务。Manager层不管理事务，只负责业务逻辑的组装和调用。

### 事务注解
- **写操作**：使用`@Transactional(rollbackFor = Exception.class)`注解，确保在发生异常时回滚事务。
- **读操作**：使用`@Transactional(readOnly = true)`注解，提高查询性能并防止意外的写操作。

### 事务管理示例
```java
@Service
@RequiredArgsConstructor
@Transactional(rollbackFor = Exception.class)
public class {Entity}ServiceImpl implements {Entity}Service {

    private final {Entity}Dao {entity}Dao;
    private final {Entity}Manager {entity}Manager;

    @Override
    public String add({Entity}Form addForm) {
        // 事务内的写操作
        int insertCount = {entity}Dao.insert(entity);
        if (insertCount != 1) {
            throw new BusinessException("新增{实体名称}失败");
        }
        {entity}Manager.removeCache();
        return ResponseStringConst.SUCCESS;
    }

    @Override
    @Transactional(readOnly = true)
    public {Entity}Entity getById(Long id) {
        return {entity}Manager.getByIdWithCache(id);
    }
}
```

**Section sources**
- [ARCHITECTURE_REFACTORING_PLAN.md](file://documentation/architecture/ARCHITECTURE_REFACTORING_PLAN.md#L321-L350)
- [MANAGER_TRANSACTION_FIX_FINAL_COMPLETE.md](file://documentation/archive/reports-2025-12-04/MANAGER_TRANSACTION_FIX_FINAL_COMPLETE.md#L58-L97)

## 性能优化建议

### 批量提交
为了提高数据写入性能，系统采用批量提交策略。通过`insertBatch`方法一次性插入多条记录，减少数据库连接和事务开销。批量提交的大小应根据数据量和系统资源进行调整，避免内存溢出。

### 索引临时禁用
在进行大规模数据导入时，可以临时禁用非关键索引，以加快数据插入速度。数据导入完成后，重新启用索引并进行优化。此操作需谨慎执行，确保不会影响系统的正常运行。

### 连接池配置
系统使用Druid连接池，通过合理配置连接池参数（如初始连接数、最大连接数、最小空闲连接数等），提高数据库连接的复用率和性能。

### SQL优化
- **避免SELECT ***：明确指定需要查询的字段，减少数据传输量。
- **使用索引**：确保查询条件使用索引，提高查询效率。
- **分页查询**：大数据量查询时使用分页，避免一次性加载过多数据。

**Section sources**
- [DAO模板.md](file://documentation/06-模板工具/代码模板/DAO模板.md#L716-L721)
- [performance_optimization.sql](file://database/performance_optimization.sql)

## 数据完整性校验

### 校验机制
数据加载完成后，系统通过多种机制确保数据的完整性：

#### 唯一性校验
通过数据库的唯一键约束（如`uk_username`、`uk_email`）确保数据的唯一性。在插入或更新数据时，数据库会自动检查唯一性约束。

#### 外键约束
通过外键约束确保数据的引用完整性。例如，`t_user_role`表中的`user_id`和`role_id`字段分别引用`t_user`和`t_role`表的主键。

#### 业务规则校验
在Service层实现业务规则校验，确保数据符合业务逻辑。例如，在创建用户时，检查用户名和邮箱是否已存在。

### 校验实现
```java
private void checkDuplicate({Entity}Form form, Long excludeId) {
    LambdaQueryWrapper<{Entity}Entity> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper.eq({Entity}Entity::getDeletedFlag, false);
    queryWrapper.eq({Entity}Entity::getName, form.getName());

    if (excludeId != null) {
        queryWrapper.ne({Entity}Entity::getId, excludeId);
    }

    Long count = {entity}Dao.selectCount(queryWrapper);
    if (count > 0) {
        throw new BusinessException("名称已存在: " + form.getName());
    }
}
```

**Section sources**
- [Service模板.md](file://documentation/06-模板工具/代码模板/Service模板.md#L292-L304)

## 结论
本文档详细介绍了IOE-DREAM系统中数据加载模块的设计与实现。通过统一的数据库表结构映射机制、灵活的数据写入策略、严格的事务管理、有效的性能优化措施以及全面的数据完整性校验，系统能够高效、可靠地处理数据加载任务。这些设计和实现确保了数据的一致性、完整性和高性能，为系统的稳定运行提供了坚实的基础。