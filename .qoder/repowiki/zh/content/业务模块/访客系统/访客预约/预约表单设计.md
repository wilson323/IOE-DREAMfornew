# 预约表单设计

<cite>
**本文档引用文件**  
- [visitor-module-architecture.md](file://documentation/03-业务模块/访客/visitor-module-architecture.md)
- [visitor-api-contract.md](file://documentation/api/visitor/visitor-api-contract.md)
- [registration.vue](file://smart-admin-web-javascript/src/views/business/visitor/registration.vue)
- [AppointmentFormModal.vue](file://smart-admin-web-javascript/src/views/business/visitor/components/AppointmentFormModal.vue)
- [visitor-api.js](file://smart-admin-web-javascript/src/api/business/visitor/visitor-api.js)
- [visitor-api.js](file://smart-app/src/api/business/visitor/visitor-api.js)
- [13-前端移动端组件设计.md](file://documentation/03-业务模块/访客/13-前端移动端组件设计.md)
</cite>

## 目录
1. [引言](#引言)
2. [表单字段设计与验证规则](#表单字段设计与验证规则)
3. [前端表单组件实现](#前端表单组件实现)
4. [表单数据提交API接口](#表单数据提交api接口)
5. [移动端与桌面端用户体验一致性](#移动端与桌面端用户体验一致性)
6. [自定义表单字段扩展方法](#自定义表单字段扩展方法)
7. [结论](#结论)

## 引言

访客预约系统是智慧园区一卡通管理平台的核心功能之一，旨在为访客提供便捷的预约服务，同时为园区管理者提供高效的访客管理能力。本系统支持线上预约和现场登记两种模式，涵盖访客信息管理、预约审批、登记管理、通行记录和统计分析等完整业务流程。

系统采用前后端分离架构，前端包括基于Vue3的PC端管理后台和基于UniApp的移动端应用，后端采用Spring Boot微服务架构，通过标准化API接口进行通信。系统设计遵循四层架构规范（Controller-Service-Manager-DAO），确保代码结构清晰、职责分明。

**Section sources**
- [visitor-module-architecture.md](file://documentation/03-业务模块/访客/visitor-module-architecture.md#L1-L800)

## 表单字段设计与验证规则

访客预约表单是系统的核心数据入口，其字段设计需满足业务需求和数据完整性要求。表单主要包含访客信息、访问信息、被访人信息和附加信息四大类。

### 核心必填字段

| 字段名称 | 字段标识 | 数据类型 | 验证规则 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| 访客姓名 | visitorName | String | 必填，长度1-50字符 | 访客真实姓名 |
| 联系方式 | phone | String | 必填，符合中国大陆手机号格式 | 用于发送预约通知 |
| 访问事由 | purpose | String | 必填，长度1-200字符 | 访问目的简要说明 |
| 访问日期 | visitDate | LocalDate | 必填，必须是未来日期 | 访问的日期 |
| 开始时间 | startTime | LocalTime | 必填，时间格式HH:mm | 访问开始时间 |
| 结束时间 | endTime | LocalTime | 必填，时间格式HH:mm | 访问结束时间 |
| 被访人ID | intervieweeId | Long | 必填，必须存在 | 被访员工的系统ID |

### 后端验证规则

后端使用Jakarta Validation框架对表单数据进行严格验证，确保数据的完整性和正确性。核心验证规则如下：

```java
@Data
public class VisitorReservationForm {
    @NotNull(message = "访客ID不能为空")
    private Long visitorId;

    @NotNull(message = "被访人ID不能为空")
    private Long intervieweeId;

    @NotBlank(message = "访问目的不能为空")
    private String visitPurpose;

    @NotNull(message = "访问日期不能为空")
    @Future(message = "访问日期必须是未来日期")
    private LocalDate visitDate;

    @NotNull(message = "开始时间不能为空")
    private LocalTime startTime;

    @NotNull(message = "结束时间不能为空")
    private LocalTime endTime;
}
```

### 前端验证规则

前端在提交前进行实时验证，提供即时反馈。主要验证规则包括：
- **手机号验证**：使用正则表达式`/^1[3-9]\d{9}$/`验证手机号格式。
- **身份证号验证**：使用正则表达式`/^[1-9]\d{17}$/`验证身份证号格式。
- **时间逻辑验证**：确保结束时间晚于开始时间。
- **日期范围验证**：访问日期必须在当前日期之后，且不超过未来3个月。

**Section sources**
- [visitor-module-architecture.md](file://documentation/03-业务模块/访客/visitor-module-architecture.md#L2421-L2571)
- [13-前端移动端组件设计.md](file://documentation/03-业务模块/访客/13-前端移动端组件设计.md#L924-L952)

## 前端表单组件实现

前端表单组件采用Vue3 Composition API和Ant Design Vue组件库实现，支持响应式布局，确保在不同设备上均有良好的用户体验。

### 组件结构

表单采用多步骤向导模式，分为三个步骤：
1. **身份验证**：输入身份证号和手机号进行身份验证。
2. **信息登记**：填写完整的访客信息和访问信息。
3. **完成登记**：显示登记成功信息，并提供后续操作。

```vue
<template>
  <a-steps :current="currentStep" class="steps">
    <a-step title="身份验证" />
    <a-step title="信息登记" />
    <a-step title="完成登记" />
  </a-steps>

  <!-- 步骤1：身份验证 -->
  <div v-if="currentStep === 0" class="step-content">
    <a-form layout="vertical">
      <a-form-item label="身份证号" required>
        <a-input v-model:value="registrationForm.idCardNumber" placeholder="请输入身份证号" />
      </a-form-item>
      <a-form-item label="手机号" required>
        <a-input v-model:value="registrationForm.phoneNumber" placeholder="请输入手机号" />
      </a-form-item>
    </a-form>
  </div>

  <!-- 步骤2：信息登记 -->
  <div v-if="currentStep === 1" class="step-content">
    <a-form :model="registrationForm" layout="vertical">
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="访客姓名" required>
            <a-input v-model:value="registrationForm.visitorName" placeholder="请输入访客姓名" />
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item label="来访公司">
            <a-input v-model:value="registrationForm.company" placeholder="请输入来访公司" />
          </a-form-item>
        </a-col>
      </a-row>
      <!-- 其他表单项 -->
    </a-form>
  </div>
</template>
```

### 时间选择器集成

时间选择器使用`a-date-picker`组件，集成日期和时间选择功能，用户可以方便地选择访问日期和时间。

```vue
<a-form-item label="预约时间" required>
  <a-date-picker
    v-model:value="registrationForm.appointmentTime"
    show-time
    format="YYYY-MM-DD HH:mm"
    placeholder="选择预约时间"
    style="width: 100%"
  />
</a-date-picker>
```

### 错误提示机制

系统采用多层次的错误提示机制：
- **实时验证**：在用户输入时实时验证，输入错误时立即显示错误信息。
- **提交验证**：在提交表单时进行完整验证，汇总所有错误信息。
- **全局提示**：使用`message`组件显示全局提示信息，如成功、警告、错误等。

```javascript
const validateInfo = async () => {
  if (!registrationForm.idCardNumber || !registrationForm.phoneNumber) {
    message.warning('请输入身份证号和手机号');
    return;
  }
  // 其他验证逻辑
};
```

**Section sources**
- [registration.vue](file://smart-admin-web-javascript/src/views/business/visitor/registration.vue#L1-L278)
- [AppointmentFormModal.vue](file://smart-admin-web-javascript/src/views/business/visitor/components/AppointmentFormModal.vue#L1-L266)

## 表单数据提交API接口

表单数据通过RESTful API接口提交到后端服务，接口设计遵循统一的规范，确保前后端通信的稳定性和可维护性。

### API接口说明

| 接口 | 方法 | 路径 | 功能 |
| :--- | :--- | :--- | :--- |
| 创建预约 | POST | `/api/v1/mobile/visitor/appointment` | 创建新的访客预约 |
| 获取预约详情 | GET | `/api/v1/mobile/visitor/appointment/{appointmentId}` | 根据预约ID获取预约详细信息 |
| 查询我的预约 | GET | `/api/v1/mobile/visitor/my-appointments` | 查询当前用户的预约记录 |
| 访客签到 | POST | `/api/v1/mobile/visitor/checkin/{appointmentId}` | 访客到达后进行签到 |
| 访客签退 | POST | `/api/v1/mobile/visitor/checkout/{appointmentId}` | 访客离开后进行签退 |

### 请求参数

创建预约接口的请求参数如下：

```typescript
interface VisitorMobileForm {
  visitorName: string;        // 访客姓名
  visitorPhone: string;        // 访客手机号
  visitorIdCard?: string;     // 访客身份证号（可选）
  hostUserId: number;         // 接待人用户ID
  hostName: string;           // 接待人姓名
  visitPurpose: string;        // 访问目的
  visitDate: string;          // 访问日期（yyyy-MM-dd）
  visitStartTime: string;     // 访问开始时间（HH:mm）
  visitEndTime: string;       // 访问结束时间（HH:mm）
  areaIds?: string[];         // 访问区域ID列表（可选）
  deviceIds?: number[];       // 访问设备ID列表（可选）
  remark?: string;            // 备注（可选）
  attachments?: string[];     // 附件URL列表（可选）
}
```

### 响应格式

所有API接口统一使用`ResponseDTO<T>`格式，确保响应结构的一致性。

```typescript
interface ResponseDTO<T> {
  code: number;        // 业务状态码（200表示成功）
  message: string;     // 提示信息
  data: T;            // 响应数据
  timestamp: number;   // 时间戳
}
```

### 错误处理

系统定义了统一的错误码规范，便于前端进行错误处理：

| 错误码范围 | 类型 | 说明 |
| :--- | :--- | :--- |
| 200 | 成功 | 操作成功 |
| 400-499 | 客户端错误 | 参数错误、未授权、禁止访问 |
| 500-599 | 服务端错误 | 服务器内部错误 |
| 7000-7999 | 访客模块错误 | 访客相关业务错误 |

**Section sources**
- [visitor-api-contract.md](file://documentation/api/visitor/visitor-api-contract.md#L1-L420)
- [visitor-api.js](file://smart-admin-web-javascript/src/api/business/visitor/visitor-api.js#L1-L456)
- [visitor-api.js](file://smart-app/src/api/business/visitor/visitor-api.js#L1-L276)

## 移动端与桌面端用户体验一致性

为确保用户在不同设备上获得一致的体验，系统在设计和实现上采取了多项措施。

### 响应式布局

前端组件采用响应式设计，能够根据屏幕尺寸自动调整布局。在桌面端，表单采用多列布局，充分利用屏幕空间；在移动端，表单采用单列布局，确保操作便捷。

```scss
@media (max-width: 375px) {
  .appointment-form {
    .form-content {
      padding: 12px;
    }
    .form-section {
      padding: 12px;
      margin-bottom: 12px;
    }
  }
}
```

### 组件复用

核心表单组件在PC端和移动端复用，确保功能和交互的一致性。例如，访客信息输入、时间选择、文件上传等组件在两端保持一致。

### 交互一致性

- **导航模式**：两端均采用步骤向导模式，引导用户完成预约流程。
- **错误提示**：使用相同的提示组件和样式，确保用户在不同设备上获得一致的反馈。
- **加载状态**：在数据加载和提交时，显示相同的加载动画，提升用户体验。

### 功能适配

虽然核心功能保持一致，但根据设备特性进行了适当的功能适配：
- **移动端**：集成OCR识别功能，支持通过拍照识别身份证信息；集成生物识别功能，支持人脸识别和指纹识别。
- **桌面端**：支持批量导入访客信息，提高管理效率；提供更丰富的查询和筛选功能。

**Section sources**
- [13-前端移动端组件设计.md](file://documentation/03-业务模块/访客/13-前端移动端组件设计.md#L226-L1502)
- [registration.vue](file://smart-admin-web-javascript/src/views/business/visitor/registration.vue#L1-L278)

## 自定义表单字段扩展方法

系统支持通过配置化方式扩展表单字段，满足不同场景下的个性化需求。

### 扩展字段配置

通过在数据库中添加新的字段配置，可以动态扩展表单。例如，为特定类型的预约添加自定义字段。

```sql
-- 访客预约表单配置表
CREATE TABLE `t_visitor_form_config` (
  `config_id` BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '配置ID',
  `form_type` VARCHAR(50) NOT NULL COMMENT '表单类型',
  `field_name` VARCHAR(100) NOT NULL COMMENT '字段名称',
  `field_label` VARCHAR(100) NOT NULL COMMENT '字段标签',
  `field_type` VARCHAR(50) NOT NULL COMMENT '字段类型',
  `required` TINYINT DEFAULT 0 COMMENT '是否必填',
  `order_num` INT DEFAULT 0 COMMENT '排序号',
  `shelves_flag` TINYINT DEFAULT 1 COMMENT '启用状态'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='访客表单配置表';
```

### 前端动态渲染

前端根据后端返回的表单配置动态渲染表单字段，无需修改代码即可支持新字段。

```javascript
// 获取表单配置
const loadFormConfig = async () => {
  const result = await visitorApi.getFormConfig('VISITOR_APPOINTMENT');
  if (result.code === 200 && result.data) {
    formConfig.value = result.data;
  }
};

// 动态渲染表单字段
<template v-for="field in formConfig" :key="field.fieldName">
  <a-form-item :label="field.fieldLabel" :required="field.required">
    <component :is="getFieldComponent(field.fieldType)" v-model="formData[field.fieldName]" />
  </a-form-item>
</template>
```

### 后端数据存储

扩展字段的数据存储在`t_visitor_reservation`表的`custom_fields`字段中，以JSON格式存储，确保数据的灵活性和可扩展性。

```sql
ALTER TABLE `t_visitor_reservation` ADD COLUMN `custom_fields` TEXT COMMENT '自定义字段(JSON格式)';
```

**Section sources**
- [visitor-module-architecture.md](file://documentation/03-业务模块/访客/visitor-module-architecture.md#L374-L414)
- [13-前端移动端组件设计.md](file://documentation/03-业务模块/访客/13-前端移动端组件设计.md#L226-L1502)

## 结论

本文档详细阐述了访客预约表单的设计与实现，涵盖了表单字段设计、前端组件实现、API接口说明、用户体验一致性和扩展方法等关键方面。系统通过标准化的设计和灵活的架构，为访客提供了便捷的预约服务，为管理者提供了高效的管理工具。

未来，系统将进一步优化用户体验，增加智能推荐、自动审批等高级功能，提升系统的智能化水平。