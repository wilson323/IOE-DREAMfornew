# 通知系统实施

<cite>
**本文档引用文件**  
- [通知系统README.md](file://documentation/03-业务模块/通知系统README.md)
- [通知系统使用指南.md](file://documentation/03-业务模块/通知系统使用指南.md)
- [通知系统实施总结.md](file://documentation/03-业务模块/通知系统实施总结.md)
- [通知系统实施最终总结.md](file://documentation/03-业务模块/通知系统实施最终总结.md)
- [通知系统深度分析报告.md](file://documentation/03-业务模块/通知系统深度分析报告.md)
- [07-t_notification_message.sql](file://database-scripts/common-service/07-t_notification_message.sql)
- [08-t_notification_template.sql](file://database-scripts/common-service/08-t_notification_template.sql)
- [09-t_notification_config.sql](file://database-scripts/common-service/09-t_notification_config.sql)
- [NotificationManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationConfigService.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/service/NotificationConfigService.java)
- [NotificationConfigServiceImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/service/impl/NotificationConfigServiceImpl.java)
- [NotificationConfigController.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/controller/NotificationConfigController.java)
- [NotificationConfigEntity.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/domain/entity/NotificationConfigEntity.java)
- [NotificationConfigVO.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/domain/vo/NotificationConfigVO.java)
- [NotificationConfigType.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/constant/NotificationConfigType.java)
- [NotificationConfigKey.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/constant/NotificationConfigKey.java)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)（如有必要）

## 简介

IOE-DREAM通知系统是一个企业级、高可用的多渠道通知解决方案，支持邮件、短信、钉钉、企业微信、Webhook等多种通知渠道。该系统已达到生产就绪状态，具备完整的配置管理、限流保护、重试机制和监控指标收集功能。

系统通过统一的API接口提供服务，支持多级缓存、配置加密存储、模板热更新等企业级特性。通知系统已集成到IOE-DREAM智慧园区一卡通管理平台中，为各个业务模块提供可靠的通知服务。

## 项目结构

通知系统相关文件分布在多个目录中，主要包括文档、数据库脚本和微服务代码。

```mermaid
graph TD
A[通知系统] --> B[文档]
A --> C[数据库]
A --> D[微服务]
B --> B1[通知系统README.md]
B --> B2[通知系统使用指南.md]
B --> B3[通知系统实施总结.md]
B --> B4[通知系统实施最终总结.md]
B --> B5[通知系统深度分析报告.md]
C --> C1[t_notification_message.sql]
C --> C2[t_notification_template.sql]
C --> C3[t_notification_config.sql]
D --> D1[NotificationManager.java]
D --> D2[NotificationManagerImpl.java]
D --> D3[NotificationConfigManager.java]
D --> D4[NotificationConfigService.java]
D --> D5[NotificationConfigServiceImpl.java]
D --> D6[NotificationConfigController.java]
```

**图示来源**
- [通知系统README.md](file://documentation/03-业务模块/通知系统README.md)
- [通知系统使用指南.md](file://documentation/03-业务模块/通知系统使用指南.md)
- [07-t_notification_message.sql](file://database-scripts/common-service/07-t_notification_message.sql)
- [08-t_notification_template.sql](file://database-scripts/common-service/08-t_notification_template.sql)
- [09-t_notification_config.sql](file://database-scripts/common-service/09-t_notification_config.sql)

**本节来源**
- [通知系统README.md](file://documentation/03-业务模块/通知系统README.md)
- [通知系统使用指南.md](file://documentation/03-业务模块/通知系统使用指南.md)
- [通知系统实施总结.md](file://documentation/03-业务模块/通知系统实施总结.md)

## 核心组件

通知系统由多个核心组件构成，包括通知管理器、配置管理器、模板管理器和数据库表结构。系统采用分层架构设计，遵循CLAUDE.md规范，实现了Controller → Service → Manager → DAO的四层架构。

通知管理器采用基类+实现类的设计模式，其中基类在microservices-common中提供框架和扩展点，实现类在ioedream-common-service中实现具体业务逻辑。这种设计符合"公共模块提供框架，微服务实现业务"的架构原则。

系统支持多渠道通知发送，包括邮件、短信、Webhook和微信。每种渠道都有专门的通知管理器负责具体的发送逻辑，并通过统一的接口进行调用。

**本节来源**
- [通知系统README.md](file://documentation/03-业务模块/通知系统README.md)
- [通知系统实施总结.md](file://documentation/03-业务模块/通知系统实施总结.md)
- [NotificationManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)

## 架构概述

通知系统采用微服务架构，通过分层设计实现高内聚、低耦合。系统架构分为四个层次：控制器层、服务层、管理器层和数据访问层。

```mermaid
graph TD
A[客户端] --> B[控制器层]
B --> C[服务层]
C --> D[管理器层]
D --> E[数据访问层]
E --> F[数据库]
B --> B1[NotificationConfigController]
C --> C1[NotificationConfigService]
D --> D1[NotificationConfigManager]
E --> E1[NotificationConfigDao]
F --> F1[t_notification_config]
D1 --> G[统一缓存管理器]
D1 --> H[AES加密工具]
D1 --> I[JSON对象映射器]
```

**图示来源**
- [NotificationConfigController.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/controller/NotificationConfigController.java)
- [NotificationConfigService.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/service/NotificationConfigService.java)
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationConfigDao.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationConfigDao.java)
- [09-t_notification_config.sql](file://database-scripts/common-service/09-t_notification_config.sql)

## 详细组件分析

### 通知配置管理器分析

通知配置管理器是通知系统的核心组件之一，负责通知配置的获取、缓存、解密等管理功能。该组件严格遵循CLAUDE.md规范，保持为纯Java类，不使用Spring注解。

#### 对象导向组件：
```mermaid
classDiagram
class NotificationConfigManager {
-notificationConfigDao : NotificationConfigDao
-cacheManager : UnifiedCacheManager
-objectMapper : ObjectMapper
-aesUtil : AESUtil
+getConfigValue(configKey) String
+getConfigValue(configKey, defaultValue) String
+getConfigsByType(configType) Map~String,String~
+getConfigObject(configKey, clazz) T
+getConfigObject(configKey, typeReference) T
+updateConfigValue(configKey, configValue) boolean
+evictCache(configKey) void
}
class NotificationConfigDao {
+selectByConfigKey(configKey) NotificationConfigEntity
+selectByConfigTypeAndStatus(configType, status) NotificationConfigEntity[]
+updateConfigValue(configId, configValue) int
+updateConfigStatus(configId, status) int
}
class NotificationConfigEntity {
+configId : Long
+configKey : String
+configValue : String
+configType : String
+configDesc : String
+isEncrypted : Integer
+status : Integer
+createTime : LocalDateTime
+updateTime : LocalDateTime
+deletedFlag : Integer
}
class UnifiedCacheManager {
+getWithRefresh(key, loader, ttl) T
+evict(key) void
}
class AESUtil {
+encrypt(plainText) String
+decrypt(encryptedText) String
}
class ObjectMapper {
+readValue(content, clazz) T
+readValue(content, typeReference) T
}
NotificationConfigManager --> NotificationConfigDao : "使用"
NotificationConfigManager --> UnifiedCacheManager : "使用"
NotificationConfigManager --> ObjectMapper : "使用"
NotificationConfigManager --> AESUtil : "使用"
NotificationConfigDao --> NotificationConfigEntity : "返回"
```

**图示来源**
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationConfigDao.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationConfigDao.java)
- [NotificationConfigEntity.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/domain/entity/NotificationConfigEntity.java)

#### API/服务组件：
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "NotificationConfigController"
participant Service as "NotificationConfigService"
participant Manager as "NotificationConfigManager"
participant Dao as "NotificationConfigDao"
participant Cache as "统一缓存管理器"
participant DB as "数据库"
Client->>Controller : GET /api/v1/notification/config/value/{configKey}
Controller->>Service : getConfigValue(configKey)
Service->>Manager : getConfigValue(configKey)
Manager->>Cache : getWithRefresh(cacheKey)
alt 缓存命中
Cache-->>Manager : 返回缓存值
else 缓存未命中
Cache->>Dao : selectByConfigKey(configKey)
Dao->>DB : 查询数据库
DB-->>Dao : 返回配置实体
Dao-->>Cache : 返回配置实体
Cache->>Manager : 返回配置实体
end
Manager->>Manager : 检查配置状态
Manager->>Manager : 解密配置值如需要
Manager-->>Service : 返回配置值
Service-->>Controller : 返回配置值
Controller-->>Client : 返回配置值
```

**图示来源**
- [NotificationConfigController.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/controller/NotificationConfigController.java)
- [NotificationConfigService.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/service/NotificationConfigService.java)
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationConfigDao.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/dao/NotificationConfigDao.java)

**本节来源**
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationConfigService.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/service/NotificationConfigService.java)
- [NotificationConfigServiceImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/service/impl/NotificationConfigServiceImpl.java)
- [NotificationConfigController.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/notification/controller/NotificationConfigController.java)

### 通知管理器分析

通知管理器负责告警通知发送、通知渠道管理、重试机制等功能。系统采用基类+实现类的设计模式，其中基类在microservices-common中提供框架和扩展点，实现类在ioedream-common-service中实现具体业务逻辑。

#### 对象导向组件：
```mermaid
classDiagram
class NotificationManager {
-notificationDao : NotificationDao
-alertRuleDao : AlertRuleDao
+sendNotification(notification) void
+sendByChannel(notification, channel) boolean
+handleRetry(notification) void
}
class NotificationManagerImpl {
-emailNotificationManager : EmailNotificationManager
-smsNotificationManager : SmsNotificationManager
-webhookNotificationManager : WebhookNotificationManager
-wechatNotificationManager : WechatNotificationManager
+sendByChannel(notification, channel) boolean
}
class EmailNotificationManager {
+sendEmail(notification) boolean
}
class SmsNotificationManager {
+sendSms(notification) boolean
}
class WebhookNotificationManager {
+sendWebhook(notification) boolean
}
class WechatNotificationManager {
+sendWechat(notification) boolean
}
class NotificationEntity {
+notificationId : Long
+title : String
+content : String
+notificationType : Integer
+receiverType : Integer
+receiverIds : String
+senderId : Long
+senderName : String
+channel : Integer
+priority : Integer
+status : Integer
+sendTime : LocalDateTime
+errorMessage : String
+retryCount : Integer
+maxRetryCount : Integer
+nextRetryTime : LocalDateTime
+createTime : LocalDateTime
+updateTime : LocalDateTime
+deletedFlag : Integer
}
NotificationManager <|-- NotificationManagerImpl : "继承"
NotificationManagerImpl --> EmailNotificationManager : "使用"
NotificationManagerImpl --> SmsNotificationManager : "使用"
NotificationManagerImpl --> WebhookNotificationManager : "使用"
NotificationManagerImpl --> WechatNotificationManager : "使用"
```

**图示来源**
- [NotificationManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)
- [NotificationEntity.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/domain/entity/NotificationEntity.java)

#### API/服务组件：
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Service as "NotificationService"
participant ManagerImpl as "NotificationManagerImpl"
participant ManagerBase as "NotificationManager"
participant EmailManager as "EmailNotificationManager"
participant SmsManager as "SmsNotificationManager"
participant WebhookManager as "WebhookNotificationManager"
participant WechatManager as "WechatNotificationManager"
Client->>Service : sendNotification(notification)
Service->>ManagerImpl : sendNotification(notification)
ManagerImpl->>ManagerBase : sendNotification(notification)
ManagerBase->>ManagerBase : 检查渠道
ManagerBase->>ManagerImpl : sendByChannel(notification, channel)
ManagerImpl->>ManagerImpl : 根据渠道类型调用对应管理器
alt 邮件渠道
ManagerImpl->>EmailManager : sendEmail(notification)
EmailManager-->>ManagerImpl : 返回结果
else 短信渠道
ManagerImpl->>SmsManager : sendSms(notification)
SmsManager-->>ManagerImpl : 返回结果
else Webhook渠道
ManagerImpl->>WebhookManager : sendWebhook(notification)
WebhookManager-->>ManagerImpl : 返回结果
else 微信渠道
ManagerImpl->>WechatManager : sendWechat(notification)
WechatManager-->>ManagerImpl : 返回结果
else 其他渠道
ManagerImpl-->>ManagerImpl : 记录警告日志
ManagerImpl-->>ManagerBase : 返回false
end
ManagerImpl-->>ManagerBase : 返回发送结果
ManagerBase-->>ManagerImpl : 更新通知状态
ManagerImpl-->>Service : 返回发送结果
Service-->>Client : 返回发送结果
```

**图示来源**
- [NotificationManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)

**本节来源**
- [NotificationManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)

### 通知模板管理分析

通知模板管理器负责消息模板的管理、渲染和热更新功能。系统通过数据库表t_notification_template存储模板信息，并提供多级缓存支持。

#### 数据模型图：
```mermaid
erDiagram
t_notification_config {
BIGINT config_id PK
VARCHAR(100) config_key UK
TEXT config_value
VARCHAR(50) config_type
VARCHAR(500) config_desc
TINYINT is_encrypted
TINYINT status
DATETIME create_time
DATETIME update_time
BIGINT create_user_id
BIGINT update_user_id
TINYINT deleted_flag
}
t_notification_template {
BIGINT template_id PK
VARCHAR(50) template_code UK
VARCHAR(100) template_name
TINYINT template_type
VARCHAR(200) subject
TEXT content
TEXT variables
TINYINT status
VARCHAR(500) remark
DATETIME create_time
DATETIME update_time
BIGINT create_user_id
BIGINT update_user_id
TINYINT deleted_flag
}
t_notification_message {
BIGINT message_id PK
TINYINT message_type
VARCHAR(200) title
TEXT content
BIGINT sender_id
VARCHAR(100) sender_name
TINYINT recipient_type
TEXT recipient_ids
TINYINT channel
TINYINT priority
TINYINT status
DATETIME send_time
INT read_count
INT total_count
VARCHAR(50) business_type
VARCHAR(100) business_id
VARCHAR(50) template_id
TEXT template_params
DATETIME create_time
DATETIME update_time
BIGINT create_user_id
BIGINT update_user_id
TINYINT deleted_flag
}
t_notification_config ||--o{ t_notification_message : "配置消息"
t_notification_template ||--o{ t_notification_message : "使用模板"
```

**图示来源**
- [07-t_notification_message.sql](file://database-scripts/common-service/07-t_notification_message.sql)
- [08-t_notification_template.sql](file://database-scripts/common-service/08-t_notification_template.sql)
- [09-t_notification_config.sql](file://database-scripts/common-service/09-t_notification_config.sql)

**本节来源**
- [07-t_notification_message.sql](file://database-scripts/common-service/07-t_notification_message.sql)
- [08-t_notification_template.sql](file://database-scripts/common-service/08-t_notification_template.sql)
- [09-t_notification_config.sql](file://database-scripts/common-service/09-t_notification_config.sql)

## 依赖分析

通知系统依赖于多个外部组件和内部模块，形成了复杂的依赖关系网络。

```mermaid
graph TD
A[通知系统] --> B[数据库]
A --> C[缓存系统]
A --> D[加密工具]
A --> E[JSON处理]
A --> F[日志系统]
A --> G[微服务框架]
B --> B1[MySQL]
C --> C1[Redis]
D --> D1[AESUtil]
E --> E1[Jackson ObjectMapper]
F --> F1[SLF4J]
G --> G1[Spring Boot]
G --> G2[MyBatis-Plus]
A --> H[通知渠道]
H --> H1[邮件服务]
H --> H2[短信服务]
H --> H3[Webhook]
H --> H4[企业微信]
H --> H5[钉钉]
```

**图示来源**
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)
- [pom.xml](file://microservices/ioedream-common-service/pom.xml)

**本节来源**
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationManagerImpl.java](file://microservices/ioedream-common-service/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManagerImpl.java)

## 性能考虑

通知系统在设计时充分考虑了性能优化，采用了多种技术手段来提高系统性能和响应速度。

系统采用多级缓存架构，包括L1本地缓存（Caffeine）和L2 Redis缓存，有效减少了数据库访问频率。配置信息和模板信息都支持缓存，提高了读取性能。

对于高频率的配置读取操作，系统实现了缓存自动刷新机制，确保在缓存过期时能够及时从数据库加载最新数据。同时，系统支持配置热更新，更新配置后会自动清除相关缓存，确保配置的实时性。

在通知发送方面，系统实现了异步发送机制，避免了同步发送导致的性能瓶颈。对于失败的通知，系统采用指数退避策略进行重试，避免了频繁重试对系统造成的压力。

**本节来源**
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)
- [NotificationManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/monitor/manager/NotificationManager.java)

## 故障排除指南

当通知系统出现问题时，可以按照以下步骤进行排查：

1. **检查配置信息**：确认通知渠道的配置是否正确，包括Webhook URL、API密钥等。可以通过API接口获取配置值进行验证。

2. **检查网络连接**：确保系统能够访问外部通知服务，如钉钉、企业微信等。可以使用ping或telnet命令测试网络连通性。

3. **查看日志信息**：检查系统日志，查找与通知发送相关的错误信息。重点关注发送失败、重试次数过多等问题。

4. **检查缓存状态**：如果配置更新后未生效，可能是缓存未清除。可以调用清除缓存的API接口，或手动清除Redis中的相关缓存。

5. **监控指标检查**：通过/actuator/prometheus端点查看监控指标，分析发送成功率、耗时、限流统计等指标，定位性能瓶颈。

**本节来源**
- [通知系统使用指南.md](file://documentation/03-业务模块/通知系统使用指南.md)
- [通知系统实施总结.md](file://documentation/03-业务模块/通知系统实施总结.md)
- [NotificationConfigManager.java](file://microservices/microservices-common/src/main/java/net/lab1024/sa/common/notification/manager/NotificationConfigManager.java)

## 结论

IOE-DREAM通知系统是一个功能完善、性能优越的企业级通知解决方案。系统通过分层架构设计，实现了高内聚、低耦合，便于维护和扩展。

核心功能包括多渠道通知发送、统一配置管理、消息模板管理、限流保护、重试机制和监控指标收集。系统已达到生产就绪状态，功能完整度达到95%以上。

未来可以进一步完善短信SDK集成、实现统一限流管理器和统一重试管理器，以及增加降级熔断机制，进一步提升系统的稳定性和可靠性。