# è®¿å®¢æœåŠ¡ä¸“å®¶æŠ€èƒ½
## Visitor Service Specialist

**ğŸ¯ æŠ€èƒ½å®šä½**: IOE-DREAMæ™ºæ…§å›­åŒºè®¿å®¢ç®¡ç†ä¸šåŠ¡ä¸“å®¶ï¼Œç²¾é€šè®¿å®¢é¢„çº¦ã€å®¡æ‰¹æµç¨‹ã€è·¨æœåŠ¡æƒé™ä¸‹å‘ã€è®¿å®¢ä½“éªŒä¼˜åŒ–ç­‰æ ¸å¿ƒä¸šåŠ¡

**âš¡ æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜…â˜…â˜…â˜… (é¡¶çº§ä¸“å®¶)
**ğŸ¯ é€‚ç”¨åœºæ™¯**: è®¿å®¢æœåŠ¡å¼€å‘ã€é¢„çº¦ç®¡ç†ç³»ç»Ÿã€å®¡æ‰¹æµç¨‹å»ºè®¾ã€è®¿å®¢ä½“éªŒä¼˜åŒ–
**ğŸ“Š æŠ€èƒ½è¦†ç›–**: è®¿å®¢é¢„çº¦ | å®¡æ‰¹æµç¨‹ | è·¨æœåŠ¡è°ƒç”¨ | æƒé™ä¸‹å‘ | è®¿å®¢è®°å½• | è®¿å®¢ä½“éªŒ | å®‰å…¨ç®¡æ§
**ğŸ”§ æŠ€æœ¯æ ˆ**: Spring Boot 3.5.8 + Camunda BPM + MyBatis-Plus + Redis + MinIO

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

### **æ ¸å¿ƒä¸“é•¿**
- **è®¿å®¢é¢„çº¦ç³»ç»Ÿ**: çµæ´»çš„è®¿å®¢é¢„çº¦æœºåˆ¶ã€æ—¶é—´å†²çªæ£€æµ‹ã€èµ„æºä¼˜åŒ–åˆ†é…
- **å®¡æ‰¹æµç¨‹å¼•æ“**: å¤šçº§å®¡æ‰¹æµç¨‹è®¾è®¡ã€åŠ¨æ€å®¡æ‰¹è§„åˆ™ã€å®¡æ‰¹çŠ¶æ€è·Ÿè¸ª
- **è·¨æœåŠ¡æƒé™ä¸‹å‘**: é€šè¿‡ç½‘å…³è°ƒç”¨é—¨ç¦æœåŠ¡ï¼Œä¸‹å‘è®¿å®¢æƒé™åˆ°é—¨ç¦è®¾å¤‡
- **æƒé™æ—¶æ•ˆç®¡ç†**: ä¸´æ—¶æƒé™ç”Ÿæˆã€è‡ªåŠ¨è¿‡æœŸå›æ”¶ã€ç²¾ç»†åŒ–è®¿é—®æ§åˆ¶
- **è®¿å®¢ä½“éªŒä¼˜åŒ–**: æ— æ„Ÿé€šè¡Œã€ç§»åŠ¨ç«¯æ”¯æŒã€è‡ªåŠ©æœåŠ¡ã€æ™ºèƒ½æ¨è
- **å®‰å…¨ç®¡æ§**: èº«ä»½éªŒè¯ã€é»‘åå•ç®¡ç†ã€å¼‚å¸¸æ£€æµ‹ã€é£é™©é¢„è­¦
- **æ•°æ®åˆ†æ**: è®¿å®¢æµé‡åˆ†æã€é¢„çº¦æˆåŠŸç‡ã€å®¡æ‰¹æ•ˆç‡ç»Ÿè®¡

### **è§£å†³èƒ½åŠ›**
- **è®¿å®¢æœåŠ¡æ¶æ„**: é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„è®¿å®¢æœåŠ¡æ¶æ„è®¾è®¡å’Œå®ç°
- **é¢„çº¦ç®—æ³•ä¼˜åŒ–**: æ™ºèƒ½é¢„çº¦ç®—æ³•ï¼Œæœ€å¤§åŒ–èµ„æºåˆ©ç”¨ç‡å’Œè®¿å®¢æ»¡æ„åº¦
- **è·¨æœåŠ¡è°ƒç”¨ä¼˜åŒ–**: é«˜æ•ˆçš„æœåŠ¡é—´è°ƒç”¨æœºåˆ¶ï¼Œç¡®ä¿æƒé™ä¸‹å‘å¯é æ€§
- **å®¡æ‰¹æµç¨‹ä¼˜åŒ–**: è‡ªåŠ¨åŒ–å®¡æ‰¹æµç¨‹ï¼Œå‡å°‘äººå·¥å¹²é¢„å’Œæé«˜å®¡æ‰¹æ•ˆç‡
- **å®‰å…¨é£é™©æ§åˆ¶**: è®¿å®¢å®‰å…¨é£é™©è¯„ä¼°ã€å®æ—¶ç›‘æ§ã€åº”æ€¥å¤„ç†æœºåˆ¶
- **æ•°æ®ç»Ÿè®¡åˆ†æ**: è®¿å®¢æ•°æ®åˆ†æå’Œæ´å¯Ÿï¼Œæ”¯æŒç®¡ç†å†³ç­–

---

## ğŸ¯ ä¸šåŠ¡åœºæ™¯è¦†ç›–

### ğŸ‘¤ è®¿å®¢é¢„çº¦ç®¡ç†
```java
// è®¿å®¢é¢„çº¦ç®¡ç† (Spring Boot 3.5.8 + MyBatis-Plus)
import jakarta.annotation.Resource;
import jakarta.validation.Valid;
import jakarta.transaction.Transactional;
import jakarta.servlet.http.HttpServletRequest;
import com.baomidou.mybatisplus.annotation.TableName;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.FieldFill;
import com.baomidou.mybatisplus.annotation.TableLogic;
import com.baomidou.mybatisplus.annotation.Version;
import lombok.Data;

// Controllerå±‚ - RESTæ¥å£
@RestController
@RequestMapping("/api/v1/visitor/appointment")
@Tag(name = "è®¿å®¢é¢„çº¦", description = "è®¿å®¢é¢„çº¦å’Œç®¡ç†æœåŠ¡")
public class VisitorAppointmentController {

    @Resource
    private VisitorAppointmentService visitorAppointmentService;

    /**
     * åˆ›å»ºè®¿å®¢é¢„çº¦
     */
    @PostMapping("/create")
    @RateLimiter(name = "appointment-create", fallbackMethod = "createAppointmentFallback")
    @ApiOperation(value = "åˆ›å»ºé¢„çº¦", notes = "åˆ›å»ºæ–°çš„è®¿å®¢é¢„çº¦")
    public ResponseDTO<AppointmentResultDTO> createAppointment(
            @Valid @RequestBody AppointmentCreateRequestDTO request,
            HttpServletRequest httpRequest) {

        log.info("[è®¿å®¢é¢„çº¦] åˆ›å»ºé¢„çº¦, visitorName={}, visitDate={}",
                request.getVisitorName(), request.getVisitDate());

        validateRequestSource(httpRequest);

        AppointmentResultDTO result = visitorAppointmentService.createAppointment(request);

        log.info("[è®¿å®¢é¢„çº¦] é¢„çº¦åˆ›å»ºæˆåŠŸ, appointmentId={}, status={}",
                result.getAppointmentId(), result.getStatus());

        return ResponseDTO.ok(result);
    }

    /**
     * å–æ¶ˆè®¿å®¢é¢„çº¦
     */
    @PostMapping("/cancel")
    @ApiOperation(value = "å–æ¶ˆé¢„çº¦", notes = "å–æ¶ˆè®¿å®¢é¢„çº¦")
    public ResponseDTO<Void> cancelAppointment(@Valid @RequestBody AppointmentCancelRequestDTO request) {
        log.info("[è®¿å®¢é¢„çº¦] å–æ¶ˆé¢„çº¦, appointmentId={}", request.getAppointmentId());

        visitorAppointmentService.cancelAppointment(request.getAppointmentId(), request.getCancelReason());

        return ResponseDTO.ok();
    }

    // æœåŠ¡é™çº§å¤„ç†
    public ResponseDTO<AppointmentResultDTO> createAppointmentFallback(AppointmentCreateRequestDTO request, Exception ex) {
        log.error("[è®¿å®¢é¢„çº¦] æœåŠ¡é™çº§, visitorName={}", request.getVisitorName(), ex);
        return ResponseDTO.error("SERVICE_DEGRADED", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}

// Serviceå±‚ - ä¸šåŠ¡é€»è¾‘å®ç°
@Service
@Transactional(rollbackFor = Exception.class)
public class VisitorAppointmentServiceImpl implements VisitorAppointmentService {

    @Resource
    private VisitorAppointmentManager visitorAppointmentManager;

    @Override
    public AppointmentResultDTO createAppointment(AppointmentCreateRequestDTO request) {
        try {
            validateAppointmentRequest(request);

            AppointmentResult result = visitorAppointmentManager.createAppointment(request);

            return convertToDTO(result);
        } catch (BusinessException e) {
            log.warn("[è®¿å®¢é¢„çº¦] ä¸šåŠ¡å¼‚å¸¸, visitorName={}, error={}", request.getVisitorName(), e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("[è®¿å®¢é¢„çº¦] ç³»ç»Ÿå¼‚å¸¸, visitorName={}", request.getVisitorName(), e);
            throw new BusinessException("APPOINTMENT_CREATE_ERROR", "è®¿å®¢é¢„çº¦åˆ›å»ºå¤±è´¥");
        }
    }

    @Override
    public void cancelAppointment(Long appointmentId, String cancelReason) {
        try {
            if (appointmentId == null) {
                throw new BusinessException("APPOINTMENT_ID_REQUIRED", "é¢„çº¦IDä¸èƒ½ä¸ºç©º");
            }

            visitorAppointmentManager.cancelAppointment(appointmentId, cancelReason);
        } catch (Exception e) {
            log.error("[è®¿å®¢é¢„çº¦] å–æ¶ˆå¤±è´¥, appointmentId={}", appointmentId, e);
            throw new BusinessException("APPOINTMENT_CANCEL_ERROR", "è®¿å®¢é¢„çº¦å–æ¶ˆå¤±è´¥");
        }
    }

    private void validateAppointmentRequest(AppointmentCreateRequestDTO request) {
        if (StringUtils.isEmpty(request.getVisitorName())) {
            throw new BusinessException("VISITOR_NAME_REQUIRED", "è®¿å®¢å§“åä¸èƒ½ä¸ºç©º");
        }
        if (StringUtils.isEmpty(request.getVisitorPhone())) {
            throw new BusinessException("VISITOR_PHONE_REQUIRED", "è®¿å®¢ç”µè¯ä¸èƒ½ä¸ºç©º");
        }
        if (request.getVisitDate() == null) {
            throw new BusinessException("VISIT_DATE_REQUIRED", "è®¿é—®æ—¥æœŸä¸èƒ½ä¸ºç©º");
        }
        if (request.getVisitDate().isBefore(LocalDate.now())) {
            throw new BusinessException("INVALID_VISIT_DATE", "è®¿é—®æ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©");
        }
    }
}

// Managerå±‚ - å¤æ‚ä¸šåŠ¡æµç¨‹ç¼–æ’
public class VisitorAppointmentManagerImpl implements VisitorAppointmentManager {

    private final AppointmentScheduler appointmentScheduler;
    private final ConflictDetector conflictDetector;
    private final VisitorValidator visitorValidator;
    private final VisitorAppointmentDao visitorAppointmentDao;
    private final ApprovalEngine approvalEngine;
    private final GatewayServiceClient gatewayServiceClient;

    // æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
    public VisitorAppointmentManagerImpl(
            AppointmentScheduler appointmentScheduler,
            ConflictDetector conflictDetector,
            VisitorValidator visitorValidator,
            VisitorAppointmentDao visitorAppointmentDao,
            ApprovalEngine approvalEngine,
            GatewayServiceClient gatewayServiceClient) {
        this.appointmentScheduler = appointmentScheduler;
        this.conflictDetector = conflictDetector;
        this.visitorValidator = visitorValidator;
        this.visitorAppointmentDao = visitorAppointmentDao;
        this.approvalEngine = approvalEngine;
        this.gatewayServiceClient = gatewayServiceClient;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public AppointmentResult createAppointment(AppointmentCreateRequestDTO request) {
        // 1. è®¿å®¢ä¿¡æ¯éªŒè¯
        VisitorValidationResult validation = visitorValidator.validateVisitor(request);
        if (!validation.isValid()) {
            throw new BusinessException("VISITOR_VALIDATION_FAILED", validation.getErrorMessage());
        }

        // 2. é¢„çº¦å†²çªæ£€æµ‹
        ConflictDetectionResult conflictResult = conflictDetector.detectConflicts(request);
        if (conflictResult.hasConflicts()) {
            return AppointmentResult.builder()
                .status("CONFLICT_DETECTED")
                .conflicts(conflictResult.getConflicts())
                .suggestions(conflictResult.getSuggestions())
                .build();
        }

        // 3. æ™ºèƒ½è°ƒåº¦å®‰æ’
        AppointmentSchedule schedule = appointmentScheduler.scheduleAppointment(request);

        // 4. è®¿å®¢é¢„çº¦ä¿¡æ¯æŒä¹…åŒ–
        VisitorAppointmentEntity appointment = saveAppointment(request, schedule);

        // 5. å¯åŠ¨å®¡æ‰¹æµç¨‹ï¼ˆå¦‚éœ€è¦ï¼‰
        if (approvalRequired(request)) {
            startApprovalProcess(appointment);
        } else {
            // è‡ªåŠ¨å®¡æ‰¹é€šè¿‡ï¼Œä¸‹å‘æƒé™
            grantVisitorPermission(appointment);
        }

        // 6. å‘é€é¢„çº¦ç¡®è®¤é€šçŸ¥
        sendAppointmentNotification(appointment);

        return buildAppointmentResult(appointment, schedule);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void cancelAppointment(Long appointmentId, String cancelReason) {
        // 1. è·å–é¢„çº¦ä¿¡æ¯
        VisitorAppointmentEntity appointment = getAppointmentById(appointmentId);
        if (appointment == null) {
            throw new BusinessException("APPOINTMENT_NOT_FOUND", "è®¿å®¢é¢„çº¦ä¸å­˜åœ¨");
        }

        // 2. éªŒè¯å–æ¶ˆæƒé™
        validateCancelPermission(appointment);

        // 3. å›æ”¶å·²ä¸‹å‘çš„æƒé™
        revokeVisitorPermission(appointment);

        // 4. æ›´æ–°é¢„çº¦çŠ¶æ€
        updateAppointmentStatus(appointmentId, "CANCELLED", cancelReason);

        // 5. å‘é€å–æ¶ˆé€šçŸ¥
        sendCancelNotification(appointment, cancelReason);
    }

    private VisitorValidationResult visitorValidator.validateVisitor(AppointmentCreateRequestDTO request) {
        return visitorValidator.validateBasicInfo(request)
                .andThen(() -> validateBlacklist(request))
                .andThen(() -> validateVisitHistory(request));
    }

    private ConflictDetectionResult conflictDetector.detectConflicts(AppointmentCreateRequestDTO request) {
        // 1. æ—¶é—´å†²çªæ£€æµ‹
        List<TimeConflict> timeConflicts = checkTimeConflicts(request);

        // 2. èµ„æºå†²çªæ£€æµ‹
        List<ResourceConflict> resourceConflicts = checkResourceConflicts(request);

        // 3. è®¿å®¢å®¹é‡å†²çªæ£€æµ‹
        List<CapacityConflict> capacityConflicts = checkCapacityConflicts(request);

        return ConflictDetectionResult.builder()
                .timeConflicts(timeConflicts)
                .resourceConflicts(resourceConflicts)
                .capacityConflicts(capacityConflicts)
                .hasConflicts(!timeConflicts.isEmpty() || !resourceConflicts.isEmpty() || !capacityConflicts.isEmpty())
                .build();
    }

    private VisitorAppointmentEntity saveAppointment(AppointmentCreateRequestDTO request, AppointmentSchedule schedule) {
        VisitorAppointmentEntity appointment = VisitorAppointmentEntity.builder()
                .visitorName(request.getVisitorName())
                .visitorPhone(request.getVisitorPhone())
                .visitorEmail(request.getVisitorEmail())
                .visitorCompany(request.getVisitorCompany())
                .visitorIdCard(request.getVisitorIdCard())
                .visitDate(request.getVisitDate())
                .visitStartTime(schedule.getStartTime())
                .visitEndTime(schedule.getEndTime())
                .visitPurpose(request.getVisitPurpose())
                .visitDepartment(request.getVisitDepartment())
                .visitContactPerson(request.getVisitContactPerson())
                .appointmentStatus("PENDING")
                .build();

        visitorAppointmentDao.insert(appointment);

        return appointment;
    }

    private void grantVisitorPermission(VisitorAppointmentEntity appointment) {
        // é€šè¿‡ç½‘å…³è°ƒç”¨é—¨ç¦æœåŠ¡ï¼Œä¸‹å‘è®¿å®¢æƒé™
        VisitorProvisionRequest provisionRequest = VisitorProvisionRequest.builder()
                .visitorId(appointment.getAppointmentId())
                .permissionId("VISITOR_" + appointment.getAppointmentId())
                .deviceIds(getDeviceIdsForDepartment(appointment.getVisitDepartment()))
                .visitorInfo(VisitorInfo.builder()
                        .name(appointment.getVisitorName())
                        .phone(appointment.getVisitorPhone())
                        .idCard(appointment.getVisitorIdCard())
                        .photo(appointment.getVisitorPhoto())
                        .build())
                .accessTimeWindow(AccessTimeWindow.builder()
                        .startTime(appointment.getVisitStartTime())
                        .endTime(appointment.getVisitEndTime())
                        .build())
                .build();

        ResponseDTO<Void> result = gatewayServiceClient.callAccessService(
                "/api/v1/access/device/visitor/provision",
                HttpMethod.POST,
                provisionRequest,
                Void.class
        );

        if (result.getCode() != 200) {
            throw new BusinessException("PERMISSION_PROVISION_FAILED", "è®¿å®¢æƒé™ä¸‹å‘å¤±è´¥");
        }

        // æ›´æ–°é¢„çº¦çŠ¶æ€ä¸ºå·²æˆæƒ
        updateAppointmentStatus(appointment.getAppointmentId(), "AUTHORIZED", "è‡ªåŠ¨å®¡æ‰¹é€šè¿‡");
    }

    private void revokeVisitorPermission(VisitorAppointmentEntity appointment) {
        VisitorRevokeRequest revokeRequest = VisitorRevokeRequest.builder()
                .visitorId(appointment.getAppointmentId())
                .deviceIds(getDeviceIdsForDepartment(appointment.getVisitDepartment()))
                .build();

        ResponseDTO<Void> result = gatewayServiceClient.callAccessService(
                "/api/v1/access/device/visitor/revoke",
                HttpMethod.DELETE,
                revokeRequest,
                Void.class
        );

        if (result.getCode() != 200) {
            log.warn("[è®¿å®¢æƒé™] æƒé™å›æ”¶å¤±è´¥, appointmentId={}", appointment.getAppointmentId());
        }
    }
}

// DAOå±‚ - æ•°æ®è®¿é—®
@Mapper
public interface VisitorAppointmentDao extends BaseMapper<VisitorAppointmentEntity> {

    @Transactional(readOnly = true)
    VisitorAppointmentEntity selectByAppointmentId(@Param("appointmentId") Long appointmentId);

    @Transactional(readOnly = true)
    List<VisitorAppointmentEntity> selectByVisitorPhone(@Param("visitorPhone") String visitorPhone);

    @Transactional(readOnly = true)
    List<VisitorAppointmentEntity> selectByVisitDateRange(
        @Param("startDate") LocalDate startDate,
        @Param("endDate") LocalDate endDate
    );

    @Transactional(readOnly = true)
    List<VisitorAppointmentEntity> selectByDepartmentAndDate(
        @Param("department") String department,
        @Param("visitDate") LocalDate visitDate
    );

    @Transactional(rollbackFor = Exception.class)
    int updateAppointmentStatus(
        @Param("appointmentId") Long appointmentId,
        @Param("status") String status,
        @Param("reason") String reason
    );
}

// å®ä½“ç±» - è®¿å®¢é¢„çº¦
@Data
@EqualsAndHashCode(callSuper = true)
@TableName("t_visitor_appointment")
public class VisitorAppointmentEntity extends BaseEntity {

    @TableId(type = IdType.AUTO)
    private Long appointmentId;

    @TableField("visitor_name")
    private String visitorName;

    @TableField("visitor_phone")
    private String visitorPhone;

    @TableField("visitor_email")
    private String visitorEmail;

    @TableField("visitor_company")
    private String visitorCompany;

    @TableField("visitor_id_card")
    @Convert(converter = EncryptedStringConverter.class)
    private String visitorIdCard;  // èº«ä»½è¯å·åŠ å¯†å­˜å‚¨

    @TableField("visitor_photo")
    private String visitorPhoto;  // ç…§ç‰‡URL

    @TableField("visit_date")
    private LocalDate visitDate;

    @TableField("visit_start_time")
    private LocalDateTime visitStartTime;

    @TableField("visit_end_time")
    private LocalDateTime visitEndTime;

    @TableField("visit_purpose")
    private String visitPurpose;

    @TableField("visit_department")
    private String visitDepartment;

    @TableField("visit_contact_person")
    private String visitContactPerson;

    @TableField("appointment_status")
    private String appointmentStatus;  // PENDING, APPROVED, REJECTED, CANCELLED, COMPLETED

    @TableField("approval_required")
    private Boolean approvalRequired;

    @TableField("approval_process_id")
    private String approvalProcessId;  // Camundaæµç¨‹å®ä¾‹ID

    @TableField("access_granted")
    private Boolean accessGranted;  // æ˜¯å¦å·²ä¸‹å‘é—¨ç¦æƒé™

    @TableField("access_start_time")
    private LocalDateTime accessStartTime;

    @TableField("access_end_time")
    private LocalDateTime accessEndTime;

    @TableField("check_in_time")
    private LocalDateTime checkInTime;  // å®é™…ç­¾åˆ°æ—¶é—´

    @TableField("check_out_time")
    private LocalDateTime checkOutTime;  // å®é™…ç¦»å¼€æ—¶é—´

    @TableField("cancel_reason")
    private String cancelReason;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;

    @TableLogic
    @TableField("deleted_flag")
    private Integer deletedFlag;

    @Version
    private Integer version;
}
```
        ValidationErrors errors = visitorValidator.validate(request);
        if (!errors.isEmpty()) {
            return AppointmentResult.failed(errors);
        }

        // 2. æ—¶é—´å†²çªæ£€æµ‹
        ConflictResult conflict = conflictDetector.checkConflict(request);
        if (conflict.hasConflict()) {
            return AppointmentResult.conflicted(conflict.getAlternatives());
        }

        // 3. æ™ºèƒ½è°ƒåº¦ç®—æ³•
        AppointmentSlot optimalSlot = scheduler.findOptimalSlot(request);

        // 4. åˆ›å»ºé¢„çº¦è®°å½•
        return buildAppointment(optimalSlot, request);
    }
}
```

### ğŸ“‹ å®¡æ‰¹æµç¨‹ç®¡ç†
```java
@Service
public class ApprovalProcessService {

    @Resource
    private WorkflowEngine workflowEngine;

    @Resource
    private NotificationService notificationService;

    public ApprovalResult startApprovalProcess(Appointment appointment) {
        // 1. ç¡®å®šå®¡æ‰¹æµç¨‹
        ApprovalWorkflow workflow = workflowEngine.getWorkflow(appointment);

        // 2. åˆ›å»ºå®¡æ‰¹å®ä¾‹
        ApprovalInstance instance = workflowEngine.createInstance(workflow, appointment);

        // 3. å¯åŠ¨ç¬¬ä¸€ä¸ªå®¡æ‰¹èŠ‚ç‚¹
        ApprovalTask firstTask = workflowEngine.startFirstTask(instance);

        // 4. å‘é€å®¡æ‰¹é€šçŸ¥
        notificationService.sendApprovalNotification(firstTask);

        return ApprovalResult.started(instance, firstTask);
    }

    public ApprovalResult processApproval(ApprovalAction action) {
        // 1. éªŒè¯å®¡æ‰¹æƒé™
        validateApprovalPermission(action);

        // 2. å¤„ç†å®¡æ‰¹å†³ç­–
        ApprovalDecision decision = workflowEngine.processDecision(action);

        // 3. ç¡®å®šä¸‹ä¸€æ­¥æ“ä½œ
        if (decision.isComplete()) {
            // å®¡æ‰¹å®Œæˆï¼Œæ‰§è¡Œåç»­æ“ä½œ
            executePostApprovalActions(decision);
        } else {
            // è¿›å…¥ä¸‹ä¸€ä¸ªå®¡æ‰¹èŠ‚ç‚¹
            moveToNextApprovalNode(decision);
        }

        return decision;
    }
}
```

### ğŸ” è®¿å®¢æƒé™ç®¡ç†ä¸è·¨æœåŠ¡è°ƒç”¨
```java
@Service
public class VisitorPermissionService {

    @Resource
    private TemporaryAccessGenerator accessGenerator;

    @Resource
    private GatewayServiceClient gatewayServiceClient;

    public VisitorPermission grantTemporaryPermission(Visitor visitor, Appointment appointment) {
        // 1. ç”Ÿæˆä¸´æ—¶æƒé™å‡­è¯
        TemporaryAccessCredential credential = accessGenerator.generateCredential(visitor, appointment);

        // 2. é…ç½®è®¿é—®æƒé™èŒƒå›´
        AccessPolicy policy = buildAccessPolicy(appointment);

        // 3. è·¨æœåŠ¡è°ƒç”¨é—¨ç¦æœåŠ¡ï¼Œä¸‹å‘æƒé™åˆ°è®¾å¤‡
        List<DeviceProvisioningResult> provisioningResults = provisionVisitorToAccessDevices(
            visitor, appointment, credential, policy);

        // 4. éªŒè¯æ‰€æœ‰è®¾å¤‡ä¸‹å‘æˆåŠŸ
        validateProvisioningResults(provisioningResults);

        // 5. è®¾ç½®æƒé™è¿‡æœŸæ—¶é—´ï¼ˆè‡ªåŠ¨å›æ”¶ï¼‰
        schedulePermissionExpiration(visitor, appointment.getEndTime());

        return VisitorPermission.builder()
                .credential(credential)
                .policy(policy)
                .provisioningResults(provisioningResults)
                .validFrom(appointment.getStartTime())
                .validUntil(appointment.getEndTime())
                .build();
    }

    /**
     * è·¨æœåŠ¡è°ƒç”¨é—¨ç¦æœåŠ¡ï¼Œä¸‹å‘è®¿å®¢æƒé™åˆ°é—¨ç¦è®¾å¤‡
     */
    private List<DeviceProvisioningResult> provisionVisitorToAccessDevices(
            Visitor visitor, Appointment appointment,
            TemporaryAccessCredential credential, AccessPolicy policy) {

        List<DeviceProvisioningResult> results = new ArrayList<>();

        // è·å–è®¿å®¢éœ€è¦è®¿é—®çš„æ‰€æœ‰é—¨ç¦è®¾å¤‡
        List<AccessDevice> accessDevices = getAccessDevicesForAppointment(appointment);

        for (AccessDevice device : accessDevices) {
            try {
                // æ„å»ºæƒé™ä¸‹å‘è¯·æ±‚
                VisitorProvisioningRequest request = VisitorProvisioningRequest.builder()
                        .visitorId(visitor.getVisitorId())
                        .deviceId(device.getDeviceId())
                        .deviceType(device.getDeviceType())
                        .visitorInfo(buildVisitorInfo(visitor))
                        .accessTimeWindow(buildAccessTimeWindow(appointment))
                        .permissionId(credential.getPermissionId())
                        .build();

                // è·¨æœåŠ¡è°ƒç”¨é—¨ç¦æœåŠ¡
                ResponseDTO<Void> response = gatewayServiceClient.callAccessService(
                    "/api/v1/access/device/provision-visitor",
                    HttpMethod.POST,
                    request,
                    Void.class
                );

                DeviceProvisioningResult result = new DeviceProvisioningResult();
                result.setDeviceId(device.getDeviceId());
                result.setSuccess(response.isSuccess());
                result.setMessage(response.getMessage());

                results.add(result);

                log.info("è®¿å®¢æƒé™ä¸‹å‘åˆ°é—¨ç¦è®¾å¤‡: è®¿å®¢ID={}, è®¾å¤‡ID={}, ç»“æœ={}",
                    visitor.getVisitorId(), device.getDeviceId(), response.isSuccess());

            } catch (Exception e) {
                log.error("è®¿å®¢æƒé™ä¸‹å‘å¤±è´¥: è®¿å®¢ID={}, è®¾å¤‡ID={}",
                    visitor.getVisitorId(), device.getDeviceId(), e);

                DeviceProvisioningResult result = new DeviceProvisioningResult();
                result.setDeviceId(device.getDeviceId());
                result.setSuccess(false);
                result.setMessage(e.getMessage());
                results.add(result);
            }
        }

        return results;
    }

    /**
     * å›æ”¶è®¿å®¢æƒé™ï¼ˆè·¨æœåŠ¡è°ƒç”¨ï¼‰
     */
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿‡æœŸæƒé™
    public void revokeExpiredVisitorPermissions() {
        List<VisitorPermission> expiredPermissions = getExpiredPermissions();

        for (VisitorPermission permission : expiredPermissions) {
            try {
                // è·å–è¯¥æƒé™å…³è”çš„æ‰€æœ‰é—¨ç¦è®¾å¤‡
                List<AccessDevice> devices = getDevicesForPermission(permission);

                for (AccessDevice device : devices) {
                    // æ„å»ºæƒé™å›æ”¶è¯·æ±‚
                    VisitorRevocationRequest request = VisitorRevocationRequest.builder()
                            .visitorId(permission.getVisitorId())
                            .deviceId(device.getDeviceId())
                            .deviceType(device.getDeviceType())
                            .permissionId(permission.getPermissionId())
                            .build();

                    // è·¨æœåŠ¡è°ƒç”¨é—¨ç¦æœåŠ¡å›æ”¶æƒé™
                    ResponseDTO<Void> response = gatewayServiceClient.callAccessService(
                        "/api/v1/access/device/revoke-visitor",
                        HttpMethod.POST,
                        request,
                        Void.class
                    );

                    if (response.isSuccess()) {
                        log.info("è®¿å®¢æƒé™å›æ”¶æˆåŠŸ: è®¿å®¢ID={}, è®¾å¤‡ID={}",
                            permission.getVisitorId(), device.getDeviceId());
                    } else {
                        log.error("è®¿å®¢æƒé™å›æ”¶å¤±è´¥: è®¿å®¢ID={}, è®¾å¤‡ID={}, é”™è¯¯={}",
                            permission.getVisitorId(), device.getDeviceId(), response.getMessage());
                    }
                }

                // æ ‡è®°æƒé™ä¸ºå·²å›æ”¶
                markPermissionAsRevoked(permission);

            } catch (Exception e) {
                log.error("å›æ”¶è®¿å®¢æƒé™å¼‚å¸¸: è®¿å®¢ID={}", permission.getVisitorId(), e);
            }
        }
    }
}
```

### ğŸ“Š è®¿å®¢æ•°æ®åˆ†æ
```java
@Service
public class VisitorAnalyticsService {

    public VisitorAnalytics generateAnalytics(AnalyticsRequest request) {
        // 1. è®¿å®¢æµé‡åˆ†æ
        VisitorFlowAnalysis flowAnalysis = analyzeVisitorFlow(request.getTimeRange());

        // 2. é¢„çº¦æˆåŠŸç‡åˆ†æ
        AppointmentSuccessAnalysis successAnalysis = analyzeAppointmentSuccess(request);

        // 3. å®¡æ‰¹æ•ˆç‡åˆ†æ
        ApprovalEfficiencyAnalysis approvalAnalysis = analyzeApprovalEfficiency(request);

        // 4. è®¿å®¢æ»¡æ„åº¦åˆ†æ
        SatisfactionAnalysis satisfactionAnalysis = analyzeSatisfaction(request);

        return VisitorAnalytics.builder()
                .flowAnalysis(flowAnalysis)
                .successAnalysis(successAnalysis)
                .approvalAnalysis(approvalAnalysis)
                .satisfactionAnalysis(satisfactionAnalysis)
                .build();
    }
}
```

---

## ğŸ”§ æŠ€æœ¯æ ˆå’Œå·¥å…·

### æ ¸å¿ƒæŠ€æœ¯
- **Spring Boot 3.x**: å¾®æœåŠ¡æ¡†æ¶
- **Camunda**: å·¥ä½œæµå¼•æ“ï¼ˆå®¡æ‰¹æµç¨‹ï¼‰
- **Spring Security**: å®‰å…¨æ¡†æ¶å’Œè®¤è¯æˆæƒ
- **Redis**: ç¼“å­˜å’Œä¼šè¯ç®¡ç†
- **MySQL**: å…³ç³»å‹æ•°æ®åº“

### å·¥ä½œæµæŠ€æœ¯
- **BPMN 2.0**: ä¸šåŠ¡æµç¨‹å»ºæ¨¡æ ‡å‡†
- **å·¥ä½œæµå¼•æ“**: Camundaã€Flowable
- **çŠ¶æ€æœº**: Spring State Machine
- **ä»»åŠ¡è°ƒåº¦**: Quartz

### é€šçŸ¥æŠ€æœ¯
- **çŸ­ä¿¡é€šçŸ¥**: é˜¿é‡Œäº‘çŸ­ä¿¡ã€è…¾è®¯äº‘çŸ­ä¿¡
- **é‚®ä»¶é€šçŸ¥**: Spring Mailã€JavaMail
- **ç§»åŠ¨æ¨é€**: æå…‰æ¨é€ã€åä¸ºæ¨é€
- **å¾®ä¿¡é€šçŸ¥**: ä¼ä¸šå¾®ä¿¡ã€æœåŠ¡å·

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´è¦æ±‚
- **è®¿å®¢é¢„çº¦åˆ›å»º**: â‰¤ 2s (95%åˆ†ä½)
- **å®¡æ‰¹æµç¨‹å¯åŠ¨**: â‰¤ 1s (95%åˆ†ä½)
- **è·¨æœåŠ¡æƒé™ä¸‹å‘**: â‰¤ 3s (95%åˆ†ä½)
- **æƒé™éªŒè¯**: â‰¤ 500ms (95%åˆ†ä½)
- **è®¿å®¢ç­¾åˆ°**: â‰¤ 3s (95%åˆ†ä½)

### å¹¶å‘å¤„ç†èƒ½åŠ›
- **å¹¶å‘é¢„çº¦æ•°**: â‰¥ 10,000/åˆ†é’Ÿ
- **åŒæ—¶åœ¨çº¿è®¿å®¢**: â‰¥ 5,000
- **è·¨æœåŠ¡è°ƒç”¨QPS**: â‰¥ 500
- **æƒé™ä¸‹å‘åå**: â‰¥ 200/åˆ†é’Ÿ
- **å®¡æ‰¹å¤„ç†åå**: â‰¥ 1,000ä¸ª/åˆ†é’Ÿ
- **æƒé™éªŒè¯QPS**: â‰¥ 50,000

### æ•°æ®å¤„ç†èƒ½åŠ›
- **è®¿å®¢è®°å½•å­˜å‚¨**: æ”¯æŒè‡³å°‘3å¹´æ•°æ®
- **æŸ¥è¯¢å“åº”æ—¶é—´**: â‰¤ 1s (å¤æ‚æŸ¥è¯¢)
- **æŠ¥è¡¨ç”Ÿæˆæ—¶é—´**: â‰¤ 30s
- **æ•°æ®åŒæ­¥å»¶è¿Ÿ**: â‰¤ 5s

---

## ğŸ“‹ æ ¸å¿ƒç®—æ³•

### æ™ºèƒ½è°ƒåº¦ç®—æ³•
```java
@Component
public class IntelligentScheduler {

    public AppointmentSlot findOptimalSlot(AppointmentRequest request) {
        // 1. è·å–å¯ç”¨æ—¶é—´æ®µ
        List<TimeSlot> availableSlots = getAvailableTimeSlots(request);

        // 2. å¤šç›®æ ‡ä¼˜åŒ–ï¼ˆæ—¶é—´ã€èµ„æºã€ä½“éªŒï¼‰
        OptimizationProblem problem = buildOptimizationProblem(availableSlots, request);

        // 3. ä½¿ç”¨é—ä¼ ç®—æ³•æ±‚è§£æœ€ä¼˜è§£
        GeneticAlgorithm ga = new GeneticAlgorithm(problem);
        Individual bestSolution = ga.evolve();

        return convertToAppointmentSlot(bestSolution);
    }

    private OptimizationProblem buildOptimizationProblem(List<TimeSlot> slots, AppointmentRequest request) {
        return OptimizationProblem.builder()
                .objective1("time_preference")  // æ—¶é—´åå¥½
                .objective2("resource_utilization")  // èµ„æºåˆ©ç”¨ç‡
                .objective3("visitor_experience")  // è®¿å®¢ä½“éªŒ
                .constraints(buildConstraints(slots, request))
                .build();
    }
}
```

### å®¡æ‰¹å†³ç­–ä¼˜åŒ–
```java
@Component
public class ApprovalDecisionOptimizer {

    public ApprovalDecision optimizeDecision(ApprovalContext context) {
        // 1. é£é™©è¯„ä¼°
        RiskAssessment risk = assessRisk(context);

        // 2. å†³ç­–æ ‘åˆ†æ
        DecisionTree decisionTree = buildDecisionTree(risk);

        // 3. æœºå™¨å­¦ä¹ é¢„æµ‹
        MLDecisionPrediction prediction = mlModel.predict(context);

        // 4. ç»¼åˆå†³ç­–
        return combineDecisions(decisionTree, prediction, context);
    }

    private RiskAssessment assessRisk(ApprovalContext context) {
        return RiskAssessment.builder()
                .securityRisk(calculateSecurityRisk(context))
                .complianceRisk(calculateComplianceRisk(context))
                .operationalRisk(calculateOperationalRisk(context))
                .reputationRisk(calculateReputationRisk(context))
                .build();
    }
}
```

---

## ğŸ›¡ï¸ å®‰å…¨å’Œéšç§

### è®¿å®¢éšç§ä¿æŠ¤
```java
@Entity
public class Visitor {

    @Convert(converter = EncryptedStringConverter.class)
    private String idCardNumber;     // èº«ä»½è¯å·åŠ å¯†

    @Convert(converter = EncryptedStringConverter.class)
    private String phoneNumber;       // æ‰‹æœºå·åŠ å¯†

    @Convert(converter = EncryptedStringConverter.class)
    private String email;             // é‚®ç®±åŠ å¯†

    @Column(columnDefinition = "POINT")
    private Point homeAddress;         // å®¶åº­ä½å€è„±æ•å­˜å‚¨
}

// è®¿å®¢æ•°æ®è„±æ•
@RestController
public class VisitorController {

    @GetMapping("/visitors")
    public ResponseDTO<List<VisitorDTO>> getVisitors(VisitorQueryRequest request) {
        List<Visitor> visitors = visitorService.queryVisitors(request);

        // æ•æ„Ÿä¿¡æ¯è„±æ•
        List<VisitorDTO> visitorDTOs = visitors.stream()
                .map(this::maskSensitiveData)
                .collect(Collectors.toList());

        return ResponseDTO.ok(visitorDTOs);
    }

    private VisitorDTO maskSensitiveData(Visitor visitor) {
        VisitorDTO dto = new VisitorDTO(visitor);
        dto.setIdCardNumber(maskIdCard(visitor.getIdCardNumber()));
        dto.setPhoneNumber(maskPhone(visitor.getPhoneNumber()));
        return dto;
    }
}
```

### è®¿å®¢å®‰å…¨ç®¡æ§
```java
@Service
public class VisitorSecurityService {

    @Resource
    private BlacklistService blacklistService;

    @Resource
    private RiskEvaluationService riskService;

    public SecurityCheckResult checkVisitorSecurity(Visitor visitor) {
        // 1. é»‘åå•æ£€æŸ¥
        BlacklistCheck blacklistCheck = blacklistService.check(visitor);
        if (blacklistCheck.isBlacklisted()) {
            return SecurityCheckResult.blocked("è®¿å®¢åœ¨é»‘åå•ä¸­");
        }

        // 2. é£é™©è¯„ä¼°
        RiskEvaluation riskEvaluation = riskService.evaluate(visitor);
        if (riskEvaluation.getRiskScore() > RISK_THRESHOLD) {
            return SecurityCheckResult.restricted("è®¿å®¢é£é™©è¯„åˆ†è¿‡é«˜");
        }

        // 3. èº«ä»½éªŒè¯
        IdentityVerificationResult identityResult = verifyIdentity(visitor);
        if (!identityResult.isVerified()) {
            return SecurityCheckResult.failed("èº«ä»½éªŒè¯å¤±è´¥");
        }

        return SecurityCheckResult.passed();
    }
}
```

---

## ğŸ“± ç§»åŠ¨ç«¯æ”¯æŒ

### è®¿å®¢ç§»åŠ¨åº”ç”¨
```java
@RestController
@RequestMapping("/api/v1/visitor/mobile")
public class VisitorMobileController {

    @PostMapping("/appointment")
    public ResponseDTO<AppointmentResult> createAppointmentByMobile(@Valid @RequestBody MobileAppointmentRequest request) {
        // ç§»åŠ¨ç«¯é¢„çº¦é€»è¾‘
        request.setSource("MOBILE_APP");
        AppointmentResult result = visitorService.createAppointment(request);

        // å‘é€ç§»åŠ¨æ¨é€é€šçŸ¥
        mobileNotificationService.sendAppointmentConfirmation(result);

        return ResponseDTO.ok(result);
    }

    @PostMapping("/checkin")
    public ResponseDTO<CheckinResult> checkinByMobile(@Valid @RequestBody MobileCheckinRequest request) {
        // ç§»åŠ¨ç«¯ç­¾åˆ°é€»è¾‘
        CheckinResult result = visitorService.checkin(request);

        // ç”ŸæˆäºŒç»´ç 
        String qrCode = qrCodeService.generateCheckinQrCode(result);
        result.setQrCode(qrCode);

        return ResponseDTO.ok(result);
    }
}
```

---

## ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•

### åŠŸèƒ½å¼€å‘æ£€æŸ¥
- [ ] è®¿å®¢é¢„çº¦ç³»ç»Ÿå®ç°
- [ ] å®¡æ‰¹æµç¨‹å¼•æ“é›†æˆ
- [ ] è·¨æœåŠ¡æƒé™ä¸‹å‘å®ç°
- [ ] æƒé™æ—¶æ•ˆç®¡ç†ç³»ç»Ÿå¼€å‘
- [ ] ç§»åŠ¨ç«¯åº”ç”¨æ”¯æŒ
- [ ] è®¿å®¢æ•°æ®åˆ†æ

### æ€§èƒ½æ£€æŸ¥
- [ ] é«˜å¹¶å‘é¢„çº¦å¤„ç†
- [ ] è·¨æœåŠ¡è°ƒç”¨æ€§èƒ½ä¼˜åŒ–
- [ ] å·¥ä½œæµå¼•æ“æ€§èƒ½
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥å®ç°
- [ ] ç§»åŠ¨ç«¯å“åº”ä¼˜åŒ–

### å®‰å…¨æ£€æŸ¥
- [ ] è®¿å®¢æ•°æ®åŠ å¯†
- [ ] é»‘åå•ç®¡ç†
- [ ] é£é™©è¯„ä¼°ç®—æ³•
- [ ] å®¡è®¡æ—¥å¿—è®°å½•
- [ ] éšç§ä¿æŠ¤æªæ–½

---

## ğŸ”— ç›¸å…³æŠ€èƒ½æ–‡æ¡£

- **access-service-specialist**: é—¨ç¦è®¿é—®æ§åˆ¶ä¸“å®¶ï¼ˆè¢«è°ƒç”¨æ–¹ï¼‰
- **workflow-engine-specialist**: å·¥ä½œæµå¼•æ“ä¸“å®¶
- **gateway-service-specialist**: ç½‘å…³æœåŠ¡ä¸“å®¶ï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰
- **mobile-app-development-specialist**: ç§»åŠ¨åº”ç”¨å¼€å‘ä¸“å®¶
- **security-protection-specialist**: å®‰å…¨é˜²æŠ¤ä¸“å®¶
- **data-analytics-specialist**: æ•°æ®åˆ†æä¸“å®¶
- **user-experience-specialist**: ç”¨æˆ·ä½“éªŒä¸“å®¶

---

## ğŸ“ è”ç³»å’Œæ”¯æŒ

**æŠ€èƒ½è´Ÿè´£äºº**: è®¿å®¢æœåŠ¡å¼€å‘å›¢é˜Ÿ
**æŠ€æœ¯æ”¯æŒ**: æ¶æ„å¸ˆå›¢é˜Ÿ + å®‰å…¨å›¢é˜Ÿ
**é—®é¢˜åé¦ˆ**: é€šè¿‡é¡¹ç›®ç®¡ç†ç³»ç»Ÿæäº¤

**ç‰ˆæœ¬ä¿¡æ¯**:
- **åˆ›å»ºæ—¶é—´**: 2025-12-02
- **æœ€åæ›´æ–°**: 2025-12-02
- **ç‰ˆæœ¬**: v1.0.0

---

**ğŸ’¡ é‡è¦æé†’**: æœ¬æŠ€èƒ½ä¸“æ³¨äºè®¿å®¢ç®¡ç†çš„æ ¸å¿ƒä¸šåŠ¡ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡è·¨æœåŠ¡è°ƒç”¨å°†è®¿å®¢æƒé™ä¸‹å‘åˆ°é—¨ç¦è®¾å¤‡ã€‚éœ€è¦ç»“åˆé—¨ç¦æœåŠ¡ï¼ˆè¢«è°ƒç”¨æ–¹ï¼‰ã€å·¥ä½œæµå¼•æ“ã€ç½‘å…³æœåŠ¡ã€ç§»åŠ¨å¼€å‘ã€å®‰å…¨é˜²æŠ¤ç­‰ç›¸å…³æŠ€èƒ½ä¸€èµ·ä½¿ç”¨ï¼Œç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚æ³¨æ„ï¼šè®¿å®¢æœåŠ¡æ˜¯ç‹¬ç«‹æ¨¡å—ï¼Œé€šè¿‡APIç½‘å…³è°ƒç”¨é—¨ç¦æœåŠ¡è¿›è¡Œè®¾å¤‡æƒé™ç®¡ç†ã€‚