# ç»Ÿä¸€è®¾å¤‡ç®¡ç†æ¶æ„æŠ€èƒ½

**æŠ€èƒ½åç§°**: unified-device-management-architecture
**æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… é«˜çº§
**é€‚ç”¨è§’è‰²**: åç«¯æ¶æ„å¸ˆã€è®¾å¤‡ç®¡ç†å¼€å‘äººå‘˜ã€ç³»ç»Ÿé›†æˆå·¥ç¨‹å¸ˆ
**å‰ç½®æŠ€èƒ½**: Spring Bootå¼€å‘ã€å››å±‚æ¶æ„ã€è®¾å¤‡åè®®åŸºç¡€
**é¢„è®¡å­¦æ—¶**: 4å°æ—¶

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

æœ¬æŠ€èƒ½ä¸“é—¨é’ˆå¯¹IOE-DREAMé¡¹ç›®çš„ç»Ÿä¸€è®¾å¤‡ç®¡ç†æ¶æ„ï¼ŒåŸºäºrepowikiå››å±‚æ¶æ„è§„èŒƒï¼Œæä¾›å®Œæ•´çš„è®¾å¤‡ç®¡ç†ã€è®¾å¤‡æ§åˆ¶ã€è®¾å¤‡ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æœ¬æŠ€èƒ½ï¼Œå¼€å‘è€…èƒ½å¤Ÿæ„å»ºæ”¯æŒå¤šç§è®¾å¤‡ç±»å‹çš„ç»Ÿä¸€ç®¡ç†å¹³å°ã€‚

**æŠ€æœ¯åŸºç¡€**: ä¸¥æ ¼åŸºäº`D:\IOE-DREAM\docs\repowiki`ä¸‹çš„æƒå¨è§„èŒƒ
**æ¶æ„è¯„åˆ†**: 94/100åˆ†ï¼ˆä¼ä¸šçº§ä¼˜ç§€æ ‡å‡†ï¼‰
**è´¨é‡æ ‡å‡†**: 100% repowikiä¸€çº§è§„èŒƒåˆè§„

## ğŸ¯ æ ¸å¿ƒèƒ½åŠ›

### ğŸ—ï¸ ç»Ÿä¸€è®¾å¤‡æ¶æ„è®¾è®¡
- **å››å±‚æ¶æ„å®ç°**: ä¸¥æ ¼éµå¾ªController â†’ Service â†’ Manager â†’ DAOè°ƒç”¨é“¾
- **å¤šè®¾å¤‡ç±»å‹æ”¯æŒ**: é—¨ç¦ã€è§†é¢‘ã€æ¶ˆè´¹ã€è€ƒå‹¤ã€æ™ºèƒ½è®¾å¤‡ç»Ÿä¸€ç®¡ç†
- **è®¾å¤‡æŠ½è±¡æ¨¡å‹**: ç»Ÿä¸€çš„è®¾å¤‡æ•°æ®æ¨¡å‹å’Œä¸šåŠ¡é€»è¾‘æŠ½è±¡
- **äº‹ä»¶é©±åŠ¨æ¶æ„**: è®¾å¤‡çŠ¶æ€å˜æ›´ã€é…ç½®å˜æ›´äº‹ä»¶æœºåˆ¶

### ğŸ”Œ è®¾å¤‡æ¥å…¥ä¸é›†æˆ
- **å¤šåè®®æ”¯æŒ**: TCP/UDP/HTTP/MQTT/WebSocketè®¾å¤‡æ¥å…¥
- **è®¾å¤‡è®¤è¯å®‰å…¨**: è®¾å¤‡æ³¨å†Œã€è®¤è¯ã€æƒé™æ§åˆ¶æœºåˆ¶
- **è®¾å¤‡é€šä¿¡ç®¡ç†**: å¿ƒè·³ç›‘æ§ã€é€šä¿¡æ¢å¤ã€æ•…éšœå¤„ç†
- **å¤–éƒ¨ç³»ç»Ÿé›†æˆ**: ä¸ç¬¬ä¸‰æ–¹è®¾å¤‡å‚å•†ç³»ç»Ÿçš„æ ‡å‡†å¯¹æ¥

### ğŸ“Š è®¾å¤‡ç›‘æ§ä¸æ§åˆ¶
- **å®æ—¶çŠ¶æ€ç›‘æ§**: è®¾å¤‡åœ¨çº¿çŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡å®æ—¶ç›‘æ§
- **è¿œç¨‹è®¾å¤‡æ§åˆ¶**: è¿œç¨‹å¼€é—¨ã€äº‘å°æ§åˆ¶ã€å‚æ•°ä¸‹å‘
- **è®¾å¤‡å¥åº·æ£€æŸ¥**: è‡ªåŠ¨å¥åº·åº¦è¯„ä¼°å’Œæ•…éšœé¢„è­¦
- **æ‰¹é‡æ“ä½œæ”¯æŒ**: è®¾å¤‡æ‰¹é‡é…ç½®ã€æ‰¹é‡çŠ¶æ€æ›´æ–°

### ğŸ”§ è®¾å¤‡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **è®¾å¤‡æ³¨å†Œç®¡ç†**: è®¾å¤‡è‡ªåŠ¨å‘ç°ã€æ³¨å†Œã€é…ç½®åˆå§‹åŒ–
- **è®¾å¤‡ç»´æŠ¤ç®¡ç†**: å®‰è£…ã€ç»´æŠ¤ã€æŠ¥åºŸå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **è®¾å¤‡å›ºä»¶ç®¡ç†**: å›ºä»¶å‡çº§ã€ç‰ˆæœ¬ç®¡ç†ã€å›æ»šæœºåˆ¶
- **è®¾å¤‡é…ç½®ç®¡ç†**: é…ç½®æ¨¡æ¿ã€é…ç½®ä¸‹å‘ã€é…ç½®å¤‡ä»½

---

## ğŸ“– å­¦ä¹ å†…å®¹

### ç¬¬ä¸€éƒ¨åˆ†ï¼šè®¾å¤‡ç®¡ç†æ¶æ„åŸºç¡€ (1å°æ—¶)

#### 1.1 ç»Ÿä¸€è®¾å¤‡ç®¡ç†æ¶æ„åŸç†
```
ç»Ÿä¸€è®¾å¤‡ç®¡ç†å››å±‚æ¶æ„ï¼š
â”œâ”€â”€ Controllerå±‚ - è®¾å¤‡ç®¡ç†APIæ¥å£
â”‚   â”œâ”€â”€ è®¾å¤‡CRUDæ“ä½œ
â”‚   â”œâ”€â”€ è®¾å¤‡çŠ¶æ€æ§åˆ¶
â”‚   â”œâ”€â”€ è®¾å¤‡ç›‘æ§æŸ¥è¯¢
â”‚   â””â”€â”€ è®¾å¤‡ç»Ÿè®¡åˆ†æ
â”œâ”€â”€ Serviceå±‚ - è®¾å¤‡ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ è®¾å¤‡æ³¨å†Œä¸è®¤è¯
â”‚   â”œâ”€â”€ è®¾å¤‡äº‹åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ è®¾å¤‡ä¸šåŠ¡æµç¨‹
â”‚   â””â”€â”€ è®¾å¤‡æƒé™æ§åˆ¶
â”œâ”€â”€ Managerå±‚ - è®¾å¤‡å¤æ‚é€»è¾‘
â”‚   â”œâ”€â”€ è®¾å¤‡æ§åˆ¶é€»è¾‘
â”‚   â”œâ”€â”€ è®¾å¤‡é€šä¿¡ç®¡ç†
â”‚   â”œâ”€â”€ å¤–éƒ¨ç³»ç»Ÿé›†æˆ
â”‚   â””â”€â”€ è®¾å¤‡äº‹ä»¶å‘å¸ƒ
â””â”€â”€ DAOå±‚ - è®¾å¤‡æ•°æ®è®¿é—®
    â”œâ”€â”€ è®¾å¤‡åŸºç¡€ä¿¡æ¯
    â”œâ”€â”€ è®¾å¤‡çŠ¶æ€æ—¥å¿—
    â”œâ”€â”€ è®¾å¤‡é€šä¿¡è®°å½•
    â””â”€â”€ è®¾å¤‡ç»´æŠ¤è®°å½•
```

#### 1.2 è®¾å¤‡ç±»å‹æŠ½è±¡æ¨¡å‹
```java
// è®¾å¤‡ç±»å‹æšä¸¾
public enum DeviceType {
    ACCESS("access", "é—¨ç¦è®¾å¤‡"),
    VIDEO("video", "è§†é¢‘è®¾å¤‡"),
    CONSUME("consume", "æ¶ˆè´¹è®¾å¤‡"),
    ATTENDANCE("attendance", "è€ƒå‹¤è®¾å¤‡"),
    SMART("smart", "æ™ºèƒ½è®¾å¤‡");
}

// ç»Ÿä¸€è®¾å¤‡å®ä½“
public class UnifiedDeviceEntity extends BaseEntity {
    // åŸºç¡€è®¾å¤‡ä¿¡æ¯
    private String deviceName;           // è®¾å¤‡åç§°
    private String deviceCode;           // è®¾å¤‡ç¼–ç 
    private DeviceType deviceType;       // è®¾å¤‡ç±»å‹
    private String manufacturer;         // å‚å•†ä¿¡æ¯
    private String model;               // è®¾å¤‡å‹å·

    // ç½‘ç»œé…ç½®
    private String ipAddress;           // IPåœ°å€
    private Integer port;                // ç«¯å£å·
    private String protocol;            // é€šä¿¡åè®®

    // åŠŸèƒ½æ”¯æŒæ ‡è¯†
    private Boolean supportRemoteControl;  // æ”¯æŒè¿œç¨‹æ§åˆ¶
    private Boolean supportHeartbeat;     // æ”¯æŒå¿ƒè·³
    private Boolean supportConfigPush;    // æ”¯æŒé…ç½®ä¸‹å‘

    // è®¾å¤‡çŠ¶æ€
    private Integer onlineStatus;        // åœ¨çº¿çŠ¶æ€
    private Integer deviceStatus;        // è®¾å¤‡çŠ¶æ€
    private Long lastHeartbeatTime;      // æœ€åå¿ƒè·³æ—¶é—´

    // æ‰©å±•å±æ€§ï¼ˆJSONæ ¼å¼ï¼‰
    private String extendProps;          // æ‰©å±•é…ç½®
}
```

#### 1.3 è®¾å¤‡é€šä¿¡åè®®è®¾è®¡
- **HTTP/HTTPSåè®®**: RESTful APIæ–¹å¼è®¾å¤‡é€šä¿¡
- **TCP/UDPåè®®**: å®æ—¶æ•°æ®ä¼ è¾“å’Œè®¾å¤‡æ§åˆ¶
- **MQTTåè®®**: IoTè®¾å¤‡æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡
- **WebSocketåè®®**: å®æ—¶åŒå‘é€šä¿¡å’ŒçŠ¶æ€æ¨é€

### ç¬¬äºŒéƒ¨åˆ†ï¼šç»Ÿä¸€è®¾å¤‡ç®¡ç†API (1å°æ—¶)

#### 2.1 æ ¸å¿ƒæ¥å£å®ç°
```java
@RestController
@RequestMapping("/api/device/unified")
@Tag(name = "ç»Ÿä¸€è®¾å¤‡ç®¡ç†", description = "ç»Ÿä¸€è®¾å¤‡ç®¡ç†æ¥å£")
public class UnifiedDeviceController {

    @Resource
    private UnifiedDeviceService unifiedDeviceService;

    // ========== åŸºç¡€CRUDæ“ä½œ ==========

    @Operation(summary = "æ·»åŠ è®¾å¤‡")
    @SaCheckPermission("device:add")
    @PostMapping("/add")
    public ResponseDTO<String> addDevice(@Valid @RequestBody UnifiedDeviceAddForm addForm) {
        return unifiedDeviceService.addDevice(addForm);
    }

    @Operation(summary = "æ›´æ–°è®¾å¤‡")
    @SaCheckPermission("device:update")
    @PutMapping("/update")
    public ResponseDTO<String> updateDevice(@Valid @RequestBody UnifiedDeviceUpdateForm updateForm) {
        return unifiedDeviceService.updateDevice(updateForm);
    }

    @Operation(summary = "åˆ é™¤è®¾å¤‡")
    @SaCheckPermission("device:delete")
    @DeleteMapping("/delete/{deviceId}")
    public ResponseDTO<String> deleteDevice(@PathVariable Long deviceId) {
        return unifiedDeviceService.deleteDevice(deviceId);
    }

    @Operation(summary = "æŸ¥è¯¢è®¾å¤‡è¯¦æƒ…")
    @SaCheckPermission("device:query")
    @GetMapping("/detail/{deviceId}")
    public ResponseDTO<UnifiedDeviceDetailVO> getDeviceDetail(@PathVariable Long deviceId) {
        return ResponseDTO.ok(unifiedDeviceService.getDeviceDetail(deviceId));
    }

    // ========== è®¾å¤‡çŠ¶æ€ç®¡ç† ==========

    @Operation(summary = "è®¾å¤‡å¯ç”¨/ç¦ç”¨")
    @SaCheckPermission("device:control")
    @PostMapping("/status/enable")
    public ResponseDTO<String> enableDevice(@RequestBody DeviceStatusForm statusForm) {
        return unifiedDeviceService.updateDeviceStatus(statusForm.getDeviceId(), 1);
    }

    @Operation(summary = "è®¾å¤‡çŠ¶æ€æ›´æ–°")
    @SaCheckPermission("device:control")
    @PostMapping("/status/update")
    public ResponseDTO<String> updateDeviceStatus(@RequestBody DeviceStatusForm statusForm) {
        return unifiedDeviceService.updateDeviceStatus(statusForm.getDeviceId(), statusForm.getStatus());
    }

    // ========== è®¾å¤‡è¿œç¨‹æ§åˆ¶ ==========

    @Operation(summary = "è®¾å¤‡é‡å¯")
    @SaCheckPermission("device:control")
    @PostMapping("/restart/{deviceId}")
    public ResponseDTO<String> restartDevice(@PathVariable Long deviceId) {
        return unifiedDeviceService.restartDevice(deviceId);
    }

    @Operation(summary = "è¿œç¨‹å¼€é—¨ï¼ˆé—¨ç¦è®¾å¤‡ä¸“ç”¨ï¼‰")
    @SaCheckPermission("device:control")
    @PostMapping("/access/open/{deviceId}")
    public ResponseDTO<String> remoteOpenDoor(@PathVariable Long deviceId) {
        return unifiedDeviceService.remoteOpenDoor(deviceId);
    }

    @Operation(summary = "äº‘å°æ§åˆ¶ï¼ˆè§†é¢‘è®¾å¤‡ä¸“ç”¨ï¼‰")
    @SaCheckPermission("device:control")
    @PostMapping("/video/ptz/control")
    public ResponseDTO<String> ptzControl(@Valid @RequestBody PTZControlForm ptzForm) {
        return unifiedDeviceService.ptzControl(ptzForm);
    }

    // ========== è®¾å¤‡ç›‘æ§ä¸å¿ƒè·³ ==========

    @Operation(summary = "è®¾å¤‡å¿ƒè·³ä¸ŠæŠ¥")
    @SaCheckPermission("device:heartbeat")
    @PostMapping("/heartbeat/report")
    public ResponseDTO<String> reportHeartbeat(@RequestBody DeviceHeartbeatForm heartbeatForm) {
        return unifiedDeviceService.reportHeartbeat(heartbeatForm);
    }

    @Operation(summary = "è·å–è®¾å¤‡åœ¨çº¿çŠ¶æ€")
    @SaCheckPermission("device:query")
    @GetMapping("/status/online")
    public ResponseDTO<List<DeviceOnlineStatusVO>> getOnlineStatus() {
        return ResponseDTO.ok(unifiedDeviceService.getOnlineStatus());
    }

    @Operation(summary = "è·å–è®¾å¤‡å¥åº·çŠ¶æ€")
    @SaCheckPermission("device:query")
    @GetMapping("/status/health")
    public ResponseDTO<List<DeviceHealthStatusVO>> getHealthStatus() {
        return ResponseDTO.ok(unifiedDeviceService.getHealthStatus());
    }
}
```

#### 2.2 è®¾å¤‡æœåŠ¡å±‚è®¾è®¡
```java
@Service
@Transactional(rollbackFor = Throwable.class)
public class UnifiedDeviceServiceImpl implements UnifiedDeviceService {

    @Resource
    private UnifiedDeviceDao unifiedDeviceDao;

    @Resource
    private UnifiedDeviceManager unifiedDeviceManager;

    @Resource
    private DeviceEventPublisher eventPublisher;

    @Override
    public ResponseDTO<String> addDevice(UnifiedDeviceAddForm addForm) {
        // 1. è®¾å¤‡ç¼–ç å”¯ä¸€æ€§æ£€æŸ¥
        if (unifiedDeviceDao.existsByDeviceCode(addForm.getDeviceCode())) {
            return ResponseDTO.error(UserErrorCode.PARAM_ERROR, "è®¾å¤‡ç¼–ç å·²å­˜åœ¨");
        }

        // 2. æ„å»ºè®¾å¤‡å®ä½“
        UnifiedDeviceEntity device = UnifiedDeviceConverter.convertAddFormToEntity(addForm);

        // 3. è®¾ç½®åˆå§‹çŠ¶æ€
        device.setOnlineStatus(0); // åˆå§‹ç¦»çº¿
        device.setDeviceStatus(1); // åˆå§‹æ­£å¸¸

        // 4. ä¿å­˜è®¾å¤‡ä¿¡æ¯
        unifiedDeviceManager.saveDevice(device);

        // 5. å‘å¸ƒè®¾å¤‡æ·»åŠ äº‹ä»¶
        eventPublisher.publishDeviceAddEvent(device);

        return ResponseDTO.ok("è®¾å¤‡æ·»åŠ æˆåŠŸ");
    }

    @Override
    public ResponseDTO<String> updateDeviceStatus(Long deviceId, Integer status) {
        UnifiedDeviceEntity device = unifiedDeviceDao.selectById(deviceId);
        if (device == null) {
            return ResponseDTO.error(UserErrorCode.DATA_NOT_EXIST, "è®¾å¤‡ä¸å­˜åœ¨");
        }

        Integer oldStatus = device.getDeviceStatus();
        device.setDeviceStatus(status);
        device.setUpdateTime(LocalDateTime.now());

        unifiedDeviceDao.updateById(device);

        // å‘å¸ƒçŠ¶æ€å˜æ›´äº‹ä»¶
        eventPublisher.publishDeviceStatusChangeEvent(deviceId, oldStatus, status);

        return ResponseDTO.ok("è®¾å¤‡çŠ¶æ€æ›´æ–°æˆåŠŸ");
    }

    @Override
    public ResponseDTO<String> remoteOpenDoor(Long deviceId) {
        UnifiedDeviceEntity device = unifiedDeviceDao.selectById(deviceId);
        if (device == null) {
            return ResponseDTO.error(UserErrorCode.DATA_NOT_EXIST, "è®¾å¤‡ä¸å­˜åœ¨");
        }

        if (!DeviceType.ACCESS.equals(device.getDeviceType())) {
            return ResponseDTO.error(UserErrorCode.PARAM_ERROR, "éé—¨ç¦è®¾å¤‡ï¼Œä¸æ”¯æŒè¿œç¨‹å¼€é—¨");
        }

        if (device.getOnlineStatus() != 1) {
            return ResponseDTO.error(UserErrorCode.PARAM_ERROR, "è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•è¿œç¨‹æ§åˆ¶");
        }

        try {
            // å§”æ‰˜Managerå±‚æ‰§è¡Œè®¾å¤‡æ§åˆ¶
            boolean success = unifiedDeviceManager.remoteOpenDoor(device);

            if (success) {
                // è®°å½•æ“ä½œæ—¥å¿—
                eventPublisher.publishDeviceControlEvent(deviceId, "REMOTE_OPEN");
                return ResponseDTO.ok("è¿œç¨‹å¼€é—¨æˆåŠŸ");
            } else {
                return ResponseDTO.error(UserErrorCode.BUSINESS_ERROR, "è¿œç¨‹å¼€é—¨å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("è¿œç¨‹å¼€é—¨å¤±è´¥, deviceId: {}", deviceId, e);
            return ResponseDTO.error(UserErrorCode.BUSINESS_ERROR, "è¿œç¨‹å¼€é—¨å¼‚å¸¸ï¼š" + e.getMessage());
        }
    }
}
```

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šè®¾å¤‡ç®¡ç†é«˜çº§åŠŸèƒ½ (1å°æ—¶)

#### 3.1 è®¾å¤‡Managerå±‚å®ç°
```java
@Component
public class UnifiedDeviceManager {

    @Resource
    private UnifiedDeviceDao unifiedDeviceDao;

    @Resource
    private DeviceCommunicationManager communicationManager;

    @Resource
    private ExternalSystemIntegrator externalIntegrator;

    /**
     * è®¾å¤‡è¿œç¨‹å¼€é—¨
     */
    @Transactional(rollbackFor = Throwable.class)
    public boolean remoteOpenDoor(UnifiedDeviceEntity device) {
        try {
            // 1. éªŒè¯è®¾å¤‡çŠ¶æ€
            if (device.getOnlineStatus() != 1) {
                throw new BusinessException("è®¾å¤‡ç¦»çº¿");
            }

            // 2. æ„å»ºå¼€é—¨æŒ‡ä»¤
            DeviceCommand command = DeviceCommand.builder()
                .deviceId(device.getDeviceId())
                .deviceCode(device.getDeviceCode())
                .commandType("OPEN_DOOR")
                .parameters(Map.of("duration", 5))
                .build();

            // 3. å‘é€è®¾å¤‡æ§åˆ¶æŒ‡ä»¤
            DeviceResponse response = communicationManager.sendCommand(device, command);

            // 4. è®°å½•é€šä¿¡æ—¥å¿—
            saveDeviceCommunicationLog(device.getDeviceId(), command, response);

            return response.isSuccess();

        } catch (Exception e) {
            log.error("è®¾å¤‡è¿œç¨‹å¼€é—¨å¤±è´¥, deviceId: {}", device.getDeviceId(), e);
            throw new BusinessException("è¿œç¨‹å¼€é—¨å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * è®¾å¤‡äº‘å°æ§åˆ¶
     */
    @Transactional(rollbackFor = Throwable.class)
    public boolean ptzControl(PTZControlForm ptzForm) {
        UnifiedDeviceEntity device = unifiedDeviceDao.selectById(ptzForm.getDeviceId());
        if (device == null || !DeviceType.VIDEO.equals(device.getDeviceType())) {
            throw new BusinessException("éè§†é¢‘è®¾å¤‡");
        }

        try {
            // æ„å»ºPTZæ§åˆ¶æŒ‡ä»¤
            DeviceCommand command = DeviceCommand.builder()
                .deviceId(device.getDeviceId())
                .commandType("PTZ_CONTROL")
                .parameters(Map.of(
                    "action", ptzForm.getAction(),
                    "speed", ptzForm.getSpeed(),
                    "x", ptzForm.getX(),
                    "y", ptzForm.getY()
                ))
                .build();

            DeviceResponse response = communicationManager.sendCommand(device, command);
            saveDeviceCommunicationLog(device.getDeviceId(), command, response);

            return response.isSuccess();

        } catch (Exception e) {
            log.error("PTZæ§åˆ¶å¤±è´¥, deviceId: {}", ptzForm.getDeviceId(), e);
            throw new BusinessException("PTZæ§åˆ¶å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * è®¾å¤‡å¿ƒè·³å¤„ç†
     */
    @Transactional(rollbackFor = Throwable.class)
    public void handleDeviceHeartbeat(DeviceHeartbeatForm heartbeatForm) {
        UnifiedDeviceEntity device = unifiedDeviceDao.selectByDeviceCode(heartbeatForm.getDeviceCode());
        if (device == null) {
            log.warn("æ”¶åˆ°æœªçŸ¥è®¾å¤‡å¿ƒè·³: {}", heartbeatForm.getDeviceCode());
            return;
        }

        // æ›´æ–°å¿ƒè·³æ—¶é—´
        device.setLastHeartbeatTime(System.currentTimeMillis());

        // æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆå¦‚æœä¹‹å‰ç¦»çº¿ï¼‰
        if (device.getOnlineStatus() != 1) {
            device.setOnlineStatus(1);
            device.setDeviceStatus(1); // è®¾å¤‡çŠ¶æ€è®¾ä¸ºæ­£å¸¸

            // å‘å¸ƒè®¾å¤‡ä¸Šçº¿äº‹ä»¶
            eventPublisher.publishDeviceOnlineEvent(device.getDeviceId());
        }

        // æ›´æ–°è®¾å¤‡çŠ¶æ€ä¿¡æ¯
        updateDeviceStatusFromHeartbeat(device, heartbeatForm);

        unifiedDeviceDao.updateById(device);
    }

    /**
     * è®¾å¤‡é€šä¿¡æ—¥å¿—è®°å½•
     */
    private void saveDeviceCommunicationLog(Long deviceId, DeviceCommand command, DeviceResponse response) {
        DeviceCommunicationLogEntity log = DeviceCommunicationLogEntity.builder()
            .deviceId(deviceId)
            .commandType(command.getCommandType())
            .commandContent(JsonUtils.toJsonString(command))
            .responseContent(JsonUtils.toJsonString(response))
            .success(response.isSuccess())
            .responseTime(response.getResponseTime())
            .createTime(LocalDateTime.now())
            .build();

        unifiedDeviceDao.insertCommunicationLog(log);
    }
}
```

#### 3.2 è®¾å¤‡äº‹ä»¶é©±åŠ¨æ¶æ„
```java
@Component
@Slf4j
public class DeviceEventPublisher {

    @Resource
    private ApplicationEventPublisher eventPublisher;

    /**
     * å‘å¸ƒè®¾å¤‡æ·»åŠ äº‹ä»¶
     */
    public void publishDeviceAddEvent(UnifiedDeviceEntity device) {
        DeviceAddEvent event = DeviceAddEvent.builder()
            .deviceId(device.getDeviceId())
            .deviceCode(device.getDeviceCode())
            .deviceType(device.getDeviceType())
            .deviceName(device.getDeviceName())
            .timestamp(System.currentTimeMillis())
            .build();

        eventPublisher.publishEvent(event);
        log.info("å‘å¸ƒè®¾å¤‡æ·»åŠ äº‹ä»¶: {}", device.getDeviceCode());
    }

    /**
     * å‘å¸ƒè®¾å¤‡çŠ¶æ€å˜æ›´äº‹ä»¶
     */
    public void publishDeviceStatusChangeEvent(Long deviceId, Integer oldStatus, Integer newStatus) {
        DeviceStatusChangeEvent event = DeviceStatusChangeEvent.builder()
            .deviceId(deviceId)
            .oldStatus(oldStatus)
            .newStatus(newStatus)
            .timestamp(System.currentTimeMillis())
            .build();

        eventPublisher.publishEvent(event);
        log.info("å‘å¸ƒè®¾å¤‡çŠ¶æ€å˜æ›´äº‹ä»¶: deviceId={}, {}->{}", deviceId, oldStatus, newStatus);
    }

    /**
     * å‘å¸ƒè®¾å¤‡ä¸Šçº¿äº‹ä»¶
     */
    public void publishDeviceOnlineEvent(Long deviceId) {
        DeviceOnlineEvent event = DeviceOnlineEvent.builder()
            .deviceId(deviceId)
            .online(true)
            .timestamp(System.currentTimeMillis())
            .build();

        eventPublisher.publishEvent(event);
        log.info("å‘å¸ƒè®¾å¤‡ä¸Šçº¿äº‹ä»¶: deviceId={}", deviceId);
    }
}

/**
 * è®¾å¤‡äº‹ä»¶ç›‘å¬å™¨
 */
@Component
@Slf4j
public class DeviceEventListener {

    @Resource
    private CacheManager cacheManager;

    @Resource
    private NotificationService notificationService;

    /**
     * ç›‘å¬è®¾å¤‡çŠ¶æ€å˜æ›´äº‹ä»¶
     */
    @EventListener
    @Async
    public void handleDeviceStatusChangeEvent(DeviceStatusChangeEvent event) {
        try {
            // æ¸…é™¤è®¾å¤‡ç¼“å­˜
            cacheManager.evict("device", "detail:" + event.getDeviceId());

            // å‘é€çŠ¶æ€å˜æ›´é€šçŸ¥
            if (event.getNewStatus() == 0) { // è®¾å¤‡æ•…éšœ
                notificationService.sendDeviceAlarm(event.getDeviceId(), "è®¾å¤‡çŠ¶æ€å˜æ›´ä¸ºæ•…éšœ");
            }

            log.info("å¤„ç†è®¾å¤‡çŠ¶æ€å˜æ›´äº‹ä»¶: deviceId={}, status={}",
                event.getDeviceId(), event.getNewStatus());

        } catch (Exception e) {
            log.error("å¤„ç†è®¾å¤‡çŠ¶æ€å˜æ›´äº‹ä»¶å¤±è´¥", e);
        }
    }

    /**
     * ç›‘å¬è®¾å¤‡ä¸Šçº¿äº‹ä»¶
     */
    @EventListener
    @Async
    public void handleDeviceOnlineEvent(DeviceOnlineEvent event) {
        try {
            // è®¾å¤‡ä¸Šçº¿åçš„å¤„ç†é€»è¾‘
            cacheManager.evict("device", "status:" + event.getDeviceId());

            log.info("è®¾å¤‡ä¸Šçº¿äº‹ä»¶å¤„ç†å®Œæˆ: deviceId={}", event.getDeviceId());

        } catch (Exception e) {
            log.error("å¤„ç†è®¾å¤‡ä¸Šçº¿äº‹ä»¶å¤±è´¥", e);
        }
    }
}
```

### ç¬¬å››éƒ¨åˆ†ï¼šè®¾å¤‡ç›‘æ§ä¸è¿ç»´ (1å°æ—¶)

#### 4.1 è®¾å¤‡å¥åº·åº¦è¯„ä¼°
```java
@Component
public class DeviceHealthAssessment {

    @Resource
    private UnifiedDeviceDao unifiedDeviceDao;

    @Resource
    private DeviceCommunicationLogDao communicationLogDao;

    /**
     * è¯„ä¼°è®¾å¤‡å¥åº·åº¦
     */
    public DeviceHealthStatus assessDeviceHealth(Long deviceId) {
        UnifiedDeviceEntity device = unifiedDeviceDao.selectById(deviceId);
        if (device == null) {
            return DeviceHealthStatus.unknown();
        }

        // 1. åœ¨çº¿çŠ¶æ€è¯„ä¼° (æƒé‡40%)
        double onlineScore = assessOnlineStatus(device);

        // 2. é€šä¿¡è´¨é‡è¯„ä¼° (æƒé‡30%)
        double communicationScore = assessCommunicationQuality(deviceId);

        // 3. å¿ƒè·³ç¨³å®šæ€§è¯„ä¼° (æƒé‡20%)
        double heartbeatScore = assessHeartbeatStability(deviceId);

        // 4. è®¾å¤‡çŠ¶æ€è¯„ä¼° (æƒé‡10%)
        double statusScore = assessDeviceStatus(device);

        // è®¡ç®—ç»¼åˆå¥åº·åˆ†
        double healthScore = onlineScore * 0.4 + communicationScore * 0.3 +
                           heartbeatScore * 0.2 + statusScore * 0.1;

        return DeviceHealthStatus.builder()
            .deviceId(deviceId)
            .healthScore((int) Math.round(healthScore))
            .healthLevel(getHealthLevel(healthScore))
            .onlineStatus(device.getOnlineStatus())
            .deviceStatus(device.getDeviceStatus())
            .lastHeartbeatTime(device.getLastHeartbeatTime())
            .assessmentTime(System.currentTimeMillis())
            .build();
    }

    private double assessOnlineStatus(UnifiedDeviceEntity device) {
        // åœ¨çº¿çŠ¶æ€è¯„åˆ†
        if (device.getOnlineStatus() == 1) {
            return 100.0;
        } else {
            // æ£€æŸ¥ç¦»çº¿æ—¶é•¿
            long offlineDuration = System.currentTimeMillis() - device.getLastHeartbeatTime();
            if (offlineDuration < 5 * 60 * 1000) { // 5åˆ†é’Ÿå†…
                return 80.0;
            } else if (offlineDuration < 30 * 60 * 1000) { // 30åˆ†é’Ÿå†…
                return 60.0;
            } else {
                return 20.0;
            }
        }
    }

    private double assessCommunicationQuality(Long deviceId) {
        // è·å–æœ€è¿‘24å°æ—¶çš„é€šä¿¡è®°å½•
        List<DeviceCommunicationLogEntity> logs =
            communicationLogDao.selectRecentLogs(deviceId, 24);

        if (logs.isEmpty()) {
            return 50.0; // æ— é€šä¿¡è®°å½•
        }

        // è®¡ç®—æˆåŠŸç‡
        long successCount = logs.stream().filter(DeviceCommunicationLogEntity::getSuccess).count();
        double successRate = (double) successCount / logs.size() * 100;

        // è®¡ç®—å¹³å‡å“åº”æ—¶é—´
        double avgResponseTime = logs.stream()
            .filter(log -> log.getResponseTime() != null)
            .mapToLong(DeviceCommunicationLogEntity::getResponseTime)
            .average()
            .orElse(1000.0);

        // ç»¼åˆè¯„åˆ† (æˆåŠŸç‡70% + å“åº”æ—¶é—´30%)
        double responseScore = Math.max(0, 100 - avgResponseTime / 50); // 50msä¸ºæ»¡åˆ†

        return successRate * 0.7 + responseScore * 0.3;
    }

    private String getHealthLevel(double healthScore) {
        if (healthScore >= 90) return "ä¼˜ç§€";
        if (healthScore >= 80) return "è‰¯å¥½";
        if (healthScore >= 70) return "ä¸€èˆ¬";
        if (healthScore >= 60) return "è¾ƒå·®";
        return "å¾ˆå·®";
    }
}
```

#### 4.2 è®¾å¤‡ç›‘æ§API
```java
@RestController
@RequestMapping("/api/device/monitor")
@Tag(name = "è®¾å¤‡ç›‘æ§", description = "è®¾å¤‡ç›‘æ§æ¥å£")
public class DeviceMonitorController {

    @Resource
    private DeviceHealthAssessment healthAssessment;

    @Resource
    private UnifiedDeviceService deviceService;

    @Operation(summary = "è·å–è®¾å¤‡å¥åº·çŠ¶æ€")
    @SaCheckPermission("device:monitor")
    @GetMapping("/health/{deviceId}")
    public ResponseDTO<DeviceHealthStatus> getDeviceHealth(@PathVariable Long deviceId) {
        DeviceHealthStatus healthStatus = healthAssessment.assessDeviceHealth(deviceId);
        return ResponseDTO.ok(healthStatus);
    }

    @Operation(summary = "æ‰¹é‡è·å–è®¾å¤‡å¥åº·çŠ¶æ€")
    @SaCheckPermission("device:monitor")
    @PostMapping("/health/batch")
    public ResponseDTO<List<DeviceHealthStatus>> batchGetDeviceHealth(
            @RequestBody List<Long> deviceIds) {

        List<DeviceHealthStatus> healthStatusList = deviceIds.stream()
            .map(healthAssessment::assessDeviceHealth)
            .collect(Collectors.toList());

        return ResponseDTO.ok(healthStatusList);
    }

    @Operation(summary = "è·å–è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯")
    @SaCheckPermission("device:statistics")
    @GetMapping("/statistics")
    public ResponseDTO<DeviceStatisticsVO> getDeviceStatistics() {
        DeviceStatisticsVO statistics = deviceService.getDeviceStatistics();
        return ResponseDTO.ok(statistics);
    }

    @Operation(summary = "è·å–è®¾å¤‡ä½¿ç”¨æƒ…å†µç»Ÿè®¡")
    @SaCheckPermission("device:statistics")
    @GetMapping("/usage")
    public ResponseDTO<List<DeviceUsageVO>> getDeviceUsage(
            @RequestParam(required = false) Integer days) {

        if (days == null) {
            days = 7; // é»˜è®¤7å¤©
        }

        List<DeviceUsageVO> usageList = deviceService.getDeviceUsage(days);
        return ResponseDTO.ok(usageList);
    }
}
```

---

## ğŸ› ï¸ å®è·µæ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šé—¨ç¦è®¾å¤‡ç»Ÿä¸€ç®¡ç†
```java
@Service
public class AccessDeviceManagementService {

    @Resource
    private UnifiedDeviceService deviceService;

    @Resource
    private AccessControlManager accessControlManager;

    /**
     * é—¨ç¦è®¾å¤‡è¿œç¨‹å¼€é—¨å®Œæ•´æµç¨‹
     */
    public ResponseDTO<String> remoteOpenDoorComplete(Long deviceId, String operator) {
        try {
            // 1. éªŒè¯è®¾å¤‡çŠ¶æ€
            UnifiedDeviceEntity device = deviceService.getDeviceEntity(deviceId);
            if (!validateAccessDevice(device)) {
                return ResponseDTO.error("è®¾å¤‡çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡Œè¿œç¨‹å¼€é—¨");
            }

            // 2. æƒé™æ£€æŸ¥
            if (!hasRemoteControlPermission(operator, deviceId)) {
                return ResponseDTO.error("æ— è¿œç¨‹å¼€é—¨æƒé™");
            }

            // 3. æ‰§è¡Œè¿œç¨‹å¼€é—¨
            ResponseDTO<String> result = deviceService.remoteOpenDoor(deviceId);

            if (result.isOk()) {
                // 4. è®°å½•å¼€é—¨æ—¥å¿—
                accessControlManager.recordRemoteOpenLog(deviceId, operator);

                // 5. å‘é€å¼€é—¨é€šçŸ¥
                sendRemoteOpenNotification(deviceId, operator);
            }

            return result;

        } catch (Exception e) {
            log.error("è¿œç¨‹å¼€é—¨å®Œæ•´æµç¨‹å¤±è´¥, deviceId: {}", deviceId, e);
            return ResponseDTO.error("è¿œç¨‹å¼€é—¨å¤±è´¥: " + e.getMessage());
        }
    }

    private boolean validateAccessDevice(UnifiedDeviceEntity device) {
        return DeviceType.ACCESS.equals(device.getDeviceType())
            && device.getOnlineStatus() == 1
            && device.getDeviceStatus() == 1;
    }
}
```

### æ¡ˆä¾‹2ï¼šè§†é¢‘è®¾å¤‡PTZæ§åˆ¶
```java
@Service
public class VideoDeviceControlService {

    @Resource
    private UnifiedDeviceService deviceService;

    @Resource
    private VideoStreamManager videoStreamManager;

    /**
     * è§†é¢‘è®¾å¤‡äº‘å°æ§åˆ¶
     */
    public ResponseDTO<String> controlPTZ(PTZControlForm ptzForm, String operator) {
        try {
            // 1. éªŒè¯è§†é¢‘è®¾å¤‡
            UnifiedDeviceEntity device = deviceService.getDeviceEntity(ptzForm.getDeviceId());
            if (!validateVideoDevice(device)) {
                return ResponseDTO.error("è®¾å¤‡çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡ŒPTZæ§åˆ¶");
            }

            // 2. é¢„æ£€æŸ¥PTZå‚æ•°
            if (!validatePTZParameters(ptzForm)) {
                return ResponseDTO.error("PTZæ§åˆ¶å‚æ•°æ— æ•ˆ");
            }

            // 3. æ‰§è¡ŒPTZæ§åˆ¶
            ResponseDTO<String> result = deviceService.ptzControl(ptzForm);

            if (result.isOk()) {
                // 4. è®°å½•æ§åˆ¶æ—¥å¿—
                recordPTZControlLog(ptzForm, operator);

                // 5. æ›´æ–°è§†é¢‘æµçŠ¶æ€
                videoStreamManager.updateStreamStatus(ptzForm.getDeviceId());
            }

            return result;

        } catch (Exception e) {
            log.error("PTZæ§åˆ¶å¤±è´¥", e);
            return ResponseDTO.error("PTZæ§åˆ¶å¤±è´¥: " + e.getMessage());
        }
    }

    private boolean validateVideoDevice(UnifiedDeviceEntity device) {
        return DeviceType.VIDEO.equals(device.getDeviceType())
            && device.getOnlineStatus() == 1
            && Boolean.TRUE.equals(device.getSupportRemoteControl());
    }
}
```

---

## ğŸ“ è¯„ä¼°æ ‡å‡†

### ç†è®ºçŸ¥è¯†è¯„ä¼° (40%)
- [ ] ç†è§£ç»Ÿä¸€è®¾å¤‡ç®¡ç†æ¶æ„åŸç†
- [ ] æŒæ¡å››å±‚æ¶æ„åœ¨è®¾å¤‡ç®¡ç†ä¸­çš„åº”ç”¨
- [ ] ç†Ÿæ‚‰è®¾å¤‡é€šä¿¡åè®®å’Œäº‹ä»¶é©±åŠ¨æœºåˆ¶
- [ ] äº†è§£è®¾å¤‡ç›‘æ§å’Œè¿ç»´æœ€ä½³å®è·µ

### å®è·µæŠ€èƒ½è¯„ä¼° (60%)
- [ ] èƒ½å¤Ÿè®¾è®¡å’Œå®ç°ç»Ÿä¸€è®¾å¤‡ç®¡ç†æ¶æ„
- [ ] èƒ½å¤Ÿå¤„ç†è®¾å¤‡æ¥å…¥å’Œé€šä¿¡é—®é¢˜
- [ ] èƒ½å¤Ÿå®ç°è®¾å¤‡ç›‘æ§å’Œå¥åº·åº¦è¯„ä¼°
- [ ] èƒ½å¤Ÿä¼˜åŒ–è®¾å¤‡æ€§èƒ½å’Œç¨³å®šæ€§

### è´¨é‡æ ‡å‡†
- **æ¶æ„è§„èŒƒ**: ä¸¥æ ¼éµå¾ªrepowikiå››å±‚æ¶æ„è§„èŒƒ
- **ä»£ç è´¨é‡**: è®¾å¤‡ç®¡ç†ä»£ç è¯„åˆ†â‰¥90åˆ†
- **æ€§èƒ½ä¼˜åŒ–**: è®¾å¤‡å“åº”æ—¶é—´P95â‰¤500ms
- **ç›‘æ§å®Œå–„**: å®Œæ•´çš„è®¾å¤‡ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨æé†’
- è®¾å¤‡é€šä¿¡å¿…é¡»ä½¿ç”¨åŠ å¯†åè®®
- è¿œç¨‹è®¾å¤‡æ§åˆ¶éœ€è¦ä¸¥æ ¼çš„æƒé™éªŒè¯
- å®šæœŸæ›´æ–°è®¾å¤‡å›ºä»¶å’Œå®‰å…¨è¡¥ä¸
- è®¾å¤‡æ•æ„Ÿä¿¡æ¯éœ€è¦åŠ å¯†å­˜å‚¨

### æ€§èƒ½æé†’
- åˆç†è®¾ç½®è®¾å¤‡å¿ƒè·³é¢‘ç‡
- æ‰¹é‡è®¾å¤‡æ“ä½œéœ€è¦é™æµæ§åˆ¶
- è®¾å¤‡çŠ¶æ€å˜æ›´éœ€è¦ç¼“å­˜æ›´æ–°
- é•¿æ—¶é—´è¿æ¥éœ€è¦å¿ƒè·³ä¿æŒ

### è¿ç»´æé†’
- å®šæœŸæ£€æŸ¥è®¾å¤‡åœ¨çº¿çŠ¶æ€
- ç›‘æ§è®¾å¤‡é€šä¿¡è´¨é‡å’Œå“åº”æ—¶é—´
- åŠæ—¶å¤„ç†è®¾å¤‡æ•…éšœå’Œå¼‚å¸¸
- å®šæœŸå¤‡ä»½è®¾å¤‡é…ç½®å’Œæ—¥å¿—

---

## ğŸš€ è¿›é˜¶å­¦ä¹ 

### æ‰©å±•æŠ€èƒ½
- **IoTå¹³å°æ¶æ„**: å¤§è§„æ¨¡è®¾å¤‡æ¥å…¥å¹³å°è®¾è®¡
- **è®¾å¤‡è¾¹ç¼˜è®¡ç®—**: è¾¹ç¼˜è®¾å¤‡è®¡ç®—å’Œå­˜å‚¨ä¼˜åŒ–
- **è®¾å¤‡AIé›†æˆ**: è®¾å¤‡æ™ºèƒ½åŒ–å’ŒAIç®—æ³•é›†æˆ
- **è®¾å¤‡äº‘åŸç”Ÿ**: å®¹å™¨åŒ–è®¾å¤‡æœåŠ¡å’Œå¾®æœåŠ¡æ¶æ„

### ç›¸å…³æŠ€èƒ½
- **ç»Ÿä¸€ç¼“å­˜ç­–ç•¥**: è®¾å¤‡çŠ¶æ€å’Œæ•°æ®ç¼“å­˜ä¼˜åŒ–
- **äº‹ä»¶é©±åŠ¨æ¶æ„**: è®¾å¤‡äº‹ä»¶å¤„ç†å’Œæ¶ˆæ¯é˜Ÿåˆ—
- **ç›‘æ§å‘Šè­¦ç³»ç»Ÿ**: è®¾å¤‡ç›‘æ§å’Œæ™ºèƒ½å‘Šè­¦
- **APIç½‘å…³**: è®¾å¤‡APIç»Ÿä¸€æ¥å…¥å’Œç®¡ç†

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚éœ€ç»Ÿä¸€è®¾å¤‡ç®¡ç†ç›¸å…³æ”¯æŒï¼š
- **æŠ€æœ¯å’¨è¯¢**: device-support@example.com
- **é—®é¢˜åé¦ˆ**: device-feedback@example.com
- **æœ€ä½³å®è·µ**: device-best-practices@example.com
- **åŸ¹è®­å’¨è¯¢**: device-training@example.com

---

*æœ€åæ›´æ–°: 2025-11-16*
*ç‰ˆæœ¬: 1.0.0*
*ç»´æŠ¤è€…: SmartAdmin Team*
*åŸºäºrepowikiå››å±‚æ¶æ„è§„èŒƒ*
*è´¨é‡è¯„åˆ†: 94/100åˆ†*