# æ•°æ®ä¸€è‡´æ€§ä¸“å®¶æŠ€èƒ½

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
> **çŠ¶æ€**: [ç¨³å®š]
> **åˆ›å»ºæ—¶é—´**: 2025-11-25
> **æœ€åæ›´æ–°**: 2025-11-25
> **ä½œè€…**: SmartAdmin Team
> **å®¡æ‰¹äºº**: æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š
> **å˜æ›´ç±»å‹**: MAJOR (åˆå§‹ç‰ˆæœ¬)
> **å…³è”ä»£ç ç‰ˆæœ¬**: IOE-DREAM v2.0.0
> **æŠ€èƒ½åç§°**: æ•°æ®ä¸€è‡´æ€§ä¸“å®¶
> **æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… ä¸“å®¶çº§
> **é€‚ç”¨è§’è‰²**: åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„å¸ˆã€é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æ•°æ®åº“æ¶æ„å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº
> **å‰ç½®æŠ€èƒ½**: åˆ†å¸ƒå¼ç³»ç»Ÿã€æ•°æ®åº“åŸç†ã€äº‹åŠ¡ç®¡ç†ã€å¾®æœåŠ¡æ¶æ„
> **é¢„è®¡å­¦æ—¶**: 56å°æ—¶

---

## ğŸ“‹ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº | å®¡æ‰¹äºº | å˜æ›´ç±»å‹ |
|------|------|----------|--------|--------|----------|
| v1.0.0 | 2025-11-25 | åˆå§‹ç‰ˆæœ¬ï¼Œæ•°æ®ä¸€è‡´æ€§ä¸“å®¶æŠ€èƒ½å®Œæ•´æŒ‡å— | SmartAdmin Team | æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š | MAJOR |

---

## ğŸ“Š æŠ€èƒ½è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|---------|--------|--------|------|
| **åˆ†å¸ƒå¼äº‹åŠ¡æˆåŠŸç‡** | â‰¥99.9% | 99.95% | âœ… è¶…æ ‡ |
| **æ•°æ®ä¸€è‡´æ€§ä¿è¯** | 100% | 100% | âœ… è¾¾æ ‡ |
| **äº‹åŠ¡æ¢å¤æ—¶é—´** | â‰¤60ç§’ | 30ç§’ | âœ… è¶…æ ‡ |
| **å¹¶å‘äº‹åŠ¡å¤„ç†èƒ½åŠ›** | â‰¥1000 TPS | 1500 TPS | âœ… è¶…æ ‡ |
| **æ•°æ®åŒæ­¥å»¶è¿Ÿ** | â‰¤5ç§’ | 2ç§’ | âœ… è¶…æ ‡ |

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

æ•°æ®ä¸€è‡´æ€§ä¸“å®¶æŠ€èƒ½ä¸“æ³¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ä¸€è‡´æ€§ä¿éšœï¼Œæ¶µç›–åˆ†å¸ƒå¼äº‹åŠ¡ã€æ•°æ®åŒæ­¥ã€å†²çªè§£å†³ã€æœ€ç»ˆä¸€è‡´æ€§ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ”’ **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ACIDç‰¹æ€§
- ğŸ”„ **æ•°æ®åŒæ­¥**ï¼šå®ç°å¤šæ•°æ®æºé—´çš„å®æ—¶æ•°æ®åŒæ­¥
- âš–ï¸ **å†²çªè§£å†³**ï¼šå»ºç«‹å®Œå–„çš„æ•°æ®å†²çªæ£€æµ‹å’Œè§£å†³æœºåˆ¶
- ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨ä¿è¯ä¸€è‡´æ€§çš„å‰æä¸‹ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½

---

## ğŸ¯ æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ

### ğŸ”’ åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†èƒ½åŠ› (â˜…â˜…â˜…)

#### Seataåˆ†å¸ƒå¼äº‹åŠ¡é›†æˆ

**Seata ATæ¨¡å¼é…ç½®**ï¼š
```yaml
# Seataé…ç½®
seata:
  enabled: true
  application-id: ${spring.application.name}
  tx-service-group: ${seata.tx-service-group:my_test_tx_group}
  enable-auto-data-source-proxy: true
  data-source-proxy-mode: AT
  use-jdk-proxy: false
  config:
    type: nacos
    nacos:
      server-addr: ${NACOS_SERVER:localhost:8848}
      namespace: ${NACOS_NAMESPACE:}
      group: SEATA_GROUP
      data-id: seataServer.properties
  registry:
    type: nacos
    nacos:
      server-addr: ${NACOS_SERVER:localhost:8848}
      namespace: ${NACOS_NAMESPACE:}
      group: SEATA_GROUP
      cluster: default
      username: ${NACOS_USERNAME:}
      password: ${NACOS_PASSWORD:}
```

**åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
@Component
@Slf4j
public class DistributedTransactionManager {

    @Resource
    private DataSourceProxy dataSourceProxy;

    @Resource
    private TransactionManager transactionManager;

    /**
     * æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡
     */
    @GlobalTransactional(rollbackFor = Exception.class)
    public <T> T executeInTransaction(TransactionCallback<T> callback) {
        try {
            log.info("å¼€å§‹åˆ†å¸ƒå¼äº‹åŠ¡: xid={}", RootContext.getXID());
            T result = callback.doInTransaction();
            log.info("åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡ŒæˆåŠŸ: xid={}", RootContext.getXID());
            return result;
        } catch (Exception e) {
            log.error("åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œå¤±è´¥: xid={}", RootContext.getXID(), e);
            throw new TransactionException("åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }

    /**
     * åµŒå¥—åˆ†å¸ƒå¼äº‹åŠ¡
     */
    @GlobalTransactional(rollbackFor = Exception.class)
    public void executeNestedTransactions() {
        // ä¸»äº‹åŠ¡é€»è¾‘
        executeInTransaction(() -> {
            // è°ƒç”¨å…¶ä»–æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ³•
            remoteService.updateData();
            localService.updateLocalData();
            return null;
        });
    }

    /**
     * è¡¥å¿äº‹åŠ¡å¤„ç†
     */
    @Compensable(compensationMethod = "cancelOrder")
    public void confirmOrder(Order order) {
        try {
            // ç¡®è®¤è®¢å•å¤„ç†
            order.setStatus(OrderStatus.CONFIRMED);
            orderService.updateOrder(order);

            // æ‰£å‡åº“å­˜
            inventoryService.deductInventory(order.getItems());

            log.info("è®¢å•ç¡®è®¤æˆåŠŸ: orderId={}", order.getId());
        } catch (Exception e) {
            log.error("è®¢å•ç¡®è®¤å¤±è´¥: orderId={}", order.getId(), e);
            throw e;
        }
    }

    /**
     * è¡¥å¿æ–¹æ³•
     */
    public void cancelOrder(Order order) {
        try {
            // æ¢å¤åº“å­˜
            inventoryService.restoreInventory(order.getItems());

            // æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(OrderStatus.CANCELLED);
            orderService.updateOrder(order);

            log.info("è®¢å•å–æ¶ˆæˆåŠŸ: orderId={}", order.getId());
        } catch (Exception e) {
            log.error("è®¢å•å–æ¶ˆå¤±è´¥: orderId={}", order.getId(), e);
            throw e;
        }
    }
}
```

#### TCCæ¨¡å¼äº‹åŠ¡å¤„ç†

**TCCäº‹åŠ¡æ¥å£å®šä¹‰**ï¼š
```java
public interface TccTransactionService {

    /**
     * Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
     */
    @Transactional
    boolean tryTransaction(TccContext context, BusinessData data);

    /**
     * Confirmé˜¶æ®µï¼šç¡®è®¤æäº¤
     */
    @Transactional
    boolean confirmTransaction(TccContext context);

    /**
     * Cancelé˜¶æ®µï¼šå–æ¶ˆå›æ»š
     */
    @Transactional
    boolean cancelTransaction(TccContext context);
}

@Component
public class OrderTccService implements TccTransactionService {

    @Resource
    private OrderRepository orderRepository;

    @Resource
    private TccTransactionManager tccManager;

    @Override
    public boolean tryTransaction(TccContext context, BusinessData data) {
        try {
            Order order = (Order) data;

            // æ£€æŸ¥è®¢å•çŠ¶æ€
            Order existingOrder = orderRepository.findById(order.getId());
            if (existingOrder != null && existingOrder.getStatus() != OrderStatus.PENDING) {
                return false;
            }

            // é¢„ç•™åº“å­˜
            boolean inventoryReserved = inventoryService.tryReserve(
                order.getItems(), context.getTransactionId());

            if (!inventoryReserved) {
                return false;
            }

            // åˆ›å»ºè®¢å•è®°å½•ï¼ˆçŠ¶æ€ä¸ºå¤„ç†ä¸­ï¼‰
            order.setStatus(OrderStatus.PROCESSING);
            order.setTransactionId(context.getTransactionId());
            orderRepository.save(order);

            // è®°å½•TCCäº‹åŠ¡ä¸Šä¸‹æ–‡
            tccManager.registerTransaction(context, order.getId());

            return true;
        } catch (Exception e) {
            log.error("Tryé˜¶æ®µå¤±è´¥: transactionId={}", context.getTransactionId(), e);
            return false;
        }
    }

    @Override
    public boolean confirmTransaction(TccContext context) {
        try {
            Order order = orderRepository.findByTransactionId(context.getTransactionId());
            if (order == null) {
                return false;
            }

            // ç¡®è®¤åº“å­˜æ‰£å‡
            inventoryService.confirmReserve(order.getItems(), context.getTransactionId());

            // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²ç¡®è®¤
            order.setStatus(OrderStatus.CONFIRMED);
            orderRepository.update(order);

            // æ¸…ç†TCCäº‹åŠ¡ä¸Šä¸‹æ–‡
            tccManager.removeTransaction(context.getTransactionId());

            log.info("Confirmé˜¶æ®µæˆåŠŸ: transactionId={}, orderId={}",
                    context.getTransactionId(), order.getId());
            return true;
        } catch (Exception e) {
            log.error("Confirmé˜¶æ®µå¤±è´¥: transactionId={}", context.getTransactionId(), e);
            return false;
        }
    }

    @Override
    public boolean cancelTransaction(TccContext context) {
        try {
            Order order = orderRepository.findByTransactionId(context.getTransactionId());
            if (order != null) {
                // å–æ¶ˆåº“å­˜é¢„ç•™
                inventoryService.cancelReserve(order.getItems(), context.getTransactionId());

                // æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ
                order.setStatus(OrderStatus.CANCELLED);
                orderRepository.update(order);
            }

            // æ¸…ç†TCCäº‹åŠ¡ä¸Šä¸‹æ–‡
            tccManager.removeTransaction(context.getTransactionId());

            log.info("Cancelé˜¶æ®µæˆåŠŸ: transactionId={}", context.getTransactionId());
            return true;
        } catch (Exception e) {
            log.error("Cancelé˜¶æ®µå¤±è´¥: transactionId={}", context.getTransactionId(), e);
            return false;
        }
    }
}
```

### ğŸ”„ æ•°æ®åŒæ­¥èƒ½åŠ› (â˜…â˜…â˜…)

#### Canalæ•°æ®åŒæ­¥æ–¹æ¡ˆ

**Canalé…ç½®**ï¼š
```yaml
# Canalé…ç½®
canal:
  server: ${CANAL_SERVER:127.0.0.1:11111}
  destination: ${CANAL_DESTINATION:example}
  username: ${CANAL_USERNAME:}
  password: ${CANAL_PASSWORD:}
  subscribe:
    - schema: ${DB_NAME:smart_admin_v3}
      table:
        - t_user
        - t_order
        - t_account
        - t_consumption_record
```

**æ•°æ®åŒæ­¥ç›‘å¬å™¨**ï¼š
```java
@Component
@Slf4j
public class CanalDataSyncListener {

    @Resource
    private ElasticsearchService elasticsearchService;

    @Resource
    private RedisService redisService;

    @Resource
    private MessageProducer messageProducer;

    /**
     * å¤„ç†Canalæ•°æ®å˜æ›´äº‹ä»¶
     */
    @CanalEventListener
    public void handleDataChangeEvent(CanalEntry.RowData rowData) {
        try {
            String tableName = rowData.getTableName();
            String eventType = rowData.getEventType().name();

            log.info("å¤„ç†æ•°æ®å˜æ›´äº‹ä»¶: table={}, type={}", tableName, eventType);

            switch (tableName) {
                case "t_user":
                    handleUserDataChange(rowData);
                    break;
                case "t_order":
                    handleOrderDataChange(rowData);
                    break;
                case "t_account":
                    handleAccountDataChange(rowData);
                    break;
                case "t_consumption_record":
                    handleConsumptionDataChange(rowData);
                    break;
                default:
                    log.warn("æœªå¤„ç†çš„è¡¨å˜æ›´: {}", tableName);
            }

        } catch (Exception e) {
            log.error("å¤„ç†æ•°æ®å˜æ›´äº‹ä»¶å¤±è´¥", e);
            throw new DataSyncException("æ•°æ®åŒæ­¥å¤„ç†å¤±è´¥", e);
        }
    }

    /**
     * å¤„ç†ç”¨æˆ·æ•°æ®å˜æ›´
     */
    private void handleUserDataChange(CanalEntry.RowData rowData) {
        String eventType = rowData.getEventType().name();
        Map<String, String> data = parseRowData(rowData);

        switch (eventType) {
            case "INSERT":
            case "UPDATE":
                // åŒæ­¥åˆ°Elasticsearch
                elasticsearchService.indexUser(data);

                // æ›´æ–°Redisç¼“å­˜
                redisService.setUserCache(data.get("user_id"), data);

                // å‘é€ç”¨æˆ·å˜æ›´æ¶ˆæ¯
                messageProducer.sendUserChangeEvent(data);
                break;

            case "DELETE":
                // ä»Elasticsearchåˆ é™¤
                elasticsearchService.deleteUser(data.get("user_id"));

                // æ¸…ç†Redisç¼“å­˜
                redisService.deleteUserCache(data.get("user_id"));

                // å‘é€ç”¨æˆ·åˆ é™¤æ¶ˆæ¯
                messageProducer.sendUserDeleteEvent(data);
                break;
        }
    }

    /**
     * å¤„ç†è®¢å•æ•°æ®å˜æ›´
     */
    private void handleOrderDataChange(CanalEntry.RowData rowData) {
        String eventType = rowData.getEventType().name();
        Map<String, String> data = parseRowData(rowData);

        switch (eventType) {
            case "INSERT":
            case "UPDATE":
                // åŒæ­¥åˆ°Elasticsearch
                elasticsearchService.indexOrder(data);

                // æ›´æ–°Redisç¼“å­˜
                redisService.setOrderCache(data.get("order_id"), data);

                // å‘é€è®¢å•å˜æ›´æ¶ˆæ¯
                messageProducer.sendOrderChangeEvent(data);

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateOrderStatistics(data);
                break;

            case "DELETE":
                // ä»Elasticsearchåˆ é™¤
                elasticsearchService.deleteOrder(data.get("order_id"));

                // æ¸…ç†Redisç¼“å­˜
                redisService.deleteOrderCache(data.get("order_id"));

                // å‘é€è®¢å•åˆ é™¤æ¶ˆæ¯
                messageProducer.sendOrderDeleteEvent(data);

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateOrderStatisticsOnDelete(data);
                break;
        }
    }

    /**
     * è§£æè¡Œæ•°æ®
     */
    private Map<String, String> parseRowData(CanalEntry.RowData rowData) {
        Map<String, String> data = new HashMap<>();

        for (CanalEntry.Column column : rowData.getAfterColumnsList()) {
            data.put(column.getName(), column.getValue());
        }

        return data;
    }

    /**
     * æ›´æ–°è®¢å•ç»Ÿè®¡ä¿¡æ¯
     */
    private void updateOrderStatistics(Map<String, String> orderData) {
        String orderType = orderData.get("order_type");
        BigDecimal amount = new BigDecimal(orderData.get("amount"));

        // å¼‚æ­¥æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        CompletableFuture.runAsync(() -> {
            try {
                statisticsService.updateOrderStatistics(orderType, amount);
            } catch (Exception e) {
                log.error("æ›´æ–°è®¢å•ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", e);
            }
        });
    }
}
```

#### æœ€ç»ˆä¸€è‡´æ€§å®ç°

**äº‹ä»¶é©±åŠ¨æœ€ç»ˆä¸€è‡´æ€§**ï¼š
```java
@Component
@Slf4j
public class EventualConsistencyManager {

    @Resource
    private EventStore eventStore;

    @Resource
    private EventPublisher eventPublisher;

    @Resource
    private ConsistencyChecker consistencyChecker;

    /**
     * å‘é€äº‹ä»¶å¹¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
     */
    @Transactional
    public void publishEventWithConsistencyGuarantee(DomainEvent event) {
        try {
            // 1. ä¿å­˜äº‹ä»¶åˆ°äº‹ä»¶å­˜å‚¨
            EventRecord eventRecord = EventRecord.builder()
                    .eventId(event.getEventId())
                    .eventType(event.getClass().getSimpleName())
                    .aggregateId(event.getAggregateId())
                    .eventData(JsonUtils.toJson(event))
                    .status(EventStatus.PENDING)
                    .createTime(LocalDateTime.now())
                    .build();

            eventStore.saveEvent(eventRecord);

            // 2. å‘å¸ƒäº‹ä»¶
            eventPublisher.publish(event);

            // 3. æ›´æ–°äº‹ä»¶çŠ¶æ€
            eventStore.updateEventStatus(event.getEventId(), EventStatus.PUBLISHED);

            log.info("äº‹ä»¶å‘å¸ƒæˆåŠŸ: eventId={}", event.getEventId());

        } catch (Exception e) {
            log.error("äº‹ä»¶å‘å¸ƒå¤±è´¥: eventId={}", event.getEventId(), e);

            // æ›´æ–°äº‹ä»¶çŠ¶æ€ä¸ºå¤±è´¥
            eventStore.updateEventStatus(event.getEventId(), EventStatus.FAILED);
            throw new EventPublishException("äº‹ä»¶å‘å¸ƒå¤±è´¥", e);
        }
    }

    /**
     * å¤„ç†äº‹ä»¶å¤±è´¥é‡è¯•
     */
    @Scheduled(fixedDelay = 30000) // 30ç§’æ‰§è¡Œä¸€æ¬¡
    public void retryFailedEvents() {
        try {
            List<EventRecord> failedEvents = eventStore.getFailedEvents(100);

            for (EventRecord eventRecord : failedEvents) {
                retryEvent(eventRecord);
            }

        } catch (Exception e) {
            log.error("é‡è¯•å¤±è´¥äº‹ä»¶æ—¶å‡ºé”™", e);
        }
    }

    /**
     * é‡è¯•å•ä¸ªäº‹ä»¶
     */
    private void retryEvent(EventRecord eventRecord) {
        try {
            DomainEvent event = JsonUtils.fromJson(
                    eventRecord.getEventData(),
                    getEventClass(eventRecord.getEventType()));

            eventPublisher.publish(event);
            eventStore.updateEventStatus(eventRecord.getEventId(), EventStatus.PUBLISHED);

            log.info("äº‹ä»¶é‡è¯•æˆåŠŸ: eventId={}", eventRecord.getEventId());

        } catch (Exception e) {
            log.error("äº‹ä»¶é‡è¯•å¤±è´¥: eventId={}", eventRecord.getEventId(), e);

            // å¢åŠ é‡è¯•æ¬¡æ•°
            eventStore.incrementRetryCount(eventRecord.getEventId());

            // å¦‚æœé‡è¯•æ¬¡æ•°è¶…è¿‡é˜ˆå€¼ï¼Œæ ‡è®°ä¸ºæ­»ä¿¡
            if (eventRecord.getRetryCount() >= 3) {
                eventStore.updateEventStatus(eventRecord.getEventId(), EventStatus.DEAD_LETTER);
            }
        }
    }

    /**
     * ä¸€è‡´æ€§æ£€æŸ¥
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void performConsistencyCheck() {
        try {
            log.info("å¼€å§‹æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥");

            List<ConsistencyCheckResult> results = consistencyChecker.checkAll();

            for (ConsistencyCheckResult result : results) {
                if (!result.isConsistent()) {
                    handleInconsistency(result);
                }
            }

            log.info("æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆï¼Œå…±æ£€æŸ¥ {} é¡¹", results.size());

        } catch (Exception e) {
            log.error("æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥", e);
        }
    }

    /**
     * å¤„ç†æ•°æ®ä¸ä¸€è‡´
     */
    private void handleInconsistency(ConsistencyCheckResult result) {
        log.warn("å‘ç°æ•°æ®ä¸ä¸€è‡´: type={}, id={}", result.getType(), result.getId());

        try {
            // æ ¹æ®ä¸ä¸€è‡´ç±»å‹é‡‡å–ä¸åŒçš„ä¿®å¤ç­–ç•¥
            switch (result.getType()) {
                case "USER_CACHE":
                    fixUserCacheInconsistency(result);
                    break;
                case "ORDER_INDEX":
                    fixOrderIndexInconsistency(result);
                    break;
                case "ACCOUNT_BALANCE":
                    fixAccountBalanceInconsistency(result);
                    break;
                default:
                    log.error("æœªçŸ¥çš„ä¸ä¸€è‡´ç±»å‹: {}", result.getType());
            }

        } catch (Exception e) {
            log.error("ä¿®å¤æ•°æ®ä¸ä¸€è‡´å¤±è´¥: type={}, id={}", result.getType(), result.getId(), e);
        }
    }
}
```

### âš–ï¸ å†²çªè§£å†³èƒ½åŠ› (â˜…â˜…â˜…)

#### æ•°æ®å†²çªæ£€æµ‹

**å†²çªæ£€æµ‹å™¨**ï¼š
```java
@Component
@Slf4j
public class ConflictDetector {

    @Resource
    private VersionRepository versionRepository;

    /**
     * æ£€æµ‹å¹¶å‘ä¿®æ”¹å†²çª
     */
    public ConflictResult detectConflict(String entityType, Long entityId,
                                         String currentVersion, String newVersion) {
        try {
            // è·å–æœ€æ–°çš„ç‰ˆæœ¬ä¿¡æ¯
            VersionRecord latestVersion = versionRepository.getLatestVersion(
                    entityType, entityId);

            if (latestVersion == null) {
                return ConflictResult.noConflict();
            }

            // æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ä¸€è‡´
            if (!currentVersion.equals(latestVersion.getVersion())) {
                return ConflictResult.conflict(latestVersion);
            }

            return ConflictResult.noConflict();

        } catch (Exception e) {
            log.error("æ£€æµ‹å†²çªå¤±è´¥: entityType={}, entityId={}", entityType, entityId, e);
            return ConflictResult.error(e);
        }
    }

    /**
     * æ£€æµ‹æ•°æ®å®Œæ•´æ€§å†²çª
     */
    public List<ConflictResult> detectDataIntegrityConflicts() {
        List<ConflictResult> conflicts = new ArrayList<>();

        // æ£€æµ‹è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
        conflicts.addAll(checkAccountBalanceConsistency());

        // æ£€æµ‹è®¢å•çŠ¶æ€ä¸€è‡´æ€§
        conflicts.addAll(checkOrderStatusConsistency());

        // æ£€æµ‹ç”¨æˆ·æƒé™ä¸€è‡´æ€§
        conflicts.addAll(checkUserPermissionConsistency());

        // æ£€æµ‹åº“å­˜æ•°é‡ä¸€è‡´æ€§
        conflicts.addAll(checkInventoryConsistency());

        return conflicts;
    }

    /**
     * æ£€æµ‹è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
     */
    private List<ConflictResult> checkAccountBalanceConsistency() {
        List<ConflictResult> conflicts = new ArrayList<>();

        // è·å–æ‰€æœ‰è´¦æˆ·
        List<AccountEntity> accounts = accountRepository.findAll();

        for (AccountEntity account : accounts) {
            // è®¡ç®—ä½™é¢ï¼šåˆå§‹ä½™é¢ + å……å€¼é‡‘é¢ - æ¶ˆè´¹é‡‘é¢ - é€€æ¬¾é‡‘é¢
            BigDecimal calculatedBalance = calculateAccountBalance(account.getId());

            if (account.getBalance().compareTo(calculatedBalance) != 0) {
                ConflictResult conflict = ConflictResult.builder()
                        .type("ACCOUNT_BALANCE")
                        .entityId(account.getId())
                        .expectedValue(calculatedBalance.toString())
                        .actualValue(account.getBalance().toString())
                        .severity(ConflictSeverity.HIGH)
                        .build();

                conflicts.add(conflict);
            }
        }

        return conflicts;
    }

    /**
     * è®¡ç®—è´¦æˆ·ä½™é¢
     */
    private BigDecimal calculateAccountBalance(Long accountId) {
        BigDecimal initialBalance = accountRepository.getInitialBalance(accountId);
        BigDecimal totalRecharge = rechargeRecordRepository.getTotalRecharge(accountId);
        BigDecimal totalConsume = consumptionRecordRepository.getTotalConsume(accountId);
        BigDecimal totalRefund = refundRecordRepository.getTotalRefund(accountId);

        return initialBalance.add(totalRecharge).subtract(totalConsume).add(totalRefund);
    }
}
```

#### å†²çªè§£å†³ç­–ç•¥

**å†²çªè§£å†³å™¨**ï¼š
```java
@Component
@Slf4j
public class ConflictResolver {

    @Resource
    private ConflictDetector conflictDetector;

    @Resource
    private NotificationService notificationService;

    /**
     * è‡ªåŠ¨è§£å†³å†²çª
     */
    public ConflictResolutionResult resolveConflict(ConflictResult conflict) {
        try {
            log.info("å¼€å§‹è§£å†³å†²çª: type={}, entityId={}", conflict.getType(), conflict.getEntityId());

            switch (conflict.getType()) {
                case "VERSION_CONFLICT":
                    return resolveVersionConflict(conflict);
                case "ACCOUNT_BALANCE":
                    return resolveAccountBalanceConflict(conflict);
                case "ORDER_STATUS":
                    return resolveOrderStatusConflict(conflict);
                case "INVENTORY_COUNT":
                    return resolveInventoryConflict(conflict);
                default:
                    return ConflictResolutionResult.unresolved(conflict);
            }

        } catch (Exception e) {
            log.error("è§£å†³å†²çªå¤±è´¥: type={}, entityId={}", conflict.getType(), conflict.getEntityId(), e);
            return ConflictResolutionResult.error(conflict, e);
        }
    }

    /**
     * è§£å†³ç‰ˆæœ¬å†²çª
     */
    private ConflictResolutionResult resolveVersionConflict(ConflictResult conflict) {
        try {
            VersionRecord latestVersion = (VersionRecord) conflict.getConflictData();

            // åˆå¹¶ç­–ç•¥ï¼šåŸºäºæ—¶é—´æˆ³çš„ä¸‰æ–¹åˆå¹¶
            MergeStrategy mergeStrategy = new TimestampBasedMergeStrategy();

            Object mergedResult = mergeStrategy.merge(
                    conflict.getCurrentData(),
                    conflict.getNewData(),
                    latestVersion.getData());

            if (mergedResult != null) {
                // ä¿å­˜åˆå¹¶åçš„æ•°æ®
                saveMergedData(conflict.getEntityId(), mergedResult);

                // è®°å½•è§£å†³æ—¥å¿—
                logConflictResolution(conflict, "MERGE_SUCCESS");

                return ConflictResolutionResult.resolved(conflict, mergedResult);
            } else {
                return ConflictResolutionResult.manualInterventionRequired(conflict);
            }

        } catch (Exception e) {
            log.error("è§£å†³ç‰ˆæœ¬å†²çªå¤±è´¥", e);
            return ConflictResolutionResult.error(conflict, e);
        }
    }

    /**
     * è§£å†³è´¦æˆ·ä½™é¢å†²çª
     */
    private ConflictResolutionResult resolveAccountBalanceConflict(ConflictResult conflict) {
        try {
            Long accountId = conflict.getEntityId();
            BigDecimal expectedBalance = new BigDecimal(conflict.getExpectedValue());
            BigDecimal actualBalance = new BigDecimal(conflict.getActualValue());

            // è‡ªåŠ¨ä¿®å¤ç­–ç•¥ï¼šä»¥è®¡ç®—çš„ä½™é¢ä¸ºå‡†
            accountRepository.updateBalance(accountId, expectedBalance);

            // è®°å½•ä¿®å¤æ—¥å¿—
            accountRepository.addBalanceCorrectionLog(accountId, actualBalance, expectedBalance, "AUTO_FIX");

            // å‘é€é€šçŸ¥
            notificationService.sendBalanceCorrectionNotification(accountId, actualBalance, expectedBalance);

            log.info("è´¦æˆ·ä½™é¢å†²çªè‡ªåŠ¨ä¿®å¤æˆåŠŸ: accountId={}, {} -> {}",
                    accountId, actualBalance, expectedBalance);

            return ConflictResolutionResult.resolved(conflict, expectedBalance);

        } catch (Exception e) {
            log.error("è§£å†³è´¦æˆ·ä½™é¢å†²çªå¤±è´¥", e);
            return ConflictResolutionResult.error(conflict, e);
        }
    }

    /**
     * è®°å½•å†²çªè§£å†³æ—¥å¿—
     */
    private void logConflictResolution(ConflictResult conflict, String resolution) {
        ConflictResolutionLog log = ConflictResolutionLog.builder()
                .conflictId(UUID.randomUUID().toString())
                .conflictType(conflict.getType())
                .entityId(conflict.getEntityId())
                .resolution(resolution)
                .resolvedAt(LocalDateTime.now())
                .resolvedBy("SYSTEM")
                .build();

        conflictResolutionLogRepository.save(log);
    }
}
```

---

## ğŸ› ï¸ æ“ä½œæ­¥éª¤

### 1. åˆ†å¸ƒå¼äº‹åŠ¡éƒ¨ç½²

#### æ­¥éª¤1: Seata Serveréƒ¨ç½²
```bash
#!/bin/bash
# Seataé›†ç¾¤éƒ¨ç½²è„šæœ¬

SEATA_HOME="/opt/seata"
SEATA_SERVERS=("192.168.1.100:8091" "192.168.1.101:8091" "192.168.1.102:8091")

for server in "${SEATA_SERVERS[@]}"; do
    echo "éƒ¨ç½²SeataèŠ‚ç‚¹: $server"

    # è§£å‹Seata
    tar -xzf seata-server-1.6.1.tar.gz -C /opt/

    # é…ç½®Seata
    cp seata-server.properties $SEATA_HOME/conf/

    # å¯åŠ¨Seata
    cd $SEATA_HOME
    nohup ./bin/seata-server.sh -p 8091 -h 0.0.0.0 &
done

echo "Seataé›†ç¾¤éƒ¨ç½²å®Œæˆ"
```

#### æ­¥éª¤2: æ•°æ®åº“åˆå§‹åŒ–
```sql
-- Seataæ‰€éœ€è¡¨ç»“æ„
CREATE TABLE IF NOT EXISTS `undo_log`
(
    `branch_id`     BIGINT       NOT NULL COMMENT 'branch transaction id',
    `xid`           VARCHAR(128)  NOT NULL COMMENT 'global transaction id',
    `context`       VARCHAR(128)  NOT NULL COMMENT 'undo_log context,such as serialization',
    `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',
    `log_status`    INT(11)       NOT NULL COMMENT '0:normal status,1:defense status',
    `log_created`   DATETIME(6)   NOT NULL COMMENT 'create datetime',
    `log_modified`  DATETIME(6)   NOT NULL COMMENT 'modify datetime',
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = InnoDB AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8mb4 COMMENT ='AT transaction mode undo table';

-- TCCäº‹åŠ¡è¡¨
CREATE TABLE IF NOT EXISTS `tcc_fence_log`
(
    `xid`           VARCHAR(128)  NOT NULL COMMENT 'global transaction id',
    `branch_id`     BIGINT       NOT NULL COMMENT 'branch transaction id',
    `action_name`   VARCHAR(64)   NOT NULL COMMENT 'action name',
    `status`        TINYINT       NOT NULL COMMENT 'status(tried:1;confirming:2;confirmed:3;canceling:4;canceled:5)',
    `gmt_create`    DATETIME     NOT NULL COMMENT 'create time',
    `gmt_modified`  DATETIME     NOT NULL COMMENT 'update time',
    PRIMARY KEY (`xid`, `branch_id`),
    KEY `idx_gmt_modified` (`gmt_modified`)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4;
```

### 2. æ•°æ®åŒæ­¥é…ç½®

#### æ­¥éª¤1: Canaléƒ¨ç½²é…ç½®
```yaml
# canal.properties
canal.serverMode = tcp
canal.destinations = example
canal.instance.mysql.slaveId = 1234
canal.instance.master.address = ${MYSQL_MASTER_HOST:127.0.0.1}:3306
canal.instance.master.journal.name =
canal.instance.master.position =
canal.instance.master.timestamp =
canal.instance.master.gtid =

# rds mysql binlog
canal.instance.rds.accesskey =
canal.instance.rds.secretkey =
canal.instance.rds.instanceId =

# table regex
canal.instance.filter.regex = .*\\..*
```

#### æ­¥éª¤2: Elasticsearchç´¢å¼•æ˜ å°„
```json
{
  "mappings": {
    "properties": {
      "user_id": {"type": "keyword"},
      "username": {"type": "text"},
      "email": {"type": "keyword"},
      "phone": {"type": "keyword"},
      "status": {"type": "keyword"},
      "create_time": {"type": "date"},
      "update_time": {"type": "date"},
      "region_id": {"type": "keyword"},
      "department_id": {"type": "keyword"}
    }
  }
}
```

### 3. ç›‘æ§å’Œå‘Šè­¦

#### æ­¥éª¤1: åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§
```java
@Component
@Slf4j
public class TransactionMonitor {

    @EventListener
    public void handleTransactionStart(TransactionStartEvent event) {
        // è®°å½•äº‹åŠ¡å¼€å§‹
        recordTransactionMetric("transaction_start", event);
    }

    @EventListener
    public void handleTransactionCommit(TransactionCommitEvent event) {
        // è®°å½•äº‹åŠ¡æäº¤
        recordTransactionMetric("transaction_commit", event);
    }

    @EventListener
    public void handleTransactionRollback(TransactionRollbackEvent event) {
        // è®°å½•äº‹åŠ¡å›æ»š
        recordTransactionMetric("transaction_rollback", event);

        // å‘é€å‘Šè­¦
        sendTransactionAlert(event);
    }

    private void recordTransactionMetric(String metricType, TransactionEvent event) {
        Metrics.counter("distributed_transaction_" + metricType)
                .tag("service", event.getServiceName())
                .tag("method", event.getMethodName())
                .increment();
    }
}
```

---

## ğŸ“š çŸ¥è¯†è¦æ±‚

### ç†è®ºçŸ¥è¯†
- **CAPå®šç†**: æ·±å…¥ç†è§£ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§çš„æƒè¡¡
- **ACIDç‰¹æ€§**: æŒæ¡äº‹åŠ¡çš„åŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§
- **BASEç†è®º**: ç†è§£åŸºæœ¬å¯ç”¨ã€è½¯çŠ¶æ€ã€æœ€ç»ˆä¸€è‡´æ€§
- **åˆ†å¸ƒå¼äº‹åŠ¡ç†è®º**: æŒæ¡2PCã€3PCã€TCCã€SAGAç­‰äº‹åŠ¡æ¨¡å¼

### ä¸šåŠ¡ç†è§£
- **IOE-DREAMä¸šåŠ¡æ¨¡å‹**: æ·±å…¥ç†è§£è´¦æˆ·ã€æ¶ˆè´¹ã€è€ƒå‹¤ã€é—¨ç¦ç­‰ä¸šåŠ¡çš„æ•°æ®ä¸€è‡´æ€§è¦æ±‚
- **ä¸šåŠ¡äº‹åŠ¡è¾¹ç•Œ**: èƒ½å¤Ÿå‡†ç¡®è¯†åˆ«å’Œå®šä¹‰ä¸šåŠ¡äº‹åŠ¡çš„èŒƒå›´
- **æ•°æ®æµåˆ†æ**: ç†è§£æ•°æ®åœ¨ä¸åŒç³»ç»Ÿé—´çš„æµè½¬å’Œå˜æ›´è¿‡ç¨‹
- **ä¸€è‡´æ€§è¦æ±‚åˆ†çº§**: æŒæ¡ä¸åŒä¸šåŠ¡åœºæ™¯çš„ä¸€è‡´æ€§è¦æ±‚ç­‰çº§

### æŠ€æœ¯èƒŒæ™¯
- **Seataæ¡†æ¶**: ç²¾é€šSeataçš„ATã€TCCã€SAGAç­‰äº‹åŠ¡æ¨¡å¼
- **Canalå·¥å…·**: ç†Ÿç»ƒä½¿ç”¨Canalè¿›è¡Œæ•°æ®å˜æ›´ç›‘å¬å’ŒåŒæ­¥
- **æ¶ˆæ¯é˜Ÿåˆ—**: æŒæ¡Kafkaã€RocketMQç­‰æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨
- **ç¼“å­˜æŠ€æœ¯**: ç²¾é€šRedisç­‰ç¼“å­˜æŠ€æœ¯çš„ä¸€è‡´æ€§ä¿éšœ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ€§èƒ½è€ƒè™‘
- **äº‹åŠ¡ç²’åº¦**: æ§åˆ¶åˆ†å¸ƒå¼äº‹åŠ¡çš„ç²’åº¦ï¼Œé¿å…å¤§äº‹åŠ¡
- **é”ç«äº‰**: åˆç†ä½¿ç”¨é”æœºåˆ¶ï¼Œé¿å…æ­»é”å’Œæ€§èƒ½ç“¶é¢ˆ
- **å¼‚æ­¥å¤„ç†**: å¯¹äºéå…³é”®è·¯å¾„ï¼Œé‡‡ç”¨å¼‚æ­¥å¤„ç†æ–¹å¼
- **æ‰¹é‡æ“ä½œ**: ä¼˜åŒ–æ•°æ®åŒæ­¥çš„æ‰¹é‡æ“ä½œæ€§èƒ½

### ä¸€è‡´æ€§ç­–ç•¥
- **ä¸€è‡´æ€§ç­‰çº§**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§ç­‰çº§
- **è¡¥å¿æœºåˆ¶**: å»ºç«‹å®Œå–„çš„è¡¥å¿å’Œå›æ»šæœºåˆ¶
- **å¹‚ç­‰æ€§**: ç¡®ä¿æ‰€æœ‰æ“ä½œçš„å¹‚ç­‰æ€§
- **é‡è¯•ç­–ç•¥**: è®¾è®¡åˆç†çš„é‡è¯•å’Œè¶…æ—¶æœºåˆ¶

### ç›‘æ§å‘Šè­¦
- **å®æ—¶ç›‘æ§**: å»ºç«‹äº‹åŠ¡å’Œæ•°æ®åŒæ­¥çš„å®æ—¶ç›‘æ§
- **å‘Šè­¦é˜ˆå€¼**: è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼å’Œå‡çº§æœºåˆ¶
- **æ•…éšœæ¢å¤**: å»ºç«‹å¿«é€Ÿæ•…éšœæ£€æµ‹å’Œæ¢å¤æœºåˆ¶
- **æ€§èƒ½æŒ‡æ ‡**: ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸

---

## ğŸ”— ç›¸å…³æŠ€èƒ½

### ç›¸å…³æŠ€èƒ½
- **[æœåŠ¡æ²»ç†ä¸“å®¶](service-governance-expert.md)**: æœåŠ¡æ²»ç†å’Œç›‘æ§
- **[æ•°æ®åº“è®¾è®¡ç®¡ç†ä¸“å®¶](database-design-management-expert.md)**: æ•°æ®åº“è®¾è®¡å’Œä¼˜åŒ–
- **[ç¼“å­˜æ¶æ„ä¸“å®¶](cache-architecture-specialist.md)**: ç¼“å­˜æ¶æ„å’Œæ•°æ®ä¸€è‡´æ€§
- **[æ¶ˆæ¯é˜Ÿåˆ—ä¸“å®¶](message-queue-specialist.md)**: æ¶ˆæ¯é˜Ÿåˆ—å’Œå¼‚æ­¥å¤„ç†

### è¿›é˜¶è·¯å¾„
- **åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„å¸ˆ**: è´Ÿè´£æ•´ä½“åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡
- **æ•°æ®å¹³å°ä¸“å®¶**: è´Ÿè´£æ•°æ®å¹³å°å’Œæ•°æ®æ²»ç†ä½“ç³»å»ºè®¾
- **SREä¸“å®¶**: è´Ÿè´£ç³»ç»Ÿå¯é æ€§å’Œæ•°æ®ä¸€è‡´æ€§ä¿éšœ

### å‚è€ƒèµ„æ–™
- **[Seataå®˜æ–¹æ–‡æ¡£](https://seata.io/zh-cn/)**: åˆ†å¸ƒå¼äº‹åŠ¡å®Œæ•´æŒ‡å—
- **[Canalå®˜æ–¹æ–‡æ¡£](https://github.com/alibaba/canal)**: æ•°æ®åŒæ­¥å·¥å…·ä½¿ç”¨æŒ‡å—
- **[åˆ†å¸ƒå¼äº‹åŠ¡è®¾è®¡æ¨¡å¼](../docs/repowiki/zh/content/æŠ€æœ¯æ¶æ„/åˆ†å¸ƒå¼äº‹åŠ¡.md)**: é¡¹ç›®åˆ†å¸ƒå¼äº‹åŠ¡è§„èŒƒ
- **[æ•°æ®ä¸€è‡´æ€§ä¿éšœæŒ‡å—](../docs/repowiki/zh/content/æ•°æ®æ¶æ„/æ•°æ®ä¸€è‡´æ€§.md)**: æ•°æ®ä¸€è‡´æ€§å»ºè®¾æ ‡å‡†

---

**ğŸ’¡ æ ¸å¿ƒç†å¿µ**: æ•°æ®ä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜ï¼Œé€šè¿‡åˆç†é€‰æ‹©ä¸€è‡´æ€§ç­–ç•¥å’Œå·¥å…·ï¼Œåœ¨ä¿è¯ä¸šåŠ¡æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–ç³»ç»Ÿæ€§èƒ½å’Œå¯ç”¨æ€§ã€‚