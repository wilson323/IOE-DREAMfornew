# å¤šåè®®è®¾å¤‡é€‚é…ä¸“å®¶ (Multi-Protocol Device Adapter Expert)

**æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… é«˜çº§
**é€‚ç”¨è§’è‰²**: IOTè®¾å¤‡æ¶æ„å¸ˆã€åè®®å¼€å‘å·¥ç¨‹å¸ˆã€ç³»ç»Ÿé›†æˆä¸“å®¶
**å‰ç½®æŠ€èƒ½**: è®¾å¤‡åè®®ä¸“å®¶ã€Spring Bootä¼ä¸šçº§å¼€å‘ã€è®¾è®¡æ¨¡å¼ã€å¹¶å‘ç¼–ç¨‹
**é¢„è®¡å­¦æ—¶**: 35å°æ—¶

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

å¤šåè®®è®¾å¤‡é€‚é…ä¸“å®¶ä¸“æ³¨äºè®¾è®¡å’Œå®ç°å¯æ‰©å±•ã€é«˜æ€§èƒ½çš„åè®®é€‚é…å™¨æ¶æ„ï¼Œæ”¯æŒå¤šç§è®¾å¤‡å‚å•†å’Œé€šè®¯åè®®çš„ç»Ÿä¸€æ¥å…¥ã€‚åŸºäºIOE-DREAMä¼ä¸šçº§è®¾å¤‡ç®¡ç†ç³»ç»Ÿçš„åè®®é€‚é…å±‚æ¶æ„ï¼ŒæŒæ¡é€‚é…å™¨æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ç­‰è®¾è®¡æ¨¡å¼çš„å®é™…åº”ç”¨ã€‚

---

## ğŸ¯ æ ¸å¿ƒèƒ½åŠ›è¦æ±‚

### ğŸ—ï¸ æ¶æ„è®¾è®¡èƒ½åŠ›
- **é€‚é…å™¨æ¨¡å¼**: ç»Ÿä¸€æ¥å£è®¾è®¡ã€å…·ä½“é€‚é…å™¨å®ç°ã€é€‚é…å™¨å·¥å‚
- **ç­–ç•¥æ¨¡å¼**: åè®®é€‰æ‹©ç­–ç•¥ã€æ•°æ®å¤„ç†ç­–ç•¥ã€è¿æ¥ç®¡ç†ç­–ç•¥
- **å·¥å‚æ¨¡å¼**: åè®®é€‚é…å™¨å·¥å‚ã€è®¾å¤‡é©±åŠ¨å·¥å‚ã€å‘½ä»¤å·¥å‚
- **è§‚å¯Ÿè€…æ¨¡å¼**: è®¾å¤‡äº‹ä»¶ç›‘å¬ã€çŠ¶æ€å˜æ›´é€šçŸ¥ã€å¼‚å¸¸å¤„ç†

### ğŸ”Œ åè®®é€‚é…å®ç°
- **åè®®è¯†åˆ«**: è‡ªåŠ¨åè®®è¯†åˆ«ã€ç‰ˆæœ¬æ£€æµ‹ã€å…¼å®¹æ€§éªŒè¯
- **æ•°æ®è½¬æ¢**: åè®®æ•°æ®æ ‡å‡†åŒ–ã€æ ¼å¼è½¬æ¢ã€ç¼–ç è§£ç 
- **å‘½ä»¤æ„å»º**: ç»Ÿä¸€å‘½ä»¤æ¥å£ã€åè®®ç‰¹å®šå‘½ä»¤å®ç°
- **è¿æ¥ç®¡ç†**: åè®®è¿æ¥é€‚é…ã€è¿æ¥æ± ç®¡ç†ã€æ–­çº¿é‡è¿

### ğŸš€ æ€§èƒ½ä¼˜åŒ–èƒ½åŠ›
- **è¿æ¥å¤ç”¨**: åè®®è¿æ¥å¤ç”¨ã€é•¿è¿æ¥ç®¡ç†ã€è¿æ¥æ± ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡IOã€å¼‚æ­¥å›è°ƒã€äº‹ä»¶é©±åŠ¨å¤„ç†
- **ç¼“å­˜æœºåˆ¶**: åè®®æ¨¡æ¿ç¼“å­˜ã€æ•°æ®ç¼“å­˜ã€é…ç½®ç¼“å­˜
- **æ‰¹å¤„ç†**: æ‰¹é‡å‘½ä»¤æ‰§è¡Œã€æ‰¹é‡æ•°æ®å¤„ç†ã€æ‰¹é‡çŠ¶æ€åŒæ­¥

---

## ğŸ› ï¸ æ“ä½œæ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šé€‚é…å™¨æ¶æ„è®¾è®¡ (10å°æ—¶)

#### 1.1 åè®®é€‚é…å™¨æ ¸å¿ƒæ¶æ„
**ç›®æ ‡**: è®¾è®¡å¯æ‰©å±•çš„åè®®é€‚é…å™¨æ ¸å¿ƒæ¶æ„

**æ“ä½œæ­¥éª¤**:
```java
// 1. åè®®é€‚é…å™¨æ ¸å¿ƒæ¥å£å®šä¹‰
public interface DeviceProtocolAdapter {

    /**
     * åè®®é€‚é…å™¨ä¿¡æ¯
     */
    interface AdapterInfo {
        String getAdapterName();
        String getSupportedProtocol();
        List<String> getSupportedManufacturers();
        String getVersion();
        List<String> getSupportedDeviceTypes();
    }

    /**
     * è·å–é€‚é…å™¨ä¿¡æ¯
     */
    AdapterInfo getAdapterInfo();

    /**
     * åè®®åˆå§‹åŒ–
     */
    void initialize(AdapterConfig config) throws AdapterInitializationException;

    /**
     * è®¾å¤‡è¿æ¥é€‚é…
     */
    CompletableFuture<AdapterConnectionResult> adaptConnection(
        DeviceConnectionRequest request);

    /**
     * æ•°æ®å¤„ç†é€‚é…
     */
    CompletableFuture<AdapterProcessResult> adaptData(
        byte[] rawData, DeviceContext context);

    /**
     * å‘½ä»¤æ„å»ºé€‚é…
     */
    CompletableFuture<AdapterCommandResult> adaptCommand(
        DeviceCommand command, DeviceContext context);

    /**
     * è¿æ¥çŠ¶æ€ç®¡ç†
     */
    void manageConnectionState(String deviceId, ConnectionState state);

    /**
     * èµ„æºæ¸…ç†
     */
    void cleanup();
}
```

#### 1.2 æŠ½è±¡é€‚é…å™¨åŸºç±»
**ç›®æ ‡**: æä¾›é€šç”¨çš„é€‚é…å™¨å®ç°åŸºç¡€

**æ“ä½œæ­¥éª¤**:
```java
// 2. æŠ½è±¡åè®®é€‚é…å™¨åŸºç±»
public abstract class AbstractDeviceProtocolAdapter implements DeviceProtocolAdapter {

    protected AdapterConfig config;
    protected DeviceStateManager stateManager;
    protected ProtocolLogger protocolLogger;
    protected MetricsCollector metricsCollector;
    protected ConnectionPoolManager connectionPool;

    @Override
    public void initialize(AdapterConfig config) throws AdapterInitializationException {
        this.config = config;

        // åˆå§‹åŒ–ç»„ä»¶
        initializeComponents();

        // éªŒè¯é…ç½®
        validateConfiguration();

        // å¯åŠ¨ç›‘æ§
        startMonitoring();

        onAdapterInitialized();
    }

    /**
     * æ¨¡æ¿æ–¹æ³•ï¼šåˆå§‹åŒ–ç»„ä»¶
     */
    protected void initializeComponents() {
        this.stateManager = createStateManager();
        this.protocolLogger = createProtocolLogger();
        this.metricsCollector = createMetricsCollector();
        this.connectionPool = createConnectionPool();
    }

    /**
     * æ¨¡æ¿æ–¹æ³•ï¼šæ•°æ®å¤„ç†é€šç”¨æµç¨‹
     */
    @Override
    public CompletableFuture<AdapterProcessResult> adaptData(
            byte[] rawData, DeviceContext context) {

        return CompletableFuture.supplyAsync(() -> {
            long startTime = System.currentTimeMillis();

            try {
                // 1. æ•°æ®é¢„å¤„ç†
                byte[] preprocessedData = preprocessData(rawData, context);

                // 2. åè®®è§£æ
                ProtocolMessage message = parseProtocolData(preprocessedData, context);

                // 3. æ•°æ®éªŒè¯
                validateMessage(message, context);

                // 4. æ•°æ®è½¬æ¢
                DeviceData deviceData = transformMessage(message, context);

                // 5. åå¤„ç†
                DeviceData finalData = postprocessData(deviceData, context);

                // 6. è®°å½•æŒ‡æ ‡
                long duration = System.currentTimeMillis() - startTime;
                metricsCollector.recordDataProcessing(getAdapterInfo().getAdapterName(), duration, true);

                return AdapterProcessResult.success(finalData);

            } catch (Exception e) {
                long duration = System.currentTimeMillis() - startTime;
                metricsCollector.recordDataProcessing(getAdapterInfo().getAdapterName(), duration, false);
                protocolLogger.logError("æ•°æ®å¤„ç†å¤±è´¥", context, e);
                return AdapterProcessResult.failure(e.getMessage());
            }
        });
    }

    /**
     * æŠ½è±¡æ–¹æ³•ï¼šå…·ä½“çš„åè®®è§£æå®ç°
     */
    protected abstract ProtocolMessage parseProtocolData(byte[] data, DeviceContext context);

    /**
     * æŠ½è±¡æ–¹æ³•ï¼šæ•°æ®è½¬æ¢å®ç°
     */
    protected abstract DeviceData transformMessage(ProtocolMessage message, DeviceContext context);

    // å…¶ä»–æ¨¡æ¿æ–¹æ³•å’Œé’©å­æ–¹æ³•...
}
```

**è´¨é‡è¦æ±‚**:
- âœ… é€‚é…å™¨æ‰©å±•æ€§ï¼šæ”¯æŒæ–°åè®®çš„çƒ­æ’æ‹”æ¥å…¥
- âœ… æ€§èƒ½æ ‡å‡†ï¼šå•é€‚é…å™¨å¤„ç†èƒ½åŠ› â‰¥ 1000TPS
- âœ… å¯é æ€§ï¼šé€‚é…å™¨æ•…éšœéš”ç¦»ï¼Œä¸å½±å“å…¶ä»–é€‚é…å™¨
- âœ… ç›‘æ§å®Œå¤‡ï¼š100%é€‚é…å™¨æ“ä½œéƒ½æœ‰ç›‘æ§æŒ‡æ ‡

### ç¬¬äºŒé˜¶æ®µï¼šå…·ä½“é€‚é…å™¨å®ç° (12å°æ—¶)

#### 2.1 ç†µåŸºç§‘æŠ€åè®®é€‚é…å™¨å®ç°
**ç›®æ ‡**: å®ç°å®Œæ•´çš„ç†µåŸºç§‘æŠ€è®¾å¤‡åè®®é€‚é…å™¨

**æ“ä½œæ­¥éª¤**:
```java
// 3. ç†µåŸºç§‘æŠ€Pushåè®®é€‚é…å™¨å®ç°
@Component
@Slf4j
public class ZktecoPushProtocolAdapter extends AbstractDeviceProtocolAdapter {

    @Resource
    private ZktecoMessageValidator messageValidator;

    @Resource
    private ZktecoDataTransformer dataTransformer;

    @Resource
    private ZktecoCommandBuilder commandBuilder;

    private ZktecoProtocolConfig zktecoConfig;

    @Override
    public AdapterInfo getAdapterInfo() {
        return AdapterInfo.builder()
            .adapterName("ZktecoPushAdapter")
            .supportedProtocol("HTTP_PUSH")
            .supportedManufacturers(Arrays.asList("ZKTeco", "ç†µåŸºç§‘æŠ€"))
            .version("4.6")
            .supportedDeviceTypes(Arrays.asList("è€ƒå‹¤æœº", "é—¨ç¦æœº", "æŒ‡çº¹æœº"))
            .build();
    }

    @Override
    public CompletableFuture<AdapterConnectionResult> adaptConnection(
            DeviceConnectionRequest request) {

        return CompletableFuture.supplyAsync(() -> {
            try {
                // 1. éªŒè¯è®¾å¤‡èº«ä»½
                ZktecoDeviceInfo deviceInfo = validateDevice(request);

                // 2. å»ºç«‹è¿æ¥
                ZktecoConnection connection = establishConnection(deviceInfo);

                // 3. é…ç½®è¿æ¥å‚æ•°
                configureConnection(connection, deviceInfo);

                // 4. æ³¨å†Œè¿æ¥ç®¡ç†
                connectionPool.addConnection(deviceInfo.getSerialNumber(), connection);

                // 5. å¯åŠ¨å¿ƒè·³ç›‘æ§
                startHeartbeatMonitoring(deviceInfo.getSerialNumber(), connection);

                return AdapterConnectionResult.success(deviceInfo.getSerialNumber(), connection);

            } catch (Exception e) {
                log.error("ç†µåŸºç§‘æŠ€è®¾å¤‡è¿æ¥é€‚é…å¤±è´¥", e);
                return AdapterConnectionResult.failure(e.getMessage());
            }
        });
    }

    /**
     * å¤„ç†ç†µåŸºç§‘æŠ€Pushæ•°æ®
     */
    @Override
    public CompletableFuture<AdapterProcessResult> adaptData(
            byte[] rawData, DeviceContext context) {

        return super.adaptData(rawData, context)
            .thenApply(result -> {
                if (result.isSuccess()) {
                    DeviceData deviceData = result.getDeviceData();

                    // ç†µåŸºç§‘æŠ€ç‰¹å®šæ•°æ®å¤„ç†
                    ZktecoProcessResult zktecoResult = processZktecoData(deviceData, context);

                    return AdapterProcessResult.success(zktecoResult.getProcessedData());
                }
                return result;
            })
            .exceptionally(throwable -> {
                log.error("ç†µåŸºç§‘æŠ€æ•°æ®å¤„ç†å¼‚å¸¸", throwable);
                return AdapterProcessResult.failure("æ•°æ®å¤„ç†å¼‚å¸¸: " + throwable.getMessage());
            });
    }

    /**
     * å¤„ç†ç‰¹å®šè¡¨å•æ•°æ®
     */
    private ZktecoProcessResult processZktecoData(DeviceData deviceData, DeviceContext context) {
        String tableName = deviceData.getTableName();

        switch (tableName) {
            case "ATTLOG":
                return processAttendanceLog(deviceData, context);
            case "OPERLOG":
                return processOperationLog(deviceData, context);
            case "USER":
                return processUserInfo(deviceData, context);
            case "FP":
                return processFingerprintData(deviceData, context);
            default:
                return ZktecoProcessResult.success(deviceData);
        }
    }

    /**
     * å¤„ç†è€ƒå‹¤è®°å½•
     */
    private ZktecoProcessResult processAttendanceLog(DeviceData deviceData, DeviceContext context) {
        List<Map<String, Object>> attendanceRecords = deviceData.getRecords();

        for (Map<String, Object> record : attendanceRecords) {
            // è½¬æ¢ä¸ºæ ‡å‡†è€ƒå‹¤è®°å½•
            AttendanceRecord attendanceRecord = dataTransformer.convertToAttendanceRecord(record);

            // æ•°æ®éªŒè¯
            if (!messageValidator.validateAttendanceRecord(attendanceRecord)) {
                continue;
            }

            // å‘å¸ƒè€ƒå‹¤äº‹ä»¶
            publishAttendanceEvent(attendanceRecord, context);
        }

        return ZktecoProcessResult.success(attendanceRecords.size() + "æ¡è€ƒå‹¤è®°å½•å¤„ç†å®Œæˆ");
    }
}
```

#### 2.2 ONVIFè§†é¢‘åè®®é€‚é…å™¨å®ç°
**ç›®æ ‡**: å®ç°è§†é¢‘è®¾å¤‡çš„ONVIFæ ‡å‡†åè®®é€‚é…

**æ“ä½œæ­¥éª¤**:
```java
// 4. ONVIFè§†é¢‘åè®®é€‚é…å™¨å®ç°
@Component
@Slf4j
public class OnvifVideoProtocolAdapter extends AbstractDeviceProtocolAdapter {

    @Resource
    private OnvifDeviceClient onvifClient;

    @Resource
    private VideoStreamManager streamManager;

    @Resource
    private PTZController ptzController;

    @Override
    public AdapterInfo getAdapterInfo() {
        return AdapterInfo.builder()
            .adapterName("OnvifVideoAdapter")
            .supportedProtocol("ONVIF")
            .supportedManufacturers(Arrays.asList("Hikvision", "Dahua", "Axis", "Sony"))
            .version("2.0")
            .supportedDeviceTypes(Arrays.asList("ç½‘ç»œæ‘„åƒå¤´", "æ™ºèƒ½çƒæœº", "è§†é¢‘æœåŠ¡å™¨"))
            .build();
    }

    /**
     * å¤„ç†è§†é¢‘æµè¿æ¥
     */
    @Override
    public CompletableFuture<AdapterConnectionResult> adaptConnection(
            DeviceConnectionRequest request) {

        return CompletableFuture.supplyAsync(() -> {
            try {
                // 1. è®¾å¤‡å‘ç°
                OnvifDevice device = onvifClient.discoverDevice(request.getDeviceIp(), request.getPort());

                // 2. è®¾å¤‡è®¤è¯
                device.authenticate(request.getUsername(), request.getPassword());

                // 3. è·å–åª’ä½“æœåŠ¡
                MediaService mediaService = device.getMediaService();

                // 4. é…ç½®è§†é¢‘æµ
                VideoStreamConfig streamConfig = configureVideoStream(mediaService, request);

                // 5. å»ºç«‹RTSPè¿æ¥
                RTSPConnection rtspConnection = establishRTSPConnection(streamConfig);

                // 6. å¯åŠ¨è§†é¢‘æµ
                streamManager.startStream(device.getDeviceId(), rtspConnection);

                return AdapterConnectionResult.success(device.getDeviceId(), rtspConnection);

            } catch (Exception e) {
                log.error("ONVIFè§†é¢‘è®¾å¤‡è¿æ¥é€‚é…å¤±è´¥", e);
                return AdapterConnectionResult.failure(e.getMessage());
            }
        });
    }

    /**
     * å¤„ç†PTZæ§åˆ¶å‘½ä»¤
     */
    @Override
    public CompletableFuture<AdapterCommandResult> adaptCommand(
            DeviceCommand command, DeviceContext context) {

        if (command.getCommandType() == CommandType.PTZ_CONTROL) {
            return handlePTZCommand(command, context);
        }

        return handleGenericCommand(command, context);
    }

    /**
     * å¤„ç†PTZæ§åˆ¶
     */
    private CompletableFuture<AdapterCommandResult> handlePTZCommand(
            DeviceCommand command, DeviceContext context) {

        return CompletableFuture.supplyAsync(() -> {
            try {
                PTZCommand ptzCommand = PTZCommand.fromDeviceCommand(command);

                // è·å–è®¾å¤‡PTZæ§åˆ¶å™¨
                PTZController controller = ptzController.getController(context.getDeviceId());

                // æ‰§è¡ŒPTZæ“ä½œ
                boolean success = controller.executePTZCommand(ptzCommand);

                if (success) {
                    return AdapterCommandResult.success("PTZæ§åˆ¶å‘½ä»¤æ‰§è¡ŒæˆåŠŸ");
                } else {
                    return AdapterCommandResult.failure("PTZæ§åˆ¶å‘½ä»¤æ‰§è¡Œå¤±è´¥");
                }

            } catch (Exception e) {
                log.error("PTZæ§åˆ¶å‘½ä»¤å¤„ç†å¤±è´¥", e);
                return AdapterCommandResult.failure(e.getMessage());
            }
        });
    }
}
```

**è´¨é‡è¦æ±‚**:
- âœ… åè®®è¦†ç›–ç‡ï¼šæ”¯æŒä¸»æµå‚å•†90%ä»¥ä¸Šè®¾å¤‡
- âœ… å…¼å®¹æ€§ï¼šå‘ä¸‹å…¼å®¹åè®®ç‰ˆæœ¬
- âœ… æ‰©å±•æ€§ï¼šæ”¯æŒæ–°è®¾å¤‡ç±»å‹çš„å¿«é€Ÿæ¥å…¥
- âœ… ç¨³å®šæ€§ï¼šé€‚é…å™¨å¼‚å¸¸æ¢å¤æ—¶é—´ < 30ç§’

### ç¬¬ä¸‰é˜¶æ®µï¼šå·¥å‚æ¨¡å¼å®ç° (8å°æ—¶)

#### 3.1 åè®®é€‚é…å™¨å·¥å‚
**ç›®æ ‡**: å®ç°å¯æ‰©å±•çš„åè®®é€‚é…å™¨å·¥å‚

**æ“ä½œæ­¥éª¤**:
```java
// 5. åè®®é€‚é…å™¨å·¥å‚å®ç°
@Component
@Slf4j
public class ProtocolAdapterFactory {

    private final Map<String, DeviceProtocolAdapter> adapterRegistry = new ConcurrentHashMap<>();
    private final Map<String, AdapterConfig> configRegistry = new ConcurrentHashMap<>();

    @Resource
    private ApplicationContext applicationContext;

    @PostConstruct
    public void initialize() {
        // è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œé€‚é…å™¨
        scanAndRegisterAdapters();

        // åŠ è½½é€‚é…å™¨é…ç½®
        loadAdapterConfigurations();

        // åˆå§‹åŒ–é€‚é…å™¨
        initializeAdapters();
    }

    /**
     * è·å–åè®®é€‚é…å™¨
     */
    public DeviceProtocolAdapter getAdapter(String manufacturer, String deviceType) {
        String adapterKey = buildAdapterKey(manufacturer, deviceType);

        DeviceProtocolAdapter adapter = adapterRegistry.get(adapterKey);
        if (adapter == null) {
            // å°è¯•è·å–é€šç”¨é€‚é…å™¨
            adapter = getGenericAdapter(manufacturer);
        }

        if (adapter == null) {
            throw new UnsupportedProtocolException(
                String.format("ä¸æ”¯æŒçš„åè®®é€‚é…å™¨: %s - %s", manufacturer, deviceType));
        }

        return adapter;
    }

    /**
     * è·å–æ‰€æœ‰æ”¯æŒçš„å‚å•†
     */
    public Set<String> getSupportedManufacturers() {
        return adapterRegistry.keySet().stream()
            .map(key -> key.split(":")[0])
            .collect(Collectors.toSet());
    }

    /**
     * è·å–å‚å•†æ”¯æŒçš„è®¾å¤‡ç±»å‹
     */
    public Set<String> getSupportedDeviceTypes(String manufacturer) {
        return adapterRegistry.keySet().stream()
            .filter(key -> key.startsWith(manufacturer + ":"))
            .map(key -> key.split(":")[1])
            .collect(Collectors.toSet());
    }

    /**
     * åŠ¨æ€æ³¨å†Œé€‚é…å™¨
     */
    public void registerAdapter(String manufacturer, String deviceType,
                                DeviceProtocolAdapter adapter, AdapterConfig config) {

        String adapterKey = buildAdapterKey(manufacturer, deviceType);

        try {
            // åˆå§‹åŒ–é€‚é…å™¨
            adapter.initialize(config);

            // æ³¨å†Œé€‚é…å™¨
            adapterRegistry.put(adapterKey, adapter);
            configRegistry.put(adapterKey, config);

            log.info("æˆåŠŸæ³¨å†Œåè®®é€‚é…å™¨: {} -> {}", adapterKey, adapter.getClass().getSimpleName());

        } catch (Exception e) {
            log.error("æ³¨å†Œåè®®é€‚é…å™¨å¤±è´¥: {}", adapterKey, e);
            throw new AdapterRegistrationException("é€‚é…å™¨æ³¨å†Œå¤±è´¥", e);
        }
    }

    /**
     * æ‰«æå¹¶æ³¨å†Œé€‚é…å™¨
     */
    private void scanAndRegisterAdapters() {
        Map<String, DeviceProtocolAdapter> adapters =
            applicationContext.getBeansOfType(DeviceProtocolAdapter.class);

        for (Map.Entry<String, DeviceProtocolAdapter> entry : adapters.entrySet()) {
            DeviceProtocolAdapter adapter = entry.getValue();
            AdapterInfo info = adapter.getAdapterInfo();

            for (String manufacturer : info.getSupportedManufacturers()) {
                for (String deviceType : info.getSupportedDeviceTypes()) {
                    String adapterKey = buildAdapterKey(manufacturer, deviceType);
                    adapterRegistry.put(adapterKey, adapter);
                }
            }
        }

        log.info("æ‰«æå¹¶æ³¨å†Œäº† {} ä¸ªåè®®é€‚é…å™¨", adapterRegistry.size());
    }

    /**
     * æ„å»ºé€‚é…å™¨é”®
     */
    private String buildAdapterKey(String manufacturer, String deviceType) {
        return manufacturer.toUpperCase() + ":" + deviceType.toUpperCase();
    }
}
```

#### 3.2 å‘½ä»¤å·¥å‚å®ç°
**ç›®æ ‡**: å®ç°è®¾å¤‡å‘½ä»¤çš„ç»Ÿä¸€æ„å»ºå·¥å‚

**æ“ä½œæ­¥éª¤**:
```java
// 6. è®¾å¤‡å‘½ä»¤å·¥å‚å®ç°
@Component
public class DeviceCommandFactory {

    private final Map<CommandType, CommandBuilder> commandBuilders = new ConcurrentHashMap<>();

    @PostConstruct
    public void initialize() {
        // æ³¨å†Œå‘½ä»¤æ„å»ºå™¨
        registerCommandBuilders();
    }

    /**
     * æ„å»ºè®¾å¤‡å‘½ä»¤
     */
    public DeviceCommand buildCommand(CommandRequest request) {
        CommandType commandType = request.getCommandType();

        CommandBuilder builder = commandBuilders.get(commandType);
        if (builder == null) {
            throw new UnsupportedCommandException("ä¸æ”¯æŒçš„å‘½ä»¤ç±»å‹: " + commandType);
        }

        return builder.build(request);
    }

    /**
     * æ‰¹é‡æ„å»ºè®¾å¤‡å‘½ä»¤
     */
    public List<DeviceCommand> buildCommands(List<CommandRequest> requests) {
        return requests.parallelStream()
            .map(this::buildCommand)
            .collect(Collectors.toList());
    }

    /**
     * æ³¨å†Œå‘½ä»¤æ„å»ºå™¨
     */
    private void registerCommandBuilders() {
        // å¼€é—¨å‘½ä»¤æ„å»ºå™¨
        commandBuilders.put(CommandType.OPEN_DOOR, new OpenDoorCommandBuilder());

        // PTZæ§åˆ¶å‘½ä»¤æ„å»ºå™¨
        commandBuilders.put(CommandType.PTZ_CONTROL, new PTZCommandBuilder());

        // è®¾å¤‡é…ç½®å‘½ä»¤æ„å»ºå™¨
        commandBuilders.put(CommandType.DEVICE_CONFIG, new DeviceConfigCommandBuilder());

        // æ•°æ®æŸ¥è¯¢å‘½ä»¤æ„å»ºå™¨
        commandBuilders.put(CommandType.DATA_QUERY, new DataQueryCommandBuilder());

        // é‡å¯å‘½ä»¤æ„å»ºå™¨
        commandBuilders.put(CommandType.REBOOT, new RebootCommandBuilder());

        log.info("æ³¨å†Œäº† {} ä¸ªå‘½ä»¤æ„å»ºå™¨", commandBuilders.size());
    }

    /**
     * è‡ªå®šä¹‰å‘½ä»¤æ„å»ºå™¨æ³¨å†Œ
     */
    public void registerCommandBuilder(CommandType commandType, CommandBuilder builder) {
        commandBuilders.put(commandType, builder);
        log.info("æ³¨å†Œè‡ªå®šä¹‰å‘½ä»¤æ„å»ºå™¨: {}", commandType);
    }
}
```

**è´¨é‡è¦æ±‚**:
- âœ… å·¥å‚æ¨¡å¼å®ç°ï¼š100%ç¬¦åˆè®¾è®¡æ¨¡å¼æ ‡å‡†
- âœ… æ‰©å±•æ€§ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œæ–°é€‚é…å™¨
- âœ… æ€§èƒ½ï¼šé€‚é…å™¨æŸ¥æ‰¾æ—¶é—´ < 1ms
- âœ… çº¿ç¨‹å®‰å…¨ï¼šæ”¯æŒé«˜å¹¶å‘è®¿é—®

### ç¬¬å››é˜¶æ®µï¼šé›†æˆæµ‹è¯•ä¸ä¼˜åŒ– (5å°æ—¶)

#### 4.1 é€‚é…å™¨é›†æˆæµ‹è¯•
**ç›®æ ‡**: å»ºç«‹å®Œå–„çš„é€‚é…å™¨æµ‹è¯•ä½“ç³»

**æ“ä½œæ­¥éª¤**:
```java
// 7. åè®®é€‚é…å™¨é›†æˆæµ‹è¯•
@SpringBootTest
@TestMethodOrder(Ordered.class)
public class ProtocolAdapterIntegrationTest {

    @Resource
    private ProtocolAdapterFactory adapterFactory;

    @Resource
    private DeviceCommandFactory commandFactory;

    @Test
    @Order(1)
    public void testZktecoAdapterRegistration() {
        // æµ‹è¯•ç†µåŸºç§‘æŠ€é€‚é…å™¨æ³¨å†Œ
        DeviceProtocolAdapter adapter = adapterFactory.getAdapter("ZKTeco", "è€ƒå‹¤æœº");

        assertNotNull(adapter);
        assertEquals("ZktecoPushAdapter", adapter.getAdapterInfo().getAdapterName());
        assertTrue(adapter.getAdapterInfo().getSupportedManufacturers().contains("ZKTeco"));
    }

    @Test
    @Order(2)
    public void testOnvifAdapterRegistration() {
        // æµ‹è¯•ONVIFè§†é¢‘é€‚é…å™¨æ³¨å†Œ
        DeviceProtocolAdapter adapter = adapterFactory.getAdapter("Hikvision", "ç½‘ç»œæ‘„åƒå¤´");

        assertNotNull(adapter);
        assertEquals("OnvifVideoAdapter", adapter.getAdapterInfo().getAdapterName());
        assertTrue(adapter.getAdapterInfo().getSupportedProtocol().equals("ONVIF"));
    }

    @Test
    @Order(3)
    public void testCommandBuilding() {
        // æµ‹è¯•å‘½ä»¤æ„å»º
        CommandRequest request = CommandRequest.builder()
            .commandType(CommandType.OPEN_DOOR)
            .deviceId("DOOR_001")
            .parameters(Map.of("doorId", "MAIN"))
            .build();

        DeviceCommand command = commandFactory.buildCommand(request);

        assertNotNull(command);
        assertEquals(CommandType.OPEN_DOOR, command.getCommandType());
        assertEquals("DOOR_001", command.getDeviceId());
    }

    @Test
    @Order(4)
    public void testDataAdapterProcessing() {
        // æµ‹è¯•æ•°æ®é€‚é…å¤„ç†
        DeviceProtocolAdapter adapter = adapterFactory.getAdapter("ZKTeco", "è€ƒå‹¤æœº");

        byte[] testData = createZktecoTestData();
        DeviceContext context = createDeviceContext();

        CompletableFuture<AdapterProcessResult> result = adapter.adaptData(testData, context);

        assertNotNull(result);
        result.thenAccept(processResult -> {
            assertTrue(processResult.isSuccess());
            assertNotNull(processResult.getDeviceData());
        });
    }
}
```

#### 4.2 æ€§èƒ½åŸºå‡†æµ‹è¯•
**ç›®æ ‡**: éªŒè¯é€‚é…å™¨æ€§èƒ½æŒ‡æ ‡

**æ“ä½œæ­¥éª¤**:
```java
// 8. åè®®é€‚é…å™¨æ€§èƒ½æµ‹è¯•
@Component
public class ProtocolAdapterPerformanceTest {

    @Resource
    private ProtocolAdapterFactory adapterFactory;

    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œ
    public void performanceBenchmark() {
        log.info("å¼€å§‹åè®®é€‚é…å™¨æ€§èƒ½åŸºå‡†æµ‹è¯•");

        // æµ‹è¯•é€‚é…å™¨æŸ¥æ‰¾æ€§èƒ½
        benchmarkAdapterLookup();

        // æµ‹è¯•æ•°æ®å¤„ç†æ€§èƒ½
        benchmarkDataProcessing();

        // æµ‹è¯•å‘½ä»¤æ„å»ºæ€§èƒ½
        benchmarkCommandBuilding();

        // æµ‹è¯•å¹¶å‘å¤„ç†æ€§èƒ½
        benchmarkConcurrentProcessing();
    }

    /**
     * é€‚é…å™¨æŸ¥æ‰¾æ€§èƒ½æµ‹è¯•
     */
    private void benchmarkAdapterLookup() {
        long startTime = System.currentTimeMillis();

        for (int i = 0; i < 10000; i++) {
            DeviceProtocolAdapter adapter = adapterFactory.getAdapter("ZKTeco", "è€ƒå‹¤æœº");
            assertNotNull(adapter);
        }

        long duration = System.currentTimeMillis() - startTime;
        double avgTime = (double) duration / 10000;

        log.info("é€‚é…å™¨æŸ¥æ‰¾æ€§èƒ½: 10000æ¬¡æŸ¥æ‰¾è€—æ—¶ {}ms, å¹³å‡æ¯æ¬¡ {:.3f}ms", duration, avgTime);

        // æ€§èƒ½è¦æ±‚ï¼šå¹³å‡æŸ¥æ‰¾æ—¶é—´ < 1ms
        assertTrue(avgTime < 1.0, "é€‚é…å™¨æŸ¥æ‰¾æ€§èƒ½ä¸è¾¾æ ‡");
    }

    /**
     * æ•°æ®å¤„ç†æ€§èƒ½æµ‹è¯•
     */
    private void benchmarkDataProcessing() {
        DeviceProtocolAdapter adapter = adapterFactory.getAdapter("ZKTeco", "è€ƒå‹¤æœº");
        byte[] testData = createZktecoTestData();
        DeviceContext context = createDeviceContext();

        long startTime = System.currentTimeMillis();

        List<CompletableFuture<AdapterProcessResult>> futures = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            CompletableFuture<AdapterProcessResult> future = adapter.adaptData(testData, context);
            futures.add(future);
        }

        // ç­‰å¾…æ‰€æœ‰å¤„ç†å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();

        long duration = System.currentTimeMillis() - startTime;
        double tps = 1000.0 * 1000 / duration;

        log.info("æ•°æ®å¤„ç†æ€§èƒ½: 1000æ¡æ•°æ®å¤„ç†è€—æ—¶ {}ms, TPS: {:.2f}", duration, tps);

        // æ€§èƒ½è¦æ±‚ï¼šTPS â‰¥ 1000
        assertTrue(tps >= 1000.0, "æ•°æ®å¤„ç†æ€§èƒ½ä¸è¾¾æ ‡");
    }
}
```

**è´¨é‡è¦æ±‚**:
- âœ… æµ‹è¯•è¦†ç›–ç‡ï¼šâ‰¥ 90%
- âœ… æ€§èƒ½è¾¾æ ‡ï¼šæ‰€æœ‰åŸºå‡†æµ‹è¯•é€šè¿‡
- âœ… é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯
- âœ… å‹åŠ›æµ‹è¯•ï¼šæ”¯æŒ1000+å¹¶å‘é€‚é…å™¨

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ğŸ”§ å¼€å‘è§„èŒƒ
- **è®¾è®¡æ¨¡å¼**: ä¸¥æ ¼éµå¾ªSOLIDåŸåˆ™å’Œè®¾è®¡æ¨¡å¼æœ€ä½³å®è·µ
- **æ¥å£è®¾è®¡**: ä¿æŒæ¥å£ç®€æ´ã€èŒè´£å•ä¸€ã€æ˜“äºæ‰©å±•
- **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œé¿å…é€‚é…å™¨çº§è”æ•…éšœ
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ“ä½œæ—¥å¿—ï¼Œæ”¯æŒé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½åˆ†æ

### ğŸš€ æ€§èƒ½è¦æ±‚
- **å†…å­˜ä½¿ç”¨**: å•é€‚é…å™¨å†…å­˜å ç”¨ < 50MB
- **CPUä½¿ç”¨**: å•é€‚é…å™¨CPUå ç”¨ < 5%
- **å“åº”æ—¶é—´**: é€‚é…å™¨æ“ä½œå“åº”æ—¶é—´ < 10ms
- **å¹¶å‘æ”¯æŒ**: å•é€‚é…å™¨æ”¯æŒ1000+å¹¶å‘è¿æ¥

### ğŸ›¡ï¸ å®‰å…¨è¦æ±‚
- **è¾“å…¥éªŒè¯**: ä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ®çš„åˆæ³•æ€§
- **æƒé™æ§åˆ¶**: é€‚é…å™¨æ“ä½œéœ€è¦ç›¸åº”çš„æƒé™éªŒè¯
- **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®ä¼ è¾“éœ€è¦åŠ å¯†ä¿æŠ¤
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰é€‚é…å™¨æ“ä½œçš„å®¡è®¡æ—¥å¿—

---

## ğŸ“Š è¯„ä¼°æ ‡å‡†

### æ“ä½œæ—¶é—´è¦æ±‚
- **æ–°é€‚é…å™¨å¼€å‘**: 2-3å¤©ï¼ˆåŒ…å«æµ‹è¯•ï¼‰
- **é€‚é…å™¨å·¥å‚æ‰©å±•**: 0.5å¤©
- **æ€§èƒ½ä¼˜åŒ–**: 1å¤©/é€‚é…å™¨
- **é—®é¢˜æ’æŸ¥**: 15åˆ†é’Ÿå†…å®šä½é—®é¢˜

### æŠ€æœ¯æŒ‡æ ‡è¦æ±‚
- **é€‚é…å™¨æ‰©å±•æ€§**: æ”¯æŒçƒ­æ’æ‹”ã€é›¶åœæœºæ–°å¢
- **åè®®å…¼å®¹æ€§**: æ”¯æŒä¸»æµè®¾å¤‡å‚å•†åè®®
- **ç³»ç»Ÿç¨³å®šæ€§**: å•é€‚é…å™¨æ•…éšœä¸å½±å“ç³»ç»Ÿæ•´ä½“
- **å¤„ç†èƒ½åŠ›**: å•é€‚é…å™¨TPS â‰¥ 1000

### è´¨é‡æ ‡å‡†
- **ä»£ç è´¨é‡**: ç¬¦åˆä¼ä¸šçº§ç¼–ç è§„èŒƒ
- **æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%
- **æ–‡æ¡£å®Œæ•´**: é€‚é…å™¨ä½¿ç”¨æ–‡æ¡£ 100% å®Œæ•´
- **ç›‘æ§å®Œå¤‡**: é€‚é…å™¨è¿è¡ŒçŠ¶æ€ 100% å¯ç›‘æ§

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### å…¸å‹åº”ç”¨åœºæ™¯
1. **æ–°è®¾å¤‡å‚å•†æ¥å…¥**: å¿«é€Ÿå¼€å‘æ–°å‚å•†è®¾å¤‡çš„åè®®é€‚é…å™¨
2. **å¤šåè®®ç»Ÿä¸€ç®¡ç†**: å»ºç«‹ç»Ÿä¸€çš„å¤šåè®®è®¾å¤‡ç®¡ç†ä½“ç³»
3. **è®¾å¤‡ç³»ç»Ÿé›†æˆ**: å°†ä¸åŒåè®®çš„è®¾å¤‡é›†æˆåˆ°ç»Ÿä¸€å¹³å°
4. **ç³»ç»Ÿæ‰©å±•**: æ”¯æŒæ–°è®¾å¤‡ç±»å‹çš„å¿«é€Ÿæ¥å…¥å’Œç®¡ç†

### æœ€ä½³å®è·µç¤ºä¾‹
```java
// æœ€ä½³å®è·µï¼šé€‚é…å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
@Component
public class AdapterLifecycleManager {

    @Resource
    private ProtocolAdapterFactory adapterFactory;

    @PreDestroy
    public void cleanup() {
        // æ¸…ç†æ‰€æœ‰é€‚é…å™¨èµ„æº
        adapterFactory.getAllAdapters().forEach((key, adapter) -> {
            try {
                adapter.cleanup();
                log.info("é€‚é…å™¨æ¸…ç†å®Œæˆ: {}", key);
            } catch (Exception e) {
                log.error("é€‚é…å™¨æ¸…ç†å¤±è´¥: {}", key, e);
            }
        });
    }

    /**
     * çƒ­æ›´æ–°é€‚é…å™¨
     */
    public void hotUpdateAdapter(String manufacturer, String deviceType,
                                  Class<? extends DeviceProtocolAdapter> newAdapterClass) {

        try {
            // 1. åœç”¨æ—§é€‚é…å™¨
            DeviceProtocolAdapter oldAdapter = adapterFactory.getAdapter(manufacturer, deviceType);
            if (oldAdapter != null) {
                oldAdapter.cleanup();
            }

            // 2. åˆ›å»ºæ–°é€‚é…å™¨
            DeviceProtocolAdapter newAdapter = newAdapterClass.getDeclaredConstructor().newInstance();

            // 3. é‡æ–°æ³¨å†Œ
            adapterFactory.registerAdapter(manufacturer, deviceType, newAdapter, createAdapterConfig());

            log.info("é€‚é…å™¨çƒ­æ›´æ–°æˆåŠŸ: {} - {}", manufacturer, deviceType);

        } catch (Exception e) {
            log.error("é€‚é…å™¨çƒ­æ›´æ–°å¤±è´¥: {} - {}", manufacturer, deviceType, e);
            throw new AdapterUpdateException("çƒ­æ›´æ–°å¤±è´¥", e);
        }
    }
}
```

---

**ğŸ’¡ ä¸“ä¸šæç¤º**: å¤šåè®®è®¾å¤‡é€‚é…ä¸“å®¶éœ€è¦å…·å¤‡æ·±åšçš„æ¶æ„è®¾è®¡èƒ½åŠ›å’Œä¸°å¯Œçš„åè®®å¼€å‘ç»éªŒï¼Œèƒ½å¤Ÿè®¾è®¡å’Œå®ç°é«˜æ‰©å±•æ€§ã€é«˜æ€§èƒ½çš„åè®®é€‚é…ä½“ç³»ï¼Œç¡®ä¿ä¼ä¸šçº§è®¾å¤‡ç®¡ç†ç³»ç»Ÿæ”¯æŒå„ç§è®¾å¤‡çš„æ— ç¼æ¥å…¥å’Œç»Ÿä¸€ç®¡ç†ã€‚