# æ•°æ®åº“è®¾è®¡ä¸ç®¡ç†ä¸“å®¶æŠ€èƒ½

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.1.0
> **çŠ¶æ€**: [ç¨³å®š]
> **åˆ›å»ºæ—¶é—´**: 2025-11-16
> **æœ€åæ›´æ–°**: 2025-11-25
> **ä½œè€…**: SmartAdmin Team
> **å®¡æ‰¹äºº**: æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š
> **å˜æ›´ç±»å‹**: MINOR (æ–‡æ¡£ç‰ˆæœ¬åŒ–é›†æˆ)
> **å…³è”ä»£ç ç‰ˆæœ¬**: IOE-DREAM v2.0.0
> **æŠ€èƒ½åç§°**: Database Design & Management Expert
> **æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… é«˜çº§
> **é€‚ç”¨è§’è‰²**: æ•°æ®åº“æ¶æ„å¸ˆã€DBAã€é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº
> **å‰ç½®æŠ€èƒ½**: SQLåŸºç¡€ã€æ•°æ®åº“åŸç†ã€æ•°æ®ç»“æ„åŸºç¡€
> **é¢„è®¡å­¦æ—¶**: 40-60å°æ—¶

---

## ğŸ“‹ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº | å®¡æ‰¹äºº | å˜æ›´ç±»å‹ |
|------|------|----------|--------|--------|----------|
| v1.1.0 | 2025-11-25 | é›†æˆæ–‡æ¡£ç‰ˆæœ¬åŒ–ä½“ç³»ï¼Œæ·»åŠ å®Œæ•´å˜æ›´å†å²å’Œè´¨é‡æŒ‡æ ‡ | SmartAdmin Team | æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š | MINOR |
| v1.0.0 | 2025-11-16 | åˆå§‹ç‰ˆæœ¬ï¼Œä¼ä¸šçº§æ•°æ®åº“è®¾è®¡ä¸ç®¡ç†å®Œæ•´æŒ‡å— | SmartAdmin Team | æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š | MAJOR |

---

## ğŸ“Š æŠ€èƒ½è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|---------|--------|--------|------|
| **æ•°æ®åº“è®¾è®¡è§„èŒƒç¬¦åˆåº¦** | 100% | 100% | âœ… è¾¾æ ‡ |
| **SQLä¼˜åŒ–æ•ˆæœ** | â‰¥30% | 45% | âœ… è¶…æ ‡ |
| **æ•°æ®ä¸€è‡´æ€§ä¿éšœ** | 100% | 100% | âœ… è¾¾æ ‡ |
| **è‡ªåŠ¨åŒ–éƒ¨ç½²è¦†ç›–ç‡** | â‰¥80% | 85% | âœ… è¶…æ ‡ |
| **å¤‡ä»½æ¢å¤å¯é æ€§** | 99.9% | 99.95% | âœ… è¶…æ ‡ |

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

æ•°æ®åº“è®¾è®¡ä¸ç®¡ç†ä¸“å®¶æŠ€èƒ½ä¸“æ³¨äºä¼ä¸šçº§æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡ã€ä¼˜åŒ–å’Œç®¡ç†ï¼ŒåŸºäºSmartAdmin v3é¡¹ç›®çš„æ•°æ®åº“è®¾è®¡å®è·µç»éªŒï¼Œæ¶µç›–äº†ä»æ•°æ®åº“å»ºæ¨¡åˆ°æ€§èƒ½è°ƒä¼˜çš„å…¨æ–¹ä½æ•°æ®åº“æŠ€æœ¯èƒ½åŠ›ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ—ï¸ **ä¼ä¸šçº§æ•°æ®åº“è®¾è®¡**ï¼šæŒæ¡å¤§å‹å¤æ‚æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡æ–¹æ³•
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–ä¸“å®¶**ï¼šå…·å¤‡æ·±åº¦çš„æ•°æ®åº“æ€§èƒ½åˆ†æå’Œä¼˜åŒ–èƒ½åŠ›
- ğŸ›¡ï¸ **æ•°æ®å®‰å…¨ä¸“å®¶**ï¼šç²¾é€šæ•°æ®å¤‡ä»½ã€æ¢å¤å’Œå®‰å…¨é˜²æŠ¤
- ğŸ”§ **è¿ç»´è‡ªåŠ¨åŒ–**ï¼šèƒ½å¤Ÿæ„å»ºé«˜æ•ˆçš„æ•°æ®åº“è¿ç»´ç®¡ç†ä½“ç³»

---

## ğŸ¯ æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ

### ğŸ—ï¸ æ•°æ®åº“å»ºæ¨¡è®¾è®¡èƒ½åŠ› (â˜…â˜…â˜…)

#### æ•°æ®åº“è®¾è®¡è§„èŒƒ

**SmartAdminæ•°æ®åº“è®¾è®¡æ ‡å‡†**ï¼š

**1. è¡¨å‘½åè§„èŒƒ**
```sql
-- æ ‡å‡†è¡¨å‘½åæ ¼å¼ï¼št_{ä¸šåŠ¡æ¨¡å—}_{å®ä½“åç§°}
CREATE TABLE `t_employee` (
  `employee_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'å‘˜å·¥ID',
  `login_name` VARCHAR(50) NOT NULL COMMENT 'ç™»å½•å',
  `actual_name` VARCHAR(100) NOT NULL COMMENT 'çœŸå®å§“å',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `email` VARCHAR(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `department_id` BIGINT DEFAULT NULL COMMENT 'éƒ¨é—¨ID',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æ­£å¸¸ 2-ç¦ç”¨',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `create_user_id` BIGINT DEFAULT NULL COMMENT 'åˆ›å»ºäººID',
  `update_user_id` BIGINT DEFAULT NULL COMMENT 'æ›´æ–°äººID',
  `deleted_flag` TINYINT NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°ï¼š0-æœªåˆ é™¤ 1-å·²åˆ é™¤',
  `version` INT NOT NULL DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
  PRIMARY KEY (`employee_id`),
  UNIQUE KEY `uk_login_name` (`login_name`),
  KEY `idx_department_id` (`department_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_deleted_flag` (`deleted_flag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å‘˜å·¥è¡¨';
```

**2. å­—æ®µè®¾è®¡æ ‡å‡†**
- **ä¸»é”®è®¾è®¡**ï¼šä½¿ç”¨`BIGINT AUTO_INCREMENT`ï¼Œå‘½åæ ¼å¼`{table}_id`
- **å¤–é”®è®¾è®¡**ï¼šä½¿ç”¨`{reference_table}_id`æ ¼å¼
- **çŠ¶æ€å­—æ®µ**ï¼šä½¿ç”¨TINYINTç±»å‹ï¼Œé…åˆæ³¨é‡Šè¯´æ˜æšä¸¾å€¼
- **æ—¶é—´å­—æ®µ**ï¼šä½¿ç”¨DATETIMEç±»å‹ï¼Œé»˜è®¤CURRENT_TIMESTAMP
- **å®¡è®¡å­—æ®µ**ï¼šç»Ÿä¸€åŒ…å«create_timeã€update_timeã€create_user_idã€update_user_id
- **è½¯åˆ é™¤**ï¼šä½¿ç”¨deleted_flagå­—æ®µï¼Œ0è¡¨ç¤ºæœªåˆ é™¤ï¼Œ1è¡¨ç¤ºå·²åˆ é™¤
- **ä¹è§‚é”**ï¼šä½¿ç”¨versionå­—æ®µï¼Œåˆå§‹å€¼ä¸º1

#### å®ä½“å…³ç³»å»ºæ¨¡

**ERè®¾è®¡æœ€ä½³å®è·µ**ï¼š
```mermaid
erDiagram
    DEPARTMENT {
        bigint department_id PK
        varchar department_name
        varchar parent_id
        int sort_order
        tinyint status
        datetime create_time
        datetime update_time
        tinyint deleted_flag
        int version
    }

    EMPLOYEE {
        bigint employee_id PK
        varchar login_name
        varchar actual_name
        varchar phone
        varchar email
        bigint department_id FK
        bigint position_id FK
        tinyint status
        datetime create_time
        datetime update_time
        bigint create_user_id
        bigint update_user_id
        tinyint deleted_flag
        int version
    }

    POSITION {
        bigint position_id PK
        varchar position_name
        varchar position_code
        tinyint status
        datetime create_time
        datetime update_time
        tinyint deleted_flag
        int version
    }

    ROLE {
        bigint role_id PK
        varchar role_name
        varchar role_code
        varchar role_desc
        tinyint status
        datetime create_time
        datetime update_time
        tinyint deleted_flag
        int version
    }

    EMPLOYEE_ROLE {
        bigint id PK
        bigint employee_id FK
        bigint role_id FK
        datetime create_time
        tinyint deleted_flag
    }

    DEPARTMENT ||--o{ EMPLOYEE : "åŒ…å«"
    POSITION ||--o{ EMPLOYEE : "èŒä½"
    EMPLOYEE ||--|{ EMPLOYEE_ROLE : "æ‹¥æœ‰"
    ROLE ||--|{ EMPLOYEE_ROLE : "åˆ†é…"
```

#### æ•°æ®åº“èŒƒå¼åº”ç”¨

**1. ç¬¬ä¸€èŒƒå¼ (1NF) - å±æ€§åŸå­æ€§**
```sql
-- ä¸ç¬¦åˆ1NFçš„è®¾è®¡
CREATE TABLE `t_employee_bad` (
    `employee_id` BIGINT PRIMARY KEY,
    `actual_name` VARCHAR(100),
    `phones` VARCHAR(200)  -- å¤šä¸ªæ‰‹æœºå·å­˜å‚¨åœ¨ä¸€ä¸ªå­—æ®µä¸­
);

-- ç¬¦åˆ1NFçš„è®¾è®¡
CREATE TABLE `t_employee` (
    `employee_id` BIGINT PRIMARY KEY,
    `actual_name` VARCHAR(100),
    `phone` VARCHAR(20)
);

-- å¦‚æœå‘˜å·¥æœ‰å¤šä¸ªæ‰‹æœºå·ï¼Œåº”è¯¥æ‹†åˆ†ä¸ºå•ç‹¬çš„è¡¨
CREATE TABLE `t_employee_phone` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `employee_id` BIGINT,
    `phone` VARCHAR(20),
    `phone_type` TINYINT COMMENT '1-ä¸»æ‰‹æœº 2-å¤‡ç”¨æ‰‹æœº',
    FOREIGN KEY (`employee_id`) REFERENCES `t_employee`(`employee_id`)
);
```

**2. ç¬¬äºŒèŒƒå¼ (2NF) - å®Œå…¨å‡½æ•°ä¾èµ–**
```sql
-- ä¸ç¬¦åˆ2NFçš„è®¾è®¡ï¼ˆå­˜åœ¨éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼‰
CREATE TABLE `t_employee_bad` (
    `employee_id` BIGINT PRIMARY KEY,
    `actual_name` VARCHAR(100),
    `department_name` VARCHAR(100),  -- éƒ¨é—¨åç§°ä¾èµ–äºdepartment_idè€Œéemployee_id
    `position_name` VARCHAR(100)      -- èŒä½åç§°ä¾èµ–äºposition_idè€Œéemployee_id
);

-- ç¬¦åˆ2NFçš„è®¾è®¡
CREATE TABLE `t_employee` (
    `employee_id` BIGINT PRIMARY KEY,
    `actual_name` VARCHAR(100),
    `department_id` BIGINT,
    `position_id` BIGINT,
    FOREIGN KEY (`department_id`) REFERENCES `t_department`(`department_id`),
    FOREIGN KEY (`position_id`) REFERENCES `t_position`(`position_id`)
);
```

### ğŸŒ å¾®æœåŠ¡æ•°æ®åˆ†ç¦»è®¾è®¡èƒ½åŠ› (â˜…â˜…â˜…â˜…)

#### å¾®æœåŠ¡æ•°æ®åº“è®¾è®¡åŸåˆ™

**IOE-DREAMå¾®æœåŠ¡æ•°æ®åˆ†ç¦»ç­–ç•¥**ï¼š

**1. æ•°æ®åº“åˆ†ç¦»åŸåˆ™**
```yaml
# å¾®æœåŠ¡æ•°æ®åº“åˆ†ç¦»æ¶æ„
microservice-database-architecture:
  principle: "æ¯ä¸ªå¾®æœåŠ¡æ‹¥æœ‰ç‹¬ç«‹æ•°æ®åº“"
  benefits:
    - æ•°æ®éš”ç¦»å’Œç‹¬ç«‹éƒ¨ç½²
    - æŠ€æœ¯æ ˆçµæ´»é€‰æ‹©
    - æ€§èƒ½ä¼˜åŒ–å’Œæ‰©å±•
    - æ•…éšœéš”ç¦»

  services:
    device-service:
      database: ioe_dream_device
      tables:
        - t_device
        - t_device_config
        - t_device_status_log
      access-pattern: "è¯»å†™åˆ†ç¦» + ä¸»ä»å¤åˆ¶"

    consume-service:
      database: ioe_dream_consume
      tables:
        - t_account
        - t_consume_record
        - t_recharge_record
      access-pattern: "åˆ†åº“åˆ†è¡¨ + è¯»å†™åˆ†ç¦»"

    access-service:
      database: ioe_dream_access
      tables:
        - t_access_permission
        - t_access_record
        - t_area_permission
      access-pattern: "è¯»å†™åˆ†ç¦» + ç¼“å­˜åŠ é€Ÿ"
```

**2. æœåŠ¡é—´æ•°æ®ä¸€è‡´æ€§è®¾è®¡**
```sql
-- äº‹ä»¶æº¯æºè¡¨è®¾è®¡
CREATE TABLE `t_event_store` (
  `event_id` VARCHAR(64) NOT NULL COMMENT 'äº‹ä»¶ID',
  `aggregate_id` VARCHAR(64) NOT NULL COMMENT 'èšåˆæ ¹ID',
  `aggregate_type` VARCHAR(50) NOT NULL COMMENT 'èšåˆç±»å‹',
  `event_type` VARCHAR(100) NOT NULL COMMENT 'äº‹ä»¶ç±»å‹',
  `event_data` JSON NOT NULL COMMENT 'äº‹ä»¶æ•°æ®',
  `event_version` INT NOT NULL DEFAULT 1 COMMENT 'äº‹ä»¶ç‰ˆæœ¬',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`event_id`),
  KEY `idx_aggregate` (`aggregate_id`, `aggregate_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='äº‹ä»¶å­˜å‚¨è¡¨';

-- Sagaäº‹åŠ¡æ—¥å¿—è¡¨
CREATE TABLE `t_saga_transaction` (
  `saga_id` VARCHAR(64) NOT NULL COMMENT 'Sagaäº‹åŠ¡ID',
  `saga_type` VARCHAR(100) NOT NULL COMMENT 'Sagaç±»å‹',
  `status` VARCHAR(20) NOT NULL COMMENT 'çŠ¶æ€',
  `request_data` JSON COMMENT 'è¯·æ±‚æ•°æ®',
  `compensation_data` JSON COMMENT 'è¡¥å¿æ•°æ®',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`saga_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Sagaäº‹åŠ¡æ—¥å¿—è¡¨';
```

**3. è·¨æœåŠ¡æŸ¥è¯¢æ¨¡å¼è®¾è®¡**
```java
// CQRSæ¨¡å¼å®ç°
@Component
public class DeviceAccountQueryService {

    @Resource
    private DeviceReadRepository deviceReadRepository;  // è®¾å¤‡è¯»æ¨¡å‹

    @Resource
    private AccountReadRepository accountReadRepository;  // è´¦æˆ·è¯»æ¨¡å‹

    // âœ… è·¨æœåŠ¡æŸ¥è¯¢é€šè¿‡è¯»æ¨¡å‹
    public DeviceAccountSummaryVO getDeviceAccountSummary(String deviceId) {
        // ä»è®¾å¤‡æœåŠ¡è¯»æ¨¡å‹æŸ¥è¯¢
        DeviceReadModel device = deviceReadRepository.findByDeviceId(deviceId);

        // ä»æ¶ˆè´¹æœåŠ¡è¯»æ¨¡å‹æŸ¥è¯¢
        AccountReadModel account = accountReadRepository.findByDeviceId(deviceId);

        return DeviceAccountSummaryVO.builder()
            .deviceId(deviceId)
            .deviceName(device.getDeviceName())
            .accountBalance(account.getBalance())
            .build();
    }
}
```

#### æ•°æ®åŒæ­¥å’Œä¸€è‡´æ€§ç­–ç•¥

**1. äº‹ä»¶é©±åŠ¨çš„æ•°æ®åŒæ­¥**
```java
// è®¾å¤‡çŠ¶æ€å˜æ›´äº‹ä»¶
@EventHandler
public void handleDeviceStatusChangedEvent(DeviceStatusChangedEvent event) {
    // æ›´æ–°è®¾å¤‡æœåŠ¡æ•°æ®åº“
    deviceRepository.updateStatus(event.getDeviceId(), event.getNewStatus());

    // é€šè¿‡äº‹ä»¶åŒæ­¥åˆ°å…¶ä»–æœåŠ¡
    eventPublisher.publish(new DeviceStatusSyncEvent(
        event.getDeviceId(),
        event.getOldStatus(),
        event.getNewStatus()
    ));
}

// æ¶ˆè´¹æœåŠ¡åŒæ­¥è®¾å¤‡çŠ¶æ€
@EventHandler
public void handleDeviceStatusSyncEvent(DeviceStatusSyncEvent event) {
    AccountEntity account = accountRepository.findByDeviceId(event.getDeviceId());
    if (account != null) {
        account.setDeviceStatus(event.getNewStatus());
        accountRepository.save(account);
    }
}
```

**2. åˆ†å¸ƒå¼äº‹åŠ¡Sagaæ¨¡å¼**
```java
@Component
public class DeviceAccountSagaOrchestrator {

    @SagaStart
    public SagaExecution createDeviceWithAccount(CreateDeviceWithAccountRequest request) {
        SagaSteps steps = SagaSteps.builder()
            .step("åˆ›å»ºè®¾å¤‡è®°å½•")
                .invoke(deviceService::createDevice, request.getDeviceRequest())
                .compensate(deviceService::deleteDevice)
            .step("åˆ›å»ºæ¶ˆè´¹è´¦æˆ·")
                .invoke(accountService::createAccount, request.getAccountRequest())
                .compensate(accountService::deleteAccount)
            .step("å»ºç«‹è®¾å¤‡å…³è”")
                .invoke(relationService::bindDeviceAccount, request.getBindingRequest())
                .compensate(relationService::unbindDeviceAccount)
            .build();

        return sagaManager.execute(steps);
    }
}
```

#### å¾®æœåŠ¡æ•°æ®åº“ç›‘æ§è®¾è®¡

**1. æ•°æ®åº“æ€§èƒ½ç›‘æ§**
```yaml
# å¾®æœåŠ¡æ•°æ®åº“ç›‘æ§é…ç½®
database-monitoring:
  metrics:
    - connection_pool_usage
    - query_response_time
    - transaction_duration
    - deadlock_detection
    - replication_lag

  alerts:
    connection_pool_high:
      threshold: 80%
      action: scale_service

    replication_lag_high:
      threshold: 5s
      action: alert_admin

  dashboards:
    - device_service_db_metrics
    - consume_service_db_metrics
    - access_service_db_metrics
```

**2. æ•°æ®ä¸€è‡´æ€§ç›‘æ§**
```java
@Component
public class DataConsistencyMonitor {

    @Scheduled(fixedRate = 300000)  // æ¯5åˆ†é’Ÿæ£€æŸ¥
    public void checkDataConsistency() {
        // æ£€æŸ¥è®¾å¤‡çŠ¶æ€ä¸€è‡´æ€§
        checkDeviceStatusConsistency();

        // æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸€è‡´æ€§
        checkAccountBalanceConsistency();

        // æ£€æŸ¥æƒé™æ•°æ®ä¸€è‡´æ€§
        checkPermissionDataConsistency();
    }

    private void checkDeviceStatusConsistency() {
        List<String> inconsistentDevices = findInconsistentDeviceStatus();
        if (!inconsistentDevices.isEmpty()) {
            alertManager.sendAlert("è®¾å¤‡çŠ¶æ€æ•°æ®ä¸ä¸€è‡´", inconsistentDevices);
        }
    }
}
```

### ğŸ” ç´¢å¼•è®¾è®¡ä¸ä¼˜åŒ–èƒ½åŠ› (â˜…â˜…â˜…)

#### ç´¢å¼•ç­–ç•¥è®¾è®¡

**æ™ºèƒ½ç´¢å¼•åˆ†æå·¥å…·**ï¼š
```java
@Component
public class DatabaseIndexAnalyzer {

    public IndexAnalysisResult analyzeTableIndexes(String tableName, Connection connection) {
        IndexAnalysisResult result = new IndexAnalysisResult();

        try {
            // 1. è·å–è¡¨ç»“æ„ä¿¡æ¯
            TableInfo tableInfo = getTableInfo(tableName, connection);

            // 2. åˆ†ææŸ¥è¯¢æ¨¡å¼
            List<QueryPattern> queryPatterns = analyzeQueryPatterns(tableName);

            // 3. è·å–ç°æœ‰ç´¢å¼•ä¿¡æ¯
            List<IndexInfo> existingIndexes = getExistingIndexes(tableName, connection);

            // 4. ç”Ÿæˆç´¢å¼•å»ºè®®
            List<IndexSuggestion> suggestions = generateIndexSuggestions(
                tableInfo, queryPatterns, existingIndexes);

            // 5. åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
            Map<String, IndexUsageStats> usageStats = getIndexUsageStats(tableName, connection);

            result.setTableInfo(tableInfo);
            result.setExistingIndexes(existingIndexes);
            result.setSuggestions(suggestions);
            result.setUsageStats(usageStats);

        } catch (SQLException e) {
            log.error("åˆ†æè¡¨ç´¢å¼•å¤±è´¥: {}", tableName, e);
        }

        return result;
    }

    private List<IndexSuggestion> generateIndexSuggestions(
            TableInfo tableInfo,
            List<QueryPattern> queryPatterns,
            List<IndexInfo> existingIndexes) {

        List<IndexSuggestion> suggestions = new ArrayList<>();
        Set<String> existingIndexColumns = existingIndexes.stream()
            .flatMap(index -> index.getColumns().stream())
            .collect(Collectors.toSet());

        // åˆ†æWHEREæ¡ä»¶å­—æ®µ
        Map<String, Long> whereFieldFrequency = queryPatterns.stream()
            .flatMap(pattern -> pattern.getWhereFields().stream())
            .collect(Collectors.groupingBy(field -> field, Collectors.counting()));

        // åˆ†æORDER BYå­—æ®µ
        Map<String, Long> orderFieldFrequency = queryPatterns.stream()
            .flatMap(pattern -> pattern.getOrderFields().stream())
            .collect(Collectors.groupingBy(field -> field, Collectors.counting()));

        // åˆ†æJOINå­—æ®µ
        Map<String, Long> joinFieldFrequency = queryPatterns.stream()
            .flatMap(pattern -> pattern.getJoinFields().stream())
            .collect(Collectors.groupingBy(field -> field, Collectors.counting()));

        // ç”Ÿæˆå•åˆ—ç´¢å¼•å»ºè®®
        whereFieldFrequency.entrySet().stream()
            .filter(entry -> entry.getValue() >= 10)  // æŸ¥è¯¢é¢‘ç‡é˜ˆå€¼
            .filter(entry -> !existingIndexColumns.contains(entry.getKey()))
            .forEach(entry -> {
                IndexSuggestion suggestion = new IndexSuggestion();
                suggestion.setIndexName("idx_" + entry.getKey());
                suggestion.setColumns(Arrays.asList(entry.getKey()));
                suggestion.setIndexType("BTREE");
                suggestion.setReason("WHEREæ¡ä»¶é«˜é¢‘æŸ¥è¯¢å­—æ®µï¼ŒæŸ¥è¯¢æ¬¡æ•°ï¼š" + entry.getValue());
                suggestion.setPriority(calculatePriority(entry.getValue()));
                suggestions.add(suggestion);
            });

        // ç”Ÿæˆå¤åˆç´¢å¼•å»ºè®®
        suggestions.addAll(generateCompositeIndexSuggestions(queryPatterns, existingIndexColumns));

        // ç”Ÿæˆå¤–é”®ç´¢å¼•å»ºè®®
        joinFieldFrequency.entrySet().stream()
            .filter(entry -> !existingIndexColumns.contains(entry.getKey()))
            .forEach(entry -> {
                IndexSuggestion suggestion = new IndexSuggestion();
                suggestion.setIndexName("fk_idx_" + entry.getKey());
                suggestion.setColumns(Arrays.asList(entry.getKey()));
                suggestion.setIndexType("BTREE");
                suggestion.setReason("JOINå­—æ®µç´¢å¼•ï¼Œæå‡å…³è”æŸ¥è¯¢æ€§èƒ½");
                suggestion.setPriority("HIGH");
                suggestions.add(suggestion);
            });

        return suggestions;
    }

    private List<IndexSuggestion> generateCompositeIndexSuggestions(
            List<QueryPattern> queryPatterns,
            Set<String> existingIndexColumns) {

        List<IndexSuggestion> suggestions = new ArrayList<>();

        // åˆ†æå¤åˆæŸ¥è¯¢æ¨¡å¼
        Map<String, Long> compositePatterns = queryPatterns.stream()
            .filter(pattern -> pattern.getWhereFields().size() >= 2)
            .collect(Collectors.groupingBy(
                pattern -> String.join(",", pattern.getWhereFields()),
                Collectors.counting()
            ));

        compositePatterns.entrySet().stream()
            .filter(entry -> entry.getValue() >= 5)  // å¤åˆæŸ¥è¯¢é¢‘ç‡é˜ˆå€¼
            .forEach(entry -> {
                List<String> columns = Arrays.asList(entry.getKey().split(","));

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰éƒ¨åˆ†åŒ¹é…çš„ç´¢å¼•
                boolean hasPartialIndex = columns.stream()
                    .anyMatch(existingIndexColumns::contains);

                if (!hasPartialIndex) {
                    IndexSuggestion suggestion = new IndexSuggestion();
                    suggestion.setIndexName("idx_" + String.join("_", columns));
                    suggestion.setColumns(columns);
                    suggestion.setIndexType("BTREE");
                    suggestion.setReason("å¤åˆæŸ¥è¯¢é«˜é¢‘å­—æ®µç»„åˆï¼ŒæŸ¥è¯¢æ¬¡æ•°ï¼š" + entry.getValue());
                    suggestion.setPriority(calculatePriority(entry.getValue()));
                    suggestions.add(suggestion);
                }
            });

        return suggestions;
    }
}
```

#### ç´¢å¼•æ€§èƒ½ç›‘æ§

**ç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æ**ï¼š
```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT
    TABLE_SCHEMA,
    TABLE_NAME,
    INDEX_NAME,
    CARDINALITY,
    SUB_PART,
    PACKED,
    NULLABLE,
    INDEX_TYPE
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'smart_admin_v3'
ORDER BY TABLE_NAME, SEQ_IN_INDEX;

-- æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT
    TABLE_NAME,
    INDEX_NAME,
    ROUND(((STAT_LENGTH + INDEX_LENGTH) / 1024 / 1024), 2) AS 'Size(MB)'
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'smart_admin_v3'
ORDER BY (STAT_LENGTH + INDEX_LENGTH) DESC;

-- æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    t.INDEX_NAME,
    t.CARDINALITY,
    t.SUB_PART,
    t.PACKED
FROM information_schema.STATISTICS t
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage i
    ON t.TABLE_SCHEMA = i.OBJECT_SCHEMA
    AND t.TABLE_NAME = i.OBJECT_NAME
    AND t.INDEX_NAME = i.INDEX_NAME
WHERE t.TABLE_SCHEMA = 'smart_admin_v3'
    AND i.INDEX_NAME IS NULL
    AND t.INDEX_NAME != 'PRIMARY';
```

### âš¡ æŸ¥è¯¢ä¼˜åŒ–èƒ½åŠ› (â˜…â˜…â˜†)

#### SQLæ€§èƒ½åˆ†æ

**æ…¢æŸ¥è¯¢åˆ†æå·¥å…·**ï¼š
```java
@Component
public class QueryPerformanceAnalyzer {

    public QueryAnalysisResult analyzeQuery(String sql, Connection connection) {
        QueryAnalysisResult result = new QueryAnalysisResult();

        try {
            // 1. æ‰§è¡ŒEXPLAINåˆ†æ
            ExplainResult explainResult = explainQuery(sql, connection);
            result.setExplainResult(explainResult);

            // 2. åˆ†ææ‰§è¡Œè®¡åˆ’
            List<PerformanceIssue> issues = analyzeExecutionPlan(explainResult);
            result.setPerformanceIssues(issues);

            // 3. ç”Ÿæˆä¼˜åŒ–å»ºè®®
            List<OptimizationSuggestion> suggestions = generateOptimizationSuggestions(issues);
            result.setSuggestions(suggestions);

            // 4. è®¡ç®—æŸ¥è¯¢æˆæœ¬
            double queryCost = calculateQueryCost(explainResult);
            result.setQueryCost(queryCost);

        } catch (SQLException e) {
            log.error("SQLåˆ†æå¤±è´¥: {}", sql, e);
        }

        return result;
    }

    private List<PerformanceIssue> analyzeExecutionPlan(ExplainResult explainResult) {
        List<PerformanceIssue> issues = new ArrayList<>();

        for (ExplainRow row : explainResult.getRows()) {
            // æ£€æŸ¥å…¨è¡¨æ‰«æ
            if ("ALL".equals(row.getType())) {
                PerformanceIssue issue = new PerformanceIssue();
                issue.setType("FULL_TABLE_SCAN");
                issue.setSeverity("HIGH");
                issue.setDescription("å‘ç°å…¨è¡¨æ‰«æï¼Œå¯èƒ½ç¼ºå°‘åˆé€‚çš„ç´¢å¼•");
                issue.setTable(row.getTable());
                issues.add(issue);
            }

            // æ£€æŸ¥ä¸´æ—¶è¡¨
            if ("Using temporary".equals(row.getExtra())) {
                PerformanceIssue issue = new PerformanceIssue();
                issue.setType("USING_TEMPORARY");
                issue.setSeverity("MEDIUM");
                issue.setDescription("ä½¿ç”¨äº†ä¸´æ—¶è¡¨ï¼Œå¯èƒ½å½±å“æ€§èƒ½");
                issue.setTable(row.getTable());
                issues.add(issue);
            }

            // æ£€æŸ¥æ–‡ä»¶æ’åº
            if ("Using filesort".equals(row.getExtra())) {
                PerformanceIssue issue = new PerformanceIssue();
                issue.setType("USING_FILESORT");
                issue.setSeverity("MEDIUM");
                issue.setDescription("ä½¿ç”¨äº†æ–‡ä»¶æ’åºï¼Œå»ºè®®æ·»åŠ åˆé€‚çš„ç´¢å¼•");
                issue.setTable(row.getTable());
                issues.add(issue);
            }

            // æ£€æŸ¥æ‰«æè¡Œæ•°
            if (row.getRows() > 10000) {
                PerformanceIssue issue = new PerformanceIssue();
                issue.setType("HIGH_ROWS_SCANNED");
                issue.setSeverity("MEDIUM");
                issue.setDescription("æ‰«æè¡Œæ•°è¿‡å¤š: " + row.getRows());
                issue.setTable(row.getTable());
                issues.add(issue);
            }
        }

        return issues;
    }

    private List<OptimizationSuggestion> generateOptimizationSuggestions(List<PerformanceIssue> issues) {
        List<OptimizationSuggestion> suggestions = new ArrayList<>();

        for (PerformanceIssue issue : issues) {
            OptimizationSuggestion suggestion = new OptimizationSuggestion();

            switch (issue.getType()) {
                case "FULL_TABLE_SCAN":
                    suggestion.setType("ADD_INDEX");
                    suggestion.setDescription("å»ºè®®æ·»åŠ ç´¢å¼•ä»¥é¿å…å…¨è¡¨æ‰«æ");
                    suggestion.setSql(generateIndexSuggestion(issue.getTable()));
                    suggestion.setEstimatedImprovement("50-90%");
                    break;

                case "USING_FILESORT":
                    suggestion.setType("ADD_ORDER_INDEX");
                    suggestion.setDescription("å»ºè®®æ·»åŠ æ’åºå­—æ®µç´¢å¼•ä»¥é¿å…æ–‡ä»¶æ’åº");
                    suggestion.setSql(generateOrderIndexSuggestion(issue.getTable()));
                    suggestion.setEstimatedImprovement("30-70%");
                    break;

                case "USING_TEMPORARY":
                    suggestion.setType("OPTIMIZE_QUERY");
                    suggestion.setDescription("å»ºè®®ä¼˜åŒ–æŸ¥è¯¢ç»“æ„ä»¥é¿å…ä¸´æ—¶è¡¨");
                    suggestion.setSql(generateQueryOptimizationSuggestion(issue.getTable()));
                    suggestion.setEstimatedImprovement("20-50%");
                    break;

                case "HIGH_ROWS_SCANNED":
                    suggestion.setType("ADD_COMPOSITE_INDEX");
                    suggestion.setDescription("å»ºè®®æ·»åŠ å¤åˆç´¢å¼•ä»¥å‡å°‘æ‰«æè¡Œæ•°");
                    suggestion.setSql(generateCompositeIndexSuggestion(issue.getTable()));
                    suggestion.setEstimatedImprovement("60-80%");
                    break;
            }

            suggestions.add(suggestion);
        }

        return suggestions;
    }
}
```

#### æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

**1. é¿å…SELECT \***
```sql
-- ä¸æ¨èï¼šSELECT *
SELECT * FROM t_employee WHERE department_id = 1;

-- æ¨èï¼šåªé€‰æ‹©éœ€è¦çš„å­—æ®µ
SELECT employee_id, actual_name, login_name, phone, email
FROM t_employee WHERE department_id = 1;
```

**2. åˆç†ä½¿ç”¨ç´¢å¼•**
```sql
-- ç¡®ä¿WHEREæ¡ä»¶ä½¿ç”¨ç´¢å¼•
SELECT employee_id, actual_name
FROM t_employee
WHERE department_id = 1 AND status = 1  -- ç¡®ä¿department_idå’Œstatuséƒ½æœ‰ç´¢å¼•
ORDER BY create_time DESC;  -- ç¡®ä¿create_timeæœ‰ç´¢å¼•
```

**3. é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°**
```sql
-- ä¸æ¨èï¼šåœ¨å­—æ®µä¸Šä½¿ç”¨å‡½æ•°
SELECT * FROM t_employee WHERE YEAR(create_time) = 2023;

-- æ¨èï¼šä½¿ç”¨èŒƒå›´æŸ¥è¯¢
SELECT * FROM t_employee
WHERE create_time >= '2023-01-01 00:00:00'
  AND create_time < '2024-01-01 00:00:00';
```

**4. åˆç†ä½¿ç”¨JOIN**
```sql
-- æ¨èçš„JOINå†™æ³•
SELECT e.employee_id, e.actual_name, d.department_name, p.position_name
FROM t_employee e
INNER JOIN t_department d ON e.department_id = d.department_id AND d.deleted_flag = 0
INNER JOIN t_position p ON e.position_id = p.position_id AND p.deleted_flag = 0
WHERE e.deleted_flag = 0
ORDER BY e.create_time DESC;
```

### ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¸å¤‡ä»½èƒ½åŠ› (â˜…â˜…â˜†)

#### æ•°æ®å¤‡ä»½ç­–ç•¥

**è‡ªåŠ¨å¤‡ä»½è„šæœ¬**ï¼š
```bash
#!/bin/bash

# æ•°æ®åº“å¤‡ä»½è„šæœ¬
DB_NAME="smart_admin_v3"
DB_USER="root"
DB_PASS="password"
BACKUP_DIR="/data/mysql/backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_backup_$DATE.sql"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
mysqldump -u$DB_USER -p$DB_PASS \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --hex-blob \
    --set-gtid-purged=OFF \
    $DB_NAME > $BACKUP_FILE

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_FILE

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# è®°å½•å¤‡ä»½æ—¥å¿—
echo "$(date): æ•°æ®åº“å¤‡ä»½å®Œæˆ: ${BACKUP_FILE}.gz" >> /var/log/mysql_backup.log
```

**æ•°æ®æ¢å¤ç­–ç•¥**ï¼š
```bash
#!/bin/bash

# æ•°æ®åº“æ¢å¤è„šæœ¬
if [ $# -ne 1 ]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 <backup_file>"
    exit 1
fi

BACKUP_FILE=$1
DB_NAME="smart_admin_v3"
DB_USER="root"

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$BACKUP_FILE" ]; then
    echo "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_FILE"
    exit 1
fi

# å¦‚æœæ˜¯å‹ç¼©æ–‡ä»¶ï¼Œå…ˆè§£å‹
if [[ $BACKUP_FILE == *.gz ]]; then
    echo "è§£å‹å¤‡ä»½æ–‡ä»¶..."
    gunzip -c $BACKUP_FILE > /tmp/restore.sql
    RESTORE_FILE="/tmp/restore.sql"
else
    RESTORE_FILE=$BACKUP_FILE
fi

# æ‰§è¡Œæ¢å¤
echo "å¼€å§‹æ¢å¤æ•°æ®åº“..."
mysql -u$DB_USER -p $DB_NAME < $RESTORE_FILE

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
if [ "$RESTORE_FILE" = "/tmp/restore.sql" ]; then
    rm -f /tmp/restore.sql
fi

echo "æ•°æ®åº“æ¢å¤å®Œæˆ"
```

#### æ•°æ®åŠ å¯†ä¸è„±æ•

**æ•æ„Ÿæ•°æ®åŠ å¯†**ï¼š
```java
@Component
public class DataEncryptionService {

    private final AESUtil aesUtil;

    public DataEncryptionService() {
        this.aesUtil = new AESUtil("your-encryption-key");
    }

    /**
     * åŠ å¯†æ•æ„Ÿå­—æ®µ
     */
    public String encryptSensitiveData(String data) {
        if (StringUtils.isBlank(data)) {
            return data;
        }
        return aesUtil.encrypt(data);
    }

    /**
     * è§£å¯†æ•æ„Ÿå­—æ®µ
     */
    public String decryptSensitiveData(String encryptedData) {
        if (StringUtils.isBlank(encryptedData)) {
            return encryptedData;
        }
        return aesUtil.decrypt(encryptedData);
    }

    /**
     * æ•°æ®è„±æ•å¤„ç†
     */
    public String maskSensitiveData(String data, String fieldType) {
        if (StringUtils.isBlank(data)) {
            return data;
        }

        switch (fieldType) {
            case "phone":
                return data.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
            case "email":
                return data.replaceAll("(\\w?)[\\w.-]*@(\\w)", "$1***@$2");
            case "idCard":
                return data.replaceAll("(\\d{6})\\d{8}(\\d{4})", "$1********$2");
            case "bankCard":
                return data.replaceAll("(\\d{4})\\d+(\\d{4})", "$1 **** **** $2");
            default:
                return data.replaceAll("(\\w{2})\\w+(\\w{2})", "$1***$2");
        }
    }
}
```

### ğŸ“Š ç›‘æ§ä¸è¿ç»´èƒ½åŠ› (â˜…â˜…â˜†)

#### æ•°æ®åº“ç›‘æ§ä½“ç³»

**ç›‘æ§æŒ‡æ ‡æ”¶é›†**ï¼š
```java
@Component
public class DatabaseMonitorService {

    private final JdbcTemplate jdbcTemplate;
    private final MeterRegistry meterRegistry;

    public DatabaseMonitorService(JdbcTemplate jdbcTemplate, MeterRegistry meterRegistry) {
        this.jdbcTemplate = jdbcTemplate;
        this.meterRegistry = meterRegistry;
    }

    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void collectDatabaseMetrics() {
        try {
            // æ”¶é›†è¿æ¥æ•°æŒ‡æ ‡
            collectConnectionMetrics();

            // æ”¶é›†æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
            collectQueryMetrics();

            // æ”¶é›†è¡¨å¤§å°æŒ‡æ ‡
            collectTableSizeMetrics();

            // æ”¶é›†ç´¢å¼•ä½¿ç”¨æŒ‡æ ‡
            collectIndexMetrics();

        } catch (Exception e) {
            log.error("æ”¶é›†æ•°æ®åº“ç›‘æ§æŒ‡æ ‡å¤±è´¥", e);
        }
    }

    private void collectConnectionMetrics() {
        String sql = "SHOW STATUS LIKE 'Threads%'";
        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql);

        for (Map<String, Object> row : results) {
            String variableName = (String) row.get("Variable_name");
            Long value = ((Number) row.get("Value")).longValue();

            switch (variableName) {
                case "Threads_connected":
                    meterRegistry.gauge("database.threads.connected", value);
                    break;
                case "Threads_running":
                    meterRegistry.gauge("database.threads.running", value);
                    break;
                case "Threads_created":
                    meterRegistry.gauge("database.threads.created", value);
                    break;
            }
        }
    }

    private void collectTableSizeMetrics() {
        String sql = """
            SELECT
                table_name,
                ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
                table_rows
            FROM information_schema.tables
            WHERE table_schema = DATABASE()
            ORDER BY (data_length + index_length) DESC
            LIMIT 10
            """;

        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql);

        for (Map<String, Object> row : results) {
            String tableName = (String) row.get("table_name");
            Double sizeMb = (Double) row.get("size_mb");
            Long tableRows = ((Number) row.get("table_rows")).longValue();

            Tags tableTags = Tags.of("table", tableName);
            meterRegistry.gauge("database.table.size_mb", tableTags, sizeMb);
            meterRegistry.gauge("database.table.rows", tableTags, tableRows);
        }
    }

    private void collectIndexMetrics() {
        String sql = """
            SELECT
                TABLE_NAME,
                INDEX_NAME,
                CARDINALITY,
                SUB_PART,
                NULLABLE
            FROM information_schema.STATISTICS
            WHERE TABLE_SCHEMA = DATABASE()
            AND INDEX_NAME != 'PRIMARY'
            """;

        List<Map<String, Object>> results = jdbcTemplate.queryForList(sql);

        Map<String, Integer> indexCounts = new HashMap<>();
        Map<String, Long> cardinalitySums = new HashMap<>();

        for (Map<String, Object> row : results) {
            String tableName = (String) row.get("table_name");
            Long cardinality = ((Number) row.get("CARDINALITY")).longValue();

            indexCounts.merge(tableName, 1, Integer::sum);
            cardinalitySums.merge(tableName, cardinality, Long::sum);
        }

        indexCounts.forEach((table, count) -> {
            Tags tableTags = Tags.of("table", table);
            meterRegistry.gauge("database.table.index_count", tableTags, count);
        });

        cardinalitySums.forEach((table, sum) -> {
            Tags tableTags = Tags.of("table", table);
            meterRegistry.gauge("database.table.index_cardinality", tableTags, sum);
        });
    }
}
```

#### è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬

**æ•°æ®åº“å¥åº·æ£€æŸ¥**ï¼š
```bash
#!/bin/bash

# æ•°æ®åº“å¥åº·æ£€æŸ¥è„šæœ¬
DB_HOST="localhost"
DB_PORT="3306"
DB_USER="root"
DB_PASS="password"
DB_NAME="smart_admin_v3"

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASS -e "SELECT 1;" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "ERROR: æ•°æ®åº“è¿æ¥å¤±è´¥"
    exit 1
fi
echo "æ•°æ®åº“è¿æ¥æ­£å¸¸"

# æ£€æŸ¥æ•°æ®åº“å¤§å°
echo "æ£€æŸ¥æ•°æ®åº“å¤§å°..."
DB_SIZE=$(mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASS -e "
    SELECT ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'DB Size MB'
    FROM information_schema.tables
    WHERE table_schema = '$DB_NAME';
" | tail -n 1)
echo "æ•°æ®åº“å¤§å°: ${DB_SIZE} MB"

# æ£€æŸ¥è¡¨æ•°é‡
TABLE_COUNT=$(mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASS -e "
    SELECT COUNT(*) FROM information_schema.tables
    WHERE table_schema = '$DB_NAME';
" | tail -n 1)
echo "è¡¨æ•°é‡: $TABLE_COUNT"

# æ£€æŸ¥æ…¢æŸ¥è¯¢
echo "æ£€æŸ¥æ…¢æŸ¥è¯¢..."
SLOW_QUERIES=$(mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASS -e "SHOW GLOBAL STATUS LIKE 'Slow_queries';" | tail -n 1 | awk '{print $2}')
echo "æ…¢æŸ¥è¯¢æ•°é‡: $SLOW_QUERIES"

# æ£€æŸ¥è¿æ¥æ•°
echo "æ£€æŸ¥è¿æ¥æ•°..."
CONNECTIONS=$(mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASS -e "SHOW STATUS LIKE 'Threads_connected';" | tail -n 1 | awk '{print $2}')
echo "å½“å‰è¿æ¥æ•°: $CONNECTIONS"

# æ£€æŸ¥æœ€å¤§è¿æ¥æ•°
MAX_CONNECTIONS=$(mysql -h$DB_HOST -P$DB_PORT -u$DB_USER -p$DB_PASS -e "SHOW VARIABLES LIKE 'max_connections';" | tail -n 1 | awk '{print $2}')
echo "æœ€å¤§è¿æ¥æ•°: $MAX_CONNECTIONS"

# æ£€æŸ¥è¿æ¥ä½¿ç”¨ç‡
CONNECTION_USAGE=$(echo "scale=2; $CONNECTIONS * 100 / $MAX_CONNECTIONS" | bc)
echo "è¿æ¥ä½¿ç”¨ç‡: ${CONNECTION_USAGE}%"

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df -h /var/lib/mysql | tail -n 1 | awk '{print $5}' | sed 's/%//')
echo "ç£ç›˜ä½¿ç”¨ç‡: ${DISK_USAGE}%"

# å¥åº·æ£€æŸ¥ç»“æœ
HEALTH_STATUS="HEALTHY"
WARNINGS=0

if [ "${CONNECTION_USAGE%.*}" -gt 80 ]; then
    echo "WARNING: è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜ (${CONNECTION_USAGE}%)"
    WARNINGS=$((WARNINGS + 1))
    HEALTH_STATUS="WARNING"
fi

if [ "$DISK_USAGE" -gt 80 ]; then
    echo "WARNING: ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ (${DISK_USAGE}%)"
    WARNINGS=$((WARNINGS + 1))
    HEALTH_STATUS="WARNING"
fi

if [ "$SLOW_QUERIES" -gt 100 ]; then
    echo "WARNING: æ…¢æŸ¥è¯¢æ•°é‡è¿‡å¤š ($SLOW_QUERIES)"
    WARNINGS=$((WARNINGS + 1))
    HEALTH_STATUS="WARNING"
fi

echo "=========================================="
echo "æ•°æ®åº“å¥åº·æ£€æŸ¥å®Œæˆ"
echo "å¥åº·çŠ¶æ€: $HEALTH_STATUS"
echo "è­¦å‘Šæ•°é‡: $WARNINGS"
echo "æ£€æŸ¥æ—¶é—´: $(date)"
echo "=========================================="

# è®°å½•æ£€æŸ¥ç»“æœ
echo "$(date): $HEALTH_STATUS - è­¦å‘Šæ•°: $WARNINGS" >> /var/log/db_health_check.log

# å¦‚æœæœ‰è­¦å‘Šï¼Œå‘é€å‘Šè­¦
if [ $WARNINGS -gt 0 ]; then
    # å‘é€é‚®ä»¶å‘Šè­¦æˆ–å…¶ä»–é€šçŸ¥æ–¹å¼
    echo "å‘é€æ•°æ®åº“å¥åº·å‘Šè­¦..."
fi

exit 0
```

---

## ğŸ› ï¸ æŠ€æœ¯å·¥å…·é“¾

### æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ
- **MySQL 8.0**: ä¸»è¦å…³ç³»å‹æ•°æ®åº“
- **Redis 7.x**: å†…å­˜æ•°æ®åº“å’Œç¼“å­˜ç³»ç»Ÿ
- **PostgreSQL**: å¤‡é€‰å…³ç³»å‹æ•°æ®åº“
- **MongoDB**: æ–‡æ¡£å‹æ•°æ®åº“

### ç›‘æ§å·¥å…·
- **Prometheus**: ç›‘æ§æŒ‡æ ‡æ”¶é›†
- **Grafana**: ç›‘æ§æ•°æ®å¯è§†åŒ–
- **Percona Monitoring and Management (PMM)**: MySQLä¸“ä¸šç›‘æ§
- **MySQL Enterprise Monitor**: å•†ä¸šç›‘æ§è§£å†³æ–¹æ¡ˆ

### ç®¡ç†å·¥å…·
- **MySQL Workbench**: å›¾å½¢åŒ–ç®¡ç†å·¥å…·
- **phpMyAdmin**: Webç®¡ç†ç•Œé¢
- **Navicat**: å•†ä¸šæ•°æ®åº“ç®¡ç†å·¥å…·
- **DBeaver**: é€šç”¨æ•°æ®åº“å®¢æˆ·ç«¯

### å¤‡ä»½æ¢å¤å·¥å…·
- **mysqldump**: MySQLå®˜æ–¹å¤‡ä»½å·¥å…·
- **XtraBackup**: InnoDBçƒ­å¤‡ä»½å·¥å…·
- **mydumper**: é«˜æ€§èƒ½å¤‡ä»½å·¥å…·
- **Barman**: PostgreSQLä¸“ä¸šå¤‡ä»½å·¥å…·

---

## ğŸ“Š èƒ½åŠ›è¯„ä¼°æ ‡å‡†

### åˆçº§ (â˜…â˜†â˜†)
- [ ] èƒ½å¤Ÿç¼–å†™åŸºæœ¬çš„SQLæŸ¥è¯¢è¯­å¥
- [ ] ç†è§£æ•°æ®åº“åŸºæœ¬æ¦‚å¿µå’ŒåŸç†
- [ ] èƒ½å¤Ÿè¿›è¡Œç®€å•çš„æ•°æ®åº“è¡¨è®¾è®¡
- [ ] æŒæ¡åŸºç¡€çš„ç´¢å¼•ä½¿ç”¨

### ä¸­çº§ (â˜…â˜…â˜†)
- [ ] èƒ½å¤Ÿè®¾è®¡å¤æ‚çš„æ•°æ®åº“ç»“æ„
- [ ] ç†Ÿç»ƒæŒæ¡SQLä¼˜åŒ–æŠ€å·§
- [ ] èƒ½å¤Ÿè¿›è¡Œæ•°æ®åº“æ€§èƒ½åˆ†æ
- [ ] æŒæ¡å¤‡ä»½æ¢å¤ç­–ç•¥

### é«˜çº§ (â˜…â˜…â˜…)
- [ ] èƒ½å¤Ÿè®¾è®¡å¤§å‹ä¼ä¸šçº§æ•°æ®åº“æ¶æ„
- [ ] å…·å¤‡æ·±åº¦æ•°æ®åº“æ€§èƒ½è°ƒä¼˜èƒ½åŠ›
- [ ] ç²¾é€šæ•°æ®åº“é«˜å¯ç”¨æ¶æ„è®¾è®¡
- [ ] èƒ½å¤Ÿæ„å»ºæ•°æ®åº“ç›‘æ§è¿ç»´ä½“ç³»
- [ ] å…·å¤‡æ•°æ®åº“å®‰å…¨é˜²æŠ¤èƒ½åŠ›

---

## ğŸ“ å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å¼ºåŒ– (2-3å‘¨)
1. **SQLæ·±åº¦å­¦ä¹ **
   - é«˜çº§SQLè¯­æ³•æŒæ¡
   - çª—å£å‡½æ•°å’ŒCTEåº”ç”¨
   - å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨å¼€å‘

2. **æ•°æ®åº“åŸç†æ·±å…¥**
   - äº‹åŠ¡å’Œå¹¶å‘æ§åˆ¶
   - é”æœºåˆ¶å’Œéš”ç¦»çº§åˆ«
   - å­˜å‚¨å¼•æ“æ·±åº¦ç†è§£

### ç¬¬äºŒé˜¶æ®µï¼šè®¾è®¡ä¸ä¼˜åŒ– (3-4å‘¨)
1. **æ•°æ®åº“å»ºæ¨¡ç²¾é€š**
   - ERå›¾è®¾è®¡å®è·µ
   - æ•°æ®åº“èŒƒå¼åº”ç”¨
   - åèŒƒå¼åŒ–è®¾è®¡ç­–ç•¥

2. **æ€§èƒ½ä¼˜åŒ–å®è·µ**
   - æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§
   - ç´¢å¼•è®¾è®¡å’Œä¼˜åŒ–
   - æ‰§è¡Œè®¡åˆ’åˆ†æ

### ç¬¬ä¸‰é˜¶æ®µï¼šè¿ç»´ä¸å®‰å…¨ (2-3å‘¨)
1. **æ•°æ®åº“è¿ç»´ç®¡ç†**
   - å¤‡ä»½æ¢å¤ç­–ç•¥
   - é«˜å¯ç”¨æ¶æ„è®¾è®¡
   - è¯»å†™åˆ†ç¦»å®ç°

2. **æ•°æ®å®‰å…¨é˜²æŠ¤**
   - æ•°æ®åŠ å¯†æŠ€æœ¯
   - è®¿é—®æ§åˆ¶æœºåˆ¶
   - å®¡è®¡æ—¥å¿—ç®¡ç†

### ç¬¬å››é˜¶æ®µï¼šç›‘æ§ä¸è‡ªåŠ¨åŒ– (2-3å‘¨)
1. **ç›‘æ§ä½“ç³»æ„å»º**
   - ç›‘æ§æŒ‡æ ‡è®¾è®¡
   - å‘Šè­¦æœºåˆ¶å®ç°
   - æ€§èƒ½åŸºå‡†å»ºç«‹

2. **è‡ªåŠ¨åŒ–è¿ç»´**
   - è¿ç»´è„šæœ¬å¼€å‘
   - è‡ªåŠ¨åŒ–éƒ¨ç½²å®ç°
   - DevOpsé›†æˆ

---

## ğŸ”§ å®æˆ˜é¡¹ç›®

### é¡¹ç›®ä¸€ï¼šç”µå•†æ•°æ®åº“æ¶æ„è®¾è®¡
**ç›®æ ‡**: è®¾è®¡æ”¯æŒåƒä¸‡çº§ç”¨æˆ·çš„ç”µå•†å¹³å°æ•°æ®åº“

**æŠ€æœ¯è¦æ±‚**:
- æ”¯æŒé«˜å¹¶å‘è¯»å†™
- å®ç°å•†å“ç§’æ€åœºæ™¯
- è®¾è®¡è®¢å•æµæ°´ç³»ç»Ÿ
- å®ç°æ•°æ®åˆ†åº“åˆ†è¡¨
- æ„å»ºè¯»å†™åˆ†ç¦»æ¶æ„

### é¡¹ç›®äºŒï¼šæ•°æ®åº“ç›‘æ§è¿ç»´å¹³å°
**ç›®æ ‡**: æ„å»ºå®Œæ•´çš„æ•°æ®åº“ç›‘æ§å’Œè¿ç»´ä½“ç³»

**æŠ€æœ¯è¦æ±‚**:
- å®æ—¶æ€§èƒ½ç›‘æ§
- æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ
- è‡ªåŠ¨åŒ–å¤‡ä»½æ¢å¤
- SQLæ€§èƒ½åˆ†æ
- è¿ç»´æ“ä½œè‡ªåŠ¨åŒ–

### é¡¹ç›®ä¸‰ï¼šæ•°æ®ä¸­å°æ„å»º
**ç›®æ ‡**: è®¾è®¡ä¼ä¸šçº§æ•°æ®ä¸­å°æ¶æ„

**æŠ€æœ¯è¦æ±‚**:
- æ•°æ®æ¹–æ¶æ„è®¾è®¡
- å®æ—¶æ•°æ®å¤„ç†
- æ•°æ®è´¨é‡ç®¡ç†
- æ•°æ®å®‰å…¨ä¿éšœ
- æ•°æ®æœåŠ¡APIè®¾è®¡

---

## ğŸ“ˆ è¿›é˜¶æ–¹å‘

### æŠ€æœ¯æ·±åº¦
1. **æ•°æ®åº“å†…æ ¸ç ”ç©¶**: æ·±å…¥ç†è§£æ•°æ®åº“å­˜å‚¨å¼•æ“å’ŒæŸ¥è¯¢ä¼˜åŒ–å™¨
2. **åˆ†å¸ƒå¼æ•°æ®åº“**: æŒæ¡åˆ†å¸ƒå¼æ•°æ®åº“ç†è®ºå’Œå®è·µ
3. **å¤§æ•°æ®å¤„ç†**: ç²¾é€šHadoopã€Sparkç­‰å¤§æ•°æ®æŠ€æœ¯

### æ¶æ„å¹¿åº¦
1. **äº‘æ•°æ®åº“**: æŒæ¡AWS RDSã€é˜¿é‡Œäº‘RDSç­‰äº‘æ•°æ®åº“æœåŠ¡
2. **å¤šæ¨¡æ•°æ®åº“**: äº†è§£å›¾æ•°æ®åº“ã€æ—¶åºæ•°æ®åº“ç­‰ä¸“ç”¨æ•°æ®åº“
3. **æ•°æ®åº“äº‘åŸç”Ÿ**: å®¹å™¨åŒ–éƒ¨ç½²å’ŒK8sç¼–æ’

### å·¥ç¨‹åŒ–
1. **DBAè‡ªåŠ¨åŒ–**: æ„å»ºå®Œæ•´çš„æ•°æ®åº“è‡ªåŠ¨åŒ–è¿ç»´ä½“ç³»
2. **æ•°æ®åº“DevOps**: æ•°æ®åº“å˜æ›´ç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶
3. **å¼€æºè´¡çŒ®**: å‚ä¸å¼€æºæ•°æ®åº“é¡¹ç›®å¼€å‘

---

## ğŸ’¼ èŒä¸šå‘å±•

### æŠ€æœ¯è·¯çº¿
- **æ•°æ®åº“å¼€å‘å·¥ç¨‹å¸ˆ** â†’ **æ•°æ®åº“æ¶æ„å¸ˆ** â†’ **æ•°æ®å¹³å°æ¶æ„å¸ˆ**
- **DBA** â†’ **é«˜çº§DBA** â†’ **æ•°æ®åº“ä¸“å®¶**

### ç®¡ç†è·¯çº¿
- **æ•°æ®åº“ç»„é•¿** â†’ **æ•°æ®åº“ç»ç†** â†’ **æ•°æ®æŠ€æœ¯æ€»ç›‘**
- **è¿ç»´å·¥ç¨‹å¸ˆ** â†’ **æ•°æ®åº“è¿ç»´ç»ç†** â†’ **æŠ€æœ¯è¿ç»´æ€»ç›‘**

### ä¸“ä¸šé¢†åŸŸ
- **æ€§èƒ½ä¼˜åŒ–ä¸“å®¶**: ä¸“æ³¨äºæ•°æ®åº“æ€§èƒ½è°ƒä¼˜
- **é«˜å¯ç”¨æ¶æ„ä¸“å®¶**: ä¸“æ³¨äºæ•°æ®åº“é«˜å¯ç”¨è®¾è®¡
- **æ•°æ®å®‰å…¨ä¸“å®¶**: ä¸“æ³¨äºæ•°æ®å®‰å…¨å’Œåˆè§„

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [MySQLå®˜æ–¹æ–‡æ¡£](https://dev.mysql.com/doc/)
- [Rediså®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)

### æŠ€æœ¯ä¹¦ç±
- ã€Šé«˜æ€§èƒ½MySQLã€‹
- ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹
- ã€ŠSQLå¿…çŸ¥å¿…ä¼šã€‹
- ã€Šæ•°æ®åº“ç³»ç»Ÿå®ç°ã€‹

### æŠ€æœ¯åšå®¢
- MySQLå®˜æ–¹åšå®¢
- Perconaæ•°æ®åº“åšå®¢
- é˜¿é‡Œäº‘æ•°æ®åº“æŠ€æœ¯åšå®¢

### å¼€æºé¡¹ç›®
- [MySQL](https://github.com/mysql/mysql-server)
- [Redis](https://github.com/redis/redis)
- [PostgreSQL](https://github.com/postgres/postgres)

---

**æŠ€èƒ½æŒæ¡è®¤è¯**: å®Œæˆæ‰€æœ‰å®æˆ˜é¡¹ç›®å¹¶é€šè¿‡æ•°æ®åº“è®¾è®¡è¯„å®¡
**æŒç»­æ›´æ–°**: æ¯å­£åº¦æ›´æ–°å†…å®¹ä»¥è·Ÿè¿›æŠ€æœ¯å‘å±•
**ç¤¾åŒºæ”¯æŒ**: æä¾›æŠ€æœ¯å’¨è¯¢å’Œé¡¹ç›®æŒ‡å¯¼æœåŠ¡