# æ¶ˆè´¹æ¨¡å—ä¸šåŠ¡ä¸“å®¶
## Consume Module Business Specialist

**ğŸ¯ æŠ€èƒ½å®šä½**: IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šæ¶ˆè´¹æ¨¡å—ä¸šåŠ¡é€»è¾‘ä¸“å®¶ï¼Œç²¾é€šæ¶ˆè´¹ã€å……å€¼ã€é€€æ¬¾ç­‰æ ¸å¿ƒä¸šåŠ¡

**âš¡ æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… (é«˜çº§ä¸“å®¶)
**ğŸ¯ é€‚ç”¨åœºæ™¯**: æ¶ˆè´¹æ¨¡å—å¼€å‘ã€ä¸šåŠ¡é€»è¾‘ä¼˜åŒ–ã€æ”¯ä»˜é›†æˆã€æ•°æ®ç»Ÿè®¡
**ğŸ“Š æŠ€èƒ½è¦†ç›–**: è´¦æˆ·ç®¡ç† | æ¶ˆè´¹è®°å½• | å……å€¼é€€æ¬¾ | æ¶ˆè´¹æ¨¡å¼å¼•æ“ | æ•°æ®ç»Ÿè®¡ | æŠ¥è¡¨ç³»ç»Ÿ

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

### **æ ¸å¿ƒä¸“é•¿**
- **æ¶ˆè´¹ä¸šåŠ¡æ¶æ„**: æ·±åº¦ç†è§£æ¶ˆè´¹æ¨¡å—å››å±‚æ¶æ„å’Œä¸šåŠ¡æµç¨‹è®¾è®¡
- **æ”¯ä»˜ç³»ç»Ÿé›†æˆ**: å¤šç§æ”¯ä»˜æ–¹å¼é›†æˆå’Œæ”¯ä»˜å®‰å…¨å¤„ç†
- **æ¶ˆè´¹æ¨¡å¼å¼•æ“**: æ™ºèƒ½æ¶ˆè´¹æ¨¡å¼è®¾è®¡å’Œå®ç°
- **æ•°æ®ç»Ÿè®¡æŠ¥è¡¨**: æ¶ˆè´¹æ•°æ®åˆ†æå’Œå¯è§†åŒ–æŠ¥è¡¨ç³»ç»Ÿ
- **è´¦æˆ·èµ„é‡‘ç®¡ç†**: è´¦æˆ·å®‰å…¨ã€èµ„é‡‘æµè½¬å’Œä½™é¢ç®¡ç†
- **å¼‚å¸¸å¤„ç†æœºåˆ¶**: æ¶ˆè´¹å¼‚å¸¸å¤„ç†å’Œèµ„é‡‘å®‰å…¨ä¿éšœ

### **è§£å†³èƒ½åŠ›**
- **æ¶ˆè´¹ä¸šåŠ¡å¼€å‘**: è´¦æˆ·ç®¡ç†ã€æ¶ˆè´¹è®°å½•ã€å……å€¼é€€æ¬¾ç­‰æ ¸å¿ƒåŠŸèƒ½å¼€å‘
- **æ”¯ä»˜æµç¨‹ä¼˜åŒ–**: å¤šæ”¯ä»˜æ–¹å¼é›†æˆå’Œæ”¯ä»˜ä½“éªŒä¼˜åŒ–
- **æ¶ˆè´¹ç­–ç•¥è®¾è®¡**: æ™ºèƒ½æ¶ˆè´¹æ¨¡å¼æ¨èå’Œä¸ªæ€§åŒ–æ¶ˆè´¹ç­–ç•¥
- **æ•°æ®å®‰å…¨ä¿éšœ**: èµ„é‡‘å®‰å…¨å’Œæ•°æ®ä¸€è‡´æ€§ä¿éšœæœºåˆ¶
- **æ€§èƒ½ä¼˜åŒ–**: é«˜å¹¶å‘æ¶ˆè´¹åœºæ™¯æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥
- **ä¸šåŠ¡è§„åˆ™å¼•æ“**: å¯é…ç½®ä¸šåŠ¡è§„åˆ™å¼•æ“è®¾è®¡

---

## ğŸ› ï¸ æŠ€æœ¯èƒ½åŠ›çŸ©é˜µ

### **æ¶ˆè´¹ä¸šåŠ¡æ¨¡å—åˆ†æ**
```
ğŸ”´ æ ¸å¿ƒä¸šåŠ¡æ¨¡å— (å¿…é¡»æŒæ¡)
â”œâ”€â”€ è´¦æˆ·ç®¡ç† (Account Management)
â”‚   â”œâ”€â”€ è´¦æˆ·åˆ›å»ºå’Œè®¤è¯
â”‚   â”œâ”€â”€ ä½™é¢æŸ¥è¯¢å’Œå……å€¼
â”‚   â”œâ”€â”€ å†»ç»“å’Œè§£å†»æœºåˆ¶
â”‚   â””â”€â”€ è´¦æˆ·å®‰å…¨ç­–ç•¥
â”œâ”€â”€ æ¶ˆè´¹è®°å½• (Consumption Records)
â”‚   â”œâ”€â”€ æ¶ˆè´¹è®°å½•åˆ›å»º
â”‚   â”œâ”€â”€ æ¶ˆè´¹æ’¤é”€å’Œé€€æ¬¾
â”‚   â”œâ”€â”€ æ¶ˆè´¹ç»Ÿè®¡å’Œåˆ†æ
â”‚   â””â”€â”€ å¼‚å¸¸æ¶ˆè´¹å¤„ç†
â”œâ”€â”€ æ”¯ä»˜é›†æˆ (Payment Integration)
â”‚   â”œâ”€â”€ æ”¯ä»˜å®æ”¯ä»˜é›†æˆ
â”‚   â”œâ”€â”€ å¾®ä¿¡æ”¯ä»˜é›†æˆ
â”‚   â”œâ”€â”€ é“¶è¡Œå¡æ”¯ä»˜é›†æˆ
â”‚   â””â”€â”€ æ”¯ä»˜å®‰å…¨æœºåˆ¶
â””â”€â”€ æŠ¥è¡¨ç»Ÿè®¡ (Reporting Analytics)
    â”œâ”€â”€ æ¶ˆè´¹ç»Ÿè®¡æŠ¥è¡¨
    â”œâ”€â”€ èµ„é‡‘æµæ°´æŠ¥è¡¨
    â”œâ”€â”€ å¼‚å¸¸æ•°æ®åˆ†æ
    â””â”€â”€ ä¸šåŠ¡è¶‹åŠ¿åˆ†æ
```

### **é«˜é¢‘ä½¿ç”¨çš„æ ¸å¿ƒåŒ…**
```
net.lab1024.sa.admin.module.consume.          # æ¶ˆè´¹æ¨¡å—æ ¹åŒ…
â”œâ”€â”€ controller/                               # APIæ¥å£å±‚
â”‚   â”œâ”€â”€ AccountController.java               # è´¦æˆ·ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ ConsumeController.java               # æ¶ˆè´¹è®°å½•æ¥å£
â”‚   â”œâ”€â”€ RechargeController.java              # å……å€¼ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ RefundController.java                # é€€æ¬¾ç®¡ç†æ¥å£
â”‚   â””â”€â”€ AdvancedReportController.java        # é«˜çº§æŠ¥è¡¨æ¥å£
â”œâ”€â”€ service/                                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ RechargeService.java                 # å……å€¼ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ RefundService.java                   # é€€æ¬¾ä¸šåŠ¡æœåŠ¡
â”‚   â””â”€â”€ ReconciliationService.java            # å¯¹è´¦æœåŠ¡
â”œâ”€â”€ engine/                                   # æ¶ˆè´¹æ¨¡å¼å¼•æ“
â”‚   â”œâ”€â”€ mode/ConsumptionMode.java            # æ¶ˆè´¹æ¨¡å¼å®šä¹‰
â”‚   â”œâ”€â”€ mode/ConsumptionModeEngine.java      # æ¶ˆè´¹æ¨¡å¼å¼•æ“
â”‚   â””â”€â”€ strategy/                             # æ¶ˆè´¹ç­–ç•¥å®ç°
â””â”€â”€ domain/                                   # æ•°æ®æ¨¡å‹å±‚
    â”œâ”€â”€ entity/                               # å®ä½“ç±»
    â”œâ”€â”€ dto/                                  # æ•°æ®ä¼ è¾“å¯¹è±¡
    â””â”€â”€ vo/                                   # è§†å›¾å¯¹è±¡
```

---

## ğŸ”§ æ ¸å¿ƒå¼€å‘æŠ€èƒ½

### **1. è´¦æˆ·ç®¡ç†å¼€å‘**

#### **è´¦æˆ·åˆ›å»ºå’Œç®¡ç†**
```java
@RestController
@RequestMapping("/api/consume/account")
@Tag(name = "è´¦æˆ·ç®¡ç†", description = "æ¶ˆè´¹è´¦æˆ·ç›¸å…³æ“ä½œ")
@SaCheckPermission("consume:account")
public class AccountController {

    @Resource
    private AccountService accountService;

    @PostMapping("/create")
    @Operation(summary = "åˆ›å»ºæ¶ˆè´¹è´¦æˆ·")
    public ResponseDTO<String> createAccount(@RequestBody @Valid AccountCreateForm form) {
        // 1. å‚æ•°éªŒè¯
        validateAccountCreateForm(form);

        // 2. åˆ›å»ºè´¦æˆ·
        String accountId = accountService.createAccount(form);

        // 3. è¿”å›ç»“æœ
        return ResponseDTO.ok(accountId);
    }

    @PostMapping("/balance/query")
    @Operation(summary = "æŸ¥è¯¢è´¦æˆ·ä½™é¢")
    public ResponseDTO<AccountBalanceVO> queryBalance(@RequestBody @Valid AccountQueryForm form) {
        // åŸºäºç¼“å­˜æ¶æ„çš„ä½™é¢æŸ¥è¯¢
        AccountBalanceVO balance = accountService.queryBalanceWithCache(form.getUserId());
        return ResponseDTO.ok(balance);
    }

    @PostMapping("/freeze")
    @Operation(summary = "å†»ç»“è´¦æˆ·")
    @SaCheckPermission("consume:account:freeze")
    public ResponseDTO<String> freezeAccount(@RequestBody @Valid AccountFreezeForm form) {
        // å®‰å…¨çš„è´¦æˆ·å†»ç»“æ“ä½œ
        String result = accountService.freezeAccount(form.getUserId(), form.getReason());
        return ResponseDTO.ok(result);
    }
}
```

#### **è´¦æˆ·æœåŠ¡å®ç°**
```java
@Service
@Transactional(rollbackFor = Exception.class)
@Slf4j
public class AccountServiceImpl implements AccountService {

    @Resource
    private AccountDao accountDao;

    @Resource
    private UnifiedCacheService unifiedCacheService;

    @Resource
    private AccountSecurityManager securityManager;

    @Override
    public String createAccount(AccountCreateForm form) {
        log.info("å¼€å§‹åˆ›å»ºæ¶ˆè´¹è´¦æˆ·, userId: {}", form.getUserId());

        try {
            // 1. å®‰å…¨éªŒè¯
            securityManager.validateCreateAccount(form);

            // 2. æ£€æŸ¥è´¦æˆ·æ˜¯å¦å·²å­˜åœ¨
            if (accountDao.existsByUserId(form.getUserId())) {
                throw new BusinessException("ACCOUNT_EXISTS", "è´¦æˆ·å·²å­˜åœ¨");
            }

            // 3. åˆ›å»ºè´¦æˆ·å®ä½“
            AccountEntity entity = SmartBeanUtil.copy(form, AccountEntity.class);
            entity.setAccountNo(generateAccountNo());
            entity.setBalance(BigDecimal.ZERO);
            entity.setStatus(AccountStatus.ACTIVE.getCode());

            // 4. ä¿å­˜è´¦æˆ·
            accountDao.insert(entity);

            // 5. ç¼“å­˜è´¦æˆ·ä¿¡æ¯
            String cacheKey = entity.getUserId().toString();
            unifiedCacheService.set(
                CacheModule.CONSUME,
                "account",
                cacheKey,
                entity,
                BusinessDataType.ACCOUNT_INFO
            );

            log.info("æ¶ˆè´¹è´¦æˆ·åˆ›å»ºæˆåŠŸ, accountId: {}, accountNo: {}",
                    entity.getAccountId(), entity.getAccountNo());

            return entity.getAccountId();

        } catch (BusinessException e) {
            log.warn("åˆ›å»ºæ¶ˆè´¹è´¦æˆ·å¤±è´¥, userId: {}, error: {}", form.getUserId(), e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("åˆ›å»ºæ¶ˆè´¹è´¦æˆ·ç³»ç»Ÿå¼‚å¸¸, userId: {}", form.getUserId(), e);
            throw new BusinessException("SYSTEM_ERROR", "åˆ›å»ºè´¦æˆ·å¤±è´¥");
        }
    }

    @Override
    public AccountBalanceVO queryBalanceWithCache(Long userId) {
        String cacheKey = userId.toString();

        // ä½¿ç”¨ç¼“å­˜æ¶æ„æŸ¥è¯¢ä½™é¢
        return unifiedCacheService.getOrSet(
            CacheModule.CONSUME,
            "balance",
            cacheKey,
            () -> this.loadBalanceFromDatabase(userId),
            AccountBalanceVO.class,
            BusinessDataType.ACCOUNT_BALANCE  // 5åˆ†é’ŸTTLï¼Œå®æ—¶æ€§è¦æ±‚é«˜
        );
    }

    private AccountBalanceVO loadBalanceFromDatabase(Long userId) {
        AccountEntity account = accountDao.selectByUserId(userId);
        if (account == null) {
            throw new BusinessException("ACCOUNT_NOT_FOUND", "è´¦æˆ·ä¸å­˜åœ¨");
        }

        return AccountBalanceVO.builder()
                .userId(userId)
                .balance(account.getBalance())
                .frozenAmount(account.getFrozenAmount())
                .availableAmount(account.getBalance().subtract(account.getFrozenAmount()))
                .accountNo(account.getAccountNo())
                .build();
    }
}
```

### **2. æ¶ˆè´¹æ¨¡å¼å¼•æ“å¼€å‘**

#### **æ¶ˆè´¹æ¨¡å¼å¼•æ“å®ç°**
```java
@Component
@Slf4j
public class ConsumptionModeEngineImpl implements ConsumptionModeEngine {

    @Resource
    private UnifiedCacheService unifiedCacheService;

    @Resource
    private List<ConsumptionModeStrategy> strategies;

    @Resource
    private EnhancedCacheMetricsCollector metricsCollector;

    @Override
    public ConsumptionResult processConsumption(ConsumptionRequest request) {
        log.info("å¼€å§‹å¤„ç†æ¶ˆè´¹è¯·æ±‚, userId: {}, amount: {}",
                request.getUserId(), request.getAmount());

        try {
            // 1. è·å–æ¶ˆè´¹æ¨¡å¼
            ConsumptionMode mode = getConsumptionMode(request.getModeId());

            // 2. è·å–å¯¹åº”çš„ç­–ç•¥
            ConsumptionModeStrategy strategy = getStrategy(mode);

            // 3. æ‰§è¡Œæ¶ˆè´¹å¤„ç†
            ConsumptionResult result = strategy.process(request);

            // 4. è®°å½•æŒ‡æ ‡
            metricsCollector.recordConsumption(
                CacheModule.CONSUME,
                mode.getModeType(),
                request.getAmount(),
                result.isSuccess()
            );

            log.info("æ¶ˆè´¹å¤„ç†å®Œæˆ, userId: {}, result: {}",
                    request.getUserId(), result.getStatus());

            return result;

        } catch (Exception e) {
            log.error("æ¶ˆè´¹å¤„ç†å¼‚å¸¸, userId: {}, amount: {}",
                     request.getUserId(), request.getAmount(), e);

            // è®°å½•å¼‚å¸¸æŒ‡æ ‡
            metricsCollector.recordConsumptionError(
                CacheModule.CONSUME,
                request.getModeId(),
                e.getMessage()
            );

            return ConsumptionResult.failure("SYSTEM_ERROR", "æ¶ˆè´¹å¤„ç†å¤±è´¥");
        }
    }

    private ConsumptionMode getConsumptionMode(Long modeId) {
        String cacheKey = modeId.toString();

        // ä»ç¼“å­˜è·å–æ¶ˆè´¹æ¨¡å¼é…ç½®
        return unifiedCacheService.getOrSet(
            CacheModule.CONSUME,
            "mode",
            cacheKey,
            () -> loadConsumptionModeFromDatabase(modeId),
            ConsumptionMode.class,
            BusinessDataType.SYSTEM_CONFIG  // 60åˆ†é’ŸTTLï¼Œé…ç½®ç›¸å¯¹ç¨³å®š
        );
    }

    private ConsumptionModeStrategy getStrategy(ConsumptionMode mode) {
        return strategies.stream()
                .filter(strategy -> strategy.supports(mode.getModeType()))
                .findFirst()
                .orElseThrow(() -> new BusinessException("UNSUPPORTED_MODE",
                        "ä¸æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼: " + mode.getModeType()));
    }
}
```

### **3. æ”¯ä»˜é›†æˆå¼€å‘**

#### **å¤šæ”¯ä»˜æ–¹å¼é›†æˆ**
```java
@Service
@Slf4j
public class PaymentIntegrationService {

    @Resource
    private AlipayPaymentService alipayPaymentService;

    @Resource
    private WechatPaymentService wechatPaymentService;

    @Resource
    private BankCardPaymentService bankCardPaymentService;

    public PaymentResult processPayment(PaymentRequest request) {
        log.info("å¼€å§‹å¤„ç†æ”¯ä»˜è¯·æ±‚, userId: {}, amount: {}, type: {}",
                request.getUserId(), request.getAmount(), request.getPaymentType());

        try {
            // æ ¹æ®æ”¯ä»˜ç±»å‹é€‰æ‹©æœåŠ¡
            PaymentService paymentService = getPaymentService(request.getPaymentType());

            // æ‰§è¡Œæ”¯ä»˜
            PaymentResult result = paymentService.process(request);

            // å¼‚æ­¥é€šçŸ¥å¤„ç†
            if (result.isSuccess()) {
                handlePaymentSuccess(result);
            }

            return result;

        } catch (Exception e) {
            log.error("æ”¯ä»˜å¤„ç†å¼‚å¸¸, userId: {}, amount: {}",
                     request.getUserId(), request.getAmount(), e);

            // æ”¯ä»˜å¤±è´¥å¤„ç†
            handlePaymentFailure(request, e);

            return PaymentResult.failure("PAYMENT_ERROR", "æ”¯ä»˜å¤„ç†å¤±è´¥");
        }
    }

    private PaymentService getPaymentService(PaymentType paymentType) {
        switch (paymentType) {
            case ALIPAY:
                return alipayPaymentService;
            case WECHAT:
                return wechatPaymentService;
            case BANK_CARD:
                return bankCardPaymentService;
            default:
                throw new BusinessException("UNSUPPORTED_PAYMENT_TYPE",
                        "ä¸æ”¯æŒçš„æ”¯ä»˜ç±»å‹: " + paymentType);
        }
    }

    @Async
    private void handlePaymentSuccess(PaymentResult result) {
        // 1. æ›´æ–°è´¦æˆ·ä½™é¢
        accountService.updateBalanceAfterPayment(result);

        // 2. åˆ›å»ºæ¶ˆè´¹è®°å½•
        consumeService.createRecordAfterPayment(result);

        // 3. å‘é€é€šçŸ¥
        notificationService.sendPaymentSuccessNotification(result);

        // 4. æ¸…é™¤ç›¸å…³ç¼“å­˜
        cacheService.clearUserBalanceCache(result.getUserId());
    }
}
```

### **4. æŠ¥è¡¨ç»Ÿè®¡å¼€å‘**

#### **æ¶ˆè´¹æ•°æ®ç»Ÿè®¡æŠ¥è¡¨**
```java
@RestController
@RequestMapping("/api/consume/report")
@Tag(name = "æ¶ˆè´¹æŠ¥è¡¨", description = "æ¶ˆè´¹æ•°æ®ç»Ÿè®¡å’ŒæŠ¥è¡¨")
@SaCheckPermission("consume:report")
public class ConsumeReportController {

    @Resource
    private ConsumeReportService consumeReportService;

    @PostMapping("/daily")
    @Operation(summary = "æ—¥æ¶ˆè´¹æŠ¥è¡¨")
    public ResponseDTO<DailyConsumeReportVO> generateDailyReport(@RequestBody @Valid DailyReportQueryForm form) {
        DailyConsumeReportVO report = consumeReportService.generateDailyReport(form);
        return ResponseDTO.ok(report);
    }

    @PostMapping("/monthly/trend")
    @Operation(summary = "æœˆåº¦æ¶ˆè´¹è¶‹åŠ¿")
    public ResponseDTO<MonthlyTrendReportVO> generateMonthlyTrend(@RequestBody @Valid MonthlyTrendQueryForm form) {
        MonthlyTrendReportVO report = consumeReportService.generateMonthlyTrend(form);
        return ResponseDTO.ok(report);
    }

    @PostMapping("/top/users")
    @Operation(summary = "æ¶ˆè´¹æ’è¡Œæ¦œ")
    public ResponseDTO<TopUsersReportVO> generateTopUsersReport(@RequestBody @Valid TopUsersQueryForm form) {
        TopUsersReportVO report = consumeReportService.generateTopUsersReport(form);
        return ResponseDTO.ok(report);
    }
}
```

#### **æŠ¥è¡¨æœåŠ¡å®ç°**
```java
@Service
@Slf4j
public class ConsumeReportServiceImpl implements ConsumeReportService {

    @Resource
    private ConsumeRecordDao consumeRecordDao;

    @Resource
    private UnifiedCacheService unifiedCacheService;

    @Override
    public DailyConsumeReportVO generateDailyReport(DailyReportQueryForm form) {
        String cacheKey = String.format("%s_%s_%s",
                form.getReportDate(), form.getSceneType(), form.getDeviceType());

        // åŸºäºç¼“å­˜æ¶æ„çš„æŠ¥è¡¨æ•°æ®è·å–
        return unifiedCacheService.getOrSet(
            CacheModule.CONSUME,
            "report:daily",
            cacheKey,
            () -> this.generateDailyReportFromDatabase(form),
            DailyConsumeReportVO.class,
            BusinessDataType.REPORT_DATA  // 30åˆ†é’ŸTTLï¼ŒæŠ¥è¡¨æ•°æ®ç›¸å¯¹ç¨³å®š
        );
    }

    private DailyConsumeReportVO generateDailyReportFromDatabase(DailyReportQueryForm form) {
        // 1. æŸ¥è¯¢åŸºç¡€ç»Ÿè®¡æ•°æ®
        DailyConsumeStatistics statistics = consumeRecordDao.queryDailyStatistics(form);

        // 2. æŸ¥è¯¢æ—¶æ®µåˆ†å¸ƒ
        List<HourlyConsumeData> hourlyData = consumeRecordDao.queryHourlyDistribution(form);

        // 3. æŸ¥è¯¢åœºæ™¯åˆ†å¸ƒ
        List<SceneConsumeData> sceneData = consumeRecordDao.querySceneDistribution(form);

        // 4. æŸ¥è¯¢è®¾å¤‡ç±»å‹åˆ†å¸ƒ
        List<DeviceTypeConsumeData> deviceTypeData = consumeRecordDao.queryDeviceTypeDistribution(form);

        // 5. æ„å»ºæŠ¥è¡¨å¯¹è±¡
        return DailyConsumeReportVO.builder()
                .reportDate(form.getReportDate())
                .totalAmount(statistics.getTotalAmount())
                .totalCount(statistics.getTotalCount())
                .avgAmount(statistics.getAvgAmount())
                .hourlyData(hourlyData)
                .sceneData(sceneData)
                .deviceTypeData(deviceTypeData)
                .generatedTime(LocalDateTime.now())
                .build();
    }
}
```

---

## ğŸ” ä¸šåŠ¡è§„åˆ™å’Œæœ€ä½³å®è·µ

### **æ¶ˆè´¹ä¸šåŠ¡æ ¸å¿ƒè§„åˆ™**

#### **1. è´¦æˆ·å®‰å…¨è§„åˆ™**
```markdown
âœ… è´¦æˆ·åˆ›å»ºå¿…é¡»è¿›è¡Œå®åè®¤è¯éªŒè¯
âœ… è´¦æˆ·ä½™é¢å˜åŠ¨å¿…é¡»è®°å½•è¯¦ç»†æµæ°´
âœ… å¤§é¢æ¶ˆè´¹å¿…é¡»è¿›è¡ŒäºŒæ¬¡éªŒè¯
âœ… è´¦æˆ·å†»ç»“å¿…é¡»è®°å½•å†»ç»“åŸå› å’Œæ—¶é—´
âœ… è´¦æˆ·è§£å†»éœ€è¦æƒé™å®¡æ‰¹æµç¨‹
âŒ ç¦æ­¢ç›´æ¥ä¿®æ”¹è´¦æˆ·ä½™é¢
âŒ ç¦æ­¢è·³è¿‡ä½™é¢éªŒè¯è¿›è¡Œæ¶ˆè´¹
âŒ ç¦æ­¢æœªè®°å½•æµæ°´å°±è¿›è¡Œèµ„é‡‘æ“ä½œ
```

#### **2. æ¶ˆè´¹å¤„ç†è§„åˆ™**
```markdown
âœ… æ¶ˆè´¹å‰å¿…é¡»éªŒè¯è´¦æˆ·ä½™é¢å……è¶³
âœ… æ¶ˆè´¹é‡‘é¢å¿…é¡»è¿›è¡Œåˆç†æ€§éªŒè¯
âœ… æ¶ˆè´¹è®°å½•å¿…é¡»åŒ…å«å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯
âœ… æ¶ˆè´¹æ’¤é”€å¿…é¡»åœ¨è§„å®šæ—¶é—´å†…è¿›è¡Œ
âœ… å¼‚å¸¸æ¶ˆè´¹å¿…é¡»è§¦å‘å®‰å…¨å‘Šè­¦
âŒ ç¦æ­¢é‡å¤å¤„ç†åŒä¸€ç¬”æ¶ˆè´¹
âŒ ç¦æ­¢è·³è¿‡ä½™é¢æ£€æŸ¥ç›´æ¥æ‰£æ¬¾
âŒ ç¦æ­¢æœªéªŒè¯æ¶ˆè´¹é™é¢å°±è¿›è¡Œå¤„ç†
```

#### **3. æ”¯ä»˜å®‰å…¨è§„åˆ™**
```markdown
âœ… æ”¯ä»˜è¯·æ±‚å¿…é¡»è¿›è¡Œé˜²é‡æ”¾å¤„ç†
âœ… æ”¯ä»˜å›è°ƒå¿…é¡»éªŒè¯ç­¾åçœŸå®æ€§
âœ… æ”¯ä»˜é‡‘é¢å¿…é¡»ä¸è®¢å•é‡‘é¢ä¸€è‡´
âœ… æ”¯ä»˜æˆåŠŸå¿…é¡»åŸå­æ€§æ›´æ–°è®¢å•çŠ¶æ€
âœ… æ”¯ä»˜å¤±è´¥å¿…é¡»é‡Šæ”¾é¢„æ‰£æ¬¾é¡¹
âŒ ç¦æ­¢æœªéªŒè¯ç­¾åå°±å¤„ç†æ”¯ä»˜å›è°ƒ
âŒ ç¦æ­¢é‡å¤å¤„ç†æ”¯ä»˜æˆåŠŸé€šçŸ¥
âŒ ç¦æ­¢æ”¯ä»˜é‡‘é¢ä¸è®¢å•é‡‘é¢ä¸ä¸€è‡´
```

### **æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ**

#### **1. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**
```java
// âœ… æ¨èï¼šå¤šçº§ç¼“å­˜ç­–ç•¥
public AccountBalanceVO queryBalance(Long userId) {
    // L1: æœ¬åœ°ç¼“å­˜ (1åˆ†é’Ÿ)
    AccountBalanceVO localCache = localCacheManager.get("balance:" + userId);
    if (localCache != null) {
        return localCache;
    }

    // L2: Redisç¼“å­˜ (5åˆ†é’Ÿ)
    return unifiedCacheService.getOrSet(
        CacheModule.CONSUME, "balance", userId.toString(),
        () -> loadBalanceFromDatabase(userId),
        AccountBalanceVO.class,
        BusinessDataType.ACCOUNT_BALANCE
    );
}

// âœ… æ¨èï¼šæ‰¹é‡æ“ä½œä¼˜åŒ–
public void batchUpdateBalances(List<BalanceUpdateRequest> requests) {
    // æ‰¹é‡å¤„ç†å‡å°‘æ•°æ®åº“äº¤äº’
    Map<Long, BigDecimal> balanceUpdates = requests.stream()
        .collect(Collectors.toMap(
            BalanceUpdateRequest::getUserId,
            BalanceUpdateRequest::getAmount,
            (existing, replacement) -> existing.add(replacement)
        ));

    // æ‰¹é‡æ›´æ–°æ•°æ®åº“
    accountDao.batchUpdateBalances(balanceUpdates);

    // æ‰¹é‡æ¸…é™¤ç¼“å­˜
    unifiedCacheService.mDelete(CacheModule.CONSUME, "balance",
            balanceUpdates.keySet().stream()
                .map(Object::toString)
                .collect(Collectors.toList()));
}
```

#### **2. æ•°æ®åº“ä¼˜åŒ–**
```sql
-- âœ… æ¨èï¼šè´¦æˆ·è¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_account_user_id ON t_consume_account(user_id);
CREATE INDEX idx_account_status ON t_consume_account(status);
CREATE INDEX idx_account_create_time ON t_consume_account(create_time);

-- âœ… æ¨èï¼šæ¶ˆè´¹è®°å½•è¡¨åˆ†åŒºä¼˜åŒ–
-- æŒ‰æœˆåˆ†åŒºæé«˜æŸ¥è¯¢æ€§èƒ½
ALTER TABLE t_consume_record PARTITION BY RANGE (YEAR(consume_time) * 100 + MONTH(consume_time)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    -- ... æ›´å¤šåˆ†åŒº
    PARTITION p_max VALUES LESS THAN MAXVALUE
);
```

---

## ğŸ“Š ä¸šåŠ¡ç›‘æ§å’Œå‘Šè­¦

### **å…³é”®ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§**

#### **1. å®æ—¶ç›‘æ§æŒ‡æ ‡**
```java
@Component
@Slf4j
public class ConsumeMetricsCollector {

    private final MeterRegistry meterRegistry;

    public ConsumeMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }

    // æ¶ˆè´¹äº¤æ˜“è®¡æ•°å™¨
    public void recordConsumption(String modeType, BigDecimal amount, boolean success) {
        Counter.builder("consume.transactions")
                .tag("mode", modeType)
                .tag("status", success ? "success" : "failure")
                .register(meterRegistry)
                .increment();

        // æ¶ˆè´¹é‡‘é¢ç»Ÿè®¡
        if (success) {
            DistributionSummary.builder("consume.amount")
                    .tag("mode", modeType)
                    .register(meterRegistry)
                    .record(amount.doubleValue());
        }
    }

    // è´¦æˆ·ä½™é¢ç›‘æ§
    public void recordBalanceChange(Long userId, BigDecimal oldBalance, BigDecimal newBalance) {
        Gauge.builder("consume.account.balance")
                .tag("user_id", userId.toString())
                .register(meterRegistry, () -> newBalance.doubleValue());
    }

    // æ”¯ä»˜æˆåŠŸç‡ç›‘æ§
    public void recordPaymentSuccess(String paymentType, long responseTime) {
        Counter.builder("consume.payment.success")
                .tag("type", paymentType)
                .register(meterRegistry)
                .increment();

        Timer.builder("consume.payment.response_time")
                .tag("type", paymentType)
                .register(meterRegistry)
                .record(responseTime, TimeUnit.MILLISECONDS);
    }
}
```

#### **2. ä¸šåŠ¡å‘Šè­¦é…ç½®**
```yaml
# æ¶ˆè´¹ä¸šåŠ¡å‘Šè­¦è§„åˆ™
consume_alerts:
  # äº¤æ˜“å¤±è´¥ç‡å‘Šè­¦
  transaction_failure_rate:
    threshold: 5%  # å¤±è´¥ç‡è¶…è¿‡5%è§¦å‘å‘Šè­¦
    window: 5m    # 5åˆ†é’Ÿçª—å£
    severity: high

  # å¹³å‡å“åº”æ—¶é—´å‘Šè­¦
  avg_response_time:
    threshold: 500ms  # å¹³å‡å“åº”æ—¶é—´è¶…è¿‡500ms
    window: 1m        # 1åˆ†é’Ÿçª—å£
    severity: medium

  # è´¦æˆ·ä½™é¢å¼‚å¸¸å‘Šè­¦
  balance_anomaly:
    threshold: -1000  # è´¦æˆ·ä½™é¢ä½äº-1000è§¦å‘å‘Šè­¦
    severity: critical

  # å¤§é¢äº¤æ˜“å‘Šè­¦
  large_transaction:
    threshold: 10000  # å•ç¬”äº¤æ˜“è¶…è¿‡10000å…ƒè§¦å‘å‘Šè­¦
    severity: high
```

---

## ğŸš¨ å¼‚å¸¸å¤„ç†å’Œå®¹é”™æœºåˆ¶

### **æ¶ˆè´¹å¼‚å¸¸å¤„ç†ç­–ç•¥**

#### **1. èµ„é‡‘å®‰å…¨ä¿éšœ**
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class SafeConsumeService {

    @Resource
    private AccountLockService accountLockService;

    public ConsumptionResult safeProcessConsumption(ConsumptionRequest request) {
        // 1. è·å–åˆ†å¸ƒå¼é”
        String lockKey = "consume:lock:" + request.getUserId();
        if (!accountLockService.tryLock(lockKey, 30, TimeUnit.SECONDS)) {
            throw new BusinessException("CONCURRENT_CONSUME", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }

        try {
            // 2. ä½™é¢é¢„æ£€æŸ¥
            AccountEntity account = accountDao.selectByUserIdForUpdate(request.getUserId());
            if (account.getBalance().compareTo(request.getAmount()) < 0) {
                throw new BusinessException("INSUFFICIENT_BALANCE", "è´¦æˆ·ä½™é¢ä¸è¶³");
            }

            // 3. é¢„æ‰£ä½™é¢ï¼ˆå†»ç»“ï¼‰
            BigDecimal frozenAmount = account.getFrozenAmount().add(request.getAmount());
            account.setFrozenAmount(frozenAmount);
            accountDao.update(account);

            // 4. å¤„ç†æ¶ˆè´¹é€»è¾‘
            ConsumptionResult result = processConsumptionLogic(request);

            // 5. æ ¹æ®ç»“æœå¤„ç†ä½™é¢
            if (result.isSuccess()) {
                // æˆåŠŸï¼šæ‰£å‡ä½™é¢ï¼Œé‡Šæ”¾å†»ç»“é‡‘é¢
                account.setBalance(account.getBalance().subtract(request.getAmount()));
                account.setFrozenAmount(account.getFrozenAmount().subtract(request.getAmount()));
            } else {
                // å¤±è´¥ï¼šé‡Šæ”¾å†»ç»“é‡‘é¢
                account.setFrozenAmount(account.getFrozenAmount().subtract(request.getAmount()));
            }

            accountDao.update(account);
            return result;

        } finally {
            // 6. é‡Šæ”¾åˆ†å¸ƒå¼é”
            accountLockService.unlock(lockKey);
        }
    }
}
```

#### **2. æ”¯ä»˜é‡è¯•æœºåˆ¶**
```java
@Component
@Slf4j
public class PaymentRetryService {

    @Retryable(
        value = {PaymentTransientException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public PaymentResult processPaymentWithRetry(PaymentRequest request) {
        try {
            return paymentService.process(request);
        } catch (PaymentTransientException e) {
            log.warn("æ”¯ä»˜å¤„ç†æš‚æ—¶å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•, requestId: {}, error: {}",
                    request.getRequestId(), e.getMessage());
            throw e;  // è§¦å‘é‡è¯•
        } catch (Exception e) {
            log.error("æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œä¸å†é‡è¯•, requestId: {}", request.getRequestId(), e);
            return PaymentResult.failure("PAYMENT_FAILED", "æ”¯ä»˜å¤„ç†å¤±è´¥");
        }
    }

    @Recover
    public PaymentResult recover(PaymentTransientException ex, PaymentRequest request) {
        log.error("æ”¯ä»˜é‡è¯•æ¬¡æ•°è€—å°½, requestId: {}, final error: {}",
                request.getRequestId(), ex.getMessage());

        // 1. æ ‡è®°æ”¯ä»˜å¤±è´¥
        paymentRecordService.markAsFailed(request.getRequestId(), ex.getMessage());

        // 2. å‘é€å‘Šè­¦é€šçŸ¥
        alertService.sendPaymentFailureAlert(request, ex);

        return PaymentResult.failure("PAYMENT_TIMEOUT", "æ”¯ä»˜å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

---

## ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•

### **åŠŸèƒ½å¼€å‘æ£€æŸ¥**
- [ ] è´¦æˆ·åˆ›å»ºæ˜¯å¦åŒ…å«å®‰å…¨éªŒè¯ï¼Ÿ
- [ ] æ¶ˆè´¹å¤„ç†æ˜¯å¦éªŒè¯ä½™é¢å……è¶³ï¼Ÿ
- [ ] æ”¯ä»˜é›†æˆæ˜¯å¦åŒ…å«é˜²é‡æ”¾æœºåˆ¶ï¼Ÿ
- [ ] èµ„é‡‘æ“ä½œæ˜¯å¦è®°å½•å®Œæ•´æµæ°´ï¼Ÿ
- [ ] å¼‚å¸¸åœºæ™¯æ˜¯å¦è€ƒè™‘å‘¨å…¨ï¼Ÿ

### **æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥**
- [ ] é«˜é¢‘æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ
- [ ] æ‰¹é‡æ“ä½œæ˜¯å¦ä¼˜åŒ–æ•°æ®åº“äº¤äº’ï¼Ÿ
- [ ] æ•°æ®åº“è¡¨æ˜¯å¦æœ‰åˆé€‚ç´¢å¼•ï¼Ÿ
- [ ] åˆ†é¡µæŸ¥è¯¢æ˜¯å¦æ€§èƒ½ä¼˜åŒ–ï¼Ÿ
- [ ] å®šæ—¶ä»»åŠ¡æ˜¯å¦é¿å…æ€§èƒ½å³°å€¼ï¼Ÿ

### **å®‰å…¨ä¿éšœæ£€æŸ¥**
- [ ] æ•æ„Ÿæ“ä½œæ˜¯å¦æœ‰æƒé™æ§åˆ¶ï¼Ÿ
- [ ] èµ„é‡‘æ“ä½œæ˜¯å¦æœ‰å®¡è®¡æ—¥å¿—ï¼Ÿ
- [ ] æ”¯ä»˜æµç¨‹æ˜¯å¦æœ‰ç­¾åéªŒè¯ï¼Ÿ
- [ ] å¼‚å¸¸æƒ…å†µæ˜¯å¦æœ‰å‘Šè­¦æœºåˆ¶ï¼Ÿ
- [ ] æ•°æ®ä¼ è¾“æ˜¯å¦æœ‰åŠ å¯†ä¿æŠ¤ï¼Ÿ

### **æµ‹è¯•éªŒè¯æ£€æŸ¥**
- [ ] æ­£å¸¸æµç¨‹æ˜¯å¦è¦†ç›–ï¼Ÿ
- [ ] å¼‚å¸¸åœºæ™¯æ˜¯å¦æµ‹è¯•ï¼Ÿ
- [ ] è¾¹ç•Œæ¡ä»¶æ˜¯å¦éªŒè¯ï¼Ÿ
- [ ] æ€§èƒ½æŒ‡æ ‡æ˜¯å¦è¾¾æ ‡ï¼Ÿ
- [ ] å®‰å…¨æ¼æ´æ˜¯å¦æ‰«æï¼Ÿ

---

## ğŸ“ æ”¯æŒå’Œåä½œ

### **æŠ€æœ¯æ”¯æŒ**
- **æŠ€æœ¯å’¨è¯¢**: consume-module-technical@company.com
- **ä¸šåŠ¡å’¨è¯¢**: consume-module-business@company.com
- **ç´§æ€¥æ”¯æŒ**: 24å°æ—¶æŠ€æœ¯çƒ­çº¿

### **å›¢é˜Ÿåä½œ**
- **å¼€å‘å›¢é˜Ÿ**: æ¶ˆè´¹æ¨¡å—å¼€å‘ç»„
- **æµ‹è¯•å›¢é˜Ÿ**: æ¶ˆè´¹ä¸šåŠ¡æµ‹è¯•ç»„
- **è¿ç»´å›¢é˜Ÿ**: æ”¯ä»˜ç³»ç»Ÿè¿ç»´ç»„
- **äº§å“å›¢é˜Ÿ**: æ¶ˆè´¹äº§å“ç»„

---

**æŒæ¡æ­¤æŠ€èƒ½ï¼Œæ‚¨å°†æˆä¸ºæ¶ˆè´¹æ¨¡å—ä¸šåŠ¡ä¸“å®¶ï¼Œèƒ½å¤Ÿç‹¬ç«‹è®¾è®¡ã€å¼€å‘å’Œä¼˜åŒ–ä¼ä¸šçº§æ¶ˆè´¹ç³»ç»Ÿï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨å’Œä¸šåŠ¡è¿ç»­æ€§ã€‚**