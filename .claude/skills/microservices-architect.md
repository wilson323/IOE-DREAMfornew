# ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„å¸ˆæŠ€èƒ½

## æŠ€èƒ½ä¿¡æ¯

**æŠ€èƒ½åç§°**: å¾®æœåŠ¡æ¶æ„å¸ˆ (Microservices Architect)
**æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… é«˜çº§
**é€‚ç”¨è§’è‰²**: æŠ€æœ¯æ¶æ„å¸ˆã€ç³»ç»Ÿæ¶æ„å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº
**å‰ç½®æŠ€èƒ½**: Spring Bootä¼ä¸šçº§å¼€å‘ã€é¢†åŸŸé©±åŠ¨è®¾è®¡ã€APIè®¾è®¡
**é¢„è®¡å­¦æ—¶**: 60å°æ—¶
**æŠ€èƒ½è®¤è¯**: IOE-DREAMå¾®æœåŠ¡æ¶æ„å¸ˆè®¤è¯

---

## ğŸ¯ æŠ€èƒ½æ¦‚è¿°

å¾®æœåŠ¡æ¶æ„å¸ˆä¸“æ³¨äºè®¾è®¡å’Œå®ç°å¤§è§„æ¨¡ã€é«˜å¯ç”¨çš„å¾®æœåŠ¡æ¶æ„ç³»ç»Ÿã€‚è¯¥æŠ€èƒ½æ¶µç›–äº†ä»å•ä½“åº”ç”¨åˆ°å¾®æœåŠ¡çš„å®Œæ•´è½¬å‹è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æœåŠ¡æ‹†åˆ†ã€APIè®¾è®¡ã€æ•°æ®ä¸€è‡´æ€§ã€æœåŠ¡æ²»ç†ç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚

## ğŸ“š çŸ¥è¯†è¦æ±‚

### ç†è®ºçŸ¥è¯†

#### ğŸ›ï¸ å¾®æœåŠ¡æ¶æ„åŸç†
- **å¾®æœåŠ¡å®šä¹‰ä¸ç‰¹å¾**
- **å¾®æœåŠ¡vså•ä½“æ¶æ„å¯¹æ¯”åˆ†æ**
- **æœåŠ¡æ‹†åˆ†åŸåˆ™ä¸æ–¹æ³•è®º**
- **é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)åœ¨å¾®æœåŠ¡ä¸­çš„åº”ç”¨**
- **CAPç†è®ºå’ŒBASEç†è®º**
- **åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ¨¡å¼**

#### ğŸ”§ æ¶æ„è®¾è®¡æ¨¡å¼
- **APIç½‘å…³æ¨¡å¼**
- **æœåŠ¡å‘ç°æ¨¡å¼**
- **æ–­è·¯å™¨æ¨¡å¼**
- **æœåŠ¡ç¼–æ’vsæœåŠ¡ç¼–æ’**
- **CQRS(å‘½ä»¤æŸ¥è¯¢è´£ä»»åˆ†ç¦»)**
- **äº‹ä»¶é©±åŠ¨æ¶æ„**
- **Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼**

#### ğŸ“Š æ•°æ®æ¶æ„
- **æ•°æ®åº“æ‹†åˆ†ç­–ç•¥**
- **è¯»å†™åˆ†ç¦»è®¾è®¡**
- **åˆ†åº“åˆ†è¡¨è®¾è®¡**
- **æ•°æ®ä¸€è‡´æ€§æ¨¡å‹**
- **äº‹ä»¶å­˜å‚¨æ¨¡å¼**
- **ç¼“å­˜æ¶æ„è®¾è®¡**

### ä¸šåŠ¡ç†è§£

#### ğŸ’¼ IOE-DREAMä¸šåŠ¡é¢†åŸŸ
- **æ¶ˆè´¹ç³»ç»Ÿ**: è´¦æˆ·ç®¡ç†ã€ä½™é¢æ§åˆ¶ã€æ¶ˆè´¹è®°å½•
- **é—¨ç¦ç³»ç»Ÿ**: æƒé™ç®¡ç†ã€è®¾å¤‡æ§åˆ¶ã€é€šè¡Œè®°å½•
- **è€ƒå‹¤ç³»ç»Ÿ**: æ’ç­ç®¡ç†ã€è€ƒå‹¤è§„åˆ™ã€ç»Ÿè®¡æŠ¥è¡¨
- **ç›‘æ§ç³»ç»Ÿ**: è§†é¢‘åˆ†æã€è®¾å¤‡ç®¡ç†ã€å‘Šè­¦ç³»ç»Ÿ
- **ç³»ç»Ÿç®¡ç†**: ç”¨æˆ·ç®¡ç†ã€è§’è‰²æƒé™ã€é…ç½®ç®¡ç†

#### ğŸ¢ ä¸šåŠ¡è¾¹ç•Œè¯†åˆ«
- **ä¸šåŠ¡èƒ½åŠ›åœ°å›¾ç»˜åˆ¶**
- **é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†**
- **ä¸šåŠ¡æµç¨‹åˆ†æ**
- **æ•°æ®æ‰€æœ‰æƒè¯†åˆ«**
- **æœåŠ¡ä¾èµ–å…³ç³»åˆ†æ**

### æŠ€æœ¯èƒŒæ™¯

#### ğŸ”¨ æŠ€æœ¯æ ˆè¦æ±‚
- **Spring Boot 3.x** (ç²¾é€š)
- **Spring Cloud** (ç†Ÿæ‚‰)
- **Docker & Kubernetes** (ç†Ÿæ‚‰)
- **APIè®¾è®¡å·¥å…·** (Swagger/OpenAPI)
- **æ¶ˆæ¯é˜Ÿåˆ—** (RabbitMQ/Kafka)
- **æ•°æ®åº“** (MySQL, Redis, MongoDB)
- **ç›‘æ§å·¥å…·** (Prometheus, Grafana)

#### ğŸ¯ è®¾è®¡åŸåˆ™
- **SOLIDè®¾è®¡åŸåˆ™**
- **DRYåŸåˆ™**
- **KISSåŸåˆ™**
- **YAGNIåŸåˆ™**
- **APIä¼˜å…ˆè®¾è®¡åŸåˆ™**

---

## ğŸ› ï¸ æ“ä½œæŠ€èƒ½

### 1. IOE-DREAMå¾®æœåŠ¡æ¶æ„è®¾è®¡

#### æœåŠ¡æ‹†åˆ†æœ€ä½³å®è·µ
```java
/**
 * IOE-DREAMå¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥ - åŸºäºå®é™…é¡¹ç›®ç»éªŒ
 */
@Component
public class IOEDreamServiceDecomposition {

    /**
     * åŸºäºä¸šåŠ¡åŸŸçš„æœåŠ¡æ‹†åˆ†
     * éµå¾ªDDDé™ç•Œä¸Šä¸‹æ–‡åŸåˆ™ï¼Œç¡®ä¿æœåŠ¡è¾¹ç•Œæ¸…æ™°
     */
    public Map<String, ServiceBoundary> decomposeByBusinessDomain() {
        Map<String, ServiceBoundary> services = new HashMap<>();

        // è®¤è¯æœåŠ¡ - å¤„ç†ç”¨æˆ·èº«ä»½éªŒè¯å’Œæˆæƒ
        services.put("ioedream-auth-service", ServiceBoundary.builder()
            .serviceName("ioedream-auth-service")
            .domain("Authentication")
            .capabilities(List.of("ç”¨æˆ·è®¤è¯", "JWT Tokenç®¡ç†", "æƒé™éªŒè¯"))
            .dataOwnership(Set.of("t_user_credential", "t_token_store"))
            .port(8081)
            .responsibility("ç”¨æˆ·èº«ä»½å®‰å…¨")
            .build());

        // èº«ä»½ç®¡ç†æœåŠ¡ - ç®¡ç†ç”¨æˆ·ã€è§’è‰²ã€æƒé™
        services.put("ioedream-identity-service", ServiceBoundary.builder()
            .serviceName("ioedream-identity-service")
            .domain("Identity Management")
            .capabilities(List.of("ç”¨æˆ·ç®¡ç†", "è§’è‰²ç®¡ç†", "æƒé™ç®¡ç†", "éƒ¨é—¨ç®¡ç†"))
            .dataOwnership(Set.of("t_user_info", "t_role_info", "t_permission_info", "t_department_info"))
            .port(8082)
            .responsibility("èº«ä»½ä¿¡æ¯ç®¡ç†")
            .build());

        // è®¾å¤‡ç®¡ç†æœåŠ¡ - ç®¡ç†IoTè®¾å¤‡
        services.put("ioedream-device-service", ServiceBoundary.builder()
            .serviceName("ioedream-device-service")
            .domain("Device Management")
            .capabilities(List.of("è®¾å¤‡æ³¨å†Œ", "è®¾å¤‡ç›‘æ§", "è®¾å¤‡é…ç½®", "è®¾å¤‡ç»´æŠ¤"))
            .dataOwnership(Set.of("t_device_info", "t_device_status_log", "t_device_config"))
            .port(8101)
            .responsibility("è®¾å¤‡ç”Ÿå‘½å‘¨æœŸç®¡ç†")
            .build());

        // é—¨ç¦æœåŠ¡ - å¤„ç†é—¨ç¦æ§åˆ¶é€»è¾‘
        services.put("ioedream-access-service", ServiceBoundary.builder()
            .serviceName("ioedream-access-service")
            .domain("Access Control")
            .capabilities(List.of("é—¨ç¦æ§åˆ¶", "ç”Ÿç‰©è¯†åˆ«", "åŒºåŸŸæƒé™", "é€šè¡Œè®°å½•"))
            .dataOwnership(Set.of("t_access_record", "t_biometric_info", "t_area_permission"))
            .dependencies(Set.of("ioedream-device-service", "ioedream-identity-service"))
            .port(8102)
            .responsibility("é—¨ç¦å®‰å…¨æ§åˆ¶")
            .build());

        // æ¶ˆè´¹æœåŠ¡ - å¤„ç†ä¸€å¡é€šæ¶ˆè´¹ä¸šåŠ¡
        services.put("ioedream-consume-service", ServiceBoundary.builder()
            .serviceName("ioedream-consume-service")
            .domain("Consumption")
            .capabilities(List.of("è´¦æˆ·ç®¡ç†", "æ¶ˆè´¹è®°å½•", "å……å€¼ç®¡ç†", "ç»Ÿè®¡åˆ†æ", "å¼‚å¸¸æ£€æµ‹"))
            .dataOwnership(Set.of("t_account_info", "t_consume_record", "t_recharge_record", "t_consume_mode"))
            .dependencies(Set.of("ioedream-auth-service", "ioedream-notification-service"))
            .port(8103)
            .responsibility("æ¶ˆè´¹ä¸šåŠ¡å¤„ç†")
            .build());

        // è®¿å®¢æœåŠ¡ - ç®¡ç†è®¿å®¢é¢„çº¦å’Œé€šè¡Œ
        services.put("ioedream-visitor-service", ServiceBoundary.builder()
            .serviceName("ioedream-visitor-service")
            .domain("Visitor Management")
            .capabilities(List.of("è®¿å®¢é¢„çº¦", "è®¿å®¢å®¡æ‰¹", "è®¿å®¢ç®¡ç†", "è®¿å®¢è®°å½•"))
            .dataOwnership(Set.of("t_visitor_info", "t_visit_appointment", "t_visit_record", "t_visitor_approval"))
            .dependencies(Set.of("ioedream-access-service", "ioedream-identity-service"))
            .port(8104)
            .responsibility("è®¿å®¢ä¸šåŠ¡æµç¨‹")
            .build());

        // è€ƒå‹¤æœåŠ¡ - å¤„ç†å‘˜å·¥è€ƒå‹¤ä¸šåŠ¡
        services.put("ioedream-attendance-service", ServiceBoundary.builder()
            .serviceName("ioedream-attendance-service")
            .domain("Attendance Management")
            .capabilities(List.of("è€ƒå‹¤è®°å½•", "æ’ç­ç®¡ç†", "è€ƒå‹¤ç»Ÿè®¡", "å¼‚å¸¸å¤„ç†"))
            .dataOwnership(Set.of("t_attendance_record", "t_work_schedule", "t_attendance_rule", "t_attendance_statistics"))
            .dependencies(Set.of("ioedream-identity-service", "ioedream-device-service"))
            .port(8105)
            .responsibility("è€ƒå‹¤ä¸šåŠ¡ç®¡ç†")
            .build());

        // è§†é¢‘æœåŠ¡ - å¤„ç†è§†é¢‘ç›‘æ§å’Œåˆ†æ
        services.put("ioedream-video-service", ServiceBoundary.builder()
            .serviceName("ioedream-video-service")
            .domain("Video Surveillance")
            .capabilities(List.of("è§†é¢‘æµç®¡ç†", "å½•åƒå­˜å‚¨", "æ™ºèƒ½åˆ†æ", "å‘Šè­¦è”åŠ¨"))
            .dataOwnership(Set.of("t_video_device", "t_video_record", "t_video_analysis", "t_video_alert"))
            .dependencies(Set.of("ioedream-device-service", "ioedream-file-service"))
            .port(8106)
            .responsibility("è§†é¢‘ç›‘æ§ç®¡ç†")
            .build());

        return services;
    }

    /**
     * æœåŠ¡è€¦åˆåº¦åˆ†æ - é¿å…è¿‡åº¦è€¦åˆ
     */
    public CouplingAnalysisResult analyzeCoupling() {
        return CouplingAnalysisResult.builder()
            .highCouplingPairs(List.of(
                // é«˜è€¦åˆéœ€è¦ç‰¹åˆ«å…³æ³¨
                "ioedream-access-service -> ioedream-device-service",
                "ioedream-consume-service -> ioedream-auth-service"
            ))
            .recommendedDecoupling(List.of(
                "ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„é™ä½åŒæ­¥è€¦åˆ",
                "å¼•å…¥APIç½‘å…³ç»Ÿä¸€æœåŠ¡è°ƒç”¨",
                "å®ç°ç¼“å­˜æœºåˆ¶å‡å°‘ç›´æ¥ä¾èµ–"
            ))
            .couplingScore(0.65) // è€¦åˆåº¦è¯„åˆ†ï¼ˆ0-1ï¼Œè¶Šä½è¶Šå¥½ï¼‰
            .build();
    }
}
```

#### å¾®æœåŠ¡æ¶æ„æ¨¡å¼åº”ç”¨
```java
/**
 * IOE-DREAMå¾®æœåŠ¡æ¶æ„æ¨¡å¼å®ç°
 */
@Configuration
public class IOEDreamMicroservicePatterns {

    /**
     * APIç½‘å…³æ¨¡å¼ - ç»Ÿä¸€å…¥å£
     */
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            .route("auth-service", r -> r.path("/api/auth/**")
                .uri("lb://ioedream-auth-service:8081"))
            .route("identity-service", r -> r.path("/api/identity/**")
                .uri("lb://ioedream-identity-service:8082"))
            .route("device-service", r -> r.path("/api/device/**")
                .uri("lb://ioedream-device-service:8101"))
            .route("access-service", r -> r.path("/api/access/**")
                .uri("lb://ioedream-access-service:8102"))
            .route("consume-service", r -> r.path("/api/consume/**")
                .uri("lb://ioedream-consume-service:8103"))
            .route("visitor-service", r -> r.path("/api/visitor/**")
                .uri("lb://ioedream-visitor-service:8104"))
            .route("attendance-service", r -> r.path("/api/attendance/**")
                .uri("lb://ioedream-attendance-service:8105"))
            .route("video-service", r -> r.path("/api/video/**")
                .uri("lb://ioedream-video-service:8106"))
            .build();
    }

    /**
     * æœåŠ¡å‘ç°ä¸æ³¨å†Œ - Consulé›†æˆ
     */
    @Bean
    public ConsulProperties consulProperties() {
        ConsulProperties properties = new ConsulProperties();
        properties.setHost("consul.service.consul");
        properties.setPort(8500);
        properties.setDiscovery(new ConsulDiscoveryProperties());
        properties.getDiscovery().setServiceName("ioe-dream-gateway");
        properties.getDiscovery().setHealthCheckPath("/actuator/health");
        properties.getDiscovery().setHealthCheckInterval("10s");
        properties.getDiscovery().setRegister(true);
        return properties;
    }

    /**
     * ç†”æ–­å™¨æ¨¡å¼ - åŸºäºResilience4j
     */
    @Bean
    public CircuitBreakerFactory<?> circuitBreakerFactory() {
        return new CustomCircuitBreakerFactory();
    }

    static class CustomCircuitBreakerFactory extends CircuitBreakerFactoryBean {
        @Override
        public CircuitBreaker create(String id) {
            CircuitBreakerConfig config = CircuitBreakerConfig.custom()
                .failureRateThreshold(50)
                .waitDurationInOpenState(Duration.ofSeconds(30))
                .slidingWindowSize(10)
                .minimumNumberOfCalls(5)
                .recordExceptionPredicate(exception ->
                    exception instanceof IOException ||
                    exception instanceof TimeoutException)
                .build();
            return new Resilience4JCircuitBreaker(config);
        }
    }
}
```

### 2. æœåŠ¡æ‹†åˆ†è®¾è®¡

#### æœåŠ¡è¾¹ç•Œè¯†åˆ«
```java
/**
 * æœåŠ¡æ‹†åˆ†åˆ†æç¤ºä¾‹
 */
@Component
public class ServiceDecompositionAnalyzer {

    /**
     * åˆ†æä¸šåŠ¡èƒ½åŠ›è¾¹ç•Œ
     */
    public ServiceBoundary analyzeBusinessBoundary(BusinessCapability capability) {
        return ServiceBoundary.builder()
            .capabilityName(capability.getName())
            .domainModel(capability.getDomainModel())
            .dataOwnership(capability.getDataOwnership())
            .teamResponsibility(capability.getOwnerTeam())
            .serviceCohesion(calculateCohesion(capability))
            .externalDependencies(analyzeDependencies(capability))
            .build();
    }

    /**
     * æœåŠ¡è€¦åˆåº¦åˆ†æ
     */
    public CouplingAnalysis analyzeServiceCoupling(List<ServiceBoundary> services) {
        Map<String, Set<String>> dependencyMatrix = new HashMap<>();

        for (ServiceBoundary service : services) {
            Set<String> dependencies = service.getExternalDependencies()
                .stream()
                .map(dep -> dep.getTargetService())
                .collect(Collectors.toSet());
            dependencyMatrix.put(service.getServiceName(), dependencies);
        }

        return new CouplingAnalysis(dependencyMatrix);
    }
}
```

#### æœåŠ¡æ‹†åˆ†ç­–ç•¥
```java
public class ServiceDecompositionStrategy {

    /**
     * æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†
     */
    public List<ServiceBoundary> decomposeByBusinessCapability(
            List<BusinessCapability> capabilities) {
        return capabilities.stream()
                .filter(this::isStandaloneCapability)
                .map(this::createServiceBoundary)
                .collect(Collectors.toList());
    }

    /**
     * æŒ‰æ•°æ®æ¨¡å‹æ‹†åˆ†
     */
    public List<ServiceBoundary> decomposeByDataModel(
            Map<String, DataModel> dataModels) {
        return dataModels.entrySet().stream()
                .filter(entry -> isIndependentDataModel(entry.getValue()))
                .map(entry -> createDataServiceBoundary(
                        entry.getKey(),
                        entry.getValue()))
                .collect(Collectors.toList());
    }

    /**
     * æŒ‰å›¢é˜Ÿç»„ç»‡æ‹†åˆ†
     */
    public List<ServiceBoundary> decomposeByTeamOrganization(
            List<Team> teams) {
        return teams.stream()
                .filter(team -> team.hasBusinessOwnership())
                .map(this::createTeamServiceBoundary)
                .collect(Collectors.toList());
    }
}
```

### 2. APIå¥‘çº¦è®¾è®¡

#### OpenAPIè§„èŒƒè®¾è®¡
```yaml
# consume-service-api.yaml
openapi: 3.0.3
info:
  title: IOE-DREAM æ¶ˆè´¹æœåŠ¡API
  version: 1.0.0
  description: æ™ºæ…§å›­åŒºä¸€å¡é€šæ¶ˆè´¹ç®¡ç†æœåŠ¡API

servers:
  - url: https://api.ioe-dream.com/v1/consume
    description: ç”Ÿäº§ç¯å¢ƒ
  - url: https://api-test.ioe-dream.com/v1/consume
    description: æµ‹è¯•ç¯å¢ƒ

paths:
  /accounts:
    get:
      summary: è·å–è´¦æˆ·åˆ—è¡¨
      tags:
        - è´¦æˆ·ç®¡ç†
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountListResponse'
        '400':
          description: è¯·æ±‚å‚æ•°é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: æœªæˆæƒ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /accounts/{accountId}:
    get:
      summary: è·å–è´¦æˆ·è¯¦æƒ…
      tags:
        - è´¦æˆ·ç®¡ç†
      parameters:
        - name: accountId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountDetailResponse'
        '404':
          description: è´¦æˆ·ä¸å­˜åœ¨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    AccountListResponse:
      type: object
      properties:
        code:
          type: integer
          example: 200
        message:
          type: string
          example: "æŸ¥è¯¢æˆåŠŸ"
        data:
          type: object
          properties:
            accounts:
              type: array
              items:
                $ref: '#/components/schemas/AccountVO'
            total:
              type: integer
              example: 100
            page:
              type: integer
              example: 1
            size:
              type: integer
              example: 20

    AccountVO:
      type: object
      properties:
        accountId:
          type: integer
          example: 1001
        accountNumber:
          type: string
          example: "CARD001"
        personName:
          type: string
          example: "å¼ ä¸‰"
        balance:
          type: number
          format: decimal
          example: 1000.50
        status:
          $ref: '#/components/schemas/AccountStatus'
        createTime:
          type: string
          format: date-time
          example: "2025-01-01T12:00:00Z"

    AccountStatus:
      type: string
      enum:
        - ACTIVE
        - FROZEN
        - CLOSED
        - EXPIRED
      example: ACTIVE
```

#### APIç‰ˆæœ¬ç®¡ç†
```java
/**
 * APIç‰ˆæœ¬ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api")
public class ApiVersionController {

    /**
     * ç‰ˆæœ¬è·¯ç”±æ˜ å°„
     */
    @Bean
    public RouterFunction<ServerResponse> apiRouter() {
        return route()
                .path("/v1/consume/**", this::routeV1)
                .path("/v2/consume/**", this::routeV2)
                .path("/v0/consume/**", this::routeV0)
                .build();
    }

    /**
     * V1ç‰ˆæœ¬APIè·¯ç”±
     */
    private Mono<ServerResponse> routeV1(ServerRequest request) {
        // è·¯ç”±åˆ°V1ç‰ˆæœ¬çš„å¤„ç†å™¨
        return handleV1Request(request);
    }

    /**
     * V2ç‰ˆæœ¬APIè·¯ç”±
     */
    private Mono<ServerResponse> routeV2(ServerRequest request) {
        // è·¯ç”±åˆ°V2ç‰ˆæœ¬çš„å¤„ç†å™¨
        return handleV2Request(request);
    }

    /**
     * V0å…¼å®¹ç‰ˆæœ¬APIè·¯ç”±
     */
    private Mono<ServerResponse> routeV0(ServerRequest request) {
        // è·¯ç”±åˆ°V0å…¼å®¹ç‰ˆæœ¬çš„å¤„ç†å™¨
        return handleV0Request(request);
    }
}
```

### 3. æ•°æ®ä¸€è‡´æ€§è®¾è®¡

#### åˆ†å¸ƒå¼äº‹åŠ¡å®ç°
```java
/**
 * Sagaåˆ†å¸ƒå¼äº‹åŠ¡ç¼–æ’å™¨
 */
@Component
public class ConsumeSagaOrchestrator {

    @Autowired
    private CommandGateway commandGateway;

    @Autowired
    private SagaManager sagaManager;

    /**
     * æ¶ˆè´¹äº‹åŠ¡ç¼–æ’
     */
    @SagaOrchestrationStart
    @SagaTransactional
    public SagaExecutionId startConsumeTransaction(ConsumeRequest request) {

        SagaExecutionId sagaId = sagaManager.startSaga();

        try {
            // æ­¥éª¤1: éªŒè¯è´¦æˆ·ä½™é¢
            AccountValidateCommand validateCommand = AccountValidateCommand.builder()
                .sagaId(sagaId)
                .accountId(request.getAccountId())
                .amount(request.getAmount())
                .build();

            commandGateway.sendAndWait(validateCommand);

            // æ­¥éª¤2: æ‰£å‡è´¦æˆ·ä½™é¢
            AccountDeductCommand deductCommand = AccountDeductCommand.builder()
                .sagaId(sagaId)
                .accountId(request.getAccountId())
                .amount(request.getAmount())
                .reason("æ¶ˆè´¹æ‰£æ¬¾")
                .build();

            commandGateway.sendAndWait(deductCommand);

            // æ­¥éª¤3: åˆ›å»ºæ¶ˆè´¹è®°å½•
            ConsumeRecordCreateCommand createCommand = ConsumeRecordCreateCommand.builder()
                .sagaId(sagaId)
                .accountId(request.getAccountId())
                .amount(request.getAmount())
                .merchantId(request.getMerchantId())
                .deviceInfo(request.getDeviceInfo())
                .build();

            commandGateway.sendAndWait(createCommand);

            // æ­¥éª¤4: å‘é€é€šçŸ¥
            NotificationSendCommand notificationCommand = NotificationSendCommand.builder()
                .sagaId(sagaId)
                .type("CONSUME_SUCCESS")
                .accountId(request.getAccountId())
                .amount(request.getAmount())
                .build();

            commandGateway.send(notificationCommand);

            sagaManager.completeSaga(sagaId);
            return sagaId;

        } catch (Exception e) {
            sagaManager.abortSaga(sagaId);
            throw new ConsumeTransactionException("æ¶ˆè´¹äº‹åŠ¡å¤±è´¥", e);
        }
    }
}

/**
 * è¡¥å¿äº‹åŠ¡å¤„ç†å™¨
 */
@Component
public class ConsumeCompensationHandler {

    @CompensationHandler("account-deduct-failed")
    public void compensateAccountDeduct(AccountDeductFailedEvent event) {
        // å›æ»šè´¦æˆ·ä½™é¢æ‰£å‡
        AccountRollbackCommand rollbackCommand = AccountRollbackCommand.builder()
            .sagaId(event.getSagaId())
            .accountId(event.getAccountId())
            .amount(event.getAmount())
            .build();

        commandGateway.send(rollbackCommand);
    }

    @CompensationHandler("consume-record-create-failed")
    public void compensateConsumeRecord(ConsumeRecordCreatedEvent event) {
        // åˆ é™¤å·²åˆ›å»ºçš„æ¶ˆè´¹è®°å½•
        ConsumeRecordDeleteCommand deleteCommand = ConsumeRecordDeleteCommand.builder()
            .sagaId(event.getSagaId())
            .recordId(event.getRecordId())
            .build();

        commandGateway.send(deleteCommand);
    }
}
```

### 4. æœåŠ¡æ²»ç†å®ç°

#### æœåŠ¡å‘ç°ä¸æ³¨å†Œ
```java
/**
 * æœåŠ¡æ³¨å†Œé…ç½®
 */
@Configuration
@EnableDiscoveryClient
public class ServiceDiscoveryConfig {

    @Bean
    public EurekaInstanceConfigBean eurekaInstanceConfigBean() {
        return EurekaInstanceConfigBean.builder()
            .instanceId(getInstanceId())
            .hostname(getHostname())
            .appName("ioe-dream-consume-service")
            .ipAddress(getIpAddress())
            .port(getPort())
            .leaseRenewalIntervalInSeconds(10)
            .leaseExpirationDurationInSeconds(30)
            .metadata(getServiceMetadata())
            .build();
    }

    /**
     * æœåŠ¡å…ƒæ•°æ®
     */
    private Map<String, String> getServiceMetadata() {
        Map<String, String> metadata = new HashMap<>();
        metadata.put("version", "1.0.0");
        metadata.put("environment", getActiveProfile());
        metadata.put("region", System.getenv("REGION"));
        metadata.put("zone", System.getenv("ZONE"));
        return metadata;
    }
}

/**
 * æœåŠ¡è´Ÿè½½å‡è¡¡é…ç½®
 */
@Configuration
public class LoadBalancerConfig {

    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }

    @Bean
    public IRule loadBalancerRule() {
        return new WeightedResponseTimeRule();
    }
}
```

#### æ–­è·¯å™¨å®ç°
```java
/**
 * æ–­è·¯å™¨é…ç½®
 */
@Configuration
public class CircuitBreakerConfig {

    @Bean
    public CircuitBreakerFactory<?> circuitBreakerFactory() {
        return new CustomCircuitBreakerFactory();
    }

    /**
     * è‡ªå®šä¹‰æ–­è·¯å™¨å·¥å‚
     */
    static class CustomCircuitBreakerFactory extends CircuitBreakerFactoryBean {

        @Override
        public CircuitBreaker create(String id) {
            CircuitBreakerConfig config = CircuitBreakerConfig.custom()
                .failureRateThreshold(50)                 // å¤±è´¥ç‡é˜ˆå€¼50%
                .waitDurationInOpenState(Duration.ofSeconds(30)) // å¼€å¯çŠ¶æ€ç­‰å¾…30ç§’
                .slidingWindowSize(10)                   // æ»‘åŠ¨çª—å£å¤§å°10
                .minimumNumberOfCalls(5)                 // æœ€å°‘è°ƒç”¨æ¬¡æ•°5
                .permittedNumberOfCallsInHalfOpenState(3) // åŠå¼€çŠ¶æ€å…è®¸3æ¬¡è°ƒç”¨
                .recordExceptionPredicate(exception ->
                    exception instanceof IOException ||
                    exception instanceof TimeoutException)
                .build();

            return new Resilience4JCircuitBreaker(config);
        }
    }
}
```

### 5. ç›‘æ§ä¸å¯è§‚æµ‹æ€§

#### å¥åº·æ£€æŸ¥å®ç°
```java
/**
 * æœåŠ¡å¥åº·æ£€æŸ¥
 */
@Component
public class ConsumeServiceHealthIndicator implements HealthIndicator {

    @Autowired
    private DatabaseHealthChecker databaseHealthChecker;

    @Autowired
    private RedisHealthChecker redisHealthChecker;

    @Autowired
    private MessageQueueHealthChecker mqHealthChecker;

    @Override
    public Health health() {
        Health.Builder builder = Health.up();

        // æ•°æ®åº“å¥åº·æ£€æŸ¥
        Health dbHealth = databaseHealthChecker.check();
        builder.withDetail("database", dbHealth.getStatus().getCode());

        // Rediså¥åº·æ£€æŸ¥
        Health redisHealth = redisHealthChecker.check();
        builder.withDetail("redis", redisHealth.getStatus().getCode());

        // æ¶ˆæ¯é˜Ÿåˆ—å¥åº·æ£€æŸ¥
        Health mqHealth = mqHealthChecker.check();
        builder.withDetail("messageQueue", mqHealth.getStatus().getCode());

        // æœåŠ¡çŠ¶æ€ä¿¡æ¯
        builder.withDetail("service", "ioe-dream-consume-service")
               .withDetail("version", "1.0.0")
               .withDetail("uptime", getUptime())
               .withDetail("lastHealthCheck", LocalDateTime.now());

        // ç»¼åˆå¥åº·çŠ¶æ€åˆ¤æ–­
        if (dbHealth.getStatus() != Status.UP ||
            redisHealth.getStatus() != Status.UP ||
            mqHealth.getStatus() != Status.UP) {
            return Health.down()
                .withDetail("database", dbHealth.getDetails())
                .withDetail("redis", redisHealth.getDetails())
                .withDetail("messageQueue", mqHealth.getDetails())
                .build();
        }

        return builder.build();
    }
}
```

#### æŒ‡æ ‡æ”¶é›†
```java
/**
 * ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†
 */
@Component
public class ConsumeMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter consumeCounter;
    private final Counter consumeSuccessCounter;
    private final Counter consumeFailureCounter;
    private final Timer consumeTimer;
    private final Gauge balanceGauge;

    public ConsumeMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        this.consumeCounter = Counter.builder("consume.requests")
            .description("æ¶ˆè´¹è¯·æ±‚æ€»æ•°")
            .tag("service", "consume-service")
            .register(meterRegistry);

        this.consumeSuccessCounter = Counter.builder("consume.requests.success")
            .description("æ¶ˆè´¹æˆåŠŸè¯·æ±‚æ•°")
            .tag("service", "consume-service")
            .register(meterRegistry);

        this.consumeFailureCounter = Counter.builder("consume.requests.failure")
            .description("æ¶ˆè´¹å¤±è´¥è¯·æ±‚æ•°")
            .tag("service", "consume-service")
            .register(meterRegistry);

        this.consumeTimer = Timer.builder("consume.duration")
            .description("æ¶ˆè´¹è¯·æ±‚è€—æ—¶")
            .tag("service", "consume-service")
            .register(meterRegistry);

        this.balanceGauge = Gauge.builder("consume.total.balance")
            .description("æ¶ˆè´¹ç³»ç»Ÿæ€»ä½™é¢")
            .tag("service", "consume-service")
            .register(meterRegistry, this, ConsumeMetrics::getTotalBalance);
    }

    /**
     * è®°å½•æ¶ˆè´¹è¯·æ±‚
     */
    public void recordConsumeRequest(boolean success, String merchantType, double amount) {
        consumeCounter.increment(
            Tags.of("success", String.valueOf(success),
                   "merchantType", merchantType,
                   "amountRange", getAmountRange(amount))
        );

        if (success) {
            consumeSuccessCounter.increment(
                Tags.of("merchantType", merchantType)
            );
        } else {
            consumeFailureCounter.increment(
                Tags.of("merchantType", merchantType)
            );
        }
    }

    /**
     * è®°å½•æ¶ˆè´¹è€—æ—¶
     */
    public void recordConsumeDuration(Duration duration, String operation) {
        consumeTimer.record(duration, Tags.of("operation", operation));
    }

    /**
     * è·å–ç³»ç»Ÿæ€»ä½™é¢
     */
    private double getTotalBalance() {
        // æŸ¥è¯¢æ‰€æœ‰è´¦æˆ·æ€»ä½™é¢
        return accountRepository.getTotalBalance();
    }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹
- **APIå®‰å…¨**: æ‰€æœ‰APIç«¯ç‚¹å¿…é¡»å®ç°è®¤è¯å’Œæˆæƒ
- **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®å¿…é¡»ä½¿ç”¨å›½å¯†ç®—æ³•åŠ å¯†
- **è®¿é—®æ§åˆ¶**: å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰é‡è¦æ“ä½œçš„å®¡è®¡æ—¥å¿—

### ğŸ—ï¸ æ¶æ„æ³¨æ„äº‹é¡¹
- **æœåŠ¡è¾¹ç•Œ**: ç¡®ä¿æœåŠ¡è¾¹ç•Œæ¸…æ™°ï¼Œé¿å…æœåŠ¡é—´è¿‡åº¦è€¦åˆ
- **æ•°æ®ä¸€è‡´æ€§**: ä¼˜å…ˆä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§ï¼Œé¿å…å¼ºä¸€è‡´æ€§
- **æ€§èƒ½è€ƒè™‘**: è€ƒè™‘ç½‘ç»œå»¶è¿Ÿå’Œåºåˆ—åŒ–å¼€é”€
- **æ•…éšœéš”ç¦»**: å®ç°ä¼˜é›…é™çº§å’Œç†”æ–­æœºåˆ¶

### ğŸ“ˆ å¯æ‰©å±•æ€§æ³¨æ„äº‹é¡¹
- **æ°´å¹³æ‰©å±•**: è®¾è®¡æ”¯æŒæ°´å¹³æ‰©å±•çš„æ— çŠ¶æ€æœåŠ¡
- **æ•°æ®åº“æ‰©å±•**: è€ƒè™‘è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨
- **ç¼“å­˜ç­–ç•¥**: å®ç°å¤šçº§ç¼“å­˜æé«˜æ€§èƒ½
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡

---

## ğŸ“Š è¯„ä¼°æ ‡å‡†

### æŠ€æœ¯æŒ‡æ ‡
- **APIè®¾è®¡**: ç¬¦åˆOpenAPI 3.0è§„èŒƒï¼Œæ–‡æ¡£å®Œæ•´åº¦â‰¥95%
- **æœåŠ¡æ‹†åˆ†**: æœåŠ¡è¾¹ç•Œæ¸…æ™°ï¼Œè€¦åˆåº¦â‰¤30%
- **æ€§èƒ½æµ‹è¯•**: APIå“åº”æ—¶é—´P95â‰¤200ms
- **å¯ç”¨æ€§**: æœåŠ¡å¯ç”¨æ€§â‰¥99.9%
- **ç›‘æ§è¦†ç›–**: å…³é”®æŒ‡æ ‡ç›‘æ§è¦†ç›–ç‡100%

### ä¸šåŠ¡æŒ‡æ ‡
- **åŠŸèƒ½å®Œæ•´æ€§**: ä¸šåŠ¡åŠŸèƒ½è¦†ç›–100%
- **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®ä¸€è‡´æ€§ä¿è¯100%
- **ç”¨æˆ·ä½“éªŒ**: APIæ˜“ç”¨æ€§è¯„åˆ†â‰¥8.0
- **å¼€å‘æ•ˆç‡**: æ–°æœåŠ¡å¼€å‘å‘¨æœŸâ‰¤2å‘¨

### è´¨é‡æ ‡å‡†
- **ä»£ç è´¨é‡**: ä»£ç è§„èŒƒç¬¦åˆåº¦100%
- **æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥80%
- **æ–‡æ¡£å®Œæ•´æ€§**: æ¶æ„æ–‡æ¡£å’ŒAPIæ–‡æ¡£å®Œæ•´
- **å®‰å…¨æ€§**: å®‰å…¨æ¼æ´æ‰«æé€šè¿‡ç‡100%

---

## ğŸš€ æœ€ä½³å®è·µ

### è®¾è®¡é˜¶æ®µæœ€ä½³å®è·µ
1. **ä¸šåŠ¡åˆ†æä¼˜å…ˆ**: æ·±å…¥ç†è§£ä¸šåŠ¡éœ€æ±‚å’Œè¾¹ç•Œ
2. **æ¸è¿›å¼æ‹†åˆ†**: ä»æ ¸å¿ƒä¸šåŠ¡å¼€å§‹é€æ­¥æ‹†åˆ†
3. **APIä¼˜å…ˆ**: å…ˆå®šä¹‰APIå¥‘çº¦å†å®ç°æœåŠ¡
4. **ç‰ˆæœ¬ç®¡ç†**: åˆ¶å®šæ¸…æ™°çš„APIç‰ˆæœ¬ç­–ç•¥

### å¼€å‘é˜¶æ®µæœ€ä½³å®è·µ
1. **DDDå®è·µ**: ä¸¥æ ¼éµå¾ªé¢†åŸŸé©±åŠ¨è®¾è®¡åŸåˆ™
2. **ä»£ç è§„èŒƒ**: éµå¾ªç»Ÿä¸€çš„ç¼–ç è§„èŒƒ
3. **æµ‹è¯•é©±åŠ¨**: ç¼–å†™å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **æŒç»­é›†æˆ**: å»ºç«‹å®Œæ•´çš„CI/CDæµæ°´çº¿

### è¿ç»´é˜¶æ®µæœ€ä½³å®è·µ
1. **ç›‘æ§å‘Šè­¦**: å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
2. **æ—¥å¿—ç®¡ç†**: ç»Ÿä¸€æ—¥å¿—æ ¼å¼å’Œæ”¶é›†æ–¹å¼
3. **æ•…éšœæ¢å¤**: åˆ¶å®šè¯¦ç»†çš„æ•…éšœæ¢å¤é¢„æ¡ˆ
4. **æ€§èƒ½ä¼˜åŒ–**: æŒç»­è¿›è¡Œæ€§èƒ½è°ƒä¼˜å’Œä¼˜åŒ–

## ğŸ¯ IOE-DREAMç‰¹å®šæœ€ä½³å®è·µ

### 1. é¡¹ç›®æ¶æ„è½¬æ¢æœ€ä½³å®è·µ

#### æ¸è¿›å¼è½¬æ¢ç­–ç•¥
```java
/**
 * IOE-DREAMå¾®æœåŠ¡æ¸è¿›å¼è½¬æ¢æœ€ä½³å®è·µ
 */
@Component
public class IOEDreamMigrationStrategy {

    /**
     * é˜¶æ®µä¸€ï¼šæ¶æ„è§„èŒƒåŒ–ï¼ˆ2å‘¨ï¼‰
     * - ç»Ÿä¸€æœåŠ¡å‘½åè§„èŒƒï¼ˆioedream-{service-name}ï¼‰
     * - æ¸…ç†é‡å¤æœåŠ¡å’Œå†—ä½™ä»£ç 
     * - ç»Ÿä¸€æŠ€æœ¯æ ˆå’Œé…ç½®æ ‡å‡†
     */
    public PhaseResult executePhase1_ArchitectureNormalization() {
        return PhaseResult.builder()
            .phase("æ¶æ„è§„èŒƒåŒ–")
            .duration("2å‘¨")
            .tasks(List.of(
                "æœåŠ¡é‡å‘½åï¼šaccess-service â†’ ioedream-access-service",
                "æ¸…ç†é‡å¤ï¼šdevice-serviceä¸ioedream-device-serviceåˆå¹¶",
                "ç»Ÿä¸€å…¬å…±æ¨¡å—ï¼šä½¿ç”¨microservices-common",
                "æŠ€æœ¯æ ˆç»Ÿä¸€ï¼šConsulæœåŠ¡å‘ç°ï¼ŒSpring Cloudé…ç½®"
            ))
            .successCriteria(List.of(
                "æ‰€æœ‰æœåŠ¡å‘½åè§„èŒƒç»Ÿä¸€",
                "é‡å¤æœåŠ¡å®Œå…¨æ¸…ç†",
                "æœåŠ¡æ³¨å†Œå‘ç°æ­£å¸¸"
            ))
            .build();
    }

    /**
     * é˜¶æ®µäºŒï¼šæ ¸å¿ƒæœåŠ¡å®Œå–„ï¼ˆ4å‘¨ï¼‰
     * - è¡¥å…¨8ä¸ªæ ¸å¿ƒä¸šåŠ¡æœåŠ¡åŠŸèƒ½
     * - å»ºè®¾6ä¸ªæ”¯æ’‘æœåŠ¡
     * - å®ç°æœåŠ¡é—´é€šä¿¡å’Œæ²»ç†
     */
    public PhaseResult executePhase2_CoreServices() {
        return PhaseResult.builder()
            .phase("æ ¸å¿ƒæœåŠ¡å®Œå–„")
            .duration("4å‘¨")
            .tasks(List.of(
                "å®Œå–„ioedream-access-serviceé—¨ç¦æœåŠ¡",
                "å®Œå–„ioedream-consume-serviceæ¶ˆè´¹æœåŠ¡",
                "æ–°å»ºioedream-notification-serviceé€šçŸ¥æœåŠ¡",
                "æ–°å»ºioedream-file-serviceæ–‡ä»¶æœåŠ¡",
                "æ–°å»ºioedream-report-serviceæŠ¥è¡¨æœåŠ¡"
            ))
            .successCriteria(List.of(
                "æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½100%å®ç°",
                "æ”¯æ’‘æœåŠ¡å®Œæ•´å¯ç”¨",
                "APIæ¥å£å®Œæ•´å¯ç”¨"
            ))
            .build();
    }

    /**
     * é˜¶æ®µä¸‰ï¼šé«˜çº§æœåŠ¡å’Œè¿ç»´ï¼ˆ4å‘¨ï¼‰
     * - éƒ¨ç½²æœåŠ¡ç½‘æ ¼å’Œç›‘æ§
     * - å»ºè®¾å®¡è®¡å’Œæ—¥å¿—æœåŠ¡
     * - å®ç°é…ç½®ä¸­å¿ƒ
     */
    public PhaseResult executePhase3_AdvancedServices() {
        return PhaseResult.builder()
            .phase("é«˜çº§æœåŠ¡å’Œè¿ç»´")
            .duration("4å‘¨")
            .tasks(List.of(
                "IstioæœåŠ¡ç½‘æ ¼éƒ¨ç½²",
                "Jaegeré“¾è·¯è¿½è¸ªé›†æˆ",
                "ioedream-audit-serviceå®¡è®¡æœåŠ¡",
                "ioedream-logging-serviceæ—¥å¿—æœåŠ¡",
                "ioedream-config-serviceé…ç½®æœåŠ¡"
            ))
            .successCriteria(List.of(
                "æœåŠ¡æ²»ç†åŠŸèƒ½å®Œæ•´",
                "ç›‘æ§å‘Šè­¦ä½“ç³»å»ºç«‹",
                "æ—¥å¿—åˆ†æåŠŸèƒ½å¯ç”¨"
            ))
            .build();
    }

    /**
     * é˜¶æ®µå››ï¼šæ•°æ®è¿ç§»å’Œåˆ‡æ¢ï¼ˆ4å‘¨ï¼‰
     * - æ•°æ®åº“åˆ†åº“æ‹†åˆ†
     * - æ•°æ®è¿ç§»å’ŒåŒæ­¥
     * - ä¸šåŠ¡æµé‡åˆ‡æ¢
     */
    public PhaseResult executePhase4_DataMigration() {
        return PhaseResult.builder()
            .phase("æ•°æ®è¿ç§»å’Œä¸šåŠ¡åˆ‡æ¢")
            .duration("4å‘¨")
            .tasks(List.of(
                "æ•°æ®åº“æŒ‰æœåŠ¡åŸŸæ‹†åˆ†",
                "æ•°æ®è¿ç§»è„šæœ¬å¼€å‘",
                "CDCæ•°æ®åŒæ­¥é…ç½®",
                "è“ç»¿éƒ¨ç½²åˆ‡æ¢",
                "ä¸šåŠ¡éªŒè¯å’Œç›‘æ§"
            ))
            .successCriteria(List.of(
                "æ•°æ®100%è¿ç§»å®Œæˆ",
                "ä¸šåŠ¡åŠŸèƒ½éªŒè¯é€šè¿‡",
                "æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡"
            ))
            .build();
    }
}
```

#### æ•°æ®åº“æ‹†åˆ†æœ€ä½³å®è·µ
```java
/**
 * IOE-DREAMæ•°æ®åº“æ‹†åˆ†ç­–ç•¥
 */
@Component
public class DatabaseDecompositionStrategy {

    /**
     * æŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†æ•°æ®åº“
     * ç¡®ä¿æ¯ä¸ªå¾®æœåŠ¡æœ‰ç‹¬ç«‹çš„æ•°æ®å­˜å‚¨
     */
    public Map<String, DatabaseSchema> decomposeDatabases() {
        Map<String, DatabaseSchema> schemas = new HashMap<>();

        // è®¤è¯æœåŠ¡æ•°æ®åº“
        schemas.put("ioedream_auth_db", DatabaseSchema.builder()
            .databaseName("ioedream_auth_db")
            .tables(List.of(
                "t_user_credential", "t_token_store", "t_login_log"
            ))
            .characteristics("ç”¨æˆ·è®¤è¯æ•°æ®ï¼Œè¯»å†™åˆ†ç¦»ï¼Œé«˜å¯ç”¨")
            .connectionPoolConfig(ConnectionPoolConfig.builder()
                .maxConnections(20)
                .minConnections(5)
                .connectionTimeout(30000)
                .build())
            .build());

        // èº«ä»½ç®¡ç†æ•°æ®åº“
        schemas.put("ioedream_identity_db", DatabaseSchema.builder()
            .databaseName("ioedream_identity_db")
            .tables(List.of(
                "t_user_info", "t_role_info", "t_permission_info",
                "t_department_info", "t_position_info"
            ))
            .characteristics("ç»„ç»‡æ¶æ„æ•°æ®ï¼Œè¯»å¤šå†™å°‘ï¼Œç¼“å­˜å‹å¥½")
            .cachingStrategy("Redisç¼“å­˜ï¼ŒTTL 30åˆ†é’Ÿ")
            .build());

        // æ¶ˆè´¹æœåŠ¡æ•°æ®åº“
        schemas.put("ioedream_consume_db", DatabaseSchema.builder()
            .databaseName("ioedream_consume_db")
            .tables(List.of(
                "t_account_info", "t_consume_record", "t_recharge_record",
                "t_consume_mode", "t_consume_config"
            ))
            .characteristics("äº¤æ˜“æ•°æ®ï¼Œé«˜å¹¶å‘ï¼Œä¸€è‡´æ€§è¦æ±‚é«˜")
            .transactionStrategy("åˆ†å¸ƒå¼äº‹åŠ¡Seata ATæ¨¡å¼")
            .partitioningStrategy("æŒ‰æœˆä»½åˆ†è¡¨")
            .build());

        return schemas;
    }

    /**
     * æ•°æ®ä¸€è‡´æ€§ä¿è¯ç­–ç•¥
     */
    public DataConsistencyStrategy getConsistencyStrategy() {
        return DataConsistencyStrategy.builder()
            .consistencyLevel("æœ€ç»ˆä¸€è‡´æ€§")
            .eventSourcing(true)
            .cqrs(true)
            .sagaPattern("Sagaç¼–æ’æ¨¡å¼")
            .compensation("è‡ªåŠ¨è¡¥å¿æœºåˆ¶")
            .build();
    }
}
```

### 2. æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

#### ç¼“å­˜ç­–ç•¥è®¾è®¡
```java
/**
 * IOE-DREAMç¼“å­˜æ¶æ„æœ€ä½³å®è·µ
 */
@Configuration
@EnableCaching
public class IOEDreamCacheConfiguration {

    /**
     * å¤šçº§ç¼“å­˜æ¶æ„
     */
    @Bean
    public CacheManager cacheManager() {
        return new CompositeCacheManager(
            // L1: æœ¬åœ°Caffeineç¼“å­˜
            caffeineCacheManager(),
            // L2: åˆ†å¸ƒå¼Redisç¼“å­˜
            redisCacheManager()
        );
    }

    /**
     * æœ¬åœ°ç¼“å­˜é…ç½®
     */
    @Bean
    public CaffeineCacheManager caffeineCacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(Duration.ofMinutes(10))
            .recordStats());
        return cacheManager;
    }

    /**
     * åˆ†å¸ƒå¼ç¼“å­˜é…ç½®
     */
    @Bean
    public RedisCacheManager redisCacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));

        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .transactionAware()
            .build();
    }
}
```

#### å¼‚æ­¥å¤„ç†ä¼˜åŒ–
```java
/**
 * IOE-DREAMå¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ
 */
@Component
public class AsyncProcessingOptimization {

    @Async("consumeTaskExecutor")
    @EventListener
    public void handleConsumeEvent(ConsumeEvent event) {
        // å¼‚æ­¥å¤„ç†æ¶ˆè´¹äº‹ä»¶
        log.info("å¼‚æ­¥å¤„ç†æ¶ˆè´¹äº‹ä»¶: {}", event);
    }

    /**
     * æ¶ˆè´¹ä¸šåŠ¡ä¸“ç”¨çº¿ç¨‹æ± 
     */
    @Bean("consumeTaskExecutor")
    public Executor consumeTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(1000);
        executor.setThreadNamePrefix("consume-async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

### 3. å®‰å…¨æœ€ä½³å®è·µ

#### APIå®‰å…¨é˜²æŠ¤
```java
/**
 * IOE-DREAM APIå®‰å…¨æœ€ä½³å®è·µ
 */
@Configuration
@EnableWebSecurity
public class APISecurityConfiguration {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/actuator/**").hasRole("ADMIN")
                .requestMatchers("/api/**").authenticated()
                .anyRequest().denyAll())
            .addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class)
            .headers(headers -> headers.frameOptions().sameOrigin());
        return http.build();
    }

    /**
     * JWTè®¤è¯è¿‡æ»¤å™¨
     */
    @Bean
    public JwtAuthenticationFilter jwtAuthenticationFilter() {
        return new JwtAuthenticationFilter();
    }
}
```

### 4. ç›‘æ§è¿ç»´æœ€ä½³å®è·µ

#### å¥åº·æ£€æŸ¥å¢å¼º
```java
/**
 * IOE-DREAMæœåŠ¡å¥åº·æ£€æŸ¥å¢å¼º
 */
@Component
public class ComprehensiveHealthIndicator implements HealthIndicator {

    @Override
    public Health health() {
        Health.Builder builder = Health.up();

        // æ•°æ®åº“å¥åº·æ£€æŸ¥
        checkDatabaseHealth(builder);

        // Rediså¥åº·æ£€æŸ¥
        checkRedisHealth(builder);

        // å¤–éƒ¨æœåŠ¡å¥åº·æ£€æŸ¥
        checkExternalServices(builder);

        // ä¸šåŠ¡æŒ‡æ ‡æ£€æŸ¥
        checkBusinessMetrics(builder);

        return builder.build();
    }

    private void checkDatabaseHealth(Health.Builder builder) {
        try {
            // æ‰§è¡Œç®€å•æŸ¥è¯¢éªŒè¯æ•°æ®åº“è¿æ¥
            jdbcTemplate.queryForObject("SELECT 1", Integer.class);
            builder.withDetail("database", Health.up().build());
        } catch (Exception e) {
            builder.withDetail("database", Health.down(e).build());
        }
    }

    private void checkRedisHealth(Health.Builder builder) {
        try {
            redisTemplate.opsForValue().set("health-check", "ok", Duration.ofSeconds(10));
            String result = redisTemplate.opsForValue().get("health-check");
            builder.withDetail("redis", "ok".equals(result) ?
                Health.up().build() : Health.down().build());
        } catch (Exception e) {
            builder.withDetail("redis", Health.down(e).build());
        }
    }
}
```

### 5. å®¹å™¨åŒ–éƒ¨ç½²æœ€ä½³å®è·µ

#### Kuberneteséƒ¨ç½²é…ç½®
```yaml
# ioedream-consume-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ioedream-consume-service
  namespace: production
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: ioedream-consume-service
  template:
    metadata:
      labels:
        app: ioedream-consume-service
        version: v1.0.0
    spec:
      containers:
      - name: consume-service
        image: ioedream/consume-service:1.0.0
        ports:
        - containerPort: 8103
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: CONSUL_HOST
          value: "consul.service.consul"
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: host
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8103
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8103
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
      volumes:
      - name: config-volume
        configMap:
          name: consume-service-config
```

### 6. é”™è¯¯å¤„ç†å’Œé™çº§æœ€ä½³å®è·µ

#### ä¼˜é›…é™çº§ç­–ç•¥
```java
/**
 * IOE-DREAMæœåŠ¡é™çº§å¤„ç†
 */
@Component
public class ServiceDegradationHandler {

    /**
     * æ¶ˆè´¹æœåŠ¡é™çº§å¤„ç†
     */
    @CircuitBreaker(name = "consumeService", fallbackMethod = "fallbackConsume")
    public ConsumeResult processConsume(ConsumeRequest request) {
        return consumeService.processConsume(request);
    }

    /**
     * æ¶ˆè´¹æœåŠ¡é™çº§æ–¹æ³•
     */
    public ConsumeResult fallbackConsume(ConsumeRequest request, Exception e) {
        log.warn("æ¶ˆè´¹æœåŠ¡é™çº§å¤„ç†ï¼Œè¯·æ±‚: {}", request, e);

        return ConsumeResult.builder()
            .success(false)
            .message("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
            .errorCode("SYSTEM_BUSY")
            .timestamp(LocalDateTime.now())
            .build();
    }

    /**
     * æ‰¹é‡æœåŠ¡é™çº§
     */
    @Bulkhead(name = "bulkheadConsume", type = Bulkhead.Type.THREADPOOL,
               fallbackMethod = "fallbackBulkConsume")
    @TimeLimiter(name = "timeLimiterConsume", fallbackMethod = "fallbackTimeout")
    public CompletableFuture<List<ConsumeResult>> processBatchConsume(
            List<ConsumeRequest> requests) {
        return CompletableFuture.supplyAsync(() -> {
            return requests.stream()
                    .map(this::processConsume)
                    .collect(Collectors.toList());
        });
    }
}
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### æ¨èä¹¦ç±
- ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹- Chris Richardson
- ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹- Eric Evans
- ã€ŠBuilding Microservicesã€‹- Sam Newman
- ã€Šå¾®æœåŠ¡æ²»ç†ã€‹- Chris Richardson

### åœ¨çº¿èµ„æº
- [Spring Cloudå®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-cloud)
- [APIè®¾è®¡æŒ‡å—](https://apistylebook.org/)
- [DDDå®è·µæŒ‡å—](https://dddcommunity.org/)
- [å¾®æœåŠ¡æœ€ä½³å®è·µ](https://microservices.io/)

---

*æ­¤æŠ€èƒ½æ–‡æ¡£æ˜¯IOE-DREAMå¾®æœåŠ¡æ¶æ„å¸ˆçš„æƒå¨æŒ‡å—ï¼Œæä¾›å®Œæ•´çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡ã€å®ç°å’Œæ²»ç†èƒ½åŠ›ã€‚*