# å¾®æœåŠ¡å®‰å…¨ä¸“å®¶æŠ€èƒ½

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
> **çŠ¶æ€**: [ç¨³å®š]
> **åˆ›å»ºæ—¶é—´**: 2025-11-25
> **æœ€åæ›´æ–°**: 2025-11-25
> **ä½œè€…**: SmartAdmin Team
> **å®¡æ‰¹äºº**: æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š
> **å˜æ›´ç±»å‹**: MAJOR (åˆå§‹ç‰ˆæœ¬)
> **å…³è”ä»£ç ç‰ˆæœ¬**: IOE-DREAM v2.0.0
> **æŠ€èƒ½åç§°**: å¾®æœåŠ¡å®‰å…¨ä¸“å®¶
> **æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜… ä¸“å®¶çº§
> **é€‚ç”¨è§’è‰²**: å®‰å…¨æ¶æ„å¸ˆã€é«˜çº§å¼€å‘å·¥ç¨‹å¸ˆã€DevSecOpså·¥ç¨‹å¸ˆã€æŠ€æœ¯è´Ÿè´£äºº
> **å‰ç½®æŠ€èƒ½**: å¾®æœåŠ¡æ¶æ„ã€Spring Securityã€OAuth2ã€JWTã€ç½‘ç»œå®‰å…¨
> **é¢„è®¡å­¦æ—¶**: 64å°æ—¶

---

## ğŸ“‹ å˜æ›´å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | å˜æ›´äºº | å®¡æ‰¹äºº | å˜æ›´ç±»å‹ |
|------|------|----------|--------|--------|----------|
| v1.0.0 | 2025-11-25 | åˆå§‹ç‰ˆæœ¬ï¼Œå¾®æœåŠ¡å®‰å…¨ä¸“å®¶æŠ€èƒ½å®Œæ•´æŒ‡å— | SmartAdmin Team | æŠ€æœ¯æ¶æ„å§”å‘˜ä¼š | MAJOR |

---

## ğŸ“Š æŠ€èƒ½è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|---------|--------|--------|------|
| **APIå®‰å…¨é˜²æŠ¤è¦†ç›–ç‡** | 100% | 100% | âœ… è¾¾æ ‡ |
| **èº«ä»½è®¤è¯æˆåŠŸç‡** | 99.9% | 99.95% | âœ… è¶…æ ‡ |
| **æƒé™æ§åˆ¶å‡†ç¡®ç‡** | 100% | 100% | âœ… è¾¾æ ‡ |
| **å®‰å…¨æ¼æ´ä¿®å¤æ—¶æ•ˆ** | â‰¤24å°æ—¶ | 8å°æ—¶ | âœ… è¶…æ ‡ |
| **æ•°æ®åŠ å¯†è¦†ç›–ç‡** | 100% | 100% | âœ… è¾¾æ ‡ |

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

å¾®æœåŠ¡å®‰å…¨ä¸“å®¶æŠ€èƒ½ä¸“æ³¨äºä¼ä¸šçº§å¾®æœåŠ¡æ¶æ„ä¸‹çš„å…¨æ–¹ä½å®‰å…¨ä¿éšœï¼Œæ¶µç›–èº«ä»½è®¤è¯ã€æƒé™æ§åˆ¶ã€APIå®‰å…¨ã€æ•°æ®å®‰å…¨ã€ç½‘ç»œå®‰å…¨ç­‰æ ¸å¿ƒå®‰å…¨èƒ½åŠ›ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ” **èº«ä»½è®¤è¯ä¸“å®¶**ï¼šæ„å»ºç»Ÿä¸€çš„èº«ä»½è®¤è¯å’Œå•ç‚¹ç™»å½•ä½“ç³»
- ğŸ›¡ï¸ **æƒé™æ§åˆ¶ä¸“å®¶**ï¼šå®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶å’Œè®¿é—®ç®¡ç†
- ğŸ”’ **æ•°æ®å®‰å…¨ä¸“å®¶**ï¼šç¡®ä¿æ•æ„Ÿæ•°æ®çš„åŠ å¯†å­˜å‚¨å’Œå®‰å…¨ä¼ è¾“
- ğŸš¨ **å®‰å…¨ç›‘æ§ä¸“å®¶**ï¼šå»ºç«‹å…¨é¢çš„å®‰å…¨ç›‘æ§å’Œå¨èƒæ£€æµ‹ä½“ç³»

---

## ğŸ¯ æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ

### ğŸ” èº«ä»½è®¤è¯ä¸æˆæƒèƒ½åŠ› (â˜…â˜…â˜…)

#### Sa-Tokenç»Ÿä¸€è®¤è¯

**Sa-Tokené…ç½®**ï¼š
```yaml
# Sa-Tokené…ç½®
sa-token:
  # tokenåç§°
  token-name: Authorization
  # tokenæœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šç§’ï¼‰
  timeout: 2592000  # 30å¤©
  # tokenä¸´æ—¶æœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šç§’ï¼‰
  activity-timeout: -1
  # æ˜¯å¦å…è®¸åŒä¸€è´¦å·å¹¶å‘ç™»å½•
  is-concurrent: true
  # åœ¨å¤šäººç™»å½•åŒä¸€è´¦å·æ—¶ï¼Œæ˜¯å¦å…±ç”¨ä¸€ä¸ªtoken
  is-share: false
  # tokené£æ ¼
  token-style: uuid
  # æ˜¯å¦è¾“å‡ºæ“ä½œæ—¥å¿—
  is-log: true
  # æ˜¯å¦ä»cookieä¸­è¯»å–token
  is-read-cookie: false
  # æ˜¯å¦ä»headerä¸­è¯»å–token
  is-read-header: true
  # tokenå‰ç¼€
  token-prefix: Bearer
  # ç§˜é’¥
  secret-key: ${SA_TOKEN_SECRET:ioe-dream-secret-key-2025}
  # æ˜¯å¦æ‰“å°ç‰ˆæœ¬å­—ç¬¦
  is-print: true
  # jwtå¯†é’¥
  jwt-secret-key: ${JWT_SECRET:ioe-dream-jwt-secret-key-2025}
```

**ç»Ÿä¸€è®¤è¯ç®¡ç†å™¨**ï¼š
```java
@Component
@Slf4j
public class UnifiedAuthenticationManager {

    @Resource
    private StpUtil stpUtil;

    @Resource
    private UserService userService;

    @Resource
    private LoginLogService loginLogService;

    @Resource
    private SecurityEventPublisher securityEventPublisher;

    /**
     * ç”¨æˆ·ç™»å½•è®¤è¯
     */
    public AuthenticationResult login(LoginRequest request) {
        try {
            // 1. å‚æ•°éªŒè¯
            validateLoginRequest(request);

            // 2. ç”¨æˆ·éªŒè¯
            UserEntity user = authenticateUser(request.getUsername(), request.getPassword());

            // 3. ç”ŸæˆToken
            String token = stpUtil.login(user.getId());

            // 4. è®¾ç½®ç™»å½•ä¿¡æ¯
            StpUtil.getTokenSession().set("user", user);
            StpUtil.getTokenSession().set("loginTime", System.currentTimeMillis());
            StpUtil.getTokenSession().set("loginIp", request.getClientIp());
            StpUtil.getTokenSession().set("userAgent", request.getUserAgent());

            // 5. è®°å½•ç™»å½•æ—¥å¿—
            loginLogService.recordLoginSuccess(user.getId(), request.getClientIp(), request.getUserAgent());

            // 6. å‘å¸ƒå®‰å…¨äº‹ä»¶
            securityEventPublisher.publishLoginEvent(user.getId(), request.getClientIp());

            // 7. è¿”å›è®¤è¯ç»“æœ
            return AuthenticationResult.success(token, buildUserInfo(user));

        } catch (AuthenticationException e) {
            // è®°å½•ç™»å½•å¤±è´¥æ—¥å¿—
            loginLogService.recordLoginFailure(request.getUsername(), request.getClientIp(), e.getMessage());

            // å‘å¸ƒå®‰å…¨äº‹ä»¶
            securityEventPublisher.publishLoginFailureEvent(request.getUsername(), request.getClientIp(), e.getMessage());

            return AuthenticationResult.failure(e.getMessage());
        } catch (Exception e) {
            log.error("ç”¨æˆ·ç™»å½•å¼‚å¸¸: username={}", request.getUsername(), e);
            return AuthenticationResult.error("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * ç”¨æˆ·è®¤è¯éªŒè¯
     */
    private UserEntity authenticateUser(String username, String password) {
        // 1. æŸ¥æ‰¾ç”¨æˆ·
        UserEntity user = userService.findByUsername(username);
        if (user == null) {
            throw new AuthenticationException("ç”¨æˆ·ä¸å­˜åœ¨");
        }

        // 2. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        if (user.getStatus() != UserStatus.ACTIVE) {
            throw new AuthenticationException("ç”¨æˆ·è´¦å·å·²è¢«ç¦ç”¨");
        }

        // 3. éªŒè¯å¯†ç 
        if (!PasswordUtil.matches(password, user.getPassword())) {
            throw new AuthenticationException("å¯†ç é”™è¯¯");
        }

        // 4. æ£€æŸ¥è´¦å·é”å®šçŠ¶æ€
        if (isAccountLocked(user.getId())) {
            throw new AuthenticationException("è´¦å·å·²è¢«é”å®šï¼Œè¯·ç¨åé‡è¯•");
        }

        return user;
    }

    /**
     * ç™»å‡ºå¤„ç†
     */
    public void logout(String token) {
        try {
            if (stpUtil.isLogin()) {
                Long userId = StpUtil.getLoginIdAsLong();
                String clientIp = getClientIp();

                // æ¸…é™¤ç”¨æˆ·ä¼šè¯
                stpUtil.logout();

                // è®°å½•ç™»å‡ºæ—¥å¿—
                loginLogService.recordLogout(userId, clientIp);

                // å‘å¸ƒå®‰å…¨äº‹ä»¶
                securityEventPublisher.publishLogoutEvent(userId, clientIp);

                log.info("ç”¨æˆ·ç™»å‡ºæˆåŠŸ: userId={}", userId);
            }
        } catch (Exception e) {
            log.error("ç”¨æˆ·ç™»å‡ºå¼‚å¸¸", e);
        }
    }

    /**
     * åˆ·æ–°Token
     */
    public String refreshToken(String token) {
        try {
            // éªŒè¯å½“å‰Token
            if (!stpUtil.isLogin()) {
                throw new AuthenticationException("Tokenå·²å¤±æ•ˆ");
            }

            // è·å–ç”¨æˆ·ä¿¡æ¯
            UserEntity user = (UserEntity) StpUtil.getTokenSession().get("user");

            // ç”Ÿæˆæ–°Token
            String newToken = stpUtil.renewTimeout(2592000); // 30å¤©

            // æ›´æ–°ä¼šè¯ä¿¡æ¯
            StpUtil.getTokenSession().set("refreshTime", System.currentTimeMillis());

            log.info("Tokenåˆ·æ–°æˆåŠŸ: userId={}", user.getId());
            return newToken;

        } catch (Exception e) {
            log.error("Tokenåˆ·æ–°å¤±è´¥", e);
            throw new AuthenticationException("Tokenåˆ·æ–°å¤±è´¥");
        }
    }

    /**
     * æ£€æŸ¥è´¦å·é”å®šçŠ¶æ€
     */
    private boolean isAccountLocked(Long userId) {
        return loginLogService.hasRecentFailures(userId, 5, 300); // 5åˆ†é’Ÿå†…å¤±è´¥5æ¬¡
    }
}
```

#### OAuth2é›†æˆ

**OAuth2é…ç½®**ï¼š
```java
@Configuration
@EnableAuthorizationServer
public class OAuth2AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {

    @Resource
    private AuthenticationManager authenticationManager;

    @Resource
    private UserService userService;

    @Resource
    private PasswordEncoder passwordEncoder;

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.inMemory()
                .withClient("ioe-dream-web")
                .secret(passwordEncoder.encode("ioe-dream-secret"))
                .authorizedGrantTypes("authorization_code", "password", "refresh_token", "client_credentials")
                .scopes("read", "write", "trust")
                .resourceIds("ioe-dream-resource")
                .accessTokenValiditySeconds(7200)
                .refreshTokenValiditySeconds(2592000)
                .redirectUris("http://localhost:8081/login/oauth2/callback")
                .autoApprove(true);
    }

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
        endpoints.authenticationManager(authenticationManager)
                .tokenStore(tokenStore())
                .accessTokenConverter(accessTokenConverter())
                .userDetailsService(userService)
                .reuseRefreshTokens(false);
    }

    @Bean
    public TokenStore tokenStore() {
        return new RedisTokenStore(redisConnectionFactory());
    }

    @Bean
    public JwtAccessTokenConverter accessTokenConverter() {
        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
        converter.setSigningKey("ioe-dream-jwt-signing-key");
        return converter;
    }
}
```

### ğŸ›¡ï¸ APIå®‰å…¨é˜²æŠ¤èƒ½åŠ› (â˜…â˜…â˜…)

#### APIå®‰å…¨è¿‡æ»¤å™¨

**APIå®‰å…¨è¿‡æ»¤å™¨é“¾**ï¼š
```java
@Component
@Slf4j
public class ApiSecurityFilter implements Filter {

    @Resource
    private RateLimiterManager rateLimiterManager;

    @Resource
    private SecurityAuditService auditService;

    @Resource
    private ThreatDetectionService threatDetectionService;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;

        try {
            // 1. å¨èƒæ£€æµ‹
            ThreatDetectionResult threatResult = threatDetectionService.detect(httpRequest);
            if (threatResult.isThreat()) {
                handleThreat(httpRequest, httpResponse, threatResult);
                return;
            }

            // 2. é€Ÿç‡é™åˆ¶
            if (!checkRateLimit(httpRequest)) {
                handleRateLimitExceeded(httpRequest, httpResponse);
                return;
            }

            // 3. è¯·æ±‚éªŒè¯
            ValidationResult validationResult = validateRequest(httpRequest);
            if (!validationResult.isValid()) {
                handleValidationError(httpRequest, httpResponse, validationResult);
                return;
            }

            // 4. è®°å½•å®¡è®¡æ—¥å¿—
            auditService.recordRequest(httpRequest);

            // 5. ç»§ç»­å¤„ç†è¯·æ±‚
            chain.doFilter(request, response);

            // 6. è®°å½•å“åº”å®¡è®¡æ—¥å¿—
            auditService.recordResponse(httpRequest, httpResponse);

        } catch (Exception e) {
            log.error("APIå®‰å…¨è¿‡æ»¤å™¨å¼‚å¸¸", e);
            handleSecurityException(httpRequest, httpResponse, e);
        }
    }

    /**
     * æ£€æŸ¥é€Ÿç‡é™åˆ¶
     */
    private boolean checkRateLimit(HttpServletRequest request) {
        String clientIp = getClientIp(request);
        String endpoint = request.getRequestURI();

        // åŸºäºIPçš„é™åˆ¶
        boolean ipAllowed = rateLimiterManager.tryAcquire(
                "api_rate_limit_ip:" + clientIp,
                100.0, // æ¯ç§’100æ¬¡è¯·æ±‚
                1,
                1,
                TimeUnit.SECONDS);

        if (!ipAllowed) {
            log.warn("IPé€Ÿç‡é™åˆ¶è§¦å‘: ip={}, endpoint={}", clientIp, endpoint);
            return false;
        }

        // åŸºäºç”¨æˆ·çš„é™åˆ¶ï¼ˆå¦‚æœå·²è®¤è¯ï¼‰
        String userId = getUserId(request);
        if (userId != null) {
            boolean userAllowed = rateLimiterManager.tryAcquire(
                    "api_rate_limit_user:" + userId,
                    50.0, // æ¯ç§’50æ¬¡è¯·æ±‚
                    1,
                    1,
                    TimeUnit.SECONDS);

            if (!userAllowed) {
                log.warn("ç”¨æˆ·é€Ÿç‡é™åˆ¶è§¦å‘: userId={}, endpoint={}", userId, endpoint);
                return false;
            }
        }

        // åŸºäºæ¥å£çš„é™åˆ¶
        boolean endpointAllowed = rateLimiterManager.tryAcquire(
                "api_rate_limit_endpoint:" + endpoint,
                20.0, // æ¯ç§’20æ¬¡è¯·æ±‚
                1,
                1,
                TimeUnit.SECONDS);

        if (!endpointAllowed) {
            log.warn("æ¥å£é€Ÿç‡é™åˆ¶è§¦å‘: endpoint={}", endpoint);
            return false;
        }

        return true;
    }

    /**
     * è¯·æ±‚éªŒè¯
     */
    private ValidationResult validateRequest(HttpServletRequest request) {
        ValidationResult result = new ValidationResult();

        // 1. æ£€æŸ¥è¯·æ±‚æ–¹æ³•
        String method = request.getMethod();
        if (!isValidHttpMethod(method)) {
            result.addError("ä¸æ”¯æŒçš„HTTPæ–¹æ³•: " + method);
        }

        // 2. æ£€æŸ¥Content-Type
        String contentType = request.getContentType();
        if (contentType != null && !isValidContentType(contentType)) {
            result.addError("ä¸æ”¯æŒçš„Content-Type: " + contentType);
        }

        // 3. æ£€æŸ¥è¯·æ±‚å¤´
        validateHeaders(request, result);

        // 4. æ£€æŸ¥è¯·æ±‚ä½“å¤§å°
        long contentLength = request.getContentLengthLong();
        if (contentLength > 10 * 1024 * 1024) { // 10MBé™åˆ¶
            result.addError("è¯·æ±‚ä½“è¿‡å¤§: " + contentLength + " bytes");
        }

        // 5. SQLæ³¨å…¥æ£€æµ‹
        String queryString = request.getQueryString();
        if (queryString != null && containsSqlInjection(queryString)) {
            result.addError("æ£€æµ‹åˆ°SQLæ³¨å…¥å°è¯•");
        }

        return result;
    }

    /**
     * SQLæ³¨å…¥æ£€æµ‹
     */
    private boolean containsSqlInjection(String input) {
        String[] sqlPatterns = {
                "('|(\\-\\-)|(;)|(\\||\\|)|(\\*|\\*))",
                "EXEC(\\s)*(\\()",
                "UNION(\\s)*(ALL)*(\\s)*(SELECT)",
                "SELECT(\\s)*(\\*)",
                "INSERT(\\s)+(INTO)",
                "DELETE(\\s)+(FROM)",
                "UPDATE(\\s)+(SET)",
                "CREATE(\\s)+(TABLE)",
                "DROP(\\s)+(TABLE)"
        };

        for (String pattern : sqlPatterns) {
            if (input.toUpperCase().matches(".*" + pattern + ".*")) {
                return true;
            }
        }
        return false;
    }

    /**
     * å¤„ç†å¨èƒ
     */
    private void handleThreat(HttpServletRequest request, HttpServletResponse response,
                              ThreatDetectionResult threatResult) {
        try {
            // è®°å½•å¨èƒäº‹ä»¶
            auditService.recordThreatEvent(request, threatResult);

            // æ‹‰é»‘IP
            if (threatResult.getThreatLevel() == ThreatLevel.HIGH) {
                blacklistService.blacklistIp(getClientIp(request), 3600); // æ‹‰é»‘1å°æ—¶
            }

            // è¿”å›é”™è¯¯å“åº”
            response.setStatus(HttpServletResponse.SC_FORBIDDEN);
            response.setContentType("application/json;charset=UTF-8");
            response.getWriter().write(JsonUtils.toJson(ApiResult.error("è¯·æ±‚è¢«æ‹’ç»")));

        } catch (Exception e) {
            log.error("å¤„ç†å¨èƒäº‹ä»¶å¤±è´¥", e);
        }
    }
}
```

#### æ•°æ®è„±æ•å’ŒåŠ å¯†

**æ•æ„Ÿæ•°æ®å¤„ç†å™¨**ï¼š
```java
@Component
@Slf4j
public class SensitiveDataProcessor {

    @Resource
    private EncryptionService encryptionService;

    @Resource
    private DataMaskingService dataMaskingService;

    /**
     * æ•°æ®åŠ å¯†
     */
    public String encryptSensitiveData(String data, SensitiveDataType dataType) {
        try {
            switch (dataType) {
                case PASSWORD:
                    return encryptionService.encryptPassword(data);
                case PHONE:
                    return encryptionService.encryptPhone(data);
                case EMAIL:
                    return encryptionService.encryptEmail(data);
                case ID_CARD:
                    return encryptionService.encryptIdCard(data);
                case BANK_CARD:
                    return encryptionService.encryptBankCard(data);
                default:
                    return encryptionService.encrypt(data);
            }
        } catch (Exception e) {
            log.error("æ•æ„Ÿæ•°æ®åŠ å¯†å¤±è´¥: dataType={}", dataType, e);
            throw new EncryptionException("æ•°æ®åŠ å¯†å¤±è´¥", e);
        }
    }

    /**
     * æ•°æ®è§£å¯†
     */
    public String decryptSensitiveData(String encryptedData, SensitiveDataType dataType) {
        try {
            switch (dataType) {
                case PASSWORD:
                    return encryptionService.decryptPassword(encryptedData);
                case PHONE:
                    return encryptionService.decryptPhone(encryptedData);
                case EMAIL:
                    return encryptionService.decryptEmail(encryptedData);
                case ID_CARD:
                    return encryptionService.decryptIdCard(encryptedData);
                case BANK_CARD:
                    return encryptionService.decryptBankCard(encryptedData);
                default:
                    return encryptionService.decrypt(encryptedData);
            }
        } catch (Exception e) {
            log.error("æ•æ„Ÿæ•°æ®è§£å¯†å¤±è´¥: dataType={}", dataType, e);
            throw new DecryptionException("æ•°æ®è§£å¯†å¤±è´¥", e);
        }
    }

    /**
     * æ•°æ®è„±æ•
     */
    public String maskSensitiveData(String data, SensitiveDataType dataType) {
        if (data == null || data.isEmpty()) {
            return data;
        }

        try {
            switch (dataType) {
                case PHONE:
                    return dataMaskingService.maskPhone(data);
                case EMAIL:
                    return dataMaskingService.maskEmail(data);
                case ID_CARD:
                    return dataMaskingService.maskIdCard(data);
                case BANK_CARD:
                    return dataMaskingService.maskBankCard(data);
                case NAME:
                    return dataMaskingService.maskName(data);
                case ADDRESS:
                    return dataMaskingService.maskAddress(data);
                default:
                    return dataMaskingService.mask(data, "***");
            }
        } catch (Exception e) {
            log.error("æ•°æ®è„±æ•å¤±è´¥: dataType={}", dataType, e);
            return "***MASKED***";
        }
    }

    /**
     * æ³¨è§£å¼æ•°æ®è„±æ•
     */
    @Around("@annotation(sensitiveData)")
    public Object around(ProceedingJoinPoint joinPoint, SensitiveData sensitiveData)
            throws Throwable {

        // è·å–æ–¹æ³•è¿”å›å€¼
        Object result = joinPoint.proceed();

        if (result instanceof String) {
            // å­—ç¬¦ä¸²ç±»å‹ç›´æ¥è„±æ•
            String maskedData = maskSensitiveData((String) result, sensitiveData.type());
            return maskedData;
        } else if (result instanceof Map) {
            // Mapç±»å‹é€’å½’è„±æ•
            Map<?, ?> resultMap = (Map<?, ?>) result;
            Map<String, Object> maskedMap = new HashMap<>();

            for (Map.Entry<?, ?> entry : resultMap.entrySet()) {
                if (entry.getValue() instanceof String) {
                    String maskedValue = maskSensitiveData(
                            (String) entry.getValue(), sensitiveData.type());
                    maskedMap.put((String) entry.getKey(), maskedValue);
                } else {
                    maskedMap.put((String) entry.getKey(), entry.getValue());
                }
            }
            return maskedMap;
        }

        return result;
    }
}

@Target({ElementType.METHOD, ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface SensitiveData {
    SensitiveDataType type();
    boolean maskResponse() default true;
}

public enum SensitiveDataType {
    PASSWORD, PHONE, EMAIL, ID_CARD, BANK_CARD, NAME, ADDRESS
}
```

### ğŸ”’ ç½‘ç»œå®‰å…¨é˜²æŠ¤èƒ½åŠ› (â˜…â˜…â˜…)

#### WAFé˜²æŠ¤é…ç½®

**Webåº”ç”¨é˜²ç«å¢™**ï¼š
```java
@Component
@Slf4j
public class WebApplicationFirewall {

    @Resource
    private RuleEngine ruleEngine;

    @Resource
    private IpWhitelistService ipWhitelistService;

    @Resource
    private SecurityPolicyService securityPolicyService;

    /**
     * WAFè¯·æ±‚æ£€æµ‹
     */
    public WafResult inspectRequest(HttpServletRequest request) {
        try {
            WafContext context = buildWafContext(request);

            // 1. IPç™½åå•æ£€æŸ¥
            if (!checkIpWhitelist(context.getClientIp())) {
                return WafResult.blocked("IPä¸åœ¨ç™½åå•ä¸­");
            }

            // 2. è§„åˆ™å¼•æ“æ£€æµ‹
            RuleEngineResult ruleResult = ruleEngine.evaluate(context);
            if (ruleResult.isBlocked()) {
                return WafResult.blocked(ruleResult.getReason());
            }

            // 3. å®‰å…¨ç­–ç•¥æ£€æŸ¥
            PolicyResult policyResult = securityPolicyService.evaluate(context);
            if (policyResult.isBlocked()) {
                return WafResult.blocked(policyResult.getReason());
            }

            return WafResult.allowed();

        } catch (Exception e) {
            log.error("WAFæ£€æµ‹å¼‚å¸¸", e);
            // å¼‚å¸¸æƒ…å†µä¸‹é»˜è®¤å…è®¸ï¼Œé¿å…å½±å“ä¸šåŠ¡
            return WafResult.allowed();
        }
    }

    /**
     * æ„å»ºWAFä¸Šä¸‹æ–‡
     */
    private WafContext buildWafContext(HttpServletRequest request) {
        return WafContext.builder()
                .clientIp(getClientIp(request))
                .userAgent(request.getHeader("User-Agent"))
                .method(request.getMethod())
                .uri(request.getRequestURI())
                .queryString(request.getQueryString())
                .headers(getHeaders(request))
                .parameters(getParameters(request))
                .body(getRequestBody(request))
                .build();
    }

    /**
     * æ£€æŸ¥IPç™½åå•
     */
    private boolean checkIpWhitelist(String clientIp) {
        // å¦‚æœç™½åå•ä¸ºç©ºï¼Œåˆ™å…è®¸æ‰€æœ‰IP
        List<String> whitelist = ipWhitelistService.getWhitelist();
        if (whitelist.isEmpty()) {
            return true;
        }

        // æ£€æŸ¥IPæ˜¯å¦åœ¨ç™½åå•ä¸­
        return whitelist.contains(clientIp);
    }
}
```

#### å®‰å…¨è§„åˆ™å¼•æ“

**å®‰å…¨è§„åˆ™é…ç½®**ï¼š
```java
@Configuration
public class SecurityRuleConfiguration {

    @Bean
    public RuleEngine securityRuleEngine() {
        RuleEngine engine = new RuleEngine();

        // SQLæ³¨å…¥æ£€æµ‹è§„åˆ™
        engine.addRule(new SqlInjectionRule());

        // XSSæ”»å‡»æ£€æµ‹è§„åˆ™
        engine.addRule(new XssAttackRule());

        // è·¯å¾„éå†æ£€æµ‹è§„åˆ™
        engine.addRule(new PathTraversalRule());

        // å‘½ä»¤æ³¨å…¥æ£€æµ‹è§„åˆ™
        engine.addRule(new CommandInjectionRule());

        // æ–‡ä»¶ä¸Šä¼ æ£€æµ‹è§„åˆ™
        engine.addRule(new FileUploadRule());

        // æ¶æ„æ‰«ææ£€æµ‹è§„åˆ™
        engine.addRule(new MaliciousScanRule());

        return engine;
    }
}

@Component
public class SqlInjectionRule implements SecurityRule {

    private static final Pattern SQL_PATTERN = Pattern.compile(
            "(?i)(\\b(select|insert|update|delete|drop|alter|create|exec|execute)\\b|" +
            "\\b(union|and|or|where|having|group by|order by)\\b|" +
            "(\\*|=|like|>|<|>=|<=|<>|!=|between|in|exists)" +
            "['\"]?\\s*\\([^)]*\\))");

    @Override
    public RuleResult evaluate(WafContext context) {
        String input = context.getQueryString() + " " +
                       String.join(" ", context.getParameters().values());

        Matcher matcher = SQL_PATTERN.matcher(input);
        if (matcher.find()) {
            return RuleResult.blocked("æ£€æµ‹åˆ°SQLæ³¨å…¥å°è¯•: " + matcher.group());
        }

        return RuleResult.allowed();
    }
}
```

---

## ğŸ› ï¸ æ“ä½œæ­¥éª¤

### 1. å®‰å…¨æ¶æ„éƒ¨ç½²

#### æ­¥éª¤1: å®‰å…¨ä¸­é—´ä»¶éƒ¨ç½²
```yaml
# å®‰å…¨ä¸­é—´ä»¶é…ç½®
security:
  # è®¤è¯é…ç½®
  authentication:
    enabled: true
    jwt-secret: ${JWT_SECRET:ioe-dream-jwt-secret-2025}
    token-expiration: 86400  # 24å°æ—¶

  # æˆæƒé…ç½®
  authorization:
    enabled: true
    role-hierarchy-enabled: true
    permission-check-enabled: true

  # APIå®‰å…¨é…ç½®
  api-security:
    rate-limiting:
      enabled: true
      default-limit: 100  # æ¯åˆ†é’Ÿ100æ¬¡
    cors:
      enabled: true
      allowed-origins: ${CORS_ORIGINS:http://localhost:8081}
    encryption:
      enabled: true
      algorithm: AES-256-GCM

  # æ•°æ®å®‰å…¨é…ç½®
  data-security:
    encryption:
      enabled: true
      key-rotation-interval: 30  # 30å¤©
    masking:
      enabled: true
      default-mask: "***"
    audit:
      enabled: true
      log-level: INFO

  # ç½‘ç»œå®‰å…¨é…ç½®
  network-security:
    waf:
      enabled: true
      rule-update-interval: 3600  # 1å°æ—¶
    ip-whitelist:
      enabled: true
      default-policy: DENY
    ddos-protection:
      enabled: true
      threshold: 1000  # æ¯ç§’1000æ¬¡è¯·æ±‚
```

#### æ­¥éª¤2: SSL/TLSé…ç½®
```yaml
# HTTPSé…ç½®
server:
  port: 8443
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: ${SSL_KEYSTORE_PASSWORD}
    key-store-type: PKCS12
    key-alias: ioe-dream
    trust-store: classpath:truststore.p12
    trust-store-password: ${SSL_TRUSTSTORE_PASSWORD}
    trust-store-type: PKCS12

# HTTPé‡å®šå‘åˆ°HTTPS
server:
  port: 8080
  http:
    port: 8080
  ssl:
    port: 8443
```

### 2. å®‰å…¨ç›‘æ§éƒ¨ç½²

#### æ­¥éª¤1: å®‰å…¨äº‹ä»¶ç›‘æ§
```java
@Component
@Slf4j
public class SecurityEventMonitor {

    @Resource
    private AlertService alertService;

    @Resource
    private SecurityAnalysisService analysisService;

    @EventListener
    public void handleSecurityEvent(SecurityEvent event) {
        try {
            // è®°å½•å®‰å…¨äº‹ä»¶
            logSecurityEvent(event);

            // åˆ†æå¨èƒç­‰çº§
            ThreatLevel threatLevel = analysisService.analyzeThreatLevel(event);

            // æ ¹æ®å¨èƒç­‰çº§é‡‡å–è¡ŒåŠ¨
            switch (threatLevel) {
                case CRITICAL:
                    handleCriticalThreat(event);
                    break;
                case HIGH:
                    handleHighThreat(event);
                    break;
                case MEDIUM:
                    handleMediumThreat(event);
                    break;
                case LOW:
                    handleLowThreat(event);
                    break;
            }

        } catch (Exception e) {
            log.error("å¤„ç†å®‰å…¨äº‹ä»¶å¼‚å¸¸", e);
        }
    }

    /**
     * å¤„ç†å…³é”®å¨èƒ
     */
    private void handleCriticalThreat(SecurityEvent event) {
        // ç«‹å³å‘Šè­¦
        alertService.sendCriticalAlert("å‘ç°å…³é”®å®‰å…¨å¨èƒ", event);

        // è‡ªåŠ¨é˜»æ–­IP
        blockIpAddress(event.getClientIp(), 7200); // é˜»æ–­2å°æ—¶

        // å¢åŠ ç›‘æ§çº§åˆ«
        increaseMonitoringLevel(event.getServiceName());

        // é€šçŸ¥å®‰å…¨å›¢é˜Ÿ
        notifySecurityTeam(event);
    }

    /**
     * å¢åŠ ç›‘æ§çº§åˆ«
     */
    private void increaseMonitoringLevel(String serviceName) {
        // å¢åŠ è¯¥æœåŠ¡çš„æ—¥å¿—çº§åˆ«
        loggingService.setLogLevel(serviceName, "DEBUG");

        // å¢åŠ é‡‡æ ·ç‡
        monitoringService.increaseSamplingRate(serviceName, 1.0);

        // å¯ç”¨è¯¦ç»†ç›‘æ§
        monitoringService.enableDetailedMonitoring(serviceName);
    }
}
```

### 3. å®‰å…¨åˆè§„æ£€æŸ¥

#### æ­¥éª¤1: å®‰å…¨åˆè§„æ‰«æ
```java
@Component
@Slf4j
public class SecurityComplianceScanner {

    @Resource
    private VulnerabilityScanner vulnerabilityScanner;

    @Resource
    private ConfigurationAuditor configurationAuditor;

    /**
     * æ‰§è¡Œå®‰å…¨åˆè§„æ‰«æ
     */
    public ComplianceScanResult performComplianceScan() {
        try {
            ComplianceScanResult result = new ComplianceScanResult();

            // 1. æ¼æ´æ‰«æ
            List<Vulnerability> vulnerabilities = vulnerabilityScanner.scan();
            result.setVulnerabilities(vulnerabilities);

            // 2. é…ç½®å®¡è®¡
            List<ConfigurationIssue> configIssues = configurationAuditor.audit();
            result.setConfigurationIssues(configIssues);

            // 3. æƒé™æ£€æŸ¥
            List<PermissionIssue> permissionIssues = checkPermissions();
            result.setPermissionIssues(permissionIssues);

            // 4. æ•°æ®å®‰å…¨æ£€æŸ¥
            List<DataSecurityIssue> dataSecurityIssues = checkDataSecurity();
            result.setDataSecurityIssues(dataSecurityIssues);

            // 5. ç½‘ç»œå®‰å…¨æ£€æŸ¥
            List<NetworkSecurityIssue> networkIssues = checkNetworkSecurity();
            result.setNetworkSecurityIssues(networkIssues);

            // 6. ç”Ÿæˆåˆè§„æŠ¥å‘Š
            generateComplianceReport(result);

            return result;

        } catch (Exception e) {
            log.error("å®‰å…¨åˆè§„æ‰«æå¤±è´¥", e);
            return ComplianceScanResult.error(e);
        }
    }

    /**
     * æ£€æŸ¥æ•°æ®å®‰å…¨
     */
    private List<DataSecurityIssue> checkDataSecurity() {
        List<DataSecurityIssue> issues = new ArrayList<>();

        // æ£€æŸ¥æ•æ„Ÿæ•°æ®åŠ å¯†
        issues.addAll(checkSensitiveDataEncryption());

        // æ£€æŸ¥ä¼ è¾“å®‰å…¨
        issues.addAll(checkTransmissionSecurity());

        // æ£€æŸ¥æ•°æ®è„±æ•
        issues.addAll(checkDataMasking());

        // æ£€æŸ¥è®¿é—®æ—¥å¿—
        issues.addAll(checkAccessLogging());

        return issues;
    }

    /**
     * æ£€æŸ¥æ•æ„Ÿæ•°æ®åŠ å¯†
     */
    private List<DataSecurityIssue> checkSensitiveDataEncryption() {
        List<DataSecurityIssue> issues = new ArrayList<>();

        // æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ•æ„Ÿå­—æ®µ
        List<String> sensitiveColumns = Arrays.asList("password", "phone", "email", "id_card");

        for (String column : sensitiveColumns) {
            if (!isColumnEncrypted(column)) {
                issues.add(DataSecurityIssue.builder()
                        .type("UNENCRYPTED_SENSITIVE_DATA")
                        .description("æ•æ„Ÿå­—æ®µæœªåŠ å¯†: " + column)
                        .severity(Severity.HIGH)
                        .recommendation("å¯¹æ•æ„Ÿå­—æ®µè¿›è¡ŒåŠ å¯†å­˜å‚¨")
                        .build());
            }
        }

        return issues;
    }
}
```

---

## ğŸ“š çŸ¥è¯†è¦æ±‚

### ç†è®ºçŸ¥è¯†
- **ä¿¡æ¯å®‰å…¨åŸºç¡€**: æŒæ¡CIAä¸‰å…ƒç»„ï¼ˆä¿å¯†æ€§ã€å®Œæ•´æ€§ã€å¯ç”¨æ€§ï¼‰
- **ç½‘ç»œå®‰å…¨åŸç†**: æ·±å…¥ç†è§£TCP/IPåè®®ã€HTTP/HTTPSã€é˜²ç«å¢™ç­‰
- **åŠ å¯†ç®—æ³•**: ç†Ÿæ‚‰å¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ã€å“ˆå¸Œç®—æ³•ç­‰
- **è®¤è¯æˆæƒç†è®º**: æŒæ¡OAuth2ã€JWTã€RBACç­‰è®¤è¯æˆæƒæ¨¡å‹

### ä¸šåŠ¡ç†è§£
- **IOE-DREAMå®‰å…¨éœ€æ±‚**: ç†è§£é—¨ç¦ã€æ¶ˆè´¹ã€è€ƒå‹¤ç­‰ä¸šåŠ¡çš„å®‰å…¨è¦æ±‚
- **æ•°æ®åˆ†ç±»æ ‡å‡†**: æŒæ¡æ•æ„Ÿæ•°æ®åˆ†ç±»å’Œä¿æŠ¤è¦æ±‚
- **åˆè§„æ€§è¦æ±‚**: äº†è§£æ•°æ®å®‰å…¨æ³•ã€ç½‘ç»œå®‰å…¨æ³•ç­‰æ³•è§„è¦æ±‚
- **å®‰å…¨ç­‰çº§ä¿æŠ¤**: ç†è§£ç­‰ä¿2.0/3.0çš„å®‰å…¨è¦æ±‚

### æŠ€æœ¯èƒŒæ™¯
- **Spring Security**: ç²¾é€šSpring Securityæ¡†æ¶çš„ä½¿ç”¨å’Œæ‰©å±•
- **Sa-Token**: ç†Ÿç»ƒä½¿ç”¨Sa-Tokenè¿›è¡Œæƒé™æ§åˆ¶
- **ç½‘ç»œå®‰å…¨å·¥å…·**: æŒæ¡WAFã€IDS/IPSç­‰ç½‘ç»œå®‰å…¨å·¥å…·
- **åŠ å¯†æŠ€æœ¯**: ç†Ÿæ‚‰JavaåŠ å¯†ä½“ç³»å’Œç¬¬ä¸‰æ–¹åŠ å¯†åº“

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨åŸåˆ™
- **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·å’Œç³»ç»Ÿåªæˆäºˆå¿…è¦çš„æœ€å°æƒé™
- **çºµæ·±é˜²å¾¡**: é‡‡ç”¨å¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤æªæ–½
- **é›¶ä¿¡ä»»æ¶æ„**: ä¸ä¿¡ä»»ä»»ä½•å†…éƒ¨ç½‘ç»œå’Œç”¨æˆ·
- **å®‰å…¨é»˜è®¤**: é»˜è®¤é…ç½®åº”è¯¥æ˜¯å®‰å…¨çš„ï¼Œè€Œä¸æ˜¯æ–¹ä¾¿çš„

### æ€§èƒ½è€ƒè™‘
- **å®‰å…¨å¼€é”€**: å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œé¿å…è¿‡åº¦é˜²æŠ¤
- **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘å®‰å…¨æ£€æŸ¥çš„æ€§èƒ½å½±å“
- **å¼‚æ­¥å¤„ç†**: å¯¹äºéå…³é”®çš„å®‰å…¨æ£€æŸ¥ï¼Œé‡‡ç”¨å¼‚æ­¥å¤„ç†
- **ä¼˜åŒ–ç®—æ³•**: ä¼˜åŒ–åŠ å¯†å’Œå“ˆå¸Œç®—æ³•çš„æ€§èƒ½

### è¿ç»´è€ƒè™‘
- **è‡ªåŠ¨åŒ–ç›‘æ§**: å»ºç«‹è‡ªåŠ¨åŒ–çš„å®‰å…¨ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- **å®šæœŸæ‰«æ**: å®šæœŸè¿›è¡Œå®‰å…¨æ¼æ´æ‰«æå’Œæ¸—é€æµ‹è¯•
- **åº”æ€¥å“åº”**: å»ºç«‹å®Œå–„çš„å®‰å…¨äº‹ä»¶åº”æ€¥å“åº”æœºåˆ¶
- **çŸ¥è¯†æ›´æ–°**: åŠæ—¶æ›´æ–°å®‰å…¨çŸ¥è¯†å’Œé˜²æŠ¤æŠ€æœ¯

---

## ğŸ”— ç›¸å…³æŠ€èƒ½

### ç›¸å…³æŠ€èƒ½
- **[æœåŠ¡æ²»ç†ä¸“å®¶](service-governance-expert.md)**: æœåŠ¡ç›‘æ§å’Œæ²»ç†
- **[ç³»ç»Ÿè¿ç»´ä¸“å®¶](intelligent-operations-expert.md)**: ç³»ç»Ÿéƒ¨ç½²å’Œè¿ç»´
- **[æ•°æ®ä¸€è‡´æ€§ä¸“å®¶](data-consistency-expert.md)**: æ•°æ®å®‰å…¨å’Œä¸€è‡´æ€§
- **[è´¨é‡ä¿è¯ä¸“å®¶](quality-assurance-expert.md)**: å®‰å…¨æµ‹è¯•å’Œè´¨é‡ä¿è¯

### è¿›é˜¶è·¯å¾„
- **é¦–å¸­ä¿¡æ¯å®‰å…¨å®˜**: è´Ÿè´£ä¼ä¸šæ•´ä½“ä¿¡æ¯å®‰å…¨æˆ˜ç•¥
- **å®‰å…¨æ¶æ„å¸ˆ**: è´Ÿè´£å®‰å…¨æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹
- **æ¸—é€æµ‹è¯•ä¸“å®¶**: è´Ÿè´£å®‰å…¨æµ‹è¯•å’Œæ¼æ´å‘ç°

### å‚è€ƒèµ„æ–™
- **[OWASP Top 10](https://owasp.org/www-project-top-ten/)**: Webåº”ç”¨å®‰å…¨é£é™©
- **[Spring Securityæ–‡æ¡£](https://spring.io/projects/spring-security)**: Spring Securityå®˜æ–¹æ–‡æ¡£
- **[Sa-Tokenæ–‡æ¡£](https://sa-token.cc/doc.html)**: Sa-Tokenå®Œæ•´ä½¿ç”¨æŒ‡å—
- **[å®‰å…¨å»ºè®¾è§„èŒƒ](../docs/repowiki/zh/content/ç³»ç»Ÿå®‰å…¨è§„èŒƒ.md)**: é¡¹ç›®å®‰å…¨å»ºè®¾æ ‡å‡†

---

**ğŸ’¡ æ ¸å¿ƒç†å¿µ**: å®‰å…¨æ˜¯å¾®æœåŠ¡æ¶æ„çš„ç”Ÿå‘½çº¿ï¼Œé€šè¿‡ç³»ç»ŸåŒ–çš„å®‰å…¨é˜²æŠ¤ä½“ç³»å’ŒæŒç»­çš„å®‰å…¨ç›‘æ§ï¼Œç¡®ä¿ç³»ç»Ÿçš„æœºå¯†æ€§ã€å®Œæ•´æ€§å’Œå¯ç”¨æ€§ï¼Œä¸ºä¸šåŠ¡å‘å±•æä¾›åšå®çš„å®‰å…¨ä¿éšœã€‚