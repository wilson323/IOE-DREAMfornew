# æ•°æ®åº“ç®¡ç†æœåŠ¡ä¸“å®¶æŠ€èƒ½
## Database Service Specialist

**ğŸ¯ æŠ€èƒ½å®šä½**: IOE-DREAMæ™ºæ…§å›­åŒºæ•°æ®åº“ç®¡ç†ä¸“å®¶ï¼Œç²¾é€šæ•°æ®å¤‡ä»½æ¢å¤ã€æ€§èƒ½ç›‘æ§ã€å®¹é‡ç®¡ç†ã€è¿ç§»åŒæ­¥ã€å¥åº·æ£€æŸ¥ç­‰æ ¸å¿ƒæ•°æ®åº“è¿ç»´åŠŸèƒ½

**âš¡ æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜…â˜…â˜…â˜… (é¡¶çº§ä¸“å®¶)
**ğŸ¯ é€‚ç”¨åœºæ™¯**: æ•°æ®åº“è¿ç»´ç®¡ç†ã€æ€§èƒ½ç›‘æ§ä¼˜åŒ–ã€å¤‡ä»½æ¢å¤ç­–ç•¥ã€æ•°æ®è¿ç§»åŒæ­¥ã€å®¹é‡è§„åˆ’ç®¡ç†
**ğŸ“Š æŠ€èƒ½è¦†ç›–**: å¤‡ä»½æ¢å¤ | æ€§èƒ½ç›‘æ§ | å®¹é‡ç®¡ç† | æ•°æ®è¿ç§» | å¥åº·æ£€æŸ¥ | å®‰å…¨å®¡è®¡
**ğŸ”§ æŠ€æœ¯æ ˆ**: Spring Boot 3.5.8 + MySQL 8.0 + Redis + RabbitMQ + Prometheus + Grafana

---

## ğŸ“‹ æŠ€èƒ½æ¦‚è¿°

### **æ ¸å¿ƒä¸“é•¿**
- **æ•°æ®å¤‡ä»½ä½“ç³»**: å…¨é‡å¤‡ä»½ã€å¢é‡å¤‡ä»½ã€å®šæ—¶å¤‡ä»½ã€è‡ªåŠ¨å¤‡ä»½ã€å¼‚åœ°å®¹ç¾
- **æ€§èƒ½ç›‘æ§åˆ†æ**: æ…¢æŸ¥è¯¢ç›‘æ§ã€è¿æ¥æ•°ç›‘æ§ã€å­˜å‚¨ç©ºé—´ç›‘æ§ã€æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- **å®¹é‡ç®¡ç†è§„åˆ’**: å­˜å‚¨å®¹é‡é¢„æµ‹ã€æ‰©å®¹ç­–ç•¥ã€æ¸…ç†ç­–ç•¥ã€ç©ºé—´ä¼˜åŒ–
- **æ•°æ®è¿ç§»åŒæ­¥**: è·¨åº“è¿ç§»ã€æ•°æ®åŒæ­¥ã€ç‰ˆæœ¬å‡çº§ã€ç»“æ„å˜æ›´ç®¡ç†
- **å¥åº·æ£€æŸ¥è¯Šæ–­**: æ•°æ®åº“è¿æ¥æ£€æŸ¥ã€è¡¨ç»“æ„æ£€æŸ¥ã€ç´¢å¼•ä¼˜åŒ–æ£€æŸ¥ã€ä¸€è‡´æ€§æ£€æŸ¥
- **å®‰å…¨å®¡è®¡ç®¡ç†**: è®¿é—®å®¡è®¡ã€æ“ä½œå®¡è®¡ã€æƒé™æ£€æŸ¥ã€å®‰å…¨ç­–ç•¥æ‰§è¡Œ

### **è§£å†³èƒ½åŠ›**
- **æ•°æ®åº“è¿ç»´å¹³å°**: å®Œæ•´çš„ä¼ä¸šçº§æ•°æ®åº“è¿ç»´ç®¡ç†ç³»ç»Ÿå®ç°
- **ç›‘æ§å‘Šè­¦ä½“ç³»**: å…¨æ–¹ä½çš„æ•°æ®åº“æ€§èƒ½ç›‘æ§å’Œæ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ
- **å¤‡ä»½æ¢å¤ç­–ç•¥**: å¤šå±‚æ¬¡çš„æ•°æ®å¤‡ä»½å’Œå¿«é€Ÿæ¢å¤æœºåˆ¶
- **æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**: è‡ªåŠ¨åŒ–çš„æ€§èƒ½é—®é¢˜è¯Šæ–­å’Œä¼˜åŒ–å»ºè®®ç³»ç»Ÿ
- **å®¹é‡è§„åˆ’å·¥å…·**: æ™ºèƒ½çš„å­˜å‚¨å®¹é‡é¢„æµ‹å’Œæ‰©å®¹å†³ç­–æ”¯æŒ

---

## ğŸ¯ ä¸šåŠ¡åœºæ™¯è¦†ç›–

### ğŸ’¾ æ™ºèƒ½å¤‡ä»½æ¢å¤ç³»ç»Ÿ

```java
// æ•°æ®åº“å¤‡ä»½å’Œæ¢å¤æ ¸å¿ƒæµç¨‹
@Service
@Transactional(rollbackFor = Exception.class)
public class DatabaseBackupServiceImpl implements DatabaseBackupService {

    @Resource
    private BackupStrategyManager backupStrategyManager;

    @Resource
    private BackupStorageService backupStorageService;

    @Resource
    private BackupValidationService backupValidationService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public BackupResultVO executeBackup(BackupRequestDTO request) {
        try {
            // 1. éªŒè¯å¤‡ä»½å‚æ•°
            validateBackupRequest(request);

            // 2. ç”Ÿæˆå¤‡ä»½ä»»åŠ¡
            BackupTaskEntity backupTask = createBackupTask(request);
            backupTaskDao.insert(backupTask);

            // 3. æ‰§è¡Œå¤‡ä»½æ“ä½œ
            BackupExecutionResult executionResult = executeBackupOperation(backupTask);

            // 4. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
            BackupValidationResult validation = backupValidationService.validateBackup(
                executionResult.getBackupPath(), backupTask.getBackupType());

            if (!validation.isValid()) {
                throw new BusinessException(ErrorCode.BACKUP_VALIDATION_FAILED,
                    "å¤‡ä»½éªŒè¯å¤±è´¥: " + validation.getFailureReason());
            }

            // 5. å­˜å‚¨å¤‡ä»½æ–‡ä»¶
            BackupStorageResult storageResult = backupStorageService.storeBackup(
                executionResult.getBackupPath(), backupTask);

            // 6. æ›´æ–°å¤‡ä»½ä»»åŠ¡çŠ¶æ€
            updateBackupTaskStatus(backupTask, executionResult, storageResult, validation);

            // 7. å‘é€å¤‡ä»½å®Œæˆäº‹ä»¶
            publishBackupCompletedEvent(backupTask);

            return convertToBackupResultVO(backupTask, executionResult, storageResult);

        } catch (Exception e) {
            log.error("æ•°æ®åº“å¤‡ä»½å¤±è´¥: request={}", request, e);
            throw new BusinessException(ErrorCode.DATABASE_BACKUP_FAILED,
                "æ•°æ®åº“å¤‡ä»½å¤±è´¥", e);
        }
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public RestoreResultVO executeRestore(RestoreRequestDTO request) {
        try {
            // 1. éªŒè¯æ¢å¤å‚æ•°å’Œæƒé™
            validateRestoreRequest(request);

            // 2. è·å–å¤‡ä»½æ–‡ä»¶ä¿¡æ¯
            BackupFileInfo backupInfo = backupStorageService.getBackupInfo(request.getBackupId());

            // 3. åˆ›å»ºæ¢å¤ä»»åŠ¡
            RestoreTaskEntity restoreTask = createRestoreTask(request, backupInfo);
            restoreTaskDao.insert(restoreTask);

            // 4. ä¸‹è½½å¤‡ä»½æ–‡ä»¶
            String localBackupPath = backupStorageService.downloadBackup(backupInfo);

            // 5. æ‰§è¡Œæ¢å¤å‰æ£€æŸ¥
            preRestoreCheck(restoreTask, localBackupPath);

            // 6. æ‰§è¡Œæ•°æ®åº“æ¢å¤
            RestoreExecutionResult executionResult = executeDatabaseRestore(restoreTask, localBackupPath);

            // 7. éªŒè¯æ¢å¤ç»“æœ
            RestoreValidationResult validation = validateRestoreResult(executionResult);

            // 8. æ›´æ–°æ¢å¤ä»»åŠ¡çŠ¶æ€
            updateRestoreTaskStatus(restoreTask, executionResult, validation);

            // 9. å‘é€æ¢å¤å®Œæˆäº‹ä»¶
            publishRestoreCompletedEvent(restoreTask);

            return convertToRestoreResultVO(restoreTask, executionResult, validation);

        } catch (Exception e) {
            log.error("æ•°æ®åº“æ¢å¤å¤±è´¥: request={}", request, e);
            throw new BusinessException(ErrorCode.DATABASE_RESTORE_FAILED,
                "æ•°æ®åº“æ¢å¤å¤±è´¥", e);
        }
    }

    private BackupExecutionResult executeBackupOperation(BackupTaskEntity backupTask) {
        try {
            String backupPath = generateBackupPath(backupTask);

            switch (backupTask.getBackupType()) {
                case FULL:
                    return executeFullBackup(backupTask, backupPath);
                case INCREMENTAL:
                    return executeIncrementalBackup(backupTask, backupPath);
                case DIFFERENTIAL:
                    return executeDifferentialBackup(backupTask, backupPath);
                default:
                    throw new BusinessException(ErrorCode.UNSUPPORTED_BACKUP_TYPE,
                        "ä¸æ”¯æŒçš„å¤‡ä»½ç±»å‹: " + backupTask.getBackupType());
            }

        } catch (Exception e) {
            log.error("å¤‡ä»½æ“ä½œæ‰§è¡Œå¤±è´¥: taskId={}", backupTask.getTaskId(), e);
            throw new BusinessException(ErrorCode.BACKUP_EXECUTION_FAILED,
                "å¤‡ä»½æ“ä½œæ‰§è¡Œå¤±è´¥", e);
        }
    }

    private BackupExecutionResult executeFullBackup(BackupTaskEntity backupTask, String backupPath) {
        log.info("å¼€å§‹æ‰§è¡Œå…¨é‡å¤‡ä»½: taskId={}, backupPath={}", backupTask.getTaskId(), backupPath);

        long startTime = System.currentTimeMillis();

        try {
            // 1. ä½¿ç”¨ mysqldump æ‰§è¡Œå…¨é‡å¤‡ä»½
            ProcessBuilder processBuilder = new ProcessBuilder(
                "mysqldump",
                "--single-transaction",
                "--routines",
                "--triggers",
                "--all-databases",
                "--result-file=" + backupPath,
                "--user=" + getDbUsername(),
                "--password=" + getDbPassword(),
                "--host=" + getDbHost(),
                "--port=" + getDbPort()
            );

            Process process = processBuilder.start();
            int exitCode = process.waitFor();

            if (exitCode != 0) {
                throw new BusinessException(ErrorCode.MYSQLDUMP_FAILED,
                    "mysqldumpæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : " + exitCode);
            }

            // 2. è®¡ç®—å¤‡ä»½æ–‡ä»¶å¤§å°
            File backupFile = new File(backupPath);
            long fileSize = backupFile.length();

            // 3. è®¡ç®—å¤‡ä»½è€—æ—¶
            long duration = System.currentTimeMillis() - startTime;

            // 4. ç”Ÿæˆå¤‡ä»½æ ¡éªŒå’Œ
            String checksum = calculateFileChecksum(backupPath);

            return BackupExecutionResult.builder()
                .backupPath(backupPath)
                .backupSize(fileSize)
                .duration(duration)
                .checksum(checksum)
                .backupType(BackupTypeEnum.FULL.getCode())
                .success(true)
                .completionTime(LocalDateTime.now())
                .build();

        } catch (Exception e) {
            log.error("å…¨é‡å¤‡ä»½æ‰§è¡Œå¤±è´¥: taskId={}", backupTask.getTaskId(), e);
            throw new BusinessException(ErrorCode.FULL_BACKUP_FAILED,
                "å…¨é‡å¤‡ä»½æ‰§è¡Œå¤±è´¥", e);
        }
    }

    private BackupExecutionResult executeIncrementalBackup(BackupTaskEntity backupTask, String backupPath) {
        log.info("å¼€å§‹æ‰§è¡Œå¢é‡å¤‡ä»½: taskId={}, backupPath={}", backupTask.getTaskId(), backupPath);

        long startTime = System.currentTimeMillis();

        try {
            // 1. è·å–ä¸Šæ¬¡å…¨é‡å¤‡ä»½ä¿¡æ¯
            BackupTaskEntity lastFullBackup = getLastFullBackup();
            if (lastFullBackup == null) {
                throw new BusinessException(ErrorCode.NO_FULL_BACKUP_FOUND,
                    "æœªæ‰¾åˆ°ä¸Šæ¬¡å…¨é‡å¤‡ä»½ï¼Œæ— æ³•æ‰§è¡Œå¢é‡å¤‡ä»½");
            }

            // 2. è·å–ä¸Šæ¬¡å¤‡ä»½æ—¶é—´ç‚¹çš„binlogä½ç½®
            BinlogPosition lastBinlogPosition = getBinlogPosition(lastFullBackup.getCompletionTime());

            // 3. ä½¿ç”¨ mysqlbinlog å¯¼å‡ºå¢é‡æ•°æ®
            String binlogBackupPath = executeBinlogBackup(lastBinlogPosition, backupPath);

            // 4. å‹ç¼©å¤‡ä»½æ–‡ä»¶
            String compressedPath = compressBackupFile(binlogBackupPath);

            // 5. è®¡ç®—å¤‡ä»½æ–‡ä»¶å¤§å°å’Œæ ¡éªŒå’Œ
            File backupFile = new File(compressedPath);
            long fileSize = backupFile.length();
            String checksum = calculateFileChecksum(compressedPath);

            long duration = System.currentTimeMillis() - startTime;

            return BackupExecutionResult.builder()
                .backupPath(compressedPath)
                .backupSize(fileSize)
                .duration(duration)
                .checksum(checksum)
                .backupType(BackupTypeEnum.INCREMENTAL.getCode())
                .success(true)
                .completionTime(LocalDateTime.now())
                .baseBackupId(lastFullBackup.getTaskId())
                .build();

        } catch (Exception e) {
            log.error("å¢é‡å¤‡ä»½æ‰§è¡Œå¤±è´¥: taskId={}", backupTask.getTaskId(), e);
            throw new BusinessException(ErrorCode.INCREMENTAL_BACKUP_FAILED,
                "å¢é‡å¤‡ä»½æ‰§è¡Œå¤±è´¥", e);
        }
    }
}
```

### ğŸ“Š æ€§èƒ½ç›‘æ§åˆ†æ

```java
// æ•°æ®åº“æ€§èƒ½ç›‘æ§å’Œåˆ†æå¼•æ“
@Service
public class DatabasePerformanceServiceImpl implements DatabasePerformanceService {

    @Resource
    private MetricsCollector metricsCollector;

    @Resource
    private PerformanceAnalyzer performanceAnalyzer;

    @Resource
    private AlertService alertService;

    /**
     * æ”¶é›†æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void collectPerformanceMetrics() {
        try {
            log.debug("å¼€å§‹æ”¶é›†æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡");

            // 1. æ”¶é›†åŸºç¡€æŒ‡æ ‡
            DatabaseMetrics metrics = collectBasicMetrics();

            // 2. æ”¶é›†æ…¢æŸ¥è¯¢æŒ‡æ ‡
            List<SlowQuery> slowQueries = collectSlowQueries();

            // 3. æ”¶é›†è¿æ¥æ± æŒ‡æ ‡
            ConnectionPoolMetrics connectionPoolMetrics = collectConnectionPoolMetrics();

            // 4. æ”¶é›†å­˜å‚¨æŒ‡æ ‡
            StorageMetrics storageMetrics = collectStorageMetrics();

            // 5. åˆ†ææ€§èƒ½è¶‹åŠ¿
            PerformanceAnalysis analysis = performanceAnalyzer.analyzePerformance(metrics);

            // 6. æ£€æŸ¥å‘Šè­¦æ¡ä»¶
            checkPerformanceAlerts(analysis);

            // 7. å­˜å‚¨æŒ‡æ ‡æ•°æ®
            storePerformanceMetrics(metrics, slowQueries, connectionPoolMetrics, storageMetrics);

            // 8. å‘é€æ€§èƒ½æŠ¥å‘Š
            if (shouldSendPerformanceReport()) {
                sendPerformanceReport(analysis);
            }

        } catch (Exception e) {
            log.error("æ”¶é›†æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡å¤±è´¥", e);
            alertService.sendSystemAlert("æ•°æ®åº“æ€§èƒ½ç›‘æ§å¼‚å¸¸",
                "æ”¶é›†æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡æ—¶å‘ç”Ÿå¼‚å¸¸: " + e.getMessage());
        }
    }

    private DatabaseMetrics collectBasicMetrics() {
        try {
            DatabaseMetrics.Builder builder = DatabaseMetrics.builder();

            // 1. QPSæŒ‡æ ‡
            builder.qps(getCurrentQPS());
            builder.tps(getCurrentTPS());

            // 2. å“åº”æ—¶é—´æŒ‡æ ‡
            builder.avgResponseTime(getAverageResponseTime());
            builder.p95ResponseTime(getPercentileResponseTime(95));
            builder.p99ResponseTime(getPercentileResponseTime(99));

            // 3. é”™è¯¯ç‡æŒ‡æ ‡
            builder.errorRate(getErrorRate());
            builder.timeoutRate(getTimeoutRate());

            // 4. ååé‡æŒ‡æ ‡
            builder.bytesReceived(getBytesReceived());
            builder.bytesSent(getBytesSent());

            // 5. èµ„æºä½¿ç”¨æŒ‡æ ‡
            builder.cpuUsage(getCpuUsage());
            builder.memoryUsage(getMemoryUsage());
            builder.diskIOPS(getDiskIOPS());
            builder.networkIO(getNetworkIO());

            return builder.build();

        } catch (Exception e) {
            log.error("æ”¶é›†åŸºç¡€æ•°æ®åº“æŒ‡æ ‡å¤±è´¥", e);
            throw new BusinessException(ErrorCode.METRICS_COLLECTION_FAILED,
                "æ”¶é›†åŸºç¡€æ•°æ®åº“æŒ‡æ ‡å¤±è´¥", e);
        }
    }

    private List<SlowQuery> collectSlowQueries() {
        try {
            // 1. æŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—
            List<SlowQuery> slowQueries = querySlowQueryLog(getSlowQueryTimeThreshold());

            // 2. åˆ†ææ…¢æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
            for (SlowQuery query : slowQueries) {
                ExecutionPlan executionPlan = analyzeExecutionPlan(query.getSql());
                query.setExecutionPlan(executionPlan);
                query.setOptimizationSuggestions(generateOptimizationSuggestions(executionPlan));
            }

            // 3. æŒ‰æ‰§è¡Œæ—¶é—´æ’åº
            slowQueries.sort((a, b) -> Long.compare(b.getExecutionTime(), a.getExecutionTime()));

            return slowQueries;

        } catch (Exception e) {
            log.error("æ”¶é›†æ…¢æŸ¥è¯¢æŒ‡æ ‡å¤±è´¥", e);
            throw new BusinessException(ErrorCode.SLOW_QUERY_COLLECTION_FAILED,
                "æ”¶é›†æ…¢æŸ¥è¯¢æŒ‡æ ‡å¤±è´¥", e);
        }
    }

    private ConnectionPoolMetrics collectConnectionPoolMetrics() {
        try {
            // 1. è·å–è¿æ¥æ± çŠ¶æ€
            HikariDataSource dataSource = getDataSource();

            HikariPoolMXBean poolProxy = dataSource.getHikariPoolMXBean();

            return ConnectionPoolMetrics.builder()
                .totalConnections(poolProxy.getTotalConnections())
                .activeConnections(poolProxy.getActiveConnections())
                .idleConnections(poolProxy.getIdleConnections())
                .waitingThreads(poolProxy.getThreadsAwaitingConnection())
                .maxPoolSize(poolProxy.getMaximumPoolSize())
                .minIdleSize(poolProxy.getMinimumIdle())
                .poolUtilization(calculatePoolUtilization(poolProxy))
                .avgCheckoutTime(getAvgCheckoutTime(poolProxy))
                .checkoutTimestamp(System.currentTimeMillis())
                .build();

        } catch (Exception e) {
            log.error("æ”¶é›†è¿æ¥æ± æŒ‡æ ‡å¤±è´¥", e);
            throw new BusinessException(ErrorCode.CONNECTION_POOL_METRICS_FAILED,
                "æ”¶é›†è¿æ¥æ± æŒ‡æ ‡å¤±è´¥", e);
        }
    }

    private void checkPerformanceAlerts(PerformanceAnalysis analysis) {
        try {
            List<PerformanceAlert> alerts = new ArrayList<>();

            // 1. æ£€æŸ¥QPSå‘Šè­¦
            if (analysis.getCurrentQPS() > getQPSAlertThreshold()) {
                alerts.add(createPerformanceAlert(
                    AlertType.HIGH_QPS,
                    "QPSè¿‡é«˜",
                    "å½“å‰QPS: " + analysis.getCurrentQPS() + ", é˜ˆå€¼: " + getQPSAlertThreshold(),
                    AlertSeverity.WARNING
                ));
            }

            // 2. æ£€æŸ¥å“åº”æ—¶é—´å‘Šè­¦
            if (analysis.getP95ResponseTime() > getResponseTimeAlertThreshold()) {
                alerts.add(createPerformanceAlert(
                    AlertType.HIGH_RESPONSE_TIME,
                    "å“åº”æ—¶é—´è¿‡é•¿",
                    "P95å“åº”æ—¶é—´: " + analysis.getP95ResponseTime() + "ms, é˜ˆå€¼: " + getResponseTimeAlertThreshold() + "ms",
                    AlertSeverity.CRITICAL
                ));
            }

            // 3. æ£€æŸ¥é”™è¯¯ç‡å‘Šè­¦
            if (analysis.getErrorRate() > getErrorRateAlertThreshold()) {
                alerts.add(createPerformanceAlert(
                    AlertType.HIGH_ERROR_RATE,
                    "é”™è¯¯ç‡è¿‡é«˜",
                    "é”™è¯¯ç‡: " + String.format("%.2f%%", analysis.getErrorRate() * 100) +
                    ", é˜ˆå€¼: " + String.format("%.2f%%", getErrorRateAlertThreshold() * 100),
                    AlertSeverity.CRITICAL
                ));
            }

            // 4. æ£€æŸ¥è¿æ¥æ± å‘Šè­¦
            if (analysis.getConnectionPoolUtilization() > getConnectionPoolAlertThreshold()) {
                alerts.add(createPerformanceAlert(
                    AlertType.HIGH_CONNECTION_POOL_UTILIZATION,
                    "è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜",
                    "ä½¿ç”¨ç‡: " + String.format("%.2f%%", analysis.getConnectionPoolUtilization() * 100) +
                    ", é˜ˆå€¼: " + String.format("%.2f%%", getConnectionPoolAlertThreshold() * 100),
                    AlertSeverity.WARNING
                ));
            }

            // 5. å‘é€å‘Šè­¦
            for (PerformanceAlert alert : alerts) {
                alertService.sendPerformanceAlert(alert);
            }

        } catch (Exception e) {
            log.error("æ£€æŸ¥æ€§èƒ½å‘Šè­¦å¤±è´¥", e);
        }
    }
}
```

### ğŸ“ˆ å®¹é‡ç®¡ç†è§„åˆ’

```java
// æ•°æ®åº“å®¹é‡ç®¡ç†å’Œé¢„æµ‹
@Service
public class DatabaseCapacityServiceImpl implements DatabaseCapacityService {

    @Resource
    private CapacityAnalyzer capacityAnalyzer;

    @Resource
    private CapacityPredictionService predictionService;

    @Resource
    private RecommendationEngine recommendationEngine;

    @Override
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void analyzeCapacity() {
        try {
            log.info("å¼€å§‹æ•°æ®åº“å®¹é‡åˆ†æ");

            // 1. æ”¶é›†å®¹é‡æ•°æ®
            CapacityData currentCapacity = collectCurrentCapacity();

            // 2. åˆ†æä½¿ç”¨è¶‹åŠ¿
            CapacityTrendAnalysis trendAnalysis = analyzeCapacityTrend();

            // 3. é¢„æµ‹æœªæ¥å®¹é‡éœ€æ±‚
            List<CapacityForecast> forecasts = predictionService.predictCapacity(
                currentCapacity, trendAnalysis, 90); // é¢„æµ‹90å¤©

            // 4. ç”Ÿæˆå®¹é‡æŠ¥å‘Š
            CapacityReport report = generateCapacityReport(currentCapacity, trendAnalysis, forecasts);

            // 5. ç”Ÿæˆä¼˜åŒ–å»ºè®®
            List<CapacityRecommendation> recommendations = generateCapacityRecommendations(
                currentCapacity, forecasts);

            // 6. æ£€æŸ¥å‘Šè­¦æ¡ä»¶
            checkCapacityAlerts(currentCapacity, forecasts);

            // 7. å‘é€å®¹é‡æŠ¥å‘Š
            sendCapacityReport(report, recommendations);

            log.info("æ•°æ®åº“å®¹é‡åˆ†æå®Œæˆ: reportId={}", report.getReportId());

        } catch (Exception e) {
            log.error("æ•°æ®åº“å®¹é‡åˆ†æå¤±è´¥", e);
            throw new BusinessException(ErrorCode.CAPACITY_ANALYSIS_FAILED,
                "æ•°æ®åº“å®¹é‡åˆ†æå¤±è´¥", e);
        }
    }

    private CapacityData collectCurrentCapacity() {
        try {
            return CapacityData.builder()
                .totalDatabaseSize(getTotalDatabaseSize())
                .usedSpace(getUsedSpace())
                .freeSpace(getFreeSpace())
                .tableSpaceInfo(getTableSpaceInfo())
                .indexSpaceInfo(getIndexSpaceInfo())
                .logSpaceInfo(getLogSpaceInfo())
                .tempSpaceInfo(getTempSpaceInfo())
                .growthRate(getGrowthRate())
                .collectionTime(LocalDateTime.now())
                .build();

        } catch (Exception e) {
            log.error("æ”¶é›†å®¹é‡æ•°æ®å¤±è´¥", e);
            throw new BusinessException(ErrorCode.CAPACITY_DATA_COLLECTION_FAILED,
                "æ”¶é›†å®¹é‡æ•°æ®å¤±è´¥", e);
        }
    }

    private List<CapacityRecommendation> generateCapacityRecommendations(
            CapacityData currentCapacity, List<CapacityForecast> forecasts) {

        List<CapacityRecommendation> recommendations = new ArrayList<>();

        try {
            // 1. æ£€æŸ¥å­˜å‚¨ç©ºé—´å‘Šè­¦
            double utilizationRate = currentCapacity.getUsedSpace() / (double) currentCapacity.getTotalDatabaseSize();
            if (utilizationRate > getHighUtilizationThreshold()) {
                recommendations.add(CapacityRecommendation.builder()
                    .recommendationType(RecommendationType.STORAGE_EXPANSION)
                    .priority(RecommendationPriority.HIGH)
                    .title("å­˜å‚¨ç©ºé—´æ‰©å®¹å»ºè®®")
                    .description("å½“å‰å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡è¾¾åˆ° " + String.format("%.1f%%", utilizationRate * 100) +
                            "ï¼Œå»ºè®®å°½å¿«æ‰©å®¹ä»¥é¿å…å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ")
                    .estimatedCost(calculateStorageExpansionCost(currentCapacity))
                    .implementationTime("1-2ä¸ªå·¥ä½œæ—¥")
                    .riskLevel("é«˜")
                    .build());
            }

            // 2. æ£€æŸ¥å®¹é‡å¢é•¿è¶‹åŠ¿
            CapacityForecast forecast30Days = forecasts.stream()
                    .filter(f -> f.getForecastDays() == 30)
                    .findFirst()
                    .orElse(null);

            if (forecast30Days != null) {
                double projectedUtilization = forecast30Days.getProjectedUtilization();
                if (projectedUtilization > getWarningThreshold()) {
                    recommendations.add(CapacityRecommendation.builder()
                            .recommendationType(RecommendationType.PROACTIVE_EXPANSION)
                            .priority(RecommendationPriority.MEDIUM)
                            .title("é¢„é˜²æ€§æ‰©å®¹å»ºè®®")
                            .description("æ ¹æ®å¢é•¿è¶‹åŠ¿é¢„æµ‹ï¼Œ30å¤©åå­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡å°†è¾¾åˆ° " +
                                    String.format("%.1f%%", projectedUtilization * 100) +
                                    "ï¼Œå»ºè®®æå‰è§„åˆ’æ‰©å®¹")
                            .estimatedCost(calculateProactiveExpansionCost(forecast30Days))
                            .implementationTime("3-5ä¸ªå·¥ä½œæ—¥")
                            .riskLevel("ä¸­")
                            .build());
                }
            }

            // 3. æ•°æ®æ¸…ç†å»ºè®®
            List<TableSpaceInfo> largeTables = getLargeTablesWithOldData();
            if (!largeTables.isEmpty()) {
                recommendations.add(CapacityRecommendation.builder()
                        .recommendationType(RecommendationType.DATA_CLEANUP)
                        .priority(RecommendationPriority.LOW)
                        .title("å†å²æ•°æ®æ¸…ç†å»ºè®®")
                        .description("å‘ç° " + largeTables.size() + " ä¸ªå¤§è¡¨åŒ…å«å¤§é‡å†å²æ•°æ®ï¼Œ" +
                                "å»ºè®®æ¸…ç†è¿‡æœŸæ•°æ®ä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´")
                        .estimatedSpaceRelease(calculateCleanupSpaceSavings(largeTables))
                        .implementationTime("1-3ä¸ªå·¥ä½œæ—¥")
                        .riskLevel("ä½")
                        .build());
            }

            // 4. ç´¢å¼•ä¼˜åŒ–å»ºè®®
            List<IndexSpaceInfo> unusedIndexes = getUnusedIndexes();
            if (!unusedIndexes.isEmpty()) {
                recommendations.add(CapacityRecommendation.builder()
                        .recommendationType(RecommendationType.INDEX_OPTIMIZATION)
                        .priority(RecommendationPriority.LOW)
                        .title("ç´¢å¼•æ¸…ç†å»ºè®®")
                        .description("å‘ç° " + unusedIndexes.size() + " ä¸ªæœªä½¿ç”¨æˆ–ä½æ•ˆç´¢å¼•ï¼Œ" +
                                "å»ºè®®æ¸…ç†ä»¥é‡Šæ”¾å­˜å‚¨ç©ºé—´å’Œæå‡æ€§èƒ½")
                        .estimatedSpaceRelease(calculateIndexSpaceSavings(unusedIndexes))
                        .implementationTime("1-2ä¸ªå·¥ä½œæ—¥")
                        .riskLevel("ä½")
                        .build());
            }

            return recommendations;

        } catch (Exception e) {
            log.error("ç”Ÿæˆå®¹é‡å»ºè®®å¤±è´¥", e);
            throw new BusinessException(ErrorCode.CAPACITY_RECOMMENDATION_FAILED,
                "ç”Ÿæˆå®¹é‡å»ºè®®å¤±è´¥", e);
        }
    }
}
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡è§„èŒƒ

### å››å±‚æ¶æ„å®ç°

#### Controllerå±‚ - æ¥å£æ§åˆ¶å±‚
```java
@RestController
@RequestMapping("/api/v1/database")
@Tag(name = "æ•°æ®åº“ç®¡ç†")
@Validated
public class DatabaseController {

    @Resource
    private DatabaseBackupService backupService;

    @Resource
    private DatabasePerformanceService performanceService;

    @PostMapping("/backup/execute")
    @Operation(summary = "æ‰§è¡Œæ•°æ®åº“å¤‡ä»½")
    public ResponseDTO<BackupResultVO> executeBackup(@Valid @RequestBody BackupRequestDTO request) {
        BackupResultVO result = backupService.executeBackup(request);
        return ResponseDTO.ok(result);
    }

    @GetMapping("/performance/metrics")
    @Operation(summary = "è·å–æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡")
    public ResponseDTO<DatabaseMetricsVO> getPerformanceMetrics() {
        DatabaseMetricsVO metrics = performanceService.getCurrentMetrics();
        return ResponseDTO.ok(metrics);
    }
}
```

#### Serviceå±‚ - æ ¸å¿ƒä¸šåŠ¡å±‚
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class DatabaseBackupServiceImpl implements DatabaseBackupService {

    @Resource
    private BackupManager backupManager;

    @Override
    public BackupResultVO executeBackup(BackupRequestDTO request) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        validateBackupRequest(request);

        // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        return backupManager.executeBackup(request);
    }

    private void validateBackupRequest(BackupRequestDTO request) {
        // éªŒè¯å¤‡ä»½æƒé™
        if (!hasBackupPermission(request.getUserId())) {
            throw new BusinessException(ErrorCode.BACKUP_PERMISSION_DENIED,
                "ç”¨æˆ·æ— å¤‡ä»½æƒé™");
        }

        // éªŒè¯å¤‡ä»½ç±»å‹æ”¯æŒ
        if (!isBackupTypeSupported(request.getBackupType())) {
            throw new BusinessException(ErrorCode.UNSUPPORTED_BACKUP_TYPE,
                "ä¸æ”¯æŒçš„å¤‡ä»½ç±»å‹");
        }
    }
}
```

---

## ğŸ“Š æŠ€èƒ½è´¨é‡æŒ‡æ ‡ä½“ç³»

### æ ¸å¿ƒè´¨é‡æŒ‡æ ‡
| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | è¯´æ˜ | æµ‹é‡æ–¹æ³• |
|---------|--------|------|----------|
| **å¤‡ä»½æˆåŠŸç‡** | â‰¥99.9% | æ•°æ®åº“å¤‡ä»½æ“ä½œæˆåŠŸç‡ | å¤‡ä»½ç›‘æ§ |
| **æ¢å¤æˆåŠŸç‡** | â‰¥99.95% | æ•°æ®åº“æ¢å¤æ“ä½œæˆåŠŸç‡ | æ¢å¤æµ‹è¯• |
| **å¤‡ä»½RTO** | â‰¤30åˆ†é’Ÿ | æ¢å¤æ—¶é—´ç›®æ ‡ | æ¢å¤æ¼”ç»ƒ |
| **å¤‡ä»½RPO** | â‰¤15åˆ†é’Ÿ | æ¢å¤ç‚¹ç›®æ ‡ | å¤‡ä»½é¢‘ç‡éªŒè¯ |
| **ç›‘æ§è¦†ç›–ç‡** | 100% | ç›‘æ§æŒ‡æ ‡è¦†ç›–æ¯”ä¾‹ | ç›‘æ§å®¡è®¡ |

### æ€§èƒ½æŒ‡æ ‡
| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | è¯´æ˜ | æµ‹é‡æ–¹æ³• |
|---------|--------|------|----------|
| **ç›‘æ§æ•°æ®æ”¶é›†å»¶è¿Ÿ** | â‰¤1ç§’ | ç›‘æ§æ•°æ®æ”¶é›†å»¶è¿Ÿ | æ€§èƒ½ç›‘æ§ |
| **å‘Šè­¦å“åº”æ—¶é—´** | â‰¤30ç§’ | å‘Šè­¦è§¦å‘å“åº”æ—¶é—´ | å‘Šè­¦æµ‹è¯• |
| **å®¹é‡é¢„æµ‹å‡†ç¡®ç‡** | â‰¥85% | å®¹é‡é¢„æµ‹å‡†ç¡®ç‡ | é¢„æµ‹éªŒè¯ |
| **æ€§èƒ½åˆ†æå“åº”æ—¶é—´** | â‰¤5ç§’ | æ€§èƒ½åˆ†æå¤„ç†æ—¶é—´ | æ€§èƒ½æµ‹è¯• |
| **å¤‡ä»½æ–‡ä»¶å‹ç¼©ç‡** | â‰¥60% | å¤‡ä»½æ–‡ä»¶å‹ç¼©æ¯”ä¾‹ | å‹ç¼©æµ‹è¯• |

### å¯é æ€§æŒ‡æ ‡
| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | è¯´æ˜ | æµ‹é‡æ–¹æ³• |
|---------|--------|------|----------|
| **æœåŠ¡å¯ç”¨æ€§** | â‰¥99.9% | æ•°æ®åº“ç®¡ç†æœåŠ¡å¯ç”¨æ€§ | å¯ç”¨æ€§ç›‘æ§ |
| **ç›‘æ§æ•°æ®å®Œæ•´æ€§** | 100% | ç›‘æ§æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ | æ•°æ®éªŒè¯ |
| **å¤‡ä»½æ•°æ®ä¸€è‡´æ€§** | 100% | å¤‡ä»½æ•°æ®ä¸€è‡´æ€§éªŒè¯ | ä¸€è‡´æ€§æµ‹è¯• |
| **æ•…éšœæ¢å¤æ—¶é—´** | â‰¤5åˆ†é’Ÿ | æœåŠ¡æ•…éšœæ¢å¤æ—¶é—´ | æ•…éšœæ¼”ç»ƒ |
| **å‘Šè­¦å‡†ç¡®ç‡** | â‰¥95% | å‘Šè­¦å‡†ç¡®ç‡ç»Ÿè®¡ | å‘Šè­¦åˆ†æ |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£å‚è€ƒ

### æ ¸å¿ƒæ¶æ„æ–‡æ¡£
- **ğŸ“‹ CLAUDE.md**: å…¨å±€æ¶æ„è§„èŒƒ (å¼ºåˆ¶éµå¾ª)
- **ğŸ—ï¸ å››å±‚æ¶æ„è¯¦è§£**: Controllerâ†’Serviceâ†’Managerâ†’DAOæ¶æ„æ¨¡å¼
- **ğŸ”§ ä¾èµ–æ³¨å…¥è§„èŒƒ**: ç»Ÿä¸€ä½¿ç”¨@Resourceæ³¨è§£
- **ğŸ“¦ DAOå±‚è§„èŒƒ**: ç»Ÿä¸€ä½¿ç”¨Daoåç¼€å’Œ@Mapperæ³¨è§£

### æŠ€æœ¯æ ˆæ–‡æ¡£
- **Spring Boot 3.5.8**: å¾®æœåŠ¡æ¡†æ¶æ–‡æ¡£
- **MySQL 8.0**: å…³ç³»æ•°æ®åº“æ–‡æ¡£
- **Redis**: åˆ†å¸ƒå¼ç¼“å­˜å’Œç›‘æ§æ•°æ®å­˜å‚¨æ–‡æ¡£
- **Prometheus**: ç›‘æ§æŒ‡æ ‡æ”¶é›†æ–‡æ¡£
- **Grafana**: ç›‘æ§å¯è§†åŒ–æ–‡æ¡£

### è¿ç»´ç®¡ç†æ–‡æ¡£
- **ğŸ“Š ç›‘æ§ç®¡ç†ç³»ç»Ÿ**: æ•°æ®åº“æ€§èƒ½ç›‘æ§ç›¸å…³ä¸šåŠ¡
- **ğŸ’¾ å¤‡ä»½æ¢å¤ç³»ç»Ÿ**: æ•°æ®å¤‡ä»½å’Œæ¢å¤ä¸šåŠ¡
- **ğŸ“ˆ å®¹é‡è§„åˆ’ç³»ç»Ÿ**: æ•°æ®åº“å®¹é‡ç®¡ç†ä¸šåŠ¡
- **ğŸ” å¥åº·æ£€æŸ¥ç³»ç»Ÿ**: æ•°æ®åº“å¥åº·æ£€æŸ¥ä¸šåŠ¡

### å®‰å…¨è§„èŒƒæ–‡æ¡£
- **ğŸ”’ æ•°æ®è®¿é—®å®‰å…¨è§„èŒƒ**: æ•°æ®åº“è®¿é—®å®‰å…¨è¦æ±‚
- **ğŸ›¡ï¸ å¤‡ä»½å®‰å…¨è§„èŒƒ**: å¤‡ä»½æ•°æ®å®‰å…¨å­˜å‚¨è¦æ±‚
- **ğŸ“‹ å®¡è®¡æ—¥å¿—è§„èŒƒ**: æ•°æ®åº“æ“ä½œå®¡è®¡è¦æ±‚
- **ğŸ” æƒé™ç®¡ç†è§„èŒƒ**: æ•°æ®åº“æƒé™æ§åˆ¶è¦æ±‚

---

**ğŸ“‹ é‡è¦æé†’**:
1. æœ¬æŠ€èƒ½ä¸¥æ ¼éµå¾ªIOE-DREAMå››å±‚æ¶æ„è§„èŒƒ
2. æ‰€æœ‰ä»£ç ç¤ºä¾‹ä½¿ç”¨Jakarta EE 3.0+åŒ…åè§„èŒƒ
3. ç»Ÿä¸€ä½¿ç”¨@Resourceä¾èµ–æ³¨å…¥ï¼Œç¦æ­¢ä½¿ç”¨@Autowired
4. ç»Ÿä¸€ä½¿ç”¨@Mapperæ³¨è§£å’ŒDaoåç¼€å‘½å
5. é‡ç‚¹å…³æ³¨æ•°æ®å®‰å…¨å’Œå¤‡ä»½æ¢å¤çš„å¯é æ€§
6. å¿…é¡»æ”¯æŒé«˜å¯ç”¨å’Œé«˜æ€§èƒ½çš„æ•°æ®åº“ç®¡ç†
7. ä¸¥æ ¼éµå¾ªæ•°æ®åº“å®‰å…¨å’Œåˆè§„æ€§è¦æ±‚

**è®©æˆ‘ä»¬ä¸€èµ·å»ºè®¾å¯é ã€é«˜æ•ˆçš„æ•°æ®åº“ç®¡ç†ä½“ç³»ï¼** ğŸš€

---
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0 - IOE-DREAMä¸ƒå¾®æœåŠ¡ä¸“ä¸šç‰ˆ
**åˆ›å»ºæ—¶é—´**: 2025-12-22
**æŠ€èƒ½ç­‰çº§**: â˜…â˜…â˜…â˜…â˜…â˜… (é¡¶çº§ä¸“å®¶)
**é€‚ç”¨æ¶æ„**: Spring Boot 3.5.8 + MySQL 8.0 + Redis + Prometheus + Grafana