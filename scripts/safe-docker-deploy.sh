#!/bin/bash

# =============================================================================
# ğŸ›¡ï¸ã€å®‰å…¨Dockeréƒ¨ç½²ã€‘Safe Docker Deploy Script
# ä½œç”¨ï¼šå¼ºåˆ¶æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥ï¼Œç¡®ä¿0å¼‚å¸¸éƒ¨ç½²
# ä½¿ç”¨ï¼š./scripts/safe-docker-deploy.sh
# ä½œè€…ï¼šè€ç‹ - ä¸“ä¸šå®‰å…¨ä¿éšœ
# =============================================================================

set -e  # ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º

echo "ğŸ›¡ï¸ã€å®‰å…¨Dockeréƒ¨ç½²ã€‘å¼€å§‹æ‰§è¡Œ..."
echo "âš ï¸  æ­¤è„šæœ¬å°†è‡ªåŠ¨æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥ï¼Œç¡®ä¿éƒ¨ç½²å®‰å…¨ï¼"
echo ""

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é”æ–‡ä»¶æœºåˆ¶
LOCK_FILE="/tmp/smart-admin-deploy.lock"

# æ£€æŸ¥æ˜¯å¦å·²æœ‰éƒ¨ç½²è¿›ç¨‹åœ¨è¿è¡Œ
if [ -f "$LOCK_FILE" ]; then
    pid=$(cat "$LOCK_FILE")
    if ps -p $pid > /dev/null 2>&1; then
        echo -e "${RED}âŒ æ£€æµ‹åˆ°å…¶ä»–éƒ¨ç½²è¿›ç¨‹æ­£åœ¨è¿è¡Œ (PID: $pid)${NC}"
        echo "è¯·ç­‰å¾…å…¶å®Œæˆæˆ–æ‰‹åŠ¨ç»ˆæ­¢åé‡è¯•"
        exit 1
    else
        echo -e "${YELLOW}âš ï¸  å‘ç°è¿‡æœŸçš„é”æ–‡ä»¶ï¼Œæ¸…ç†ä¸­...${NC}"
        rm -f "$LOCK_FILE"
    fi
fi

# åˆ›å»ºé”æ–‡ä»¶
echo $$ > "$LOCK_FILE"
trap "rm -f $LOCK_FILE; echo 'ğŸ”“ é”æ–‡ä»¶å·²æ¸…ç†'" EXIT

echo -e "${BLUE}ğŸ”’ å·²åˆ›å»ºéƒ¨ç½²é”æ–‡ä»¶: $LOCK_FILE${NC}"

# =============================================================================
# ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸ” ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œå¼ºåˆ¶éƒ¨ç½²å‰æ£€æŸ¥"
echo "=========================================="

echo -e "${BLUE}ğŸ“ å½“å‰ä½ç½®: $(pwd)${NC}"
echo -e "${BLUE}â° å¼€å§‹æ—¶é—´: $(date)${NC}"

if [ -f "scripts/pre-deploy-check.sh" ]; then
    echo "æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥è„šæœ¬..."
    if bash scripts/pre-deploy-check.sh; then
        echo -e "${GREEN}âœ… éƒ¨ç½²å‰æ£€æŸ¥é€šè¿‡ï¼${NC}"
    else
        echo -e "${RED}âŒ éƒ¨ç½²å‰æ£€æŸ¥å¤±è´¥ï¼${NC}"
        echo -e "${RED}ğŸš« ç¦æ­¢ç»§ç»­éƒ¨ç½²ï¼${NC}"
        exit 1
    fi
else
    echo -e "${RED}âŒ æœªæ‰¾åˆ°éƒ¨ç½²å‰æ£€æŸ¥è„šæœ¬: scripts/pre-deploy-check.sh${NC}"
    exit 1
fi

# =============================================================================
# ç¬¬äºŒæ­¥ï¼šæ¸…ç†ç°æœ‰Dockerèµ„æº
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸ§¹ ç¬¬äºŒæ­¥ï¼šæ¸…ç†ç°æœ‰Dockerèµ„æº"
echo "=========================================="

echo "åœæ­¢ç°æœ‰å®¹å™¨..."
docker-compose down 2>/dev/null || true

echo "æ¸…ç†æ‚¬ç©ºé•œåƒ..."
docker image prune -f 2>/dev/null || true

echo "æ¸…ç†æ‚¬ç©ºå·..."
docker volume prune -f 2>/dev/null || true

# =============================================================================
# ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œå®‰å…¨çš„Dockeræ„å»º
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸ³ ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œå®‰å…¨çš„Dockeræ„å»º"
echo "=========================================="

echo "æ„å»ºåç«¯é•œåƒ..."
if docker-compose build backend --no-cache; then
    echo -e "${GREEN}âœ… åç«¯é•œåƒæ„å»ºæˆåŠŸï¼${NC}"
else
    echo -e "${RED}âŒ åç«¯é•œåƒæ„å»ºå¤±è´¥ï¼${NC}"
    exit 1
fi

# =============================================================================
# ç¬¬å››æ­¥ï¼šå¯åŠ¨æœåŠ¡
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸš€ ç¬¬å››æ­¥ï¼šå¯åŠ¨æœåŠ¡"
echo "=========================================="

echo "å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
if docker-compose up -d; then
    echo -e "${GREEN}âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼${NC}"
else
    echo -e "${RED}âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼${NC}"
    exit 1
fi

# =============================================================================
# ç¬¬äº”æ­¥ï¼šæœåŠ¡å¥åº·æ£€æŸ¥
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸ¥ ç¬¬äº”æ­¥ï¼šæœåŠ¡å¥åº·æ£€æŸ¥"
echo "=========================================="

echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
echo "æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
container_status=$(docker-compose ps)
echo "$container_status"

# æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
echo "æ£€æŸ¥åç«¯APIå¥åº·çŠ¶æ€..."
max_attempts=10
attempt=1

while [ $attempt -le $max_attempts ]; do
    echo "å¥åº·æ£€æŸ¥å°è¯• $attempt/$max_attempts..."

    if curl -s -f http://localhost:1024/api/health >/dev/null 2>&1; then
        echo -e "${GREEN}âœ… åç«¯APIå¥åº·æ£€æŸ¥é€šè¿‡ï¼${NC}"

        # æ˜¾ç¤ºè¯¦ç»†å¥åº·ä¿¡æ¯
        health_info=$(curl -s http://localhost:1024/api/health)
        echo "å¥åº·è¯¦æƒ…: $health_info"
        break
    else
        echo -e "${YELLOW}âš ï¸  åç«¯APIå°šæœªå°±ç»ªï¼Œç­‰å¾…10ç§’...${NC}"
        sleep 10
        ((attempt++))
    fi
done

if [ $attempt -gt $max_attempts ]; then
    echo -e "${RED}âŒ åç«¯APIå¥åº·æ£€æŸ¥å¤±è´¥ï¼${NC}"

    # æ˜¾ç¤ºå®¹å™¨æ—¥å¿—
    echo ""
    echo "åç«¯å®¹å™¨æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰:"
    docker logs smart-admin-backend --tail 50

    exit 1
fi

# =============================================================================
# ç¬¬å…­æ­¥ï¼šå‰ç«¯æœåŠ¡æ£€æŸ¥
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸŒ ç¬¬å…­æ­¥ï¼šå‰ç«¯æœåŠ¡æ£€æŸ¥"
echo "=========================================="

echo "å¯åŠ¨å‰ç«¯æœåŠ¡..."
cd smart-admin-web-javascript

# æ¸…ç†å¯èƒ½å­˜åœ¨çš„Nodeè¿›ç¨‹
pkill -f "vite.*localhost" 2>/dev/null || true

# æ¸…ç†Viteç¼“å­˜
rm -rf node_modules/.vite 2>/dev/null || true

# å¯åŠ¨å‰ç«¯
npm run localhost &
frontend_pid=$!

echo "ç­‰å¾…å‰ç«¯å¯åŠ¨..."
sleep 20

# æ£€æŸ¥å‰ç«¯æœåŠ¡
if curl -s -f http://localhost:8081 >/dev/null 2>&1; then
    echo -e "${GREEN}âœ… å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸï¼${NC}"
else
    echo -e "${YELLOW}âš ï¸  å‰ç«¯æœåŠ¡å¯èƒ½ä»åœ¨å¯åŠ¨ä¸­...${NC}"
fi

cd ..

# =============================================================================
# æœ€ç»ˆæŠ¥å‘Š
# =============================================================================
echo ""
echo "=========================================="
echo "ğŸ‰ éƒ¨ç½²å®ŒæˆæŠ¥å‘Š"
echo "=========================================="

echo -e "${GREEN}ğŸŠ SmartAdmin v3.0 éƒ¨ç½²æˆåŠŸï¼${NC}"
echo ""

echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
echo "  ğŸ³ åç«¯å®¹å™¨: $(docker-compose ps -q backend | xargs docker inspect --format='{{.State.Status}}' 2>/dev/null || echo 'æœªçŸ¥')"
echo "  ğŸ—„ï¸  MySQLå®¹å™¨: $(docker-compose ps -q mysql | xargs docker inspect --format='{{.State.Status}}' 2>/dev/null || echo 'æœªçŸ¥')"
echo "  ğŸ”´ Rediså®¹å™¨: $(docker-compose ps -q redis | xargs docker inspect --format='{{.State.Status}}' 2>/dev/null || echo 'æœªçŸ¥')"
echo ""

echo "ğŸŒ è®¿é—®åœ°å€:"
echo "  ğŸ–¥ï¸  åç«¯API: http://localhost:1024"
echo "  ğŸ“š APIæ–‡æ¡£: http://localhost:1024/doc.html"
echo "  ğŸ¨ å‰ç«¯ç•Œé¢: http://localhost:8081"
echo ""

echo "ğŸ› ï¸  ç®¡ç†å‘½ä»¤:"
echo "  æŸ¥çœ‹å®¹å™¨çŠ¶æ€: docker-compose ps"
echo "  æŸ¥çœ‹åç«¯æ—¥å¿—: docker logs smart-admin-backend"
echo "  åœæ­¢æ‰€æœ‰æœåŠ¡: docker-compose down"
echo ""

echo -e "${GREEN}âœ… éƒ¨ç½²é”æ–‡ä»¶å·²è‡ªåŠ¨æ¸…ç†${NC}"
echo ""
echo "ğŸ¯ éƒ¨ç½²æ—¶é—´: $(date)"
echo "ğŸ‘¤ éƒ¨ç½²æ“ä½œè€…: $(whoami)"
echo ""

# ä¿å­˜éƒ¨ç½²è®°å½•
deploy_log="deploy-$(date +%Y%m%d-%H%M%S).log"
{
    echo "SmartAdmin v3.0 éƒ¨ç½²è®°å½•"
    echo "éƒ¨ç½²æ—¶é—´: $(date)"
    echo "éƒ¨ç½²è€…: $(whoami)"
    echo "æ£€æŸ¥çŠ¶æ€: é€šè¿‡"
    echo "å®¹å™¨çŠ¶æ€:"
    docker-compose ps
    echo ""
    echo "APIå¥åº·çŠ¶æ€:"
    curl -s http://localhost:1024/api/health
} > "logs/$deploy_log" 2>/dev/null || true

echo -e "${BLUE}ğŸ“ éƒ¨ç½²è®°å½•å·²ä¿å­˜: logs/$deploy_log${NC}"

exit 0