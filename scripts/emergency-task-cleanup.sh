#!/bin/bash

# ===================================================================
# ğŸš¨ã€ç»ˆæé˜²æŠ¤ã€‘å¼ºåˆ¶ä»»åŠ¡æ¸…ç†è„šæœ¬ - è€ç‹ä¸“æ²»å„ç§ä¸æœ
# ===================================================================
# ç”¨é€”ï¼šå½»åº•æ¸…ç†æ‰€æœ‰å¤±æ§çš„Dockerå’ŒJavaæ„å»ºä»»åŠ¡
# è°ƒç”¨ï¼š./scripts/emergency-task-cleanup.sh
#

echo "ğŸ”¥ã€è€ç‹ç´§æ€¥æ¸…ç†ã€‘å¼€å§‹å¼ºåˆ¶æ¸…ç†æ‰€æœ‰å¤±æ§ä»»åŠ¡..."
echo "âš ï¸  è¿™æ˜¯æœ€åçš„æ‰‹æ®µï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å°†è¢«å¼ºåˆ¶ç»ˆæ­¢ï¼"

# ===================================================================
# ç¬¬ä¸€é˜¶æ®µï¼šè¿›ç¨‹çº§å¼ºåˆ¶æ¸…ç†
# ===================================================================
echo ""
echo "ğŸ“‹ ç¬¬ä¸€é˜¶æ®µï¼šè¿›ç¨‹çº§å¼ºåˆ¶æ¸…ç†..."

# 1. å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰Javaè¿›ç¨‹
echo "   ğŸ”„ ç»ˆæ­¢Javaè¿›ç¨‹..."
pkill -f "java.*spring-boot" 2>/dev/null || true
pkill -f "java.*mvn" 2>/dev/null || true
pkill -f "java.*gradle" 2>/dev/null || true

# 2. å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰Dockerç›¸å…³è¿›ç¨‹
echo "   ğŸ”„ ç»ˆæ­¢Dockeræ„å»ºè¿›ç¨‹..."
pkill -f "docker.*build" 2>/dev/null || true
pkill -f "docker-compose.*build" 2>/dev/null || true
pkill -f "docker.*compose" 2>/dev/null || true

# 3. å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰Mavenè¿›ç¨‹
echo "   ğŸ”„ ç»ˆæ­¢Mavenè¿›ç¨‹..."
pkill -f "mvn.*build" 2>/dev/null || true
pkill -f "maven" 2>/dev/null || true

# ===================================================================
# ç¬¬äºŒé˜¶æ®µï¼šå®¹å™¨çº§å¼ºåˆ¶æ¸…ç†
# ===================================================================
echo ""
echo "ğŸ“‹ ç¬¬äºŒé˜¶æ®µï¼šå®¹å™¨çº§å¼ºåˆ¶æ¸…ç†..."

# 4. åœæ­¢æ‰€æœ‰Dockerå®¹å™¨
echo "   ğŸ”„ åœæ­¢æ‰€æœ‰å®¹å™¨..."
docker stop $(docker ps -q) 2>/dev/null || true

# 5. å¼ºåˆ¶åˆ é™¤æ‰€æœ‰æ„å»ºä¸­çš„å®¹å™¨
echo "   ğŸ”„ åˆ é™¤æ„å»ºå®¹å™¨..."
docker rm -f $(docker ps -a -q --filter "status=created") 2>/dev/null || true
docker rm -f $(docker ps -a -q --filter "status=restarting") 2>/dev/null || true

# ===================================================================
# ç¬¬ä¸‰é˜¶æ®µï¼šèµ„æºçº§å¼ºåˆ¶æ¸…ç†
# ===================================================================
echo ""
echo "ğŸ“‹ ç¬¬ä¸‰é˜¶æ®µï¼šèµ„æºçº§å¼ºåˆ¶æ¸…ç†..."

# 6. æ¸…ç†Dockeræ„å»ºç¼“å­˜
echo "   ğŸ”„ æ¸…ç†æ„å»ºç¼“å­˜..."
docker builder prune -f 2>/dev/null || true

# 7. æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
echo "   ğŸ”„ æ¸…ç†æœªä½¿ç”¨é•œåƒ..."
docker image prune -f 2>/dev/null || true

# 8. æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
echo "   ğŸ”„ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
rm -rf /tmp/.docker* 2>/dev/null || true
rm -rf /tmp/.mvn* 2>/dev/null || true

# ===================================================================
# ç¬¬å››é˜¶æ®µï¼šWindowsè¿›ç¨‹æ¸…ç†
# ===================================================================
echo ""
echo "ğŸ“‹ ç¬¬å››é˜¶æ®µï¼šWindowsè¿›ç¨‹æ¸…ç†..."

# 9. Windowsä¸“ç”¨æ¸…ç†
if command -v taskkill >/dev/null 2>&1; then
    echo "   ğŸ”„ Windowsè¿›ç¨‹æ¸…ç†..."
    taskkill /F /IM java.exe 2>/dev/null || true
    taskkill /F /IM javaw.exe 2>/dev/null || true
    taskkill /F /IM docker.exe 2>/dev/null || true
    taskkill /F /IM "Docker Desktop.exe" 2>/dev/null || true
fi

# ===================================================================
# éªŒè¯æ¸…ç†ç»“æœ
# ===================================================================
echo ""
echo "ğŸ”ã€æ¸…ç†éªŒè¯ã€‘æ£€æŸ¥æ¸…ç†ç»“æœ..."

sleep 3

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰Javaè¿›ç¨‹
java_count=$(ps aux | grep -i java | grep -v grep | wc -l)
echo "   Javaè¿›ç¨‹æ•°é‡: $java_count"

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰Dockeræ„å»ºè¿›ç¨‹
docker_count=$(ps aux | grep -i docker | grep -v grep | wc -l)
echo "   Dockerè¿›ç¨‹æ•°é‡: $docker_count"

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
container_count=$(docker ps -q | wc -l)
echo "   è¿è¡Œä¸­å®¹å™¨: $container_count"

# ===================================================================
# æœ€ç»ˆæŠ¥å‘Š
# ===================================================================
echo ""
if [ $java_count -eq 0 ] && [ $docker_count -eq 0 ] && [ $container_count -eq 0 ]; then
    echo "ğŸ‰ã€æ¸…ç†æˆåŠŸã€‘æ‰€æœ‰å¤±æ§ä»»åŠ¡å·²è¢«å½»åº•æ¸…ç†ï¼"
    echo "   âœ… Javaè¿›ç¨‹: 0"
    echo "   âœ… Dockerè¿›ç¨‹: 0"
    echo "   âœ… è¿è¡Œå®¹å™¨: 0"
    echo ""
    echo "ğŸ”¥ è€ç‹æˆ‘å†æ¬¡æ‰¿è¯ºï¼šè¿™ç§èµ„æºæµªè´¹çš„SBæƒ…å†µç»ä¸ä¼šå†å‘ç”Ÿï¼"
else
    echo "âš ï¸ ã€éƒ¨åˆ†æ¸…ç†ã€‘ä»æœ‰ä¸€äº›è¿›ç¨‹åœ¨è¿è¡Œï¼š"
    echo "   âš ï¸ Javaè¿›ç¨‹: $java_count"
    echo "   âš ï¸ Dockerè¿›ç¨‹: $docker_count"
    echo "   âš ï¸ è¿è¡Œå®¹å™¨: $container_count"
    echo ""
    echo "ğŸ’¡ å»ºè®®ï¼šé‡å¯Docker DesktopæœåŠ¡"
fi

echo ""
echo "ğŸ”’ã€é˜²æŠ¤æœºåˆ¶ã€‘é‡æ–°å¯åŠ¨ä»»åŠ¡é˜²æŠ¤ç³»ç»Ÿ..."
# é‡æ–°å¯åŠ¨ä»»åŠ¡ç›‘æ§
./scripts/monitor-tasks.sh &

echo "âœ… ç´§æ€¥æ¸…ç†å®Œæˆï¼"