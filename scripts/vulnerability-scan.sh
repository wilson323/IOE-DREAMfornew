#!/bin/bash

# =============================================================================
# IOE-DREAM ç³»ç»ŸæŠ—æ”»å‡»èƒ½åŠ›å’Œå®‰å…¨æ¼æ´æ‰«æè„šæœ¬
#
# åŠŸèƒ½æè¿°ï¼š
# å…¨é¢æ‰«æç³»ç»Ÿçš„å®‰å…¨æ¼æ´ï¼ŒåŒ…æ‹¬å·²çŸ¥æ¼æ´ã€é…ç½®é—®é¢˜ã€ä»£ç å®‰å…¨é—®é¢˜ç­‰
#
# @author IOE-DREAM å®‰å…¨å›¢é˜Ÿ
# @version 1.0.0
# @date 2025-11-29
# =============================================================================

set -euo pipefail

# é¢œè‰²å®šä¹‰
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# é¡¹ç›®è·¯å¾„é…ç½®
readonly PROJECT_ROOT="D:/IOE-DREAM"
readonly MICROSERVICES_DIR="${PROJECT_ROOT}/microservices"
readonly MONOLITH_DIR="${PROJECT_ROOT}/smart-admin-api-java17-springboot3"
readonly REPORTS_DIR="${PROJECT_ROOT}/security-audit-reports"
readonly TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
readonly REPORT_FILE="${REPORTS_DIR}/vulnerability_scan_${TIMESTAMP}.md"

# å¸¸è§CVEæ¼æ´æ¨¡å¼
readonly CVE_PATTERNS=(
    "log4j.*2\.14\|log4shell"
    "spring.*4\.3\|spring.*RCE"
    "jackson.*2\.12\|jackson.*RCE"
    "fastjson.*1\.2\|fastjson.*RCE"
    "commons.*collections.*3\|commons.*RCE"
)

# å®‰å…¨é…ç½®æ£€æŸ¥æ¨¡å¼
readonly SECURITY_CONFIG_PATTERNS=(
    "password.*="
    "secret.*="
    "key.*="
    "token.*="
    "admin.*="
    "root.*="
)

# åˆ›å»ºæŠ¥å‘Šç›®å½•
mkdir -p "${REPORTS_DIR}"

# æ¼æ´æ‰«æç»“æœç»Ÿè®¡
declare -A SCAN_RESULTS=(
    ["total_scans"]=0
    ["vulnerabilities_found"]=0
    ["critical_vulnerabilities"]=0
    ["high_vulnerabilities"]=0
    ["medium_vulnerabilities"]=0
    ["low_vulnerabilities"]=0
    ["config_issues"]=0
    ["dependency_issues"]=0
    ["code_issues"]=0
)

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_success() {
    echo -e "${GREEN}[PASS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_warning() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
    ((SCAN_RESULTS[medium_vulnerabilities]++))
    ((SCAN_RESULTS[vulnerabilities_found]++))
}

log_error() {
    echo -e "${RED}[FAIL]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
    ((SCAN_RESULTS[high_vulnerabilities]++))
    ((SCAN_RESULTS[vulnerabilities_found]++))
}

log_critical() {
    echo -e "${PURPLE}[CRITICAL]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
    ((SCAN_RESULTS[critical_vulnerabilities]++))
    ((SCAN_RESULTS[vulnerabilities_found]++))
}

log_vulnerability() {
    echo -e "${RED}[VULNERABILITY]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# åˆå§‹åŒ–æ‰«ææŠ¥å‘Š
init_scan_report() {
    cat > "${REPORT_FILE}" << EOF
# IOE-DREAM ç³»ç»Ÿå®‰å…¨æ¼æ´æ‰«ææŠ¥å‘Š

**æ‰«ææ—¶é—´**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
**æ‰«æèŒƒå›´**: å¾®æœåŠ¡æ¶æ„å…¨æ ˆå®‰å…¨æ¼æ´æ‰«æ
**æ‰«æç‰ˆæœ¬**: v1.0.0
**æ‰«æå›¢é˜Ÿ**: IOE-DREAM å®‰å…¨å›¢é˜Ÿ

---

## ğŸ“‹ æ‰«ææ¦‚è¿°

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº†IOE-DREAMå¾®æœåŠ¡æ¶æ„çš„å®‰å…¨æ¼æ´æ‰«æç»“æœï¼ŒåŒ…æ‹¬ï¼š
- ä¾èµ–åŒ…æ¼æ´æ‰«æ
- é…ç½®å®‰å…¨é—®é¢˜æ‰«æ
- ä»£ç å®‰å…¨æ¼æ´æ‰«æ
- ç³»ç»Ÿé…ç½®æ¼æ´æ‰«æ
- ç½‘ç»œå®‰å…¨æ¼æ´æ‰«æ

---

## ğŸ” æ‰«æç»“æœè¯¦æƒ…

EOF
    log_info "æ¼æ´æ‰«ææŠ¥å‘Šåˆå§‹åŒ–å®Œæˆ"
}

# 1. ä¾èµ–åŒ…æ¼æ´æ‰«æ
scan_dependency_vulnerabilities() {
    log_info "å¼€å§‹ä¾èµ–åŒ…æ¼æ´æ‰«æ..."

    ((SCAN_RESULTS[total_scans]++))

    echo -e "\n### 1. ä¾èµ–åŒ…æ¼æ´æ‰«æ" >> "${REPORT_FILE}"

    # 1.1 æ‰«æMavenä¾èµ–æ¼æ´
    log_info "æ‰«æMavenä¾èµ–åŒ…æ¼æ´..."

    local pom_files=$(find "${PROJECT_ROOT}" -name "pom.xml" | wc -l)
    log_info "å‘ç°${pom_files}ä¸ªMavené¡¹ç›®æ–‡ä»¶"

    if [[ $pom_files -gt 0 ]]; then
        # æ£€æŸ¥å·²çŸ¥çš„CVEæ¼æ´ä¾èµ–
        echo "#### å·²çŸ¥CVEæ¼æ´ä¾èµ–æ£€æŸ¥" >> "${REPORT_FILE}"
        echo "| CVEæ¼æ´æ¨¡å¼ | æ‰«æç»“æœ | é£é™©ç­‰çº§ |" >> "${REPORT_FILE}"
        echo "|--------------|----------|----------|" >> "${REPORT_FILE}"

        for pattern in "${CVE_PATTERNS[@]}"; do
            local matches=$(find "${PROJECT_ROOT}" -name "pom.xml" -exec grep -l "$pattern" {} \; | wc -l)
            if [[ $matches -gt 0 ]]; then
                echo "| $pattern | å‘ç°${matches}ä¸ªåŒ¹é… | ğŸ”´ é«˜å± |" >> "${REPORT_FILE}"
                log_critical "å‘ç°CVEæ¼æ´æ¨¡å¼: $pattern"
                ((SCAN_RESULTS[dependency_issues]++))
            else
                echo "| $pattern | æœªå‘ç° | âœ… å®‰å…¨ |" >> "${REPORT_FILE}"
            fi
        done

        # æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–ç‰ˆæœ¬
        local outdated_deps=0
        local vulnerable_versions=("log4j:2.14" "spring-core:4.3" "jackson-databind:2.12" "fastjson:1.2.24")

        for dep in "${vulnerable_versions[@]}"; do
            local version_matches=$(find "${PROJECT_ROOT}" -name "pom.xml" -exec grep -l "$dep" {} \; | wc -l)
            if [[ $version_matches -gt 0 ]]; then
                ((outdated_deps++))
                log_warning "å‘ç°å¯èƒ½å­˜åœ¨æ¼æ´çš„ä¾èµ–ç‰ˆæœ¬: $dep"
            fi
        done

        if [[ $outdated_deps -gt 0 ]]; then
            ((SCAN_RESULTS[dependency_issues]++))
            echo -e "\nâš ï¸ **è¿‡æ—¶ä¾èµ–è­¦å‘Š**: å‘ç°${outdated_deps}ä¸ªå¯èƒ½å­˜åœ¨æ¼æ´çš„ä¾èµ–ç‰ˆæœ¬" >> "${REPORT_FILE}"
        fi
    else
        log_warning "æœªå‘ç°Mavené¡¹ç›®æ–‡ä»¶"
        echo "âš ï¸ **Mavené¡¹ç›®**: æœªå‘ç°Mavené¡¹ç›®æ–‡ä»¶" >> "${REPORT_FILE}"
    fi

    # 1.2 æ‰«æNode.jsä¾èµ–æ¼æ´
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æNode.jsä¾èµ–åŒ…æ¼æ´..."

    local package_json_files=$(find "${PROJECT_ROOT}" -name "package.json" | wc -l)
    if [[ $package_json_files -gt 0 ]]; then
        log_info "å‘ç°${package_json_files}ä¸ªNode.jsé¡¹ç›®æ–‡ä»¶"

        # æ£€æŸ¥å¸¸è§çš„Node.jså®‰å…¨æ¼æ´
        local node_vulnerable_deps=("lodash:4.17.20" "node-forge:0.10.0" "axios:0.21.1")
        local node_vulns=0

        for dep in "${node_vulnerable_deps[@]}"; do
            local matches=$(find "${PROJECT_ROOT}" -name "package.json" -exec grep -l "$dep" {} \; | wc -l)
            if [[ $matches -gt 0 ]]; then
                ((node_vulns++))
                log_warning "å‘ç°å¯èƒ½å­˜åœ¨æ¼æ´çš„Node.jsä¾èµ–: $dep"
            fi
        done

        if [[ $node_vulns -gt 0 ]]; then
            ((SCAN_RESULTS[dependency_issues]++))
            echo "âš ï¸ **Node.jsä¾èµ–**: å‘ç°${node_vulns}ä¸ªå¯èƒ½å­˜åœ¨æ¼æ´çš„Node.jsä¾èµ–" >> "${REPORT_FILE}"
        else
            echo "âœ… **Node.jsä¾èµ–**: æœªå‘ç°æ˜æ˜¾çš„Node.jsä¾èµ–æ¼æ´" >> "${REPORT_FILE}"
        fi
    fi

    log_info "ä¾èµ–åŒ…æ¼æ´æ‰«æå®Œæˆ"
}

# 2. é…ç½®å®‰å…¨æ¼æ´æ‰«æ
scan_configuration_vulnerabilities() {
    log_info "å¼€å§‹é…ç½®å®‰å…¨æ¼æ´æ‰«æ..."

    ((SCAN_RESULTS[total_scans]++))

    echo -e "\n### 2. é…ç½®å®‰å…¨æ¼æ´æ‰«æ" >> "${REPORT_FILE}"

    # 2.1 æ‰«æç¡¬ç¼–ç å¯†ç 
    log_info "æ‰«æé…ç½®æ–‡ä»¶ä¸­çš„ç¡¬ç¼–ç å¯†ç ..."

    local config_files=$(find "${PROJECT_ROOT}" -name "*.yml" -o -name "*.yaml" -o -name "*.properties" | wc -l)
    log_info "æ‰«æ${config_files}ä¸ªé…ç½®æ–‡ä»¶"

    local hardcoded_passwords=0
    local default_passwords=0
    local plain_text_secrets=0

    echo "#### é…ç½®å®‰å…¨é—®é¢˜æ£€æŸ¥" >> "${REPORT_FILE}"
    echo "| é—®é¢˜ç±»å‹ | å‘ç°æ•°é‡ | é£é™©ç­‰çº§ |" >> "${REPORT_FILE}"
    echo "|----------|----------|----------|" >> "${REPORT_FILE}"

    # æ£€æŸ¥ç¡¬ç¼–ç å¯†ç 
    local hardcoded_password_files=$(find "${PROJECT_ROOT}" -name "*.yml" -o -name "*.properties" -exec grep -l "password.*=\|password:\s*[^$\s\\]" {} \;)
    while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            ((hardcoded_passwords++))
            log_warning "å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç å¯†ç : $file"
        fi
    done <<< "$hardcoded_password_files"

    if [[ $hardcoded_passwords -gt 0 ]]; then
        echo "| ç¡¬ç¼–ç å¯†ç  | ${hardcoded_passwords} | ğŸ”´ é«˜å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "| ç¡¬ç¼–ç å¯†ç  | 0 | âœ… å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    # æ£€æŸ¥é»˜è®¤å¯†ç 
    local default_password_files=$(find "${PROJECT_ROOT}" -name "*.yml" -o -name "*.properties" -exec grep -l "password.*root\|password.*admin\|password.*123\|password.*password" {} \;)
    while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            ((default_passwords++))
            log_warning "å‘ç°é»˜è®¤å¯†ç : $file"
        fi
    done <<< "$default_password_files"

    if [[ $default_passwords -gt 0 ]]; then
        echo "| é»˜è®¤å¯†ç  | ${default_passwords} | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "| é»˜è®¤å¯†ç  | 0 | âœ… å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    # 2.2 æ£€æŸ¥ä¸å®‰å…¨çš„é…ç½®
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æä¸å®‰å…¨çš„é…ç½®..."

    local insecure_configs=0

    # æ£€æŸ¥è°ƒè¯•æ¨¡å¼å¼€å¯
    local debug_enabled=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "debug.*true" {} \; | wc -l)
    if [[ $debug_enabled -gt 0 ]]; then
        ((insecure_configs++))
        log_warning "å‘ç°${debug_enabled}ä¸ªé…ç½®å¼€å¯äº†è°ƒè¯•æ¨¡å¼"
        echo "| è°ƒè¯•æ¨¡å¼å¼€å¯ | ${debug_enabled} | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
    fi

    # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒæš´éœ²
    local prod_exposure=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "profiles.*prod\|production.*debug" {} \; | wc -l)
    if [[ $prod_exposure -gt 0 ]]; then
        ((insecure_configs++))
        log_warning "å‘ç°å¯èƒ½çš„ç”Ÿäº§ç¯å¢ƒæš´éœ²é…ç½®"
        echo "| ç”Ÿäº§ç¯å¢ƒæš´éœ² | ${prod_exposure} | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
    fi

    # æ£€æŸ¥å…è®¸æ‰€æœ‰æº
    local cors_all=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "allowed-origins.*\*\|cors.*\*" {} \; | wc -l)
    if [[ $cors_all -gt 0 ]]; then
        ((insecure_configs++))
        log_warning "å‘ç°${cors_all}ä¸ªé…ç½®å…è®¸æ‰€æœ‰æºçš„CORSè®¾ç½®"
        echo "| å…è®¸æ‰€æœ‰æºCORS | ${cors_all} | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
    fi

    if [[ $insecure_configs -gt 0 ]]; then
        ((SCAN_RESULTS[config_issues]++))
    fi

    # 2.3 æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«ææ•æ„Ÿä¿¡æ¯æ³„éœ²é…ç½®..."

    local sensitive_info_leaks=0

    # æ£€æŸ¥APIå¯†é’¥æ³„éœ²
    local api_key_leaks=$(find "${PROJECT_ROOT}" -name "*.yml" -o -name "*.properties" -exec grep -l "api.*key.*=\|apikey.*=" {} \; | wc -l)
    if [[ $api_key_leaks -gt 0 ]]; then
        ((sensitive_info_leaks++))
        log_warning "å‘ç°${api_key_leaks}ä¸ªé…ç½®å¯èƒ½æ³„éœ²APIå¯†é’¥"
    fi

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥ä¿¡æ¯æ³„éœ²
    local db_info_leaks=$(find "${PROJECT_ROOT}" -name "*.yml" -o -name "*.properties" -exec grep -l "jdbc:mysql://.*root\|username.*root" {} \; | wc -l)
    if [[ $db_info_leaks -gt 0 ]]; then
        ((sensitive_info_leaks++))
        log_warning "å‘ç°${db_info_leaks}ä¸ªé…ç½®å¯èƒ½æ³„éœ²æ•°æ®åº“è¿æ¥ä¿¡æ¯"
    fi

    if [[ $sensitive_info_leaks -gt 0 ]]; then
        echo "| æ•æ„Ÿä¿¡æ¯æ³„éœ² | ${sensitive_info_leaks} | ğŸ”´ é«˜å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "| æ•æ„Ÿä¿¡æ¯æ³„éœ² | 0 | âœ… å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    log_info "é…ç½®å®‰å…¨æ¼æ´æ‰«æå®Œæˆ"
}

# 3. ä»£ç å®‰å…¨æ¼æ´æ‰«æ
scan_code_vulnerabilities() {
    log_info "å¼€å§‹ä»£ç å®‰å…¨æ¼æ´æ‰«æ..."

    ((SCAN_RESULTS[total_scans]++))

    echo -e "\n### 3. ä»£ç å®‰å…¨æ¼æ´æ‰«æ" >> "${REPORT_FILE}"

    local java_files=$(find "${PROJECT_ROOT}" -name "*.java" | wc -l)
    log_info "æ‰«æ${java_files}ä¸ªJavaæºæ–‡ä»¶"

    # 3.1 æ‰«æSQLæ³¨å…¥æ¼æ´
    log_info "æ‰«æSQLæ³¨å…¥æ¼æ´..."

    local sql_injection_risks=0
    local unsafe_sql=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "String.*sql.*=\|\"\+.*sql\|Statement.*execute" {} \;)
    while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            ((sql_injection_risks++))
            log_warning "å‘ç°æ½œåœ¨çš„SQLæ³¨å…¥é£é™©: $file"
        fi
    done <<< "$unsafe_sql"

    if [[ $sql_injection_risks -gt 0 ]]; then
        echo "#### SQLæ³¨å…¥é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | ${sql_injection_risks} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        echo "| å»ºè®® | ä½¿ç”¨PreparedStatementæˆ–å‚æ•°åŒ–æŸ¥è¯¢ |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[code_issues]++))
    else
        echo "#### SQLæ³¨å…¥é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | 0 | âœ… æœªå‘ç°æ˜æ˜¾çš„SQLæ³¨å…¥é£é™© |" >> "${REPORT_FILE}"
    fi

    # 3.2 æ‰«æXSSæ¼æ´
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æXSSæ¼æ´..."

    local xss_risks=0
    local xss_vulnerable=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "response\.getWriter\|out\.print.*request\|request\.getParameter.*response" {} \;)
    while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            ((xss_risks++))
            log_warning "å‘ç°æ½œåœ¨çš„XSSé£é™©: $file"
        fi
    done <<< "$xss_vulnerable"

    if [[ $xss_risks -gt 0 ]]; then
        echo "#### XSSè·¨ç«™è„šæœ¬é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | ${xss_risks} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        echo "| å»ºè®® | å¯¹è¾“å‡ºè¿›è¡ŒHTMLç¼–ç æˆ–ä½¿ç”¨å®‰å…¨çš„æ¨¡æ¿å¼•æ“ |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[code_issues]++))
    else
        echo "#### XSSè·¨ç«™è„šæœ¬é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | 0 | âœ… æœªå‘ç°æ˜æ˜¾çš„XSSé£é™© |" >> "${REPORT_FILE}"
    fi

    # 3.3 æ‰«æè·¯å¾„éå†æ¼æ´
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æè·¯å¾„éå†æ¼æ´..."

    local path_traversal_risks=0
    local path_vulnerable=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "new.*File.*request\|getRealPath.*request\|File.*getParameter" {} \;)
    while IFS= read -r file; do
        if [[ -n "$file" ]]; then
            ((path_traversal_risks++))
            log_warning "å‘ç°æ½œåœ¨çš„è·¯å¾„éå†é£é™©: $file"
        fi
    done <<< "$path_vulnerable"

    if [[ $path_traversal_risks -gt 0 ]]; then
        echo "#### è·¯å¾„éå†é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | ${path_traversal_risks} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        echo "| å»ºè®® | å¯¹æ–‡ä»¶è·¯å¾„è¿›è¡ŒéªŒè¯å’Œè§„èŒƒåŒ– |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[code_issues]++))
    else
        echo "#### è·¯å¾„éå†é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | 0 | âœ… æœªå‘ç°æ˜æ˜¾çš„è·¯å¾„éå†é£é™© |" >> "${REPORT_FILE}"
    fi

    # 3.4 æ‰«æä¸å®‰å…¨çš„ååºåˆ—åŒ–
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æä¸å®‰å…¨çš„ååºåˆ—åŒ–æ¼æ´..."

    local deserialization_risks=0
    local unsafe_deserialization=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "ObjectInputStream\|readObject\|Serializable.* malicious" {} \; | wc -l)
    if [[ $unsafe_deserialization -gt 0 ]]; then
        ((deserialization_risks=$unsafe_deserialization))
        log_warning "å‘ç°${unsafe_deserialization}ä¸ªæ–‡ä»¶ä½¿ç”¨ååºåˆ—åŒ–ï¼Œå¯èƒ½å­˜åœ¨é£é™©"
    fi

    if [[ $deserialization_risks -gt 0 ]]; then
        echo "#### ååºåˆ—åŒ–é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | ${deserialization_risks} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸ”´ é«˜å± |" >> "${REPORT_FILE}"
        echo "| å»ºè®® | éªŒè¯åºåˆ—åŒ–æ•°æ®ï¼Œä½¿ç”¨ç™½åå•æœºåˆ¶ |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[code_issues]++))
    else
        echo "#### ååºåˆ—åŒ–é£é™©" >> "${REPORT_FILE}"
        echo "| é£é™©æ–‡ä»¶æ•°é‡ | 0 | âœ… æœªå‘ç°æ˜æ˜¾çš„ååºåˆ—åŒ–é£é™© |" >> "${REPORT_FILE}"
    fi

    # 3.5 æ‰«æç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æä»£ç ä¸­çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯..."

    local hardcoded_secrets=0
    local secret_patterns=("password.*=\s*\"" "secret.*=\s*\"" "key.*=\s*\"" "token.*=\s*\"")

    for pattern in "${secret_patterns[@]}"; do
        local matches=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "$pattern" {} \; | wc -l)
        if [[ $matches -gt 0 ]]; then
            ((hardcoded_secrets++))
            log_warning "å‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯æ¨¡å¼: $pattern"
        fi
    done

    if [[ $hardcoded_secrets -gt 0 ]]; then
        echo "#### ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯" >> "${REPORT_FILE}"
        echo "| å‘ç°æ•°é‡ | ${hardcoded_secrets} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸ”´ é«˜å± |" >> "${REPORT_FILE}"
        echo "| å»ºè®® | ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å®‰å…¨çš„å¯†é’¥ç®¡ç†ç³»ç»Ÿ |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[code_issues]++))
    else
        echo "#### ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯" >> "${REPORT_FILE}"
        echo "| å‘ç°æ•°é‡ | 0 | âœ… æœªå‘ç°ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ |" >> "${REPORT_FILE}"
    fi

    log_info "ä»£ç å®‰å…¨æ¼æ´æ‰«æå®Œæˆ"
}

# 4. ç³»ç»Ÿå®‰å…¨é…ç½®æ‰«æ
scan_system_security() {
    log_info "å¼€å§‹ç³»ç»Ÿå®‰å…¨é…ç½®æ‰«æ..."

    ((SCAN_RESULTS[total_scans]++))

    echo -e "\n### 4. ç³»ç»Ÿå®‰å…¨é…ç½®æ‰«æ" >> "${REPORT_FILE}"

    # 4.1 æ£€æŸ¥Dockeré…ç½®å®‰å…¨
    log_info "æ‰«æDockeré…ç½®å®‰å…¨..."

    local docker_files=$(find "${PROJECT_ROOT}" -name "Dockerfile*" -o -name "docker-compose*" | wc -l)
    if [[ $docker_files -gt 0 ]]; then
        log_info "å‘ç°${docker_files}ä¸ªDockeré…ç½®æ–‡ä»¶"

        local docker_security_issues=0

        # æ£€æŸ¥Dockerfileä¸­ä½¿ç”¨rootç”¨æˆ·
        local root_user_docker=$(find "${PROJECT_ROOT}" -name "Dockerfile*" -exec grep -l "USER.*root\|user.*root" {} \; | wc -l)
        if [[ $root_user_docker -gt 0 ]]; then
            ((docker_security_issues++))
            log_warning "å‘ç°${root_user_docker}ä¸ªDockerfileä½¿ç”¨rootç”¨æˆ·"
        fi

        # æ£€æŸ¥æš´éœ²è¿‡å¤šç«¯å£
        local exposed_ports=$(find "${PROJECT_ROOT}" -name "Dockerfile*" -exec grep -c "EXPOSE" {} \; | awk '{sum+=$1} END {print sum}')
        if [[ $exposed_ports -gt 5 ]]; then
            ((docker_security_issues++))
            log_warning "Dockeré…ç½®æš´éœ²è¿‡å¤šç«¯å£: ${exposed_ports}ä¸ª"
        fi

        if [[ $docker_security_issues -gt 0 ]]; then
            echo "#### Dockerå®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
            echo "| å®‰å…¨é—®é¢˜æ•°é‡ | ${docker_security_issues} |" >> "${REPORT_FILE}"
            echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
            ((SCAN_RESULTS[config_issues]++))
        else
            echo "#### Dockerå®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
            echo "| å®‰å…¨é—®é¢˜æ•°é‡ | 0 | âœ… Dockeré…ç½®ç›¸å¯¹å®‰å…¨ |" >> "${REPORT_FILE}"
        fi
    fi

    # 4.2 æ£€æŸ¥æœåŠ¡å™¨é…ç½®
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«ææœåŠ¡å™¨é…ç½®å®‰å…¨..."

    local server_security_issues=0

    # æ£€æŸ¥æ˜¯å¦å¯ç”¨å®‰å…¨å¤´éƒ¨
    local security_headers=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "X-Frame-Options\|X-Content-Type-Options\|X-XSS-Protection" {} \; | wc -l)
    if [[ $security_headers -eq 0 ]]; then
        ((server_security_issues++))
        log_warning "æœªå‘ç°å®‰å…¨å¤´éƒ¨é…ç½®"
    fi

    # æ£€æŸ¥ä¼šè¯é…ç½®
    local session_security=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "secure.*true\|httpOnly.*true\|session.*timeout" {} \; | wc -l)
    if [[ $session_security -eq 0 ]]; then
        ((server_security_issues++))
        log_warning "æœªå‘ç°ä¼šè¯å®‰å…¨é…ç½®"
    fi

    if [[ $server_security_issues -gt 0 ]]; then
        echo "#### æœåŠ¡å™¨å®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | ${server_security_issues} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "#### æœåŠ¡å™¨å®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | 0 | âœ… æœåŠ¡å™¨é…ç½®ç›¸å¯¹å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    # 4.3 æ£€æŸ¥æ—¥å¿—å®‰å…¨é…ç½®
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«ææ—¥å¿—å®‰å…¨é…ç½®..."

    local log_security_issues=0

    # æ£€æŸ¥æ˜¯å¦è®°å½•æ•æ„Ÿä¿¡æ¯
    local sensitive_logs=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "log.*password\|log.*secret\|log.*token" {} \; | wc -l)
    if [[ $sensitive_logs -gt 0 ]]; then
        ((log_security_issues++))
        log_warning "å‘ç°${sensitive_logs}ä¸ªæ–‡ä»¶å¯èƒ½è®°å½•æ•æ„Ÿä¿¡æ¯åˆ°æ—¥å¿—"
    fi

    # æ£€æŸ¥æ—¥å¿—çº§åˆ«é…ç½®
    local debug_logs=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "level.*debug\|logging.*debug" {} \; | wc -l)
    if [[ $debug_logs -gt 0 ]]; then
        ((log_security_issues++))
        log_warning "å‘ç°${debug_logs}ä¸ªé…ç½®å¯ç”¨è°ƒè¯•æ—¥å¿—"
    fi

    if [[ $log_security_issues -gt 0 ]]; then
        echo "#### æ—¥å¿—å®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | ${log_security_issues} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "#### æ—¥å¿—å®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | 0 | âœ… æ—¥å¿—é…ç½®ç›¸å¯¹å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    log_info "ç³»ç»Ÿå®‰å…¨é…ç½®æ‰«æå®Œæˆ"
}

# 5. ç½‘ç»œå®‰å…¨æ¼æ´æ‰«æ
scan_network_security() {
    log_info "å¼€å§‹ç½‘ç»œå®‰å…¨æ¼æ´æ‰«æ..."

    ((SCAN_RESULTS[total_scans]++))

    echo -e "\n### 5. ç½‘ç»œå®‰å…¨æ¼æ´æ‰«æ" >> "${REPORT_FILE}"

    # 5.1 æ£€æŸ¥ç«¯å£é…ç½®
    log_info "æ‰«æç«¯å£é…ç½®å®‰å…¨..."

    local port_configs=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -h "port:" {} \; | sort -u)
    local risk_ports=0

    echo "#### ç«¯å£é…ç½®æ£€æŸ¥" >> "${REPORT_FILE}"
    echo "| ç«¯å£å· | é…ç½®æ•°é‡ | é£é™©è¯„ä¼° |" >> "${REPORT_FILE}"
    echo "|--------|----------|----------|" >> "${REPORT_FILE}"

    while IFS= read -r port_config; do
        if [[ -n "$port_config" ]]; then
            local port_number=$(echo "$port_config" | grep -o '[0-9]\+' | head -1)
            if [[ -n "$port_number" ]]; then
                local port_count=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "port.*$port_number" {} \; | wc -l)

                # è¯„ä¼°ç«¯å£é£é™©
                local risk_level="âœ… å®‰å…¨"
                if [[ $port_number -eq 22 ]]; then
                    risk_level="ğŸŸ¡ SSHç«¯å£"
                    ((risk_ports++))
                elif [[ $port_number -eq 3389 ]]; then
                    risk_level="ğŸŸ¡ RDPç«¯å£"
                    ((risk_ports++))
                elif [[ $port_number -eq 8080 || $port_number -eq 80 ]]; then
                    risk_level="âœ… Webç«¯å£"
                elif [[ $port_number -gt 10000 ]]; then
                    risk_level="âœ… é«˜ä½ç«¯å£"
                fi

                echo "| $port_number | $port_count | $risk_level |" >> "${REPORT_FILE}"
            fi
        fi
    done <<< "$port_configs"

    # 5.2 æ£€æŸ¥ç½‘ç»œé…ç½®å®‰å…¨
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«æç½‘ç»œé…ç½®å®‰å…¨..."

    local network_security_issues=0

    # æ£€æŸ¥æ˜¯å¦å¯ç”¨SSL/TLS
    local ssl_configs=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "ssl:\|https:" {} \; | wc -l)
    if [[ $ssl_configs -eq 0 ]]; then
        ((network_security_issues++))
        log_warning "æœªå‘ç°SSL/TLSé…ç½®"
    fi

    # æ£€æŸ¥ä»£ç†é…ç½®
    local proxy_configs=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "proxy\|ä»£ç†" {} \; | wc -l)
    if [[ $proxy_configs -gt 0 ]]; then
        log_info "å‘ç°${proxy_configs}ä¸ªä»£ç†é…ç½®"
    fi

    if [[ $network_security_issues -gt 0 ]]; then
        echo "#### ç½‘ç»œå®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | ${network_security_issues} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "#### ç½‘ç»œå®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | 0 | âœ… ç½‘ç»œé…ç½®ç›¸å¯¹å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    log_info "ç½‘ç»œå®‰å…¨æ¼æ´æ‰«æå®Œæˆ"
}

# 6. æƒé™å’Œè®¤è¯å®‰å…¨æ‰«æ
scan_auth_security() {
    log_info "å¼€å§‹æƒé™å’Œè®¤è¯å®‰å…¨æ‰«æ..."

    ((SCAN_RESULTS[total_scans]++))

    echo -e "\n### 6. æƒé™å’Œè®¤è¯å®‰å…¨æ‰«æ" >> "${REPORT_FILE}"

    # 6.1 æ£€æŸ¥è®¤è¯é…ç½®
    log_info "æ‰«æè®¤è¯é…ç½®å®‰å…¨..."

    local auth_security_issues=0

    # æ£€æŸ¥JWTé…ç½®
    local jwt_configs=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "jwt\|JWT" {} \; | wc -l)
    if [[ $jwt_configs -gt 0 ]]; then
        log_info "å‘ç°${jwt_configs}ä¸ªJWTé…ç½®"

        # æ£€æŸ¥JWTå¯†é’¥å®‰å…¨æ€§
        local jwt_secrets=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "secret.*test\|secret.*default" {} \; | wc -l)
        if [[ $jwt_secrets -gt 0 ]]; then
            ((auth_security_issues++))
            log_warning "å‘ç°å¯èƒ½ä½¿ç”¨é»˜è®¤/æµ‹è¯•JWTå¯†é’¥"
        fi
    else
        ((auth_security_issues++))
        log_warning "æœªå‘ç°JWTé…ç½®"
    fi

    # æ£€æŸ¥ä¼šè¯ç®¡ç†
    local session_configs=$(find "${PROJECT_ROOT}" -name "*.yml" -exec grep -l "session\|Session" {} \; | wc -l)
    if [[ $session_configs -eq 0 ]]; then
        ((auth_security_issues++))
        log_warning "æœªå‘ç°ä¼šè¯ç®¡ç†é…ç½®"
    fi

    # 6.2 æ£€æŸ¥æƒé™é…ç½®
    ((SCAN_RESULTS[total_scans]++))
    log_info "æ‰«ææƒé™é…ç½®å®‰å…¨..."

    # æ£€æŸ¥é»˜è®¤è§’è‰²æƒé™
    local default_roles=$(find "${PROJECT_ROOT}" -name "*.java" -exec grep -l "ROLE_ADMIN\|ROLE_USER\|é»˜è®¤è§’è‰²" {} \; | wc -l)
    if [[ $default_roles -gt 0 ]]; then
        log_info "å‘ç°${default_roles}ä¸ªæ–‡ä»¶å®šä¹‰äº†è§’è‰²æƒé™"
    fi

    # æ£€æŸ¥æƒé™æ³¨è§£è¦†ç›–ç‡
    local protected_controllers=$(find "${PROJECT_ROOT}" -name "*Controller.java" -exec grep -l "@RequireResource\|@PreAuthorize\|@Secured" {} \; | wc -l)
    local total_controllers=$(find "${PROJECT_ROOT}" -name "*Controller.java" | wc -l)

    if [[ $total_controllers -gt 0 ]]; then
        local auth_coverage=$((protected_controllers * 100 / total_controllers))
        if [[ $auth_coverage -lt 50 ]]; then
            ((auth_security_issues++))
            log_warning "æ§åˆ¶å™¨æƒé™ä¿æŠ¤è¦†ç›–ç‡è¿‡ä½: ${auth_coverage}%"
        fi
    fi

    if [[ $auth_security_issues -gt 0 ]]; then
        echo "#### è®¤è¯å’Œæƒé™å®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | ${auth_security_issues} |" >> "${REPORT_FILE}"
        echo "| é£é™©ç­‰çº§ | ğŸŸ¡ ä¸­å± |" >> "${REPORT_FILE}"
        ((SCAN_RESULTS[config_issues]++))
    else
        echo "#### è®¤è¯å’Œæƒé™å®‰å…¨é—®é¢˜" >> "${REPORT_FILE}"
        echo "| å®‰å…¨é—®é¢˜æ•°é‡ | 0 | âœ… è®¤è¯å’Œæƒé™é…ç½®ç›¸å¯¹å®‰å…¨ |" >> "${REPORT_FILE}"
    fi

    log_info "æƒé™å’Œè®¤è¯å®‰å…¨æ‰«æå®Œæˆ"
}

# 7. ç”Ÿæˆæ‰«ææŠ¥å‘Šæ€»ç»“
generate_scan_summary() {
    log_info "ç”Ÿæˆæ‰«ææŠ¥å‘Šæ€»ç»“..."

    echo -e "\n---" >> "${REPORT_FILE}"
    echo -e "\n## ğŸ“Š æ‰«æç»“æœæ€»ç»“" >> "${REPORT_FILE}"

    local total_scans=${SCAN_RESULTS[total_scans]}
    local vulnerabilities_found=${SCAN_RESULTS[vulnerabilities_found]}
    local critical_vulnerabilities=${SCAN_RESULTS[critical_vulnerabilities]}
    local high_vulnerabilities=${SCAN_RESULTS[high_vulnerabilities]}
    local medium_vulnerabilities=${SCAN_RESULTS[medium_vulnerabilities]}
    local low_vulnerabilities=${SCAN_RESULTS[low_vulnerabilities]}
    local dependency_issues=${SCAN_RESULTS[dependency_issues]}
    local config_issues=${SCAN_RESULTS[config_issues]}
    local code_issues=${SCAN_RESULTS[code_issues]}

    cat >> "${REPORT_FILE}" << EOF

### ğŸ“ˆ å®‰å…¨æ‰«æç»Ÿè®¡

| æ‰«ææŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|----------|------|------|
| **æ€»æ‰«æé¡¹** | ${total_scans} | å®‰å…¨æ‰«ææ€»é¡¹ç›®æ•° |
| **å‘ç°æ¼æ´** | ${vulnerabilities_found} | å‘ç°çš„å®‰å…¨æ¼æ´æ€»æ•° |
| **ä¸¥é‡æ¼æ´** | ${critical_vulnerabilities} | ä¸¥é‡å®‰å…¨æ¼æ´æ•°é‡ |
| **é«˜å±æ¼æ´** | ${high_vulnerabilities} | é«˜å±å®‰å…¨æ¼æ´æ•°é‡ |
| **ä¸­å±æ¼æ´** | ${medium_vulnerabilities} | ä¸­å±å®‰å…¨æ¼æ´æ•°é‡ |
| **ä½å±æ¼æ´** | ${low_vulnerabilities} | ä½å±å®‰å…¨æ¼æ´æ•°é‡ |
| **ä¾èµ–é—®é¢˜** | ${dependency_issues} | ä¾èµ–åŒ…å®‰å…¨é—®é¢˜ |
| **é…ç½®é—®é¢˜** | ${config_issues} | é…ç½®å®‰å…¨é—®é¢˜ |
| **ä»£ç é—®é¢˜** | ${code_issues} | æºç å®‰å…¨é—®é¢˜ |

### ğŸ¯ ç³»ç»Ÿå®‰å…¨è¯„åˆ†

EOF

    # è®¡ç®—å®‰å…¨è¯„åˆ†
    local security_score=100
    if [[ $vulnerabilities_found -gt 0 ]]; then
        security_score=$((100 - (critical_vulnerabilities * 20) - (high_vulnerabilities * 10) - (medium_vulnerabilities * 5) - (low_vulnerabilities * 1)))
        if [[ $security_score -lt 0 ]]; then
            security_score=0
        fi
    fi

    local security_level="ä¼˜ç§€"
    if [[ $security_score -lt 60 ]]; then
        security_level="éœ€è¦ç´§æ€¥ä¿®å¤"
        echo "ğŸ”´ **ç³»ç»Ÿå®‰å…¨ç­‰çº§**: ${security_level} - å­˜åœ¨ä¸¥é‡å®‰å…¨é£é™©" >> "${REPORT_FILE}"
    elif [[ $security_score -lt 80 ]]; then
        security_level="éœ€è¦æ”¹è¿›"
        echo "ğŸŸ¡ **ç³»ç»Ÿå®‰å…¨ç­‰çº§**: ${security_level} - å­˜åœ¨å®‰å…¨é£é™©" >> "${REPORT_FILE}"
    else
        echo "ğŸŸ¢ **ç³»ç»Ÿå®‰å…¨ç­‰çº§**: ${security_level} - ç³»ç»Ÿå®‰å…¨æ€§è‰¯å¥½" >> "${REPORT_FILE}"
    fi

    cat >> "${REPORT_FILE}" << EOF

**ç³»ç»Ÿå®‰å…¨è¯„åˆ†: ${security_score}/100**

### ğŸš¨ æ¼æ´é£é™©åˆ†æ

#### ä¸¥é‡é£é™© (Critical)
EOF

    if [[ $critical_vulnerabilities -gt 0 ]]; then
        echo "- å‘ç°${critical_vulnerabilities}ä¸ªä¸¥é‡å®‰å…¨æ¼æ´ï¼Œéœ€è¦ç«‹å³ä¿®å¤" >> "${REPORT_FILE}"
    else
        echo "- âœ… æœªå‘ç°ä¸¥é‡å®‰å…¨æ¼æ´" >> "${REPORT_FILE}"
    fi

    cat >> "${REPORT_FILE}" << EOF

#### é«˜é£é™© (High)
EOF

    if [[ $high_vulnerabilities -gt 0 ]]; then
        echo "- å‘ç°${high_vulnerabilities}ä¸ªé«˜å±å®‰å…¨æ¼æ´ï¼Œå»ºè®®ä¼˜å…ˆä¿®å¤" >> "${REPORT_FILE}"
    else
        echo "- âœ… æœªå‘ç°é«˜å±å®‰å…¨æ¼æ´" >> "${REPORT_FILE}"
    fi

    cat >> "${REPORT_FILE}" << EOF

#### ä¸­ç­‰é£é™© (Medium)
EOF

    if [[ $medium_vulnerabilities -gt 0 ]]; then
        echo "- å‘ç°${medium_vulnerabilities}ä¸ªä¸­ç­‰å®‰å…¨æ¼æ´ï¼Œå»ºè®®åŠæ—¶ä¿®å¤" >> "${REPORT_FILE}"
    else
        echo "- âœ… æœªå‘ç°ä¸­ç­‰å®‰å…¨æ¼æ´" >> "${REPORT_FILE}"
    fi

    cat >> "${REPORT_FILE}" << EOF

### ğŸ”§ ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

#### ç«‹å³ä¿®å¤ (P0 - Critical)
1. **ç§»é™¤ç¡¬ç¼–ç å¯†ç **: ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†ç³»ç»Ÿ
2. **ä¿®å¤SQLæ³¨å…¥æ¼æ´**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
3. **å‡çº§æœ‰æ¼æ´çš„ä¾èµ–åŒ…**: å‡çº§åˆ°å®‰å…¨ç‰ˆæœ¬
4. **ä¿®å¤ååºåˆ—åŒ–æ¼æ´**: å®ç°å®‰å…¨çš„ååºåˆ—åŒ–æœºåˆ¶

#### ä¼˜å…ˆä¿®å¤ (P1 - High)
1. **å®ç°è¾“å‡ºç¼–ç **: é˜²æ­¢XSSæ”»å‡»
2. **åŠ å¼ºè¾“å…¥éªŒè¯**: é˜²æ­¢æ³¨å…¥æ”»å‡»
3. **é…ç½®å®‰å…¨å¤´éƒ¨**: å®ç°HTTPå®‰å…¨å¤´éƒ¨
4. **å®ç°CSRFé˜²æŠ¤**: é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ 

#### è®¡åˆ’ä¿®å¤ (P2 - Medium)
1. **æ”¹è¿›ä¼šè¯ç®¡ç†**: é…ç½®å®‰å…¨çš„ä¼šè¯ç­–ç•¥
2. **åŠ å¼ºæ—¥å¿—å®‰å…¨**: é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯
3. **ä¼˜åŒ–æƒé™æ§åˆ¶**: æé«˜æƒé™ä¿æŠ¤è¦†ç›–ç‡
4. **å®Œå–„é…ç½®å®‰å…¨**: ç§»é™¤ä¸å®‰å…¨çš„é…ç½®

#### åç»­ä¼˜åŒ– (P3 - Low)
1. **ä»£ç è§„èŒƒ**: éµå¾ªå®‰å…¨ç¼–ç è§„èŒƒ
2. **å®‰å…¨æµ‹è¯•**: æ·»åŠ è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•
3. **ç›‘æ§å‘Šè­¦**: å®ç°å®‰å…¨ç›‘æ§æœºåˆ¶
4. **æ–‡æ¡£å®Œå–„**: å®Œå–„å®‰å…¨é…ç½®æ–‡æ¡£

### âœ… å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç å¯†ç å’Œå¯†é’¥
- [ ] å‡çº§æ‰€æœ‰æœ‰æ¼æ´çš„ä¾èµ–åŒ…
- [ ] ä¿®å¤æ‰€æœ‰SQLæ³¨å…¥æ¼æ´
- [ ] ä¿®å¤æ‰€æœ‰XSSæ¼æ´
- [ ] å®ç°CSRFé˜²æŠ¤
- [ ] é…ç½®å®‰å…¨HTTPå¤´éƒ¨
- [ ] å®ç°å®‰å…¨çš„ä¼šè¯ç®¡ç†
- [ ] é…ç½®HTTPS/TLSä¼ è¾“åŠ å¯†
- [ ] å®ç°æ•°æ®åŠ å¯†å­˜å‚¨
- [ ] æ·»åŠ å®‰å…¨ç›‘æ§å’Œå‘Šè­¦
- [ ] å»ºç«‹å®‰å…¨å¼€å‘æµç¨‹
- [ ] å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡

### ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

#### å¼€å‘é˜¶æ®µ
1. **å®‰å…¨ç¼–ç åŸ¹è®­**: å®šæœŸè¿›è¡Œå®‰å…¨ç¼–ç åŸ¹è®­
2. **ä»£ç å®¡æŸ¥**: å¼ºåˆ¶æ€§çš„å®‰å…¨ä»£ç å®¡æŸ¥
3. **ä¾èµ–ç®¡ç†**: å®šæœŸæ›´æ–°å’Œæ‰«æä¾èµ–åŒ…
4. **å¨èƒå»ºæ¨¡**: åœ¨è®¾è®¡é˜¶æ®µè¿›è¡Œå¨èƒå»ºæ¨¡

#### æµ‹è¯•é˜¶æ®µ
1. **æ¸—é€æµ‹è¯•**: å®šæœŸè¿›è¡Œæ¸—é€æµ‹è¯•
2. **è‡ªåŠ¨åŒ–æ‰«æ**: é›†æˆè‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ
3. **å®‰å…¨æµ‹è¯•**: åŠŸèƒ½æ€§å’Œå®‰å…¨æ€§å¹¶è¡Œæµ‹è¯•
4. **æ¼æ´ç®¡ç†**: å»ºç«‹æ¼æ´è·Ÿè¸ªå’Œä¿®å¤æµç¨‹

#### éƒ¨ç½²é˜¶æ®µ
1. **å®‰å…¨é…ç½®**: ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
2. **ç½‘ç»œéš”ç¦»**: å®ç°ç½‘ç»œåˆ†æ®µå’Œéš”ç¦»
3. **è®¿é—®æ§åˆ¶**: æœ€å°æƒé™è®¿é—®æ§åˆ¶
4. **ç›‘æ§å‘Šè­¦**: å®æ—¶å®‰å…¨ç›‘æ§å’Œå‘Šè­¦

#### è¿ç»´é˜¶æ®µ
1. **å®‰å…¨æ›´æ–°**: åŠæ—¶åº”ç”¨å®‰å…¨è¡¥ä¸
2. **æ—¥å¿—å®¡è®¡**: å®šæœŸå®‰å…¨æ—¥å¿—å®¡è®¡
3. **åº”æ€¥å“åº”**: å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æµç¨‹
4. **å®šæœŸè¯„ä¼°**: å®šæœŸå®‰å…¨é£é™©è¯„ä¼°

EOF

    # æ ¹æ®æ‰«æç»“æœç»™å‡ºæ€»ä½“è¯„ä»·
    if [[ $critical_vulnerabilities -gt 0 ]]; then
        echo -e "âš ï¸ **æ€»ä½“è¯„ä»·**: å‘ç°${critical_vulnerabilities}ä¸ªä¸¥é‡æ¼æ´ï¼Œç³»ç»Ÿå­˜åœ¨é‡å¤§å®‰å…¨é£é™©ï¼Œéœ€è¦ç«‹å³ä¿®å¤" >> "${REPORT_FILE}"
    elif [[ $vulnerabilities_found -gt 0 ]]; then
        echo -e "âš ï¸ **æ€»ä½“è¯„ä»·**: å‘ç°${vulnerabilities_found}ä¸ªå®‰å…¨æ¼æ´ï¼Œå»ºè®®å°½å¿«ä¿®å¤ä»¥æå‡ç³»ç»Ÿå®‰å…¨æ€§" >> "${REPORT_FILE}"
    else
        echo -e "âœ… **æ€»ä½“è¯„ä»·**: æœªå‘ç°æ˜æ˜¾çš„å®‰å…¨æ¼æ´ï¼Œç³»ç»Ÿå®‰å…¨æ€§è‰¯å¥½ï¼Œå»ºè®®ç»§ç»­ä¿æŒå®‰å…¨å®è·µ" >> "${REPORT_FILE}"
    fi
}

# ä¸»å‡½æ•°
main() {
    echo -e "${CYAN}"
    cat << 'EOF'
 _____ _   _ ____  _____ _______       _   _ _____ ____
| ____| \ | |  _ \| ____|__   __|____ | | | |_   _/ ___|
|  _| |  \| | | | |  _|    | |/ _ \ \ / / | | | || |
| |___| |\  | |_| | |___   | | (_) \ V /| |_| | | |
|_____|_| \_|____/|_____|  |_|\___/ \_/  \___/  |_|

               ç³»ç»Ÿå®‰å…¨æ¼æ´æ‰«æå·¥å…·
EOF
    echo -e "${NC}"

    log_info "å¼€å§‹IOE-DREAMç³»ç»Ÿå®‰å…¨æ¼æ´æ‰«æ..."

    # åˆå§‹åŒ–æ‰«ææŠ¥å‘Š
    init_scan_report

    # æ‰§è¡Œå„é¡¹æ‰«æ
    scan_dependency_vulnerabilities
    scan_configuration_vulnerabilities
    scan_code_vulnerabilities
    scan_system_security
    scan_network_security
    scan_auth_security

    # ç”Ÿæˆæ‰«ææ€»ç»“
    generate_scan_summary

    # è¾“å‡ºæ‰«æç»“æœ
    echo -e "\n${GREEN}=== å®‰å…¨æ¼æ´æ‰«æå®Œæˆ ===${NC}"
    echo -e "æ€»æ‰«æé¡¹: ${SCAN_RESULTS[total_scans]}"
    echo -e "å‘ç°æ¼æ´: ${RED}${SCAN_RESULTS[vulnerabilities_found]}${NC}"
    echo -e "ä¸¥é‡æ¼æ´: ${PURPLE}${SCAN_RESULTS[critical_vulnerabilities]}${NC}"
    echo -e "é«˜å±æ¼æ´: ${RED}${SCAN_RESULTS[high_vulnerabilities]}${NC}"
    echo -e "ä¸­å±æ¼æ´: ${YELLOW}${SCAN_RESULTS[medium_vulnerabilities]}${NC}"
    echo -e "ä½å±æ¼æ´: ${GREEN}${SCAN_RESULTS[low_vulnerabilities]}${NC}"
    echo -e "ä¾èµ–é—®é¢˜: ${YELLOW}${SCAN_RESULTS[dependency_issues]}${NC}"
    echo -e "é…ç½®é—®é¢˜: ${YELLOW}${SCAN_RESULTS[config_issues]}${NC}"
    echo -e "ä»£ç é—®é¢˜: ${YELLOW}${SCAN_RESULTS[code_issues]}${NC}"
    echo -e "\nè¯¦ç»†æŠ¥å‘Š: ${BLUE}${REPORT_FILE}${NC}"

    # æ ¹æ®ç»“æœè¿”å›é€€å‡ºç 
    if [[ ${SCAN_RESULTS[critical_vulnerabilities]} -gt 0 ]]; then
        exit 1
    elif [[ ${SCAN_RESULTS[vulnerabilities_found]} -gt 0 ]]; then
        exit 2
    else
        exit 0
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"