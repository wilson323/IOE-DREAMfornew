<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.admin.module.system.area.dao.AreaDao">

    <!-- 通用ResultMap -->
    <resultMap id="AreaVOMap" type="net.lab1024.sa.admin.module.system.area.domain.vo.AreaVO">
        <id property="areaId" column="area_id"/>
        <result property="areaCode" column="area_code"/>
        <result property="areaName" column="area_name"/>
        <result property="areaType" column="area_type"/>
        <result property="areaLevel" column="area_level"/>
        <result property="parentId" column="parent_id"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="areaConfig" column="area_config" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result property="areaDesc" column="area_desc"/>
        <result property="managerId" column="manager_id"/>
        <result property="managerName" column="manager_name"/>
        <result property="contactPhone" column="contact_phone"/>
        <result property="address" column="address"/>
        <result property="longitude" column="longitude"/>
        <result property="latitude" column="latitude"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createUserId" column="create_user_id"/>
        <result property="createUserName" column="create_user_name"/>
        <result property="updateUserId" column="update_user_id"/>
        <result property="updateUserName" column="update_user_name"/>
    </resultMap>

    <!-- 通用查询列 -->
    <sql id="AreaColumns">
        a.area_id,
        a.area_code,
        a.area_name,
        a.area_type,
        a.area_level,
        a.parent_id,
        a.sort_order,
        a.area_config,
        a.area_desc,
        a.manager_id,
        a.contact_phone,
        a.address,
        a.longitude,
        a.latitude,
        a.status,
        a.create_time,
        a.update_time,
        a.create_user_id,
        a.update_user_id,
        me.actual_name as manager_name,
        ce.actual_name as create_user_name,
        ue.actual_name as update_user_name
    </sql>

    <!-- 通用FROM子句 -->
    <sql id="AreaFromClause">
        FROM t_area a
        LEFT JOIN t_employee me ON a.manager_id = me.employee_id
        LEFT JOIN t_employee ce ON a.create_user_id = ce.employee_id
        LEFT JOIN t_employee ue ON a.update_user_id = ue.employee_id
    </sql>

    <!-- 通用WHERE条件 -->
    <sql id="AreaWhereClause">
        <where>
            <if test="queryForm.includeDeleted == null or queryForm.includeDeleted == false">
                AND a.deleted_flag = 0
            </if>
            <if test="queryForm.areaCode != null and queryForm.areaCode != ''">
                AND a.area_code LIKE CONCAT('%', #{queryForm.areaCode}, '%')
            </if>
            <if test="queryForm.areaName != null and queryForm.areaName != ''">
                AND a.area_name LIKE CONCAT('%', #{queryForm.areaName}, '%')
            </if>
            <if test="queryForm.areaType != null and queryForm.areaType != ''">
                AND a.area_type = #{queryForm.areaType}
            </if>
            <if test="queryForm.areaLevel != null">
                AND a.area_level = #{queryForm.areaLevel}
            </if>
            <if test="queryForm.parentId != null">
                AND a.parent_id = #{queryForm.parentId}
            </if>
            <if test="queryForm.managerId != null">
                AND a.manager_id = #{queryForm.managerId}
            </if>
            <if test="queryForm.status != null">
                AND a.status = #{queryForm.status}
            </if>
        </where>
    </sql>

    <!-- 分页查询区域 -->
    <select id="queryPage" resultMap="AreaVOMap">
        SELECT
        <include refid="AreaColumns"/>
        <include refid="AreaFromClause"/>
        <include refid="AreaWhereClause"/>
        ORDER BY a.sort_order ASC, a.create_time DESC
    </select>

    <!-- 根据区域ID查询区域详情 -->
    <select id="selectAreaVO" resultMap="AreaVOMap">
        SELECT
        <include refid="AreaColumns"/>
        <include refid="AreaFromClause"/>
        WHERE a.area_id = #{areaId}
        AND a.deleted_flag = 0
    </select>

    <!-- 查询所有区域列表 -->
    <select id="listAll" resultMap="AreaVOMap">
        SELECT
        <include refid="AreaColumns"/>
        <include refid="AreaFromClause"/>
        WHERE a.deleted_flag = 0
        ORDER BY a.sort_order ASC, a.create_time DESC
    </select>

    <!-- 根据父区域ID查询子区域数量 -->
    <select id="countByParentId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM t_area
        WHERE parent_id = #{parentId}
        AND deleted_flag = 0
    </select>

    <!-- 根据区域编码查询区域 -->
    <select id="selectByAreaCode" resultType="net.lab1024.sa.admin.module.system.area.domain.entity.AreaEntity">
        SELECT *
        FROM t_area
        WHERE area_code = #{areaCode}
        AND deleted_flag = 0
        LIMIT 1
    </select>

    <!-- 查询某个区域下的所有子区域（递归） -->
    <select id="selectChildrenAreaIds" resultType="java.lang.Long">
        WITH RECURSIVE area_tree AS (
            -- 基础查询：选择指定区域
            SELECT area_id, parent_id
            FROM t_area
            WHERE area_id = #{areaId}
            AND deleted_flag = 0

            UNION ALL

            -- 递归查询：查找子区域
            SELECT a.area_id, a.parent_id
            FROM t_area a
            INNER JOIN area_tree at ON a.parent_id = at.area_id
            WHERE a.deleted_flag = 0
        )
        SELECT area_id FROM area_tree WHERE area_id != #{areaId}
    </select>

</mapper>
