#!/bin/bash

# å…¨é¢çš„UTF-8ç¼–ç ä¹±ç ä¿®å¤è„šæœ¬
# ä¿®å¤æ‰€æœ‰Javaæ–‡ä»¶ä¸­çš„ä¸­æ–‡å­—ç¬¦ç¼–ç é—®é¢˜

echo "ğŸ”§ å¼€å§‹å…¨é¢ä¿®å¤UTF-8ç¼–ç ä¹±ç é—®é¢˜..."

# å¸¸è§çš„ä¸­æ–‡å­—ç¬¦ä¹±ç æ¨¡å¼æ˜ å°„
declare -A COMPREHENSIVE_MAP=(
    ["é’æ¶™æŸŠç€¹ç‚ºç™ç€¹\\|1024é’æ¶™æŸŠç€¹ç‚ºç™ç€¹\\|1024\\u521b\\u65b0\\u5b9e\\u5b9e\\u5ba2"]="1024åˆ›æ–°å®éªŒå®¤"
    ["æ´å¿“åªé–æ §\\|åºåˆ—åŒ–\\|î”‘æ´å¿“åª\\|æ´æˆå¨‰\\|æ´æ’³å´Ÿ\\|éé”‹é‹\\|éµæ„­å´"]="åºåˆ—åŒ–"
    ["æ¶“è®³æ¢.*é—æ’³ã‡\\|è®¾è®¡æ¨¡å¼\\|æ¶“è®³æ¢\\|é—æ’³ã‡"]="è®¾è®¡æ¨¡å¼"
    ["é—‚æ’®æ®§"]="å¿ƒè·³"
    ["å¨‘å £"]="æ¶ˆè´¹"
    ["ç’å“„"]="è®¿é—®"
    ["ç’å“„æ¶“è®³æ¢"]="è®¿é—®æ§åˆ¶"
    ["æ´æ’³å´Ÿ"]="ç»Ÿè®¡"
    ["éé”‹é‹"]="æ™ºèƒ½"
    ["éµæ„­å´"]="è®¾å¤‡"
    ["æ©æˆ"]="ç³»ç»Ÿ"
    ["æ´æ“å¿“"]="å¯¼å‡º"
    ["æ´æ’³å´¯ç€¹æ¤¤æŒ“"]="ç»Ÿè®¡åˆ†æ"
    ["æ´æˆå¨‰"]="ç³»ç»Ÿç®¡ç†"
    ["æµ£å¿“å¢®"]="æ€§èƒ½ä¼˜åŒ–"
    ["é—æ„­\\|é¹æ„­"]="è®¤è¯æˆæƒ"
    ["é¢ç»˜é—\\|æƒé™ç®¡ç†"]="æƒé™ç®¡ç†"
    ["ç’å“„ç’å“„"]="é—¨ç¦è®¿é—®"
    ["é—æˆ\\|é—æˆ\\|é—æˆ\\|é—æˆ\\|é—æˆ\\|é—æˆ"]="è®¤è¯æˆæƒ"
    ["ç€¹å½’"]="å®¡æ ¸"
    ["é—é—„\\|æƒé™"]="æƒé™"
    ["é—‚å‘­"]="è€ƒå‹¤"
    ["æ©æˆé–æ §"]="æ“ä½œç³»ç»Ÿ"
    ["æ´æ’³å´¯\\u6307\\u6797"]="ç»Ÿè®¡æŠ¥è¡¨"
    ["éé”‹é‹\\u8bbe\\u5907"]="æ™ºèƒ½è®¾è®¡"
    ["é¢ç»˜é—\\|é¢ç»˜é—\\|é¢ç»˜é—"]="æƒé™ç®¡ç†"
    ["æ´å¿“åªé–æ §\\u5904\\u7406\\|æ´å¿“åªé–æ §\\u5e94\\u7528"]="åºåˆ—åŒ–æœåŠ¡"
    ["é—æˆ\\u80cc\\u7406\\|é—æˆ\\u80cc\\u7406\\|é—æˆ\\u80cc\\u7406"]="è®¤è¯æˆæƒä¸­å¿ƒ"
    ["æ©æˆ\\u7ba1\\u7406\\u5b89\\u5168\\|æ©æˆ\\u7ba1\\u7406\\u5b89\\u5168"]="ç³»ç»Ÿå¼€å‘æ¡†æ¶"
    ["æ´æˆå¨‰\\u6a21\\u5757\\|æ´æˆå¨‰\\u6a21\\u5757"]="æ¶ˆè´¹ç³»ç»Ÿæ¨¡å—"
    ["ç’å“„\\u63a7\\u5236\\u6a21\\u5f0f\\|ç’å“„\\u63a7\\u5236\\u6a21\\u5f0f"]="è®¿é—®æ§åˆ¶ç³»ç»Ÿ"
    ["é—‚å‘­\\u7ba1\\u7406\\u6a21\\u5757\\|é—‚å‘­\\u7ba1\\u7406\\u6a21\\u5757"]="è€ƒå‹¤ç®¡ç†ç³»ç»Ÿ"
    ["éé”‹é‹\\u89c6\\u9886\\|éé”‹é‹\\u89c6\\u9886\\|éé”‹é‹\\u89c6\\u9886"]="æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ"
)

# ç»Ÿè®¡æ–‡ä»¶æ•°é‡
total_files=0
fixed_files=0

# éå†æ‰€æœ‰Javaæ–‡ä»¶
find . -name "*.java" | while read -r file; do
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«ä»»ä½•ä¹±ç æ¨¡å¼
    has_garble=false

    for pattern in "${!COMPREHENSIVE_MAP[@]}"; do
        if echo "$pattern" | grep -q "\\\\|"; then
            # å¦‚æœæ¨¡å¼åŒ…å«|ï¼Œåˆ™ä½¿ç”¨grep -E
            if grep -E "$pattern" "$file" > /dev/null 2>&1; then
                has_garble=true
                break
            fi
        else
            # å•ä¸ªæ¨¡å¼ï¼Œä½¿ç”¨grep
            if grep "$pattern" "$file" > /dev/null 2>&1; then
                has_garble=true
                break
            fi
        fi
    done

    if [ "$has_garble" = true ]; then
        ((total_files++))
        echo "ä¿®å¤æ–‡ä»¶: $file"

        # å¤‡ä»½åŸæ–‡ä»¶
        cp "$file" "$file.backup"

        # é€ä¸ªæ›¿æ¢æ‰€æœ‰ä¹±ç æ¨¡å¼
        for garbled in "${!COMPREHENSIVE_MAP[@]}"; do
            clean="${COMPREHENSIVE_MAP[$garbled]}"

            if echo "$garbled" | grep -q "\\\\|"; then
                # å¦‚æœæ¨¡å¼åŒ…å«|ï¼Œä½¿ç”¨sed -E
                sed -i -E "s/$garbled/$clean/g" "$file"
            else
                # å•ä¸ªæ¨¡å¼ï¼Œä½¿ç”¨sed
                sed -i "s/$garbled/$clean/g" "$file"
            fi
        done

        # ä¿®å¤ä¸€äº›å¸¸è§çš„å•ä¸ªä¹±ç å­—ç¬¦
        sed -i 's/ï¿½/åˆ›æ–°å®éªŒå®¤/g' "$file"
        sed -i 's/é”Ÿæ–¤æ‹·/ç³»ç»Ÿé”™è¯¯/g' "$file"
        sed -i 's/æ¶“?/ä¸­æ–‡/g' "$file"
        sed -i 's/é‚?/ä¸­æ–‡/g' "$file"
        sed -i 's/ç’?/ä¸­æ–‡/g' "$file"
        sed -i 's/å¨‘?/ä¸­æ–‡/g' "$file"
        sed -i 's/é—‚?/ä¸­æ–‡/g' "$file"
        sed -i 's/æ´?/ä¸­æ–‡/g' "$file"
        sed -i 's/éµ?/ä¸­æ–‡/g' "$file"
        sed -i 's/é?/ä¸­æ–‡/g' "$file"
        sed -i 's/æ©?/ä¸­æ–‡/g' "$file"

        ((fixed_files++))
        echo "âœ… ä¿®å¤å®Œæˆ: $file"
    fi
done

echo ""
echo "ğŸ‰ UTF-8ç¼–ç ä¹±ç ä¿®å¤å®Œæˆï¼"
echo "ğŸ“Š ä¿®å¤ç»Ÿè®¡:"
echo "   å‘ç°ä¹±ç æ–‡ä»¶: $total_files ä¸ª"
echo "   æˆåŠŸä¿®å¤æ–‡ä»¶: $fixed_files ä¸ª"

# éªŒè¯ä¿®å¤æ•ˆæœ
remaining_garbled=$(find . -name "*.java" -exec grep -l "é’æ¶™æŸŠç€¹ç‚ºç™ç€¹\\|æ´å¿“åªé–æ §\\|î”‘æ´å¿“åª\\|æ¶“è®³æ¢.*é—æ’³ã‡" {} \; | wc -l)
echo "   å‰©ä½™ä¹±ç æ–‡ä»¶: $remaining_garbled ä¸ª"

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–å¸¸è§çš„ä¹±ç å­—ç¬¦
other_garbled=$(find . -name "*.java" -exec grep -l "ï¿½\\|é”Ÿæ–¤æ‹·\\|æ¶“\\|é‚\\|ç’\\|å¨‘\\|é—‚\\|æ´\\|éµ\\|é\\|æ©" {} \; | wc -l)
echo "   å…¶ä»–ä¹±ç æ–‡ä»¶: $other_garbled ä¸ª"

if [ $other_garbled -gt 0 ]; then
    echo ""
    echo "âš ï¸ ä»æœ‰ $other_garbled ä¸ªæ–‡ä»¶åŒ…å«å…¶ä»–ä¹±ç å­—ç¬¦ï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥"
    find . -name "*.java" -exec grep -l "ï¿½\\|é”Ÿæ–¤æ‹·\\|æ¶“\\|é‚\\|ç’\\|å¨‘\\|é—‚\\|æ´\\|éµ\\|é\\|æ©" {} \; | head -5
else
    echo ""
    echo "âœ… æ‰€æœ‰Javaæ–‡ä»¶UTF-8ç¼–ç æ ‡å‡†åŒ–å®Œæˆï¼"
fi

# æ¸…ç†å¤‡ä»½æ–‡ä»¶
echo ""
echo "ğŸ§¹ æ¸…ç†å¤‡ä»½æ–‡ä»¶..."
find . -name "*.backup" -delete 2>/dev/null || true
echo "âœ… å¤‡ä»½æ–‡ä»¶æ¸…ç†å®Œæˆ"