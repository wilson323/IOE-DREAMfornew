# IOE-DREAM 完整项目 Docker Compose 配置
# 包含所有基础设施服务和微服务
# 注意: Docker Compose v2+ 不再需要 version 字段

services:
  # ==================== 基础设施服务 ====================
  
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: ioedream-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ioedream
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./deployment/mysql/init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ioedream-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: ioedream-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - ioedream-network

  # Nacos注册中心
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: ioedream-nacos
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - NACOS_AUTH_ENABLE=true
      - NACOS_AUTH_TOKEN=${NACOS_AUTH_TOKEN:-SecretKey012345678901234567890123456789012345678901234567890123456789}
      - NACOS_AUTH_IDENTITY_KEY=nacos
      - NACOS_AUTH_IDENTITY_VALUE=nacos
      - TZ=Asia/Shanghai
    ports:
      - "8848:8848"
      - "9848:9848"
    volumes:
      - nacos_data:/home/nacos/data
      - nacos_logs:/home/nacos/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ioedream-network

  # ==================== 微服务 ====================

  # API网关服务
  gateway-service:
    build:
      context: .
      dockerfile: microservices/ioedream-gateway-service/Dockerfile
    image: ioedream/gateway-service:latest
    container_name: ioedream-gateway-service
    environment:
      - SERVER_PORT=8080
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8080:8080"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 公共业务服务
  common-service:
    build:
      context: .
      dockerfile: microservices/ioedream-common-service/Dockerfile
    image: ioedream/common-service:latest
    container_name: ioedream-common-service
    environment:
      - SERVER_PORT=8088
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8088:8088"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 设备通讯服务
  device-comm-service:
    build:
      context: .
      dockerfile: microservices/ioedream-device-comm-service/Dockerfile
    image: ioedream/device-comm-service:latest
    container_name: ioedream-device-comm-service
    environment:
      - SERVER_PORT=8087
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8087:8087"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # OA服务
  oa-service:
    build:
      context: .
      dockerfile: microservices/ioedream-oa-service/Dockerfile
    image: ioedream/oa-service:latest
    container_name: ioedream-oa-service
    environment:
      - SERVER_PORT=8089
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8089:8089"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 门禁服务
  access-service:
    build:
      context: .
      dockerfile: microservices/ioedream-access-service/Dockerfile
    image: ioedream/access-service:latest
    container_name: ioedream-access-service
    environment:
      - SERVER_PORT=8090
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8090:8090"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 考勤服务
  attendance-service:
    build:
      context: .
      dockerfile: microservices/ioedream-attendance-service/Dockerfile
    image: ioedream/attendance-service:latest
    container_name: ioedream-attendance-service
    environment:
      - SERVER_PORT=8091
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8091:8091"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 视频服务
  video-service:
    build:
      context: .
      dockerfile: microservices/ioedream-video-service/Dockerfile
    image: ioedream/video-service:latest
    container_name: ioedream-video-service
    environment:
      - SERVER_PORT=8092
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8092:8092"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 消费服务
  consume-service:
    build:
      context: .
      dockerfile: microservices/ioedream-consume-service/Dockerfile
    image: ioedream/consume-service:latest
    container_name: ioedream-consume-service
    environment:
      - SERVER_PORT=8094
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8094:8094"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 访客服务
  visitor-service:
    build:
      context: .
      dockerfile: microservices/ioedream-visitor-service/Dockerfile
    image: ioedream/visitor-service:latest
    container_name: ioedream-visitor-service
    environment:
      - SERVER_PORT=8095
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=public
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root}
      - TZ=Asia/Shanghai
    ports:
      - "8095:8095"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

# ==================== 数据卷 ====================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  nacos_data:
    driver: local
  nacos_logs:
    driver: local

# ==================== 网络 ====================
networks:
  ioedream-network:
    driver: bridge
    name: ioedream-network
