# IOE-DREAM 完整项目 Docker Compose 配置
# 包含所有基础设施服务和微服务
# 统一使用根目录.env文件作为配置源
# 注意: Docker Compose v2+ 不再需要 version 字段

services:
  # ==================== 基础设施服务 ====================

  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: ioedream-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ioedream
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./deployment/mysql/init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ioedream-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: ioedream-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      # 修复：健康检查需要提供Redis密码
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - ioedream-network

  # 数据库自动初始化服务
  # 按顺序执行 deployment/mysql/init/ 目录下的所有SQL文件
  db-init:
    image: mysql:8.0
    container_name: ioedream-db-init
    environment:
      MYSQL_PWD: ${MYSQL_ROOT_PASSWORD}
      ENVIRONMENT: ${ENVIRONMENT:-dev}  # 环境变量：dev/test/prod
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo '=========================================='
        echo '  IOE-DREAM 数据库初始化服务'
        echo '=========================================='
        echo ''
        echo '[1/3] 等待MySQL服务就绪...'
        max_retries=30
        retry_count=0
        until mysql -h mysql -uroot -e 'SELECT 1' > /dev/null 2>&1; do
          retry_count=$$((retry_count + 1))
          if [ $$retry_count -ge $$max_retries ]; then
            echo '错误: MySQL连接超时!'
            exit 1
          fi
          echo "  等待MySQL... ($$retry_count/$$max_retries)"
          sleep 3
        done
        echo '  MySQL已就绪 ✓'
        echo ''
        echo '[2/5] 检查环境配置...'
        ENV=$${ENVIRONMENT:-dev}
        echo "  当前环境: $$ENV"
        echo ''

        # 脚本执行函数（必须在调用前定义）
        execute_script() {
          local sql_file=$$1
          if [ -f "$$sql_file" ]; then
            SCRIPT_COUNT=$$((SCRIPT_COUNT + 1))
            SCRIPT_NAME=$$(basename "$$sql_file")
            echo "  [$$SCRIPT_COUNT] 执行: $$SCRIPT_NAME"
            START_TIME=$$(date +%s)
            if mysql -h mysql -uroot < "$$sql_file" 2>&1 | tee "/tmp/db-init-$$SCRIPT_NAME.log"; then
              END_TIME=$$(date +%s)
              DURATION=$$((END_TIME - START_TIME))
              echo "    ✓ 完成 (耗时: $$DURATION秒)"
              SUCCESS_COUNT=$$((SUCCESS_COUNT + 1))
            else
              END_TIME=$$(date +%s)
              ERROR_LOG=$$(cat "/tmp/db-init-$$SCRIPT_NAME.log" 2>/dev/null || echo "未知错误")
              echo "    ✗ 失败!"
              echo "    错误信息: $$ERROR_LOG"
              FAILED_SCRIPTS="$$FAILED_SCRIPTS $$SCRIPT_NAME"
              echo "    错误: 脚本执行失败，停止初始化流程!"
              exit 1
            fi
          fi
        }

        echo '[3/5] 执行数据库初始化脚本（版本管理和环境隔离）...'
        SCRIPT_COUNT=0
        SUCCESS_COUNT=0
        FAILED_SCRIPTS=""

        # 定义脚本执行顺序（按文件名排序，但排除环境特定脚本）
        # 1. 版本检查脚本
        # 2. 表结构脚本
        # 3. 基础数据脚本（所有环境通用）
        # 4. 环境特定数据脚本（根据ENVIRONMENT选择）
        # 5. Nacos脚本

        # 执行版本检查脚本
        if [ -f "/init-sql/00-version-check.sql" ]; then
          execute_script "/init-sql/00-version-check.sql"
        fi

        # 执行表结构脚本
        if [ -f "/init-sql/01-ioedream-schema.sql" ]; then
          execute_script "/init-sql/01-ioedream-schema.sql"
        fi

        # 执行基础数据脚本（所有环境通用）
        if [ -f "/init-sql/02-ioedream-data.sql" ]; then
          execute_script "/init-sql/02-ioedream-data.sql"
        fi

        # 根据环境选择执行环境特定数据脚本
        ENV_DATA_SCRIPT=""
        case "$$ENV" in
          dev)
            ENV_DATA_SCRIPT="/init-sql/02-ioedream-data-dev.sql"
            ;;
          test)
            ENV_DATA_SCRIPT="/init-sql/02-ioedream-data-test.sql"
            ;;
          prod)
            ENV_DATA_SCRIPT="/init-sql/02-ioedream-data-prod.sql"
            ;;
          *)
            echo "  警告: 未知环境 $$ENV，使用开发环境配置"
            ENV_DATA_SCRIPT="/init-sql/02-ioedream-data-dev.sql"
            ;;
        esac

        if [ -f "$$ENV_DATA_SCRIPT" ]; then
          echo "  执行环境特定数据脚本: $$(basename $$ENV_DATA_SCRIPT)"
          execute_script "$$ENV_DATA_SCRIPT"
        else
          echo "  警告: 环境特定数据脚本不存在: $$ENV_DATA_SCRIPT"
        fi

        # 执行索引优化脚本（性能优化：在数据插入后创建索引）
        if [ -f "/init-sql/03-optimize-indexes.sql" ]; then
          execute_script "/init-sql/03-optimize-indexes.sql"
        fi

        # 执行V2.0.x版本迁移脚本（增量更新）
        if [ -f "/init-sql/04-v2.0.0__enhance-consume-record.sql" ]; then
          execute_script "/init-sql/04-v2.0.0__enhance-consume-record.sql"
        fi

        if [ -f "/init-sql/05-v2.0.1__enhance-account-table.sql" ]; then
          execute_script "/init-sql/05-v2.0.1__enhance-account-table.sql"
        fi

        if [ -f "/init-sql/06-v2.0.2__create-refund-table.sql" ]; then
          execute_script "/init-sql/06-v2.0.2__create-refund-table.sql"
        fi

        if [ -f "/init-sql/07-v2.1.0__api-compatibility-validation.sql" ]; then
          execute_script "/init-sql/07-v2.1.0__api-compatibility-validation.sql"
        fi

        # 执行Nacos脚本
        if [ -f "/init-sql/nacos-schema.sql" ]; then
          execute_script "/init-sql/nacos-schema.sql"
        fi
        echo "  执行统计: 总计 $$SCRIPT_COUNT 个脚本，成功 $$SUCCESS_COUNT 个"
        if [ -n "$$FAILED_SCRIPTS" ]; then
          echo "  失败的脚本: $$FAILED_SCRIPTS"
          exit 1
        fi
        echo ''
        echo '[4/5] 验证数据库状态...'
        echo '  检查ioedream数据库:'
        IOEDREAM_TABLES=$$(mysql -h mysql -uroot -N -e "SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='ioedream';" 2>/dev/null || echo '0')
        echo "    表数量: $$IOEDREAM_TABLES"
        IOEDREAM_DICT_COUNT=$$(mysql -h mysql -uroot -N -e "SELECT COUNT(*) FROM ioedream.t_common_dict_type;" 2>/dev/null || echo '0')
        echo "    字典类型数量: $$IOEDREAM_DICT_COUNT"
        IOEDREAM_USER_COUNT=$$(mysql -h mysql -uroot -N -e "SELECT COUNT(*) FROM ioedream.t_common_user;" 2>/dev/null || echo '0')
        echo "    用户数量: $$IOEDREAM_USER_COUNT"
        if [ "$$IOEDREAM_TABLES" -lt 20 ]; then
          echo '  ✗ 错误: ioedream表数量不足，初始化不完整!'
          exit 1
        fi
        if [ "$$IOEDREAM_DICT_COUNT" -lt 10 ]; then
          echo '  ✗ 错误: ioedream字典数据不足，初始化不完整!'
          exit 1
        fi
        if [ "$$IOEDREAM_USER_COUNT" -lt 1 ]; then
          echo '  ✗ 错误: ioedream用户数据不足，初始化不完整!'
          exit 1
        fi
        echo '  检查nacos数据库:'
        NACOS_TABLES=$$(mysql -h mysql -uroot -N -e "SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='nacos';" 2>/dev/null || echo '0')
        echo "    表数量: $$NACOS_TABLES"
        if [ "$$NACOS_TABLES" -lt 10 ]; then
          echo '  ✗ 错误: Nacos表数量不足，初始化不完整!'
          exit 1
        fi
        echo ''
        echo '[5/5] 验证数据库版本记录...'
        MIGRATION_COUNT=$$(mysql -h mysql -uroot -N -e "SELECT COUNT(*) FROM ioedream.t_migration_history;" 2>/dev/null || echo '0')
        echo "    迁移记录数量: $$MIGRATION_COUNT"
        if [ "$$MIGRATION_COUNT" -lt 1 ]; then
          echo '  ⚠ 警告: 迁移历史记录为空，但数据库可能已初始化'
        fi
        echo ''
        echo ''
        echo '=========================================='
        echo '  ✓ 数据库初始化完成!'
        echo '=========================================='
        echo '  初始化统计:'
        echo "    - ioedream表: $$IOEDREAM_TABLES 个"
        echo "    - ioedream字典: $$IOEDREAM_DICT_COUNT 个"
        echo "    - ioedream用户: $$IOEDREAM_USER_COUNT 个"
        echo "    - nacos表: $$NACOS_TABLES 个"
        echo "    - 迁移记录: $$MIGRATION_COUNT 条"
        echo '=========================================='
    volumes:
      - ./deployment/mysql/init:/init-sql:ro
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ioedream-network
    restart: "no"

  # Nacos注册中心
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: ioedream-nacos
    environment:
      # 运行模式
      - MODE=standalone
      # 数据库配置 - 与MySQL服务保持一致
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      # 内置数据库连接池优化（解决启动缓慢问题）
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=10000&socketTimeout=30000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai
      # 认证配置
      - NACOS_AUTH_ENABLE=true
      - NACOS_AUTH_TOKEN=${NACOS_AUTH_TOKEN}
      - NACOS_AUTH_IDENTITY_KEY=nacos
      - NACOS_AUTH_IDENTITY_VALUE=nacos
      # JVM配置优化（低内存环境）
      - JVM_XMS=256m
      - JVM_XMX=512m
      - JVM_XMN=128m
      - TZ=Asia/Shanghai
    mem_limit: 768m
    mem_reservation: 512m
    ports:
      - "8848:8848"
      - "9848:9848"
      - "9849:9849"
    volumes:
      - nacos_data:/home/nacos/data
      - nacos_logs:/home/nacos/logs
    healthcheck:
      # 修复：使用TCP端口检查（Nacos镜像不包含wget/curl，但支持TCP检查）
      # Nacos 2.3.0 健康检查：检查8848端口是否可访问
      # 如果端口开放且Nacos进程运行，则认为健康
      test: ["CMD-SHELL", "timeout 3 bash -c '</dev/tcp/localhost/8848' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 90s
    depends_on:
      mysql:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - ioedream-network

  # RabbitMQ消息队列
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: ioedream-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "5672:5672"          # AMQP端口
      - "15672:15672"        # 管理界面端口
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - rabbitmq_logs:/var/log/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - ioedream-network

  # ==================== 微服务 ====================

  # API网关服务
  gateway-service:
    build:
      context: .
      dockerfile: microservices/ioedream-gateway-service/Dockerfile
    image: ioedream/gateway-service:latest
    container_name: ioedream-gateway-service
    environment:
      - SERVER_PORT=8080
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-gateway-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8080:8080"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 公共业务服务
  common-service:
    build:
      context: .
      dockerfile: microservices/ioedream-common-service/Dockerfile
    image: ioedream/common-service:latest
    container_name: ioedream-common-service
    environment:
      - SERVER_PORT=8088
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-common-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8088:8088"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 设备通讯服务
  device-comm-service:
    build:
      context: .
      dockerfile: microservices/ioedream-device-comm-service/Dockerfile
    image: ioedream/device-comm-service:latest
    container_name: ioedream-device-comm-service
    environment:
      - SERVER_PORT=8087
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-device-comm-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8087:8087"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # OA服务
  oa-service:
    build:
      context: .
      dockerfile: microservices/ioedream-oa-service/Dockerfile
    image: ioedream/oa-service:latest
    container_name: ioedream-oa-service
    environment:
      - SERVER_PORT=8089
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（复杂业务服务）
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-oa-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8089:8089"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 门禁服务
  access-service:
    build:
      context: .
      dockerfile: microservices/ioedream-access-service/Dockerfile
    image: ioedream/access-service:latest
    container_name: ioedream-access-service
    environment:
      - SERVER_PORT=8090
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-access-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8090:8090"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 考勤服务
  attendance-service:
    build:
      context: .
      dockerfile: microservices/ioedream-attendance-service/Dockerfile
    image: ioedream/attendance-service:latest
    container_name: ioedream-attendance-service
    environment:
      - SERVER_PORT=8091
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-attendance-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8091:8091"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 视频服务
  video-service:
    build:
      context: .
      dockerfile: microservices/ioedream-video-service/Dockerfile
    image: ioedream/video-service:latest
    container_name: ioedream-video-service
    environment:
      - SERVER_PORT=8092
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-video-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8092:8092"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 消费服务
  consume-service:
    build:
      context: .
      dockerfile: microservices/ioedream-consume-service/Dockerfile
    image: ioedream/consume-service:latest
    container_name: ioedream-consume-service
    environment:
      - SERVER_PORT=8094
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（复杂业务服务）
      - JAVA_OPTS=-Xms256m -Xmx512m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-consume-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8094:8094"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8094/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

  # 访客服务
  visitor-service:
    build:
      context: .
      dockerfile: microservices/ioedream-visitor-service/Dockerfile
    image: ioedream/visitor-service:latest
    container_name: ioedream-visitor-service
    environment:
      - SERVER_PORT=8095
      - SPRING_PROFILES_ACTIVE=docker
      # JVM内存优化配置（低内存环境）
      - JAVA_OPTS=-Xms128m -Xmx256m -XX:MaxMetaspaceSize=96m -XX:+UseSerialGC -XX:+UseStringDeduplication -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Shanghai
      # 注释掉环境变量，使用application.yml中的配置（支持占位符，自动推断dataId）
      # - 'SPRING_CONFIG_IMPORT=optional:nacos:ioedream-visitor-service-docker.yaml'
      - NACOS_SERVER_ADDR=nacos:8848
      - NACOS_NAMESPACE=$${NACOS_NAMESPACE:-dev}
      - NACOS_USERNAME=$${NACOS_USERNAME}
      - NACOS_PASSWORD=$${NACOS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=ioedream
      - MYSQL_USERNAME=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-admin123}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-ioedream}
      - TZ=Asia/Shanghai
    ports:
      - "8095:8095"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      common-service:
        condition: service_started
    restart: unless-stopped
    networks:
      - ioedream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8095/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 90s

# ==================== 数据卷 ====================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  nacos_data:
    driver: local
  nacos_logs:
    driver: local
  rabbitmq_data:
    driver: local
  rabbitmq_logs:
    driver: local

# ==================== 网络 ====================
networks:
  ioedream-network:
    driver: bridge
    name: ioedream-network
