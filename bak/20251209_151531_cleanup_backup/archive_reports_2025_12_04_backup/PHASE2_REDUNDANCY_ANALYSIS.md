# Phase 2: ä»£ç å†—ä½™æ¸…ç†åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2025-12-03  
**åˆ†æèŒƒå›´**: æ¶ˆè´¹æ¨¡å¼æ¶æ„ã€è®¾å¤‡ç®¡ç†ã€å…¶ä»–ä»£ç å†—ä½™  
**åˆ†æçŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“Š å†—ä½™åˆ†æç»“æœ

### Task 2.1: æ¶ˆè´¹æ¨¡å¼æ¶æ„ç»Ÿä¸€

### 1. ConsumeModeEngineä½“ç³»åˆ†æ

#### å½“å‰çŠ¶æ€

**ConsumeModeEngineç±»**:
- **æ–‡ä»¶**: `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/engine/ConsumeModeEngine.java`
- **çŠ¶æ€**: âœ… **åˆ«åç±»**ï¼Œç»§æ‰¿è‡ª`ConsumptionModeEngine`
- **ç”¨é€”**: å‘åå…¼å®¹å’ŒåŒ…è·¯å¾„ä¸€è‡´æ€§
- **å»ºè®®**: âš ï¸ **ä¿ç•™**ï¼ˆä½œä¸ºåˆ«åï¼Œä¸å½±å“åŠŸèƒ½ï¼‰

**ConsumeRequestDTOå’ŒConsumeResultDTO**:
- **æ–‡ä»¶**: 
  - `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/domain/dto/ConsumeRequestDTO.java`
  - `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/domain/dto/ConsumeResultDTO.java`
- **çŠ¶æ€**: âš ï¸ **æ­£åœ¨ä½¿ç”¨ä¸­**
- **ä½¿ç”¨ä½ç½®**: 
  - `ConsumeServiceImpl.java` - ä¸»è¦ä½¿ç”¨
  - `ConsumptionModeEngineManager.java` - ä½¿ç”¨
  - `StandardConsumeFlowManager.java` - ä½¿ç”¨
  - å¤šä¸ªStrategyå®ç°ç±» - ä½¿ç”¨

**æ–°æ¶æ„ConsumeRequestå’ŒConsumeResult**:
- **æ–‡ä»¶**: 
  - `microservices/ioedream-consume-service/src/main/java/net/lab1024/sa/consume/domain/request/ConsumeRequest.java`
- **çŠ¶æ€**: âœ… **æ–°æ¶æ„**ï¼Œç”¨äº`ConsumeTransactionManager`
- **ä½¿ç”¨ä½ç½®**: äº¤æ˜“ç®¡ç†å™¨ç›¸å…³ä»£ç 

### 2. æ¶æ„ä½¿ç”¨æƒ…å†µåˆ†æ

| ä½“ç³» | æ¥å£/ç±» | çŠ¶æ€ | ä½¿ç”¨æƒ…å†µ | å»ºè®® |
|------|---------|------|---------|------|
| **ConsumptionModeEngine** | `ConsumptionModeEngine` | âœ… æ­£åœ¨ä½¿ç”¨ | Controllerå®é™…ä½¿ç”¨ | âœ… ä¿ç•™ |
| **ConsumptionModeEngine** | `ConsumptionModeStrategy` | âœ… æ­£åœ¨ä½¿ç”¨ | 7ä¸ªå®ç°ç±» | âœ… ä¿ç•™ |
| **ConsumptionModeEngine** | `ConsumeRequest` | âœ… æ­£åœ¨ä½¿ç”¨ | äº¤æ˜“ç®¡ç†å™¨ | âœ… ä¿ç•™ |
| **ConsumptionModeEngine** | `ConsumeResult` | âœ… æ­£åœ¨ä½¿ç”¨ | äº¤æ˜“ç®¡ç†å™¨ | âœ… ä¿ç•™ |
| **ConsumeModeEngine** | `ConsumeModeEngine` | âš ï¸ åˆ«åç±» | ç»§æ‰¿ConsumptionModeEngine | âš ï¸ å¯ä¿ç•™ |
| **ConsumeModeEngine** | `ConsumeRequestDTO` | âš ï¸ æ­£åœ¨ä½¿ç”¨ | Serviceå±‚ä½¿ç”¨ | âš ï¸ éœ€è¯„ä¼° |
| **ConsumeModeEngine** | `ConsumeResultDTO` | âš ï¸ æ­£åœ¨ä½¿ç”¨ | Serviceå±‚ä½¿ç”¨ | âš ï¸ éœ€è¯„ä¼° |

### 3. æ¸…ç†å»ºè®®

#### æ–¹æ¡ˆAï¼šä¿ç•™DTOä½“ç³»ï¼ˆæ¨èï¼‰

**ç†ç”±**:
1. âœ… DTOä½“ç³»æ­£åœ¨è¢«Serviceå±‚å¹¿æ³›ä½¿ç”¨
2. âœ… ä¸Controllerå±‚æ¥å£åŒ¹é…ï¼ˆRESTful APIï¼‰
3. âœ… è¿ç§»æˆæœ¬é«˜ï¼Œé£é™©å¤§
4. âœ… ConsumeRequestç”¨äºå†…éƒ¨äº¤æ˜“ç®¡ç†ï¼ŒèŒè´£ä¸åŒ

**è¡ŒåŠ¨**:
- âœ… ä¿ç•™`ConsumeRequestDTO`å’Œ`ConsumeResultDTO`
- âœ… ä¿ç•™`ConsumeModeEngine`åˆ«åç±»ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… æ˜ç¡®èŒè´£åˆ’åˆ†ï¼š
  - `ConsumeRequestDTO/ConsumeResultDTO` - Controller/Serviceå±‚ä½¿ç”¨
  - `ConsumeRequest/ConsumeResult` - Manager/Transactionå±‚ä½¿ç”¨

#### æ–¹æ¡ˆBï¼šç»Ÿä¸€åˆ°æ–°æ¶æ„ï¼ˆä¸æ¨èï¼‰

**ç†ç”±**:
1. âŒ éœ€è¦å¤§é‡ä»£ç ä¿®æ”¹
2. âŒ å½±å“ç°æœ‰APIæ¥å£
3. âŒ é£é™©é«˜ï¼Œæµ‹è¯•å·¥ä½œé‡å¤§

**ç»“è®º**: **ä¸é‡‡ç”¨æ­¤æ–¹æ¡ˆ**

---

## ğŸ“Š Task 2.2: è®¾å¤‡ç®¡ç†ä¼˜åŒ–åˆ†æ

### 1. è®¾å¤‡å®ä½“ç±»åˆ†æ

#### å‘ç°çš„è®¾å¤‡å®ä½“ç±»

| å®ä½“ç±» | ä½ç½® | çŠ¶æ€ | å»ºè®® |
|--------|------|------|------|
| **DeviceEntity** | `microservices-common/src/main/java/net/lab1024/sa/common/organization/entity/DeviceEntity.java` | âœ… å…¬å…±å®ä½“ | âœ… ä¿ç•™ï¼ˆç»Ÿä¸€è®¾å¤‡å®ä½“ï¼‰ |
| **DeviceEntity** | `ioedream-device-comm-service/src/main/java/net/lab1024/sa/device/domain/entity/DeviceEntity.java` | âš ï¸ è®¾å¤‡æœåŠ¡å®ä½“ | âš ï¸ éœ€è¯„ä¼° |
| **DeviceEntity** | `ioedream-common-core/src/main/java/net/lab1024/sa/common/organization/entity/DeviceEntity.java` | âš ï¸ å¯èƒ½é‡å¤ | âš ï¸ éœ€è¯„ä¼° |

### 2. è®¾å¤‡å®ä½“ç»Ÿä¸€æ–¹æ¡ˆ

**æ ‡å‡†æ¶æ„**:
```
å…¬å…±æ¨¡å— (microservices-common):
â”œâ”€â”€ DeviceEntity (ç»Ÿä¸€è®¾å¤‡å®ä½“)
â”‚   â”œâ”€â”€ åŸºç¡€å­—æ®µï¼ˆè®¾å¤‡IDã€åç§°ã€ç¼–å·ã€ç±»å‹ç­‰ï¼‰
â”‚   â”œâ”€â”€ çŠ¶æ€å­—æ®µï¼ˆåœ¨çº¿çŠ¶æ€ã€å¯ç”¨çŠ¶æ€ç­‰ï¼‰
â”‚   â””â”€â”€ extendedAttributes (JSONæ‰©å±•å±æ€§)

ä¸šåŠ¡å¾®æœåŠ¡:
â”œâ”€â”€ ä½¿ç”¨å…¬å…±DeviceEntity
â”œâ”€â”€ ä¸šåŠ¡ç‰¹å®šé…ç½®å­˜å‚¨åœ¨extendedAttributes
â””â”€â”€ é€šè¿‡DeviceDaoè®¿é—®è®¾å¤‡æ•°æ®
```

**ä¼˜åŒ–å»ºè®®**:
1. âœ… ç»Ÿä¸€ä½¿ç”¨`microservices-common`ä¸­çš„`DeviceEntity`
2. âœ… ä¸šåŠ¡ç‰¹å®šå­—æ®µå­˜å‚¨åœ¨`extendedAttributes`ï¼ˆJSONï¼‰
3. âœ… åˆ›å»ºè®¾å¤‡æœåŠ¡ç»Ÿä¸€ç®¡ç†è®¾å¤‡CRUD
4. âš ï¸ è¯„ä¼°è®¾å¤‡é€šè®¯æœåŠ¡ä¸­çš„DeviceEntityæ˜¯å¦éœ€è¦ç‹¬ç«‹

---

## ğŸ“Š Task 2.3: ç”Ÿç‰©è¯†åˆ«åŠŸèƒ½è¿ç§»éªŒè¯

### è¿ç§»çŠ¶æ€æ£€æŸ¥

æ ¹æ®ä¹‹å‰çš„æ–‡æ¡£ï¼Œç”Ÿç‰©è¯†åˆ«åŠŸèƒ½å·²ä»`access-service`è¿ç§»åˆ°`common-service`ã€‚

**éªŒè¯é¡¹**:
- [ ] ç¡®è®¤access-serviceä¸­æ— ç”Ÿç‰©è¯†åˆ«ç›¸å…³ä»£ç æ®‹ç•™
- [ ] ç¡®è®¤common-serviceä¸­ç”Ÿç‰©è¯†åˆ«åŠŸèƒ½å®Œæ•´
- [ ] ç¡®è®¤APIè·¯å¾„å·²æ›´æ–°
- [ ] ç¡®è®¤è°ƒç”¨æ–¹å·²æ›´æ–°

---

## ğŸ“Š Task 2.4: å…¶ä»–ä»£ç å†—ä½™æ¸…ç†

### éœ€è¦æ‰«æçš„å†—ä½™ç±»å‹

1. **é‡å¤çš„å·¥å…·ç±»**
   - RedisUtilã€CacheUtilç­‰
   - DateUtilã€StringUtilç­‰

2. **é‡å¤çš„é…ç½®ç±»**
   - Redisé…ç½®
   - MyBatisé…ç½®
   - ç¼“å­˜é…ç½®

3. **é‡å¤çš„å¼‚å¸¸ç±»**
   - BusinessException
   - SystemException

4. **é‡å¤çš„å¸¸é‡ç±»**
   - é”™è¯¯ç å¸¸é‡
   - ä¸šåŠ¡å¸¸é‡

---

## ğŸ¯ Phase 2 æ‰§è¡Œè®¡åˆ’

### Task 2.1: æ¶ˆè´¹æ¨¡å¼æ¶æ„ç»Ÿä¸€

**çŠ¶æ€**: âš ï¸ **éœ€é‡æ–°è¯„ä¼°**

**å‘ç°**:
- `ConsumeRequestDTO`å’Œ`ConsumeResultDTO`æ­£åœ¨è¢«å¹¿æ³›ä½¿ç”¨
- æ–°æ¶æ„`ConsumeRequest`ç”¨äºä¸åŒåœºæ™¯ï¼ˆäº¤æ˜“ç®¡ç†ï¼‰
- ä¸¤å¥—ä½“ç³»èŒè´£ä¸åŒï¼Œå¯ä»¥å…±å­˜

**å»ºè®®**:
- âœ… **ä¿ç•™ä¸¤å¥—ä½“ç³»**ï¼Œæ˜ç¡®èŒè´£åˆ’åˆ†
- âœ… æ·»åŠ æ–‡æ¡£è¯´æ˜ä½¿ç”¨åœºæ™¯
- âœ… æ ‡è®°`ConsumeModeEngine`ä¸ºåˆ«åç±»ï¼ˆå·²æ ‡è®°ï¼‰

**å·¥ä½œé‡**: 1å°æ—¶ï¼ˆæ–‡æ¡£æ›´æ–°ï¼‰

---

### Task 2.2: è®¾å¤‡ç®¡ç†ä¼˜åŒ–

**çŠ¶æ€**: â³ **å‡†å¤‡æ‰§è¡Œ**

**ä»»åŠ¡**:
1. åˆ†æè®¾å¤‡å®ä½“ç±»å·®å¼‚
2. ç»Ÿä¸€ä½¿ç”¨å…¬å…±DeviceEntity
3. ä¸šåŠ¡ç‰¹å®šå­—æ®µè¿ç§»åˆ°extendedAttributes
4. æ›´æ–°è®¾å¤‡ç›¸å…³ä»£ç 

**å·¥ä½œé‡**: 3-4å°æ—¶

---

### Task 2.3: ç”Ÿç‰©è¯†åˆ«åŠŸèƒ½è¿ç§»éªŒè¯

**çŠ¶æ€**: â³ **å‡†å¤‡æ‰§è¡Œ**

**ä»»åŠ¡**:
1. éªŒè¯è¿ç§»å®Œæ•´æ€§
2. æ¸…ç†æ®‹ç•™ä»£ç 
3. æ›´æ–°è°ƒç”¨æ–¹

**å·¥ä½œé‡**: 1-2å°æ—¶

---

### Task 2.4: å…¶ä»–ä»£ç å†—ä½™æ¸…ç†

**çŠ¶æ€**: â³ **å‡†å¤‡æ‰§è¡Œ**

**ä»»åŠ¡**:
1. æ‰«æé‡å¤å·¥å…·ç±»
2. æ‰«æé‡å¤é…ç½®ç±»
3. ç»Ÿä¸€åˆ°å…¬å…±æ¨¡å—

**å·¥ä½œé‡**: 2-3å°æ—¶

---

## ğŸ“ˆ Phase 2 æ€»ä½“è¯„ä¼°

### å·¥ä½œé‡è¯„ä¼°

| ä»»åŠ¡ | åŸè®¡åˆ’ | å®é™…éœ€æ±‚ | è¯´æ˜ |
|------|--------|---------|------|
| Task 2.1 | 4-6å°æ—¶ | 1å°æ—¶ | DTOä½“ç³»éœ€ä¿ç•™ï¼Œåªéœ€æ–‡æ¡£æ›´æ–° |
| Task 2.2 | 3-4å°æ—¶ | 3-4å°æ—¶ | è®¾å¤‡å®ä½“ç»Ÿä¸€ |
| Task 2.3 | 1-2å°æ—¶ | 1-2å°æ—¶ | è¿ç§»éªŒè¯ |
| Task 2.4 | 2-3å°æ—¶ | 2-3å°æ—¶ | å…¶ä»–å†—ä½™æ¸…ç† |
| **æ€»è®¡** | **10-15å°æ—¶** | **7-10å°æ—¶** | âœ… **èŠ‚çœ30%** |

### ä¼˜å…ˆçº§è°ƒæ•´

| ä»»åŠ¡ | åŸä¼˜å…ˆçº§ | æ–°ä¼˜å…ˆçº§ | åŸå›  |
|------|---------|---------|------|
| Task 2.1 | P0 | P2 | DTOä½“ç³»éœ€ä¿ç•™ï¼Œéå†—ä½™ |
| Task 2.2 | P0 | P0 | è®¾å¤‡å®ä½“ç¡®å®éœ€è¦ç»Ÿä¸€ |
| Task 2.3 | P0 | P1 | è¿ç§»å·²å®Œæˆï¼Œåªéœ€éªŒè¯ |
| Task 2.4 | P1 | P1 | å…¶ä»–å†—ä½™æ¸…ç† |

---

## ğŸš€ ç«‹å³æ‰§è¡Œè®¡åˆ’

### Step 1: è®¾å¤‡ç®¡ç†ä¼˜åŒ–ï¼ˆä¼˜å…ˆæ‰§è¡Œï¼‰

1. **åˆ†æè®¾å¤‡å®ä½“å·®å¼‚** (30åˆ†é’Ÿ)
2. **ç»Ÿä¸€åˆ°å…¬å…±DeviceEntity** (2å°æ—¶)
3. **æ›´æ–°ä¸šåŠ¡ä»£ç ** (1å°æ—¶)
4. **éªŒè¯ç¼–è¯‘** (30åˆ†é’Ÿ)

### Step 2: ç”Ÿç‰©è¯†åˆ«è¿ç§»éªŒè¯ï¼ˆå¿«é€ŸéªŒè¯ï¼‰

1. **æ‰«ææ®‹ç•™ä»£ç ** (15åˆ†é’Ÿ)
2. **éªŒè¯åŠŸèƒ½å®Œæ•´æ€§** (30åˆ†é’Ÿ)
3. **æ›´æ–°è°ƒç”¨æ–¹** (30åˆ†é’Ÿ)

### Step 3: å…¶ä»–å†—ä½™æ¸…ç†ï¼ˆæ‰¹é‡å¤„ç†ï¼‰

1. **æ‰«æé‡å¤å·¥å…·ç±»** (30åˆ†é’Ÿ)
2. **ç»Ÿä¸€åˆ°å…¬å…±æ¨¡å—** (1.5å°æ—¶)
3. **æ›´æ–°å¼•ç”¨** (1å°æ—¶)

---

**Phase 2 çŠ¶æ€**: â³ **å‡†å¤‡æ‰§è¡Œ**  
**é¢„è®¡å®Œæˆæ—¶é—´**: 4-6å°æ—¶  
**ä¼˜å…ˆçº§**: P0ï¼ˆè®¾å¤‡ç®¡ç†ä¼˜åŒ–ï¼‰

