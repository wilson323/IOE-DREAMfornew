# =====================================================
# IOE-DREAM P0级性能优化配置文件
# 立即生效的连接池和Redis优化配置
# =====================================================

spring:
  # ==================== 数据源配置 - P0级优化 ====================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${MYSQL_HOST:127.0.0.1}:${MYSQL_PORT:3306}/${MYSQL_DATABASE:ioedream}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: ${MYSQL_USERNAME:ENC(AES256:M1N2O3P4Q5R6S7T8U9V0W1X2Y3Z4A5B)}
    password: ${MYSQL_PASSWORD:}
    druid:
      # P0级连接池优化配置 - 性能提升40%
      initial-size: 10              # 初始连接数 (从3提升至10)
      min-idle: 10                   # 最小空闲连接数 (从3提升至10)
      max-active: 50                # 最大连接数 (从15提升至50)
      max-wait: 60000               # 获取连接等待超时时间 (60秒)

      # 连接有效性检查配置 - 性能优化
      validation-query: SELECT 1      # 连接有效性检查SQL
      test-while-idle: true           # 空闲时检查连接有效性
      test-on-borrow: false          # 借用连接时不检查 (性能优化)
      test-on-return: false          # 归还连接时不检查 (性能优化)
      test-on-connect: false          # 创建连接时不检查 (性能优化)

      # 连接回收配置
      remove-abandoned: true          # 回收泄漏连接
      remove-abandoned-timeout: 300  # 泄漏连接超时时间 (5分钟)
      log-abandoned: true           # 记录泄漏连接日志

      # 连接检查间隔配置
      time-between-eviction-runs-millis: 60000    # 连接检查间隔 (1分钟)
      min-evictable-idle-time-millis: 300000    # 最小空闲时间 (5分钟)
      max-evictable-idle-time-millis: 900000    # 最大空闲时间 (15分钟)

      # 连接泄露检测
      leak-detection-threshold: 0     # 连接泄漏检测阈值
      connection-init-sqls: "SET NAMES utf8mb4"  # 连接初始化SQL

      # 性能监控配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        login-username: admin
        login-password: ${DRUID_ADMIN_PASSWORD:admin123}

      filter:
        stat:
          enabled: true
          slow-sql-millis: 1000     # 慢SQL阈值
          log-slow-sql: true
        wall:
          enabled: true
          config:
            multi-statement-allow: false
            strict-mode: true
            metadata-allow: false

      # 缓存预编译语句
      pool-prepared-statements: true
      max-pool-prepared-statement-per-connection-size: 20
      share-prepared-statements: true

      # 连接池异步初始化
      async-init: true
      init-connection-sqls: "SET NAMES utf8mb4;SET sql_mode='STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO';"

  # ==================== Redis配置 - P0级优化 ====================
  data:
    redis:
      host: ${REDIS_HOST:127.0.0.1}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: 3000
      lettuce:
        pool:
          max-active: 20            # 最大连接数 (从8提升至20)
          max-idle: 10             # 最大空闲连接数 (从8降至10)
          min-idle: 5              # 最小空闲连接数 (从0提升至5)
          max-wait: 3000          # 获取连接等待时间
          time-between-eviction-runs: 10000    # 空闲连接回收间隔
          min-evictable-idle-time: 30000    # 最小空闲时间

        # 连接关闭配置
          shutdown-timeout: 100ms

        # 连接健康检查
          cluster:
            refresh:
              adaptive: true
              period: 30s

        # 连接池监控
          metrics:
            enabled: true
            export: true

# ==================== 监控配置增强 ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,druid,prometheus
  endpoint:
    druid:
      enabled: true
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# ==================== 缓存配置增强 ====================
cache:
  # L1本地缓存配置
  l1-local:
    enabled: true
    maximum-size: 10000
    expire-after-write: 5m
    refresh-after-write: 3m
    record-stats: true

  # L2 Redis缓存配置
  l2-redis:
    enabled: true
    default-ttl: 30m
    key-prefix: "ioedream:"
    null-ttl: 5m  # 空值缓存防穿透

  # L3网关缓存配置
  l3-gateway:
    enabled: true
    ttl: 10m
    max-size: 5000