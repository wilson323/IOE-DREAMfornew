---
# 消费模块Kubernetes部署配置
# 支持高可用、负载均衡和自动扩缩容

apiVersion: apps/v1
kind: Deployment
metadata:
  name: consume-module
  namespace: smart-admin
  labels:
    app: consume-module
    version: v1.0.0
    component: backend
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: consume-module
  template:
    metadata:
      labels:
        app: consume-module
        version: v1.0.0
        component: backend
    spec:
      containers:
        - name: consume-module
          image: smart-admin/consume-module:v1.0.0
          ports:
            - containerPort: 1024
              name: http
              protocol: TCP
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: JAVA_OPTS
              value: "-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: database-secret
                  key: url
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: database-secret
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: database-secret
                  key: password
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: redis-secret
                  key: url
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-secret
                  key: password
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /api/consume/health
              port: 1024
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/consume/ready
              port: 1024
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          lifecycle:
            preStop:
              exec:
                command: ["sh", "-c", "sleep 15"]
      restartPolicy: Always
      imagePullSecrets:
        - name: registry-secret
      terminationGracePeriodSeconds: 30

---
apiVersion: v1
kind: Service
metadata:
  name: consume-module-service
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  type: ClusterIP
  selector:
    app: consume-module
  ports:
    - port: 1024
      targetPort: 1024
      protocol: TCP
      name: http
  sessionAffinity: None

---
apiVersion: v1
kind: Service
metadata:
  name: consume-module-nodeport
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  type: NodePort
  selector:
    app: consume-module
  ports:
    - port: 1024
      targetPort: 1024
      nodePort: 31024
      protocol: TCP
      name: http

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: consume-module-hpa
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: consume-module
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
    - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: consume-module-config
  namespace: smart-admin
  labels:
    app: consume-module
data:
  application.yml: |
    server:
      port: 1024
      servlet:
        context-path: /
      tomcat:
        max-threads: 200
        min-spare-threads: 10
    spring:
      profiles:
        active: prod
      datasource:
        hikari:
          minimum-idle: 10
          maximum-pool-size: 50
          idle-timeout: 300000
          connection-timeout: 20000
          max-lifetime: 1800000
      cache:
        type: redis
        redis:
          time-to-live: 3600
          cache-null-values: false
      async:
        executor:
          core-pool-size: 10
          max-pool-size: 50
          queue-capacity: 1000
          thread-name-prefix: consume-async-
    logging:
      level:
        root: INFO
        net.lab1024: DEBUG
      pattern:
        console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
        file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
      file:
        name: /var/log/consume-module/application.log
        max-size: 100MB
        max-history: 30

---
apiVersion: v1
kind: Secret
metadata:
  name: database-secret
  namespace: smart-admin
  labels:
    app: consume-module
type: Opaque
data:
  url: bXlzcWw6Ly9sbWFydHExOjMzMDYvbWFydFwpMw==  # base64编码的数据库URL
  username: c21hcnRhZG1bg==  # base64编码的用户名
  password: c21hcnRhZG1uMTIz  # base64编码的密码

---
apiVersion: v1
kind: Secret
metadata:
  name: redis-secret
  namespace: smart-admin
  labels:
    app: consume-module
type: Opaque
data:
  url: cmVkaXM6Ly9zbWFydC1cmVkaXM6NjM4OS8w  # base64编码的Redis URL
  password: enhrZWNvMzEwMA==  # base64编码的Redis密码

---
# Pod Disruption Budget - 确保应用可用性
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: consume-module-pdb
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: consume-module

---
# Network Policy - 网络安全策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: consume-module-netpol
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  podSelector:
    matchLabels:
      app: consume-module
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: ingress-nginx
      - namespaceSelector:
          matchLabels:
            name: smart-admin
    - ports:
      - protocol: TCP
        port: 1024
  egress:
    - to: []
    - ports:
      - protocol: TCP
        port: 3306  # MySQL
      - protocol: TCP
        port: 6379  # Redis
      - protocol: TCP
        port: 443   # HTTPS
      - protocol: TCP
        port: 80    # HTTP

---
# Resource Quota - 资源配额限制
apiVersion: v1
kind: ResourceQuota
metadata:
  name: consume-module-quota
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  hard:
    requests.cpu: "2000m"
    requests.memory: "4Gi"
    limits.cpu: "4000m"
    limits.memory: "8Gi"
    persistentvolumeclaims: "5"
    services: "10"
    count/secrets: "10"
    count/configmaps: "10"

---
# Limit Range - 默认资源限制
apiVersion: v1
kind: LimitRange
metadata:
  name: consume-module-limits
  namespace: smart-admin
  labels:
    app: consume-module
spec:
  limits:
    default:
      cpu: "1000m"
      memory: "2Gi"
    defaultRequest:
      cpu: "200m"
      memory: "512Mi"
  max:
      cpu: "2000m"
      memory: "4Gi"