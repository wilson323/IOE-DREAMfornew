# 智能视频模块完整设计文档系统

## 📋 项目概述

### 项目定位

**智能视频模块**是安防系统的核心业务模块，专注于提供完整的视频监控解决方案。本模块采用**Spring Boot 3.5.8 + Spring Cloud 2025.0.0分布式微服务架构**，作为`ioedream-video-service`(8092)独立微服务与其他模块协同工作，通过**事件订阅中心**进行数据交互。

### 微服务边界说明

**✅ 包含模块**：
- 实时监控服务
- 录像回放服务
- 行为分析服务
- 告警管理服务
- 解码上墙服务
- 事件订阅服务

**❌ 不包含（依赖外部模块）**：
- 设备管理（依赖公共设备管理模块，通过订阅获取设备数据）
- 用户权限（依赖公共用户权限模块进行认证授权）
- 系统日志（依赖公共系统管理模块）
- 视频下载（依赖下载中心模块，提交任务即可）
- 地图显示（已移除该功能）

### 核心特性

- **🔐 五级安全体系**：绝密、机密、秘密、内部、公开
- **📹 实时监控**：多画面、多协议、多格式视频流、流媒体转发优化
- **🎥 录像回放**：高效查询、快速定位、时间轴预览、多倍速播放
- **🤖 AI智能分析**：人脸识别、行为分析、异常检测、低延时联动抓拍
- **🚨 告警管理**：实时告警、设备离线告警、智能联动、自动处理
- **🔔 事件订阅中心**：混合推送模式、实时事件推送、历史数据拉取
- **💧 水印支持**：可自定义水印配置（由下载中心实现）
- **⚡ 性能优化**：大规模摄像头并发处理、流媒体转发、懒加载

### 微服务架构与跨模块交互图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Spring Boot微服务生态系统                           │
│                                                                              │
│  ┌────────────────┐     ┌────────────────┐     ┌────────────────┐        │
│  │  设备管理模块   │     │  用户权限模块   │     │  事件订阅中心   │        │
│  │   (公共模块)    │     │   (公共模块)    │     │   (中心枢纽)    │        │
│  │                │     │                │     │                │        │
│  │ • 设备注册     │     │ • 用户认证     │     │ • 事件发布     │        │
│  │ • 设备配置     │     │ • 权限控制     │     │ • 事件订阅     │        │
│  │ • 设备状态     │────▶│ • 安全级别     │     │ • 数据推送     │◀──────│
│  └────────────────┘     └────────────────┘     └────────────────┘        │
│         ▲                       ▲                         │               │
│         │                       │                         │               │
│  设备数据订阅                   用户权限查询              事件推送         │
│         │                       │                         │               │
│  ┌──────┴────────────────────────────────────────────────────┐           │
│  │              智能视频模块 (本微服务)                         │           │
│  │                                                             │           │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │           │
│  │  │  实时监控   │  │  录像回放   │  │  行为分析   │          │           │
│  │  │   服务      │  │   服务      │  │   服务      │          │           │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │           │
│  │                                                             │           │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │           │
│  │  │  告警管理   │  │  解码上墙   │  │ 事件订阅推送│          │           │
│  │  │   服务      │  │   服务      │  │   服务      │          │           │
│  │  │(含离线告警) │  │             │  │             │          │           │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │           │
│  │                                                             │           │
│  │  ┌─────────────┐  ┌─────────────┐                          │           │
│  │  │  流媒体转发 │  │ 性能优化服务│                          │           │
│  │  │   服务      │  │             │                          │           │
│  │  └─────────────┘  └─────────────┘                          │           │
│  └────────────────────────────┬───────────────────────────────┘           │
│                                 │                                             │
│                          提交下载任务                                     │
│                                 │                                             │
│  ┌──────────────────────────────┴────────────┐                             │
│  │              下载中心模块                  │                             │
│  │                                       │                             │
│  │  • 视频下载                           │                             │
│  │  • 水印添加 (根据视频模块传递的配置)     │                             │
│  │  • 文件管理                           │                             │
│  └────────────────────────────────────────┘                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 事件订阅中心交互模式（混合模式）

```
┌─────────────────────────────────────────────────────────────┐
│                    事件订阅中心 (混合推送模式)                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 实时事件推送 (主动推送)                                 │
│  ┌─────────────────┐                                         │
│  │  智能视频模块   │  ──── 触发事件 ────▶  事件订阅中心          │
│  │                 │                     │                     │
│  │  • 告警事件     │                     ├──▶ 设备管理模块       │
│  │  • 设备离线     │                     ├──▶ 门禁控制模块       │
│  │  • 分析结果     │                     ├──▶ 短信通知模块       │
│  └─────────────────┘                     └──▶ 邮件通知模块       │
│                                                             │
│  2. 历史数据拉取 (被动查询)                                 │
│  ┌─────────────────┐                                         │
│  │  其他业务模块   │  ──── 查询请求 ───▶  事件订阅中心          │
│  │                 │                     │                     │
│  │  • 统计报表模块 │                     │                     │
│  │  • 运维监控模块 │ ◀─── 返回数据 ───┤ 智能视频模块          │
│  │  • 数据分析模块 │                     │                     │
│  └─────────────────┘                     │                     │
│                     ◀─── 查询数据 ──────┘                     │
└─────────────────────────────────────────────────────────────┘
```

### 模块依赖关系矩阵

| 智能视频模块 | 依赖模块         | 交互方式          | 数据方向          |
|------------|----------------|-----------------|-----------------|
| 实时监控     | 设备管理模块     | 事件订阅          | 设备数据 ←       |
| 实时监控     | 用户权限模块     | API调用           | 权限验证 →       |
| 录像回放     | 下载中心模块     | 任务提交          | 下载任务 →       |
| 告警管理     | 事件订阅中心     | 事件发布          | 告警事件 →       |
| 行为分析     | 设备管理模块     | 事件订阅          | 设备数据 ←       |
| 解码上墙     | 设备管理模块     | 事件订阅          | 设备数据 ←       |
| 跨模块交互   | 事件订阅中心     | 混合模式          | 双向             |

## 🎯 设计原则

### 1. 安全性原则
- **五级安全控制**：基于安全级别的细粒度权限控制
- **数据加密**：敏感数据加密存储和传输
- **操作审计**：完整的操作日志和审计追踪
- **异常检测**：实时监控异常访问行为

### 2. 高性能原则
- **多级缓存**：本地缓存 + 分布式缓存 + 数据库缓存
- **读写分离**：主从架构，提升读写性能
- **分库分表**：水平拆分，支持海量数据
- **异步处理**：消息队列异步处理耗时任务

### 3. 高可用原则
- **集群部署**：支持多节点集群部署
- **故障转移**：自动故障检测和切换
- **服务熔断**：防止雪崩效应
- **监控告警**：全方位监控和自动告警

### 4. 可扩展原则
- **微服务架构**：服务拆分，独立部署
- **插件机制**：支持功能插件扩展
- **协议支持**：多协议设备接入
- **API开放**：提供开放API接口

### 5. 易用性原则
- **直观界面**：符合用户习惯的界面设计
- **操作简化**：简化复杂操作流程
- **智能提示**：提供操作引导和提示
- **多语言支持**：国际化支持

## 📦 模块清单
## 📋 IOE-DREAM七微服务架构

**核心架构组成**:
- **Gateway Service (8080)**: API网关
- **Common Service (8088)**: 公共模块微服务
- **DeviceComm Service (8087)**: 设备通讯微服务
- **OA Service (8089)**: OA微服务
- **Access Service (8090)**: 门禁服务
- **Attendance Service (8091)**: 考勤服务
- **Video Service (8092)**: 视频服务
- **Consume Service (8094)**: 消费服务
- **Visitor Service (8095)**: 访客服务

**架构特点**:
- 基于Spring Boot 3.5.8 + Java 17
- 严格遵循企业级微服务规范
- 支持高并发、高可用、水平扩展

**技术栈标准**:
- **数据库**: MySQL 8.0 + Druid连接池
- **缓存**: Redis + Caffeine多级缓存
- **注册中心**: Nacos
- **配置中心**: Nacos Config
- **认证授权**: Sa-Token

## 🏗️ 四层架构规范

**标准架构模式**:
```
Controller (接口控制层)
    ↓
Service (核心业务层)
    ↓
Manager (流程管理层)
    ↓
DAO (数据访问层)
```

**层级职责**:
- **Controller层**: HTTP请求处理、参数验证、权限控制
- **Service层**: 核心业务逻辑、事务管理、业务规则验证
- **Manager层**: 复杂流程编排、多数据组装、第三方服务集成
- **DAO层**: 数据库CRUD操作、SQL查询实现、数据访问边界

**严格禁止跨层访问**: Controller不能直接调用Manager/DAO！
### 核心业务模块
## ⚠️ IOE-DREAM零容忍规则（强制执行）

**必须遵守的架构规则**:
- ✅ **必须使用 @Resource 注入依赖**
- ✅ **必须使用 @Mapper 注解** (禁止@Repository)
- ✅ **必须使用 Dao 后缀** (禁止Repository)
- ✅ **必须使用 @RestController 注解**
- ✅ **必须使用 @Valid 参数校验**
- ✅ **必须返回统一ResponseDTO格式**
- ✅ **必须遵循四层架构边界**

**严格禁止事项**:
- ❌ **禁止使用 @Autowired 注入**
- ❌ **禁止使用 @Repository 注解**
- ❌ **禁止使用 Repository 后缀命名**
- ❌ **禁止跨层访问**
- ❌ **禁止在Controller中包含业务逻辑**
- ❌ **禁止直接访问数据库**

**违规后果**: P0级问题，立即修复，禁止合并！

#### 1. 实时监控模块
- **功能描述**：实时视频预览、云台控制、截图录像
- **主要特性**：
  - 多画面布局（1/4/9/16/25画面）
  - 多种视频流协议支持（RTSP/RTMP/HLS/WebRTC）
  - 云台控制（方向、变焦、巡航）
  - 实时截图和录像
  - 画面控制（缩放、旋转、镜像）

#### 2. 设备管理交互模块（从公共模块获取）
- **功能描述**：设备数据获取、状态监控、联动抓拍
- **主要特性**：
  - 设备数据订阅（从设备管理模块获取设备信息）
  - 设备状态监控（在线状态、性能指标）
  - 设备离线告警（检测设备心跳，超时触发告警）
  - 联动抓拍（低延时控制，目标<200ms）
  - 设备数据缓存（缓存热点设备数据）

#### 3. 录像回放模块
- **功能描述**：录像查询、回放、预览、水印配置
- **主要特性**：
  - 多条件查询（时间、设备、事件）
  - 回放控制（播放、暂停、倍速、跳转）
  - **时间轴预览**（可视化波形，快速定位）
  - **下载前预览**（支持实时流预览和缩略图预览）
  - **水印配置**（自定义水印内容、位置、大小，传递给下载中心）
  - 录像管理（列表、删除、备份）
  - 录像统计

#### 4. 行为分析模块
- **功能描述**：AI算法配置、行为检测、异常识别
- **主要特性**：
  - AI算法管理（人脸识别、行为分析）
  - 检测规则配置（区域、时段、规则）
  - 异常行为识别（徘徊、聚集、摔倒）
  - 分析结果查看（事件列表、统计图表）
  - **联动抓拍延时控制**（目标<200ms）
  - 算法性能监控
  - **分析结果推送**（通过事件订阅中心推送给其他模块）

#### 5. 告警管理模块
- **功能描述**：告警配置、事件处理、联动控制
- **主要特性**：
  - 告警规则配置（条件、联动、通知）
  - **设备离线告警**（检测设备心跳超时）
  - 告警事件查看（实时、历史、统计）
  - 告警处理（确认、处理、反馈）
  - 告警联动（视频联动、门禁联动）
  - 告警统计（数量、趋势、分布）
  - **告警事件发布**（通过事件订阅中心发布）

#### 6. 解码上墙模块
- **功能描述**：解码器管理、大屏控制、多屏联动
- **主要特性**：
  - 解码器管理（注册、配置、状态）
  - 大屏布局配置（窗口、尺寸、位置）
  - 视频上墙显示（实时视频、回放画面）
  - 多屏联动控制（同步、轮询、分组）
  - 显示效果调节（亮度、对比度、色调）

#### 7. 事件订阅交互模块
- **功能描述**：事件订阅、数据推送、跨模块交互
- **主要特性**：
  - **混合推送模式**（实时事件推送 + 历史数据拉取）
  - 事件订阅管理（订阅规则、过滤条件）
  - 数据推送机制（实时推送、批量推送）
  - 推送记录统计（发送量、成功率、延迟）
  - **跨模块数据交互**（与其他微服务数据交换）

#### 8. 性能优化服务
- **功能描述**：流媒体转发、大规模并发优化
- **主要特性**：
  - **流媒体转发服务**（减少摄像头直连压力）
  - **大规模摄像头并发优化**（支持1000+路并发）
  - 懒加载机制（按需加载摄像头画面）
  - 分级联方案（分级显示不同优先级设备）
  - 缓存优化（多级缓存机制）

### 公共支撑模块

#### 1. 用户权限模块
- **用户管理**：用户CRUD、组织架构
- **角色管理**：角色定义、权限分配
- **安全级别**：5级安全控制体系
- **操作审计**：操作日志、行为追踪

#### 2. 区域管理模块
- **区域定义**：树形区域结构
- **设备归属**：设备归属区域管理
- **权限分配**：区域权限控制
- **区域联动**：跨区域联动控制

#### 3. 系统配置模块
- **参数配置**：系统参数配置
- **模板管理**：设备模板、告警模板
- **文件管理**：文件上传、下载、存储
- **日志管理**：日志配置、查询、清理

## 🔗 模块依赖关系

### 依赖层级

```
Level 1: 用户权限模块、区域管理模块（最底层）
Level 2: 设备管理模块、消息中心模块
Level 3: 实时监控模块、录像回放模块、行为分析模块
Level 4: 告警管理模块、解码上墙模块、地图显示模块（最顶层）
```

### 依赖说明

1. **用户权限模块**：
   - 所有模块都依赖用户权限进行访问控制
   - 提供用户认证、授权、审计功能

2. **区域管理模块**：
   - 设备管理依赖区域管理进行设备归属
   - 实时监控依赖区域进行设备筛选
   - 其他模块通过区域进行数据隔离

3. **设备管理模块**：
   - 实时监控依赖设备管理获取设备信息
   - 录像回放依赖设备管理获取设备列表
   - 行为分析依赖设备管理进行设备配置

4. **消息中心模块**：
   - 告警管理依赖消息中心发送告警通知
   - 设备管理依赖消息中心推送设备状态
   - 实时监控依赖消息中心推送告警事件

5. **其他业务模块**：
   - 各业务模块相互独立，无直接依赖
   - 通过消息中心进行间接通信
   - 通过用户权限和区域管理进行数据隔离

## 📊 性能指标

### 响应时间指标

| 操作类型 | 目标响应时间 | 可接受响应时间 |
|---------|-------------|---------------|
| 页面加载 | < 2秒 | < 5秒 |
| 实时预览 | < 1秒 | < 3秒 |
| **联动抓拍响应** | **< 200ms** | **< 500ms** |
| 录像查询 | < 3秒 | < 8秒 |
| 录像回放 | < 2秒 | < 5秒 |
| **时间轴预览生成** | **< 1秒** | **< 3秒** |
| 告警响应 | < 0.5秒 | < 2秒 |

### 并发性能指标

| 指标类型 | 目标值 | 最大值 |
|---------|-------|-------|
| 同时在线用户 | 500 | 1000 |
| **同时预览画面** | **2000** | **5000** |
| **大规模摄像头接入** | **1000路** | **5000路** |
| 同时回放路数 | 500 | 1000 |
| 告警并发处理 | 1000 | 2000 |
| API并发请求 | 2000 | 5000 |

### 性能优化策略指标

| 优化策略 | 性能提升目标 | 实施方式 |
|---------|-------------|----------|
| **流媒体转发** | **减少80%直连压力** | 流媒体服务器集群 |
| **懒加载机制** | **提升50%页面加载速度** | 按需加载摄像头 |
| **分级联方案** | **支持5000+路设备** | 优先级分级显示 |
| **多级缓存** | **命中率>90%** | L1/L2/L3缓存架构 |
| **读写分离** | **提升200%读性能** | 主从集群架构 |

### 存储性能指标

| 存储类型 | 容量 | 性能 |
|---------|------|------|
| 数据库存储 | 10TB | 10万QPS |
| 缓存存储 | 100GB | 50万QPS |
| 文件存储 | 100TB | 1万QPS |
| 录像存储 | 1PB | 5千路并发 |

## 🚀 部署架构

### 部署拓扑

```
┌─────────────────────────────────────────────────────────────┐
│                        负载均衡层                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Nginx     │ │   HAProxy   │ │    F5       │           │
│  │  负载均衡   │ │  负载均衡   │ │   硬件负载  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       应用服务层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  Web前端    │ │  API网关    │ │  微服务集群 │           │
│  │  静态资源   │ │  路由/限流  │ │  业务服务   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   AI服务    │ │  消息队列   │ │   定时任务  │           │
│  │  算法推理   │ │  RabbitMQ   │ │  Quartz     │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       数据存储层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  主数据库   │ │  从数据库   │ │  缓存集群   │           │
│  │ PostgreSQL  │ │ PostgreSQL  │ │    Redis    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  对象存储   │ │  文件系统   │ │  搜索引擎   │           │
│  │    HDFS     │ │    NAS      │ │  Elastic    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                       设备接入层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │  视频监控   │ │  录像存储   │ │  显示拼接   │           │
│  │   设备网    │ │   存储网    │ │   设备网    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   管理网    │ │   物联网    │ │   无线网    │           │
│  │  办公网络   │ │   IoT网络   │ │   WiFi/5G   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 集群部署方案

#### 1. Web前端集群
- **节点数量**：2-4个节点
- **负载均衡**：Nginx + Keepalived
- **静态资源**：CDN加速
- **会话保持**：Redis会话存储

#### 2. API网关集群
- **节点数量**：2-3个节点
- **路由规则**：基于URL和权重
- **限流熔断**：Sentinel
- **API监控**：SkyWalking

#### 3. 微服务集群
- **节点数量**：3-10个节点（根据业务量）
- **服务发现**：Eureka/Nacos
- **配置管理**：Spring Cloud Config
- **链路追踪**：Zipkin/Jaeger

#### 4. 数据库集群
- **主从配置**：1主2从
- **读写分离**：主库写、从库读
- **故障切换**：MHA/PGTools
- **备份策略**：每日全量 + 实时增量

#### 5. 缓存集群
- **集群模式**：Redis Cluster
- **节点数量**：6个节点（3主3从）
- **数据分片**：16384个哈希槽
- **持久化**：RDB + AOF

## 📝 总结

本设计文档系统从项目概述、技术架构、模块设计、性能指标、部署架构等方面，全面阐述了智能视频模块的设计方案。后续文档将深入到每个模块的详细功能设计、界面原型和数据库设计。

**下一步**：
1. 详细功能模块设计（安全级别、功能清单、流程设计）
2. 界面原型图设计（每个页面、每个按钮的详细设计）
3. 数据库表结构设计（表结构、ER图、索引设计）
4. 接口设计规范（API定义、参数说明、返回格式）

---

*本文档是智能视频模块完整设计文档系统的第一部分，后续将持续更新和完善。*
