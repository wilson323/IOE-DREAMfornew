# 04-è´¦æˆ·ç±»åˆ«åŒºåŸŸæƒé™è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**è®¾è®¡ç›®æ ‡**ï¼šé€šè¿‡JSONå­—æ®µåœ¨è´¦æˆ·ç±»åˆ«ä¸­ç›´æ¥é…ç½®åŒºåŸŸæƒé™ï¼Œä¼˜åŒ–é«˜é¢‘æŸ¥è¯¢æ€§èƒ½ï¼ŒåŒæ—¶æä¾›å®Œå–„çš„è¡¥å¿æœºåˆ¶åº”å¯¹å„ç§åœºæ™¯ã€‚

**æ ¸å¿ƒè®¾è®¡**ï¼š
- âœ… è´¦æˆ·ç±»åˆ«é€šè¿‡ `area_config` JSONå­—æ®µé…ç½®å¯ç”¨åŒºåŸŸ
- âœ… åŒºåŸŸæœ¬èº«å·²é…ç½®æ”¯æŒçš„é¤åˆ«åˆ†ç±»ï¼ˆåœ¨åŒºåŸŸç®¡ç†æ¨¡å—ï¼‰
- âœ… è´¦æˆ·ç±»åˆ«ç»§æ‰¿åŒºåŸŸçš„é¤åˆ«æƒé™ï¼Œå¯é€‰æ‹©æ€§è¿‡æ»¤
- âœ… æä¾›åå‘ç´¢å¼•å’Œç»Ÿè®¡è¡¨åº”å¯¹ä½é¢‘æŸ¥è¯¢åœºæ™¯

**è®¾è®¡ç†å¿µ**ï¼š
```
è´¦æˆ·ç±»åˆ«.area_config â†’ åŒºåŸŸ.meal_categories â†’ é¤åˆ«åˆ†ç±» â†’ å…·ä½“é¤åˆ«
   (JSONé…ç½®)           (é¤å…åŸæœ‰å±æ€§)
```

**è¡¥å¿æœºåˆ¶**ï¼š
- ğŸ”„ Redisåå‘ç´¢å¼•ï¼ˆåº”å¯¹åå‘æŸ¥è¯¢ï¼‰
- ğŸ“Š ç»Ÿè®¡æ±‡æ€»è¡¨ï¼ˆåº”å¯¹æŠ¥è¡¨éœ€æ±‚ï¼‰
- âœ… æ•°æ®ä¸€è‡´æ€§æ ¡éªŒï¼ˆå®šæœŸæ ¡éªŒä»»åŠ¡ï¼‰
- ğŸ”™ SQLè§†å›¾ï¼ˆåº”æ€¥é™çº§æ–¹æ¡ˆï¼‰

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### 1. ä¸»è¡¨ç»“æ„

```mermaid
erDiagram
    POSID_ACCOUNTKIND ||--o{ POSID_ACCOUNT : "è´¦æˆ·"
    
    POSID_ACCOUNTKIND {
        VARCHAR id PK "è´¦æˆ·ç±»åˆ«ID"
        VARCHAR code UK "ç¼–å·"
        VARCHAR name "åç§°"
        INT discount_type "æŠ˜æ‰£ç±»å‹"
        INT discount "æŠ˜æ‰£å€¼"
        INT date_max_money "æ—¥é™é¢"
        INT date_max_count "æ—¥é™æ¬¡"
        INT month_max_money "æœˆé™é¢"
        INT month_max_count "æœˆé™æ¬¡"
        JSON mode_config "æ¶ˆè´¹æ¨¡å¼é…ç½®"
        JSON area_config "åŒºåŸŸæƒé™é…ç½®"
        BOOLEAN order_meal "å¿…é¡»è®¢é¤"
        BOOLEAN is_attendance_consume "è€ƒå‹¤æ¶ˆè´¹"
        DATETIME create_time "åˆ›å»ºæ—¶é—´"
        DATETIME update_time "æ›´æ–°æ—¶é—´"
    }
```

### 2. è¡¥å¿æœºåˆ¶è¡¨ç»“æ„

#### 2.1 åŒºåŸŸä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆåº”å¯¹æŠ¥è¡¨éœ€æ±‚ï¼‰

```sql
-- ========================================
-- åŒºåŸŸä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆæ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ï¼‰
-- ========================================
CREATE TABLE POSID_AREA_USAGE_STAT (
    area_id VARCHAR(50) PRIMARY KEY COMMENT 'åŒºåŸŸID',
    account_kind_ids TEXT COMMENT 'ä½¿ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«IDï¼ˆJSONæ•°ç»„ï¼‰',
    account_kind_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ•°é‡',
    include_sub_count INT DEFAULT 0 COMMENT 'åŒ…å«å­åŒºåŸŸçš„æ•°é‡',
    last_update_time DATETIME COMMENT 'æœ€åæ›´æ–°æ—¶é—´',
    
    INDEX idx_update_time(last_update_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åŒºåŸŸä½¿ç”¨ç»Ÿè®¡è¡¨';

-- æ›´æ–°SQLï¼ˆå®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼‰
INSERT INTO POSID_AREA_USAGE_STAT (area_id, account_kind_ids, account_kind_count, include_sub_count, last_update_time)
SELECT 
    a.id AS area_id,
    JSON_ARRAYAGG(ak.id) AS account_kind_ids,
    COUNT(ak.id) AS account_kind_count,
    SUM(CASE WHEN JSON_EXTRACT(area_config_item.value, '$.includeSubAreas') = true THEN 1 ELSE 0 END) AS include_sub_count,
    NOW() AS last_update_time
FROM POSID_AREA a
LEFT JOIN POSID_ACCOUNTKIND ak ON JSON_CONTAINS(
    ak.area_config, 
    JSON_OBJECT('areaId', a.id),
    '$'
)
GROUP BY a.id
ON DUPLICATE KEY UPDATE
    account_kind_ids = VALUES(account_kind_ids),
    account_kind_count = VALUES(account_kind_count),
    include_sub_count = VALUES(include_sub_count),
    last_update_time = VALUES(last_update_time);
```

#### 2.2 åº”æ€¥SQLè§†å›¾ï¼ˆé™çº§æ–¹æ¡ˆï¼‰

```sql
-- ========================================
-- è´¦æˆ·ç±»åˆ«-åŒºåŸŸå…³è”è§†å›¾ï¼ˆåº”æ€¥é™çº§ä½¿ç”¨ï¼‰
-- ========================================
CREATE VIEW V_POSID_ACCOUNTKIND_AREA AS
SELECT 
    ak.id AS account_kind_id,
    JSON_EXTRACT(area_item.value, '$.areaId') AS area_id,
    JSON_EXTRACT(area_item.value, '$.includeSubAreas') AS include_sub_areas,
    ak.update_time AS update_time
FROM POSID_ACCOUNTKIND ak
CROSS JOIN JSON_TABLE(
    ak.area_config,
    '$[*]' COLUMNS(
        value JSON PATH '$'
    )
) AS area_item
WHERE ak.area_config IS NOT NULL;

-- ä½¿ç”¨ç¤ºä¾‹ï¼šæŸ¥è¯¢æŸåŒºåŸŸè¢«å“ªäº›è´¦æˆ·ç±»åˆ«ä½¿ç”¨
SELECT account_kind_id 
FROM V_POSID_ACCOUNTKIND_AREA 
WHERE area_id = 'area_001';
```

---

## ğŸ”‘ area_config JSONç»“æ„è®¾è®¡

### ç®€åŒ–ç»“æ„

```json
[
  {
    "areaId": "åŒºåŸŸID",
    "includeSubAreas": true
  }
]
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| areaId | String | âœ… | åŒºåŸŸID |
| includeSubAreas | Boolean | âœ… | æ˜¯å¦åŒ…å«æ‰€æœ‰å­åŒºåŸŸï¼ˆtrue/falseï¼‰ |

**è®¾è®¡è¦ç‚¹ï¼š**
- âœ… **æç®€è®¾è®¡**ï¼šåªé…ç½®åŒºåŸŸIDå’Œå±‚çº§ç»§æ‰¿
- âœ… **è‡ªåŠ¨ç»§æ‰¿**ï¼šè´¦æˆ·ç±»åˆ«è‡ªåŠ¨ç»§æ‰¿åŒºåŸŸçš„æ‰€æœ‰é¤åˆ«
- âœ… **æ‰©å±•æ€§**ï¼šæœªæ¥å¦‚éœ€å¢åŠ å­—æ®µï¼Œå¯åœ¨å¯¹è±¡ä¸­æ·»åŠ 

---

## ğŸ“Š é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ•™èŒå·¥å¡ï¼ˆå±‚çº§æƒé™ï¼‰

```json
{
  "code": "TEACHER",
  "name": "æ•™èŒå·¥å¡",
  "area_config": [
    {
      "areaId": "main_campus",
      "includeSubAreas": true
    }
  ]
}
```

### ç¤ºä¾‹2ï¼šå­¦ç”Ÿå¡ï¼ˆå¤šä¸ªåŒºåŸŸï¼‰

```json
{
  "code": "STUDENT",
  "name": "å­¦ç”Ÿå¡",
  "area_config": [
    {
      "areaId": "canteen_1",
      "includeSubAreas": false
    },
    {
      "areaId": "canteen_2",
      "includeSubAreas": false
    },
    {
      "areaId": "library",
      "includeSubAreas": true
    }
  ]
}
```

---

## ğŸ”„ æƒé™éªŒè¯æµç¨‹

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

```
è´¦æˆ·ç±»åˆ«.area_config â†’ åŒºåŸŸ.meal_categories â†’ é¤åˆ«åˆ†ç±» â†’ å…·ä½“é¤åˆ«
     (é…ç½®å¯ç”¨åŒºåŸŸ)      (åŒºåŸŸæ”¯æŒçš„é¤åˆ«)     (åˆ†ç±»)      (é¤åˆ«)
```

**å…³é”®ç‚¹ï¼š**
1. **è´¦æˆ·ç±»åˆ«** `area_config`ï¼šé…ç½®è¯¥ç±»åˆ«å¯ä»¥åœ¨å“ªäº›åŒºåŸŸæ¶ˆè´¹
2. **åŒºåŸŸè¡¨** `meal_categories` å­—æ®µï¼šé…ç½®è¯¥åŒºåŸŸæ”¯æŒå“ªäº›é¤åˆ«åˆ†ç±»ï¼ˆåœ¨åŒºåŸŸç®¡ç†æ¨¡å—é…ç½®ï¼‰
3. **è‡ªåŠ¨ç»§æ‰¿**ï¼šè´¦æˆ·ç±»åˆ«åœ¨è¯¥åŒºåŸŸæ¶ˆè´¹æ—¶ï¼Œè‡ªåŠ¨ç»§æ‰¿è¯¥åŒºåŸŸçš„æ‰€æœ‰é¤åˆ«åˆ†ç±»

### å®Œæ•´éªŒè¯æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·åœ¨è®¾å¤‡æ¶ˆè´¹] --> B[è¯»å–è´¦æˆ·ç±»åˆ«]
    B --> C[è·å–area_configæ•°ç»„]
    
    C --> D[è·å–è®¾å¤‡æ‰€åœ¨åŒºåŸŸID]
    D --> E{éå†area_config}
    
    E --> F{åŒºåŸŸIDåŒ¹é…?}
    F -->|ç›´æ¥åŒ¹é…| G[åŒºåŸŸæƒé™é€šè¿‡]
    F -->|ä¸åŒ¹é…| H{includeSubAreas=true?}
    
    H -->|æ˜¯| I{è®¾å¤‡åŒºåŸŸæ˜¯å­åŒºåŸŸ?}
    I -->|æ˜¯| G
    I -->|å¦| J[ç»§ç»­éå†ä¸‹ä¸€ä¸ªåŒºåŸŸ]
    
    H -->|å¦| J
    J --> K{è¿˜æœ‰å…¶ä»–é…ç½®åŒºåŸŸ?}
    K -->|æ˜¯| E
    K -->|å¦| L[åŒºåŸŸæƒé™æ‹’ç»]
    
    G --> M[ä»åŒºåŸŸè¡¨è¯»å–meal_categories]
    M --> N{åŒºåŸŸæœ‰é¤åˆ«é…ç½®?}
    N -->|å¦| O[è¯¥åŒºåŸŸä¸é™åˆ¶é¤åˆ«\næƒé™é€šè¿‡]
    N -->|æ˜¯| P[è·å–å½“å‰æ¶ˆè´¹é¤åˆ«åˆ†ç±»]
    
    P --> Q{é¤åˆ«åˆ†ç±»åœ¨åŒºåŸŸå…è®¸åˆ—è¡¨?}
    Q -->|æ˜¯| O
    Q -->|å¦| R[é¤åˆ«æƒé™æ‹’ç»]
    
    style L fill:#ff6b6b
    style R fill:#ff6b6b
    style O fill:#51cf66
```

---

## ğŸ’¾ ç¼“å­˜ç­–ç•¥

### æ ¸å¿ƒç¼“å­˜è®¾è®¡

| ç¼“å­˜é¡¹ | Redis Key | è¿‡æœŸæ—¶é—´ | è¯´æ˜ |
|-------|-----------|---------|------|
| è´¦æˆ·ç±»åˆ«å®Œæ•´é…ç½® | `accountkind:full:{id}` | 1å°æ—¶ | åŒ…å«mode_config+area_config |
| æœ‰æ•ˆåŒºåŸŸåˆ—è¡¨ï¼ˆå±•å¼€ï¼‰ | `accountkind:areas:{id}` | 1å°æ—¶ | å±•å¼€includeSubAreasåçš„æ‰€æœ‰åŒºåŸŸ |
| åŒºåŸŸè¯¦æƒ…ï¼ˆå«é¤åˆ«ï¼‰ | `area:info:{areaId}` | 30åˆ†é’Ÿ | åŒºåŸŸä¿¡æ¯+meal_categories |
| åŒºåŸŸæƒé™æ ¡éªŒç»“æœ | `perm:area:{accountKindId}:{areaId}` | 30åˆ†é’Ÿ | å¸ƒå°”å€¼ç¼“å­˜ |

### åå‘ç´¢å¼•ç¼“å­˜ï¼ˆåº”å¯¹åå‘æŸ¥è¯¢ï¼‰

| ç¼“å­˜é¡¹ | Redis Key | è¿‡æœŸæ—¶é—´ | è¯´æ˜ |
|-------|-----------|---------|------|
| åŒºåŸŸè¢«å“ªäº›è´¦æˆ·ç±»åˆ«ä½¿ç”¨ | `area:accountkinds:{areaId}` | 1å°æ—¶ | Setç»“æ„ï¼Œè´¦æˆ·ç±»åˆ«IDåˆ—è¡¨ |
| è´¦æˆ·ç±»åˆ«ä½¿ç”¨çš„æ‰€æœ‰åŒºåŸŸ | `accountkind:all-areas:{kindId}` | 1å°æ—¶ | å±•å¼€åçš„æ‰€æœ‰åŒºåŸŸï¼ˆå«å­åŒºåŸŸï¼‰ |

### ç¼“å­˜æ›´æ–°ç­–ç•¥

**ä¸»åŠ¨åˆ·æ–°ï¼š**
- è´¦æˆ·ç±»åˆ«çš„ `area_config` å˜æ›´ â†’ åˆ é™¤è¯¥ç±»åˆ«çš„æ‰€æœ‰æƒé™ç¼“å­˜ + æ›´æ–°åå‘ç´¢å¼•
- åŒºåŸŸç»“æ„å˜æ›´ï¼ˆæ–°å¢/åˆ é™¤å­åŒºåŸŸï¼‰â†’ åˆ é™¤æ‰€æœ‰è´¦æˆ·ç±»åˆ«çš„åŒºåŸŸç¼“å­˜
- åŒºåŸŸçš„ `meal_categories` é…ç½®å˜æ›´ â†’ åˆ é™¤åŒºåŸŸç¼“å­˜å’Œç›¸å…³æƒé™ç¼“å­˜

**åå‘ç´¢å¼•æ›´æ–°é€»è¾‘**ï¼š

è´¦æˆ·ç±»åˆ«`area_config`å˜æ›´æ—¶çš„å¤„ç†æ­¥éª¤ï¼š
1. **è·å–æ—§é…ç½®**ï¼šä»æ•°æ®åº“è¯»å–åŸæœ‰çš„`area_config`
2. **æ›´æ–°æ•°æ®åº“**ï¼šä¿å­˜æ–°çš„`area_config`åˆ°æ•°æ®åº“
3. **åˆ é™¤æ—§çš„åå‘ç´¢å¼•**ï¼šéå†æ—§é…ç½®ï¼Œä»Redis Setä¸­ç§»é™¤å¯¹åº”å…³ç³»
   - é”®æ ¼å¼ï¼š`area:accountkinds:{areaId}`
   - æ“ä½œï¼š`SREM area:accountkinds:{æ—§areaId} {accountKindId}`
4. **æ·»åŠ æ–°çš„åå‘ç´¢å¼•**ï¼šéå†æ–°é…ç½®ï¼Œå‘Redis Setä¸­æ·»åŠ å¯¹åº”å…³ç³»
   - æ“ä½œï¼š`SADD area:accountkinds:{æ–°areaId} {accountKindId}`
5. **åˆ é™¤ç›¸å…³ç¼“å­˜**ï¼šæ¸…ç†è´¦æˆ·ç±»åˆ«çš„å®Œæ•´é…ç½®ç¼“å­˜
   - `accountkind:full:{accountKindId}`
   - `accountkind:areas:{accountKindId}`

---

## ğŸ”§ å®Œå–„çš„è¡¥å¿æœºåˆ¶

### 1. åå‘æŸ¥è¯¢æ”¯æŒ

**æŸ¥è¯¢æŸåŒºåŸŸè¢«å“ªäº›è´¦æˆ·ç±»åˆ«ä½¿ç”¨**çš„ä¸‰çº§é™çº§æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆAï¼šRediså®æ—¶ç´¢å¼•ï¼ˆæ¨èï¼Œæ—¥å¸¸ä½¿ç”¨ï¼‰

**æŸ¥è¯¢é€»è¾‘**ï¼š
1. **ä¸€çº§æŸ¥è¯¢**ï¼šä»Redis Setè¯»å– `area:accountkinds:{areaId}`
   - å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›è´¦æˆ·ç±»åˆ«IDåˆ—è¡¨
   - æ€§èƒ½ï¼š<5msï¼Œé€‚åˆå®æ—¶æŸ¥è¯¢

2. **äºŒçº§é™çº§**ï¼šRedisä¸å­˜åœ¨æ—¶ï¼Œä»ç»Ÿè®¡è¡¨`POSID_AREA_USAGE_STAT`è¯»å–
   - è§£æ`account_kind_ids` JSONæ•°ç»„
   - é‡å»ºRedisç´¢å¼•ï¼ˆè¿‡æœŸæ—¶é—´1å°æ—¶ï¼‰
   - æ€§èƒ½ï¼š10-20ms

3. **ä¸‰çº§é™çº§**ï¼šç»Ÿè®¡è¡¨ä¹Ÿä¸å­˜åœ¨æ—¶ï¼Œå…¨è¡¨æ‰«æï¼ˆæœ€åæ‰‹æ®µï¼‰
   - æ‰«ææ‰€æœ‰è´¦æˆ·ç±»åˆ«çš„`area_config`
   - æ€§èƒ½ï¼š100-500msï¼ˆå–å†³äºæ•°æ®é‡ï¼‰

#### æ–¹æ¡ˆBï¼šSQLè§†å›¾ï¼ˆåº”æ€¥é™çº§ï¼Œä»…ç´§æ€¥æƒ…å†µï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼šRediså’Œç»Ÿè®¡è¡¨éƒ½ä¸å¯ç”¨æ—¶çš„åº”æ€¥æ–¹æ¡ˆ

**æŸ¥è¯¢æ–¹å¼**ï¼š
- ç›´æ¥æŸ¥è¯¢SQLè§†å›¾ `V_POSID_ACCOUNTKIND_AREA`
- SQLï¼š`SELECT account_kind_id FROM V_POSID_ACCOUNTKIND_AREA WHERE area_id = ?`
- æ€§èƒ½ï¼š20-50msï¼ˆå–å†³äºç´¢å¼•ï¼‰

### 2. ç»Ÿè®¡æŠ¥è¡¨æ”¯æŒ

#### å®šæ—¶ä»»åŠ¡ï¼šæ›´æ–°ç»Ÿè®¡è¡¨

**æ‰§è¡Œé¢‘ç‡**ï¼šæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆ`cron: 0 0 * * * ?`ï¼‰

**ç»Ÿè®¡é€»è¾‘**ï¼š
1. æŸ¥è¯¢æ‰€æœ‰åŒºåŸŸåˆ—è¡¨
2. å¯¹æ¯ä¸ªåŒºåŸŸï¼š
   - æ‰«ææ‰€æœ‰è´¦æˆ·ç±»åˆ«çš„`area_config`
   - æŸ¥æ‰¾å¼•ç”¨å½“å‰åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«
   - ç»Ÿè®¡`includeSubAreas=true`çš„æ•°é‡
   - ä¿å­˜åˆ°ç»Ÿè®¡è¡¨`POSID_AREA_USAGE_STAT`ï¼š
     - `area_id`ï¼šåŒºåŸŸID
     - `account_kind_ids`ï¼šè´¦æˆ·ç±»åˆ«IDæ•°ç»„ï¼ˆJSONï¼‰
     - `account_kind_count`ï¼šä½¿ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«æ•°é‡
     - `include_sub_count`ï¼šå¯ç”¨åŒ…å«å­åŒºåŸŸçš„æ•°é‡
     - `last_update_time`ï¼šæœ€åæ›´æ–°æ—¶é—´
   - åŒæ­¥æ›´æ–°Redisåå‘ç´¢å¼• `area:accountkinds:{areaId}`

3. è®°å½•ç»Ÿè®¡å®Œæˆæ—¥å¿—

### 3. æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ

**æ‰§è¡Œé¢‘ç‡**ï¼šæ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆ`cron: 0 0 2 * * ?`ï¼‰

**æ ¡éªŒé€»è¾‘**ï¼š
1. éå†æ‰€æœ‰è´¦æˆ·ç±»åˆ«
2. å¯¹æ¯ä¸ªè´¦æˆ·ç±»åˆ«çš„`area_config`è¿›è¡Œæ ¡éªŒï¼š
   - **æ£€æŸ¥åŒºåŸŸå­˜åœ¨æ€§**ï¼š
     - è§£æJSONï¼Œæå–æ‰€æœ‰`areaId`
     - æŸ¥è¯¢æ•°æ®åº“éªŒè¯åŒºåŸŸæ˜¯å¦å­˜åœ¨
     - å¦‚æœä¸å­˜åœ¨ï¼Œè®°å½•è­¦å‘Šå¹¶æ·»åŠ åˆ°å¼‚å¸¸åˆ—è¡¨

   - **æ£€æŸ¥includeSubAreasåˆç†æ€§**ï¼š
     - å¦‚æœé…ç½®äº†`includeSubAreas=true`
     - æ£€æŸ¥è¯¥åŒºåŸŸæ˜¯å¦æœ‰å­åŒºåŸŸ
     - å¦‚æœæ— å­åŒºåŸŸï¼Œè®°å½•ä¿¡æ¯æ—¥å¿—ï¼ˆä¸ç®—å¼‚å¸¸ï¼‰

   - **æ£€æŸ¥JSONæ ¼å¼**ï¼š
     - æ•è·JSONè§£æå¼‚å¸¸
     - è®°å½•æ ¼å¼é”™è¯¯åˆ°å¼‚å¸¸åˆ—è¡¨

3. å¦‚æœå‘ç°å¼‚å¸¸ï¼Œå‘é€å‘Šè­¦é‚®ä»¶
4. è®°å½•æ ¡éªŒå®Œæˆæ—¥å¿—å’Œå¼‚å¸¸æ•°é‡

### 4. çº§è”æ›´æ–°å·¥å…·

**åŒºåŸŸåˆ é™¤å‰çš„æ£€æŸ¥å’Œæ¸…ç†é€»è¾‘**ï¼š

**æ­¥éª¤1ï¼šå®‰å…¨æ€§æ£€æŸ¥**
- æ£€æŸ¥æ˜¯å¦æœ‰å­åŒºåŸŸï¼Œæœ‰åˆ™æ‹’ç»åˆ é™¤

**æ­¥éª¤2ï¼šå…³è”æ•°æ®æ£€æŸ¥**
- æ£€æŸ¥æ˜¯å¦æœ‰è®¾å¤‡å…³è”è¯¥åŒºåŸŸï¼Œæœ‰åˆ™æ‹’ç»åˆ é™¤

**æ­¥éª¤3ï¼šæŸ¥æ‰¾å¼•ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«**
- è°ƒç”¨åå‘æŸ¥è¯¢è·å–æ‰€æœ‰ä½¿ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«IDåˆ—è¡¨
- å¦‚æœåˆ—è¡¨ä¸ä¸ºç©ºï¼š
  - æŠ›å‡ºå¼‚å¸¸ï¼Œæç¤ºç®¡ç†å‘˜å…ˆè§£é™¤å…³è”
  - é”™è¯¯æ¶ˆæ¯åŒ…å«å—å½±å“çš„è´¦æˆ·ç±»åˆ«æ•°é‡å’Œå‰5ä¸ªID

**æ­¥éª¤4ï¼šæ‰§è¡Œåˆ é™¤**
- ä»æ•°æ®åº“åˆ é™¤åŒºåŸŸè®°å½•

**æ­¥éª¤5ï¼šæ¸…ç†ç¼“å­˜**
- åˆ é™¤åŒºåŸŸç¼“å­˜ï¼š`area:info:{areaId}`
- åˆ é™¤åå‘ç´¢å¼•ï¼š`area:accountkinds:{areaId}`

**æ­¥éª¤6ï¼šæ¸…ç†ç»Ÿè®¡è¡¨**
- ä»`POSID_AREA_USAGE_STAT`è¡¨åˆ é™¤è¯¥åŒºåŸŸçš„ç»Ÿè®¡è®°å½•

---

**æ‰¹é‡æ›´æ–°å·¥å…·ï¼šåŒºåŸŸIDæ›¿æ¢**

**ä½¿ç”¨åœºæ™¯**ï¼šå½“åŒºåŸŸåˆå¹¶æˆ–è¿ç§»æ—¶ï¼Œæ‰¹é‡æ›´æ–°æ‰€æœ‰å¼•ç”¨

**å¤„ç†é€»è¾‘**ï¼š
1. è°ƒç”¨åå‘æŸ¥è¯¢è·å–æ‰€æœ‰ä½¿ç”¨æ—§åŒºåŸŸIDçš„è´¦æˆ·ç±»åˆ«
2. å¯¹æ¯ä¸ªè´¦æˆ·ç±»åˆ«ï¼š
   - è¯»å–å…¶`area_config` JSON
   - éå†é…ç½®é¡¹ï¼Œå°†æ—§åŒºåŸŸIDæ›¿æ¢ä¸ºæ–°åŒºåŸŸID
   - ä¿å­˜æ›´æ–°åçš„`area_config`
   - æ›´æ–°Redisåå‘ç´¢å¼•ï¼š
     - ä»æ—§åŒºåŸŸçš„Setä¸­ç§»é™¤ `SREM area:accountkinds:{oldAreaId} {kindId}`
     - æ·»åŠ åˆ°æ–°åŒºåŸŸçš„Set `SADD area:accountkinds:{newAreaId} {kindId}`
3. è®°å½•æ›´æ–°æ•°é‡æ—¥å¿—

---

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿æ€»ç»“

### æ ¸å¿ƒè®¾è®¡

1. **æç®€æ•°æ®æ¨¡å‹**ï¼šè´¦æˆ·ç±»åˆ«åªéœ€ `area_config` JSONå­—æ®µï¼Œæ— éœ€å…³è”è¡¨
2. **å•ä¸€æ•°æ®æº**ï¼šé¤åˆ«é…ç½®ç»Ÿä¸€ç”±åŒºåŸŸè¡¨ `meal_categories` å­—æ®µç®¡ç†
3. **è‡ªåŠ¨ç»§æ‰¿**ï¼šè´¦æˆ·ç±»åˆ«å…³è”åŒºåŸŸåï¼Œè‡ªåŠ¨ç»§æ‰¿è¯¥åŒºåŸŸçš„æ‰€æœ‰é¤åˆ«
4. **å±‚çº§æƒé™**ï¼šæ”¯æŒ `includeSubAreas`ï¼Œé…ç½®æ•ˆç‡æå‡10å€

### è¡¥å¿æœºåˆ¶å®Œå–„

âœ… **åå‘ç´¢å¼•**ï¼šRedis Set + ç»Ÿè®¡è¡¨åŒé‡ä¿éšœ  
âœ… **SQLè§†å›¾**ï¼šåº”æ€¥é™çº§æ–¹æ¡ˆï¼Œå…¼å®¹ä¼ ç»ŸSQL  
âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šå®šæœŸæ ¡éªŒ + å‘Šè­¦  
âœ… **çº§è”æ›´æ–°**ï¼šæä¾›æ‰¹é‡æ›´æ–°å·¥å…·  
âœ… **æ€§èƒ½ç›‘æ§**ï¼šç»Ÿè®¡è¡¨æ”¯æŒæŠ¥è¡¨åˆ†æ

### é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æ”¯æŒæ–¹å¼ | æ€§èƒ½ |
|------|---------|------|
| é«˜é¢‘æƒé™éªŒè¯ï¼ˆ85%ï¼‰ | JSONç›´æ¥è¯»å– + ç¼“å­˜ | æå¿«ï¼ˆ1-3msï¼‰ |
| é…ç½®ç•Œé¢å±•ç¤ºï¼ˆ10%ï¼‰ | JSONç›´æ¥è¯»å– | å¿«ï¼ˆ5msï¼‰ |
| åå‘æŸ¥è¯¢ï¼ˆ3%ï¼‰ | Redisç´¢å¼• + ç»Ÿè®¡è¡¨ | å¿«ï¼ˆ10msï¼‰ |
| æŠ¥è¡¨ç»Ÿè®¡ï¼ˆ2%ï¼‰ | ç»Ÿè®¡è¡¨ + å®šæ—¶æ›´æ–° | å¿«ï¼ˆç¦»çº¿ï¼‰ |
| åº”æ€¥æŸ¥è¯¢ï¼ˆ<1%ï¼‰ | SQLè§†å›¾ | ä¸­ï¼ˆ50msï¼‰ |

---

## ğŸ”§ å®ç°å»ºè®®

### ç³»ç»Ÿå¯åŠ¨æ—¶åˆå§‹åŒ–

**åˆå§‹åŒ–æµç¨‹ï¼ˆSpringå®¹å™¨å¯åŠ¨åè‡ªåŠ¨æ‰§è¡Œï¼‰**ï¼š

1. **é¢„çƒ­ç¼“å­˜**ï¼š
   - åŠ è½½çƒ­é—¨åŒºåŸŸçš„åŒºåŸŸä¿¡æ¯åˆ°Redis
   - åŠ è½½æ´»è·ƒè´¦æˆ·ç±»åˆ«çš„`area_config`åˆ°ç¼“å­˜

2. **æ„å»ºåå‘ç´¢å¼•**ï¼š
   - æ‰«ææ‰€æœ‰è´¦æˆ·ç±»åˆ«çš„`area_config`
   - æ„å»ºRedisåå‘ç´¢å¼• `area:accountkinds:{areaId}`
   - è®¾ç½®è¿‡æœŸæ—¶é—´1å°æ—¶

3. **æ›´æ–°ç»Ÿè®¡è¡¨**ï¼š
   - æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„åŒºåŸŸä½¿ç”¨ç»Ÿè®¡
   - ç¡®ä¿ç»Ÿè®¡è¡¨æ•°æ®æœ€æ–°

### ç›‘æ§å‘Šè­¦

**Prometheusç›‘æ§æŒ‡æ ‡**ï¼š

- `counter_accountkind_area_validation_total`ï¼šæƒé™éªŒè¯æ€»æ¬¡æ•°ï¼ˆæŒ‰ç»“æœåˆ†ç±»ï¼šæˆåŠŸ/å¤±è´¥ï¼‰
- `histogram_accountkind_area_validation_duration`ï¼šæƒé™éªŒè¯è€—æ—¶åˆ†å¸ƒï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
- `gauge_area_usage_stat_update_lag`ï¼šç»Ÿè®¡è¡¨æ›´æ–°å»¶è¿Ÿï¼ˆå½“å‰æ—¶é—´ - last_update_timeï¼‰

**å‘Šè­¦è§„åˆ™**ï¼š
- éªŒè¯å¤±è´¥ç‡è¶…è¿‡10%æ—¶å‘Šè­¦
- éªŒè¯è€—æ—¶P99è¶…è¿‡100msæ—¶å‘Šè­¦
- ç»Ÿè®¡è¡¨æ›´æ–°å»¶è¿Ÿè¶…è¿‡2å°æ—¶æ—¶å‘Šè­¦

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv6.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-31  
**æ›´æ–°æ—¶é—´**ï¼š2025-10-31  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šPOSID v3.13.1+  
**æ›´æ–°è¯´æ˜**ï¼š
- v6.0: ç®€åŒ–æ–‡æ¡£ï¼Œç§»é™¤Javaä»£ç ï¼ˆçº¦150è¡Œï¼‰ï¼Œç”¨æ–‡å­—æè¿°æ ¸å¿ƒé€»è¾‘
- v5.0: å¢åŠ å®Œå–„çš„è¡¥å¿æœºåˆ¶ï¼šåå‘ç´¢å¼•ã€ç»Ÿè®¡è¡¨ã€SQLè§†å›¾ã€ä¸€è‡´æ€§æ ¡éªŒ
- v4.0: ç®€åŒ–area_configç»“æ„ï¼Œé¤åˆ«é…ç½®ç”±åŒºåŸŸè¡¨meal_categoriesç»Ÿä¸€ç®¡ç†
- v3.0: é‡æ„ä¸ºJSONé…ç½®æ–¹æ¡ˆï¼Œåˆ é™¤ç‹¬ç«‹å…³è”è¡¨

