# 规则配置功能布局文档 - 完整版

## 功能概述

规则配置模块是考勤管理系统的核心配置中心，负责定义和管理各类考勤规则、预警规则、移动端规则、通知规则等。该模块提供灵活的规则引擎，支持多种条件组合和自定义配置，确保考勤系统能够适应不同企业的管理需求，实现精准的考勤计算和异常检测。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **表单构建器**: FormCreate 1.x (动态表单)
- **代码编辑器**: Monaco Editor (规则脚本编辑)
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue

### 项目文件组织结构
```
src/views/business/attendance/rules/
├── index.vue                        # 规则配置主页面
├── attendance/
│   ├── index.vue                   # 考勤规则配置页面
│   ├── components/
│   │   ├── WorkTimeRule.vue        # 工作时间规则组件
│   │   ├── ExceptionRule.vue       # 异常判定规则组件
│   │   ├── OvertimeRule.vue        # 加班规则组件
│   │   └── SpecialRule.vue         # 特殊规则组件
│   └── api/
│       └── attendance-rules-api.js # 考勤规则API
├── alert/
│   ├── index.vue                   # 预警规则配置页面
│   ├── components/
│   │   ├── RealTimeAlert.vue       # 实时预警组件
│   │   ├── StatisticsAlert.vue     # 统计预警组件
│   │   └── AlertProcessor.vue      # 预警处理组件
│   └── api/
│       └── alert-rules-api.js      # 预警规则API
├── mobile/
│   ├── index.vue                   # 移动端规则配置页面
│   ├── components/
│   │   ├── ClockInRule.vue         # 打卡规则组件
│   │   ├── SecurityRule.vue        # 安全规则组件
│   │   └── ConvenienceRule.vue     # 便捷规则组件
│   └── api/
│       └── mobile-rules-api.js     # 移动端规则API
├── notification/
│   ├── index.vue                   # 通知规则配置页面
│   ├── components/
│   │   ├── ChannelConfig.vue       # 通知渠道组件
│   │   ├── SceneConfig.vue         # 通知场景组件
│   │   └── TemplateEditor.vue      # 模板编辑器组件
│   └── api/
│       └── notification-rules-api.js # 通知规则API
├── mock/
│   └── rules-mock.js               # 模拟数据
├── api/
│   └── rules-api.js                # 统一API接口
└── utils/
    ├── rule-engine.js              # 规则引擎工具
    ├── form-builder.js             # 动态表单构建器
    └── rule-validator.js           # 规则验证器
```

### API接口设计
```javascript
// src/api/business/attendance/rules/attendance-rules-api.js
import { postRequest, getRequest, putRequest, deleteRequest } from '/@/lib/axios';

export const attendanceRulesApi = {
  // 工作时间规则
  getWorkTimeRules: (params) => getRequest('/attendance/rules/work-time/list', params),
  createWorkTimeRule: (params) => postRequest('/attendance/rules/work-time/create', params),
  updateWorkTimeRule: (id, params) => putRequest(`/attendance/rules/work-time/update/${id}`, params),
  deleteWorkTimeRule: (id) => deleteRequest(`/attendance/rules/work-time/delete/${id}`),
  testWorkTimeRule: (params) => postRequest('/attendance/rules/work-time/test', params),

  // 异常判定规则
  getExceptionRules: (params) => getRequest('/attendance/rules/exception/list', params),
  createExceptionRule: (params) => postRequest('/attendance/rules/exception/create', params),
  updateExceptionRule: (id, params) => putRequest(`/attendance/rules/exception/update/${id}`, params),
  deleteExceptionRule: (id) => deleteRequest(`/attendance/rules/exception/delete/${id}`),

  // 加班规则
  getOvertimeRules: (params) => getRequest('/attendance/rules/overtime/list', params),
  createOvertimeRule: (params) => postRequest('/attendance/rules/overtime/create', params),
  updateOvertimeRule: (id, params) => putRequest(`/attendance/rules/overtime/update/${id}`, params),
  deleteOvertimeRule: (id) => deleteRequest(`/attendance/rules/overtime/delete/${id}`),

  // 特殊规则
  getSpecialRules: (params) => getRequest('/attendance/rules/special/list', params),
  createSpecialRule: (params) => postRequest('/attendance/rules/special/create', params),
  updateSpecialRule: (id, params) => putRequest(`/attendance/rules/special/update/${id}`, params),
  deleteSpecialRule: (id) => deleteRequest(`/attendance/rules/special/delete/${id}`),
};

// src/api/business/attendance/rules/alert-rules-api.js
export const alertRulesApi = {
  // 实时预警规则
  getRealTimeAlertRules: (params) => getRequest('/attendance/rules/alert/realtime/list', params),
  createRealTimeAlertRule: (params) => postRequest('/attendance/rules/alert/realtime/create', params),
  updateRealTimeAlertRule: (id, params) => putRequest(`/attendance/rules/alert/realtime/update/${id}`, params),
  deleteRealTimeAlertRule: (id) => deleteRequest(`/attendance/rules/alert/realtime/delete/${id}`),

  // 统计预警规则
  getStatisticsAlertRules: (params) => getRequest('/attendance/rules/alert/statistics/list', params),
  createStatisticsAlertRule: (params) => postRequest('/attendance/rules/alert/statistics/create', params),
  updateStatisticsAlertRule: (id, params) => putRequest(`/attendance/rules/alert/statistics/update/${id}`, params),

  // 预警处理
  getAlertProcessors: () => getRequest('/attendance/rules/alert/processors'),
  updateAlertProcessor: (ruleId, processorId, params) => putRequest(`/attendance/rules/alert/${ruleId}/processor/${processorId}`, params),
};

// src/api/business/attendance/rules/notification-rules-api.js
export const notificationRulesApi = {
  // 通知渠道
  getNotificationChannels: () => getRequest('/attendance/rules/notification/channels'),
  updateNotificationChannel: (channelId, params) => putRequest(`/attendance/rules/notification/channel/${channelId}`, params),
  testNotificationChannel: (channelId, params) => postRequest(`/attendance/rules/notification/channel/${channelId}/test`, params),

  // 通知场景
  getNotificationScenes: (params) => getRequest('/attendance/rules/notification/scenes', params),
  createNotificationScene: (params) => postRequest('/attendance/rules/notification/scene/create', params),
  updateNotificationScene: (id, params) => putRequest(`/attendance/rules/notification/scene/update/${id}`, params),
  deleteNotificationScene: (id) => deleteRequest(`/attendance/rules/notification/scene/delete/${id}`),

  // 通知模板
  getNotificationTemplates: (sceneId) => getRequest(`/attendance/rules/notification/templates/${sceneId}`),
  updateNotificationTemplate: (templateId, params) => putRequest(`/attendance/rules/notification/template/${templateId}`, params),
  previewNotificationTemplate: (params) => postRequest('/attendance/rules/notification/template/preview', params),
};
```

## 核心功能模块

### 1. 工作时间规则配置

#### 工作时间规则组件
```vue
<!-- src/views/business/attendance/rules/attendance/components/WorkTimeRule.vue -->
<template>
  <div class="work-time-rule">
    <div class="rule-header">
      <h3>工作时间规则</h3>
      <div class="header-actions">
        <a-button type="primary" @click="handleAddRule">
          <template #icon><PlusOutlined /></template>
          新增规则
        </a-button>
      </div>
    </div>

    <!-- 规则列表 -->
    <div class="rule-list">
      <div
        v-for="rule in rules"
        :key="rule.id"
        class="rule-item"
        :class="{ active: selectedRuleId === rule.id }"
        @click="selectRule(rule)"
      >
        <div class="rule-info">
          <div class="rule-title">
            <h4>{{ rule.name }}</h4>
            <a-tag :color="getRuleStatusColor(rule.status)">{{ getRuleStatusText(rule.status) }}</a-tag>
          </div>
          <div class="rule-description">{{ rule.description }}</div>
          <div class="rule-meta">
            <span class="meta-item">
              <ClockCircleOutlined />
              {{ formatWorkTime(rule.workTime) }}
            </span>
            <span class="meta-item">
              <CalendarOutlined />
              {{ getWeekdaysText(rule.weekdays) }}
            </span>
            <span class="meta-item">
              <TeamOutlined />
              适用: {{ rule.applicableCount }}个部门
            </span>
          </div>
        </div>

        <div class="rule-actions">
          <a-button type="text" size="small" @click.stop="handleEditRule(rule)">
            <template #icon><EditOutlined /></template>
            编辑
          </a-button>
          <a-button type="text" size="small" @click.stop="handleCopyRule(rule)">
            <template #icon><CopyOutlined /></template>
            复制
          </a-button>
          <a-dropdown>
            <template #overlay>
              <a-menu @click="({ key }) => handleMenuClick(key, rule)">
                <a-menu-item key="test">
                  <PlayCircleOutlined />
                  测试
                </a-menu-item>
                <a-menu-item key="enable" v-if="rule.status !== 'active'">
                  <CheckCircleOutlined />
                  启用
                </a-menu-item>
                <a-menu-item key="disable" v-if="rule.status === 'active'">
                  <StopOutlined />
                  禁用
                </a-menu-item>
                <a-menu-divider />
                <a-menu-item key="delete" class="danger">
                  <DeleteOutlined />
                  删除
                </a-menu-item>
              </a-menu>
            </template>
            <a-button type="text" size="small">
              <MoreOutlined />
            </a-button>
          </a-dropdown>
        </div>
      </div>
    </div>

    <!-- 规则配置面板 -->
    <div class="rule-config-panel" v-if="selectedRule">
      <a-card :title="isEditing ? '编辑规则' : '查看规则'" :bordered="false">
        <template #extra>
          <a-button type="text" @click="closeConfig">
            <template #icon><CloseOutlined /></template>
          </a-button>
        </template>

        <a-form
          ref="formRef"
          :model="formData"
          :rules="formRules"
          :label-col="{ span: 6 }"
          :wrapper-col="{ span: 18 }"
        >
          <a-form-item label="规则名称" name="name">
            <a-input v-model:value="formData.name" placeholder="请输入规则名称" />
          </a-form-item>

          <a-form-item label="规则描述" name="description">
            <a-textarea v-model:value="formData.description" placeholder="请输入规则描述" :rows="2" />
          </a-form-item>

          <a-form-item label="工作时段" name="workTime">
            <a-time-range-picker
              v-model:value="formData.workTime"
              format="HH:mm"
              placeholder="['开始时间', '结束时间']"
            />
          </a-form-item>

          <a-form-item label="休息时段" name="breakTime">
            <a-time-range-picker
              v-model:value="formData.breakTime"
              format="HH:mm"
              placeholder="['休息开始', '休息结束']"
            />
          </a-form-item>

          <a-form-item label="工作日" name="weekdays">
            <a-checkbox-group v-model:value="formData.weekdays">
              <a-checkbox v-for="day in weekdays" :key="day.value" :value="day.value">
                {{ day.label }}
              </a-checkbox>
            </a-checkbox-group>
          </a-form-item>

          <a-form-item label="弹性时间" name="flexibleTime">
            <a-input-group compact>
              <a-input-number
                v-model:value="formData.flexibleTime.start"
                :min="0"
                :max="60"
                placeholder="迟到"
                style="width: 100px"
              />
              <a-input
                style="width: 30px; text-align: center; border-left: 0; pointer-events: none"
                placeholder="~"
                disabled
              />
              <a-input-number
                v-model:value="formData.flexibleTime.end"
                :min="0"
                :max="60"
                placeholder="早退"
                style="width: 100px; border-left: 0"
              />
              <span style="margin-left: 8px; color: #666;">分钟</span>
            </a-input-group>
          </a-form-item>

          <a-form-item label="适用范围" name="scope">
            <a-radio-group v-model:value="formData.scope.type">
              <a-radio value="all">全部员工</a-radio>
              <a-radio value="department">指定部门</a-radio>
              <a-radio value="position">指定岗位</a-radio>
              <a-radio value="individual">指定员工</a-radio>
            </a-radio-group>
          </a-form-item>

          <a-form-item name="scope" v-if="formData.scope.type !== 'all'">
            <a-select
              v-model:value="formData.scope.targets"
              mode="multiple"
              :placeholder="getScopePlaceholder(formData.scope.type)"
              style="width: 100%"
            >
              <a-select-option
                v-for="item in scopeOptions"
                :key="item.id"
                :value="item.id"
              >
                {{ item.name }}
              </a-select-option>
            </a-select>
          </a-form-item>

          <a-form-item label="状态" name="status">
            <a-radio-group v-model:value="formData.status">
              <a-radio value="active">启用</a-radio>
              <a-radio value="inactive">禁用</a-radio>
            </a-radio-group>
          </a-form-item>

          <a-form-item :wrapper-col="{ offset: 6, span: 18 }">
            <a-space>
              <a-button type="primary" @click="handleSaveRule" :loading="saving">
                保存
              </a-button>
              <a-button @click="handleTestRule" :loading="testing">
                测试
              </a-button>
              <a-button @click="closeConfig">取消</a-button>
            </a-space>
          </a-form-item>
        </a-form>
      </a-card>
    </div>

    <!-- 测试结果弹窗 -->
    <a-modal
      v-model:open="testResultVisible"
      title="规则测试结果"
      :footer="null"
      width="800px"
    >
      <div class="test-result">
        <a-descriptions :column="2" bordered>
          <a-descriptions-item label="测试时间">{{ testResult.testTime }}</a-descriptions-item>
          <a-descriptions-item label="测试员工">{{ testResult.employeeName }}</a-descriptions-item>
          <a-descriptions-item label="打卡时间">{{ testResult.clockTime }}</a-descriptions-item>
          <a-descriptions-item label="判定结果">
            <a-tag :color="testResult.result === 'normal' ? 'success' : 'error'">
              {{ testResult.result === 'normal' ? '正常' : '异常' }}
            </a-tag>
          </a-descriptions-item>
          <a-descriptions-item label="匹配规则" :span="2">{{ testResult.ruleName }}</a-descriptions-item>
          <a-descriptions-item label="详细说明" :span="2">{{ testResult.explanation }}</a-descriptions-item>
        </a-descriptions>
      </div>
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message, Modal } from 'ant-design-vue';
import {
  PlusOutlined,
  EditOutlined,
  CopyOutlined,
  PlayCircleOutlined,
  CheckCircleOutlined,
  StopOutlined,
  DeleteOutlined,
  MoreOutlined,
  CloseOutlined,
  ClockCircleOutlined,
  CalendarOutlined,
  TeamOutlined
} from '@ant-design/icons-vue';
import { attendanceRulesApi } from '/@/api/business/attendance/rules/attendance-rules-api';
import dayjs from 'dayjs';

const emit = defineEmits(['rule-change']);

const rules = ref([]);
const selectedRuleId = ref(null);
const selectedRule = computed(() => rules.value.find(r => r.id === selectedRuleId.value));
const isEditing = ref(false);
const saving = ref(false);
const testing = ref(false);
const testResultVisible = ref(false);
const testResult = ref({});

const formRef = ref();
const formData = reactive({
  name: '',
  description: '',
  workTime: [],
  breakTime: [],
  weekdays: [1, 2, 3, 4, 5],
  flexibleTime: {
    start: 0,
    end: 0
  },
  scope: {
    type: 'all',
    targets: []
  },
  status: 'active'
});

const weekdays = [
  { label: '周一', value: 1 },
  { label: '周二', value: 2 },
  { label: '周三', value: 3 },
  { label: '周四', value: 4 },
  { label: '周五', value: 5 },
  { label: '周六', value: 6 },
  { label: '周日', value: 7 }
];

const scopeOptions = ref([]);

const formRules = {
  name: [
    { required: true, message: '请输入规则名称', trigger: 'blur' }
  ],
  workTime: [
    { required: true, message: '请选择工作时段', trigger: 'change' }
  ],
  weekdays: [
    { required: true, message: '请选择工作日', trigger: 'change' }
  ]
};

// 加载规则列表
const loadRules = async () => {
  try {
    const response = await attendanceRulesApi.getWorkTimeRules();
    rules.value = response.data;
  } catch (error) {
    console.error('加载规则失败:', error);
    message.error('加载规则失败');
  }
};

// 选择规则
const selectRule = (rule) => {
  selectedRuleId.value = rule.id;
  isEditing.value = false;
  Object.assign(formData, rule);
  formData.workTime = [dayjs(rule.startTime, 'HH:mm'), dayjs(rule.endTime, 'HH:mm')];
  if (rule.breakStartTime && rule.breakEndTime) {
    formData.breakTime = [dayjs(rule.breakStartTime, 'HH:mm'), dayjs(rule.breakEndTime, 'HH:mm')];
  }
};

// 新增规则
const handleAddRule = () => {
  resetForm();
  selectedRuleId.value = null;
  isEditing.value = true;
};

// 编辑规则
const handleEditRule = (rule) => {
  selectRule(rule);
  isEditing.value = true;
};

// 复制规则
const handleCopyRule = async (rule) => {
  try {
    const copyData = {
      ...rule,
      name: `${rule.name}_副本`,
      status: 'inactive'
    };
    delete copyData.id;
    delete copyData.createdAt;
    delete copyData.updatedAt;

    await attendanceRulesApi.createWorkTimeRule(copyData);
    message.success('规则复制成功');
    loadRules();
  } catch (error) {
    message.error('规则复制失败');
  }
};

// 菜单点击
const handleMenuClick = async (key, rule) => {
  switch (key) {
    case 'test':
      await handleTestRule(rule);
      break;
    case 'enable':
      await handleToggleRuleStatus(rule, 'active');
      break;
    case 'disable':
      await handleToggleRuleStatus(rule, 'inactive');
      break;
    case 'delete':
      await handleDeleteRule(rule);
      break;
  }
};

// 测试规则
const handleTestRule = async (rule) => {
  testing.value = true;
  try {
    const testRule = rule || formData;
    const response = await attendanceRulesApi.testWorkTimeRule({
      ruleId: testRule.id,
      testDate: dayjs().format('YYYY-MM-DD'),
      testTime: dayjs().format('HH:mm:ss'),
      employeeId: 'test_employee'
    });

    testResult.value = response.data;
    testResultVisible.value = true;
  } catch (error) {
    message.error('规则测试失败');
  } finally {
    testing.value = false;
  }
};

// 切换规则状态
const handleToggleRuleStatus = async (rule, status) => {
  try {
    await attendanceRulesApi.updateWorkTimeRule(rule.id, { ...rule, status });
    message.success(`规则已${status === 'active' ? '启用' : '禁用'}`);
    loadRules();
  } catch (error) {
    message.error('操作失败');
  }
};

// 删除规则
const handleDeleteRule = (rule) => {
  Modal.confirm({
    title: '确认删除',
    content: `确定要删除规则"${rule.name}"吗？`,
    onOk: async () => {
      try {
        await attendanceRulesApi.deleteWorkTimeRule(rule.id);
        message.success('规则删除成功');
        if (selectedRuleId.value === rule.id) {
          closeConfig();
        }
        loadRules();
      } catch (error) {
        message.error('规则删除失败');
      }
    },
  });
};

// 保存规则
const handleSaveRule = async () => {
  try {
    await formRef.value.validate();
    saving.value = true;

    const saveData = {
      ...formData,
      startTime: formData.workTime[0].format('HH:mm'),
      endTime: formData.workTime[1].format('HH:mm'),
      breakStartTime: formData.breakTime.length > 0 ? formData.breakTime[0].format('HH:mm') : null,
      breakEndTime: formData.breakTime.length > 0 ? formData.breakTime[1].format('HH:mm') : null
    };

    if (selectedRuleId.value) {
      await attendanceRulesApi.updateWorkTimeRule(selectedRuleId.value, saveData);
      message.success('规则更新成功');
    } else {
      await attendanceRulesApi.createWorkTimeRule(saveData);
      message.success('规则创建成功');
    }

    emit('rule-change');
    closeConfig();
    loadRules();
  } catch (error) {
    if (error.errorFields) {
      message.error('请检查表单填写是否正确');
    } else {
      message.error('保存失败');
    }
  } finally {
    saving.value = false;
  }
};

// 关闭配置面板
const closeConfig = () => {
  selectedRuleId.value = null;
  isEditing.value = false;
  formRef.value?.resetFields();
};

// 重置表单
const resetForm = () => {
  Object.assign(formData, {
    name: '',
    description: '',
    workTime: [],
    breakTime: [],
    weekdays: [1, 2, 3, 4, 5],
    flexibleTime: {
      start: 0,
      end: 0
    },
    scope: {
      type: 'all',
      targets: []
    },
    status: 'active'
  });
};

// 获取规则状态颜色
const getRuleStatusColor = (status) => {
  return status === 'active' ? 'success' : 'default';
};

// 获取规则状态文本
const getRuleStatusText = (status) => {
  return status === 'active' ? '启用' : '禁用';
};

// 格式化工作时间
const formatWorkTime = (rule) => {
  return `${rule.startTime} - ${rule.endTime}`;
};

// 获取工作日文本
const getWeekdaysText = (weekdays) => {
  const dayNames = ['', '周一', '周二', '周三', '周四', '周五', '周六', '周日'];
  return weekdays.map(day => dayNames[day]).join('、');
};

// 获取适用范围占位符
const getScopePlaceholder = (type) => {
  const placeholders = {
    department: '请选择适用部门',
    position: '请选择适用岗位',
    individual: '请选择适用员工'
  };
  return placeholders[type] || '请选择';
};

onMounted(() => {
  loadRules();
});
</script>

<style scoped lang="less">
.work-time-rule {
  display: flex;
  height: 600px;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;

  .rule-header {
    padding: 16px 24px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;

    h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
  }

  .rule-list {
    width: 400px;
    border-right: 1px solid #f0f0f0;
    overflow-y: auto;
    padding: 16px;

    .rule-item {
      padding: 16px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;

      &:hover {
        border-color: #1890ff;
        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
      }

      &.active {
        border-color: #1890ff;
        background: #f0f8ff;
      }

      .rule-info {
        .rule-title {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;

          h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
          }
        }

        .rule-description {
          color: #666;
          font-size: 12px;
          margin-bottom: 8px;
          line-height: 1.4;
        }

        .rule-meta {
          display: flex;
          flex-wrap: wrap;
          gap: 12px;

          .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #999;
          }
        }
      }

      .rule-actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 4px;
      }
    }
  }

  .rule-config-panel {
    flex: 1;
    overflow-y: auto;
    padding: 16px;

    .test-result {
      :deep(.ant-descriptions-item-label) {
        font-weight: 600;
      }
    }
  }
}
</style>
```

### 2. 异常判定规则

```vue
<!-- src/views/business/attendance/rules/attendance/components/ExceptionRule.vue -->
<template>
  <div class="exception-rule">
    <div class="rule-header">
      <h3>异常判定规则</h3>
      <a-button type="primary" @click="showAddModal">
        <template #icon><PlusOutlined /></template>
        新增异常规则
      </a-button>
    </div>

    <!-- 规则分类标签 -->
    <div class="rule-categories">
      <a-tabs v-model:activeKey="activeCategory" @change="handleCategoryChange">
        <a-tab-pane key="late" tab="迟到规则">
          <RuleTable
            :rules="lateRules"
            rule-type="late"
            @edit="handleEditRule"
            @delete="handleDeleteRule"
            @test="handleTestRule"
          />
        </a-tab-pane>
        <a-tab-pane key="early" tab="早退规则">
          <RuleTable
            :rules="earlyRules"
            rule-type="early"
            @edit="handleEditRule"
            @delete="handleDeleteRule"
            @test="handleTestRule"
          />
        </a-tab-pane>
        <a-tab-pane key="absent" tab="缺勤规则">
          <RuleTable
            :rules="absentRules"
            rule-type="absent"
            @edit="handleEditRule"
            @delete="handleDeleteRule"
            @test="handleTestRule"
          />
        </a-tab-pane>
        <a-tab-pane key="forgot" tab="忘打卡规则">
          <RuleTable
            :rules="forgotRules"
            rule-type="forgot"
            @edit="handleEditRule"
            @delete="handleDeleteRule"
            @test="handleTestRule"
          />
        </a-tab-pane>
      </a-tabs>
    </div>

    <!-- 规则配置弹窗 -->
    <a-modal
      v-model:open="modalVisible"
      :title="isEditing ? '编辑异常规则' : '新增异常规则'"
      @ok="handleSaveRule"
      @cancel="handleCancelModal"
      :confirm-loading="saving"
      width="800px"
    >
      <ExceptionRuleForm
        ref="ruleFormRef"
        :rule-data="currentRule"
        :rule-type="activeCategory"
      />
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import { PlusOutlined } from '@ant-design/icons-vue';
import { attendanceRulesApi } from '/@/api/business/attendance/rules/attendance-rules-api';
import RuleTable from './components/RuleTable.vue';
import ExceptionRuleForm from './components/ExceptionRuleForm.vue';

const activeCategory = ref('late');
const modalVisible = ref(false);
const isEditing = ref(false);
const saving = ref(false);
const currentRule = ref(null);
const ruleFormRef = ref();

const lateRules = ref([]);
const earlyRules = ref([]);
const absentRules = ref([]);
const forgotRules = ref([]);

// 加载规则数据
const loadRules = async () => {
  try {
    const response = await attendanceRulesApi.getExceptionRules();
    const rules = response.data;

    lateRules.value = rules.filter(rule => rule.type === 'late');
    earlyRules.value = rules.filter(rule => rule.type === 'early');
    absentRules.value = rules.filter(rule => rule.type === 'absent');
    forgotRules.value = rules.filter(rule => rule.type === 'forgot');
  } catch (error) {
    console.error('加载异常规则失败:', error);
    message.error('加载异常规则失败');
  }
};

// 分类切换
const handleCategoryChange = (category) => {
  activeCategory.value = category;
};

// 显示新增弹窗
const showAddModal = () => {
  currentRule.value = null;
  isEditing.value = false;
  modalVisible.value = true;
};

// 编辑规则
const handleEditRule = (rule) => {
  currentRule.value = rule;
  isEditing.value = true;
  modalVisible.value = true;
};

// 删除规则
const handleDeleteRule = async (rule) => {
  try {
    await attendanceRulesApi.deleteExceptionRule(rule.id);
    message.success('规则删除成功');
    loadRules();
  } catch (error) {
    message.error('规则删除失败');
  }
};

// 测试规则
const handleTestRule = async (rule) => {
  try {
    const response = await attendanceRulesApi.testExceptionRule({
      ruleId: rule.id,
      testScenarios: ['late_5min', 'late_30min', 'early_10min']
    });
    // 显示测试结果
    message.info('规则测试完成');
  } catch (error) {
    message.error('规则测试失败');
  }
};

// 保存规则
const handleSaveRule = async () => {
  try {
    const formData = await ruleFormRef.value.getFormData();
    saving.value = true;

    if (isEditing.value) {
      await attendanceRulesApi.updateExceptionRule(currentRule.value.id, formData);
      message.success('规则更新成功');
    } else {
      await attendanceRulesApi.createExceptionRule({
        ...formData,
        type: activeCategory.value
      });
      message.success('规则创建成功');
    }

    modalVisible.value = false;
    loadRules();
  } catch (error) {
    message.error('保存失败');
  } finally {
    saving.value = false;
  }
};

// 取消弹窗
const handleCancelModal = () => {
  modalVisible.value = false;
  currentRule.value = null;
};

onMounted(() => {
  loadRules();
});
</script>

<style scoped lang="less">
.exception-rule {
  background: #fff;
  border-radius: 8px;
  padding: 16px;

  .rule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;

    h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
  }

  .rule-categories {
    :deep(.ant-tabs-content-holder) {
      padding: 16px 0;
    }
  }
}
</style>
```

### 3. 通知规则配置

```vue
<!-- src/views/business/attendance/rules/notification/components/TemplateEditor.vue -->
<template>
  <div class="template-editor">
    <div class="editor-header">
      <h4>通知模板编辑器</h4>
      <div class="editor-actions">
        <a-button @click="handlePreview" :loading="previewing">
          <template #icon><EyeOutlined /></template>
          预览
        </a-button>
        <a-button type="primary" @click="handleSave" :loading="saving">
          <template #icon><SaveOutlined /></template>
          保存
        </a-button>
      </div>
    </div>

    <div class="editor-content">
      <div class="template-form">
        <a-form layout="vertical">
          <a-form-item label="模板名称">
            <a-input v-model:value="templateData.name" placeholder="请输入模板名称" />
          </a-form-item>

          <a-form-item label="模板标题">
            <a-input v-model:value="templateData.title" placeholder="请输入通知标题" />
          </a-form-item>

          <a-form-item label="通知渠道">
            <a-checkbox-group v-model:value="templateData.channels">
              <a-checkbox value="email">邮件</a-checkbox>
              <a-checkbox value="sms">短信</a-checkbox>
              <a-checkbox value="app">APP推送</a-checkbox>
              <a-checkbox value="wechat">微信</a-checkbox>
              <a-checkbox value="dingtalk">钉钉</a-checkbox>
            </a-checkbox-group>
          </a-form-item>
        </a-form>
      </div>

      <div class="template-editor-main">
        <div class="editor-toolbar">
          <a-space>
            <a-button size="small" @click="insertVariable('employeeName')">
              员工姓名
            </a-button>
            <a-button size="small" @click="insertVariable('department')">
              部门名称
            </a-button>
            <a-button size="small" @click="insertVariable('date')">
              日期
            </a-button>
            <a-button size="small" @click="insertVariable('time')">
              时间
            </a-button>
            <a-button size="small" @click="insertVariable('rule')">
              规则名称
            </a-button>
            <a-button size="small" @click="insertVariable('reason')">
              异常原因
            </a-button>
          </a-space>
        </div>

        <div class="editor-area">
          <a-textarea
            v-model:value="templateData.content"
            placeholder="请输入通知内容，支持变量替换"
            :rows="10"
            @input="handleContentChange"
          />
        </div>

        <div class="variable-hint">
          <h5>可用变量：</h5>
          <div class="variable-list">
            <a-tag
              v-for="variable in availableVariables"
              :key="variable.key"
              @click="insertVariable(variable.key)"
              style="cursor: pointer; margin: 2px;"
            >
              {{ variable.key }} - {{ variable.description }}
            </a-tag>
          </div>
        </div>
      </div>
    </div>

    <!-- 预览弹窗 -->
    <a-modal
      v-model:open="previewVisible"
      title="模板预览"
      :footer="null"
      width="600px"
    >
      <div class="preview-content">
        <div class="preview-item">
          <h5>标题：</h5>
          <div class="preview-title">{{ previewData.title }}</div>
        </div>
        <div class="preview-item">
          <h5>内容：</h5>
          <div class="preview-body" v-html="previewData.content"></div>
        </div>
      </div>
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, computed } from 'vue';
import { message } from 'ant-design-vue';
import { EyeOutlined, SaveOutlined } from '@ant-design/icons-vue';
import { notificationRulesApi } from '/@/api/business/attendance/rules/notification-rules-api';

const props = defineProps({
  templateId: String,
  sceneId: String
});

const emit = defineEmits(['save']);

const saving = ref(false);
const previewing = ref(false);
const previewVisible = ref(false);

const templateData = reactive({
  name: '',
  title: '',
  content: '',
  channels: []
});

const previewData = reactive({
  title: '',
  content: ''
});

const availableVariables = [
  { key: '${employeeName}', description: '员工姓名' },
  { key: '${employeeNo}', description: '员工工号' },
  { key: '${department}', description: '部门名称' },
  { key: '${position}', description: '岗位名称' },
  { key: '${date}', description: '日期' },
  { key: '${time}', description: '时间' },
  { key: '${rule}', description: '规则名称' },
  { key: '${reason}', description: '异常原因' },
  { key: '${location}', description: '打卡地点' },
  { key: '${device}', description: '设备名称' }
];

// 插入变量
const insertVariable = (variable) => {
  const textarea = document.querySelector('.editor-area textarea');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = templateData.content;

  templateData.content = text.substring(0, start) + variable + text.substring(end);

  // 重新设置光标位置
  setTimeout(() => {
    textarea.focus();
    textarea.setSelectionRange(start + variable.length, start + variable.length);
  }, 0);
};

// 内容变化处理
const handleContentChange = () => {
  // 实时字数统计或其他处理
};

// 预览模板
const handlePreview = async () => {
  if (!templateData.title || !templateData.content) {
    message.warning('请先填写模板标题和内容');
    return;
  }

  previewing.value = true;
  try {
    const response = await notificationRulesApi.previewNotificationTemplate({
      title: templateData.title,
      content: templateData.content,
      testData: {
        employeeName: '张三',
        employeeNo: 'EMP001',
        department: '技术部',
        position: '高级工程师',
        date: '2024-01-15',
        time: '09:15',
        rule: '迟到判定规则',
        reason: '超过上班时间15分钟',
        location: '公司前门',
        device: '前门人脸识别机'
      }
    });

    previewData.title = response.data.title;
    previewData.content = response.data.content;
    previewVisible.value = true;
  } catch (error) {
    message.error('预览失败');
  } finally {
    previewing.value = false;
  }
};

// 保存模板
const handleSave = async () => {
  if (!templateData.name || !templateData.title || !templateData.content) {
    message.warning('请填写完整的模板信息');
    return;
  }

  saving.value = true;
  try {
    await notificationRulesApi.updateNotificationTemplate(props.templateId, templateData);
    message.success('模板保存成功');
    emit('save', templateData);
  } catch (error) {
    message.error('模板保存失败');
  } finally {
    saving.value = false;
  }
};
</script>

<style scoped lang="less">
.template-editor {
  .editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;

    h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
  }

  .editor-content {
    display: flex;
    gap: 16px;

    .template-form {
      width: 300px;
      flex-shrink: 0;
    }

    .template-editor-main {
      flex: 1;

      .editor-toolbar {
        margin-bottom: 12px;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
      }

      .editor-area {
        margin-bottom: 16px;

        :deep(.ant-input) {
          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
      }

      .variable-hint {
        h5 {
          margin-bottom: 8px;
          font-size: 14px;
        }

        .variable-list {
          border: 1px solid #f0f0f0;
          border-radius: 4px;
          padding: 8px;
          background: #fafafa;
        }
      }
    }
  }

  .preview-content {
    .preview-item {
      margin-bottom: 16px;

      h5 {
        margin-bottom: 8px;
        font-weight: 600;
      }

      .preview-title {
        padding: 8px 12px;
        background: #f0f8ff;
        border-left: 3px solid #1890ff;
        font-weight: 600;
      }

      .preview-body {
        padding: 12px;
        background: #fafafa;
        border-radius: 4px;
        line-height: 1.6;
        white-space: pre-wrap;
      }
    }
  }
}
</style>
```

## Mock数据示例

```javascript
// src/mock/rules-mock.js
export const mockWorkTimeRules = [
  {
    id: 'rule001',
    name: '标准工作时间',
    description: '周一至周五，9:00-18:00，午休12:00-13:00',
    startTime: '09:00',
    endTime: '18:00',
    breakStartTime: '12:00',
    breakEndTime: '13:00',
    weekdays: [1, 2, 3, 4, 5],
    flexibleTime: { start: 10, end: 10 },
    scope: { type: 'all', targets: [] },
    status: 'active',
    applicableCount: 1500
  },
  {
    id: 'rule002',
    name: '研发弹性工作时间',
    description: '研发部门弹性工作制，核心工作时间10:00-16:00',
    startTime: '09:30',
    endTime: '19:00',
    breakStartTime: '12:30',
    breakEndTime: '13:30',
    weekdays: [1, 2, 3, 4, 5],
    flexibleTime: { start: 30, end: 30 },
    scope: { type: 'department', targets: ['dept001', 'dept002'] },
    status: 'active',
    applicableCount: 200
  }
];

export const mockExceptionRules = {
  late: [
    {
      id: 'late001',
      name: '迟到5分钟内',
      type: 'late',
      condition: 'minutes > 0 AND minutes <= 5',
      action: 'warning',
      message: '迟到${minutes}分钟，请注意时间',
      status: 'active'
    },
    {
      id: 'late002',
      name: '迟到30分钟内',
      type: 'late',
      condition: 'minutes > 5 AND minutes <= 30',
      action: 'record',
      message: '迟到${minutes}分钟，已记录考勤异常',
      status: 'active'
    }
  ],
  early: [
    {
      id: 'early001',
      name: '早退10分钟内',
      type: 'early',
      condition: 'minutes > 0 AND minutes <= 10',
      action: 'warning',
      message: '早退${minutes}分钟，请注意工作时间',
      status: 'active'
    }
  ]
};

export const mockNotificationTemplates = [
  {
    id: 'tpl001',
    name: '迟到通知模板',
    title: '考勤异常提醒 - 迟到',
    content: '尊敬的${employeeName}，您今天${time}打卡，已迟到${minutes}分钟，请准时出勤。',
    channels: ['app', 'email'],
    sceneId: 'late'
  },
  {
    id: 'tpl002',
    name: '缺勤通知模板',
    title: '考勤异常提醒 - 缺勤',
    content: '尊敬的${employeeName}，您今天未打卡，请及时联系部门主管说明情况。',
    channels: ['app', 'sms'],
    sceneId: 'absent'
  }
];

export default {
  mockWorkTimeRules,
  mockExceptionRules,
  mockNotificationTemplates
};
```

## 开发注意事项总结

### 核心功能要点
1. **规则引擎** - 灵活的条件配置和执行逻辑
2. **动态表单** - 根据规则类型动态生成配置表单
3. **规则测试** - 实时测试规则效果和准确性
4. **模板系统** - 可配置的通知消息模板
5. **权限控制** - 不同角色的规则管理权限
6. **版本管理** - 规则变更的版本追踪

### 性能优化建议
1. 规则解析采用缓存机制
2. 批量规则处理优化
3. 动态表单组件懒加载
4. 规则测试异步执行

### 用户体验优化
1. 提供规则向导和模板
2. 实时预览规则效果
3. 智能提示和验证
4. 可视化的规则配置

## 总结

规则配置模块作为系统的配置核心，需要重点关注：

- 规则定义的灵活性和扩展性
- 配置界面的易用性和直观性
- 规则测试的准确性和实时性
- 模板系统的可配置性
- 规则执行的效率和性能

通过遵循本文档的技术规范，可以构建出功能完善、灵活可扩展的规则配置模块。