# è®¿å®¢é¢„çº¦å®¡æ‰¹æµç¨‹å›¾

## ğŸ“‹ æµç¨‹æ¦‚è¿°

è®¿å®¢é¢„çº¦å®¡æ‰¹æµç¨‹æ˜¯IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°ä¸­é‡è¦çš„å¤–éƒ¨äººå‘˜ç®¡ç†æµç¨‹ï¼Œç”¨äºå¤–éƒ¨è®¿å®¢é€šè¿‡é¢„çº¦ç”³è¯·è¿›å…¥å›­åŒºè¿›è¡Œå•†åŠ¡è®¿é—®ã€æŠ€æœ¯äº¤æµã€å‚è§‚è€ƒå¯Ÿç­‰æ´»åŠ¨ã€‚è¯¥æµç¨‹ç»“åˆäº†OAå·¥ä½œæµå¼•æ“ã€è®¿å®¢ç®¡ç†ç³»ç»Ÿã€é—¨ç¦æ§åˆ¶ç³»ç»Ÿå’Œè§†é¢‘ç›‘æ§ç³»ç»Ÿï¼Œä¸ºè®¿å®¢æä¾›ä»é¢„çº¦ç”³è¯·åˆ°ç¦»å›­çš„å…¨æµç¨‹æœåŠ¡ã€‚

### ğŸ¯ ä¸šåŠ¡ç›®æ ‡

- **ä¾¿æ·é¢„çº¦**: ä¸ºè®¿å®¢æä¾›ç®€å•å¿«æ·çš„é¢„çº¦ç”³è¯·æ¸ é“
- **å®‰å…¨ä¿éšœ**: é€šè¿‡å¤šçº§å®¡æ‰¹ç¡®ä¿è®¿å®¢è®¿é—®çš„å®‰å…¨æ€§
- **ä½“éªŒä¼˜åŒ–**: æå‡è®¿å®¢æ¥å¾…æ•ˆç‡å’ŒæœåŠ¡è´¨é‡
- **æ•°å­—åŒ–ç®¡ç†**: å®ç°è®¿å®¢ç®¡ç†çš„å…¨æµç¨‹æ•°å­—åŒ–
- **æ•°æ®åˆ†æ**: è®¿å®¢æ•°æ®ç»Ÿè®¡å’Œåˆ†ææ”¯æŒç®¡ç†å†³ç­–

### ğŸ“Š æµç¨‹æŒ‡æ ‡

| æŒ‡æ ‡é¡¹ | ç›®æ ‡å€¼ | è¯´æ˜ |
|---------|--------|------|
| **é¢„çº¦å“åº”æ—¶é—´** | â‰¤ 4å°æ—¶ | ä»é¢„çº¦ç”³è¯·åˆ°é¦–æ¬¡å®¡æ‰¹å“åº” |
| **å®¡æ‰¹å®Œæˆæ—¶é—´** | â‰¤ 24å°æ—¶ | ä»ç”³è¯·åˆ°æœ€ç»ˆå®¡æ‰¹å®Œæˆ |
| **å…¥å›­åŠç†æ—¶é—´** | â‰¤ 5åˆ†é’Ÿ | è®¿å®¢åˆ°è¾¾ååŠç†å…¥å›­æ‰‹ç»­æ—¶é—´ |
| **ç”µå­é€šè¡Œè¯ç”Ÿæˆ** | â‰¤ 2åˆ†é’Ÿ | å®¡æ‰¹é€šè¿‡åç”Ÿæˆç”µå­é€šè¡Œè¯ |
| **è®¿å®¢æ»¡æ„åº¦** | â‰¥ 95% | è®¿å®¢ä½“éªŒè¯„åˆ† |

---

## ğŸ”„ è¯¦ç»†æµç¨‹å›¾

```mermaid
graph TD
    A[è®¿å®¢å‘èµ·é¢„çº¦] --> B{é¢„çº¦æ¸ é“}

    B -->|å®˜ç½‘é¢„çº¦| C[Webé¢„çº¦è¡¨å•]
    B -->|å°ç¨‹åºé¢„çº¦| D[å¾®ä¿¡å°ç¨‹åº]
    B -->|å†…éƒ¨é‚€è¯·| E[å‘˜å·¥ä»£ä¸ºé¢„çº¦]
    B -->|ç”µè¯é¢„çº¦| F[å®¢æœå½•å…¥é¢„çº¦]

    C --> G[å¡«å†™è®¿å®¢ä¿¡æ¯]
    D --> G
    E --> H[é‚€è¯·äººä¿¡æ¯å¡«å†™]
    F --> G

    G --> I[é€‰æ‹©è¢«è®¿äºº/éƒ¨é—¨]
    H --> I
    I --> J[å¡«å†™è®¿é—®äº‹ç”±]

    J --> K[è®¾ç½®è®¿é—®æ—¶é—´]
    K --> L[é€‰æ‹©è®¿é—®åŒºåŸŸ]
    L --> M[ä¸Šä¼ è¯ä»¶ææ–™]

    M --> N[æäº¤é¢„çº¦ç”³è¯·]
    N --> O[ç³»ç»Ÿè‡ªåŠ¨åˆå®¡]

    O --> P{åˆå®¡ç»“æœ}
    P -->|é€šè¿‡| Q[å‘é€ç»™è¢«è®¿äººç¡®è®¤]
    P -->|ä¿¡æ¯ä¸å…¨| R[è¦æ±‚è¡¥å……ä¿¡æ¯]
    P -->|æ—¶é—´å†²çª| S[æ—¶é—´å†²çªæé†’]
    P -->|é»‘åå•æ£€æŸ¥| T[å®‰å…¨é£é™©æé†’]

    Q --> U{è¢«è®¿äººç¡®è®¤}
    U -->|åŒæ„| V[åˆ†é…å®¡æ‰¹äºº]
    U -->|æ‹’ç»| W[é€šçŸ¥è®¿å®¢è°ƒæ•´]
    U -->|è½¬ä»–äºº| X[è½¬å…¶ä»–è¢«è®¿äºº]

    V --> Y{è®¿é—®ç±»å‹åˆ¤æ–­}
    Y -->|æ™®é€šå•†åŠ¡è®¿é—®| Z[éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹]
    Y -->|é‡è¦å®¢æˆ·è®¿é—®| AA[éƒ¨é—¨ç»ç†+å®‰å…¨ç®¡ç†]
    Y -->|æ”¿åºœå®˜å‘˜è®¿é—®| BB[å¤šéƒ¨é—¨è”åˆå®¡æ‰¹]
    Y -->|ä¸´æ—¶ç´§æ€¥è®¿é—®| CC[ç®€åŒ–å®¡æ‰¹æµç¨‹]

    Z --> DD[éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹]
    AA --> EE[éƒ¨é—¨ç»ç†å®¡æ‰¹]
    BB --> FF[å¤šéƒ¨é—¨ä¼šç­¾]
    CC --> GG[å¿«é€Ÿé€šé“å®¡æ‰¹]

    DD --> HH{å®¡æ‰¹ç»“æœ}
    EE --> HH
    FF --> II{ä¼šç­¾ç»“æœ}
    GG --> HH

    HH -->|é€šè¿‡| JJ[ç”Ÿæˆè®¿å®¢é€šè¡Œè¯]
    HH -->|é©³å›| KK[å‘é€æ‹’ç»é€šçŸ¥]
    HH -->|éœ€è¡¥å……| LL[è¦æ±‚è¡¥å……ææ–™]
    HH -->|è½¬ä¸Šçº§| MM[ä¸Šçº§å®¡æ‰¹]

    II -->|å…¨éƒ¨é€šè¿‡| JJ
    II -->|ä»»ä¸€é©³å›| KK
    II -->|éƒ¨åˆ†é€šè¿‡| NN[è°ƒæ•´è®¿é—®æƒé™]

    JJ --> OO[å‘é€ç¡®è®¤é€šçŸ¥]
    NN --> OO
    MM --> OO

    OO --> PP[è®¿å®¢åˆ°è¾¾ç°åœº]
    PP --> QQ[éªŒè¯èº«ä»½ä¿¡æ¯]
    QQ --> RR[åŠç†å…¥å›­æ‰‹ç»­]

    RR --> SS[å‘æ”¾è®¿å®¢è¯ä»¶]
    SS --> TT[æ¿€æ´»é—¨ç¦æƒé™]
    TT --> UU[è®¿é—®è¿›è¡Œä¸­]

    UU --> VV{è®¿é—®ç»“æŸ}
    VV -->|æ­£å¸¸ç»“æŸ| WW[æƒé™è‡ªåŠ¨å¤±æ•ˆ]
    VV -->|æå‰ç¦»å¼€| XX[æƒé™æå‰å¤±æ•ˆ]

    WW --> YY[å‘é€æ„Ÿè°¢é—®å·]
    XX --> YY
    YY --> ZZ[æ•°æ®ç»Ÿè®¡åˆ†æ]

    W --> AAA[é€šçŸ¥è®¿å®¢]
    R --> BBB[é‡æ–°æäº¤]
    S --> CCC[æ—¶é—´è°ƒæ•´]
    T --> DDD[äººå·¥å®¡æ ¸]
    KK --> EEE[é€šçŸ¥æ‹’ç»åŸå› ]
    LL --> FFF[ææ–™è¡¥å……]
```

---

## ğŸ“‹ æµç¨‹èŠ‚ç‚¹è¯¦ç»†è¯´æ˜

### 1. é¢„çº¦ç”³è¯·é˜¶æ®µ

#### 1.1 è®¿å®¢ä¿¡æ¯ç™»è®°
```json
{
  "visitorInfo": {
    "visitorName": "ææ˜",
    "gender": "ç”·",
    "idCard": "110101199001011234",
    "phone": "13800138000",
    "email": "liming@example.com",
    "company": "ABCç§‘æŠ€æœ‰é™å…¬å¸",
    "position": "æŠ€æœ¯æ€»ç›‘",
    "photoUrl": "/uploads/visitor/photo_001.jpg"
  },
  "visitInfo": {
    "visitPurpose": "æŠ€æœ¯äº¤æµä¼šè®®",
    "visitType": "BUSINESS",
    "expectedDuration": "2å°æ—¶",
    "vehicleInfo": {
      "hasVehicle": true,
      "plateNumber": "äº¬A12345",
      "vehicleType": "è½¿è½¦"
    }
  },
  "materials": [
    {
      "type": "ID_CARD",
      "url": "/uploads/visitor/idcard_front.jpg",
      "name": "èº«ä»½è¯æ­£é¢"
    },
    {
      "type": "BUSINESS_CARD",
      "url": "/uploads/visitor/business_card.jpg",
      "name": "åç‰‡"
    }
  ]
}
```

#### 1.2 è®¿é—®æ—¶é—´è®¾ç½®
```java
@Component
public class VisitTimeValidationService {

    @Resource
    private HolidayService holidayService;

    @Resource
    private WorkingHoursService workingHoursService;

    /**
     * éªŒè¯è®¿é—®æ—¶é—´
     */
    public TimeValidationResult validateVisitTime(LocalDateTime startTime, LocalDateTime endTime) {
        TimeValidationResult result = new TimeValidationResult();

        // 1. æ£€æŸ¥æ—¶é—´åˆç†æ€§
        if (startTime.isAfter(endTime)) {
            result.setValid(false);
            result.setMessage("å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´");
            return result;
        }

        // 2. æ£€æŸ¥è®¿é—®æ—¶é•¿
        Duration duration = Duration.between(startTime, endTime);
        if (duration.toHours() > 8) {
            result.addWarning("è®¿é—®æ—¶é—´è¶…è¿‡8å°æ—¶ï¼Œå»ºè®®åˆ†æ®µå®‰æ’");
        }

        // 3. æ£€æŸ¥å·¥ä½œæ—¶é—´
        if (!isWorkingTime(startTime)) {
            result.addWarning("è®¿é—®æ—¶é—´åŒ…å«éå·¥ä½œæ—¶é—´");
        }

        // 4. æ£€æŸ¥èŠ‚å‡æ—¥
        if (isHoliday(startTime.toLocalDate())) {
            result.addWarning("è®¿é—®æ—¶é—´ä¸ºèŠ‚å‡æ—¥");
        }

        // 5. æ£€æŸ¥æ—¶é—´å†²çª
        List<VisitSchedule> conflicts = checkTimeConflicts(startTime, endTime);
        if (!conflicts.isEmpty()) {
            result.setConflicts(conflicts);
        }

        result.setValid(true);
        return result;
    }

    private boolean isWorkingTime(LocalDateTime time) {
        return workingHoursService.isWorkingTime(time);
    }

    private boolean isHoliday(LocalDate date) {
        return holidayService.isHoliday(date);
    }
}
```

### 2. è‡ªåŠ¨åˆå®¡é˜¶æ®µ

#### 2.1 è®¿å®¢ä¿¡æ¯éªŒè¯æœåŠ¡
```java
@Service
public class VisitorPreCheckService {

    @Resource
    private BlacklistService blacklistService;

    @Resource
    private IdCardVerificationService idCardService;

    @Resource
    private VisitorDao visitorDao;

    /**
     * æ‰§è¡Œè®¿å®¢è‡ªåŠ¨åˆå®¡
     */
    public VisitorPreCheckResult executePreCheck(VisitorApplication application) {
        VisitorPreCheckResult result = new VisitorPreCheckResult();

        try {
            // 1. èº«ä»½è¯çœŸå®æ€§éªŒè¯
            IdCardVerificationResult idResult = verifyIdCard(application.getIdCard());
            result.setIdCardValid(idResult.isValid());
            if (!idResult.isValid()) {
                result.addError("èº«ä»½è¯ä¿¡æ¯éªŒè¯å¤±è´¥: " + idResult.getMessage());
            }

            // 2. é»‘åå•æ£€æŸ¥
            BlacklistCheckResult blacklistResult = checkBlacklist(application);
            if (blacklistResult.isBlacklisted()) {
                result.setBlacklisted(true);
                result.addError("è®¿å®¢åœ¨é»‘åå•ä¸­: " + blacklistResult.getReason());
                return result;
            }

            // 3. å†å²è®¿é—®è®°å½•æ£€æŸ¥
            VisitorHistory history = getVisitorHistory(application.getIdCard());
            result.setHistoryScore(calculateHistoryScore(history));

            // 4. å®‰å…¨é£é™©è¯„ä¼°
            SecurityRisk risk = assessSecurityRisk(application, history);
            result.setRiskLevel(risk.getLevel());

            // 5. è®¿é—®æƒé™åŒ¹é…æ£€æŸ¥
            validateAccessPermissions(application, result);

        } catch (Exception e) {
            result.setSuccess(false);
            result.addError("è‡ªåŠ¨åˆå®¡å¼‚å¸¸: " + e.getMessage());
        }

        return result;
    }

    private IdCardVerificationResult verifyIdCard(String idCard) {
        // è°ƒç”¨ç¬¬ä¸‰æ–¹èº«ä»½è¯éªŒè¯API
        return idCardService.verify(idCard);
    }

    private BlacklistCheckResult checkBlacklist(VisitorApplication application) {
        return blacklistService.check(
            application.getIdCard(),
            application.getPhone(),
            application.getCompany()
        );
    }

    private SecurityRisk assessSecurityRisk(VisitorApplication application, VisitorHistory history) {
        SecurityRisk risk = new SecurityRisk();

        int riskScore = 0;

        // å…¬å¸é£é™©è¯„ä¼°
        if (isHighRiskCompany(application.getCompany())) {
            riskScore += 20;
        }

        // è®¿é—®äº‹ç”±é£é™©è¯„ä¼°
        if (isHighRiskPurpose(application.getVisitPurpose())) {
            riskScore += 15;
        }

        // å†å²è®°å½•é£é™©è¯„ä¼°
        if (history.hasViolationRecords()) {
            riskScore += 30;
        }

        // æ—¶é—´é£é™©è¯„ä¼°
        if (isAfterHours(application.getStartTime())) {
            riskScore += 10;
        }

        risk.setScore(riskScore);

        if (riskScore >= 50) {
            risk.setLevel(RiskLevel.HIGH);
        } else if (riskScore >= 25) {
            risk.setLevel(RiskLevel.MEDIUM);
        } else {
            risk.setLevel(RiskLevel.LOW);
        }

        return risk;
    }
}
```

### 3. è¢«è®¿äººç¡®è®¤é˜¶æ®µ

#### 3.1 è¢«è®¿äººç¡®è®¤æœåŠ¡
```java
@Service
public class HostConfirmationService {

    @Resource
    private NotificationService notificationService;

    @Resource
    private EmployeeDao employeeDao;

    @Resource
    private VisitApplicationDao applicationDao;

    /**
     * å‘é€è¢«è®¿äººç¡®è®¤é€šçŸ¥
     */
    public void sendHostConfirmation(VisitorApplication application) {
        HostConfirmation confirmation = HostConfirmation.builder()
            .applicationId(application.getId())
            .visitorName(application.getVisitorName())
            .visitorCompany(application.getCompany())
            .visitPurpose(application.getVisitPurpose())
            .visitTime(application.getStartTime())
            .hostUserId(application.getHostUserId())
            .confirmationUrl(generateConfirmationUrl(application.getId()))
            .build();

        // å‘é€å¤šæ¸ é“é€šçŸ¥
        notificationService.sendEmailConfirmation(confirmation);
        notificationService.sendSmsConfirmation(confirmation);
        notificationService.sendSystemNotification(confirmation);

        // è®°å½•é€šçŸ¥æ—¥å¿—
        logConfirmationSent(confirmation);
    }

    /**
     * å¤„ç†è¢«è®¿äººç¡®è®¤å“åº”
     */
    public ConfirmationResult processHostConfirmation(String applicationId, HostResponse response) {
        VisitorApplication application = applicationDao.selectById(applicationId);
        if (application == null) {
            throw new IllegalArgumentException("é¢„çº¦ç”³è¯·ä¸å­˜åœ¨");
        }

        ConfirmationResult result = new ConfirmationResult();

        switch (response.getAction()) {
            case AGREE:
                application.setStatus("HOST_CONFIRMED");
                application.setHostConfirmationTime(LocalDateTime.now());
                application.setHostRemark(response.getRemark());

                // ç»§ç»­å®¡æ‰¹æµç¨‹
                startApprovalProcess(application);
                result.setMessage("ç¡®è®¤æˆåŠŸï¼Œå·²è¿›å…¥å®¡æ‰¹æµç¨‹");
                break;

            case REJECT:
                application.setStatus("HOST_REJECTED");
                application.setHostRejectionReason(response.getReason());
                application.setHostRejectionTime(LocalDateTime.now());

                // é€šçŸ¥è®¿å®¢è°ƒæ•´
                notifyVisitorAdjustment(application, response.getReason());
                result.setMessage("å·²æ‹’ç»ï¼Œè¯·è®¿å®¢è°ƒæ•´é¢„çº¦ä¿¡æ¯");
                break;

            case TRANSFER:
                application.setStatus("HOST_TRANSFERRED");
                application.setNewHostUserId(response.getNewHostUserId());
                application.setTransferReason(response.getReason());

                // è½¬ç»™æ–°è¢«è®¿äºº
                transferToNewHost(application, response.getNewHostUserId());
                result.setMessage("å·²è½¬ç»™å…¶ä»–è¢«è®¿äººç¡®è®¤");
                break;

            default:
                throw new IllegalArgumentException("æœªçŸ¥çš„ç¡®è®¤åŠ¨ä½œ: " + response.getAction());
        }

        applicationDao.updateById(application);
        return result;
    }

    private void startApprovalProcess(VisitorApplication application) {
        // å¯åŠ¨å·¥ä½œæµå®¡æ‰¹
        WorkflowStartRequest workflowRequest = WorkflowStartRequest.builder()
            .processKey("visitor_approval")
            .businessKey(application.getId())
            .variables(Map.of(
                "applicationId", application.getId(),
                "visitorName", application.getVisitorName(),
                "visitPurpose", application.getVisitPurpose(),
                "riskLevel", application.getRiskLevel(),
                "hostUserId", application.getHostUserId()
            ))
            .build();

        workflowEngine.startProcess(workflowRequest);
    }
}
```

### 4. å®¡æ‰¹æ‰§è¡Œé˜¶æ®µ

#### 4.1 å®¡æ‰¹å†³ç­–å¼•æ“
```java
@Service
public class VisitorApprovalEngine {

    @Resource
    private ApprovalRuleEngine ruleEngine;

    @Resource
    private SecurityPolicyService securityPolicyService;

    /**
     * æ‰§è¡Œå®¡æ‰¹å†³ç­–
     */
    public ApprovalDecision executeDecision(ApprovalContext context) {
        ApprovalDecision decision = new ApprovalDecision();

        try {
            // 1. åº”ç”¨å®¡æ‰¹è§„åˆ™
            List<ApprovalRule> rules = getApplicableRules(context);
            for (ApprovalRule rule : rules) {
                RuleResult result = ruleEngine.apply(rule, context);
                decision.addRuleResult(rule.getName(), result);

                if (!result.isPassed() && rule.isMandatory()) {
                    decision.setResult(DecisionResult.REJECTED);
                    decision.setReason("è¿åå¼ºåˆ¶è§„åˆ™: " + rule.getName());
                    return decision;
                }
            }

            // 2. å®‰å…¨ç­–ç•¥æ£€æŸ¥
            SecurityPolicyCheck securityCheck = securityPolicyService.check(context);
            decision.setSecurityCheck(securityCheck);

            if (securityCheck.getRiskLevel() == RiskLevel.HIGH &&
                !context.getApprovalLevel().equals("EMERGENCY")) {
                decision.setResult(DecisionResult.MANUAL_REVIEW);
                decision.setReason("é«˜é£é™©è®¿é—®éœ€è¦äººå·¥å®¡æ ¸");
                return decision;
            }

            // 3. ç»¼åˆå†³ç­–
            decision.setResult(calculateFinalDecision(decision));
            decision.setReason(generateDecisionReason(decision));

        } catch (Exception e) {
            decision.setResult(DecisionResult.ERROR);
            decision.setReason("å†³ç­–å¼•æ“å¼‚å¸¸: " + e.getMessage());
        }

        return decision;
    }

    private List<ApprovalRule> getApplicableRules(ApprovalContext context) {
        return ruleEngine.getRulesByTypeAndLevel(
            context.getVisitType(),
            context.getApprovalLevel()
        );
    }

    private DecisionResult calculateFinalDecision(ApprovalDecision decision) {
        // è§„åˆ™è¯„ä¼°
        int passedRules = 0;
        int totalRules = decision.getRuleResults().size();

        for (RuleResult result : decision.getRuleResults().values()) {
            if (result.isPassed()) {
                passedRules++;
            }
        }

        // å®‰å…¨è¯„ä¼°
        SecurityPolicyCheck securityCheck = decision.getSecurityCheck();
        double ruleScore = (double) passedRules / totalRules;
        double securityScore = securityCheck.getScore();
        double totalScore = (ruleScore * 0.6) + (securityScore * 0.4);

        if (totalScore >= 0.8) {
            return DecisionResult.APPROVED;
        } else if (totalScore >= 0.6) {
            return DecisionResult.APPROVED_WITH_CONDITIONS;
        } else {
            return DecisionResult.REJECTED;
        }
    }
}
```

### 5. é€šè¡Œè¯ç”Ÿæˆé˜¶æ®µ

#### 5.1 ç”µå­é€šè¡Œè¯æœåŠ¡
```java
@Service
public class VisitorPassService {

    @Resource
    private QRCodeService qrCodeService;

    @Resource
    private PhotoService photoService;

    @Resource
    private AccessControlClient accessControlClient;

    /**
     * ç”Ÿæˆè®¿å®¢é€šè¡Œè¯
     */
    public VisitorPass generateVisitorPass(VisitorApplication application) {
        VisitorPass pass = new VisitorPass();

        try {
            // 1. ç”Ÿæˆé€šè¡Œè¯ç¼–å·
            String passNumber = generatePassNumber();
            pass.setPassNumber(passNumber);

            // 2. ç”ŸæˆäºŒç»´ç 
            QRCodeInfo qrInfo = QRCodeInfo.builder()
                .passNumber(passNumber)
                .visitorName(application.getVisitorName())
                .idCard(application.getIdCard())
                .validFrom(application.getStartTime())
                .validTo(application.getEndTime())
                .accessAreas(application.getAccessAreas())
                .build();

            String qrCode = qrCodeService.generate(qrInfo);
            pass.setQrCode(qrCode);

            // 3. å¤„ç†è®¿å®¢ç…§ç‰‡
            String photo = processVisitorPhoto(application.getPhotoUrl());
            pass.setPhotoUrl(photo);

            // 4. è®¾ç½®è®¿é—®æƒé™
            pass.setAccessAreas(application.getAccessAreas());
            pass.setValidPeriod(TimeRange.builder()
                .start(application.getStartTime())
                .end(application.getEndTime())
                .build());

            // 5. ç”Ÿæˆè®¿å®¢å‡­è¯
            byte[] credential = generateCredential(pass);
            pass.setCredential(credential);

            // 6. åŒæ­¥åˆ°é—¨ç¦ç³»ç»Ÿ
            syncToAccessControl(pass);

            // 7. å‘é€é€šè¡Œè¯ç»™è®¿å®¢
            sendPassToVisitor(pass, application);

        } catch (Exception e) {
            throw new RuntimeException("ç”Ÿæˆè®¿å®¢é€šè¡Œè¯å¤±è´¥", e);
        }

        return pass;
    }

    private String generatePassNumber() {
        // æ ¼å¼: VP + å¹´æœˆæ—¥ + 4ä½æµæ°´å·
        String dateStr = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String sequence = String.format("%04d", getNextSequence());
        return "VP" + dateStr + sequence;
    }

    private void syncToAccessControl(VisitorPass pass) {
        AccessControlRequest request = AccessControlRequest.builder()
            .credential(pass.getCredential())
            .qrCode(pass.getQrCode())
            .accessAreas(pass.getAccessAreas())
            .validFrom(pass.getValidPeriod().getStart())
            .validTo(pass.getValidPeriod().getEnd())
            .passType("VISITOR")
            .build();

        AccessControlResponse response = accessControlClient.grantAccess(request);

        if (!response.isSuccess()) {
            throw new RuntimeException("é—¨ç¦ç³»ç»ŸåŒæ­¥å¤±è´¥: " + response.getErrorMessage());
        }
    }

    private void sendPassToVisitor(VisitorPass pass, VisitorApplication application) {
        // å‘é€ç”µå­é€šè¡Œè¯åˆ°è®¿å®¢æ‰‹æœº
        String message = String.format(
            "æ‚¨çš„è®¿å®¢é€šè¡Œè¯å·²ç”Ÿæˆï¼Œé€šè¡Œè¯å·: %sï¼Œè®¿é—®æ—¶é—´: %s - %s",
            pass.getPassNumber(),
            pass.getValidPeriod().getStart().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm")),
            pass.getValidPeriod().getEnd().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"))
        );

        notificationService.sendSms(application.getPhone(), message);
        notificationService.sendEmail(application.getEmail(), "è®¿å®¢é€šè¡Œè¯", message, pass.getQrCode());
    }
}
```

### 6. ç°åœºæ¥å¾…é˜¶æ®µ

#### 6.1 è®¿å®¢æ¥å¾…æœåŠ¡
```java
@Service
public class VisitorReceptionService {

    @Resource
    private FaceRecognitionService faceRecognitionService;

    @Resource
    private VisitorCheckInDao checkInDao;

    /**
     * è®¿å®¢ç­¾åˆ°
     */
    public VisitorCheckInResult checkIn(VisitorCheckInRequest request) {
        VisitorCheckInResult result = new VisitorCheckInResult();

        try {
            // 1. éªŒè¯é€šè¡Œè¯
            VisitorPass pass = validateVisitorPass(request.getPassNumber());
            result.setPass(pass);

            // 2. èº«ä»½éªŒè¯
            IdentityVerificationResult identityResult = verifyIdentity(request, pass);
            result.setIdentityVerified(identityResult.isSuccess());

            if (!identityResult.isSuccess()) {
                result.setSuccess(false);
                result.setMessage("èº«ä»½éªŒè¯å¤±è´¥: " + identityResult.getMessage());
                return result;
            }

            // 3. ç­¾åˆ°ç™»è®°
            VisitorCheckIn checkIn = createCheckInRecord(request, pass);
            checkInDao.insert(checkIn);

            // 4. æ¿€æ´»è®¿é—®æƒé™
            activateAccessPermissions(pass);

            // 5. å‘æ”¾è®¿å®¢è¯ä»¶
            if (request.needPhysicalCard()) {
                String cardId = issuePhysicalCard(pass);
                result.setCardId(cardId);
            }

            // 6. é€šçŸ¥è¢«è®¿äºº
            notifyHostArrival(pass);

            result.setSuccess(true);
            result.setMessage("ç­¾åˆ°æˆåŠŸ");

        } catch (Exception e) {
            result.setSuccess(false);
            result.setMessage("ç­¾åˆ°å¤±è´¥: " + e.getMessage());
        }

        return result;
    }

    private IdentityVerificationResult verifyIdentity(VisitorCheckInRequest request, VisitorPass pass) {
        // å¤šé‡èº«ä»½éªŒè¯
        IdentityVerificationResult result = new IdentityVerificationResult();

        // 1. äººè„¸è¯†åˆ«éªŒè¯
        if (request.hasFaceImage()) {
            FaceRecognitionResult faceResult = faceRecognitionService.verify(
                request.getFaceImage(),
                pass.getPhotoUrl()
            );
            result.setFaceMatch(faceResult.isMatch());
            result.setFaceScore(faceResult.getScore());
        }

        // 2. äºŒç»´ç éªŒè¯
        QRCodeVerificationResult qrResult = qrCodeService.verify(request.getQrCode());
        result.setQrValid(qrResult.isValid());

        // 3. è¯ä»¶éªŒè¯
        if (request.hasIdCard()) {
            IdCardVerificationResult idResult = idCardService.verify(request.getIdCard());
            result.setIdCardValid(idResult.isValid());
        }

        // ç»¼åˆåˆ¤æ–­
        result.setSuccess(calculateIdentityScore(result) >= 0.8);
        return result;
    }

    private void activateAccessPermissions(VisitorPass pass) {
        // æ¿€æ´»é—¨ç¦æƒé™
        for (AccessArea area : pass.getAccessAreas()) {
            accessControlClient.activateAccess(
                pass.getCredential(),
                area.getAreaId(),
                pass.getValidPeriod()
            );
        }

        // è®°å½•æƒé™æ¿€æ´»æ—¥å¿—
        logAccessActivation(pass);
    }
}
```

---

## ğŸ“± ç§»åŠ¨ç«¯åº”ç”¨

### è®¿å®¢å°ç¨‹åºç•Œé¢
```vue
<template>
  <div class="visitor-appointment">
    <van-nav-bar
      title="è®¿å®¢é¢„çº¦"
      left-arrow
      @click-left="$router.go(-1)"
    />

    <!-- é¢„çº¦è¡¨å• -->
    <van-form @submit="submitAppointment">
      <van-cell-group title="è®¿å®¢ä¿¡æ¯">
        <van-field
          v-model="form.visitorName"
          label="å§“å"
          placeholder="è¯·è¾“å…¥çœŸå®å§“å"
          :rules="[{ required: true, message: 'è¯·è¾“å…¥å§“å' }]"
        />

        <van-field
          v-model="form.phone"
          label="æ‰‹æœºå·"
          type="tel"
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
          :rules="[
            { required: true, message: 'è¯·è¾“å…¥æ‰‹æœºå·' },
            { pattern: /^1[3-9]\d{9}$/, message: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·' }
          ]"
        />

        <van-field
          v-model="form.idCard"
          label="èº«ä»½è¯å·"
          placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"
          :rules="[
            { required: true, message: 'è¯·è¾“å…¥èº«ä»½è¯å·' },
            { pattern: /^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/, message: 'è¯·è¾“å…¥æ­£ç¡®çš„èº«ä»½è¯å·' }
          ]"
        />

        <van-field
          v-model="form.company"
          label="å…¬å¸åç§°"
          placeholder="è¯·è¾“å…¥å…¬å¸åç§°"
          :rules="[{ required: true, message: 'è¯·è¾“å…¥å…¬å¸åç§°' }]"
        />

        <van-field
          v-model="form.position"
          label="èŒä½"
          placeholder="è¯·è¾“å…¥èŒä½"
        />
      </van-cell-group>

      <van-cell-group title="è®¿é—®ä¿¡æ¯">
        <van-field
          v-model="form.hostName"
          label="è¢«è®¿äºº"
          placeholder="è¯·è¾“å…¥è¢«è®¿äººå§“å"
          :rules="[{ required: true, message: 'è¯·è¾“å…¥è¢«è®¿äººå§“å' }]"
          @click="showHostPicker = true"
          readonly
        />

        <van-field
          v-model="form.visitPurpose"
          label="è®¿é—®äº‹ç”±"
          placeholder="è¯·è¾“å…¥è®¿é—®äº‹ç”±"
          :rules="[{ required: true, message: 'è¯·è¾“å…¥è®¿é—®äº‹ç”±' }]"
        />

        <van-field
          label="è®¿é—®æ—¶é—´"
          :value="timeRangeText"
          placeholder="è¯·é€‰æ‹©è®¿é—®æ—¶é—´"
          :rules="[{ required: true, message: 'è¯·é€‰æ‹©è®¿é—®æ—¶é—´' }]"
          @click="showTimePicker = true"
          readonly
        />

        <van-field
          label="è®¿é—®åŒºåŸŸ"
          :value="selectedAreasText"
          placeholder="è¯·é€‰æ‹©è®¿é—®åŒºåŸŸ"
          :rules="[{ required: true, message: 'è¯·é€‰æ‹©è®¿é—®åŒºåŸŸ' }]"
          @click="showAreaPicker = true"
          readonly
        />
      </van-cell-group>

      <van-cell-group title="è¯ä»¶ä¸Šä¼ ">
        <van-uploader
          v-model="idCardImages"
          :after-read="handleIdCardUpload"
          :max-count="2"
          accept="image/*"
        >
          <template #preview-cover>
            <div class="preview-cover">
              <span>{{ file.name }}</span>
            </div>
          </template>
        </van-uploader>
      </van-cell-group>

      <!-- æäº¤æŒ‰é’® -->
      <div class="submit-section">
        <van-button
          type="primary"
          block
          native-type="submit"
          :loading="submitting"
        >
          æäº¤é¢„çº¦
        </van-button>
      </div>
    </van-form>

    <!-- è¢«è®¿äººé€‰æ‹©å™¨ -->
    <van-popup v-model="showHostPicker" position="bottom">
      <van-search
        v-model="hostSearchKeyword"
        placeholder="æœç´¢è¢«è®¿äºº"
        @search="searchHosts"
      />
      <van-picker
        show-toolbar
        :columns="hostColumns"
        @confirm="onHostConfirm"
        @cancel="showHostPicker = false"
      />
    </van-popup>

    <!-- æ—¶é—´é€‰æ‹©å™¨ -->
    <van-popup v-model="showTimePicker" position="bottom">
      <van-datetime-picker
        v-model="selectedStartTime"
        type="datetime"
        title="å¼€å§‹æ—¶é—´"
        @confirm="onStartTimeConfirm"
        @cancel="showTimePicker = false"
      />
    </van-popup>

    <!-- åŒºåŸŸé€‰æ‹©å™¨ -->
    <van-popup v-model="showAreaPicker" position="bottom">
      <van-checkbox-group v-model="selectedAreas">
        <van-cell-group>
          <van-cell
            v-for="area in areaList"
            :key="area.id"
            :title="area.name"
            clickable
            @click="toggleArea(area)"
          >
            <template #right-icon>
              <van-checkbox :name="area.id" />
            </template>
          </van-cell>
        </van-cell-group>
      </van-checkbox-group>
    </van-popup>
  </div>
</template>

<script>
export default {
  name: 'VisitorAppointment',

  data() {
    return {
      form: {
        visitorName: '',
        phone: '',
        idCard: '',
        company: '',
        position: '',
        hostName: '',
        hostId: '',
        visitPurpose: ''
      },
      selectedStartTime: null,
      selectedEndTime: null,
      selectedAreas: [],
      idCardImages: [],
      showHostPicker: false,
      showTimePicker: false,
      showAreaPicker: false,
      hostSearchKeyword: '',
      hostColumns: [],
      areaList: [],
      submitting: false
    }
  },

  computed: {
    timeRangeText() {
      if (this.selectedStartTime && this.selectedEndTime) {
        return `${this.$dayjs(this.selectedStartTime).format('YYYY-MM-DD HH:mm')} - ${this.$dayjs(this.selectedEndTime).format('HH:mm')}`;
      }
      return '';
    },

    selectedAreasText() {
      return this.selectedAreas.map(area => area.name).join(', ');
    }
  },

  async created() {
    await this.loadAreaList();
    await this.loadHostList();
  },

  methods: {
    async submitAppointment() {
      if (!this.validateForm()) {
        return;
      }

      this.submitting = true;

      try {
        const appointment = {
          visitorInfo: {
            name: this.form.visitorName,
            phone: this.form.phone,
            idCard: this.form.idCard,
            company: this.form.company,
            position: this.form.position
          },
          visitInfo: {
            hostId: this.form.hostId,
            hostName: this.form.hostName,
            purpose: this.form.visitPurpose,
            startTime: this.selectedStartTime,
            endTime: this.selectedEndTime,
            areas: this.selectedAreas
          },
          attachments: this.idCardImages
        };

        const response = await this.$http.post('/api/visitor/appointment', appointment);

        this.$toast.success('é¢„çº¦æäº¤æˆåŠŸ');
        this.$router.push('/visitor/status/' + response.data.appointmentId);

      } catch (error) {
        this.$toast.fail('æäº¤å¤±è´¥: ' + error.message);
      } finally {
        this.submitting = false;
      }
    },

    validateForm() {
      // è¡¨å•éªŒè¯é€»è¾‘
      return true;
    },

    async loadAreaList() {
      const response = await this.$http.get('/api/visitor/areas');
      this.areaList = response.data;
    },

    async loadHostList() {
      const response = await this.$http.get('/api/visitor/hosts');
      this.hostColumns = response.data.map(host => ({
        text: host.name,
        value: host.id
      }));
    }
  }
}
</script>
```

---

## ğŸ”§ ç³»ç»Ÿé›†æˆæ¶æ„

### ä¸å…¶ä»–ç³»ç»Ÿé›†æˆ
```mermaid
graph LR
    subgraph "è®¿å®¢ç®¡ç†ç³»ç»Ÿ"
        A[é¢„çº¦ç”³è¯·]
        B[å®¡æ‰¹æµç¨‹]
        C[é€šè¡Œè¯ç®¡ç†]
    end

    subgraph "OAå·¥ä½œæµç³»ç»Ÿ"
        D[å®¡æ‰¹å¼•æ“]
        E[è§„åˆ™å¼•æ“]
        F[é€šçŸ¥æœåŠ¡]
    end

    subgraph "é—¨ç¦æ§åˆ¶ç³»ç»Ÿ"
        G[æƒé™ç®¡ç†]
        H[è®¾å¤‡æ§åˆ¶]
        I[è®¿é—®è®°å½•]
    end

    subgraph "è§†é¢‘ç›‘æ§ç³»ç»Ÿ"
        J[äººè„¸è¯†åˆ«]
        K[è¡Œä¸ºåˆ†æ]
        L[å½•åƒå­˜å‚¨]
    end

    subgraph "æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ"
        M[çŸ­ä¿¡æœåŠ¡]
        N[é‚®ä»¶æœåŠ¡]
        O[å¾®ä¿¡é€šçŸ¥]
    end

    A --> D
    B --> E
    C --> G

    D --> F
    F --> M
    F --> N
    F --> O

    G --> H
    H --> I
    J --> K
    K --> L
```

### APIæ¥å£è®¾è®¡
```java
@RestController
@RequestMapping("/api/visitor")
public class VisitorController {

    @PostMapping("/appointment")
    public ResponseDTO<String> submitAppointment(@Valid @RequestBody VisitorAppointmentRequest request) {
        String appointmentId = visitorService.submitAppointment(request);
        return ResponseDTO.ok(appointmentId);
    }

    @GetMapping("/appointment/{id}/status")
    public ResponseDTO<AppointmentStatus> getAppointmentStatus(@PathVariable String id) {
        AppointmentStatus status = visitorService.getAppointmentStatus(id);
        return ResponseDTO.ok(status);
    }

    @PostMapping("/checkin")
    public ResponseDTO<VisitorCheckInResult> checkIn(@Valid @RequestBody VisitorCheckInRequest request) {
        VisitorCheckInResult result = visitorService.checkIn(request);
        return ResponseDTO.ok(result);
    }

    @PostMapping("/checkout")
    public ResponseDTO<Void> checkOut(@Valid @RequestBody VisitorCheckOutRequest request) {
        visitorService.checkOut(request);
        return ResponseDTO.ok();
    }

    @GetMapping("/pass/{passNumber}")
    public ResponseDTO<VisitorPass> getVisitorPass(@PathVariable String passNumber) {
        VisitorPass pass = visitorService.getVisitorPass(passNumber);
        return ResponseDTO.ok(pass);
    }

    @GetMapping("/statistics")
    public ResponseDTO<VisitorStatistics> getVisitorStatistics(
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime) {
        VisitorStatistics statistics = visitorService.getStatistics(startTime, endTime);
        return ResponseDTO.ok(statistics);
    }
}
```

---

## ğŸ“Š æ•°æ®åˆ†æå’Œç›‘æ§

### è®¿å®¢æ•°æ®ç»Ÿè®¡
```java
@Service
public class VisitorAnalyticsService {

    @Resource
    private VisitorDao visitorDao;

    @Resource
    private CheckInDao checkInDao;

    /**
     * ç”Ÿæˆè®¿å®¢ç»Ÿè®¡æŠ¥å‘Š
     */
    public VisitorStatisticsReport generateReport(LocalDateTime startTime, LocalDateTime endTime) {
        VisitorStatisticsReport report = new VisitorStatisticsReport();

        // 1. åŸºç¡€ç»Ÿè®¡æ•°æ®
        report.setTotalVisitors(visitorDao.countVisitors(startTime, endTime));
        report.setCompletedVisitors(visitorDao.countCompletedVisitors(startTime, endTime));
        report.setCancelledVisitors(visitorDao.countCancelledVisitors(startTime, endTime));

        // 2. è®¿å®¢ç±»å‹åˆ†å¸ƒ
        report.setVisitorTypeDistribution(visitorDao.getVisitorTypeDistribution(startTime, endTime));

        // 3. è®¿é—®ç›®çš„åˆ†å¸ƒ
        report.setPurposeDistribution(visitorDao.getPurposeDistribution(startTime, endTime));

        // 4. æ—¶é—´æ®µåˆ†å¸ƒ
        report.setTimeDistribution(checkInDao.getTimeDistribution(startTime, endTime));

        // 5. éƒ¨é—¨æ¥å¾…ç»Ÿè®¡
        report.setDepartmentStatistics(visitorDao.getDepartmentStatistics(startTime, endTime));

        // 6. æ»¡æ„åº¦ç»Ÿè®¡
        report.setSatisfactionStatistics(visitorDao.getSatisfactionStatistics(startTime, endTime));

        return report;
    }

    /**
     * å®æ—¶ç›‘æ§è®¿å®¢æµé‡
     */
    public VisitorFlowMonitor getRealTimeFlowMonitor() {
        VisitorFlowMonitor monitor = new VisitorFlowMonitor();

        LocalDateTime now = LocalDateTime.now();
        LocalDateTime todayStart = now.toLocalDate().atStartOfDay();

        monitor.setCurrentVisitors(checkInDao.getCurrentVisitors());
        monitor.setTodayVisitors(visitorDao.countVisitors(todayStart, now));
        monitor.setPeakTime(checkInDao.getPeakTime(todayStart, now));
        monitor.setAverageVisitDuration(checkInDao.getAverageVisitDuration(todayStart, now));

        return monitor;
    }
}
```

---

## ğŸ¯ æ€»ç»“

è®¿å®¢é¢„çº¦å®¡æ‰¹æµç¨‹é€šè¿‡æ•°å­—åŒ–ã€æ™ºèƒ½åŒ–çš„æ–¹å¼ï¼Œä¸ºå¤–éƒ¨è®¿å®¢æä¾›äº†ä¾¿æ·ã€å®‰å…¨ã€é«˜æ•ˆçš„è®¿é—®ä½“éªŒã€‚è¯¥æµç¨‹å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **å¤šæ¸ é“é¢„çº¦** - æ”¯æŒå®˜ç½‘ã€å°ç¨‹åºã€å†…éƒ¨é‚€è¯·ç­‰å¤šç§é¢„çº¦æ–¹å¼
2. **æ™ºèƒ½åˆå®¡** - è‡ªåŠ¨éªŒè¯è®¿å®¢èº«ä»½å’Œå®‰å…¨é£é™©
3. **åˆ†çº§å®¡æ‰¹** - æ ¹æ®è®¿å®¢ç±»å‹å’Œè®¿é—®å†…å®¹åˆ†é…ä¸åŒå®¡æ‰¹æµç¨‹
4. **ç”µå­é€šè¡Œè¯** - ç”ŸæˆäºŒç»´ç ç”µå­é€šè¡Œè¯ï¼Œæ”¯æŒç§»åŠ¨ç«¯å±•ç¤º
5. **å…¨ç¨‹ç›‘æ§** - ä»é¢„çº¦åˆ°ç¦»å›­çš„å…¨æµç¨‹ç›‘æ§å’Œè®°å½•
6. **æ•°æ®åˆ†æ** - ä¸°å¯Œçš„è®¿å®¢æ•°æ®ç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½

è¯¥æµç¨‹ä¸ä»…æå‡äº†è®¿å®¢æ¥å¾…æ•ˆç‡ï¼Œä¹ŸåŠ å¼ºäº†å›­åŒºå®‰å…¨ç®¡ç†ï¼Œä¸ºä¼ä¸šå½¢è±¡å’Œè®¿å®¢ä½“éªŒæä¾›äº†æœ‰åŠ›ä¿éšœã€‚

---

**æµç¨‹å›¾çŠ¶æ€**: âœ… å·²å®Œæˆ
**é€‚ç”¨ç‰ˆæœ¬**: IOE-DREAM v2.0.0+
**ç»´æŠ¤è´£ä»»äºº**: è®¿å®¢ç®¡ç†å›¢é˜Ÿ + OAå·¥ä½œæµå›¢é˜Ÿ
**æœ€åå®¡æ ¸**: 2025-12-16