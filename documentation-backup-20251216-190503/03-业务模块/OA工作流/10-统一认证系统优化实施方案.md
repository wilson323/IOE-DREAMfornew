# ç»Ÿä¸€è®¤è¯ç³»ç»Ÿä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

## æ–¹æ¡ˆæ¦‚è¿°

**æ–¹æ¡ˆåç§°**: IOE-DREAMç»Ÿä¸€è®¤è¯ç³»ç»Ÿä¼ä¸šçº§ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ
**åˆ¶å®šæ—¶é—´**: 2025-12-16
**ç‰ˆæœ¬**: v1.0
**ä¼˜å…ˆçº§**: P0çº§å®‰å…¨ä¼˜åŒ–
**å®æ–½å‘¨æœŸ**: 6å‘¨
**è´£ä»»å›¢é˜Ÿ**: æ¶æ„å§”å‘˜ä¼š + å®‰å…¨æŠ€æœ¯å›¢é˜Ÿ

---

## ğŸš¨ æ ¸å¿ƒé—®é¢˜è¯†åˆ«

### å½“å‰å®‰å…¨é£é™©è¯„ä¼° (B+ çº§åˆ«)

åŸºäºå…¨å±€æ·±åº¦åˆ†æç»“æœï¼Œå‘ç°ä»¥ä¸‹å…³é”®å®‰å…¨é—®é¢˜ï¼š

#### 1. é…ç½®å®‰å…¨é—®é¢˜ (P0çº§)
- **é—®é¢˜**: 64ä¸ªé…ç½®æ–‡ä»¶ä½¿ç”¨æ˜æ–‡å¯†ç 
- **é£é™©**: æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€ç¬¬ä¸‰æ–¹APIå¯†é’¥ã€æ”¯ä»˜å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯æš´éœ²
- **å½±å“**: å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€ç³»ç»Ÿè¢«æ”»å‡»ã€èµ„é‡‘æŸå¤±

#### 2. è®¤è¯æœåŠ¡å•ç‚¹æ•…éšœ (P0çº§)
- **é—®é¢˜**: è®¤è¯æœåŠ¡ç¼ºä¹é«˜å¯ç”¨éƒ¨ç½²
- **é£é™©**: è®¤è¯æœåŠ¡å®•æœºå¯¼è‡´å…¨ç½‘æ— æ³•è®¿é—®
- **å½±å“**: ä¸šåŠ¡å®Œå…¨ä¸­æ–­ï¼Œç”¨æˆ·ä½“éªŒä¸¥é‡å—å½±å“

#### 3. å¤šå› å­è®¤è¯ç¼ºå¤± (P1çº§)
- **é—®é¢˜**: ä»…æ”¯æŒç”¨æˆ·åå¯†ç è®¤è¯
- **é£é™©**: å¯†ç æ³„éœ²å¯¼è‡´è´¦æˆ·è¢«è½»æ˜“ç›—ç”¨
- **å½±å“**: æ•°æ®å®‰å…¨é£é™©ï¼Œä¸ç¬¦åˆä¼ä¸šçº§å®‰å…¨æ ‡å‡†

#### 4. ä¼šè¯ç®¡ç†ä¸è§„èŒƒ (P1çº§)
- **é—®é¢˜**: Tokenç®¡ç†æœºåˆ¶ä¸å®Œå–„ï¼Œç¼ºä¹ä¼šè¯çŠ¶æ€è·Ÿè¸ª
- **é£é™©**: Tokenè¢«åŠ«æŒã€ä¼šè¯å›ºå®šæ”»å‡»
- **å½±å“**: ç”¨æˆ·è´¦æˆ·å®‰å…¨é£é™©ï¼Œç³»ç»Ÿå®‰å…¨æ¼æ´

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡è®¾å®š

### å®‰å…¨ç­‰çº§ç›®æ ‡
- **å½“å‰ç­‰çº§**: B+ (76/100)
- **ç›®æ ‡ç­‰çº§**: A (92/100)
- **æå‡å¹…åº¦**: +21%

### æ€§èƒ½ç›®æ ‡
- **è®¤è¯å“åº”æ—¶é—´**: P95ä»500msé™è‡³100ms (80%æå‡)
- **å¹¶å‘è®¤è¯èƒ½åŠ›**: ä»1000æå‡è‡³10000 (900%æå‡)
- **ç³»ç»Ÿå¯ç”¨æ€§**: ä»99.5%æå‡è‡³99.99% (å…³é”®æœåŠ¡å¯ç”¨æ€§)

### åŠŸèƒ½ç›®æ ‡
- **å¤šå› å­è®¤è¯**: æ”¯æŒçŸ­ä¿¡ã€é‚®ç®±ã€ç”Ÿç‰©è¯†åˆ«ã€TOTP
- **å•ç‚¹ç™»å½•**: å®ç°å…¨ç½‘ç»Ÿä¸€è®¤è¯
- **ä¼šè¯ç®¡ç†**: å®Œå–„çš„ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **å®¡è®¡æ—¥å¿—**: 100%æ“ä½œå¯è¿½æº¯

---

## ğŸ“‹ è¯¦ç»†å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨åŠ å›º (ç¬¬1-2å‘¨) - P0çº§

#### 1.1 é…ç½®å®‰å…¨æ•´æ”¹ (ç¬¬1å‘¨)
**è´£ä»»äºº**: å®‰å…¨æŠ€æœ¯å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P0çº§

**ä»»åŠ¡æ¸…å•**:
- [x] æ‰«ææ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„æ˜æ–‡å¯†ç  (64ä¸ª)
- [ ] å®æ–½Nacosé…ç½®ä¸­å¿ƒåŠ å¯†
- [ ] æ›¿æ¢æ‰€æœ‰æ˜æ–‡å¯†ç ä¸ºåŠ å¯†é…ç½®
- [ ] é…ç½®æ–‡ä»¶è®¿é—®æƒé™åŠ å›º
- [ ] æ•æ„Ÿé…ç½®ç¯å¢ƒå˜é‡åŒ–

**æŠ€æœ¯æ–¹æ¡ˆ**:
```yaml
# åŠ å¯†é…ç½®ç¤ºä¾‹
spring:
  datasource:
    password: "ENC(AES256:encrypted_password_hash)"
    druid:
      connection-properties: "config.decrypt=true;config.decrypt.key=${nacos.config.key}"

# NacosåŠ å¯†é…ç½®
nacos:
  config:
    encrypt-key: "${NACOS_ENCRYPT_KEY}"
    data-id: "auth-service-encrypted-config.yml"
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… 0ä¸ªæ˜æ–‡å¯†ç é…ç½®
- âœ… 100%æ•æ„Ÿé…ç½®åŠ å¯†
- âœ… é…ç½®æ–‡ä»¶æƒé™600
- âœ… é€šè¿‡å®‰å…¨æ‰«ææ£€æµ‹

#### 1.2 è®¤è¯æœåŠ¡é«˜å¯ç”¨ (ç¬¬2å‘¨)
**è´£ä»»äºº**: åŸºç¡€è®¾æ–½å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P0çº§

**ä»»åŠ¡æ¸…å•**:
- [ ] è®¤è¯æœåŠ¡é›†ç¾¤éƒ¨ç½² (3èŠ‚ç‚¹)
- [ ] Redisé›†ç¾¤éƒ¨ç½² (1ä¸»2ä»)
- [ ] MySQLä¸»ä»å¤åˆ¶é…ç½®
- [ ] è´Ÿè½½å‡è¡¡é…ç½® (Nginx/HAProxy)
- [ ] å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»

**éƒ¨ç½²æ¶æ„**:
```yaml
# Kuberneteséƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: ioedream/auth-service:1.0.0
        ports:
        - containerPort: 8088
        resources:
          limits:
            cpu: 2000m
            memory: 4Gi
          requests:
            cpu: 1000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8088
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8088
          initialDelaySeconds: 30
          periodSeconds: 10
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… 3èŠ‚ç‚¹è®¤è¯æœåŠ¡é›†ç¾¤
- âœ… Redisé›†ç¾¤é«˜å¯ç”¨
- âœ… æ•°æ®åº“ä¸»ä»åŒæ­¥
- âœ… æ•…éšœåˆ‡æ¢æ—¶é—´<30ç§’

### ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å¢å¼º (ç¬¬3-4å‘¨) - P1çº§

#### 2.1 å¤šå› å­è®¤è¯å®ç° (ç¬¬3å‘¨)
**è´£ä»»äºº**: è®¤è¯æœåŠ¡å¼€å‘å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P1çº§

**ä»»åŠ¡æ¸…å•**:
- [ ] MFAæ¡†æ¶é›†æˆ (Google Authenticator)
- [ ] çŸ­ä¿¡éªŒè¯ç æœåŠ¡é›†æˆ
- [ ] é‚®ç®±éªŒè¯ç æœåŠ¡é›†æˆ
- [ ] ç”Ÿç‰©è¯†åˆ«è®¤è¯é›†æˆ
- [ ] MFAé…ç½®ç®¡ç†ç•Œé¢

**æ ¸å¿ƒä»£ç å®ç°**:
```java
@Service
public class MfaService {

    @Resource
    private GoogleAuthenticator googleAuthenticator;

    @Resource
    private SmsService smsService;

    @Resource
    private EmailService emailService;

    /**
     * ç”ŸæˆMFAå¯†é’¥å’ŒäºŒç»´ç 
     */
    public MfaSetupDTO generateMfaSetup(Long userId) {
        String secret = googleAuthenticator.createSecret();
        String qrCodeUrl = googleAuthenticator.generateQRUrl(
            "IOE-DREAM:" + getUserEmail(userId), secret);

        // ä¿å­˜å¯†é’¥åˆ°æ•°æ®åº“
        saveMfaSecret(userId, secret);

        return MfaSetupDTO.builder()
            .secret(secret)
            .qrCodeUrl(qrCodeUrl)
            .backupCodes(generateBackupCodes())
            .build();
    }

    /**
     * éªŒè¯MFAä»£ç 
     */
    public boolean verifyMfaCode(Long userId, String code) {
        String secret = getMfaSecret(userId);
        return googleAuthenticator.authorize(secret, code);
    }

    /**
     * å‘é€çŸ­ä¿¡éªŒè¯ç 
     */
    public void sendSmsCode(String phone, String code) {
        SmsRequest request = SmsRequest.builder()
            .phone(phone)
            .template("SMS_VERIFY_CODE")
            .params(Map.of("code", code))
            .build();

        smsService.sendSms(request);
        // è®°å½•å‘é€æ—¥å¿—
        log.info("MFAçŸ­ä¿¡éªŒè¯ç å·²å‘é€: {}", maskPhone(phone));
    }
}

@RestController
@RequestMapping("/api/v1/auth/mfa")
public class MfaController {

    @PostMapping("/setup")
    public ResponseDTO<MfaSetupDTO> setupMfa() {
        Long userId = getCurrentUserId();
        MfaSetupDTO result = mfaService.generateMfaSetup(userId);
        return ResponseDTO.ok(result);
    }

    @PostMapping("/verify")
    public ResponseDTO<Void> verifyMfa(@Valid @RequestBody MfaVerifyForm form) {
        Long userId = getCurrentUserId();
        boolean valid = mfaService.verifyMfaCode(userId, form.getCode());

        if (!valid) {
            throw new BusinessException("MFA_CODE_INVALID", "éªŒè¯ç é”™è¯¯");
        }

        return ResponseDTO.ok();
    }

    @PostMapping("/sms/send")
    public ResponseDTO<Void> sendSmsCode(@Valid @RequestBody SmsSendForm form) {
        String code = generateSmsCode();
        mfaService.sendSmsCode(form.getPhone(), code);
        // ç¼“å­˜éªŒè¯ç ï¼Œæœ‰æ•ˆæœŸ5åˆ†é’Ÿ
        cacheSmsCode(form.getPhone(), code, Duration.ofMinutes(5));
        return ResponseDTO.ok();
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒGoogle Authenticator
- âœ… æ”¯æŒçŸ­ä¿¡éªŒè¯ç 
- âœ… æ”¯æŒé‚®ç®±éªŒè¯ç 
- âœ… æ”¯æŒç”Ÿç‰©è¯†åˆ«
- âœ… MFAé…ç½®ç•Œé¢å®Œæ•´

#### 2.2 ä¼šè¯ç®¡ç†ä¼˜åŒ– (ç¬¬4å‘¨)
**è´£ä»»äºº**: è®¤è¯æœåŠ¡å¼€å‘å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P1çº§

**ä»»åŠ¡æ¸…å•**:
- [ ] JWT Tokenä¼˜åŒ– (å¢åŠ ç”¨æˆ·ä¿¡æ¯)
- [ ] Redisä¼šè¯çŠ¶æ€ç®¡ç†
- [ ] ä¼šè¯è¶…æ—¶ç­–ç•¥å®ç°
- [ ] å¹¶å‘ä¼šè¯æ§åˆ¶
- [ ] å¼‚å¸¸ä¼šè¯æ£€æµ‹

**ä¼šè¯ç®¡ç†æ ¸å¿ƒå®ç°**:
```java
@Service
public class SessionService {

    @Resource
    private RedisTemplate<String, Object> redisTemplate;

    @Resource
    private UserDeviceService userDeviceService;

    /**
     * åˆ›å»ºç”¨æˆ·ä¼šè¯
     */
    public UserSessionDTO createUserSession(Long userId, LoginDeviceInfo deviceInfo) {
        String sessionId = UUID.randomUUID().toString();
        String token = generateJwtToken(userId, sessionId);

        // ä¼šè¯ä¿¡æ¯
        UserSession session = UserSession.builder()
            .sessionId(sessionId)
            .userId(userId)
            .deviceFingerprint(deviceInfo.getFingerprint())
            .ipAddress(deviceInfo.getIpAddress())
            .userAgent(deviceInfo.getUserAgent())
            .createTime(LocalDateTime.now())
            .lastAccessTime(LocalDateTime.now())
            .expireTime(LocalDateTime.now().plusHours(8))
            .status(SessionStatus.ACTIVE)
            .build();

        // ä¿å­˜ä¼šè¯åˆ°Redis
        redisTemplate.opsForValue().set(
            "session:" + sessionId,
            session,
            Duration.ofHours(8)
        );

        // æ›´æ–°ç”¨æˆ·è®¾å¤‡ä¿¡æ¯
        userDeviceService.updateUserDevice(userId, deviceInfo);

        // å¹¶å‘ä¼šè¯æ§åˆ¶
        checkConcurrentSessions(userId, sessionId);

        return UserSessionDTO.builder()
            .sessionId(sessionId)
            .token(token)
            .expireTime(session.getExpireTime())
            .build();
    }

    /**
     * éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
     */
    public boolean validateSession(String sessionId, HttpServletRequest request) {
        UserSession session = (UserSession) redisTemplate
            .opsForValue().get("session:" + sessionId);

        if (session == null || session.getStatus() != SessionStatus.ACTIVE) {
            return false;
        }

        // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
        if (LocalDateTime.now().isAfter(session.getExpireTime())) {
            invalidateSession(sessionId);
            return false;
        }

        // å¼‚å¸¸æ£€æµ‹
        if (detectAnomalousAccess(session, request)) {
            handleAnomalousAccess(session);
            return false;
        }

        // æ›´æ–°æœ€åè®¿é—®æ—¶é—´
        session.setLastAccessTime(LocalDateTime.now());
        redisTemplate.opsForValue().set(
            "session:" + sessionId,
            session,
            Duration.ofHours(8)
        );

        return true;
    }

    /**
     * å¹¶å‘ä¼šè¯æ§åˆ¶
     */
    private void checkConcurrentSessions(Long userId, String newSessionId) {
        String pattern = "session:*";
        Set<String> sessionKeys = redisTemplate.keys(pattern);

        List<UserSession> userSessions = sessionKeys.stream()
            .map(key -> (UserSession) redisTemplate.opsForValue().get(key))
            .filter(session -> session != null && session.getUserId().equals(userId))
            .filter(session -> session.getStatus() == SessionStatus.ACTIVE)
            .sorted(Comparator.comparing(UserSession::getCreateTime).reversed())
            .collect(Collectors.toList());

        // æœ€å¤šå…è®¸3ä¸ªå¹¶å‘ä¼šè¯
        if (userSessions.size() >= 3) {
            // è¸¢å‡ºæœ€æ—§çš„ä¼šè¯
            UserSession oldestSession = userSessions.get(userSessions.size() - 1);
            invalidateSession(oldestSession.getSessionId());

            // å‘é€é€šçŸ¥
            sendSessionKickoutNotification(oldestSession.getUserId());
        }
    }

    /**
     * å¼‚å¸¸è®¿é—®æ£€æµ‹
     */
    private boolean detectAnomalousAccess(UserSession session, HttpServletRequest request) {
        String currentIp = getClientIpAddress(request);
        String currentUserAgent = request.getHeader("User-Agent");

        // IPåœ°å€å˜æ›´æ£€æµ‹
        if (!currentIp.equals(session.getIpAddress())) {
            log.warn("æ£€æµ‹åˆ°ä¼šè¯IPåœ°å€å˜æ›´: sessionId={}, oldIp={}, newIp={}",
                session.getSessionId(), session.getIpAddress(), currentIp);
            return true;
        }

        // è®¾å¤‡æŒ‡çº¹å˜æ›´æ£€æµ‹
        String currentFingerprint = generateDeviceFingerprint(request);
        if (!currentFingerprint.equals(session.getDeviceFingerprint())) {
            log.warn("æ£€æµ‹åˆ°ä¼šè¯è®¾å¤‡æŒ‡çº¹å˜æ›´: sessionId={}", session.getSessionId());
            return true;
        }

        return false;
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… JWT TokenåŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯
- âœ… Redisä¼šè¯çŠ¶æ€ç®¡ç†
- âœ… ä¼šè¯è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆ
- âœ… å¹¶å‘ä¼šè¯â‰¤3ä¸ª
- âœ… å¼‚å¸¸è®¿é—®æ£€æµ‹å‘Šè­¦

### ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ– (ç¬¬5å‘¨) - P1çº§

#### 3.1 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
**è´£ä»»äºº**: æ€§èƒ½ä¼˜åŒ–å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P1çº§

**ä»»åŠ¡æ¸…å•**:
- [ ] å¤šçº§ç¼“å­˜æ¶æ„å®ç°
- [ ] ç¼“å­˜é¢„çƒ­ç­–ç•¥
- [ ] ç¼“å­˜å‡»ç©¿é˜²æŠ¤
- [ ] ç¼“å­˜é›ªå´©é˜²æŠ¤
- [ ] ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

**ç¼“å­˜æ¶æ„å®ç°**:
```java
@Configuration
@EnableCaching
public class CacheConfiguration {

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        // L1: Caffeineæœ¬åœ°ç¼“å­˜
        CaffeineCacheManager localCacheManager = new CaffeineCacheManager();
        localCacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .recordStats());

        // L2: Redisåˆ†å¸ƒå¼ç¼“å­˜
        RedisCacheManager redisCacheManager = RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30))
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                    .fromSerializer(new GenericJackson2JsonRedisSerializer())));

        // ç»„åˆç¼“å­˜ç®¡ç†å™¨
        return new CompositeCacheManager(localCacheManager, redisCacheManager);
    }
}

@Service
public class UserService {

    @Cacheable(value = "user", key = "#userId", unless = "#result == null")
    public UserEntity getUserById(Long userId) {
        return userDao.selectById(userId);
    }

    @CacheEvict(value = "user", key = "#user.id")
    public void updateUser(UserEntity user) {
        userDao.updateById(user);
    }

    /**
     * ç¼“å­˜é¢„çƒ­
     */
    @PostConstruct
    public void warmUpCache() {
        // é¢„åŠ è½½çƒ­ç‚¹ç”¨æˆ·æ•°æ®
        List<Long> hotUserIds = getHotUserIds();
        hotUserIds.forEach(userId -> {
            UserEntity user = userDao.selectById(userId);
            if (user != null) {
                cacheManager.getCache("user").put(userId, user);
            }
        });
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… L1+L2å¤šçº§ç¼“å­˜
- âœ… ç¼“å­˜å‘½ä¸­ç‡â‰¥90%
- âœ… ç¼“å­˜é¢„çƒ­æœºåˆ¶
- âœ… ç¼“å­˜é˜²æŠ¤æœºåˆ¶å®Œå–„

#### 3.2 æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
**è´£ä»»äºº**: æ•°æ®åº“ä¼˜åŒ–å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P1çº§

**ä»»åŠ¡æ¸…å•**:
- [ ] æ ¸å¿ƒè¡¨ç´¢å¼•ä¼˜åŒ–
- [ ] æ…¢æŸ¥è¯¢SQLä¼˜åŒ–
- [ ] è¿æ¥æ± å‚æ•°è°ƒä¼˜
- [ ] è¯»å†™åˆ†ç¦»é…ç½®
- [ ] æ•°æ®åº“ç›‘æ§é…ç½®

**ç´¢å¼•ä¼˜åŒ–è„šæœ¬**:
```sql
-- ç”¨æˆ·è®¤è¯ç›¸å…³ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_username_status ON t_user(username, status, deleted_flag);
CREATE INDEX idx_user_phone_status ON t_user(phone, status, deleted_flag);
CREATE INDEX idx_user_email_status ON t_user(email, status, deleted_flag);
CREATE INDEX idx_user_dept_status_time ON t_user(department_id, status, create_time);

-- ä¼šè¯ç®¡ç†ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_session_user_status ON t_user_session(user_id, status, expire_time);
CREATE INDEX idx_user_session_device ON t_user_session(device_fingerprint, create_time);
CREATE INDEX idx_user_session_ip ON t_user_session(ip_address, create_time);

-- æƒé™ç®¡ç†ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_role_user ON t_user_role(user_id, create_time);
CREATE INDEX idx_role_permission_role ON t_role_permission(role_id, create_time);
CREATE INDEX idx_user_permission_user ON t_user_permission(user_id, resource_type, create_time);

-- å®¡è®¡æ—¥å¿—ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_auth_log_user_time ON t_auth_log(user_id, create_time);
CREATE INDEX idx_auth_log_type_status ON t_auth_log(log_type, status, create_time);
CREATE INDEX idx_auth_log_ip ON t_auth_log(ip_address, create_time);

-- åˆ†ææ…¢æŸ¥è¯¢
EXPLAIN SELECT * FROM t_user WHERE username = ? AND status = 1 AND deleted_flag = 0;
EXPLAIN SELECT * FROM t_user_session WHERE user_id = ? AND status = 1 AND expire_time > NOW();
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ ¸å¿ƒæŸ¥è¯¢å“åº”æ—¶é—´<50ms
- âœ… æ…¢æŸ¥è¯¢æ•°é‡ä¸º0
- âœ… è¿æ¥æ± åˆ©ç”¨ç‡â‰¥80%
- âœ… æ•°æ®åº“ç›‘æ§å®Œå–„

### ç¬¬å››é˜¶æ®µï¼šç›‘æ§å‘Šè­¦ (ç¬¬6å‘¨) - P2çº§

#### 4.1 ç›‘æ§ä½“ç³»å»ºè®¾
**è´£ä»»äºº**: è¿ç»´ç›‘æ§å›¢é˜Ÿ
**ä¼˜å…ˆçº§**: P2çº§

**ä»»åŠ¡æ¸…å•**:
- [ ] PrometheusæŒ‡æ ‡æ”¶é›†
- [ ] Grafanaä»ªè¡¨æ¿é…ç½®
- [ ] å‘Šè­¦è§„åˆ™é…ç½®
- [ ] æ—¥å¿—æ”¶é›†åˆ†æ
- [ ] æ€§èƒ½åŸºçº¿å»ºç«‹

**ç›‘æ§æŒ‡æ ‡å®šä¹‰**:
```yaml
# PrometheusæŒ‡æ ‡é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
        auth.processing.time: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
        auth.processing.time: 0.5,0.9,0.95,0.99
    tags:
      application: ioedream-auth-service
      environment: ${spring.profiles.active}

# è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
@Component
public class AuthMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter authSuccessCounter;
    private final Counter authFailureCounter;
    private final Timer authProcessingTimer;

    public AuthMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.authSuccessCounter = Counter.builder("auth.success.total")
            .description("Successful authentication count")
            .register(meterRegistry);
        this.authFailureCounter = Counter.builder("auth.failure.total")
            .description("Failed authentication count")
            .register(meterRegistry);
        this.authProcessingTimer = Timer.builder("auth.processing.time")
            .description("Authentication processing time")
            .register(meterRegistry);
    }

    public void recordAuthSuccess() {
        authSuccessCounter.increment();
    }

    public void recordAuthFailure(String reason) {
        authFailureCounter.increment(Tags.of("reason", reason));
    }

    public Timer.Sample startAuthProcessingTimer() {
        return Timer.start(meterRegistry);
    }
}
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç›‘æ§æŒ‡æ ‡è¦†ç›–ç‡100%
- âœ… å‘Šè­¦è§„åˆ™é…ç½®å®Œæ•´
- âœ… Grafanaä»ªè¡¨æ¿å®Œå–„
- âœ… æ—¥å¿—åˆ†æç³»ç»Ÿå¯ç”¨

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 1. å®‰å…¨æµ‹è¯•

#### å¯†ç å®‰å…¨æµ‹è¯•
```bash
# å¯†ç å¼ºåº¦æµ‹è¯•
test_password_strength.py --min-length 8 --require-uppercase --require-lowercase --require-numbers --require-special

# å¯†ç åŠ å¯†æµ‹è¯•
test_password_encryption.py --algorithm bcrypt --check-salt --verify-encryption

# æš´åŠ›ç ´è§£é˜²æŠ¤æµ‹è¯•
test_brute_force_protection.py --max-attempts 5 --lockout-duration 1800 --ip-blocking
```

#### MFAåŠŸèƒ½æµ‹è¯•
```bash
# Google Authenticatoræµ‹è¯•
test_mfa_totp.py --secret-user test_user --time-window 30 --code-length 6

# çŸ­ä¿¡éªŒè¯ç æµ‹è¯•
test_mfa_sms.py --phone 13800138000 --code-length 6 --expire-time 300

# é‚®ç®±éªŒè¯ç æµ‹è¯•
test_mfa_email.py --email test@example.com --template mfa_verify --expire-time 600
```

### 2. æ€§èƒ½æµ‹è¯•

#### è®¤è¯æ€§èƒ½å‹æµ‹
```bash
# JMeterå‹æµ‹è„šæœ¬
jmeter -n -t auth_performance_test.jmx -l results.jtl -Jthreads=1000 -Jrampup=60 -Jduration=300

# å¹¶å‘è®¤è¯æµ‹è¯•
test_concurrent_auth.py --concurrent-users 10000 --duration 300 --target-rps 1000

# TokenéªŒè¯æ€§èƒ½æµ‹è¯•
test_token_validation.py --token-count 100000 --validation-rate 5000
```

#### ç¼“å­˜æ€§èƒ½æµ‹è¯•
```bash
# ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
test_cache_hit_rate.py --cache-type redis --operations 100000 --expected-hit-rate 0.9

# ç¼“å­˜å¹¶å‘æµ‹è¯•
test_cache_concurrency.py --concurrent-threads 100 --operations-per-thread 1000
```

### 3. é«˜å¯ç”¨æµ‹è¯•

#### æ•…éšœåˆ‡æ¢æµ‹è¯•
```bash
# è®¤è¯æœåŠ¡æ•…éšœåˆ‡æ¢
test_auth_failover.py --kill-node auth-service-1 --expected-downtime 30 --auto-recovery true

# Redisæ•…éšœåˆ‡æ¢
test_redis_failover.py --promote-slave redis-slave-1 --expected-downtime 10

# æ•°æ®åº“æ•…éšœåˆ‡æ¢
test_db_failover.py --promote-slave mysql-slave-1 --expected-downtime 60
```

### 4. é›†æˆæµ‹è¯•

#### å•ç‚¹ç™»å½•æµ‹è¯•
```bash
# SSOç™»å½•æµç¨‹æµ‹è¯•
test_sso_flow.py --systems access,attendance,consume --user test_user --expected-single-login true

# è·¨ç³»ç»ŸTokenéªŒè¯æµ‹è¯•
test_cross_system_token.py --token "jwt_token" --systems access,attendance --expected-valid true
```

---

## ğŸ“Š é£é™©è¯„ä¼°ä¸åº”å¯¹

### 1. æŠ€æœ¯é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | åº”å¯¹æªæ–½ | è´£ä»»äºº |
|--------|----------|----------|----------|--------|
| é…ç½®åŠ å¯†å…¼å®¹æ€§ | ä¸­ | è®¤è¯æœåŠ¡å¯åŠ¨ | å……åˆ†æµ‹è¯•ï¼Œå‡†å¤‡å›æ»šæ–¹æ¡ˆ | å®‰å…¨å›¢é˜Ÿ |
| MFAé›†æˆå¤æ‚åº¦ | é«˜ | è®¤è¯åŠŸèƒ½ | åˆ†é˜¶æ®µå®æ–½ï¼Œå…ˆåŸºç¡€åé«˜çº§ | å¼€å‘å›¢é˜Ÿ |
| æ€§èƒ½ä¼˜åŒ–å›é€€ | ä¸­ | ç³»ç»Ÿæ€§èƒ½ | åŸºå‡†æµ‹è¯•ï¼Œç°åº¦å‘å¸ƒ | æ€§èƒ½å›¢é˜Ÿ |
| é«˜å¯ç”¨åˆ‡æ¢å¤±è´¥ | é«˜ | ç³»ç»Ÿå¯ç”¨æ€§ | è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæ‰‹åŠ¨æ¼”ç»ƒ | è¿ç»´å›¢é˜Ÿ |

### 2. ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | é£é™©ç­‰çº§ | å½±å“èŒƒå›´ | åº”å¯¹æªæ–½ | è´£ä»»äºº |
|--------|----------|----------|----------|--------|
| ç”¨æˆ·ä½“éªŒå½±å“ | ä¸­ | ç™»å½•ä½“éªŒ | å……åˆ†åŸ¹è®­ï¼Œæ“ä½œæŒ‡å— | äº§å“å›¢é˜Ÿ |
| å…¼å®¹æ€§é—®é¢˜ | ä½ | ç¬¬ä¸‰æ–¹ç³»ç»Ÿ | æ¥å£é€‚é…ï¼Œç‰ˆæœ¬ç®¡ç† | é›†æˆå›¢é˜Ÿ |
| è¿ç§»æ•°æ®ä¸¢å¤± | é«˜ | ç”¨æˆ·æ•°æ® | å¤‡ä»½éªŒè¯ï¼Œåˆ†æ‰¹è¿ç§» | æ•°æ®å›¢é˜Ÿ |

### 3. åº”æ€¥é¢„æ¡ˆ

#### è®¤è¯æœåŠ¡æ•…éšœåº”æ€¥é¢„æ¡ˆ
```bash
#!/bin/bash
# auth_service_emergency.sh

echo "è®¤è¯æœåŠ¡æ•…éšœåº”æ€¥é¢„æ¡ˆå¯åŠ¨..."

# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get pods -n ioedream | grep auth-service

# 2. å¿«é€Ÿå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/auth-service -n ioedream

# 3. æ‰©å®¹æœåŠ¡å®ä¾‹
kubectl scale deployment auth-service --replicas=5 -n ioedream

# 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥
kubectl exec -it $(kubectl get pods -n ioedream | grep auth-service | head -1 | awk '{print $1}') -- nc -zv mysql-cluster-master 3306

# 5. æ£€æŸ¥Redisè¿æ¥
kubectl exec -it $(kubectl get pods -n ioedream | grep auth-service | head -1 | awk '{print $1}') -- nc -zv redis-master 6379

echo "åº”æ€¥é¢„æ¡ˆæ‰§è¡Œå®Œæˆ"
```

---

## ğŸ“ˆ æ•ˆç›Šè¯„ä¼°

### 1. å®‰å…¨æ•ˆç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| å®‰å…¨ç­‰çº§è¯„åˆ† | 76/100 (B+) | 92/100 (A) | +21% |
| æ˜æ–‡é…ç½®æ•°é‡ | 64ä¸ª | 0ä¸ª | -100% |
| å¤šå› å­è®¤è¯è¦†ç›– | 0% | 100% | +100% |
| ä¼šè¯å®‰å…¨ç­‰çº§ | C | A | æ˜¾è‘—æå‡ |

### 2. æ€§èƒ½æ•ˆç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| è®¤è¯å“åº”æ—¶é—´(P95) | 500ms | 100ms | -80% |
| å¹¶å‘è®¤è¯èƒ½åŠ› | 1000 TPS | 10000 TPS | +900% |
| ç¼“å­˜å‘½ä¸­ç‡ | 65% | 90% | +38% |
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.5% | 99.99% | å…³é”®æå‡ |

### 3. è¿ç»´æ•ˆç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| æ•…éšœæ¢å¤æ—¶é—´ | 30åˆ†é’Ÿ | 5åˆ†é’Ÿ | -83% |
| ç›‘æ§è¦†ç›–ç‡ | 60% | 100% | +67% |
| è‡ªåŠ¨åŒ–è¿ç»´ç¨‹åº¦ | 40% | 85% | +113% |
| è¿ç»´äººåŠ›æˆæœ¬ | 100% | 60% | -40% |

### 4. ä¸šåŠ¡æ•ˆç›Š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| ç”¨æˆ·ä½“éªŒè¯„åˆ† | 3.5/5 | 4.8/5 | +37% |
| å•æ¬¡ç™»å½•æ—¶é—´ | 8ç§’ | 2ç§’ | -75% |
| è·¨ç³»ç»Ÿåˆ‡æ¢ | 5ç§’ | 1ç§’ | -80% |
| å®‰å…¨äº‹ä»¶æ•° | æœˆå‡5æ¬¡ | æœˆå‡0æ¬¡ | -100% |

---

## ğŸ“ å®æ–½æ”¯æŒ

### å›¢é˜Ÿç»„ç»‡

**é¡¹ç›®æŒ‡å¯¼å§”å‘˜ä¼š**:
- é¦–å¸­æ¶æ„å¸ˆ (æŠ€æœ¯æ€»è´Ÿè´£)
- å®‰å…¨æ€»ç›‘ (å®‰å…¨åˆè§„è´Ÿè´£)
- è¿ç»´æ€»ç›‘ (åŸºç¡€è®¾æ–½è´Ÿè´£)

**æ ¸å¿ƒå®æ–½å›¢é˜Ÿ**:
- å®‰å…¨æŠ€æœ¯å›¢é˜Ÿ (4äºº) - é…ç½®å®‰å…¨ã€MFAå®æ–½
- è®¤è¯æœåŠ¡å¼€å‘å›¢é˜Ÿ (6äºº) - åŠŸèƒ½å¼€å‘ã€æ€§èƒ½ä¼˜åŒ–
- åŸºç¡€è®¾æ–½å›¢é˜Ÿ (4äºº) - é«˜å¯ç”¨éƒ¨ç½²ã€ç›‘æ§
- æµ‹è¯•éªŒè¯å›¢é˜Ÿ (3äºº) - åŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½å‹æµ‹
- è¿ç»´æ”¯æŒå›¢é˜Ÿ (2äºº) - ç”Ÿäº§éƒ¨ç½²ã€åº”æ€¥å“åº”

### æ²Ÿé€šæœºåˆ¶

**æ¯æ—¥ç«™ä¼š** (9:00-9:30):
- è¿›åº¦åŒæ­¥
- é£é™©è¯†åˆ«
- é—®é¢˜è§£å†³

**å‘¨ä¾‹ä¼š** (å‘¨äº”16:00-17:00):
- å‘¨è¿›åº¦å›é¡¾
- ä¸‹å‘¨è®¡åˆ’åˆ¶å®š
- è·¨å›¢é˜Ÿåè°ƒ

**é‡Œç¨‹ç¢‘è¯„å®¡** (æ¯ä¸¤å‘¨):
- é˜¶æ®µæ€§æˆæœéªŒæ”¶
- è´¨é‡è¯„ä¼°
- é£é™©è¯„ä¼°æ›´æ–°

### è´¨é‡ä¿éšœ

**ä»£ç è´¨é‡æ ‡å‡†**:
- ä»£ç è¦†ç›–ç‡ â‰¥ 80%
- æ ¸å¿ƒå®‰å…¨æ¨¡å—è¦†ç›–ç‡ = 100%
- é™æ€ä»£ç æ‰«æé€šè¿‡
- å®‰å…¨æ¼æ´æ‰«æé€šè¿‡

**æµ‹è¯•æ ‡å‡†**:
- å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%
- é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- æ€§èƒ½æµ‹è¯•è¾¾æ ‡ç‡ 100%
- å®‰å…¨æµ‹è¯•é€šè¿‡ç‡ 100%

---

## ğŸ”„ åç»­ä¼˜åŒ–è®¡åˆ’

### çŸ­æœŸä¼˜åŒ– (3-6ä¸ªæœˆ)
- **ç”Ÿç‰©è¯†åˆ«å¢å¼º**: äººè„¸è¯†åˆ«æ´»ä½“æ£€æµ‹
- **æ™ºèƒ½é£æ§**: åŸºäºAIçš„å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
- **æƒé™ä¼˜åŒ–**: ç»†ç²’åº¦æ•°æ®æƒé™æ§åˆ¶
- **æ€§èƒ½ç›‘æ§**: å®æ—¶æ€§èƒ½å¤§å±å±•ç¤º

### ä¸­æœŸä¼˜åŒ– (6-12ä¸ªæœˆ)
- **è”é‚¦èº«ä»½**: æ”¯æŒç¬¬ä¸‰æ–¹èº«ä»½æä¾›å•†
- **é›¶ä¿¡ä»»æ¶æ„**: å…¨é¢é›¶ä¿¡ä»»å®‰å…¨æ¶æ„
- **åŒºå—é“¾è®¤è¯**: åŒºå—é“¾èº«ä»½è®¤è¯æ¢ç´¢
- **é‡å­å®‰å…¨**: æŠ—é‡å­åŠ å¯†ç®—æ³•å‡†å¤‡

### é•¿æœŸè§„åˆ’ (1-2å¹´)
- **AIé©±åŠ¨**: æ™ºèƒ½èº«ä»½è®¤è¯å’Œé£é™©é¢„æµ‹
- **æ— å¯†ç è®¤è¯**: å®Œå…¨æ— å¯†ç è®¤è¯ä½“ç³»
- **å…ƒå®‡å®™è®¤è¯**: å…ƒå®‡å®™ç¯å¢ƒèº«ä»½è®¤è¯
- **é‡å­è®¤è¯**: é‡å­è®¡ç®—å®‰å…¨è®¤è¯

---

**ğŸ“ æŠ€æœ¯æ”¯æŒ**: 24x7æŠ€æœ¯æ”¯æŒçƒ­çº¿ + åœ¨çº¿æ–‡æ¡£ + å®šæœŸåŸ¹è®­
**ğŸ”„ ç‰ˆæœ¬æ›´æ–°**: æŒç»­è¿­ä»£ä¼˜åŒ–ï¼Œæ¯å­£åº¦å‘å¸ƒåŠŸèƒ½å¢å¼ºç‰ˆæœ¬
**âœ… è´¨é‡æ‰¿è¯º**: ç¬¦åˆå›½å®¶ä¸‰çº§ç­‰ä¿æ ‡å‡†ï¼Œæ”¯æŒé‡‘èçº§å®‰å…¨è¦æ±‚
**ğŸ¯ æˆåŠŸä¿éšœ**: ä¸¥æ ¼æŒ‰ç…§æ­¤æ–¹æ¡ˆå®æ–½ï¼Œç¡®ä¿100%è¾¾æˆä¼˜åŒ–ç›®æ ‡