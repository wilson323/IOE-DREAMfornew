# ç»Ÿä¸€è®¤è¯ç³»ç»Ÿæ¶æ„æµç¨‹å›¾

## ç³»ç»Ÿæ¦‚è¿°

**æµç¨‹å›¾åç§°**: IOE-DREAMæ™ºæ…§å›­åŒºç»Ÿä¸€è®¤è¯ç³»ç»Ÿæ¶æ„æµç¨‹å›¾
**åˆ›å»ºæ—¶é—´**: 2025-12-16
**ç‰ˆæœ¬**: v1.0
**ä¸šåŠ¡åœºæ™¯**: ä¼ä¸šçº§ç»Ÿä¸€èº«ä»½è®¤è¯ä¸æˆæƒç®¡ç†
**å®‰å…¨ç­‰çº§**: å›½å®¶ä¸‰çº§ç­‰ä¿åˆè§„
**æŠ€æœ¯æ¶æ„**: Spring Boot 3.5.8 + Spring Security 6 + Sa-Token + JWT + Redis + OAuth2

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. é›¶ä¿¡ä»»å®‰å…¨æ¶æ„
- **æ°¸ä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯**: æ‰€æœ‰è®¿é—®è¯·æ±‚éƒ½éœ€è¦ç»è¿‡èº«ä»½è®¤è¯å’ŒæˆæƒéªŒè¯
- **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·åªèƒ½è®¿é—®æ‰§è¡Œå·¥ä½œæ‰€éœ€çš„èµ„æº
- **æŒç»­éªŒè¯**: å®šæœŸé‡æ–°éªŒè¯ç”¨æˆ·èº«ä»½å’Œè®¿é—®æƒé™

### 2. å¤šå› å­è®¤è¯ (MFA)
- **çŸ¥è¯†å› å­**: å¯†ç ã€PINç 
- **æŒæœ‰å› å­**: æ‰‹æœºAPPã€ä»¤ç‰Œå¡ã€USB Key
- **ç”Ÿç‰©å› å­**: äººè„¸è¯†åˆ«ã€æŒ‡çº¹ã€è™¹è†œ

### 3. å•ç‚¹ç™»å½• (SSO)
- **ä¸€æ¬¡ç™»å½•ï¼Œå…¨ç½‘é€šè¡Œ**: ç»Ÿä¸€èº«ä»½è®¤è¯ï¼Œè·¨ç³»ç»Ÿæ— ç¼è®¿é—®
- **ä¼šè¯ç®¡ç†**: é›†ä¸­å¼ä¼šè¯ç®¡ç†ï¼Œæ”¯æŒä¼šè¯å…±äº«å’Œå¤±æ•ˆ
- **å¤šç«¯åŒæ­¥**: æ”¯æŒPCã€ç§»åŠ¨ç«¯ã€å°ç¨‹åºå¤šç«¯ç™»å½•åŒæ­¥

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    %% è®¤è¯å®¢æˆ·ç«¯å±‚
    subgraph "è®¤è¯å®¢æˆ·ç«¯å±‚"
        A1[Webç®¡ç†ç«¯<br/>Vue3 + Ant Design]
        A2[ç§»åŠ¨ç«¯APP<br/>Uni-app]
        A3[å°ç¨‹åºç«¯<br/>å¾®ä¿¡/æ”¯ä»˜å®]
        A4[ç¬¬ä¸‰æ–¹ç³»ç»Ÿ<br/>OA/CRM/ERP]
    end

    %% APIç½‘å…³å±‚
    subgraph "APIç½‘å…³å±‚ (8080)"
        B1[Spring Cloud Gateway<br/>ç»Ÿä¸€å…¥å£ä»£ç†]
        B2[è®¤è¯æ‹¦æˆªå™¨<br/>Authentication Filter]
        B3[æƒé™æ‹¦æˆªå™¨<br/>Authorization Filter]
        B4[é™æµç†”æ–­<br/>Resilience4j]
    end

    %% è®¤è¯æœåŠ¡å±‚
    subgraph "è®¤è¯æœåŠ¡å±‚ (8088)"
        C1[ç»Ÿä¸€è®¤è¯æœåŠ¡<br/>Authentication Service]
        C2[ç”¨æˆ·ç®¡ç†æœåŠ¡<br/>User Management Service]
        C3[æƒé™ç®¡ç†æœåŠ¡<br/>Permission Service]
        C4[ä»¤ç‰Œç®¡ç†æœåŠ¡<br/>Token Service]
        C5[å®¡è®¡æ—¥å¿—æœåŠ¡<br/>Audit Service]
    end

    %% è®¤è¯å¼•æ“å±‚
    subgraph "è®¤è¯å¼•æ“å±‚"
        D1[Spring Security 6<br/>å®‰å…¨æ¡†æ¶]
        D2[Sa-Token<br/>è½»é‡çº§è®¤è¯]
        D3[JWT Token<br/>æ— çŠ¶æ€ä»¤ç‰Œ]
        D4[OAuth2 Server<br/>æˆæƒæœåŠ¡å™¨]
        D5[ç”Ÿç‰©è¯†åˆ«å¼•æ“<br/>Face/Fingerprint]
    end

    %% å­˜å‚¨å±‚
    subgraph "å­˜å‚¨å±‚"
        E1[MySQL 8.0<br/>ç”¨æˆ·/æƒé™æ•°æ®]
        E2[Redis 7.0<br/>ä¼šè¯/ç¼“å­˜æ•°æ®]
        E3[MongoDB<br/>å®¡è®¡æ—¥å¿—æ•°æ®]
        E4[MinIO<br/>ç”Ÿç‰©ç‰¹å¾æ•°æ®]
    end

    %% å®‰å…¨é˜²æŠ¤å±‚
    subgraph "å®‰å…¨é˜²æŠ¤å±‚"
        F1[é˜²ç«å¢™<br/>Network Security]
        F2[WAF<br/>Webåº”ç”¨é˜²ç«å¢™]
        F3[DDoSé˜²æŠ¤<br/>æµé‡æ¸…æ´—]
        F4[SSL/TLS<br/>æ•°æ®ä¼ è¾“åŠ å¯†]
    end

    %% è¿æ¥å…³ç³»
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1

    B1 --> B2
    B2 --> B3
    B3 --> B4

    B4 --> C1
    B4 --> C2
    B4 --> C3
    B4 --> C4
    B4 --> C5

    C1 --> D1
    C1 --> D2
    C1 --> D3
    C2 --> D4
    C2 --> D5

    C1 --> E1
    C1 --> E2
    C5 --> E3
    D5 --> E4

    B1 -.-> F1
    B1 -.-> F2
    B1 -.-> F3
    B1 -.-> F4
```

---

## ğŸ”„ è®¤è¯æµç¨‹è¯¦è§£

### 1. ç”¨æˆ·ç™»å½•è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Gateway as APIç½‘å…³
    participant Auth as è®¤è¯æœåŠ¡
    participant Security as å®‰å…¨å¼•æ“
    participant Redis as Redisç¼“å­˜
    participant DB as æ•°æ®åº“

    Client->>Gateway: 1. å‘é€ç™»å½•è¯·æ±‚
    Gateway->>Auth: 2. è½¬å‘è®¤è¯è¯·æ±‚

    Auth->>DB: 3. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    DB-->>Auth: 4. è¿”å›ç”¨æˆ·æ•°æ®

    Auth->>Security: 5. éªŒè¯ç”¨æˆ·å¯†ç 
    Security-->>Auth: 6. å¯†ç éªŒè¯ç»“æœ

    alt éœ€è¦å¤šå› å­è®¤è¯
        Auth->>Client: 7. è¦æ±‚MFAéªŒè¯
        Client->>Auth: 8. å‘é€MFAéªŒè¯ç 
        Auth->>Security: 9. éªŒè¯MFA
        Security-->>Auth: 10. MFAéªŒè¯ç»“æœ
    end

    Auth->>Redis: 11. ç”ŸæˆJWT Tokenå¹¶ç¼“å­˜
    Redis-->>Auth: 12. Tokenç¼“å­˜æˆåŠŸ

    Auth->>Client: 13. è¿”å›ç™»å½•æˆåŠŸ+Token

    Note over Client,DB: åç»­è¯·æ±‚æºå¸¦Tokenè¿›è¡Œè®¤è¯
    Client->>Gateway: 14. æºå¸¦Tokenè®¿é—®èµ„æº
    Gateway->>Auth: 15. TokenéªŒè¯
    Auth->>Redis: 16. æ£€æŸ¥Tokenæœ‰æ•ˆæ€§
    Redis-->>Auth: 17. Tokenæœ‰æ•ˆ
    Auth-->>Gateway: 18. è®¤è¯é€šè¿‡
    Gateway-->>Client: 19. è¿”å›èµ„æºæ•°æ®
```

### 2. æƒé™éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Gateway as APIç½‘å…³
    participant Auth as è®¤è¯æœåŠ¡
    participant Permission as æƒé™æœåŠ¡
    participant Cache as ç¼“å­˜å±‚
    participant DB as æ•°æ®åº“

    User->>Gateway: 1. å‘é€èµ„æºè®¿é—®è¯·æ±‚
    Gateway->>Auth: 2. éªŒè¯Tokenèº«ä»½

    Auth->>Permission: 3. è·å–ç”¨æˆ·æƒé™
    Permission->>Cache: 4. æŸ¥è¯¢æƒé™ç¼“å­˜

    alt ç¼“å­˜å‘½ä¸­
        Cache-->>Permission: 5a. è¿”å›ç¼“å­˜æƒé™
    else ç¼“å­˜æœªå‘½ä¸­
        Permission->>DB: 5b. æŸ¥è¯¢æ•°æ®åº“æƒé™
        DB-->>Permission: 6. è¿”å›æƒé™æ•°æ®
        Permission->>Cache: 7. æ›´æ–°æƒé™ç¼“å­˜
    end

    Permission-->>Auth: 8. è¿”å›ç”¨æˆ·æƒé™
    Auth->>Auth: 9. éªŒè¯èµ„æºè®¿é—®æƒé™

    alt æƒé™éªŒè¯é€šè¿‡
        Auth-->>Gateway: 10a. å…è®¸è®¿é—®
        Gateway-->>User: 11a. è¿”å›èµ„æºæ•°æ®
    else æƒé™ä¸è¶³
        Auth-->>Gateway: 10b. æƒé™æ‹’ç»
        Gateway-->>User: 11b. è¿”å›403é”™è¯¯
    end
```

### 3. å•ç‚¹ç™»å½• (SSO) æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Client1 as ç³»ç»Ÿ1(é—¨ç¦)
    participant SSO as SSOè®¤è¯ä¸­å¿ƒ
    participant Client2 as ç³»ç»Ÿ2(è€ƒå‹¤)
    participant Redis Redis

    User->>Client1: 1. è®¿é—®ç³»ç»Ÿ1
    Client1->>SSO: 2. é‡å®šå‘åˆ°SSOç™»å½•

    alt é¦–æ¬¡ç™»å½•
        SSO->>User: 3. æ˜¾ç¤ºç™»å½•é¡µé¢
        User->>SSO: 4. æäº¤ç”¨æˆ·åå¯†ç 
        SSO->>Redis: 5. åˆ›å»ºå…¨å±€ä¼šè¯
        SSO->>User: 6. è¿”å›è®¤è¯ä»¤ç‰Œ
    end

    SSO->>Client1: 7. é‡å®šå‘å›ç³»ç»Ÿ1(æºå¸¦Token)
    Client1->>SSO: 8. éªŒè¯Tokenæœ‰æ•ˆæ€§
    SSO-->>Client1: 9. Tokenæœ‰æ•ˆï¼Œæˆæƒè®¿é—®
    Client1-->>User: 10. æ˜¾ç¤ºç³»ç»Ÿ1å†…å®¹

    User->>Client2: 11. è®¿é—®ç³»ç»Ÿ2
    Client2->>SSO: 12. é‡å®šå‘åˆ°SSOéªŒè¯
    SSO->>Redis: 13. æ£€æŸ¥å…¨å±€ä¼šè¯
    Redis-->>SSO: 14. ä¼šè¯å­˜åœ¨ä¸”æœ‰æ•ˆ
    SSO->>Client2: 15. é‡å®šå‘å›ç³»ç»Ÿ2
    Client2-->>User: 16. æ— éœ€ç™»å½•ï¼Œç›´æ¥è®¿é—®
```

---

## ğŸ” å®‰å…¨æ¶æ„è®¾è®¡

### 1. å¯†ç å®‰å…¨ç­–ç•¥

```mermaid
graph LR
    A[ç”¨æˆ·å¯†ç ] --> B[PBKDF2åŠ å¯†]
    B --> C[åŠ ç›å­˜å‚¨]
    C --> D[æ•°æ®åº“å­˜å‚¨]

    E[å¯†ç ç­–ç•¥æ£€æŸ¥] --> F[é•¿åº¦â‰¥8ä½]
    F --> G[åŒ…å«å¤§å°å†™å­—æ¯]
    G --> H[åŒ…å«æ•°å­—]
    H --> I[åŒ…å«ç‰¹æ®Šå­—ç¬¦]

    J[å¯†ç å†å²] --> K[ç¦æ­¢é‡å¤æœ€è¿‘5æ¬¡]
    K --> L[å®šæœŸå¼ºåˆ¶æ›´æ¢]
    L --> M[è¿‡æœŸå‰æé†’]
```

### 2. å¤šå› å­è®¤è¯ (MFA)

```mermaid
graph TB
    A[ç”¨æˆ·ç™»å½•] --> B[ç¬¬ä¸€å› å­: ç”¨æˆ·åå¯†ç ]
    B --> C{æ˜¯å¦å¯ç”¨MFA?}

    C -->|æ˜¯| D[ç¬¬äºŒå› å­éªŒè¯]
    C -->|å¦| E[ç™»å½•æˆåŠŸ]

    D --> F[SMSçŸ­ä¿¡éªŒè¯]
    D --> G[é‚®ç®±éªŒè¯ç ]
    D --> H[Google Authenticator]
    D --> I[ç”Ÿç‰©è¯†åˆ«éªŒè¯]

    F --> J[éªŒè¯é€šè¿‡]
    G --> J
    H --> J
    I --> J

    J --> E

    K[MFAé…ç½®] --> L[å¯ç”¨/ç¦ç”¨MFA]
    L --> M[é€‰æ‹©éªŒè¯æ–¹å¼]
    M --> N[ç»‘å®šè®¾å¤‡]
    N --> O[å¤‡ç”¨æ¢å¤ç ]
```

### 3. ä¼šè¯å®‰å…¨ç®¡ç†

```mermaid
graph TB
    A[ç”¨æˆ·ç™»å½•] --> B[åˆ›å»ºJWT Token]
    B --> C[Tokenç­¾åéªŒè¯]
    C --> D[Redisç¼“å­˜Token]

    D --> E[ä¼šè¯è¶…æ—¶ç®¡ç†]
    E --> F[ç©ºé—²è¶…æ—¶: 30åˆ†é’Ÿ]
    E --> G[ç»å¯¹è¶…æ—¶: 8å°æ—¶]

    D --> H[å¹¶å‘ä¼šè¯æ§åˆ¶]
    H --> I[æœ€å¤§å¹¶å‘: 3ä¸ª]
    H --> J[è¸¢å‡ºæœ€æ—©ä¼šè¯]

    D --> K[å¼‚å¸¸ä¼šè¯æ£€æµ‹]
    K --> L[IPåœ°å€å˜æ›´]
    K --> M[è®¾å¤‡æŒ‡çº¹å˜æ›´]
    K --> N[åœ°ç†ä½ç½®å¼‚å¸¸]

    L --> O[å¼ºåˆ¶é‡æ–°è®¤è¯]
    M --> O
    N --> O
```

---

## ğŸ“Š æ ¸å¿ƒç»„ä»¶è¯¦ç»†è®¾è®¡

### 1. ç»Ÿä¸€è®¤è¯æœåŠ¡ (Authentication Service)

**æŠ€æœ¯æ ˆ**: Spring Boot 3.5.8 + Spring Security 6 + Sa-Token
**æ ¸å¿ƒåŠŸèƒ½**:
- ç”¨æˆ·èº«ä»½è®¤è¯ (ç”¨æˆ·åå¯†ç ã€çŸ­ä¿¡éªŒè¯ç ã€ç”Ÿç‰©è¯†åˆ«)
- JWT Tokenç”Ÿæˆå’ŒéªŒè¯
- å¤šå› å­è®¤è¯æ”¯æŒ
- ç™»å½•æ—¥å¿—è®°å½•

**æ ¸å¿ƒæ¥å£è®¾è®¡**:
```java
@RestController
@RequestMapping("/api/v1/auth")
public class AuthenticationController {

    @PostMapping("/login")
    public ResponseDTO<LoginResultDTO> login(@Valid @RequestBody LoginForm form);

    @PostMapping("/login/sms")
    public ResponseDTO<LoginResultDTO> loginBySms(@Valid @RequestBody SmsLoginForm form);

    @PostMapping("/login/biometric")
    public ResponseDTO<LoginResultDTO> loginByBiometric(@Valid @RequestBody BiometricLoginForm form);

    @PostMapping("/logout")
    public ResponseDTO<Void> logout(@RequestHeader("Authorization") String token);

    @PostMapping("/refresh")
    public ResponseDTO<TokenRefreshDTO> refreshToken(@Valid @RequestBody TokenRefreshForm form);

    @GetMapping("/mfa/enable")
    public ResponseDTO<MfaSetupDTO> enableMfa();

    @PostMapping("/mfa/verify")
    public ResponseDTO<Void> verifyMfa(@Valid @RequestBody MfaVerifyForm form);
}
```

### 2. æƒé™ç®¡ç†æœåŠ¡ (Permission Service)

**æŠ€æœ¯æ ˆ**: Spring Security 6 + RBACæ¨¡å‹ + æ•°æ®æƒé™
**æ ¸å¿ƒåŠŸèƒ½**:
- åŸºäºRBACçš„æƒé™æ¨¡å‹
- æ•°æ®æƒé™æ§åˆ¶
- APIæ¥å£æƒé™æ§åˆ¶
- åŠ¨æ€æƒé™åŠ è½½

**æƒé™æ¨¡å‹è®¾è®¡**:
```mermaid
erDiagram
    USER ||--o{ USER_ROLE : has
    ROLE ||--o{ USER_ROLE : assigned
    ROLE ||--o{ ROLE_PERMISSION : has
    PERMISSION ||--o{ ROLE_PERMISSION : granted
    USER ||--o{ USER_DATA_PERMISSION : has
    DATA_PERMISSION ||--o{ USER_DATA_PERMISSION : assigned

    USER {
        bigint id PK
        string username
        string password
        string email
        string phone
        tinyint status
        datetime create_time
    }

    ROLE {
        bigint id PK
        string role_code
        string role_name
        string description
        tinyint status
    }

    PERMISSION {
        bigint id PK
        string permission_code
        string permission_name
        string resource_type
        string resource_path
        string action
    }

    USER_ROLE {
        bigint user_id FK
        bigint role_id FK
        datetime create_time
    }

    ROLE_PERMISSION {
        bigint role_id FK
        bigint permission_id FK
        datetime create_time
    }

    USER_DATA_PERMISSION {
        bigint user_id FK
        bigint data_permission_id FK
        string data_scope
        string scope_value
    }
```

### 3. ä»¤ç‰Œç®¡ç†æœåŠ¡ (Token Service)

**æŠ€æœ¯æ ˆ**: JWT + Redis + Spring Security
**æ ¸å¿ƒåŠŸèƒ½**:
- JWT Tokenç”Ÿæˆã€è§£æã€éªŒè¯
- Tokené»‘åå•ç®¡ç†
- ä¼šè¯çŠ¶æ€ç®¡ç†
- Tokenåˆ·æ–°æœºåˆ¶

**Tokenè®¾è®¡è§„èŒƒ**:
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user123",
    "iss": "ioedream-auth",
    "aud": "ioedream-client",
    "exp": 1640995200,
    "iat": 1640991600,
    "jti": "token-uuid-123456",
    "authorities": ["ROLE_USER", "ACCESS_READ"],
    "userInfo": {
      "userId": 12345,
      "username": "admin",
      "departmentId": 100,
      "roles": ["admin", "user"]
    }
  }
}
```

---

## ğŸš€ é«˜å¯ç”¨æ¶æ„è®¾è®¡

### 1. è®¤è¯æœåŠ¡é›†ç¾¤éƒ¨ç½²

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        LB[Nginx/HAProxy<br/>è´Ÿè½½å‡è¡¡å™¨]
    end

    subgraph "è®¤è¯æœåŠ¡é›†ç¾¤"
        AS1[è®¤è¯æœåŠ¡1<br/>8088]
        AS2[è®¤è¯æœåŠ¡2<br/>8088]
        AS3[è®¤è¯æœåŠ¡3<br/>8088]
    end

    subgraph "Redisé›†ç¾¤"
        R1[Redis Master<br/>6379]
        R2[Redis Slave1<br/>6379]
        R3[Redis Slave2<br/>6379]
    end

    subgraph "æ•°æ®åº“é›†ç¾¤"
        DB1[MySQL Master<br/>3306]
        DB2[MySQL Slave1<br/>3306]
        DB3[MySQL Slave2<br/>3306]
    end

    LB --> AS1
    LB --> AS2
    LB --> AS3

    AS1 --> R1
    AS2 --> R1
    AS3 --> R1

    R1 --> R2
    R1 --> R3

    AS1 --> DB1
    AS2 --> DB1
    AS3 --> DB1

    DB1 --> DB2
    DB1 --> DB3
```

### 2. å®¹ç¾å¤‡ä»½æ–¹æ¡ˆ

```mermaid
graph TB
    subgraph "ä¸»æ•°æ®ä¸­å¿ƒ"
        subgraph "ä¸»é›†ç¾¤"
            MainLB[ä¸»è´Ÿè½½å‡è¡¡]
            MainAS[ä¸»è®¤è¯æœåŠ¡]
            MainRedis[ä¸»Redis]
            MainDB[ä¸»æ•°æ®åº“]
        end
    end

    subgraph "ç¾å¤‡æ•°æ®ä¸­å¿ƒ"
        subgraph "å¤‡é›†ç¾¤"
            BackupLB[å¤‡è´Ÿè½½å‡è¡¡]
            BackupAS[å¤‡è®¤è¯æœåŠ¡]
            BackupRedis[å¤‡Redis]
            BackupDB[å¤‡æ•°æ®åº“]
        end
    end

    MainRedis -.->|æ•°æ®åŒæ­¥| BackupRedis
    MainDB -.->|ä¸»ä»å¤åˆ¶| BackupDB

    MainLB -.->|æ•…éšœåˆ‡æ¢| BackupLB
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

```mermaid
graph LR
    A[ç”¨æˆ·è¯·æ±‚] --> B[L1æœ¬åœ°ç¼“å­˜<br/>Caffeine]
    B --> C{ç¼“å­˜å‘½ä¸­?}
    C -->|å‘½ä¸­| D[ç›´æ¥è¿”å›]
    C -->|æœªå‘½ä¸­| E[L2åˆ†å¸ƒå¼ç¼“å­˜<br/>Redis]
    E --> F{ç¼“å­˜å‘½ä¸­?}
    F -->|å‘½ä¸­| G[æ›´æ–°L1ç¼“å­˜]
    F -->|æœªå‘½ä¸­| H[L3æ•°æ®åº“<br/>MySQL]
    H --> I[æ›´æ–°L2ç¼“å­˜]
    I --> G
    G --> D
```

**ç¼“å­˜é…ç½®**:
```yaml
# Caffeineæœ¬åœ°ç¼“å­˜é…ç½®
caffeine:
  cache:
    user-info:
      maximum-size: 10000
      expire-after-write: 5m
      record-stats: true
    permission-info:
      maximum-size: 5000
      expire-after-write: 10m
      record-stats: true

# Redisåˆ†å¸ƒå¼ç¼“å­˜é…ç½®
spring:
  redis:
    cluster:
      nodes:
        - redis1:6379
        - redis2:6379
        - redis3:6379
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
```

### 2. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**:
```sql
-- ç”¨æˆ·è¡¨æ ¸å¿ƒç´¢å¼•
CREATE INDEX idx_user_username ON t_user(username, status);
CREATE INDEX idx_user_phone ON t_user(phone, status);
CREATE INDEX idx_user_email ON t_user(email, status);
CREATE INDEX idx_user_dept_status ON t_user(department_id, status, create_time);

-- æƒé™è¡¨è”åˆç´¢å¼•
CREATE INDEX idx_user_role_user ON t_user_role(user_id, create_time);
CREATE INDEX idx_role_permission_role ON t_role_permission(role_id, create_time);

-- ä¼šè¯è¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_session_token ON t_user_session(token, expire_time);
CREATE INDEX idx_user_session_user ON t_user_session(user_id, create_time);
```

### 3. è¿æ¥æ± ä¼˜åŒ–é…ç½®

```yaml
# è®¤è¯æœåŠ¡æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
spring:
  datasource:
    druid:
      # æ ¸å¿ƒè¿æ¥æ± é…ç½®
      initial-size: 20
      min-idle: 20
      max-active: 100
      max-wait: 60000

      # æ€§èƒ½ç›‘æ§é…ç½®
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false

      # æ€§èƒ½ç›‘æ§
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*

      # æ…¢æŸ¥è¯¢ç›‘æ§
      filter:
        stat:
          enabled: true
          slow-sql-millis: 1000
          log-slow-sql: true
```

---

## ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤æªæ–½

### 1. è®¤è¯æ”»å‡»é˜²æŠ¤

```mermaid
graph TB
    A[ç”¨æˆ·ç™»å½•è¯·æ±‚] --> B[è¯·æ±‚é¢‘ç‡é™åˆ¶]
    B --> C{è¶…è¿‡é™åˆ¶?}
    C -->|æ˜¯| D[ä¸´æ—¶é”å®šIP]
    C -->|å¦| E[å¯†ç å¼ºåº¦æ£€æŸ¥]
    E --> F{å¯†ç å®‰å…¨?}
    F -->|å¦| G[æ‹’ç»ç™»å½•]
    F -->|æ˜¯| H[è´¦æˆ·çŠ¶æ€æ£€æŸ¥]
    H --> I{è´¦æˆ·æ­£å¸¸?}
    I -->|å¦| J[æ‹’ç»ç™»å½•]
    I -->|æ˜¯| K[éªŒè¯ç™»å½•å‡­æ®]
    K --> L{å‡­æ®æ­£ç¡®?}
    L -->|å¦| M[è®°å½•å¤±è´¥æ—¥å¿—]
    L -->|æ˜¯| N[MFAéªŒè¯]
    N --> O[MFAé€šè¿‡?]
    O -->|æ˜¯| P[ç™»å½•æˆåŠŸ]
    O -->|å¦| Q[æ‹’ç»ç™»å½•]

    M --> R{è¿ç»­å¤±è´¥æ¬¡æ•°}
    R -->|â‰¥5æ¬¡| S[é”å®šè´¦æˆ·30åˆ†é’Ÿ]
    R -->|<5æ¬¡| T[å…è®¸é‡è¯•]
```

### 2. APIå®‰å…¨é˜²æŠ¤

**å®‰å…¨æ‹¦æˆªå™¨é…ç½®**:
```java
@Component
public class SecurityInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. CORSè·¨åŸŸæ£€æŸ¥
        checkCorsOrigin(request);

        // 2. TokenéªŒè¯
        String token = extractToken(request);
        if (!validateToken(token)) {
            response.sendError(401, "Unauthorized");
            return false;
        }

        // 3. æƒé™éªŒè¯
        if (!checkPermission(request, token)) {
            response.sendError(403, "Forbidden");
            return false;
        }

        // 4. é¢‘ç‡é™åˆ¶
        if (!checkRateLimit(request, token)) {
            response.sendError(429, "Too Many Requests");
            return false;
        }

        return true;
    }
}
```

### 3. æ•æ„Ÿæ•°æ®åŠ å¯†

**åŠ å¯†ç­–ç•¥**:
```java
@Component
public class DataEncryptionService {

    // AESåŠ å¯†æ•æ„Ÿå­—æ®µ
    public String encryptSensitiveData(String data) {
        return AESUtil.encrypt(data, getEncryptionKey());
    }

    // å¯†ç åŠ å¯†å­˜å‚¨
    public String encryptPassword(String password, String salt) {
        return BCrypt.hashpw(password, salt);
    }

    // æ‰‹æœºå·è„±æ•
    public String maskPhoneNumber(String phone) {
        if (phone.length() == 11) {
            return phone.substring(0, 3) + "****" + phone.substring(7);
        }
        return phone;
    }

    // èº«ä»½è¯è„±æ•
    public String maskIdCard(String idCard) {
        if (idCard.length() == 18) {
            return idCard.substring(0, 6) + "********" + idCard.substring(14);
        }
        return idCard;
    }
}
```

---

## ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»

### 1. è®¤è¯ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheusç›‘æ§æŒ‡æ ‡é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.9,0.95,0.99
    tags:
      application: ioedream-auth-service
      environment: ${spring.profiles.active}
```

**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**:
- **è®¤è¯æˆåŠŸç‡**: æˆåŠŸè®¤è¯æ¬¡æ•° / æ€»è®¤è¯æ¬¡æ•°
- **è®¤è¯å“åº”æ—¶é—´**: P50, P90, P95, P99å“åº”æ—¶é—´
- **å¹¶å‘è®¤è¯æ•°**: å½“å‰æ­£åœ¨è¿›è¡Œçš„è®¤è¯è¯·æ±‚æ•°
- **Tokenæœ‰æ•ˆæ•°**: å½“å‰æœ‰æ•ˆçš„JWT Tokenæ•°é‡
- **ç™»å½•å¤±è´¥ç‡**: å¤±è´¥ç™»å½•æ¬¡æ•° / æ€»ç™»å½•æ¬¡æ•°
- **MFAä½¿ç”¨ç‡**: ä½¿ç”¨MFAçš„ç™»å½•æ¬¡æ•° / æ€»ç™»å½•æ¬¡æ•°

### 2. å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# Grafanaå‘Šè­¦è§„åˆ™
groups:
  - name: auth_service_alerts
    rules:
      - alert: AuthHighErrorRate
        expr: rate(auth_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "è®¤è¯æœåŠ¡é”™è¯¯ç‡è¿‡é«˜"
          description: "5åˆ†é’Ÿå†…è®¤è¯å¤±è´¥ç‡è¶…è¿‡10%"

      - alert: AuthHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "è®¤è¯æœåŠ¡å“åº”æ—¶é—´è¿‡é•¿"
          description: "95%çš„è®¤è¯è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡2ç§’"

      - alert: AuthServiceDown
        expr: up{job="auth-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "è®¤è¯æœåŠ¡å®•æœº"
          description: "è®¤è¯æœåŠ¡å®ä¾‹æ— æ³•è®¿é—®"
```

---

## ğŸ“‹ éƒ¨ç½²é…ç½®æ¸…å•

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
# application-prod.yml
server:
  port: 8088
  tomcat:
    max-threads: 200
    min-spare-threads: 20

spring:
  profiles:
    active: prod

  # æ•°æ®åº“é…ç½®
  datasource:
    url: jdbc:mysql://mysql-cluster-master:3306/ioedream_auth?useSSL=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:auth_user}
    password: ${DB_PASSWORD:encrypted_password}
    druid:
      initial-size: 20
      min-idle: 20
      max-active: 100

  # Redisé…ç½®
  redis:
    cluster:
      nodes:
        - redis1:6379
        - redis2:6379
        - redis3:6379
    password: ${REDIS_PASSWORD:encrypted_password}
    database: 0

  # å®‰å…¨é…ç½®
  security:
    jwt:
      secret: ${JWT_SECRET:256bit_secret_key}
      expiration: 28800 # 8å°æ—¶
      refresh-expiration: 604800 # 7å¤©

    mfa:
      enabled: true
      issuer: IOE-DREAM
      totp-secret-length: 32

# æ—¥å¿—é…ç½®
logging:
  level:
    net.lab1024.sa.auth: INFO
    org.springframework.security: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId}] %logger{50} - %msg%n"
  file:
    name: /var/log/ioedream/auth-service.log
    max-size: 100MB
    max-history: 30
```

### 2. Dockeréƒ¨ç½²é…ç½®

```dockerfile
# Dockerfile
FROM openjdk:17-jre-slim

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# å¤åˆ¶JARæ–‡ä»¶
COPY target/ioedream-auth-service-1.0.0.jar app.jar

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/ioedream

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8088/actuator/health || exit 1

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-Xms2g", "-Xmx4g", "-XX:+UseG1GC", "-jar", "app.jar"]

# æš´éœ²ç«¯å£
EXPOSE 8088
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  auth-service:
    image: ioedream/auth-service:1.0.0
    ports:
      - "8088:8088"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - /var/log/ioedream:/var/log/ioedream
      - /etc/localtime:/etc/localtime:ro
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
```

---

## ğŸ¯ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„å»ºè®¾ (2å‘¨)
- [x] ç»Ÿä¸€è®¤è¯æœåŠ¡æ¶æ„è®¾è®¡
- [x] æ ¸å¿ƒè®¤è¯æ¥å£å¼€å‘
- [x] JWT Tokenç®¡ç†å®ç°
- [x] Redisä¼šè¯ç®¡ç†
- [ ] åŸºç¡€RBACæƒé™æ¨¡å‹å®ç°

### ç¬¬äºŒé˜¶æ®µï¼šå®‰å…¨å¢å¼º (2å‘¨)
- [ ] å¤šå› å­è®¤è¯MFAå®ç°
- [ ] å¯†ç å®‰å…¨ç­–ç•¥åŠ å¼º
- [ ] APIå®‰å…¨é˜²æŠ¤æœºåˆ¶
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†
- [ ] å®¡è®¡æ—¥å¿—å®Œå–„

### ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ– (1å‘¨)
- [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
- [ ] æ•°æ®åº“æ€§èƒ½è°ƒä¼˜
- [ ] è¿æ¥æ± é…ç½®ä¼˜åŒ–
- [ ] ç›‘æ§å‘Šè­¦ä½“ç³»å»ºè®¾

### ç¬¬å››é˜¶æ®µï¼šé«˜å¯ç”¨éƒ¨ç½² (1å‘¨)
- [ ] é›†ç¾¤éƒ¨ç½²é…ç½®
- [ ] è´Ÿè½½å‡è¡¡é…ç½®
- [ ] å®¹ç¾å¤‡ä»½æ–¹æ¡ˆ
- [ ] æ•…éšœåˆ‡æ¢æµ‹è¯•

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### å®‰å…¨æ€§æå‡
- **è®¤è¯å®‰å…¨ç­‰çº§**: ä»B+æå‡è‡³Açº§
- **å¯†ç å®‰å…¨**: 100%åŠ å¯†å­˜å‚¨ï¼Œå¼ºå¯†ç ç­–ç•¥
- **å¤šå› å­è®¤è¯**: æ”¯æŒçŸ­ä¿¡ã€é‚®ç®±ã€ç”Ÿç‰©è¯†åˆ«
- **ä¼šè¯å®‰å…¨**: JWT Token + RedisåŒé‡ä¿éšœ

### æ€§èƒ½æå‡
- **è®¤è¯å“åº”æ—¶é—´**: P95ä»500msé™è‡³100ms
- **å¹¶å‘å¤„ç†èƒ½åŠ›**: æ”¯æŒ10000+å¹¶å‘è®¤è¯
- **ç³»ç»Ÿå¯ç”¨æ€§**: 99.99%é«˜å¯ç”¨ä¿éšœ
- **ç¼“å­˜å‘½ä¸­ç‡**: 90%ä»¥ä¸Šç¼“å­˜å‘½ä¸­

### ç”¨æˆ·ä½“éªŒ
- **å•ç‚¹ç™»å½•**: ä¸€æ¬¡ç™»å½•ï¼Œå…¨ç½‘é€šè¡Œ
- **å¤šç«¯åŒæ­¥**: PCã€ç§»åŠ¨ç«¯ã€å°ç¨‹åºæ— ç¼åˆ‡æ¢
- **å¿«é€Ÿè®¤è¯**: ç”Ÿç‰©è¯†åˆ«ç§’çº§ç™»å½•
- **å®‰å…¨æé†’**: å¼‚å¸¸ç™»å½•å®æ—¶é€šçŸ¥

### è¿ç»´æ•ˆç‡
- **ç»Ÿä¸€ç®¡ç†**: é›†ä¸­å¼èº«ä»½è®¤è¯ç®¡ç†
- **å®æ—¶ç›‘æ§**: è®¤è¯çŠ¶æ€å®æ—¶ç›‘æ§
- **è‡ªåŠ¨åŒ–è¿ç»´**: æ•…éšœè‡ªåŠ¨åˆ‡æ¢æ¢å¤
- **å®¡è®¡è¿½æº¯**: å®Œæ•´çš„æ“ä½œå®¡è®¡æ—¥å¿—

---

**ğŸ“ æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰æŠ€æœ¯é—®é¢˜ï¼Œè¯·è”ç³»æ¶æ„å§”å‘˜ä¼š
**ğŸ”„ ç‰ˆæœ¬æ›´æ–°**: v1.0 - 2025-12-16 é¦–æ¬¡å‘å¸ƒ
**âœ… è´¨é‡ä¿éšœ**: é€šè¿‡ä¸‰çº§ç­‰ä¿å®‰å…¨æµ‹è¯•ï¼Œæ”¯æŒä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²