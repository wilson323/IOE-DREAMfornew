# å®¡æ‰¹æµç¨‹å¯é…ç½®åŒ–åŠŸèƒ½è®¾è®¡

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®¡æ‰¹æµç¨‹å¯é…ç½®åŒ–åŠŸèƒ½æ˜¯IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°OAå·¥ä½œæµæ¨¡å—çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæ—¨åœ¨é€šè¿‡ä½ä»£ç é…ç½®æ–¹å¼ï¼Œè®©ä¸šåŠ¡ç®¡ç†å‘˜èƒ½å¤Ÿçµæ´»å®šä¹‰ã€ä¿®æ”¹å’Œç®¡ç†å„ç§å®¡æ‰¹æµç¨‹ï¼Œæ— éœ€å¼€å‘äººå‘˜ä»‹å…¥å³å¯æ»¡è¶³ä¸šåŠ¡å˜åŒ–éœ€æ±‚ã€‚

### ğŸ¯ è®¾è®¡ç›®æ ‡

- **é›¶ä»£ç é…ç½®** - ä¸šåŠ¡ç®¡ç†å‘˜é€šè¿‡å¯è§†åŒ–ç•Œé¢é…ç½®å®¡æ‰¹æµç¨‹
- **çµæ´»é€‚é…** - æ”¯æŒå„ç§ä¸šåŠ¡åœºæ™¯çš„å®¡æ‰¹æµç¨‹å®šä¹‰
- **å®æ—¶ç”Ÿæ•ˆ** - é…ç½®ä¿®æ”¹åç«‹å³å¯ç”¨ï¼Œæ— éœ€é‡å¯ç³»ç»Ÿ
- **ç‰ˆæœ¬ç®¡ç†** - æ”¯æŒæµç¨‹ç‰ˆæœ¬æ§åˆ¶å’Œå†å²è¿½æº¯
- **æ¨¡å—åŒ–è®¾è®¡** - å„ä¸šåŠ¡æ¨¡å—å¯ç‹¬ç«‹é…ç½®è‡ªå·±çš„å®¡æ‰¹æµç¨‹

### ğŸ“Š åŠŸèƒ½æŒ‡æ ‡

| æŒ‡æ ‡é¡¹ | ç›®æ ‡å€¼ | è¯´æ˜ |
|---------|--------|------|
| **é…ç½®å“åº”æ—¶é—´** | â‰¤ 2ç§’ | æµç¨‹é…ç½®çš„ç•Œé¢å“åº”æ—¶é—´ |
| **æµç¨‹ç”Ÿæ•ˆæ—¶é—´** | â‰¤ 30ç§’ | é…ç½®ä¿®æ”¹åç”Ÿæ•ˆæ—¶é—´ |
| **é…ç½®å¤æ‚åº¦** | â‰¤ 3æ­¥ | å®ŒæˆåŸºç¡€æµç¨‹é…ç½®çš„æ“ä½œæ­¥éª¤ |
| **ä¸šåŠ¡è¦†ç›–åº¦** | â‰¥ 95% | å¯é…ç½®æµç¨‹è¦†ç›–çš„ä¸šåŠ¡åœºæ™¯ |
| **ç”¨æˆ·æ»¡æ„åº¦** | â‰¥ 92% | ä¸šåŠ¡ç®¡ç†å‘˜æ»¡æ„åº¦ |

---

## ğŸ”„ åŠŸèƒ½æ¶æ„å›¾

```mermaid
graph TD
    A[é…ç½®ç®¡ç†å…¥å£] --> B[æµç¨‹ç±»å‹é€‰æ‹©]

    B --> C{æµç¨‹ç±»å‹}
    C -->|è¯·å‡å®¡æ‰¹| D[è¯·å‡æµç¨‹æ¨¡æ¿]
    C -->|æŠ¥é”€å®¡æ‰¹| E[æŠ¥é”€æµç¨‹æ¨¡æ¿]
    C -->|é—¨ç¦æƒé™| F[æƒé™å®¡æ‰¹æ¨¡æ¿]
    C -->|è®¿å®¢é¢„çº¦| G[è®¿å®¢æµç¨‹æ¨¡æ¿]
    C -->|è€ƒå‹¤ç”³è¯‰| H[ç”³è¯‰æµç¨‹æ¨¡æ¿]
    C -->|è‡ªå®šä¹‰æµç¨‹| I[ç©ºç™½æµç¨‹æ¨¡æ¿]

    D --> J[æµç¨‹è®¾è®¡å™¨]
    E --> J
    F --> J
    G --> J
    H --> J
    I --> J

    J --> K[èŠ‚ç‚¹é…ç½®]
    J --> L[æ¡ä»¶é…ç½®]
    J --> M[å®¡æ‰¹äººé…ç½®]
    J --> N[é€šçŸ¥é…ç½®]

    K --> O[æµç¨‹é¢„è§ˆ]
    L --> O
    M --> O
    N --> O

    O --> P{é…ç½®éªŒè¯}
    P -->|éªŒè¯é€šè¿‡| Q[ä¿å­˜é…ç½®]
    P -->|éªŒè¯å¤±è´¥| R[é”™è¯¯æç¤º]

    Q --> S[éƒ¨ç½²æµç¨‹]
    S --> T[ç”ŸæˆBPMN]
    T --> U[æ›´æ–°å·¥ä½œæµå¼•æ“]
    U --> V[é…ç½®ç”Ÿæ•ˆ]

    V --> W[ç›‘æ§è¿è¡ŒçŠ¶æ€]
    W --> X[æ€§èƒ½ä¼˜åŒ–]

    style A fill:#e1f5fe
    style J fill:#fff3e0
    style Q fill:#e8f5e8
    style V fill:#e8f5e8
    style R fill:#ffebee
```

---

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. æµç¨‹æ¨¡æ¿ç®¡ç†

#### 1.1 æµç¨‹æ¨¡æ¿å®ä½“è®¾è®¡
```java
@Entity
@Table(name = "workflow_template")
public class WorkflowTemplateEntity extends BaseEntity {

    @TableId(type = IdType.ASSIGN_ID)
    private String templateId;

    @TableField("template_name")
    @NotBlank(message = "æ¨¡æ¿åç§°ä¸èƒ½ä¸ºç©º")
    @Size(max = 100)
    private String templateName;

    @TableField("template_code")
    @NotBlank(message = "æ¨¡æ¿ç¼–ç ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^[A-Z][A-Z0-9_]*$", message = "æ¨¡æ¿ç¼–ç æ ¼å¼ä¸æ­£ç¡®")
    private String templateCode;

    @TableField("template_type")
    @NotBlank(message = "æ¨¡æ¿ç±»å‹ä¸èƒ½ä¸ºç©º")
    private String templateType;

    @TableField("template_category")
    private String templateCategory;

    @TableField("template_description")
    private String templateDescription;

    @TableField("template_config")
    private String templateConfig;  // JSONé…ç½®

    @TableField("bpmn_definition")
    private String bpmnDefinition;  // BPMNæµç¨‹å®šä¹‰

    @TableField("version")
    private Integer version;

    @TableField("status")
    private Integer status;  // 0-è‰ç¨¿ 1-å¯ç”¨ 2-åœç”¨

    @TableField("is_system")
    private Boolean isSystem;  // æ˜¯å¦ç³»ç»Ÿæ¨¡æ¿

    @TableField("create_user_id")
    private String createUserId;

    @TableField("update_user_id")
    private String updateUserId;
}
```

#### 1.2 æµç¨‹æ¨¡æ¿é…ç½®JSONç»“æ„
```json
{
  "templateInfo": {
    "templateName": "æ ‡å‡†è¯·å‡å®¡æ‰¹æµç¨‹",
    "templateCode": "LEAVE_APPROVAL_STANDARD",
    "templateType": "LEAVE",
    "templateCategory": "HR",
    "description": "é€‚ç”¨äºæ ‡å‡†è¯·å‡åœºæ™¯çš„å®¡æ‰¹æµç¨‹",
    "tags": ["HR", "è¯·å‡", "æ ‡å‡†"],
    "icon": "leave-icon",
    "color": "#1890ff"
  },
  "processConfig": {
    "startNode": {
      "nodeId": "start",
      "nodeType": "START",
      "nodeName": "å¼€å§‹",
      "nodePosition": { "x": 100, "y": 200 },
      "config": {
        "formKey": "leave_application_form",
        "autoValidation": true
      }
    },
    "nodes": [
      {
        "nodeId": "manager_approval",
        "nodeType": "APPROVAL",
        "nodeName": "ä¸»ç®¡å®¡æ‰¹",
        "nodePosition": { "x": 300, "y": 200 },
        "config": {
          "approvalType": "SINGLE",
          "approverAssignment": "DIRECT_MANAGER",
          "timeLimit": 24,
          "allowDelegation": true,
          "requireComment": true,
          "actions": ["APPROVE", "REJECT", "TRANSFER"]
        }
      },
      {
        "nodeId": "hr_approval",
        "nodeType": "APPROVAL",
        "nodeName": "HRå®¡æ‰¹",
        "nodePosition": { "x": 500, "y": 200 },
        "config": {
          "approvalType": "SINGLE",
          "approverAssignment": "HR_SPECIALIST",
          "timeLimit": 48,
          "allowDelegation": true,
          "requireComment": true,
          "conditionalApproval": true,
          "conditions": [
            {
              "conditionType": "LEAVE_DAYS",
              "operator": "GT",
              "value": 3
            }
          ]
        }
      }
    ],
    "connections": [
      {
        "from": "start",
        "to": "manager_approval",
        "condition": null
      },
      {
        "from": "manager_approval",
        "to": "hr_approval",
        "condition": {
          "type": "LEAVE_DAYS",
          "operator": "GT",
          "value": 3
        }
      }
    ]
  },
  "notificationConfig": {
    "events": [
      {
        "eventType": "PROCESS_STARTED",
        "notifications": [
          {
            "type": "EMAIL",
            "recipients": ["APPLICANT"],
            "template": "leave_process_started"
          }
        ]
      },
      {
        "eventType": "APPROVAL_COMPLETED",
        "notifications": [
          {
            "type": "EMAIL",
            "recipients": ["APPLICANT", "MANAGER"],
            "template": "leave_approved"
          }
        ]
      }
    ]
  }
}
```

### 2. å¯è§†åŒ–æµç¨‹è®¾è®¡å™¨

#### 2.1 å‰ç«¯æµç¨‹è®¾è®¡å™¨ç»„ä»¶
```vue
<template>
  <div class="workflow-designer">
    <!-- å·¥å…·æ  -->
    <div class="designer-toolbar">
      <el-button-group>
        <el-button type="primary" @click="saveWorkflow">
          <i class="el-icon-save"></i> ä¿å­˜
        </el-button>
        <el-button @click="previewWorkflow">
          <i class="el-icon-view"></i> é¢„è§ˆ
        </el-button>
        <el-button @click="deployWorkflow">
          <i class="el-icon-upload"></i> éƒ¨ç½²
        </el-button>
        <el-button @click="exportBpmn">
          <i class="el-icon-download"></i> å¯¼å‡ºBPMN
        </el-button>
      </el-button-group>

      <el-divider direction="vertical"></el-divider>

      <el-button-group>
        <el-button @click="undo">
          <i class="el-icon-refresh-left"></i> æ’¤é”€
        </el-button>
        <el-button @click="redo">
          <i class="el-icon-refresh-right"></i> é‡åš
        </el-button>
        <el-button @click="clearCanvas">
          <i class="el-icon-delete"></i> æ¸…ç©º
        </el-button>
      </el-button-group>
    </div>

    <!-- è®¾è®¡åŒºåŸŸ -->
    <div class="designer-content">
      <!-- å·¦ä¾§èŠ‚ç‚¹é¢æ¿ -->
      <div class="node-panel">
        <div class="panel-header">
          <h4>æµç¨‹èŠ‚ç‚¹</h4>
        </div>
        <div class="node-categories">
          <el-collapse v-model="activeCategories" accordion>
            <el-collapse-item title="åŸºç¡€èŠ‚ç‚¹" name="basic">
              <div class="node-list">
                <div
                  v-for="node in basicNodes"
                  :key="node.type"
                  class="node-item"
                  draggable="true"
                  @dragstart="handleNodeDragStart(node, $event)"
                >
                  <div class="node-icon" :class="node.iconClass"></div>
                  <span class="node-name">{{ node.name }}</span>
                </div>
              </div>
            </el-collapse-item>

            <el-collapse-item title="å®¡æ‰¹èŠ‚ç‚¹" name="approval">
              <div class="node-list">
                <div
                  v-for="node in approvalNodes"
                  :key="node.type"
                  class="node-item"
                  draggable="true"
                  @dragstart="handleNodeDragStart(node, $event)"
                >
                  <div class="node-icon" :class="node.iconClass"></div>
                  <span class="node-name">{{ node.name }}</span>
                </div>
              </div>
            </el-collapse-item>

            <el-collapse-item title="ç½‘å…³èŠ‚ç‚¹" name="gateway">
              <div class="node-list">
                <div
                  v-for="node in gatewayNodes"
                  :key="node.type"
                  class="node-item"
                  draggable="true"
                  @dragstart="handleNodeDragStart(node, $event)"
                >
                  <div class="node-icon" :class="node.iconClass"></div>
                  <span class="node-name">{{ node.name }}</span>
                </div>
              </div>
            </el-collapse-item>
          </el-collapse>
        </div>
      </div>

      <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
      <div class="design-canvas" ref="designCanvas">
        <canvas
          ref="workflowCanvas"
          :width="canvasWidth"
          :height="canvasHeight"
          @drop="handleCanvasDrop"
          @dragover="handleCanvasDragOver"
        ></canvas>

        <!-- ç¼©æ”¾æ§åˆ¶ -->
        <div class="zoom-controls">
          <el-button-group>
            <el-button size="small" @click="zoomIn">
              <i class="el-icon-zoom-in"></i>
            </el-button>
            <el-button size="small">{{ zoomLevel }}%</el-button>
            <el-button size="small" @click="zoomOut">
              <i class="el-icon-zoom-out"></i>
            </el-button>
            <el-button size="small" @click="zoomFit">
              <i class="el-icon-full-screen"></i>
            </el-button>
          </el-button-group>
        </div>
      </div>

      <!-- å³ä¾§å±æ€§é¢æ¿ -->
      <div class="property-panel" v-if="selectedNode">
        <div class="panel-header">
          <h4>èŠ‚ç‚¹å±æ€§</h4>
          <el-button size="mini" @click="closePropertyPanel">
            <i class="el-icon-close"></i>
          </el-button>
        </div>

        <div class="panel-content">
          <!-- åŸºç¡€å±æ€§ -->
          <el-form :model="nodeProperties" label-width="100px" size="small">
            <el-form-item label="èŠ‚ç‚¹ID">
              <el-input v-model="nodeProperties.nodeId" disabled></el-input>
            </el-form-item>

            <el-form-item label="èŠ‚ç‚¹åç§°">
              <el-input v-model="nodeProperties.nodeName" placeholder="è¯·è¾“å…¥èŠ‚ç‚¹åç§°"></el-input>
            </el-form-item>

            <!-- å®¡æ‰¹èŠ‚ç‚¹å±æ€§ -->
            <template v-if="selectedNode.nodeType === 'APPROVAL'">
              <el-form-item label="å®¡æ‰¹ç±»å‹">
                <el-select v-model="nodeProperties.approvalType">
                  <el-option label="å•äººå®¡æ‰¹" value="SINGLE"></el-option>
                  <el-option label="å¤šäººå®¡æ‰¹" value="MULTIPLE"></el-option>
                  <el-option label="ä¼šç­¾å®¡æ‰¹" value="JOINT"></el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="å®¡æ‰¹äººåˆ†é…">
                <el-select v-model="nodeProperties.approverAssignment">
                  <el-option label="ç›´æ¥ä¸»ç®¡" value="DIRECT_MANAGER"></el-option>
                  <el-option label="éƒ¨é—¨è´Ÿè´£äºº" value="DEPARTMENT_HEAD"></el-option>
                  <el-option label="HRä¸“å‘˜" value="HR_SPECIALIST"></el-option>
                  <el-option label="æŒ‡å®šäººå‘˜" value="SPECIFIC_USER"></el-option>
                  <el-option label="è§’è‰²" value="ROLE"></el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="æŒ‡å®šäººå‘˜" v-if="nodeProperties.approverAssignment === 'SPECIFIC_USER'">
                <el-select
                  v-model="nodeProperties.specificApprovers"
                  multiple
                  filterable
                  remote
                  reserve-keyword
                  placeholder="è¯·é€‰æ‹©å®¡æ‰¹äºº"
                  :remote-method="searchUsers"
                  :loading="userSearchLoading"
                >
                  <el-option
                    v-for="user in userOptions"
                    :key="user.id"
                    :label="user.name"
                    :value="user.id"
                  ></el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="æ—¶é—´é™åˆ¶">
                <el-input-number
                  v-model="nodeProperties.timeLimit"
                  :min="1"
                  :max="168"
                  controls-position="right"
                >
                  <template slot="append">å°æ—¶</template>
                </el-input-number>
              </el-form-item>

              <el-form-item label="å…è®¸è½¬åŠ">
                <el-switch v-model="nodeProperties.allowDelegation"></el-switch>
              </el-form-item>

              <el-form-item label="å¿…é¡»å¡«å†™æ„è§">
                <el-switch v-model="nodeProperties.requireComment"></el-switch>
              </el-form-item>
            </template>

            <!-- ç½‘å…³èŠ‚ç‚¹å±æ€§ -->
            <template v-if="isGatewayNode(selectedNode.nodeType)">
              <el-form-item label="ç½‘å…³ç±»å‹">
                <el-select v-model="nodeProperties.gatewayType" disabled>
                  <el-option label="æ’ä»–ç½‘å…³" value="EXCLUSIVE"></el-option>
                  <el-option label="å¹¶è¡Œç½‘å…³" value="PARALLEL"></el-option>
                  <el-option label="åŒ…å®¹ç½‘å…³" value="INCLUSIVE"></el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="åˆ†æ”¯æ¡ä»¶" v-if="nodeProperties.gatewayType !== 'PARALLEL'">
                <div class="condition-list">
                  <div
                    v-for="(condition, index) in nodeProperties.branchConditions"
                    :key="index"
                    class="condition-item"
                  >
                    <el-row :gutter="10">
                      <el-col :span="6">
                        <el-select v-model="condition.field" placeholder="å­—æ®µ">
                          <el-option label="è¯·å‡å¤©æ•°" value="leaveDays"></el-option>
                          <el-option label="è¯·å‡ç±»å‹" value="leaveType"></el-option>
                          <el-option label="ç”³è¯·é‡‘é¢" value="amount"></el-option>
                        </el-select>
                      </el-col>
                      <el-col :span="6">
                        <el-select v-model="condition.operator" placeholder="æ“ä½œç¬¦">
                          <el-option label="ç­‰äº" value="EQ"></el-option>
                          <el-option label="ä¸ç­‰äº" value="NE"></el-option>
                          <el-option label="å¤§äº" value="GT"></el-option>
                          <el-option label="å°äº" value="LT"></el-option>
                          <el-option label="å¤§äºç­‰äº" value="GTE"></el-option>
                          <el-option label="å°äºç­‰äº" value="LTE"></el-option>
                        </el-select>
                      </el-col>
                      <el-col :span="6">
                        <el-input v-model="condition.value" placeholder="å€¼"></el-input>
                      </el-col>
                      <el-col :span="4">
                        <el-button
                          size="mini"
                          type="danger"
                          icon="el-icon-delete"
                          @click="removeCondition(index)"
                        ></el-button>
                      </el-col>
                    </el-row>
                  </div>
                  <el-button
                    size="mini"
                    type="primary"
                    @click="addCondition"
                  >
                    æ·»åŠ æ¡ä»¶
                  </el-button>
                </div>
              </el-form-item>
            </template>
          </el-form>
        </div>
      </div>
    </div>

    <!-- é¢„è§ˆå¯¹è¯æ¡† -->
    <el-dialog
      title="æµç¨‹é¢„è§ˆ"
      :visible.sync="previewVisible"
      width="80%"
      top="5vh"
    >
      <div class="workflow-preview">
        <div class="preview-header">
          <h3>{{ workflowConfig.templateInfo.templateName }}</h3>
          <p>{{ workflowConfig.templateInfo.templateDescription }}</p>
        </div>
        <div class="preview-content">
          <!-- è¿™é‡Œæ˜¾ç¤ºæµç¨‹å›¾é¢„è§ˆ -->
          <workflow-preview-diagram :config="workflowConfig"></workflow-preview-diagram>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import WorkflowPreviewDiagram from './WorkflowPreviewDiagram.vue';

export default {
  name: 'WorkflowDesigner',

  components: {
    WorkflowPreviewDiagram
  },

  data() {
    return {
      workflowConfig: {},
      selectedNode: null,
      nodeProperties: {},
      zoomLevel: 100,
      canvasWidth: 1200,
      canvasHeight: 800,
      activeCategories: ['basic'],
      previewVisible: false,
      userOptions: [],
      userSearchLoading: false,

      // èŠ‚ç‚¹ç±»å‹å®šä¹‰
      basicNodes: [
        { type: 'START', name: 'å¼€å§‹èŠ‚ç‚¹', iconClass: 'node-start' },
        { type: 'END', name: 'ç»“æŸèŠ‚ç‚¹', iconClass: 'node-end' },
        { type: 'TASK', name: 'ä»»åŠ¡èŠ‚ç‚¹', iconClass: 'node-task' }
      ],

      approvalNodes: [
        { type: 'APPROVAL', name: 'å®¡æ‰¹èŠ‚ç‚¹', iconClass: 'node-approval' },
        { type: 'COUNTER_SIGN', name: 'ä¼šç­¾èŠ‚ç‚¹', iconClass: 'node-counter-sign' }
      ],

      gatewayNodes: [
        { type: 'EXCLUSIVE_GATEWAY', name: 'æ’ä»–ç½‘å…³', iconClass: 'node-gateway-exclusive' },
        { type: 'PARALLEL_GATEWAY', name: 'å¹¶è¡Œç½‘å…³', iconClass: 'node-gateway-parallel' },
        { type: 'INCLUSIVE_GATEWAY', name: 'åŒ…å®¹ç½‘å…³', iconClass: 'node-gateway-inclusive' }
      ]
    };
  },

  methods: {
    // èŠ‚ç‚¹æ‹–æ‹½å¼€å§‹
    handleNodeDragStart(node, event) {
      event.dataTransfer.setData('application/json', JSON.stringify(node));
      event.dataTransfer.effectAllowed = 'copy';
    },

    // ç”»å¸ƒæ‹–æ‹½é‡Šæ”¾
    handleCanvasDrop(event) {
      event.preventDefault();

      const nodeData = JSON.parse(event.dataTransfer.getData('application/json'));
      const canvasRect = this.$refs.workflowCanvas.getBoundingClientRect();

      const x = event.clientX - canvasRect.left;
      const y = event.clientY - canvasRect.top;

      this.addNodeToCanvas(nodeData, x, y);
    },

    // æ·»åŠ èŠ‚ç‚¹åˆ°ç”»å¸ƒ
    addNodeToCanvas(nodeData, x, y) {
      const newNode = {
        nodeId: this.generateNodeId(nodeData.type),
        nodeType: nodeData.type,
        nodeName: nodeData.name,
        nodePosition: { x, y },
        config: this.getDefaultNodeConfig(nodeData.type)
      };

      this.workflowConfig.processConfig.nodes.push(newNode);
      this.renderNode(newNode);
    },

    // ç”ŸæˆèŠ‚ç‚¹ID
    generateNodeId(nodeType) {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000);
      return `${nodeType.toLowerCase()}_${timestamp}_${random}`;
    },

    // è·å–èŠ‚ç‚¹é»˜è®¤é…ç½®
    getDefaultNodeConfig(nodeType) {
      const configs = {
        START: {
          formKey: 'application_form',
          autoValidation: true
        },
        APPROVAL: {
          approvalType: 'SINGLE',
          approverAssignment: 'DIRECT_MANAGER',
          timeLimit: 24,
          allowDelegation: true,
          requireComment: true
        },
        END: {
          autoActions: ['NOTIFY_APPLICANT', 'UPDATE_STATUS']
        }
      };

      return configs[nodeType] || {};
    },

    // æ¸²æŸ“èŠ‚ç‚¹
    renderNode(node) {
      const canvas = this.$refs.workflowCanvas;
      const ctx = canvas.getContext('2d');

      // ç»˜åˆ¶èŠ‚ç‚¹çŸ©å½¢
      ctx.fillStyle = this.getNodeColor(node.nodeType);
      ctx.fillRect(node.nodePosition.x, node.nodePosition.y, 120, 60);

      // ç»˜åˆ¶èŠ‚ç‚¹æ–‡æœ¬
      ctx.fillStyle = '#333';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(node.nodeName, node.nodePosition.x + 60, node.nodePosition.y + 30);
    },

    // è·å–èŠ‚ç‚¹é¢œè‰²
    getNodeColor(nodeType) {
      const colors = {
        START: '#52c41a',
        END: '#ff4d4f',
        TASK: '#1890ff',
        APPROVAL: '#722ed1',
        GATEWAY: '#faad14'
      };

      return colors[nodeType] || '#d9d9d9';
    },

    // ä¿å­˜å·¥ä½œæµé…ç½®
    async saveWorkflow() {
      try {
        // éªŒè¯é…ç½®
        const validationResult = this.validateWorkflowConfig();
        if (!validationResult.valid) {
          this.$message.error('é…ç½®éªŒè¯å¤±è´¥: ' + validationResult.message);
          return;
        }

        // ä¿å­˜é…ç½®
        const response = await this.$http.post('/api/workflow/template/save', {
          templateId: this.workflowConfig.templateId,
          config: this.workflowConfig
        });

        this.$message.success('ä¿å­˜æˆåŠŸ');
      } catch (error) {
        this.$message.error('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    },

    // éªŒè¯å·¥ä½œæµé…ç½®
    validateWorkflowConfig() {
      const config = this.workflowConfig.processConfig;

      // æ£€æŸ¥æ˜¯å¦æœ‰å¼€å§‹èŠ‚ç‚¹
      const startNode = config.nodes.find(node => node.nodeType === 'START');
      if (!startNode) {
        return { valid: false, message: 'ç¼ºå°‘å¼€å§‹èŠ‚ç‚¹' };
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æŸèŠ‚ç‚¹
      const endNode = config.nodes.find(node => node.nodeType === 'END');
      if (!endNode) {
        return { valid: false, message: 'ç¼ºå°‘ç»“æŸèŠ‚ç‚¹' };
      }

      // æ£€æŸ¥è¿æ¥å®Œæ•´æ€§
      // TODO: å®ç°è¿æ¥éªŒè¯é€»è¾‘

      return { valid: true };
    },

    // é¢„è§ˆå·¥ä½œæµ
    previewWorkflow() {
      this.previewVisible = true;
    },

    // éƒ¨ç½²å·¥ä½œæµ
    async deployWorkflow() {
      try {
        const response = await this.$http.post('/api/workflow/template/deploy', {
          templateId: this.workflowConfig.templateId
        });

        this.$message.success('éƒ¨ç½²æˆåŠŸ');
      } catch (error) {
        this.$message.error('éƒ¨ç½²å¤±è´¥: ' + error.message);
      }
    },

    // å¯¼å‡ºBPMN
    exportBpmn() {
      // è°ƒç”¨åç«¯ç”ŸæˆBPMNæ–‡ä»¶
      this.$http.get('/api/workflow/template/export-bpmn', {
        params: { templateId: this.workflowConfig.templateId },
        responseType: 'blob'
      }).then(response => {
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.download = `${this.workflowConfig.templateInfo.templateName}.bpmn`;
        link.click();
        window.URL.revokeObjectURL(url);
      });
    },

    // æœç´¢ç”¨æˆ·
    searchUsers(query) {
      this.userSearchLoading = true;

      this.$http.get('/api/system/users/search', {
        params: { keyword: query }
      }).then(response => {
        this.userOptions = response.data;
      }).finally(() => {
        this.userSearchLoading = false;
      });
    },

    // æ·»åŠ æ¡ä»¶
    addCondition() {
      if (!this.nodeProperties.branchConditions) {
        this.$set(this.nodeProperties, 'branchConditions', []);
      }

      this.nodeProperties.branchConditions.push({
        field: '',
        operator: 'EQ',
        value: ''
      });
    },

    // ç§»é™¤æ¡ä»¶
    removeCondition(index) {
      this.nodeProperties.branchConditions.splice(index, 1);
    }
  }
};
</script>
```

### 3. åç«¯é…ç½®ç®¡ç†æœåŠ¡

#### 3.1 é…ç½®ç®¡ç†æœåŠ¡
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class WorkflowConfigService {

    @Resource
    private WorkflowTemplateDao templateDao;

    @Resource
    private WorkflowEngine workflowEngine;

    @Resource
    private BpmnGenerator bpmnGenerator;

    /**
     * ä¿å­˜æµç¨‹é…ç½®
     */
    public WorkflowConfigResult saveConfig(WorkflowConfigRequest request) {
        WorkflowConfigResult result = new WorkflowConfigResult();

        try {
            // 1. éªŒè¯é…ç½®
            ValidationResult validation = validateConfig(request.getConfig());
            if (!validation.isValid()) {
                result.setSuccess(false);
                result.setMessage("é…ç½®éªŒè¯å¤±è´¥: " + validation.getMessage());
                return result;
            }

            // 2. ä¿å­˜é…ç½®
            WorkflowTemplateEntity template = new WorkflowTemplateEntity();

            if (StringUtils.isNotBlank(request.getTemplateId())) {
                // æ›´æ–°ç°æœ‰æ¨¡æ¿
                template = templateDao.selectById(request.getTemplateId());
                if (template == null) {
                    throw new IllegalArgumentException("æ¨¡æ¿ä¸å­˜åœ¨");
                }
                template.setUpdateTime(LocalDateTime.now());
                template.setUpdateUserId(request.getCurrentUserId());
            } else {
                // åˆ›å»ºæ–°æ¨¡æ¿
                template.setTemplateId(generateTemplateId());
                template.setCreateTime(LocalDateTime.now());
                template.setCreateUserId(request.getCurrentUserId());
                template.setVersion(1);
                template.setStatus(0); // è‰ç¨¿çŠ¶æ€
            }

            // è®¾ç½®åŸºç¡€ä¿¡æ¯
            template.setTemplateName(request.getConfig().getTemplateInfo().getTemplateName());
            template.setTemplateCode(request.getConfig().getTemplateInfo().getTemplateCode());
            template.setTemplateType(request.getConfig().getTemplateInfo().getTemplateType());
            template.setTemplateDescription(request.getConfig().getTemplateInfo().getTemplateDescription());
            template.setTemplateConfig(JSON.toJSONString(request.getConfig()));

            // ç”ŸæˆBPMNå®šä¹‰
            String bpmnXml = bpmnGenerator.generateBpmn(request.getConfig());
            template.setBpmnDefinition(bpmnXml);

            // ä¿å­˜åˆ°æ•°æ®åº“
            if (StringUtils.isNotBlank(request.getTemplateId())) {
                templateDao.updateById(template);
            } else {
                templateDao.insert(template);
            }

            result.setTemplateId(template.getTemplateId());
            result.setSuccess(true);
            result.setMessage("é…ç½®ä¿å­˜æˆåŠŸ");

        } catch (Exception e) {
            result.setSuccess(false);
            result.setMessage("é…ç½®ä¿å­˜å¤±è´¥: " + e.getMessage());
        }

        return result;
    }

    /**
     * éƒ¨ç½²æµç¨‹
     */
    public WorkflowDeployResult deployWorkflow(String templateId) {
        WorkflowDeployResult result = new WorkflowDeployResult();

        try {
            // 1. è·å–æ¨¡æ¿
            WorkflowTemplateEntity template = templateDao.selectById(templateId);
            if (template == null) {
                throw new IllegalArgumentException("æ¨¡æ¿ä¸å­˜åœ¨");
            }

            // 2. æ£€æŸ¥æ¨¡æ¿çŠ¶æ€
            if (template.getStatus() != 1) {
                // æ›´æ–°çŠ¶æ€ä¸ºå¯ç”¨
                template.setStatus(1);
                templateDao.updateById(template);
            }

            // 3. éƒ¨ç½²åˆ°å·¥ä½œæµå¼•æ“
            Deployment deployment = workflowEngine.getRepositoryService()
                .createDeployment()
                .name(template.getTemplateName())
                .addString(template.getBpmnDefinition(), template.getBpmnDefinition())
                .deploy();

            // 4. æ›´æ–°éƒ¨ç½²ä¿¡æ¯
            template.setDeploymentId(deployment.getId());
            template.setDeployTime(LocalDateTime.now());
            templateDao.updateById(template);

            result.setDeploymentId(deployment.getId());
            result.setProcessDefinitionKey(deployment.getDeployedProcessDefinitions().get(0).getKey());
            result.setSuccess(true);
            result.setMessage("æµç¨‹éƒ¨ç½²æˆåŠŸ");

        } catch (Exception e) {
            result.setSuccess(false);
            result.setMessage("æµç¨‹éƒ¨ç½²å¤±è´¥: " + e.getMessage());
        }

        return result;
    }

    /**
     * éªŒè¯é…ç½®
     */
    private ValidationResult validateConfig(WorkflowConfig config) {
        ValidationResult validation = new ValidationResult();

        // 1. éªŒè¯åŸºç¡€ä¿¡æ¯
        if (config.getTemplateInfo() == null) {
            validation.addError("æ¨¡æ¿åŸºç¡€ä¿¡æ¯ä¸èƒ½ä¸ºç©º");
        }

        if (StringUtils.isBlank(config.getTemplateInfo().getTemplateName())) {
            validation.addError("æ¨¡æ¿åç§°ä¸èƒ½ä¸ºç©º");
        }

        if (StringUtils.isBlank(config.getTemplateInfo().getTemplateCode())) {
            validation.addError("æ¨¡æ¿ç¼–ç ä¸èƒ½ä¸ºç©º");
        }

        // 2. éªŒè¯æµç¨‹é…ç½®
        ProcessConfig processConfig = config.getProcessConfig();
        if (processConfig == null) {
            validation.addError("æµç¨‹é…ç½®ä¸èƒ½ä¸ºç©º");
            return validation;
        }

        // 3. éªŒè¯èŠ‚ç‚¹é…ç½®
        List<NodeConfig> nodes = processConfig.getNodes();
        if (nodes == null || nodes.isEmpty()) {
            validation.addError("æµç¨‹èŠ‚ç‚¹ä¸èƒ½ä¸ºç©º");
            return validation;
        }

        // æ£€æŸ¥å¼€å§‹èŠ‚ç‚¹
        boolean hasStartNode = nodes.stream().anyMatch(node -> "START".equals(node.getNodeType()));
        if (!hasStartNode) {
            validation.addError("æµç¨‹å¿…é¡»åŒ…å«å¼€å§‹èŠ‚ç‚¹");
        }

        // æ£€æŸ¥ç»“æŸèŠ‚ç‚¹
        boolean hasEndNode = nodes.stream().anyMatch(node -> "END".equals(node.getNodeType()));
        if (!hasEndNode) {
            validation.addError("æµç¨‹å¿…é¡»åŒ…å«ç»“æŸèŠ‚ç‚¹");
        }

        // 4. éªŒè¯è¿æ¥é…ç½®
        List<ConnectionConfig> connections = processConfig.getConnections();
        if (connections != null) {
            for (ConnectionConfig connection : connections) {
                if (!nodeExists(nodes, connection.getFrom())) {
                    validation.addError("è¿æ¥èµ·å§‹èŠ‚ç‚¹ä¸å­˜åœ¨: " + connection.getFrom());
                }

                if (!nodeExists(nodes, connection.getTo())) {
                    validation.addError("è¿æ¥ç›®æ ‡èŠ‚ç‚¹ä¸å­˜åœ¨: " + connection.getTo());
                }
            }
        }

        // 5. éªŒè¯å®¡æ‰¹èŠ‚ç‚¹é…ç½®
        for (NodeConfig node : nodes) {
            if ("APPROVAL".equals(node.getNodeType()) || "COUNTER_SIGN".equals(node.getNodeType())) {
                validateApprovalNode(node, validation);
            }
        }

        return validation;
    }

    private void validateApprovalNode(NodeConfig node, ValidationResult validation) {
        NodeConfig config = node.getConfig();

        if (config == null) {
            validation.addError("å®¡æ‰¹èŠ‚ç‚¹é…ç½®ä¸èƒ½ä¸ºç©º: " + node.getNodeId());
            return;
        }

        // éªŒè¯å®¡æ‰¹äººåˆ†é…
        if (StringUtils.isBlank(config.getApproverAssignment())) {
            validation.addError("å®¡æ‰¹èŠ‚ç‚¹å¿…é¡»é…ç½®å®¡æ‰¹äººåˆ†é…æ–¹å¼: " + node.getNodeId());
        }

        // éªŒè¯æ—¶é—´é™åˆ¶
        if (config.getTimeLimit() != null && config.getTimeLimit() <= 0) {
            validation.addError("å®¡æ‰¹æ—¶é—´é™åˆ¶å¿…é¡»å¤§äº0: " + node.getNodeId());
        }
    }

    private boolean nodeExists(List<NodeConfig> nodes, String nodeId) {
        return nodes.stream().anyMatch(node -> nodeId.equals(node.getNodeId()));
    }

    private String generateTemplateId() {
        return "TEMPLATE_" + System.currentTimeMillis() + "_" + UUID.randomUUID().toString().substring(0, 8).toUpperCase();
    }
}
```

### 4. BPMNç”Ÿæˆå™¨

#### 4.1 BPMN XMLç”ŸæˆæœåŠ¡
```java
@Service
public class BpmnGenerator {

    /**
     * ç”ŸæˆBPMN XML
     */
    public String generateBpmn(WorkflowConfig config) {
        try {
            Definitions definitions = new Definitions();

            // è®¾ç½®ç›®æ ‡å‘½åç©ºé—´
            definitions.setTargetNamespace("http://bpmn.io/bpmn20");

            // åˆ›å»ºæµç¨‹
            Process process = new Process();
            process.setId(config.getTemplateInfo().getTemplateCode());
            process.setName(config.getTemplateInfo().getTemplateName());
            process.setExecutable(true);

            // æ·»åŠ æµç¨‹å®šä¹‰
            definitions.getRootElements().add(process);

            // ç”ŸæˆèŠ‚ç‚¹
            Map<String, FlowNode> nodeMap = new HashMap<>();
            for (NodeConfig nodeConfig : config.getProcessConfig().getNodes()) {
                FlowNode bpmnNode = createBpmnNode(nodeConfig);
                nodeMap.put(nodeConfig.getNodeId(), bpmnNode);
                process.addChildElement(bpmnNode);
            }

            // ç”Ÿæˆè¿æ¥
            for (ConnectionConfig connectionConfig : config.getProcessConfig().getConnections()) {
                createBpmnSequence(process, nodeMap, connectionConfig);
            }

            // ç”ŸæˆXML
            BpmnModel bpmnModel = new BpmnModel();
            bpmnModel.addProcess(process);

            return convertToXml(bpmnModel);

        } catch (Exception e) {
            throw new RuntimeException("ç”ŸæˆBPMN XMLå¤±è´¥", e);
        }
    }

    private FlowNode createBpmnNode(NodeConfig nodeConfig) {
        switch (nodeConfig.getNodeType()) {
            case "START":
                return createStartEvent(nodeConfig);

            case "END":
                return createEndEvent(nodeConfig);

            case "APPROVAL":
                return createUserTask(nodeConfig);

            case "COUNTER_SIGN":
                return createMultiInstanceTask(nodeConfig);

            case "TASK":
                return createServiceTask(nodeConfig);

            case "EXCLUSIVE_GATEWAY":
                return createExclusiveGateway(nodeConfig);

            case "PARALLEL_GATEWAY":
                return createParallelGateway(nodeConfig);

            default:
                throw new IllegalArgumentException("ä¸æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹: " + nodeConfig.getNodeType());
        }
    }

    private StartEvent createStartEvent(NodeConfig nodeConfig) {
        StartEvent startEvent = new StartEvent();
        startEvent.setId(nodeConfig.getNodeId());
        startEvent.setName(nodeConfig.getNodeName());

        // è®¾ç½®è¡¨å•key
        if (nodeConfig.getConfig() != null) {
            String formKey = nodeConfig.getConfig().get("formKey");
            if (StringUtils.isNotBlank(formKey)) {
                startEvent.setCamundaFormKey(formKey);
            }
        }

        return startEvent;
    }

    private UserTask createUserTask(NodeConfig nodeConfig) {
        UserTask userTask = new UserTask();
        userTask.setId(nodeConfig.getNodeId());
        userTask.setName(nodeConfig.getNodeName());

        // è®¾ç½®å®¡æ‰¹äººåˆ†é…
        String approverAssignment = nodeConfig.getConfig().get("approverAssignment");
        if (StringUtils.isNotBlank(approverAssignment)) {
            switch (approverAssignment) {
                case "DIRECT_MANAGER":
                    userTask.setCamundaAssignee("${directManager}");
                    break;
                case "DEPARTMENT_HEAD":
                    userTask.setCamundaCandidateGroups("${departmentHeadGroup}");
                    break;
                case "HR_SPECIALIST":
                    userTask.setCamundaCandidateGroups("${hrSpecialistGroup}");
                    break;
                case "SPECIFIC_USER":
                    List<String> specificApprovers = nodeConfig.getConfig().get("specificApprovers");
                    userTask.setCamundaAssignee("${specificApprover}");
                    // TODO: å¤„ç†å¤šç”¨æˆ·åˆ†é…
                    break;
                case "ROLE":
                    String role = nodeConfig.getConfig().get("role");
                    userTask.setCamundaCandidateGroups(role);
                    break;
            }
        }

        // è®¾ç½®æ—¶é—´é™åˆ¶
        Integer timeLimit = nodeConfig.getConfig().get("timeLimit");
        if (timeLimit != null && timeLimit > 0) {
            userTask.setCamundaTaskPriority(timeLimit.toString());
        }

        return userTask;
    }

    private void createBpmnSequence(Process process, Map<String, FlowNode> nodeMap, ConnectionConfig connectionConfig) {
        SequenceFlow sequenceFlow = new SequenceFlow();
        sequenceFlow.setId(generateSequenceFlowId());

        FlowNode sourceNode = nodeMap.get(connectionConfig.getFrom());
        FlowNode targetNode = nodeMap.get(connectionConfig.getTo());

        sequenceFlow.setSourceRef(sourceNode.getId());
        sequenceFlow.setTargetRef(targetNode.getId());

        // è®¾ç½®æ¡ä»¶è¡¨è¾¾å¼
        if (connectionConfig.getCondition() != null) {
            String conditionExpression = generateConditionExpression(connectionConfig.getCondition());
            sequenceFlow.setConditionExpression(conditionExpression);
        }

        // æ·»åŠ åˆ°æºèŠ‚ç‚¹çš„æµå‡º
        if (sourceNode instanceof FlowNode) {
            sourceNode.getOutgoingFlows().add(sequenceFlow);
        }
    }

    private String generateConditionExpression(ConditionConfig condition) {
        StringBuilder expression = new StringBuilder();
        expression.append("${");

        expression.append(condition.getField());

        String operator = mapOperator(condition.getOperator());
        expression.append(" ").append(operator).append(" ");

        if ("String".equals(condition.getType())) {
            expression.append("'").append(condition.getValue()).append("'");
        } else {
            expression.append(condition.getValue());
        }

        expression.append("}");

        return expression.toString();
    }

    private String mapOperator(String operator) {
        Map<String, String> operatorMap = Map.of(
            "EQ", "==",
            "NE", "!=",
            "GT", ">",
            "LT", "<",
            "GTE", ">=",
            "LTE", "<="
        );

        return operatorMap.getOrDefault(operator, "==");
    }

    private String convertToXml(BpmnModel bpmnModel) {
        try {
            BpmnXMLConverter converter = new BpmnXMLConverter();
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
            converter.convertToXML(bpmnModel, outputStream);
            return outputStream.toString("UTF-8");
        } catch (Exception e) {
            throw new RuntimeException("BPMNè½¬XMLå¤±è´¥", e);
        }
    }
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾
```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[æµç¨‹è®¾è®¡å™¨]
        B[é…ç½®ç®¡ç†ç•Œé¢]
        C[æµç¨‹é¢„è§ˆ]
    end

    subgraph "APIå±‚"
        D[é…ç½®ç®¡ç†API]
        E[æ¨¡æ¿ç®¡ç†API]
        F[éƒ¨ç½²ç®¡ç†API]
    end

    subgraph "æœåŠ¡å±‚"
        G[é…ç½®ç®¡ç†æœåŠ¡]
        H[æ¨¡æ¿æœåŠ¡]
        I[BPMNç”Ÿæˆå™¨]
        J[éªŒè¯æœåŠ¡]
    end

    subgraph "å¼•æ“å±‚"
        K[Flowableå¼•æ“]
        L[è§„åˆ™å¼•æ“]
        M[è¡¨å•å¼•æ“]
    end

    subgraph "æ•°æ®å±‚"
        N[MySQLé…ç½®åº“]
        O[æµç¨‹å®ä¾‹åº“]
        P[Redisç¼“å­˜]
    end

    A --> D
    B --> D
    C --> D

    D --> G
    E --> H
    F --> G

    G --> I
    G --> J
    H --> K

    I --> K
    J --> L
    K --> M

    G --> N
    K --> O
    G --> P
```

### æ ¸å¿ƒä¾èµ–é…ç½®
```xml
<!-- pom.xml ä¾èµ–é…ç½® -->
<dependencies>
    <!-- Flowableå·¥ä½œæµå¼•æ“ -->
    <dependency>
        <groupId>org.flowable</groupId>
        <artifactId>flowable-spring-boot-starter</artifactId>
        <version>7.0.1</version>
    </dependency>

    <!-- BPMNæ¨¡å‹å¤„ç† -->
    <dependency>
        <groupId>org.flowable</groupId>
        <artifactId>flowable-bpmn-model</artifactId>
        <version>7.0.1</version>
    </dependency>

    <!-- è§„åˆ™å¼•æ“ -->
    <dependency>
        <groupId>org.drools</groupId>
        <artifactId>drools-core</artifactId>
        <version>8.44.0.Final</version>
    </dependency>

    <!-- è¡¨å•å¼•æ“ -->
    <dependency>
        <groupId>org.flowable</groupId>
        <artifactId>flowable-form-model</artifactId>
        <version>7.0.1</version>
    </dependency>

    <!-- JSONå¤„ç† -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>2.0.58</version>
    </dependency>
</dependencies>
```

---

## ğŸ“Š é…ç½®ç®¡ç†API

### RESTful APIè®¾è®¡
```java
@RestController
@RequestMapping("/api/workflow")
public class WorkflowConfigController {

    @Resource
    private WorkflowConfigService configService;

    @PostMapping("/template/save")
    public ResponseDTO<String> saveTemplate(@Valid @RequestBody WorkflowConfigRequest request) {
        WorkflowConfigResult result = configService.saveConfig(request);
        return ResponseDTO.ok(result.getTemplateId());
    }

    @GetMapping("/template/list")
    public ResponseDTO<List<WorkflowTemplateVO>> listTemplates(
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String status) {
        List<WorkflowTemplateVO> templates = configService.listTemplates(type, status);
        return ResponseDTO.ok(templates);
    }

    @GetMapping("/template/{templateId}")
    public ResponseDTO<WorkflowTemplateVO> getTemplate(@PathVariable String templateId) {
        WorkflowTemplateVO template = configService.getTemplate(templateId);
        return ResponseDTO.ok(template);
    }

    @PostMapping("/template/{templateId}/deploy")
    public ResponseDTO<WorkflowDeployVO> deployTemplate(@PathVariable String templateId) {
        WorkflowDeployResult result = configService.deployWorkflow(templateId);
        return ResponseDTO.ok(WorkflowDeployVO.builder()
            .deploymentId(result.getDeploymentId())
            .processDefinitionKey(result.getProcessDefinitionKey())
            .build());
    }

    @GetMapping("/template/{templateId}/export/bpmn")
    public void exportBpmn(@PathVariable String templateId, HttpServletResponse response) {
        configService.exportBpmn(templateId, response);
    }

    @PostMapping("/template/import")
    public ResponseDTO<String> importTemplate(@RequestParam("file") MultipartFile file) {
        String templateId = configService.importTemplate(file);
        return ResponseDTO.ok(templateId);
    }

    @GetMapping("/template/{templateId}/preview")
    public ResponseDTO<WorkflowPreviewVO> previewTemplate(@PathVariable String templateId) {
        WorkflowPreviewVO preview = configService.previewTemplate(templateId);
        return ResponseDTO.ok(preview);
    }

    @PostMapping("/template/{templateId}/validate")
    public ResponseDTO<ValidationResultVO> validateTemplate(@PathVariable String templateId) {
        ValidationResult result = configService.validateTemplate(templateId);
        return ResponseDTO.ok(ValidationResultVO.builder()
            .valid(result.isValid())
            .errors(result.getErrors())
            .warnings(result.getWarnings())
            .build());
    }
}
```

---

## ğŸ¯ ä½¿ç”¨æµç¨‹å’Œæœ€ä½³å®è·µ

### 1. é…ç½®æµç¨‹æœ€ä½³å®è·µ

#### 1.1 æµç¨‹è®¾è®¡åŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªæµç¨‹ä¸“æ³¨ä¸€ç§ä¸šåŠ¡åœºæ™¯
- **èŠ‚ç‚¹ç²¾ç®€**: é¿å…è¿‡åº¦å¤æ‚çš„èŠ‚ç‚¹é…ç½®
- **æ¡ä»¶æ˜ç¡®**: åˆ†æ”¯æ¡ä»¶æ¸…æ™°å¯ç†è§£
- **æƒé™åˆç†**: å®¡æ‰¹äººåˆ†é…ç¬¦åˆä¸šåŠ¡è§„åˆ™

#### 1.2 å‘½åè§„èŒƒ
```java
// æ¨¡æ¿ç¼–ç å‘½åè§„èŒƒ
TEMPLATE_{ä¸šåŠ¡ç±»å‹}_{åœºæ™¯}_{ç‰ˆæœ¬}
// ç¤ºä¾‹:
TEMPLATE_LEAVE_STANDARD_001
TEMPLATE_EXPENSE_SIMPLE_001
TEMPLATE_ACCESS_PERMISSION_001

// èŠ‚ç‚¹IDå‘½åè§„èŒƒ
{èŠ‚ç‚¹ç±»å‹}_{åºå·}_{æè¿°}
// ç¤ºä¾‹:
START_001
APPROVAL_MANAGER_001
GATEWAY_EXCLUSIVE_001
```

### 2. é…ç½®ç‰ˆæœ¬ç®¡ç†

#### 2.1 ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥
```java
@Service
public class WorkflowVersionService {

    /**
     * åˆ›å»ºæ–°ç‰ˆæœ¬
     */
    public WorkflowTemplateVersion createNewVersion(String templateId, String changeDescription) {
        // 1. è·å–å½“å‰ç‰ˆæœ¬
        WorkflowTemplateEntity currentTemplate = templateDao.selectById(templateId);

        // 2. å¤‡ä»½å½“å‰ç‰ˆæœ¬
        WorkflowTemplateEntity backupTemplate = createTemplateBackup(currentTemplate);
        templateDao.insert(backupTemplate);

        // 3. æ›´æ–°ç‰ˆæœ¬å·
        currentTemplate.setVersion(currentTemplate.getVersion() + 1);
        currentTemplate.setUpdateTime(LocalDateTime.now());

        // 4. è®°å½•å˜æ›´ä¿¡æ¯
        currentTemplate.setChangeLog(appendToChangeLog(currentTemplate.getChangeLog(), changeDescription));

        templateDao.updateById(currentTemplate);

        return WorkflowTemplateVersion.builder()
            .templateId(templateId)
            .version(currentTemplate.getVersion())
            .changeDescription(changeDescription)
            .createTime(LocalDateTime.now())
            .build();
    }

    /**
     * å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
     */
    public void rollbackToVersion(String templateId, Integer targetVersion) {
        // 1. è·å–æŒ‡å®šç‰ˆæœ¬çš„å¤‡ä»½
        WorkflowTemplateEntity backupTemplate = templateDao.selectByTemplateIdAndVersion(templateId, targetVersion);
        if (backupTemplate == null) {
            throw new IllegalArgumentException("æŒ‡å®šçš„ç‰ˆæœ¬å¤‡ä»½ä¸å­˜åœ¨");
        }

        // 2. å¤‡ä»½å½“å‰ç‰ˆæœ¬
        WorkflowTemplateEntity currentTemplate = templateDao.selectById(templateId);
        currentTemplate.setStatus(2); // å†å²ç‰ˆæœ¬
        templateDao.updateById(currentTemplate);

        // 3. æ¢å¤å¤‡ä»½ç‰ˆæœ¬
        backupTemplate.setStatus(1); // å¯ç”¨ç‰ˆæœ¬
        backupTemplate.setTemplateId(templateId); // ä½¿ç”¨å½“å‰æ¨¡æ¿ID
        templateDao.updateById(backupTemplate);

        // 4. é‡æ–°éƒ¨ç½²æµç¨‹
        workflowService.deployWorkflow(templateId);
    }
}
```

---

## ğŸ“ˆ ç›‘æ§å’Œä¼˜åŒ–

### 1. é…ç½®ä½¿ç”¨ç»Ÿè®¡
```java
@Service
public class WorkflowAnalyticsService {

    /**
     * è·å–é…ç½®ä½¿ç”¨ç»Ÿè®¡
     */
    public WorkflowUsageStatistics getUsageStatistics(LocalDateTime startTime, LocalDateTime endTime) {
        WorkflowUsageStatistics statistics = new WorkflowUsageStatistics();

        // 1. æ¨¡æ¿ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡
        statistics.setTemplateUsageStats(templateDao.getTemplateUsageStats(startTime, endTime));

        // 2. èŠ‚ç‚¹ç±»å‹åˆ†å¸ƒ
        statistics.setNodeTypeDistribution(getNodeTypeDistribution());

        // 3. é…ç½®å¤æ‚åº¦åˆ†æ
        statistics.setComplexityAnalysis(analyzeConfigComplexity());

        // 4. ç”¨æˆ·æ´»è·ƒåº¦
        statistics.setUserActivityStats(getUserActivityStats(startTime, endTime));

        return statistics;
    }

    /**
     * åˆ†æé…ç½®å¤æ‚åº¦
     */
    private ComplexityAnalysis analyzeConfigComplexity() {
        List<WorkflowTemplateEntity> templates = templateDao.selectList(null);

        ComplexityAnalysis analysis = new ComplexityAnalysis();

        int totalTemplates = templates.size();
        int simpleTemplates = 0;
        int complexTemplates = 0;
        int veryComplexTemplates = 0;

        for (WorkflowTemplateEntity template : templates) {
            WorkflowConfig config = JSON.parseObject(template.getTemplateConfig(), WorkflowConfig.class);
            int complexityScore = calculateComplexityScore(config);

            if (complexityScore <= 3) {
                simpleTemplates++;
            } else if (complexityScore <= 6) {
                complexTemplates++;
            } else {
                veryComplexTemplates++;
            }
        }

        analysis.setTotalTemplates(totalTemplates);
        analysis.setSimpleTemplates(simpleTemplates);
        analysis.setComplexTemplates(complexTemplates);
        analysis.setVeryComplexTemplates(veryComplexTemplates);

        return analysis;
    }

    private int calculateComplexityScore(WorkflowConfig config) {
        int score = 0;

        // èŠ‚ç‚¹æ•°é‡å½±å“
        int nodeCount = config.getProcessConfig().getNodes().size();
        score += Math.min(nodeCount / 2, 3);

        // è¿æ¥æ•°é‡å½±å“
        int connectionCount = config.getProcessConfig().getConnections().size();
        score += Math.min(connectionCount / 3, 2);

        // æ¡ä»¶å¤æ‚åº¦å½±å“
        int conditionComplexity = calculateConditionComplexity(config);
        score += conditionComplexity;

        return score;
    }
}
```

---

## ğŸ¯ æ€»ç»“

å®¡æ‰¹æµç¨‹å¯é…ç½®åŒ–åŠŸèƒ½é€šè¿‡å¯è§†åŒ–è®¾è®¡å™¨ã€çµæ´»çš„é…ç½®ç®¡ç†å’Œå¼ºå¤§çš„BPMNç”Ÿæˆèƒ½åŠ›ï¼Œä¸ºIOE-DREAMå¹³å°æä¾›äº†ï¼š

1. **é›¶ä»£ç é…ç½®** - ä¸šåŠ¡ç®¡ç†å‘˜é€šè¿‡æ‹–æ‹½æ–¹å¼è®¾è®¡æµç¨‹
2. **å®æ—¶ç”Ÿæ•ˆ** - é…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
3. **ç‰ˆæœ¬ç®¡ç†** - å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»šæœºåˆ¶
4. **æ¨¡æ¿å¤ç”¨** - ä¸°å¯Œçš„æµç¨‹æ¨¡æ¿å’ŒèŠ‚ç‚¹åº“
5. **éªŒè¯ä¿éšœ** - è‡ªåŠ¨éªŒè¯ç¡®ä¿æµç¨‹é…ç½®æ­£ç¡®æ€§
6. **æ•°æ®åˆ†æ** - è¯¦ç»†çš„ä½¿ç”¨ç»Ÿè®¡å’Œä¼˜åŒ–å»ºè®®

è¯¥åŠŸèƒ½è®©ä¼ä¸šèƒ½å¤Ÿå¿«é€Ÿå“åº”ä¸šåŠ¡å˜åŒ–ï¼Œæé«˜å®¡æ‰¹æµç¨‹çš„çµæ´»æ€§å’Œé€‚åº”æ€§ï¼Œæ˜¯ç°ä»£ä¼ä¸šæ•°å­—åŒ–è½¬å‹çš„å…³é”®èƒ½åŠ›ã€‚

---

**åŠŸèƒ½çŠ¶æ€**: âœ… å·²å®Œæˆ
**é€‚ç”¨ç‰ˆæœ¬**: IOE-DREAM v2.0.0+
**ç»´æŠ¤è´£ä»»äºº**: OAå·¥ä½œæµå›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-12-16