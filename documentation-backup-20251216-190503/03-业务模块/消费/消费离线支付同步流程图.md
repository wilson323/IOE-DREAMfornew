# æ¶ˆè´¹ç¦»çº¿æ”¯ä»˜åŒæ­¥æµç¨‹å›¾

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-16
> **ä¸šåŠ¡èŒƒå›´**: ç¦»çº¿æ”¯ä»˜ä¸æ•°æ®åŒæ­¥
> **æŠ€æœ¯æ¶æ„**: æœ¬åœ°ç¼“å­˜ + é˜Ÿåˆ—åŒæ­¥ + æœ€ç»ˆä¸€è‡´æ€§

---

## ğŸ”„ ç¦»çº¿æ”¯ä»˜æ¶æ„è®¾è®¡

### ç¦»çº¿æ”¯ä»˜ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[ç§»åŠ¨ç«¯App]
        B[POSè®¾å¤‡]
        C[è‡ªåŠ©ç»ˆç«¯]
        D[æ¶ˆè´¹æœº]
    end

    subgraph "ç¦»çº¿ç¼“å­˜å±‚"
        E[æœ¬åœ°æ•°æ®å­˜å‚¨]
        F[æ¶ˆè´¹è®°å½•ç¼“å­˜]
        G[ä½™é¢ç¼“å­˜]
        H[æƒé™ç¼“å­˜]
        I[ç¦»çº¿é˜Ÿåˆ—]
    end

    subgraph "åŒæ­¥å¼•æ“"
        J[ç½‘ç»œçŠ¶æ€ç›‘æµ‹]
        K[æ•°æ®å‹ç¼©å™¨]
        L[å·®åˆ†è®¡ç®—å™¨]
        M[å†²çªè§£å†³å™¨]
        N[é‡è¯•æœºåˆ¶]
    end

    subgraph "æœåŠ¡ç«¯å±‚"
        O[æ¶ˆè´¹æœåŠ¡]
        P[è´¦æˆ·æœåŠ¡]
        Q[é€šçŸ¥æœåŠ¡]
        R[å®¡è®¡æœåŠ¡]
    end

    subgraph "æ•°æ®æŒä¹…å±‚"
        S[MySQLä¸»åº“]
        T[Redisç¼“å­˜]
        U[æ¶ˆæ¯é˜Ÿåˆ—]
        V[æ–‡ä»¶å­˜å‚¨]
    end

    A --> E
    B --> E
    C --> E
    D --> E

    E --> F
    E --> G
    E --> H
    E --> I

    E --> J
    J --> K
    K --> L
    L --> M
    M --> N

    J --> O
    N --> O
    O --> P
    P --> Q
    Q --> R

    O --> S
    P --> T
    Q --> U
    R --> V
```

## ğŸ’³ ç¦»çº¿æ”¯ä»˜å®Œæ•´æµç¨‹

### ç¦»çº¿æ”¯ä»˜æ“ä½œåºåˆ—å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Device as æ¶ˆè´¹è®¾å¤‡
    participant LocalCache as æœ¬åœ°ç¼“å­˜
    participant Queue as ç¦»çº¿é˜Ÿåˆ—
    participant SyncEngine as åŒæ­¥å¼•æ“
    participant CloudService as äº‘æœåŠ¡
    participant AccountService as è´¦æˆ·æœåŠ¡
    participant NotificationService as é€šçŸ¥æœåŠ¡

    Note over User,NotificationService: 1. ç¦»çº¿æ”¯ä»˜å¤„ç†æµç¨‹

    User->>Device: å‘èµ·æ¶ˆè´¹è¯·æ±‚
    Device->>LocalCache: æ£€æŸ¥æœ¬åœ°ä½™é¢

    alt ä½™é¢å……è¶³
        LocalCache-->>Device: è¿”å›ä½™é¢ä¿¡æ¯
        Device->>LocalCache: æ‰£å‡æœ¬åœ°ä½™é¢
        LocalCache->>Queue: æ·»åŠ ç¦»çº¿æ¶ˆè´¹è®°å½•
        LocalCache->>User: æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ

        Note over LocalCache,NotificationService: 2. ç¦»çº¿æ•°æ®åŒæ­¥

        Device->>SyncEngine: æ£€æŸ¥ç½‘ç»œçŠ¶æ€

        alt ç½‘ç»œå¯ç”¨
            SyncEngine->>Queue: è·å–å¾…åŒæ­¥æ•°æ®
            SyncEngine->>Queue: æ‰¹é‡å¤„ç†æ¶ˆè´¹è®°å½•
            SyncEngine->>CloudService: æ‰¹é‡ä¸Šä¼ æ•°æ®

            CloudService->>CloudService: éªŒè¯æ¶ˆè´¹è®°å½•
            CloudService->>AccountService: æ‰¹é‡æ›´æ–°è´¦æˆ·
            CloudService->>NotificationService: å‘é€æˆåŠŸé€šçŸ¥
            CloudService-->>SyncEngine: åŒæ­¥æˆåŠŸç¡®è®¤

            SyncEngine->>LocalCache: æ›´æ–°æœ¬åœ°çŠ¶æ€
            SyncEngine->>Queue: æ¸…ç†å·²åŒæ­¥æ•°æ®
            LocalCache->>Device: åŒæ­¥çŠ¶æ€æ›´æ–°
        else ç½‘ç»œä¸å¯ç”¨
            SyncEngine->>Queue: ç»§ç»­ç¼“å­˜æ•°æ®
            LocalCache->>Device: æ˜¾ç¤ºç¦»çº¿æ¨¡å¼
        end

    else ä½™é¢ä¸è¶³
        LocalCache-->>Device: ä½™é¢ä¸è¶³æç¤º
        Device->>User: æ˜¾ç¤ºä½™é¢ä¸è¶³é”™è¯¯
    end

    Note over User,NotificationService: 3. å†²çªè§£å†³æœºåˆ¶

    alt å‘ç°æ•°æ®å†²çª
        SyncEngine->>CloudService: å†²çªæ£€æµ‹è¯·æ±‚
        CloudService->>CloudService: æœåŠ¡ç«¯æ•°æ®æ¯”å¯¹
        CloudService-->>SyncEngine: å†²çªæ£€æµ‹ç»“æœ

        SyncEngine->>SyncEngine: åº”ç”¨å†²çªè§£å†³ç­–ç•¥
        SyncEngine->>LocalCache: æ›´æ–°æœ¬åœ°æ•°æ®
        SyncEngine->>CloudService: ä¸Šä¼ è§£å†³ç»“æœ
    end
```

## ğŸ”„ æ•°æ®åŒæ­¥ç­–ç•¥

### æœ€ç»ˆä¸€è‡´æ€§ä¿éšœæœºåˆ¶

```mermaid
graph TB
    A[æ•°æ®ç”Ÿæˆ] --> B[æœ¬åœ°å­˜å‚¨]
    B --> C[é˜Ÿåˆ—æ’é˜Ÿ]
    C --> D[ç½‘ç»œæ£€æµ‹]

    D --> E{ç½‘ç»œçŠ¶æ€}

    E -->|åœ¨çº¿| F[å®æ—¶åŒæ­¥]
    E -->|å¼±ç½‘| G[æ‰¹é‡åŒæ­¥]
    E -->|ç¦»çº¿| H[æ•°æ®ç´¯ç§¯]

    F --> I[æ•°æ®éªŒè¯]
    G --> I
    H --> J[å‘¨æœŸæ£€æµ‹]
    J --> E

    I --> K{æ•°æ®ä¸€è‡´æ€§}

    K -->|ä¸€è‡´| L[ç¡®è®¤å®Œæˆ]
    K -->|å†²çª| M[å†²çªè§£å†³]
    K -->|å¼‚å¸¸| N[é”™è¯¯å¤„ç†]

    L --> O[æ¸…ç†æœ¬åœ°æ•°æ®]
    M --> P[æœåŠ¡ç«¯ä¼˜å…ˆ]
    N --> Q[é‡è¯•æœºåˆ¶]

    O --> R[åŒæ­¥å®Œæˆ]
    P --> S[æœ¬åœ°æ›´æ–°]
    Q --> I

    R --> T[å®¡è®¡æ—¥å¿—]
    S --> T
    T --> U[æœ€ç»ˆä¸€è‡´]
```

## âš¡ ç¦»çº¿é˜Ÿåˆ—ç®¡ç†

### é˜Ÿåˆ—æ•°æ®å¤„ç†æµç¨‹

```mermaid
graph TB
    A[æ¶ˆè´¹äº‹ä»¶] --> B[æ•°æ®åºåˆ—åŒ–]
    B --> C[é˜Ÿåˆ—åˆ†ç±»]

    C --> D[æ”¯ä»˜é˜Ÿåˆ—]
    C --> E[é€€æ¬¾é˜Ÿåˆ—]
    C --> F[æƒé™é˜Ÿåˆ—]
    C --> G[æ—¥å¿—é˜Ÿåˆ—]

    subgraph "ä¼˜å…ˆçº§å¤„ç†"
        D --> D1[é«˜ä¼˜å…ˆçº§]
        E --> E2[ä¸­ä¼˜å…ˆçº§]
        F --> F3[ä½ä¼˜å…ˆçº§]
        G --> G4[æœ€ä½ä¼˜å…ˆçº§]
    end

    D1 --> H[ç«‹å³å¤„ç†]
    D2 --> I[å®šæ—¶å¤„ç†]
    E2 --> I
    F3 --> I
    G4 --> I

    H --> J[æ‰¹é‡å¤„ç†]
    I --> K[æ‰¹é‡èšåˆ]

    J --> L[ç½‘ç»œä¸Šä¼ ]
    K --> L
    L --> M[æœåŠ¡ç«¯æ¥æ”¶]

    M --> N[å¤„ç†ç»“æœ]
    N --> O[çŠ¶æ€æ›´æ–°]
    O --> P[ç¡®è®¤å®Œæˆ]
```

## ğŸ” å®‰å…¨æœºåˆ¶è®¾è®¡

### ç¦»çº¿å®‰å…¨é˜²æŠ¤ç­–ç•¥

```mermaid
graph TB
    A[ç¦»çº¿æ”¯ä»˜å®‰å…¨] --> B{å®‰å…¨æ§åˆ¶}

    B -->|æ•°æ®åŠ å¯†| C[AES-256åŠ å¯†]
    B -->|æ•°å­—ç­¾å| C[RSAç­¾åéªŒè¯]
    B -->|é˜²é‡æ”¾| C[æ—¶é—´æˆ³é˜²é‡æ”¾]
    B -->|é˜²ç¯¡æ”¹| C[HMACå®Œæ•´æ€§æ ¡éªŒ]
    B -->|è®¾å¤‡ç»‘å®š| C[è®¾å¤‡æŒ‡çº¹éªŒè¯]

    C --> D[ç¦»çº¿æ•°æ®ä¿æŠ¤]
    D --> E[å®‰å…¨å­˜å‚¨]
    E --> F[å†…å­˜åŠ å¯†]
    E --> G[æ–‡ä»¶åŠ å¯†]

    D --> H[ä¼ è¾“å®‰å…¨]
    H --> I[SSL/TLSåŠ å¯†]
    I --> J[å‹ç¼©åŠ å¯†]

    D --> K[è®¿é—®æ§åˆ¶]
    K --> L[è®¾å¤‡æˆæƒ]
    L --> M[æƒé™éªŒè¯]
    M --> N[æ“ä½œé™åˆ¶]
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç¦»çº¿å­˜å‚¨ä¼˜åŒ–

```mermaid
pie title æœ¬åœ°å­˜å‚¨ä½¿ç”¨ç­–ç•¥
    "æ¶ˆè´¹è®°å½•" : 35
    "è´¦æˆ·ä¿¡æ¯" : 25
    "æƒé™æ•°æ®" : 20
    "é…ç½®ä¿¡æ¯" : 15
    "ç¼“å­˜æ•°æ®" : 5
```

### åŒæ­¥æ€§èƒ½ä¼˜åŒ–

```mermaid
xychart-beta
    title åŒæ­¥æ€§èƒ½ä¼˜åŒ–æ•ˆæœ
    x-axis "æ•°æ®é‡(æ¡)"
    y-axis "åŒæ­¥æ—¶é—´(ç§’)"
    line [1, 0.5, 5, 1.2, 10, 2.1, 50, 4.8, 100, 9.5, 500, 32.5, 1000, 58.2]
    bar [1-10, 10, 11-50, 50, 51-100, 100, 101-500, 500, 501-1000, 1000]
```

## ğŸš¨ å¼‚å¸¸å¤„ç†ä¸æ¢å¤

### ç½‘ç»œä¸­æ–­æ¢å¤æµç¨‹

```mermaid
sequenceDiagram
    participant Device as æ¶ˆè´¹è®¾å¤‡
    participant Monitor as ç½‘ç»œç›‘æµ‹å™¨
    participant Queue as ç¦»çº¿é˜Ÿåˆ—
    participant SyncEngine as åŒæ­¥å¼•æ“
    participant CloudService as äº‘æœåŠ¡
    participant Admin as ç®¡ç†å‘˜

    Device->>Monitor: å®šæœŸç½‘ç»œæ£€æµ‹
    Monitor->>Device: ç½‘ç»œä¸­æ–­é€šçŸ¥

    Note over Device,Admin: 1. ç½‘ç»œä¸­æ–­æœŸé—´

    Device->>Queue: ç»§ç»­ç¼“å­˜æ•°æ®
    Device->>Device: å¯ç”¨ç¦»çº¿æ¨¡å¼
    Device->>User: æ˜¾ç¤ºç¦»çº¿çŠ¶æ€

    loop ç¦»çº¿æ¨¡å¼è¿è¡Œ
        User->>Device: ç¦»çº¿æ”¯ä»˜æ“ä½œ
        Device->>Queue: è®°å½•æ“ä½œæ•°æ®
        Device->>Device: æ›´æ–°æœ¬åœ°çŠ¶æ€
    end

    Note over Device,Admin: 2. ç½‘ç»œæ¢å¤å¤„ç†

    Monitor->>Device: ç½‘ç»œæ¢å¤æ£€æµ‹
    Device->>SyncEngine: è§¦å‘åŒæ­¥æµç¨‹

    SyncEngine->>Queue: æ£€æŸ¥å¾…åŒæ­¥æ•°æ®é‡
    SyncEngine->>CloudService: æ‰¹é‡åŒæ­¥å¤„ç†

    alt åŒæ­¥æˆåŠŸ
        CloudService-->>SyncEngine: åŒæ­¥å®Œæˆ
        SyncEngine->>Queue: æ¸…ç†å·²åŒæ­¥æ•°æ®
        SyncEngine->>Device: åŒæ­¥çŠ¶æ€æ›´æ–°
        Device->>User: æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€
    else åŒæ­¥å¼‚å¸¸
        CloudService-->>SyncEngine: åŒæ­¥å¤±è´¥
        SyncEngine->>Queue: ä¿ç•™æœªåŒæ­¥æ•°æ®
        SyncEngine->>Admin: å¼‚å¸¸æŠ¥å‘Š
    end
```

## ğŸ“‹ ç›‘æ§æŒ‡æ ‡ä½“ç³»

### å…³é”®æ€§èƒ½æŒ‡æ ‡KPI

| æŒ‡æ ‡ç±»åˆ« | ç›‘æ§æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ | ç›‘æ§é¢‘ç‡ |
|---------|----------|--------|----------|----------|
| **åŒæ­¥æ€§èƒ½** | æ•°æ®åŒæ­¥å»¶è¿Ÿ | â‰¤30ç§’ | >60ç§’ | å®æ—¶ |
| **åŒæ­¥æ€§èƒ½** | åŒæ­¥æˆåŠŸç‡ | â‰¥99.5% | <98% | å®æ—¶ |
| **æ•°æ®ä¸€è‡´æ€§** | æ•°æ®ä¸€è‡´ç‡ | â‰¥99.9% | <99% | 5åˆ†é’Ÿ |
| **ç¦»çº¿åŠŸèƒ½** | ç¦»çº¿å¯ç”¨æ€§ | 100% | <95% | å®æ—¶ |
| **ç³»ç»Ÿæ€§èƒ½** | æœ¬åœ°å“åº”æ—¶é—´ | â‰¤200ms | >500ms | å®æ—¶ |

### å®æ—¶ç›‘æ§ä»ªè¡¨æ¿

```mermaid
graph TB
    subgraph "å®æ—¶ç›‘æ§é¢æ¿"
        A[ç¦»çº¿è®¾å¤‡çŠ¶æ€]
        B[åŒæ­¥é˜Ÿåˆ—é•¿åº¦]
        C[æ•°æ®ä¸€è‡´æ€§çŠ¶æ€]
        D[å¼‚å¸¸äº‹ä»¶ç»Ÿè®¡]
    end

    subgraph "æ€§èƒ½æŒ‡æ ‡"
        E[åŒæ­¥æˆåŠŸç‡]
        F[å¹³å‡å“åº”æ—¶é—´]
        G[æ•°æ®ååé‡]
        H[é”™è¯¯ç‡ç»Ÿè®¡]
    end

    subgraph "å‘Šè­¦ä¸­å¿ƒ"
        I[ç½‘ç»œå¼‚å¸¸å‘Šè­¦]
        J[æ•°æ®å†²çªå‘Šè­¦]
        K[è®¾å¤‡ç¦»çº¿å‘Šè­¦]
        L[å®‰å…¨å¨èƒå‘Šè­¦]
    end

    A --> E
    B --> F
    C --> G
    D --> H

    E --> I
    F --> J
    G --> K
    H --> L
```

---

## ğŸ”§ é…ç½®å‚æ•°å‚è€ƒ

### ç¦»çº¿æ¨¡å¼é…ç½®

```yaml
# ç¦»çº¿æ”¯ä»˜é…ç½®
offline-payment:
  # æœ¬åœ°å­˜å‚¨é…ç½®
  local-storage:
    max-cache-size: 10000          # æœ€å¤§ç¼“å­˜è®°å½•æ•°
    data-retention-days: 7          # æ•°æ®ä¿ç•™å¤©æ•°
    encryption-enabled: true      # å¯ç”¨æ•°æ®åŠ å¯†
    compression-enabled: true     # å¯ç”¨æ•°æ®å‹ç¼©

  # åŒæ­¥é…ç½®
  sync:
    batch-size: 100                 # æ‰¹é‡åŒæ­¥å¤§å°
    sync-interval: 30              # åŒæ­¥é—´éš”(ç§’)
    max-retry-times: 3              # æœ€å¤§é‡è¯•æ¬¡æ•°
    timeout-seconds: 60            # è¶…æ—¶æ—¶é—´(ç§’)

  # é˜Ÿåˆ—é…ç½®
  queue:
    max-queue-size: 50000          # æœ€å¤§é˜Ÿåˆ—é•¿åº¦
    priority-levels: 4             # ä¼˜å…ˆçº§æ•°é‡
    overflow-strategy: "oldest"     # æº¢å‡ºç­–ç•¥

  # å®‰å…¨é…ç½®
  security:
    data-encryption: "AES-256"     # æ•°æ®åŠ å¯†ç®—æ³•
    signature-algorithm: "RSA-2048"  # ç­¾åç®—æ³•
    device-binding: true           # è®¾å¤‡ç»‘å®šéªŒè¯
    anti-replay-window: 300        # é˜²é‡æ”¾æ—¶é—´çª—å£(ç§’)
```

---

**æ–‡æ¡£åˆ›å»ºå®Œæˆæ—¶é—´**: 2025-12-16
**æµç¨‹å›¾æ€»æ•°**: 6ä¸ªæ ¸å¿ƒæµç¨‹å›¾
**è¦†ç›–èŒƒå›´**: ç¦»çº¿æ”¯ä»˜å…¨æµç¨‹
**æŠ€æœ¯ç‰¹ç‚¹**: æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡ + é«˜å¯ç”¨æ¶æ„
**å®æ–½å»ºè®®**: åŸºäºæ­¤æµç¨‹å›¾ç«‹å³å®Œæ•´å®ç°ç¦»çº¿æ”¯ä»˜åŒæ­¥åŠŸèƒ½