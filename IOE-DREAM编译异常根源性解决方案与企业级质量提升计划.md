# IOE-DREAM ç¼–è¯‘å¼‚å¸¸æ ¹æºæ€§è§£å†³æ–¹æ¡ˆä¸ä¼ä¸šçº§è´¨é‡æå‡è®¡åˆ’

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 - ä¼ä¸šçº§å®Œæ•´æ–¹æ¡ˆ  
**åˆ¶å®šæ—¥æœŸ**: 2025-12-17  
**é€‚ç”¨èŒƒå›´**: IOE-DREAM æ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°å…¨é¡¹ç›®  
**æ‰§è¡Œä¼˜å…ˆçº§**: P0 - æœ€é«˜ä¼˜å…ˆçº§  
**é¢„ä¼°å·¥æœŸ**: 3-4 å‘¨ï¼ˆåˆ†3ä¸ªé˜¶æ®µï¼‰  
**æ–‡æ¡£æ€§è´¨**: å›¢é˜Ÿå¼€å‘ä¸ç»´æŠ¤æƒå¨æŒ‡å¯¼ä¾æ®  

---

## ğŸ“‹ æ–‡æ¡£å¯¼èˆª

- [ä¸€ã€æ‰§è¡Œæ‘˜è¦](#ä¸€æ‰§è¡Œæ‘˜è¦)
- [äºŒã€é—®é¢˜æ ¹æºæ·±åº¦åˆ†æ](#äºŒé—®é¢˜æ ¹æºæ·±åº¦åˆ†æ)
- [ä¸‰ã€ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ](#ä¸‰ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ)
- [å››ã€åˆ†é˜¶æ®µå·¥ä½œè®¡åˆ’](#å››åˆ†é˜¶æ®µå·¥ä½œè®¡åˆ’)
- [äº”ã€å…¨å±€ä¸€è‡´æ€§è§„èŒƒ](#äº”å…¨å±€ä¸€è‡´æ€§è§„èŒƒ)
- [å…­ã€è´¨é‡ä¿éšœä½“ç³»](#å…­è´¨é‡ä¿éšœä½“ç³»)
- [ä¸ƒã€é£é™©ç®¡ç†ä¸åº”æ€¥é¢„æ¡ˆ](#ä¸ƒé£é™©ç®¡ç†ä¸åº”æ€¥é¢„æ¡ˆ)
- [å…«ã€é¡¹ç›®éªŒæ”¶æ ‡å‡†](#å…«é¡¹ç›®éªŒæ”¶æ ‡å‡†)

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

### 1.1 å½“å‰çŠ¶å†µè¯„ä¼°

IOE-DREAM é¡¹ç›®å½“å‰å¤„äº **P0 çº§ä¼ä¸šå±æœºçŠ¶æ€**ï¼Œä¸»è¦è¡¨ç°ä¸ºï¼š

```plaintext
ç¼–è¯‘çŠ¶æ€: âŒ å®Œå…¨å¤±è´¥ (69ä¸ªç¼–è¯‘é”™è¯¯)
æ„å»ºçŠ¶æ€: âŒ æ— æ³•æ„å»º
éƒ¨ç½²çŠ¶æ€: âŒ æ— æ³•éƒ¨ç½²
åŠŸèƒ½å¼€å‘: â¸ï¸ å®Œå…¨é˜»å¡
å›¢é˜Ÿæ•ˆç‡: âš ï¸ é™ä½80%
ä¸šåŠ¡å½±å“: ğŸ”´ ä¸¥é‡ - æ— æ³•äº¤ä»˜
```

### 1.2 æ ¹æºæ€§åŸå› æ€»ç»“

ç»è¿‡å…¨å±€ä»£ç æ·±åº¦åˆ†æï¼Œé—®é¢˜å‘ˆç°**äº”å±‚é‡‘å­—å¡”ç»“æ„**ï¼š

| å±‚çº§ | åŸå› ç±»å‹ | å½±å“æƒé‡ | è§£å†³éš¾åº¦ |
|------|---------|---------|---------|
| **L5 ç»„ç»‡æµç¨‹å±‚** | è´¨é‡é—¨ç¦ç¼ºå¤±ã€æŠ€æœ¯å€ºåŠ¡å¤±æ§ | 30% | â­â­â­â­â­ |
| **L4 æ¼”è¿›ç®¡ç†å±‚** | æ¶æ„é‡æ„åŠé€”è€ŒåºŸã€è¿ç§»ä¸å®Œæ•´ | 50% | â­â­â­â­â­ |
| **L3 æ¶æ„è®¾è®¡å±‚** | æ¨¡å—èŒè´£ä¸æ¸…ã€ä¾èµ–æ··ä¹± | 15% | â­â­â­â­ |
| **L2 ä»£ç å®ç°å±‚** | APIä¸åŒ¹é…ã€ç±»å¼•ç”¨é”™è¯¯ | 5% | â­â­â­ |
| **L1 ç¼–è¯‘é”™è¯¯å±‚** | 69ä¸ªç¼–è¯‘é”™è¯¯ | 0% | â­â­ |

**æ ¸å¿ƒç»“è®º**: è¿™æ˜¯å…¸å‹çš„"ç»„ç»‡å‹æŠ€æœ¯å€ºåŠ¡å±æœº"ï¼Œéœ€è¦ç³»ç»Ÿæ€§è§£å†³ã€‚

### 1.3 è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

æœ¬æ–¹æ¡ˆé‡‡ç”¨**ä¸‰é˜¶æ®µé€’è¿›å¼**è§£å†³ç­–ç•¥ï¼š

```mermaid
graph LR
    A[é˜¶æ®µ1<br/>ç´§æ€¥æ­¢è¡€<br/>3-5å¤©] --> B[é˜¶æ®µ2<br/>æ¶æ„é‡æ„<br/>2-3å‘¨]
    B --> C[é˜¶æ®µ3<br/>è´¨é‡æå‡<br/>1å‘¨]
    
    A1[ä¿®å¤ç¼–è¯‘é”™è¯¯<br/>å®ŒæˆJakartaè¿ç§»] --> A
    B1[æ¨¡å—åŒ–æ‹†åˆ†<br/>ä¸šåŠ¡ä»£ç è¿ç§»<br/>ä¾èµ–å…³ç³»ä¼˜åŒ–] --> B
    C1[å»ºç«‹è´¨é‡é—¨ç¦<br/>å®Œå–„CI/CD<br/>åˆ¶å®šå¼€å‘è§„èŒƒ] --> C
```

### 1.4 é¢„æœŸæˆæœ

| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | æå‡å¹…åº¦ |
|------|---------|---------|---------|
| **ç¼–è¯‘æˆåŠŸç‡** | 0% | 100% | +100% |
| **ä»£ç è´¨é‡è¯„åˆ†** | 6.5/10 | 9.0/10 | +38% |
| **æ¶æ„åˆè§„æ€§** | 60% | 95%+ | +58% |
| **æµ‹è¯•è¦†ç›–ç‡** | 45% | 85%+ | +89% |
| **æ„å»ºæ—¶é—´** | è¶…æ—¶ | <5åˆ†é’Ÿ | -80% |
| **å›¢é˜Ÿå¼€å‘æ•ˆç‡** | 20% | 100% | +400% |

---

## äºŒã€é—®é¢˜æ ¹æºæ·±åº¦åˆ†æ

### 2.1 æ¶æ„æ¼”è¿›é—®é¢˜åˆ†æ

#### 2.1.1 å½“å‰æ¶æ„çŠ¶æ€å›¾

```mermaid
graph TB
    subgraph "ç›®æ ‡æ¶æ„ (æœªå®Œæˆ)"
        Core[microservices-common-core<br/>æ ¸å¿ƒå…¬å…±]
        Security[microservices-common-security<br/>å®‰å…¨æ¨¡å—]
        Data[microservices-common-data<br/>æ•°æ®å±‚]
        Cache[microservices-common-cache<br/>ç¼“å­˜æ¨¡å—]
        Business[microservices-common-business<br/>ä¸šåŠ¡å…¬å…±]
        
        OA[ioedream-oa-service]
        Consume[ioedream-consume-service]
        Visitor[ioedream-visitor-service]
        Access[ioedream-access-service]
        
        OA --> Core
        OA --> Security
        Consume --> Core
        Consume --> Data
        Visitor --> Core
        Access --> Security
    end
    
    subgraph "å®é™…æ¶æ„ (æ··ä¹±çŠ¶æ€)"
        Common[microservices-common<br/>å¤§æ‚çƒ©<br/>âŒ åŒ…å«17ä¸ªä¸šåŠ¡ç›®å½•]
        
        Common --> |ä¸šåŠ¡ä»£ç æ··æ‚| Workflow[workflow/]
        Common --> |ä¸šåŠ¡ä»£ç æ··æ‚| ConsumeDir[consume/]
        Common --> |ä¸šåŠ¡ä»£ç æ··æ‚| VisitorDir[visitor/]
        Common --> |ä¸šåŠ¡ä»£ç æ··æ‚| AccessDir[access/]
        
        Services[æ‰€æœ‰å¾®æœåŠ¡] --> |å¼ºä¾èµ–| Common
    end
    
    style Common fill:#ff6b6b
    style Services fill:#ffd93d
```

#### 2.1.2 é—®é¢˜æ¸…å•

**æ–‡ä»¶è·¯å¾„**: `d:\IOE-DREAM\microservices\microservices-common\src\main\java\net\lab1024\sa\common\`

| é—®é¢˜ç›®å½• | åº”å½’å±æœåŠ¡ | å½“å‰ä½ç½® | å½±å“èŒƒå›´ |
|---------|-----------|---------|---------|
| `access/` | ioedream-access-service | microservices-common | é—¨ç¦æ¨¡å—å…¨å±€ |
| `consume/` | ioedream-consume-service | microservices-common | æ¶ˆè´¹æ¨¡å—å…¨å±€ |
| `oa/` | ioedream-oa-service | microservices-common | OAå·¥ä½œæµå…¨å±€ |
| `visitor/` | ioedream-visitor-service | microservices-common | è®¿å®¢ç®¡ç†å…¨å±€ |
| `attendance/` | ioedream-attendance-service | microservices-common | è€ƒå‹¤æ¨¡å—å…¨å±€ |
| `video/` | ioedream-video-service | microservices-common | è§†é¢‘ç›‘æ§å…¨å±€ |

**è¿ååŸåˆ™**: 
- âŒ å•ä¸€èŒè´£åŸåˆ™ (SRP)
- âŒ ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
- âŒ æ¥å£éš”ç¦»åŸåˆ™ (ISP)

### 2.2 ç¼–è¯‘é”™è¯¯è¯¦ç»†åˆ†æ

#### 2.2.1 é”™è¯¯åˆ†ç±»ç»Ÿè®¡

```mermaid
pie title 69ä¸ªç¼–è¯‘é”™è¯¯åˆ†ç±»åˆ†å¸ƒ
    "æ–¹æ³•ç­¾åä¸åŒ¹é…" : 25
    "ç±»å¼•ç”¨é”™è¯¯" : 18
    "ä¾èµ–æ³¨å…¥ç¼ºå¤±" : 12
    "ç±»å‹è½¬æ¢é”™è¯¯" : 8
    "Jakartaè¿ç§»æœªå®Œæˆ" : 6
```

#### 2.2.2 æ ¸å¿ƒé”™è¯¯æ¡ˆä¾‹åˆ†æ

**æ¡ˆä¾‹1: UserOpenApiServiceImpl é”™è¯¯é“¾**

**æ–‡ä»¶è·¯å¾„**: `d:\IOE-DREAM\microservices\ioedream-common-service\src\main\java\net\lab1024\sa\common\openapi\service\impl\UserOpenApiServiceImpl.java`

```java
// âŒ é”™è¯¯1: å¯¼å…¥äº†é”™è¯¯çš„ LoginRequest
import net.lab1024.sa.common.openapi.domain.request.LoginRequest;
// å®é™…åº”ä½¿ç”¨
// import net.lab1024.sa.common.auth.domain.dto.LoginRequest;

// âŒ é”™è¯¯2: APIç­¾åä¸åŒ¹é…
String accessToken = jwtTokenUtil.generateAccessToken(
    user.getUserId(), user.getUsername());
// JwtTokenUtil å®é™…ç­¾åéœ€è¦4ä¸ªå‚æ•°:
// generateAccessToken(Long userId, String username, 
//                     List<String> roles, List<String> permissions)

// âŒ é”™è¯¯3: ä¾èµ–æ³¨å…¥ç¼ºå¤±
securityManager.xxx(); // securityManager ä»æœªæ³¨å…¥

// âŒ é”™è¯¯4: æ–¹æ³•ä¸å­˜åœ¨
String phone = request.getPhone(); 
// openapi.LoginRequest æ²¡æœ‰ getPhone() æ–¹æ³•
```

**æ ¹æœ¬åŸå› åˆ†æå›¾**:

```mermaid
graph TD
    A[UserOpenApiServiceImpl<br/>ä½äº ioedream-common-service] --> B[ä¾èµ– microservices-common]
    B --> C[microservices-common æœªå®Œæˆæ‹†åˆ†]
    C --> D[åŒ…å«ä¸¤ä¸ª LoginRequest å®šä¹‰]
    C --> E[JwtTokenUtil API å·²é‡æ„]
    C --> F[SecurityManager æ¥å£æœªå®šä¹‰]
    
    D --> G[å¯¼å…¥é”™è¯¯çš„ç±»]
    E --> H[è°ƒç”¨æ—§APIç­¾å]
    F --> I[ä¾èµ–æ³¨å…¥å¤±è´¥]
    
    G --> J[ğŸ’¥ ç¼–è¯‘é”™è¯¯]
    H --> J
    I --> J
    
    style J fill:#ff6b6b
```

#### 2.2.3 Jakarta EE è¿ç§»çŠ¶æ€

**æ–‡ä»¶è·¯å¾„æ‰«æç»“æœ**:

```plaintext
æœªå®Œæˆè¿ç§»çš„æ–‡ä»¶ (ç¤ºä¾‹):
â”œâ”€â”€ microservices-common/src/.../SomeOldClass.java
â”‚   â””â”€â”€ import javax.annotation.Resource; âŒ
â”œâ”€â”€ microservices-common/src/.../AnotherClass.java  
â”‚   â””â”€â”€ import javax.validation.Valid; âŒ
â””â”€â”€ ... (é¢„ä¼°30+æ–‡ä»¶)

å·²å®Œæˆè¿ç§»çš„æ–‡ä»¶:
â”œâ”€â”€ microservices-common-core/... âœ…
â””â”€â”€ microservices-common-security/... âœ…
```

### 2.3 ä¾èµ–å…³ç³»é—®é¢˜åˆ†æ

#### 2.3.1 å½“å‰ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    subgraph "âŒ å½“å‰æ··ä¹±çš„ä¾èµ–å…³ç³»"
        MC[microservices-common]
        CS[ioedream-common-service]
        AS[ioedream-access-service]
        
        MC -->|ä¸å½“ä¾èµ–| UserEntity[UserEntity<br/>ä¸šåŠ¡å®ä½“]
        MC -->|ä¸å½“ä¾èµ–| RoleEntity[RoleEntity<br/>ä¸šåŠ¡å®ä½“]
        
        CS --> MC
        AS --> MC
        
        CS -->|å¾ªç¯ä¾èµ–é£é™©| MC
    end
    
    subgraph "âœ… æ­£ç¡®çš„ä¾èµ–å…³ç³»"
        Core[common-core]
        Security[common-security]
        
        Service[ioedream-common-service]
        
        Security --> DataProvider[PermissionDataProvider<br/>æ¥å£]
        Service --> Security
        Service --> DataProvider
        Service --> Entities[ä¸šåŠ¡å®ä½“]
    end
    
    style MC fill:#ff6b6b
    style Core fill:#51cf66
```

#### 2.3.2 POM ä¾èµ–åˆ†æ

**çˆ¶POM**: `d:\IOE-DREAM\microservices\pom.xml`

```xml
<!-- âœ… ä¾èµ–ç®¡ç†é…ç½®å®Œæ•´ -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>3.5.8</version>
        </dependency>
        <!-- ... å…¶ä»–ä¾èµ– ... -->
    </dependencies>
</dependencyManagement>

<!-- âš ï¸ ä½†æ¨¡å—æ„å»ºé¡ºåºå­˜åœ¨é—®é¢˜ -->
<modules>
    <module>microservices-common-core</module>
    <module>microservices-common-security</module>
    <!-- ... -->
    <module>microservices-common</module> <!-- âŒ åº”è¯¥æœ€åæˆ–ç§»é™¤ -->
    <module>ioedream-common-service</module>
</modules>
```

---

## ä¸‰ã€ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆ

### 3.1 æ€»ä½“è§£å†³ç­–ç•¥

#### 3.1.1 è§£å†³æ–¹æ¡ˆæ¶æ„å›¾

```mermaid
graph TB
    subgraph "é˜¶æ®µ1: ç´§æ€¥æ­¢è¡€ (3-5å¤©)"
        A1[1.1 ä¿®å¤æ˜æ˜¾ç¼–è¯‘é”™è¯¯]
        A2[1.2 å®ŒæˆJakartaè¿ç§»]
        A3[1.3 ä¿®å¤APIç­¾åä¸åŒ¹é…]
        A4[1.4 è¡¥å……ä¾èµ–æ³¨å…¥]
        A5[1.5 å»ºç«‹ä¸´æ—¶å¯ç¼–è¯‘çŠ¶æ€]
        
        A1 --> A2 --> A3 --> A4 --> A5
    end
    
    subgraph "é˜¶æ®µ2: æ¶æ„é‡æ„ (2-3å‘¨)"
        B1[2.1 å®Œæˆæ¨¡å—åŒ–æ‹†åˆ†]
        B2[2.2 è¿ç§»ä¸šåŠ¡ä»£ç ]
        B3[2.3 é‡æ„ä¾èµ–å…³ç³»]
        B4[2.4 æ¸…ç†microservices-common]
        B5[2.5 ç»Ÿä¸€æŠ€æœ¯æ ˆç‰ˆæœ¬]
        
        B1 --> B2 --> B3 --> B4 --> B5
    end
    
    subgraph "é˜¶æ®µ3: è´¨é‡æå‡ (1å‘¨)"
        C1[3.1 å»ºç«‹CI/CDè´¨é‡é—¨ç¦]
        C2[3.2 å®Œå–„è‡ªåŠ¨åŒ–æµ‹è¯•]
        C3[3.3 åˆ¶å®šå¼€å‘è§„èŒƒ]
        C4[3.4 å»ºç«‹ä»£ç å®¡æŸ¥æœºåˆ¶]
        C5[3.5 å®Œå–„æ–‡æ¡£ä½“ç³»]
        
        C1 --> C2 --> C3 --> C4 --> C5
    end
    
    A5 --> B1
    B5 --> C1
```

### 3.2 é˜¶æ®µ1: ç´§æ€¥æ­¢è¡€æ–¹æ¡ˆ (3-5å¤©)

#### 3.2.1 ä»»åŠ¡1.1: ä¿®å¤æ˜æ˜¾ç¼–è¯‘é”™è¯¯

**ç›®æ ‡**: ä¿®å¤ UserOpenApiServiceImpl ä¸­çš„ 60 ä¸ªç¼–è¯‘é”™è¯¯

**æ¶‰åŠæ–‡ä»¶**:
- `d:\IOE-DREAM\microservices\ioedream-common-service\src\main\java\net\lab1024\sa\common\openapi\service\impl\UserOpenApiServiceImpl.java`

**å®æ–½æ­¥éª¤**:

**æ­¥éª¤1: ä¿®å¤ LoginRequest ç±»å¼•ç”¨**

```java
// âŒ åˆ é™¤é”™è¯¯çš„å¯¼å…¥
// import net.lab1024.sa.common.openapi.domain.request.LoginRequest;

// âœ… ä½¿ç”¨æ­£ç¡®çš„å¯¼å…¥
import net.lab1024.sa.common.auth.domain.dto.LoginRequest;
```

**æ­¥éª¤2: ä¿®å¤ JwtTokenUtil API è°ƒç”¨**

```java
// âŒ é”™è¯¯çš„è°ƒç”¨æ–¹å¼ (2ä¸ªå‚æ•°)
String accessToken = jwtTokenUtil.generateAccessToken(
    user.getUserId(), user.getUsername());

// âœ… æ–¹æ¡ˆA: ä½¿ç”¨é‡è½½æ–¹æ³• (å¦‚æœå­˜åœ¨)
String accessToken = jwtTokenUtil.generateAccessToken(
    user.getUserId(), user.getUsername());

// âœ… æ–¹æ¡ˆB: ä¼ é€’å®Œæ•´å‚æ•°
List<String> roles = userRoleService.getUserRoles(user.getUserId());
List<String> permissions = permissionService.getUserPermissions(user.getUserId());
String accessToken = jwtTokenUtil.generateAccessToken(
    user.getUserId(), user.getUsername(), roles, permissions);
```

**æ­¥éª¤3: æ³¨å…¥ SecurityManager ä¾èµ–**

```java
@Slf4j
@Service
public class UserOpenApiServiceImpl implements UserOpenApiService {
    
    @Resource
    private JwtTokenUtil jwtTokenUtil;
    
    // âœ… æ–°å¢ SecurityManager æ³¨å…¥
    @Resource
    private SecurityManager securityManager;
    
    // âœ… å¦‚æœ SecurityManager ä¸å­˜åœ¨,éœ€è¦åˆ›å»ºæ¥å£
    // æ–‡ä»¶: microservices-common-security/.../SecurityManager.java
    
    // ... å…¶ä»–ä»£ç  ...
}
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… æ‰€æœ‰Serviceç±»å¿…é¡»ä½¿ç”¨ `@Service` æ³¨è§£
2. âœ… æ‰€æœ‰ä¾èµ–æ³¨å…¥å¿…é¡»ä½¿ç”¨ `@Resource` (æ¨è) æˆ– `@Autowired`
3. âœ… æ‰€æœ‰Serviceç±»å¿…é¡»æ·»åŠ  `@Slf4j` æ³¨è§£ç”¨äºæ—¥å¿—
4. âœ… å¯¼å…¥è¯­å¥å¿…é¡»æŒ‰ç…§è§„èŒƒæ’åº: Javaæ ‡å‡†åº“ â†’ ç¬¬ä¸‰æ–¹åº“ â†’ é¡¹ç›®å†…éƒ¨

**éªŒè¯æ–¹æ³•**:
```powershell
# ç¼–è¯‘éªŒè¯
cd d:\IOE-DREAM\microservices\ioedream-common-service
mvn clean compile -DskipTests

# é¢„æœŸç»“æœ: ç¼–è¯‘æˆåŠŸ,é”™è¯¯æ•°ä»60é™åˆ°0
```

#### 3.2.2 ä»»åŠ¡1.2: å®Œæˆ Jakarta EE è¿ç§»

**ç›®æ ‡**: å…¨é¢å®Œæˆ javax.* â†’ jakarta.* åŒ…åè¿ç§»

**è‡ªåŠ¨åŒ–è¿ç§»è„šæœ¬**:

**æ–‡ä»¶**: `d:\IOE-DREAM\scripts\migrate-to-jakarta.ps1`

```powershell
# IOE-DREAM Jakarta EE è¿ç§»è„šæœ¬
# ç‰ˆæœ¬: 1.0
# ç”¨é€”: è‡ªåŠ¨åŒ–æ›¿æ¢ javax.* ä¸º jakarta.*

param(
    [string]$ProjectRoot = "d:\IOE-DREAM\microservices",
    [switch]$DryRun = $false
)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Jakarta EE è¿ç§»å·¥å…·" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

$replacements = @{
    'javax.annotation.Resource' = 'jakarta.annotation.Resource'
    'javax.annotation.PostConstruct' = 'jakarta.annotation.PostConstruct'
    'javax.annotation.PreDestroy' = 'jakarta.annotation.PreDestroy'
    'javax.validation.Valid' = 'jakarta.validation.Valid'
    'javax.validation.constraints.' = 'jakarta.validation.constraints.'
    'javax.transaction.Transactional' = 'jakarta.transaction.Transactional'
    'javax.servlet.' = 'jakarta.servlet.'
    'javax.persistence.' = 'jakarta.persistence.'
}

$files = Get-ChildItem -Path $ProjectRoot -Filter "*.java" -Recurse
$totalFixed = 0

foreach ($file in $files) {
    $content = Get-Content $file.FullName -Raw
    $originalContent = $content
    $fileChanged = $false
    
    foreach ($old in $replacements.Keys) {
        $new = $replacements[$old]
        if ($content -match [regex]::Escape($old)) {
            $content = $content -replace [regex]::Escape($old), $new
            $fileChanged = $true
        }
    }
    
    if ($fileChanged) {
        if (-not $DryRun) {
            Set-Content -Path $file.FullName -Value $content -NoNewline
            Write-Host "âœ… å·²ä¿®å¤: $($file.FullName)" -ForegroundColor Green
        } else {
            Write-Host "ğŸ” éœ€è¦ä¿®å¤: $($file.FullName)" -ForegroundColor Yellow
        }
        $totalFixed++
    }
}

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "è¿ç§»å®Œæˆ!" -ForegroundColor Green
Write-Host "å…±å¤„ç†æ–‡ä»¶: $($files.Count)" -ForegroundColor White
Write-Host "ä¿®å¤æ–‡ä»¶æ•°: $totalFixed" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan

if ($DryRun) {
    Write-Host ""
    Write-Host "âš ï¸ è¿™æ˜¯é¢„è§ˆæ¨¡å¼,æœªå®é™…ä¿®æ”¹æ–‡ä»¶" -ForegroundColor Yellow
    Write-Host "æ‰§è¡Œå®é™…è¿ç§»è¯·è¿è¡Œ: .\migrate-to-jakarta.ps1" -ForegroundColor Yellow
}
```

**æ‰§è¡Œæ­¥éª¤**:

```powershell
# æ­¥éª¤1: é¢„è§ˆæ¨¡å¼ (ä¸ä¿®æ”¹æ–‡ä»¶)
cd d:\IOE-DREAM\scripts
.\migrate-to-jakarta.ps1 -DryRun

# æ­¥éª¤2: ç¡®è®¤æ— è¯¯åæ‰§è¡Œå®é™…è¿ç§»
.\migrate-to-jakarta.ps1

# æ­¥éª¤3: éªŒè¯ç¼–è¯‘
cd ..\microservices
mvn clean compile -DskipTests
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… é¡¹ç›®ä¸­**ç¦æ­¢**å‡ºç°ä»»ä½• `javax.*` åŒ…å¯¼å…¥
2. âœ… æ‰€æœ‰æ–°ä»£ç å¿…é¡»ä½¿ç”¨ `jakarta.*` å‘½åç©ºé—´
3. âœ… POMä¾èµ–å¿…é¡»ä½¿ç”¨æ”¯æŒ Jakarta çš„ç‰ˆæœ¬
4. âœ… CI/CD ä¸­å¿…é¡»æ·»åŠ  jakarta åŒ…åæ£€æŸ¥

**éªŒè¯æ£€æŸ¥ç‚¹**:
```powershell
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ javax æ®‹ç•™
cd d:\IOE-DREAM\microservices
findstr /s /i /m "import javax\." *.java

# é¢„æœŸç»“æœ: æ— ä»»ä½•åŒ¹é…
```

#### 3.2.3 ä»»åŠ¡1.3: ä¿®å¤è§†é¢‘æ¨¡å—ç±»å‹è½¬æ¢é”™è¯¯

**ç›®æ ‡**: ä¿®å¤ VideoBehaviorManagerã€VideoFaceManagerã€VideoPTZManager ä¸­çš„ç±»å‹é”™è¯¯

**æ¶‰åŠæ–‡ä»¶**:
- `d:\IOE-DREAM\microservices\microservices-common\src\main\java\net\lab1024\sa\common\video\manager\VideoBehaviorManager.java`
- `d:\IOE-DREAM\microservices\microservices-common\src\main\java\net\lab1024\sa\common\video\manager\VideoFaceManager.java`
- `d:\IOE-DREAM\microservices\microservices-common\src\main\java\net\lab1024\sa\common\video\manager\VideoPTZManager.java`

**é—®é¢˜åˆ†æä¸ä¿®å¤**:

**é”™è¯¯1: VideoBehaviorManager.java:239**
```java
// âŒ é”™è¯¯ä»£ç 
VideoBehaviorPatternEntity pattern = ...;
VideoBehaviorEntity behavior = someMethod(pattern); // ç±»å‹ä¸åŒ¹é…

// âœ… ä¿®å¤æ–¹æ¡ˆ: ç±»å‹è½¬æ¢æˆ–æ–¹æ³•è¿”å›å€¼è°ƒæ•´
VideoBehaviorPatternEntity pattern = ...;
VideoBehaviorPatternEntity result = someMethod(pattern);
```

**é”™è¯¯2: VideoFaceManager.java:147**
```java
// âŒ é”™è¯¯ä»£ç 
Long cameraId = getCameraId();
int id = cameraId; // Long â†’ int ä¸å®‰å…¨è½¬æ¢

// âœ… ä¿®å¤æ–¹æ¡ˆ: ä½¿ç”¨å®‰å…¨çš„ç±»å‹è½¬æ¢
Long cameraId = getCameraId();
int id = cameraId != null ? cameraId.intValue() : 0;
// æˆ–è€…æ›´å¥½çš„åšæ³•: ä¿®æ”¹æ–¹æ³•ç­¾åç»Ÿä¸€ä½¿ç”¨ Long
```

**é”™è¯¯3: VideoPTZManager.java:243**
```java
// âŒ é”™è¯¯ä»£ç 
VideoPTZEntity entity = dao.selectById(id);
List<VideoPTZEntity> list = entity; // å•ä¸ªå¯¹è±¡ â†’ åˆ—è¡¨ é”™è¯¯

// âœ… ä¿®å¤æ–¹æ¡ˆ: è¿”å›å€¼åŒ…è£…ä¸ºåˆ—è¡¨
VideoPTZEntity entity = dao.selectById(id);
List<VideoPTZEntity> list = entity != null ? Collections.singletonList(entity) : Collections.emptyList();
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… Manager å±‚æ–¹æ³•è¿”å›å€¼å¿…é¡»æ˜ç¡®ç±»å‹,é¿å…éšå¼è½¬æ¢
2. âœ… æ•°å€¼ç±»å‹è½¬æ¢å¿…é¡»æ˜¾å¼ä¸”å®‰å…¨ (Long.intValue() ç­‰)
3. âœ… é›†åˆç±»å‹ä¸å…è®¸éšå¼è½¬æ¢,å¿…é¡»æ˜¾å¼åŒ…è£…
4. âœ… æ‰€æœ‰ç±»å‹è½¬æ¢å¿…é¡»æ·»åŠ  null æ£€æŸ¥

#### 3.2.4 é˜¶æ®µ1 éªŒæ”¶æ ‡å‡†

**éªŒæ”¶æ¸…å•**:

| æ£€æŸ¥é¡¹ | éªŒæ”¶æ ‡å‡† | éªŒè¯æ–¹æ³• |
|-------|---------|---------|
| **ç¼–è¯‘æˆåŠŸ** | 0 ç¼–è¯‘é”™è¯¯ | `mvn clean compile -DskipTests` |
| **Jakartaè¿ç§»** | æ—  javax.* å¯¼å…¥ | `findstr /s /i "import javax\." *.java` |
| **ä»£ç è§„èŒƒ** | é€šè¿‡ PMD æ£€æŸ¥ | `mvn pmd:check` |
| **ä¾èµ–æ³¨å…¥** | æ— æœªæ³¨å…¥çš„ä¾èµ– | ä»£ç å®¡æŸ¥ |

---

### 3.3 é˜¶æ®µ2: æ¶æ„é‡æ„æ–¹æ¡ˆ (2-3å‘¨)

#### 3.3.1 ä»»åŠ¡2.1: å®Œæˆæ¨¡å—åŒ–æ‹†åˆ†

**ç›®æ ‡**: å°† microservices-common ä¸­çš„ä¸šåŠ¡ä»£ç è¿ç§»åˆ°å¯¹åº”æœåŠ¡

**è¿ç§»è®¡åˆ’è¡¨**:

| æºç›®å½• | ç›®æ ‡ä½ç½® | æ–‡ä»¶æ•° | ä¼˜å…ˆçº§ | è´Ÿè´£äºº | é¢„ä¼°å·¥æ—¶ |
|-------|---------|-------|-------|-------|---------|
| `common/access/` | ioedream-access-service | ~15 | P0 | å¼ ä¸‰ | 2å¤© |
| `common/consume/` | ioedream-consume-service | ~20 | P0 | æå›› | 3å¤© |
| `common/oa/` | ioedream-oa-service | ~18 | P0 | ç‹äº” | 3å¤© |
| `common/visitor/` | ioedream-visitor-service | ~12 | P1 | èµµå…­ | 2å¤© |
| `common/attendance/` | ioedream-attendance-service | ~14 | P1 | å­™ä¸ƒ | 2å¤© |
| `common/video/` | ioedream-video-service | ~16 | P1 | å‘¨å…« | 2å¤© |

**è¿ç§»æµç¨‹å›¾**:

```mermaid
graph TD
    A[é€‰æ‹©å¾…è¿ç§»æ¨¡å—] --> B[åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„]
    B --> C[å¤åˆ¶ä»£ç æ–‡ä»¶]
    C --> D[ä¿®æ”¹packageå£°æ˜]
    D --> E[æ›´æ–°å¯¼å…¥è¯­å¥]
    E --> F[ä¿®å¤ä¾èµ–å¼•ç”¨]
    F --> G[æ›´æ–°POMä¾èµ–]
    G --> H[ç¼–è¯‘éªŒè¯]
    H --> I{ç¼–è¯‘æˆåŠŸ?}
    I -->|å¦| F
    I -->|æ˜¯| J[å•å…ƒæµ‹è¯•éªŒè¯]
    J --> K{æµ‹è¯•é€šè¿‡?}
    K -->|å¦| F
    K -->|æ˜¯| L[ä»£ç å®¡æŸ¥]
    L --> M[åˆå¹¶ä»£ç ]
    M --> N[åˆ é™¤æºæ–‡ä»¶]
```

**è¯¦ç»†å®æ–½æ­¥éª¤ (ä»¥ access æ¨¡å—ä¸ºä¾‹)**:

**æ­¥éª¤1: åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„**

```powershell
# ç›®æ ‡è·¯å¾„
cd d:\IOE-DREAM\microservices\ioedream-access-service\src\main\java\net\lab1024\sa

# åˆ›å»ºç›®å½•
mkdir -p access\manager
mkdir -p access\service
mkdir -p access\domain
```

**æ­¥éª¤2: å¤åˆ¶ä»£ç æ–‡ä»¶**

```powershell
# æºè·¯å¾„
$source = "d:\IOE-DREAM\microservices\microservices-common\src\main\java\net\lab1024\sa\common\access"
# ç›®æ ‡è·¯å¾„  
$target = "d:\IOE-DREAM\microservices\ioedream-access-service\src\main\java\net\lab1024\sa\access"

# å¤åˆ¶æ–‡ä»¶
Copy-Item -Path $source\* -Destination $target -Recurse
```

**æ­¥éª¤3: æ‰¹é‡ä¿®æ”¹ package å£°æ˜**

```powershell
# ä¿®æ”¹packageå£°æ˜è„šæœ¬
$files = Get-ChildItem -Path $target -Filter "*.java" -Recurse

foreach ($file in $files) {
    $content = Get-Content $file.FullName -Raw
    $content = $content -replace 'package net\.lab1024\.sa\.common\.access', 'package net.lab1024.sa.access'
    Set-Content -Path $file.FullName -Value $content -NoNewline
}
```

**æ­¥éª¤4: æ›´æ–°å¯¼å…¥è¯­å¥**

```powershell
# æ›´æ–°å¯¼å…¥è¯­å¥
foreach ($file in $files) {
    $content = Get-Content $file.FullName -Raw
    $content = $content -replace 'import net\.lab1024\.sa\.common\.access\.', 'import net.lab1024.sa.access.'
    Set-Content -Path $file.FullName -Value $content -NoNewline
}
```

**æ­¥éª¤5: æ›´æ–° POM ä¾èµ–**

**æ–‡ä»¶**: `d:\IOE-DREAM\microservices\ioedream-access-service\pom.xml`

```xml
<dependencies>
    <!-- âœ… ä¿ç•™å¿…è¦çš„å…¬å…±ä¾èµ– -->
    <dependency>
        <groupId>net.lab1024.sa</groupId>
        <artifactId>microservices-common-core</artifactId>
    </dependency>
    
    <dependency>
        <groupId>net.lab1024.sa</groupId>
        <artifactId>microservices-common-security</artifactId>
    </dependency>
    
    <dependency>
        <groupId>net.lab1024.sa</groupId>
        <artifactId>microservices-common-data</artifactId>
    </dependency>
    
    <!-- âŒ ç§»é™¤å¯¹ microservices-common çš„ä¾èµ– -->
    <!--
    <dependency>
        <groupId>net.lab1024.sa</groupId>
        <artifactId>microservices-common</artifactId>
    </dependency>
    -->
</dependencies>
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… åŒ…åå¿…é¡»éµå¾ªè§„èŒƒ: `net.lab1024.sa.{æœåŠ¡å}.{æ¨¡å—}`
2. âœ… ä¸šåŠ¡ä»£ç **ç¦æ­¢**æ”¾åœ¨ common æ¨¡å—
3. âœ… è¿ç§»åå¿…é¡»åˆ é™¤æºæ–‡ä»¶,é¿å…é‡å¤å®šä¹‰
4. âœ… æ¯æ¬¡è¿ç§»åå¿…é¡»è¿›è¡Œç¼–è¯‘å’Œæµ‹è¯•éªŒè¯

#### 3.3.2 ä»»åŠ¡2.2: é‡æ„ä¾èµ–å…³ç³»

**ç›®æ ‡**: å»ºç«‹æ¸…æ™°çš„ä¾èµ–å±‚æ¬¡,æ¶ˆé™¤å¾ªç¯ä¾èµ–

**æ­£ç¡®çš„ä¾èµ–å±‚æ¬¡å›¾**:

```mermaid
graph TB
    subgraph "ç¬¬1å±‚: æ ¸å¿ƒåŸºç¡€"
        Core[microservices-common-core<br/>ResponseDTO/Exception/Constants]
    end
    
    subgraph "ç¬¬2å±‚: åŠŸèƒ½æ¨¡å—"
        Security[common-security<br/>JWT/RBAC]
        Data[common-data<br/>MyBatis/EntityåŸºç±»]
        Cache[common-cache<br/>Redis/Caffeine]
        Monitor[common-monitor<br/>Metrics]
    end
    
    subgraph "ç¬¬3å±‚: ä¸šåŠ¡å…¬å…±"
        Business[common-business<br/>ä»…é€šç”¨ä¸šåŠ¡å·¥å…·]
    end
    
    subgraph "ç¬¬4å±‚: ä¸šåŠ¡æœåŠ¡"
        Common[ioedream-common-service<br/>ç”¨æˆ·/æƒé™/ç»„ç»‡]
        Access[ioedream-access-service]
        OA[ioedream-oa-service]
    end
    
    Security --> Core
    Data --> Core
    Cache --> Core
    Monitor --> Core
    
    Business --> Security
    Business --> Data
    
    Common --> Security
    Common --> Data
    Common --> Cache
    
    Access --> Security
    Access --> Data
    OA --> Business
    
    style Core fill:#51cf66
    style Security fill:#4dabf7
    style Data fill:#4dabf7
    style Business fill:#ffd43b
    style Common fill:#ff8787
```

**ä¾èµ–ç®¡ç†è§„èŒƒ**:

**æ–‡ä»¶**: `d:\IOE-DREAM\microservices\pom.xml` (çˆ¶POM)

```xml
<dependencyManagement>
    <dependencies>
        <!-- å†…éƒ¨æ¨¡å—ç‰ˆæœ¬ç»Ÿä¸€ç®¡ç† -->
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-core</artifactId>
            <version>${project.version}</version>
        </dependency>
        
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-security</artifactId>
            <version>${project.version}</version>
        </dependency>
        
        <!-- ... å…¶ä»–æ¨¡å— ... -->
    </dependencies>
</dependencyManagement>

<!-- âœ… æ­£ç¡®çš„æ¨¡å—æ„å»ºé¡ºåº -->
<modules>
    <!-- ç¬¬1å±‚: æ ¸å¿ƒ -->
    <module>microservices-common-core</module>
    
    <!-- ç¬¬2å±‚: åŠŸèƒ½æ¨¡å— -->
    <module>microservices-common-security</module>
    <module>microservices-common-data</module>
    <module>microservices-common-cache</module>
    <module>microservices-common-monitor</module>
    <module>microservices-common-permission</module>
    
    <!-- ç¬¬3å±‚: ä¸šåŠ¡å…¬å…± -->
    <module>microservices-common-business</module>
    <module>microservices-common-export</module>
    <module>microservices-common-workflow</module>
    
    <!-- ç¬¬4å±‚: èšåˆæ¨¡å— (å¯é€‰) -->
    <!-- <module>microservices-common</module> å»ºè®®ç§»é™¤æˆ–ä»…ä½œèšåˆ -->
    
    <!-- ç¬¬5å±‚: ä¸šåŠ¡æœåŠ¡ -->
    <module>ioedream-db-init</module>
    <module>ioedream-gateway-service</module>
    <module>ioedream-common-service</module>
    <module>ioedream-device-comm-service</module>
    <module>ioedream-oa-service</module>
    <module>ioedream-access-service</module>
    <module>ioedream-attendance-service</module>
    <module>ioedream-video-service</module>
    <module>ioedream-consume-service</module>
    <module>ioedream-visitor-service</module>
</modules>
```

**ä¾èµ–å†²çªæ£€æµ‹è„šæœ¬**:

**æ–‡ä»¶**: `d:\IOE-DREAM\scripts\check-dependency-cycles.ps1`

```powershell
# ä¾èµ–å¾ªç¯æ£€æµ‹è„šæœ¬
Write-Host "æ£€æŸ¥Mavenä¾èµ–å¾ªç¯..." -ForegroundColor Cyan

cd d:\IOE-DREAM\microservices

# ä½¿ç”¨ Maven ä¾èµ–æ’ä»¶æ£€æŸ¥
mvn dependency:tree -Dverbose 2>&1 | Tee-Object -Variable output

# æ£€æŸ¥å¾ªç¯ä¾èµ–
if ($output -match "cycle") {
    Write-Host "âŒ å‘ç°å¾ªç¯ä¾èµ–!" -ForegroundColor Red
    $output | Select-String "cycle"
    exit 1
} else {
    Write-Host "âœ… æ— å¾ªç¯ä¾èµ–" -ForegroundColor Green
}
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… ä¾èµ–æ–¹å‘å¿…é¡»ä»ä¸Šå±‚åˆ°ä¸‹å±‚,**ç¦æ­¢**åå‘ä¾èµ–
2. âœ… å…¬å…±æ¨¡å—**ç¦æ­¢**ä¾èµ–ä¸šåŠ¡æ¨¡å—
3. âœ… ä¸šåŠ¡æ¨¡å—ä¹‹é—´**ç¦æ­¢**ç›¸äº’ä¾èµ–,å¿…é¡»é€šè¿‡APIé€šä¿¡
4. âœ… æ¯æ¬¡ä¿®æ”¹ä¾èµ–åå¿…é¡»è¿è¡Œå¾ªç¯ä¾èµ–æ£€æµ‹

#### 3.3.3 ä»»åŠ¡2.3: æ¸…ç† microservices-common

**ç›®æ ‡**: å°† microservices-common è½¬æ¢ä¸ºè½»é‡çº§èšåˆæ¨¡å—æˆ–å®Œå…¨ç§»é™¤

**æ–¹æ¡ˆA: è½¬æ¢ä¸ºèšåˆæ¨¡å— (æ¨è)**

**æ–‡ä»¶**: `d:\IOE-DREAM\microservices\microservices-common\pom.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project>
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>net.lab1024.sa</groupId>
        <artifactId>ioedream-microservices-parent</artifactId>
        <version>1.0.0</version>
    </parent>
    
    <artifactId>microservices-common</artifactId>
    <packaging>pom</packaging>
    <name>IOE-DREAM :: Common Libraries Aggregator</name>
    <description>å…¬å…±åº“èšåˆæ¨¡å— - ä»…ç”¨äºç®€åŒ–ä¾èµ–ç®¡ç†</description>
    
    <!-- âœ… ä»…èšåˆä¾èµ–,ä¸åŒ…å«ä»»ä½•ä»£ç  -->
    <dependencies>
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-core</artifactId>
        </dependency>
        
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-security</artifactId>
        </dependency>
        
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-data</artifactId>
        </dependency>
        
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-cache</artifactId>
        </dependency>
        
        <dependency>
            <groupId>net.lab1024.sa</groupId>
            <artifactId>microservices-common-monitor</artifactId>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <!-- è·³è¿‡ repackage,å› ä¸ºè¿™æ˜¯èšåˆæ¨¡å— -->
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <skip>true</skip>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

**æ¸…ç†æ­¥éª¤**:

```powershell
# 1. å¤‡ä»½ç°æœ‰ä»£ç 
cd d:\IOE-DREAM\microservices\microservices-common
$backupDir = "d:\IOE-DREAM\backup-microservices-common-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
Copy-Item -Path . -Destination $backupDir -Recurse

# 2. åˆ é™¤ src ç›®å½• (æ‰€æœ‰ä»£ç å·²è¿ç§»)
Remove-Item -Path src -Recurse -Force

# 3. æ›´æ–° pom.xml ä¸ºèšåˆæ¨¡å¼ (å¦‚ä¸Šæ‰€ç¤º)

# 4. éªŒè¯ç¼–è¯‘
cd ..
mvn clean install -DskipTests -pl microservices-common
```

**æ–¹æ¡ˆB: å®Œå…¨ç§»é™¤ (æ¿€è¿›æ–¹æ¡ˆ)**

```powershell
# 1. ä»çˆ¶POMç§»é™¤æ¨¡å—å¼•ç”¨
# ç¼–è¾‘ d:\IOE-DREAM\microservices\pom.xml
# åˆ é™¤ <module>microservices-common</module>

# 2. æ›´æ–°æ‰€æœ‰æœåŠ¡çš„POM,ç§»é™¤å¯¹ microservices-common çš„ä¾èµ–
# æ›¿æ¢ä¸ºå…·ä½“çš„å­æ¨¡å—ä¾èµ–

# 3. åˆ é™¤ç›®å½•
Remove-Item -Path d:\IOE-DREAM\microservices\microservices-common -Recurse -Force
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… å¦‚æœä¿ç•™èšåˆæ¨¡å—,å¿…é¡»è®¾ç½® `<packaging>pom</packaging>`
2. âœ… èšåˆæ¨¡å—**ç¦æ­¢**åŒ…å«ä»»ä½• Java ä»£ç 
3. âœ… æ‰€æœ‰æœåŠ¡ä¾èµ–å¿…é¡»æ˜ç¡®åˆ—å‡ºå…·ä½“çš„å­æ¨¡å—
4. âœ… æ¸…ç†åå¿…é¡»æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡£

#### 3.3.4 é˜¶æ®µ2 éªŒæ”¶æ ‡å‡†

**éªŒæ”¶æ¸…å•**:

| æ£€æŸ¥é¡¹ | éªŒæ”¶æ ‡å‡† | éªŒè¯æ–¹æ³• |
|-------|---------|---------|
| **æ¨¡å—åŒ–æ‹†åˆ†** | 6ä¸ªä¸šåŠ¡ç›®å½•å…¨éƒ¨è¿ç§» | æ£€æŸ¥ microservices-common/src |
| **ä¾èµ–å…³ç³»** | æ— å¾ªç¯ä¾èµ– | `.\scripts\check-dependency-cycles.ps1` |
| **ç¼–è¯‘æˆåŠŸ** | æ‰€æœ‰æ¨¡å—ç¼–è¯‘é€šè¿‡ | `mvn clean install -DskipTests` |
| **æ¶æ„åˆè§„** | é€šè¿‡æ¶æ„æ£€æŸ¥ | ä»£ç å®¡æŸ¥ + è‡ªåŠ¨åŒ–å·¥å…· |
| **æ–‡æ¡£æ›´æ–°** | æ¶æ„æ–‡æ¡£åŒæ­¥æ›´æ–° | æ–‡æ¡£å®¡æŸ¥ |

---

### 3.4 é˜¶æ®µ3: è´¨é‡æå‡æ–¹æ¡ˆ (1å‘¨)

#### 3.4.1 ä»»åŠ¡3.1: å»ºç«‹ CI/CD è´¨é‡é—¨ç¦

**ç›®æ ‡**: å»ºç«‹å¼ºåˆ¶æ€§çš„è´¨é‡æ£€æŸ¥,é˜²æ­¢ä¸è§„èŒƒä»£ç åˆå¹¶

**CI/CD æµæ°´çº¿æ¶æ„å›¾**:

```mermaid
graph LR
    A[ä»£ç æäº¤] --> B[ç¼–è¯‘æ£€æŸ¥]
    B --> C[å•å…ƒæµ‹è¯•]
    C --> D[ä»£ç è´¨é‡æ‰«æ]
    D --> E[æ¶æ„åˆè§„æ£€æŸ¥]
    E --> F[JakartaåŒ…åæ£€æŸ¥]
    F --> G[ä¾èµ–å†²çªæ£€æµ‹]
    G --> H{å…¨éƒ¨é€šè¿‡?}
    H -->|æ˜¯| I[å…è®¸åˆå¹¶]
    H -->|å¦| J[é˜»æ­¢åˆå¹¶<br/>é€šçŸ¥å¼€å‘è€…]
    
    style H fill:#ffd43b
    style I fill:#51cf66
    style J fill:#ff6b6b
```

**GitLab CI é…ç½®æ–‡ä»¶**:

**æ–‡ä»¶**: `d:\IOE-DREAM\.gitlab-ci.yml`

```yaml
# IOE-DREAM CI/CD æµæ°´çº¿é…ç½®
# ç‰ˆæœ¬: 2.0 - ä¼ä¸šçº§è´¨é‡é—¨ç¦

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"

cache:
  paths:
    - .m2/repository/

stages:
  - validate
  - build
  - test
  - quality
  - deploy

# ========================================
# é˜¶æ®µ1: éªŒè¯é˜¶æ®µ
# ========================================

validate:jakarta-migration:
  stage: validate
  script:
    - echo "æ£€æŸ¥ Jakarta è¿ç§»çŠ¶æ€..."
    - |
      if grep -r "import javax\." microservices/*/src --include="*.java"; then
        echo "âŒ å‘ç° javax.* åŒ…å¯¼å…¥,å¿…é¡»è¿ç§»åˆ° jakarta.*"
        exit 1
      fi
    - echo "âœ… Jakarta è¿ç§»æ£€æŸ¥é€šè¿‡"
  only:
    - merge_requests
    - main
    - develop

validate:architecture-compliance:
  stage: validate
  script:
    - echo "æ£€æŸ¥æ¶æ„åˆè§„æ€§..."
    - chmod +x scripts/check-architecture-compliance.ps1
    - pwsh scripts/check-architecture-compliance.ps1
  only:
    - merge_requests
    - main

# ========================================
# é˜¶æ®µ2: æ„å»ºé˜¶æ®µ
# ========================================

build:compile:
  stage: build
  script:
    - echo "ç¼–è¯‘é¡¹ç›®..."
    - cd microservices
    - mvn $MAVEN_CLI_OPTS clean compile -DskipTests
  artifacts:
    paths:
      - microservices/*/target/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop

# ========================================
# é˜¶æ®µ3: æµ‹è¯•é˜¶æ®µ
# ========================================

test:unit-tests:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - cd microservices
    - mvn $MAVEN_CLI_OPTS test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit:
        - microservices/*/target/surefire-reports/TEST-*.xml
    paths:
      - microservices/*/target/site/jacoco/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# ========================================
# é˜¶æ®µ4: è´¨é‡æ£€æŸ¥é˜¶æ®µ
# ========================================

quality:pmd-check:
  stage: quality
  script:
    - echo "è¿è¡Œ PMD ä»£ç è´¨é‡æ£€æŸ¥..."
    - cd microservices
    - mvn $MAVEN_CLI_OPTS pmd:check
  allow_failure: false  # âŒ ä¸å…è®¸å¤±è´¥
  only:
    - merge_requests
    - main

quality:dependency-check:
  stage: quality
  script:
    - echo "æ£€æŸ¥ä¾èµ–å†²çª..."
    - cd microservices
    - mvn $MAVEN_CLI_OPTS dependency:analyze
    - |
      if mvn dependency:tree | grep -i "cycle"; then
        echo "âŒ å‘ç°å¾ªç¯ä¾èµ–"
        exit 1
      fi
  only:
    - merge_requests
    - main

quality:code-coverage:
  stage: quality
  script:
    - echo "æ£€æŸ¥ä»£ç è¦†ç›–ç‡..."
    - cd microservices
    - mvn $MAVEN_CLI_OPTS jacoco:check
  coverage: '/Total.*?([0-9]{1,3})%/'
  only:
    - merge_requests
    - main
  allow_failure: true  # âš ï¸ åˆæœŸå…è®¸å¤±è´¥,åæœŸæ”¹ä¸º false

# ========================================
# é˜¶æ®µ5: éƒ¨ç½²é˜¶æ®µ
# ========================================

deploy:staging:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    - # éƒ¨ç½²è„šæœ¬
  environment:
    name: staging
  only:
    - develop

deploy:production:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - # éƒ¨ç½²è„šæœ¬
  environment:
    name: production
  only:
    - main
  when: manual  # ç”Ÿäº§éƒ¨ç½²éœ€è¦æ‰‹åŠ¨è§¦å‘
```

**æ¶æ„åˆè§„æ£€æŸ¥è„šæœ¬**:

**æ–‡ä»¶**: `d:\IOE-DREAM\scripts\check-architecture-compliance.ps1`

```powershell
# IOE-DREAM æ¶æ„åˆè§„æ€§æ£€æŸ¥è„šæœ¬
# ç‰ˆæœ¬: 1.0

param(
    [string]$ProjectRoot = "d:\IOE-DREAM\microservices"
)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "æ¶æ„åˆè§„æ€§æ£€æŸ¥" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

$violations = @()
$errorCount = 0

# ========================================
# æ£€æŸ¥1: ä¸šåŠ¡ä»£ç ä¸åº”åœ¨ microservices-common
# ========================================
Write-Host "[æ£€æŸ¥1] ä¸šåŠ¡ä»£ç ä½ç½®æ£€æŸ¥..." -ForegroundColor Yellow

$commonPath = Join-Path $ProjectRoot "microservices-common\src"
if (Test-Path $commonPath) {
    $businessDirs = @("access", "consume", "oa", "visitor", "attendance", "video")
    
    foreach ($dir in $businessDirs) {
        $dirPath = Join-Path $commonPath "main\java\net\lab1024\sa\common\$dir"
        if (Test-Path $dirPath) {
            $violations += "âŒ å‘ç°ä¸šåŠ¡ä»£ç åœ¨å…¬å…±æ¨¡å—: $dir/"
            $errorCount++
        }
    }
}

if ($errorCount -eq 0) {
    Write-Host "  âœ… é€šè¿‡" -ForegroundColor Green
}

# ========================================
# æ£€æŸ¥2: @Repository æ³¨è§£ä½¿ç”¨æ£€æŸ¥
# ========================================
Write-Host "[æ£€æŸ¥2] DAOå±‚æ³¨è§£æ£€æŸ¥..." -ForegroundColor Yellow

$repositoryUsage = Select-String -Path "$ProjectRoot\*\src" -Pattern "@Repository" -Recurse -Include "*.java"
if ($repositoryUsage) {
    $violations += "âŒ å‘ç° @Repository æ³¨è§£ä½¿ç”¨,åº”ä½¿ç”¨ @Mapper"
    $errorCount++
    $repositoryUsage | ForEach-Object {
        Write-Host "  $($_.Path):$($_.LineNumber)" -ForegroundColor Red
    }
} else {
    Write-Host "  âœ… é€šè¿‡" -ForegroundColor Green
}

# ========================================
# æ£€æŸ¥3: æ—¥å¿—æ³¨è§£ç¼ºå¤±æ£€æŸ¥
# ========================================
Write-Host "[æ£€æŸ¥3] Serviceç±»æ—¥å¿—æ³¨è§£æ£€æŸ¥..." -ForegroundColor Yellow

$serviceFiles = Get-ChildItem -Path "$ProjectRoot\*\src" -Filter "*Service.java" -Recurse
$missingSlf4j = 0

foreach ($file in $serviceFiles) {
    $content = Get-Content $file.FullName -Raw
    if ($content -match "@Service" -and $content -notmatch "@Slf4j") {
        $violations += "âš ï¸ Serviceç±»ç¼ºå°‘ @Slf4j: $($file.Name)"
        $missingSlf4j++
    }
}

if ($missingSlf4j -eq 0) {
    Write-Host "  âœ… é€šè¿‡" -ForegroundColor Green
} else {
    Write-Host "  âš ï¸ å‘ç° $missingSlf4j ä¸ªServiceç±»ç¼ºå°‘ @Slf4j" -ForegroundColor Yellow
}

# ========================================
# è¾“å‡ºç»“æœ
# ========================================
Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "æ£€æŸ¥ç»“æœ" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

if ($errorCount -gt 0) {
    Write-Host "âŒ æ¶æ„åˆè§„æ€§æ£€æŸ¥å¤±è´¥!" -ForegroundColor Red
    Write-Host "å‘ç° $errorCount ä¸ªä¸¥é‡è¿è§„é¡¹:" -ForegroundColor Red
    $violations | ForEach-Object { Write-Host "  $_" -ForegroundColor Red }
    exit 1
} else {
    Write-Host "âœ… æ¶æ„åˆè§„æ€§æ£€æŸ¥é€šè¿‡!" -ForegroundColor Green
    if ($missingSlf4j -gt 0) {
        Write-Host "âš ï¸ æœ‰ $missingSlf4j ä¸ªè­¦å‘Šé¡¹,å»ºè®®ä¿®å¤" -ForegroundColor Yellow
    }
    exit 0
}
```

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… æ‰€æœ‰ä»£ç åˆå¹¶å‰**å¿…é¡»**é€šè¿‡ CI/CD æ£€æŸ¥
2. âœ… è´¨é‡é—¨ç¦**ä¸å…è®¸**è¢«è·³è¿‡æˆ–ç¦ç”¨
3. âœ… ä»£ç è¦†ç›–ç‡ç›®æ ‡: 80% (line), 75% (branch)
4. âœ… PMD æ£€æŸ¥é›¶è¿è§„ (maxAllowedViolations=0)

#### 3.4.2 ä»»åŠ¡3.2: å®Œå–„è‡ªåŠ¨åŒ–æµ‹è¯•

**ç›®æ ‡**: å»ºç«‹å®Œæ•´çš„æµ‹è¯•ä½“ç³»,ç¡®ä¿ä»£ç è´¨é‡

**æµ‹è¯•é‡‘å­—å¡”æ¶æ„**:

```mermaid
graph TD
    subgraph "æµ‹è¯•é‡‘å­—å¡”"
        E2E[ç«¯åˆ°ç«¯æµ‹è¯•<br/>5% - å…³é”®ä¸šåŠ¡æµç¨‹]
        Integration[é›†æˆæµ‹è¯•<br/>20% - æ¨¡å—é—´åä½œ]
        Unit[å•å…ƒæµ‹è¯•<br/>75% - ä¸šåŠ¡é€»è¾‘]
    end
    
    E2E --> Integration
    Integration --> Unit
    
    style E2E fill:#ff8787
    style Integration fill:#ffd43b
    style Unit fill:#51cf66
```

**å•å…ƒæµ‹è¯•è§„èŒƒ**:

**ç¤ºä¾‹**: Manager å±‚æµ‹è¯•æ¨¡æ¿

**æ–‡ä»¶**: `d:\IOE-DREAM\microservices\ioedream-access-service\src\test\java\net\lab1024\sa\access\manager\AccessManagerTest.java`

```java
package net.lab1024.sa.access.manager;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * AccessManager å•å…ƒæµ‹è¯•
 * 
 * @author IOE-DREAM Team
 * @date 2025-12-17
 */
@ExtendWith(MockitoExtension.class)
class AccessManagerTest {
    
    @Mock
    private AccessDao accessDao;
    
    @InjectMocks
    private AccessManager accessManager;
    
    @BeforeEach
    void setUp() {
        // æµ‹è¯•å‰ç½®å‡†å¤‡
    }
    
    @Test
    void testCheckAccessPermission_Success() {
        // Given: å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        String deviceCode = "DEVICE001";
        
        AccessEntity mockEntity = new AccessEntity();
        mockEntity.setUserId(userId);
        mockEntity.setStatus(1);
        
        when(accessDao.selectByUserIdAndDevice(userId, deviceCode))
            .thenReturn(mockEntity);
        
        // When: æ‰§è¡Œæµ‹è¯•æ–¹æ³•
        boolean result = accessManager.checkAccessPermission(userId, deviceCode);
        
        // Then: éªŒè¯ç»“æœ
        assertTrue(result, "åº”è¯¥è¿”å›true");
        verify(accessDao, times(1)).selectByUserIdAndDevice(userId, deviceCode);
    }
    
    @Test
    void testCheckAccessPermission_UserNotFound() {
        // Given
        Long userId = 999L;
        String deviceCode = "DEVICE001";
        when(accessDao.selectByUserIdAndDevice(userId, deviceCode))
            .thenReturn(null);
        
        // When
        boolean result = accessManager.checkAccessPermission(userId, deviceCode);
        
        // Then
        assertFalse(result, "ç”¨æˆ·ä¸å­˜åœ¨åº”è¿”å›false");
    }
    
    @Test
    void testCheckAccessPermission_NullUserId() {
        // When & Then
        assertThrows(IllegalArgumentException.class, () -> {
            accessManager.checkAccessPermission(null, "DEVICE001");
        }, "userIdä¸ºnullåº”æŠ›å‡ºå¼‚å¸¸");
    }
}
```

**æµ‹è¯•è¦†ç›–ç‡è¦æ±‚**:

| ä»£ç å±‚çº§ | è¦†ç›–ç‡ç›®æ ‡ | é‡ç‚¹æµ‹è¯•å†…å®¹ |
|---------|-----------|------------|
| **Controller** | 60%+ | å‚æ•°éªŒè¯ã€æƒé™æ£€æŸ¥ã€å¼‚å¸¸å¤„ç† |
| **Service** | 80%+ | ä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡å¤„ç†ã€å¼‚å¸¸åœºæ™¯ |
| **Manager** | 75%+ | å¤æ‚ä¸šåŠ¡é€»è¾‘ã€è¾¹ç•Œæ¡ä»¶ |
| **DAO** | 70%+ | SQLæ­£ç¡®æ€§ã€æ•°æ®æ˜ å°„ |
| **Util** | 90%+ | å·¥å…·æ–¹æ³•ã€è¾¹ç•Œå€¼ã€å¼‚å¸¸è¾“å…¥ |

**å…¨å±€ä¸€è‡´æ€§è§„èŒƒ**:
1. âœ… æ‰€æœ‰ Manager/Service æ–¹æ³•å¿…é¡»æœ‰å¯¹åº”çš„å•å…ƒæµ‹è¯•
2. âœ… æµ‹è¯•æ–¹æ³•å‘½å: `test{æ–¹æ³•å}_{åœºæ™¯}` (å¦‚ `testCheckAccess_Success`)
3. âœ… æµ‹è¯•ç»“æ„å¿…é¡»éµå¾ª Given-When-Then æ¨¡å¼
4. âœ… ä½¿ç”¨ Mockito è¿›è¡Œä¾èµ– Mock,é¿å…çœŸå®æ•°æ®åº“æ“ä½œ

#### 3.4.3 ä»»åŠ¡3.3: åˆ¶å®šå¼€å‘è§„èŒƒ

**ç›®æ ‡**: å»ºç«‹ç»Ÿä¸€çš„å¼€å‘è§„èŒƒ,ç¡®ä¿ä»£ç ä¸€è‡´æ€§

**å¼€å‘è§„èŒƒæ–‡æ¡£**:

**æ–‡ä»¶**: `d:\IOE-DREAM\documentation\development\IOE-DREAM-CODING-STANDARDS.md`

```markdown
# IOE-DREAM ç¼–ç è§„èŒƒ

## 1. å‘½åè§„èŒƒ

### 1.1 åŒ…å
- âœ… å…¨å°å†™,å•è¯é—´ç”¨ç‚¹åˆ†éš”
- âœ… æ ¼å¼: `net.lab1024.sa.{æœåŠ¡å}.{æ¨¡å—}.{å­æ¨¡å—}`
- âŒ ç¦æ­¢ä½¿ç”¨ä¸‹åˆ’çº¿æˆ–é©¼å³°

**ç¤ºä¾‹**:
```java
âœ… package net.lab1024.sa.access.manager;
âŒ package net.lab1024.sa.access_manager;
âŒ package net.lab1024.sa.accessManager;
```

### 1.2 ç±»å
- âœ… å¤§é©¼å³° (PascalCase)
- âœ… åè¯æˆ–åè¯çŸ­è¯­
- âœ… éµå¾ªåç¼€çº¦å®š

**åç¼€çº¦å®š**:
| ç±»å‹ | åç¼€ | ç¤ºä¾‹ |
|------|------|------|
| æ§åˆ¶å™¨ | Controller | `UserController` |
| æœåŠ¡æ¥å£ | Service | `UserService` |
| æœåŠ¡å®ç° | ServiceImpl | `UserServiceImpl` |
| ä¸šåŠ¡é€»è¾‘ | Manager | `UserManager` |
| æ•°æ®è®¿é—® | Dao/Mapper | `UserDao` |
| å®ä½“ç±» | Entity | `UserEntity` |
| DTO | DTO/Form/VO | `UserDTO`, `LoginForm`, `UserVO` |

### 1.3 æ–¹æ³•å
- âœ… å°é©¼å³° (camelCase)
- âœ… åŠ¨è¯æˆ–åŠ¨è¯çŸ­è¯­
- âœ… éµå¾ªå‘½åçº¦å®š

**å‘½åçº¦å®š**:
| æ“ä½œç±»å‹ | å‰ç¼€ | ç¤ºä¾‹ |
|---------|------|------|
| æŸ¥è¯¢å•ä¸ª | get/find | `getUserById` |
| æŸ¥è¯¢åˆ—è¡¨ | list/query | `listUsers` |
| ä¿å­˜ | save/add/create | `saveUser` |
| æ›´æ–° | update/modify | `updateUser` |
| åˆ é™¤ | delete/remove | `deleteUser` |
| æ£€æŸ¥ | check/validate/verify | `checkPermission` |
| è½¬æ¢ | to/convert | `toDTO` |

### 1.4 å˜é‡å
- âœ… å°é©¼å³° (camelCase)
- âœ… æœ‰æ„ä¹‰çš„åç§°,é¿å…ç¼©å†™
- âœ… å¸ƒå°”å˜é‡ä½¿ç”¨ is/has/can å‰ç¼€

**ç¤ºä¾‹**:
```java
âœ… private String userName;
âœ… private boolean isActive;
âœ… private boolean hasPermission;

âŒ private String un;
âŒ private boolean active; // åº”è¯¥ç”¨ isActive
```

## 2. ä»£ç ç»“æ„è§„èŒƒ

### 2.1 Controller å±‚

**èŒè´£**: æ¥æ”¶è¯·æ±‚ã€å‚æ•°éªŒè¯ã€è°ƒç”¨Serviceã€è¿”å›å“åº”

**è§„èŒƒæ¨¡æ¿**:
```java
@RestController
@RequestMapping("/api/v1/users")
@Tag(name = "ç”¨æˆ·ç®¡ç†")
@Slf4j
public class UserController {
    
    @Resource
    private UserService userService;
    
    @PostMapping
    @Operation(summary = "åˆ›å»ºç”¨æˆ·")
    public ResponseDTO<Long> createUser(@Valid @RequestBody UserCreateForm form) {
        log.info("[åˆ›å»ºç”¨æˆ·] è¯·æ±‚å‚æ•°: {}", form);
        
        try {
            Long userId = userService.createUser(form);
            log.info("[åˆ›å»ºç”¨æˆ·] æˆåŠŸ, userId: {}", userId);
            return ResponseDTO.ok(userId);
        } catch (BusinessException e) {
            log.warn("[åˆ›å»ºç”¨æˆ·] ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
            return ResponseDTO.error(e.getCode(), e.getMessage());
        } catch (Exception e) {
            log
