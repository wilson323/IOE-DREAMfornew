# P0级任务执行前安全检查清单

> **📋 检查日期**: 2025-12-02  
> **📋 检查范围**: 所有P0级脚本和操作  
> **📋 检查状态**: 🔍 严格审查中  
> **📋 执行原则**: 安全第一，谨慎操作

---

## 🛡️ 执行前安全检查原则

### 核心原则
1. **只读优先**: 先执行只读扫描，不做任何修改
2. **备份先行**: 任何修改前必须先备份
3. **小范围测试**: 先在单个文件测试，再批量执行
4. **可回滚**: 确保所有操作都可以回滚
5. **人工确认**: 关键操作需要人工确认

---

## 📋 P0-1: 配置安全加固检查清单

### 第一阶段：只读扫描（安全）✅

**操作内容**:
- 扫描配置文件中的明文密码
- 生成扫描报告
- 生成环境变量模板
- 生成替换脚本（不执行）

**风险评估**: 🟢 低风险（只读操作）

**检查项**:
- [x] 脚本只读取文件，不修改
- [x] 不删除任何文件
- [x] 不执行危险命令（rm、mv等）
- [x] 生成的报告和模板可供人工审查

**执行方式**: 
```bash
# Windows PowerShell 安全执行方式
cd D:\IOE-DREAM
bash scripts/p0-security/01-encrypt-passwords.sh
```

### 第二阶段：备份操作（需确认）⏳

**操作内容**:
- 备份所有配置文件（.yml, .yaml）
- 创建 .backup 文件

**风险评估**: 🟢 低风险（只增加备份文件）

**检查项**:
- [ ] 确认有足够磁盘空间
- [ ] 备份文件命名规范（原文件名.backup）
- [ ] 不覆盖已存在的备份

**执行前确认**:
```bash
# 1. 检查磁盘空间
df -h

# 2. 统计需要备份的文件数量
find microservices -name "*.yml" -o -name "*.yaml" | wc -l

# 3. 预估备份空间需求
du -sh microservices/*/src/main/resources/
```

### 第三阶段：密码替换（高风险）⚠️

**操作内容**:
- 替换配置文件中的明文密码为环境变量引用
- 修改 .yml 和 .yaml 文件

**风险评估**: 🔴 高风险（修改配置文件）

**检查项**:
- [ ] 已完成备份
- [ ] 已人工审查替换脚本
- [ ] 已在测试环境验证
- [ ] 已准备回滚方案
- [ ] 已配置环境变量

**执行前必须**:
1. **人工审查**: 逐行检查替换脚本
2. **单文件测试**: 先在一个文件上测试
3. **验证结果**: 确认替换正确
4. **准备回滚**: 确保可以快速恢复

**回滚方案**:
```bash
# 如果出现问题，立即回滚
find microservices -name "*.backup" | while read backup; do
    original="${backup%.backup}"
    cp "$backup" "$original"
done
```

### 第四阶段：验证测试（必须）✅

**操作内容**:
- 启动服务验证配置
- 测试数据库连接
- 测试Redis连接
- 测试服务间调用

**风险评估**: 🟢 低风险（只读验证）

**检查项**:
- [ ] 所有服务能正常启动
- [ ] 数据库连接成功
- [ ] Redis连接成功
- [ ] 服务注册到Nacos成功
- [ ] 接口调用正常

---

## 📋 P0-2: 分布式追踪检查清单

### 操作内容
- 为19个服务添加Sleuth+Zipkin依赖
- 修改pom.xml文件
- 添加追踪配置到application.yml

### 风险评估
🟡 中风险（修改依赖和配置）

### 检查项
- [ ] 已备份pom.xml
- [ ] 已备份application.yml
- [ ] 依赖版本兼容性检查
- [ ] 不影响现有功能
- [ ] 可以独立回滚

---

## 📋 P0-3: Repository命名整改检查清单

### 操作内容
- 将15个@Repository注解改为@Mapper
- 修改Java源文件

### 风险评估
🟡 中风险（修改源代码）

### 检查项
- [ ] 已备份源文件
- [ ] 已通过编译测试
- [ ] 已运行单元测试
- [ ] 不影响现有功能
- [ ] Git版本控制

---

## 📋 P0-4: @Autowired违规整改检查清单

### 操作内容
- 将10个@Autowired注解改为@Resource
- 修改Java源文件（主要是测试代码）

### 风险评估
🟢 低风险（测试代码修改）

### 检查项
- [ ] 已备份源文件
- [ ] 已通过编译测试
- [ ] 已运行单元测试
- [ ] Git版本控制

---

## 📋 P0-5: RESTful API重构检查清单

### 操作内容
- 修改Controller接口定义
- 将POST改为GET/PUT/DELETE
- 添加API版本控制

### 风险评估
🔴 高风险（接口变更，影响前端）

### 检查项
- [ ] 已与前端团队沟通
- [ ] 已制定接口兼容方案
- [ ] 已准备API文档更新
- [ ] 已制定灰度发布计划
- [ ] 已准备回滚方案

---

## 🚨 紧急回滚程序

### 场景1: 配置文件损坏
```bash
# 立即恢复所有配置文件
cd D:\IOE-DREAM
find microservices -name "*.backup" | while read backup; do
    original="${backup%.backup}"
    cp "$backup" "$original"
    echo "已恢复: $original"
done
```

### 场景2: 服务无法启动
```bash
# 1. 停止所有服务
./scripts/stop-all-services.sh

# 2. 恢复配置
# 执行场景1的回滚程序

# 3. 重启服务
./scripts/start-all-services.sh
```

### 场景3: 数据库连接失败
```bash
# 1. 检查环境变量
echo $DB_PASSWORD

# 2. 恢复原配置
cp microservices/*/src/main/resources/*.backup microservices/*/src/main/resources/

# 3. 重启服务
```

---

## ✅ 执行建议

### 推荐执行顺序

1. **第一天**: 只执行P0-1第一阶段（只读扫描）
   - 生成报告
   - 人工审查
   - 制定详细方案

2. **第二天**: 执行P0-1备份和单文件测试
   - 备份所有配置
   - 在测试服务上验证
   - 确认无问题

3. **第三天**: 执行P0-1批量替换
   - 配置环境变量
   - 批量替换密码
   - 验证所有服务

4. **第四天**: 执行P0-3和P0-4（代码规范整改）
   - 风险较低
   - 可以并行执行

5. **第五天**: 开始P0-2（分布式追踪）
   - 逐个服务添加
   - 验证追踪效果

6. **第二周**: 执行P0-5（RESTful重构）
   - 需要前后端配合
   - 灰度发布

---

## 📞 紧急联系方式

- **架构委员会**: [联系方式]
- **技术负责人**: [联系方式]
- **运维团队**: [联系方式]

---

## 🎯 当前建议

**立即可执行**: P0-1第一阶段（只读扫描）
- ✅ 安全性高
- ✅ 无风险
- ✅ 生成报告供审查

**需要审查后执行**: P0-1第二、三阶段
- ⚠️ 需要人工审查报告
- ⚠️ 需要准备环境变量
- ⚠️ 需要制定详细执行计划

**暂缓执行**: P0-5 RESTful重构
- 🔴 需要前后端配合
- 🔴 需要详细的兼容方案
- 🔴 需要灰度发布计划

---

**👥 检查人**: IOE-DREAM 架构委员会  
**📅 检查日期**: 2025-12-02  
**✅ 检查结论**: P0-1第一阶段可以安全执行，其他阶段需要进一步审查

