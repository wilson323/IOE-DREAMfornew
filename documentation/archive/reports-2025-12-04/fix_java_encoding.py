#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Java文件UTF-8编码修复工具
专门修复中文字符被截断的问题（例如：控制�? -> 控制器）
"""

import os
import re
import sys
from pathlib import Path

# 更全面的被截断的中文字符修复映射
ENCODING_FIXES = {
    '控制�?': '控制器',
    '规范�?': '规范',
    '服务�?': '服务',
    '管理�?': '管理',
    '系统�?': '系统',
    '数据�?': '数据',
    '接口�?': '接口',
    '模块�?': '模块',
    '配置�?': '配置',
    '实现�?': '实现',
    '查询�?': '查询',
    '操作�?': '操作',
    '记录�?': '记录',
    '用户�?': '用户',
    '登录�?': '登录',
    '权限�?': '权限',
    '验证�?': '验证',
    '格式�?': '格式',
    '统一�?': '统一',
    '完整�?': '完整',
    '返回�?': '返回',
    '请求�?': '请求',
    '响应�?': '响应',
    '处理�?': '处理',
    '方法�?': '方法',
    '参数�?': '参数',
    '结果�?': '结果',
    '类型�?': '类型',
    '状态�?': '状态',
    '信息�?': '信息',
    '实体�?': '实体',
    '对象�?': '对象',
    '集合�?': '集合',
    '列表�?': '列表',
    '页面�?': '页面',
    '表单�?': '表单',
    '组件�?': '组件',
    '工具�?': '工具',
    '异常�?': '异常',
    '错误�?': '错误',
    '测试�?': '测试',
    '注解�?': '注解',
    '枚举�?': '枚举',
    '缓存�?': '缓存',
    '会话�?': '会话',
    '事务�?': '事务',
    '日志�?': '日志',
    '监控�?': '监控',
    '统计�?': '统计',
    '分析�?': '分析',
    '优化�?': '优化',
    '性能�?': '性能',
    '安全�?': '安全',
    '加密�?': '加密',
    '解密�?': '解密',
    '认证�?': '认证',
    '授权�?': '授权',
    '审计�?': '审计',
    '备份�?': '备份',
    '恢复�?': '恢复',
    '同步�?': '同步',
    '异步�?': '异步',
    '队列�?': '队列',
    '消息�?': '消息',
    '事件�?': '事件',
    '通知�?': '通知',
    '邮件�?': '邮件',
    '短信�?': '短信',
    '推送�?': '推送',
    '调度�?': '调度',
    '定时�?': '定时',
    '计划�?': '计划',
    '任务�?': '任务',
    '作业�?': '作业',
    '流程�?': '流程',
    '引擎�?': '引擎',
    '规则�?': '规则',
    '策略�?': '策略',
    '算法�?': '算法',
    '模板�?': '模板',
    '生成�?': '生成',
    '解析�?': '解析',
    '转换�?': '转换',
    '映射�?': '映射',
    '绑定�?': '绑定',
    '注入�?': '注入',
    '依赖�?': '依赖',
    '框架�?': '框架',
    '应用�?': '应用',
    '程序�?': '程序',
    '代码�?': '代码',
    '项目�?': '项目',
    '包�?': '包',
    '库�?': '库',
    '版本�?': '版本',
    '更新�?': '更新',
    '升级�?': '升级',
    '部署�?': '部署',
    '发布�?': '发布',
    '运行�?': '运行',
    '启动�?': '启动',
    '停止�?': '停止',
    '重启�?': '重启',
    '关闭�?': '关闭',
    '开启�?': '开启',
    '启用�?': '启用',
    '禁用�?': '禁用',
    '激活�?': '激活',
    '停用�?': '停用',
    '删除�?': '删除',
    '添加�?': '添加',
    '编辑�?': '编辑',
    '修改�?': '修改',
    '保存�?': '保存',
    '提交�?': '提交',
    '取消�?': '取消',
    '重置�?': '重置',
    '清空�?': '清空',
    '刷新�?': '刷新',
    '重新�?': '重新',
    '再次�?': '再次',
    '继续�?': '继续',
    '完成�?': '完成',
    '结束�?': '结束',
    '开始�?': '开始',
    '创建�?': '创建',
    '新建�?': '新建',
    '复制�?': '复制',
    '粘贴�?': '粘贴',
    '剪切�?': '剪切',
    '选择�?': '选择',
    '全选�?': '全选',
    '搜索�?': '搜索',
    '查找�?': '查找',
    '替换�?': '替换',
    '过滤�?': '过滤',
    '排序�?': '排序',
    '分页�?': '分页',
    '导出�?': '导出',
    '导入�?': '导入',
    '下载�?': '下载',
    '上传�?': '上传',
    '浏览�?': '浏览',
    '预览�?': '预览',
    '打印�?': '打印',
    '设置�?': '设置',
    '选项�?': '选项',
    '属性�?': '属性',
    '特性�?': '特性',
    '功能�?': '功能',
    '作用�?': '作用',
    '目的�?': '目的',
    '用途�?': '用途',
    '说明�?': '说明',
    '描述�?': '描述',
    '内容�?': '内容',
    '详细�?': '详细',
    '简介�?': '简介',
    '摘要�?': '摘要',
    '总结�?': '总结',
    '概述�?': '概述',
    '介绍�?': '介绍',
    '标题�?': '标题',
    '名称�?': '名称',
    '标识�?': '标识',
    '编号�?': '编号',
    '编码�?': '编码',
    '解码�?': '解码',
    '字符�?': '字符',
    '数字�?': '数字',
    '数值�?': '数值',
    '整数�?': '整数',
    '小数�?': '小数',
    '浮点�?': '浮点',
    '布尔�?': '布尔',
    '日期�?': '日期',
    '时间�?': '时间',
    '格式化�?': '格式化',
    '解析器�?': '解析器',
    '验证器�?': '验证器',
    '检查�?': '检查',
    '校验�?': '校验',
    '调试�?': '调试',
    '开发�?': '开发',
    '设计�?': '设计',
    '架构�?': '架构',
    '模式�?': '模式',
    '标准�?': '标准',
    '协议�?': '协议',
    '数据库�?': '数据库',
    '表�?': '表',
    '字段�?': '字段',
    '索引�?': '索引',
    '主键�?': '主键',
    '外键�?': '外键',
    '关联�?': '关联',
    '关系�?': '关系',
    '条件�?': '条件',
    '分组�?': '分组',
    '聚合�?': '聚合',
    '总计�?': '总计',
    '平均值�?': '平均值',
    '最大值�?': '最大值',
    '最小值�?': '最小值',
    '计数�?': '计数',
    '求和�?': '求和',
    '字符�': '字符',
    '数字�': '数字',
    '类型�': '类型',
    '状态�': '状态',
    '信息�': '信息',
    '对象�': '对象',
    '数据�': '数据',
    '服务�': '服务',
    '接口�': '接口',
    '方法�': '方法',
    '参数�': '参数',
    '结果�': '结果',
    '异常�': '异常',
    '错误�': '错误',
    '测试�': '测试',
    '配置�': '配置',
    '文件�': '文件',
    '目录�': '目录',
    '路径�': '路径',
    '名称�': '名称',
    '版本�': '版本',
    '时间�': '时间',
    '日期�': '日期',
    '用户�': '用户',
    '权限�': '权限',
    '角色�': '角色',
    '登录�': '登录',
    '退出�': '退出',
    '注册�': '注册',
    '密码�': '密码',
    '账号�': '账号',
    '邮箱�': '邮箱',
    '电话�': '电话',
    '地址�': '地址',
    '公司�': '公司',
    '部门�': '部门',
    '员工�': '员工',
    '管理�': '管理',
    '管理员�': '管理员',
    '操作�': '操作',
    '查询�': '查询',
    '添加�': '添加',
    '编辑�': '编辑',
    '删除�': '删除',
    '保存�': '保存',
    '提交�': '提交',
    '取消�': '取消',
    '确认�': '确认',
    '返回�': '返回',
    '继续�': '继续',
    '完成�': '完成',
    '开始�': '开始',
    '结束�': '结束',
    '启动�': '启动',
    '停止�': '停止',
    '运行�': '运行',
    '暂停�': '暂停',
    '恢复�': '恢复',
    '重置�': '重置',
    '刷新�': '刷新',
    '更新�': '更新',
    '升级�': '升级',
    '下载�': '下载',
    '上传�': '上传',
    '导入�': '导入',
    '导出�': '导出',
    '打印�': '打印',
    '预览�': '预览',
    '搜索�': '搜索',
    '查找�': '查找',
    '替换�': '替换',
    '复制�': '复制',
    '粘贴�': '粘贴',
    '剪切�': '剪切',
    '选择�': '选择',
    '全选�': '全选',
    '清空�': '清空',
    '排序�': '排序',
    '过滤�': '过滤',
    '分页�': '分页',
    '设置�': '设置',
    '配置�': '配置',
    '选项�': '选项',
    '属性�': '属性',
    '特性�': '特性',
    '功能�': '功能',
    '作用�': '作用',
    '目的�': '目的',
    '用途�': '用途',
    '说明�': '说明',
    '描述�': '描述',
    '内容�': '内容',
    '详细�': '详细',
    '简介�': '简介',
    '摘要�': '摘要',
    '总结�': '总结',
    '概述�': '概述',
    '介绍�': '介绍',
    '标题�': '标题',
    '标识�': '标识',
    '编号�': '编号',
    '编码�': '编码',
    '解码�': '解码',
}

def fix_java_encoding(file_path):
    """修复单个Java文件的编码问题"""
    try:
        # 读取文件内容
        with open(file_path, 'r', encoding='utf-8', errors='replace') as f:
            content = f.read()

        original_content = content
        fix_count = 0

        # 应用所有修复规则
        for broken, fixed in ENCODING_FIXES.items():
            if broken in content:
                content = content.replace(broken, fixed)
                fix_count += content.count(fixed) - original_content.count(fixed)

        # 如果有修复，写回文件
        if content != original_content:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            return fix_count
        else:
            return 0

    except Exception as e:
        print(f"处理文件 {file_path} 时出错: {e}")
        return 0

def main():
    """主函数"""
    # 获取当前目录
    base_dir = Path('.')

    # 统计信息
    total_files = 0
    fixed_files = 0
    total_fixes = 0

    print("开始修复Java文件UTF-8编码问题...")
    print("=" * 50)

    # 查找所有Java文件
    java_files = list(base_dir.rglob("*.java"))

    for file_path in java_files:
        total_files += 1

        # 检查文件是否包含编码问题
        try:
            with open(file_path, 'r', encoding='utf-8', errors='replace') as f:
                content = f.read()

            # 检查是否包含被截断的中文字符
            has_encoding_issues = False
            for broken in ENCODING_FIXES.keys():
                if broken in content:
                    has_encoding_issues = True
                    break

            if has_encoding_issues:
                fixes = fix_java_encoding(file_path)
                if fixes > 0:
                    fixed_files += 1
                    total_fixes += fixes
                    print(f"[FIXED] {file_path} (修复 {fixes} 处)")
                else:
                    print(f"[SKIP]  {file_path}")
        except Exception as e:
            print(f"[ERROR] 处理文件失败: {file_path} - {e}")

    print("=" * 50)
    print("修复完成！")
    print(f"总文件数: {total_files}")
    print(f"已修复文件数: {fixed_files}")
    print(f"总修复处数: {total_fixes}")

    if fixed_files > 0:
        print("\n建议执行以下命令验证修复结果:")
        print("git status")
        print("git diff --stat")

if __name__ == "__main__":
    main()