# 考勤管理模块 - 完整业务流程图设计

## 📋 模块概述

考勤管理模块是IOE-DREAM智慧园区安防综合管理平台的核心业务模块之一，基于Spring Boot 3.5.8 + Spring Cloud 2025.0.0微服务架构，提供完整的考勤管理解决方案。

### 核心功能架构

```mermaid
graph TB
    subgraph "考勤管理微服务 (ioedream-attendance-service:8091)"
        A[Controller层] --> B[Service层]
        B --> C[Manager层]
        C --> D[DAO层]

        A --> A1[AttendanceRecordController]
        A --> A2[AttendanceShiftController]
        A --> A3[AttendanceLeaveController]
        A --> A4[AttendanceOvertimeController]
        A --> A5[AttendanceSupplementController]
        A --> A6[AttendanceTravelController]

        B --> B1[AttendanceRecordService]
        B --> B2[AttendanceShiftService]
        B --> B3[AttendanceLeaveService]
        B --> B4[AttendanceOvertimeService]
        B --> B5[AttendanceSupplementService]
        B --> B6[AttendanceTravelService]

        C --> C1[AttendanceManager]
        C --> C2[ShiftRotationSystem]
        C --> C3[RuleEngine]

        D --> D1[AttendanceRecordDao]
        D --> D2[AttendanceShiftDao]
        D --> D3[AttendanceLeaveDao]
        D --> D4[AttendanceOvertimeDao]
    end

    subgraph "外部依赖"
        E[公共模块微服务]
        F[设备通讯微服务]
        G[OA工作流微服务]
        H[视频监控微服务]
    end

    A1 -.-> E
    A2 -.-> F
    A3 -.-> G
    A4 -.-> G
    A5 -.-> G
    A6 -.-> H
```

## 1. 考勤记录管理流程

### 1.1 考勤打卡核心流程

```mermaid
sequenceDiagram
    participant Employee as 员工
    participant Device as 考勤设备
    participant Gateway as API网关
    participant AttendanceService as 考勤服务
    participant CommonService as 公共服务
    participant VideoService as 视频服务
    participant DB as 数据库

    Employee->>Device: 刷卡/人脸识别
    Device->>Gateway: 推送打卡数据
    Gateway->>AttendanceService: /api/v1/attendance/record/create

    AttendanceService->>AttendanceService: 验证设备权限
    AttendanceService->>CommonService: 获取员工信息
    CommonService-->>AttendanceService: 返回员工数据

    AttendanceService->>AttendanceService: 验证打卡有效性
    AttendanceService->>AttendanceService: 判断打卡类型(上班/下班)
    AttendanceService->>DB: 保存打卡记录

    alt 需要视频联动
        AttendanceService->>VideoService: 请求视频抓拍
        VideoService-->>AttendanceService: 返回抓拍图片
        AttendanceService->>DB: 保存图片URL
    end

    AttendanceService->>AttendanceService: 触发实时考勤计算
    AttendanceService-->>Gateway: 返回打卡结果
    Gateway-->>Device: 确认接收成功
    Device-->>Employee: 显示打卡成功
```

### 1.2 移动端签到流程

```mermaid
sequenceDiagram
    participant Mobile as 移动端APP
    participant Gateway as API网关
    participant AttendanceService as 考勤服务
    participant LocationService as 定位服务
    participant CommonService as 公共服务
    participant DB as 数据库

    Mobile->>Gateway: 请求签到接口
    Gateway->>AttendanceService: /api/v1/attendance/mobile/checkin

    AttendanceService->>LocationService: 获取位置信息
    LocationService-->>AttendanceService: 返回经纬度

    AttendanceService->>AttendanceService: 验证位置有效性
    AttendanceService->>AttendanceService: 检查定位精度
    AttendanceService->>CommonService: 验证员工权限
    CommonService-->>AttendanceService: 权限验证结果

    alt 位置验证通过
        AttendanceService->>DB: 保存签到记录
        AttendanceService->>AttendanceService: 生成考勤结果
        AttendanceService-->>Gateway: 返回签到成功
        Gateway-->>Mobile: 显示签到结果
    else 位置验证失败
        AttendanceService-->>Gateway: 返回位置错误
        Gateway-->>Mobile: 显示错误信息
    end
```

## 2. 排班管理流程

### 2.1 智能排班流程

```mermaid
flowchart TD
    A[开始智能排班] --> B[选择排班对象]
    B --> C{排班对象类型}
    C -->|个人排班| D[选择个人员工]
    C -->|部门排班| E[选择部门]
    C -->|分组排班| F[选择分组]

    D --> G[设置排班时间范围]
    E --> G
    F --> G

    G --> H[获取历史考勤数据]
    H --> I[分析打卡时间规律]
    I --> J[识别最早打卡时间分布]
    J --> K[识别最晚打卡时间分布]
    K --> L[匹配最适合班次]

    L --> M[生成排班建议]
    M --> N[预览排班结果]
    N --> O{是否满意排班结果}
    O -->|否| P[调整排班参数]
    P --> I
    O -->|是| Q[确认智能排班]

    Q --> R[执行排班保存]
    R --> S[更新排班数据]
    S --> T[生成排班报告]
    T --> U[智能排班完成]
```

### 2.2 班次轮换流程

```mermaid
flowchart TD
    A[设置班次轮换] --> B[选择轮换类型]
    B --> C{轮换类型}
    C -->|三班倒| D[配置早中晚班时间]
    C -->|四班三倒| E[配置四个班次时间]
    C -->|自定义轮换| F[设置轮换规则]

    D --> G[设置早班时间]
    G --> H[设置中班时间]
    H --> I[设置晚班时间]
    I --> J[设置轮换周期]

    E --> K[设置A班时间]
    K --> L[设置B班时间]
    L --> M[设置C班时间]
    M --> N[设置D班时间]
    N --> O[设置轮换规则<br/>三天工作/一天休息]

    F --> P[设置轮换周期]
    P --> Q[设置轮换顺序]
    Q --> R[设置休息规则]

    J --> S[配置轮换人员]
    O --> S
    R --> S

    S --> T[预览轮换计划]
    T --> U[验证轮换合理性]
    U --> V{验证通过}
    V -->|否| W[调整轮换参数]
    W --> B
    V -->|是| X[保存轮换配置]
    X --> Y[轮换配置完成]
```

## 3. 异常管理流程

### 3.1 异常申请统一处理流程

```mermaid
flowchart TD
    A[异常申请入口] --> B[选择异常类型]
    B --> C{异常类型}

    C -->|补签申请| D[进入补签流程]
    C -->|请假申请| E[进入请假流程]
    C -->|加班申请| F[进入加班流程]
    C -->|调休申请| G[进入调休流程]
    C -->|调班申请| H[进入调班流程]
    C -->|销假申请| I[进入销假流程]
    C -->|周末加班| J[进入周末加班流程]

    D --> D1[选择补签类型]
    D1 --> D2[设置补签时间]
    D2 --> D3[填写申请原因]
    D3 --> D4[上传申请凭证]

    E --> E1[选择请假类型]
    E1 --> E2[设置请假时间]
    E2 --> E3[填写请假原因]
    E3 --> E4[上传请假凭证]

    F --> F1[选择加班类型]
    F1 --> F2[设置加班时间]
    F2 --> F3[填写加班原因]
    F3 --> F4[上传加班证明]

    G --> G1[检查调休资格]
    G1 --> G2[设置调休时长]
    G2 --> G3[填写调休原因]

    H --> H1[选择调班对象]
    H1 --> H2[设置调班信息]
    H2 --> H3[填写调班原因]

    I --> I1[查询有效请假记录]
    I1 --> I2[选择销假记录]
    I2 --> I3[填写实际销假时间]
    I3 --> I4[填写销假说明]
    I4 --> I5[上传销假证明]

    J --> J1[查询周末打卡记录]
    J1 --> J2[计算打卡时长]
    J2 --> J3[设置加班类型]
    J3 --> J4[填写加班说明]
    J4 --> J5[上传加班证明]

    D4 --> K[选择审批人]
    E4 --> K
    F4 --> K
    G3 --> K
    H3 --> K
    I5 --> K
    J5 --> K

    K --> L[启动审批流程]
    L --> M[异常申请提交成功]
```

### 3.2 销假特殊处理流程

```mermaid
flowchart TD
    A[发起销假申请] --> B[查询有效请假记录]
    B --> C{是否有有效请假记录}
    C -->|否| D[提示无有效请假记录]
    C -->|是| E[显示请假记录列表]
    E --> F[选择要销假的请假记录]
    F --> G[填写实际销假时间]
    G --> H{销假时间验证}
    H -->|时间无效| I[提示销假时间无效]
    H -->|时间有效| J[计算剩余假期]
    J --> K[填写销假说明]
    K --> L[上传销假证明]
    L --> M[提交销假申请]
    M --> N[进入审批流程]
    N --> O{审批结果}
    O -->|通过| P[更新请假状态为已销假]
    O -->|拒绝| Q[保持原请假状态]
    O -->|部分通过| R[调整请假结束时间]
    P --> S[更新剩余假期额度]
    R --> S
    Q --> T[通知申请人]
    R --> T
    S --> T
```

## 4. 考勤计算流程

### 4.1 实时考勤计算引擎

```mermaid
flowchart TD
    A[打卡事件触发] --> B[加载员工基础信息]
    B --> C[获取当日排班信息]
    C --> D{是否有排班记录}
    D -->|无排班| E[智能找班匹配]
    D -->|有排班| F[应用排班规则]

    E --> E1[分析历史打卡规律]
    E1 --> E2[匹配最合适班次]
    E2 --> E3{找到匹配班次}
    E3 -->|否| E4[检查是否为周末]
    E3 -->|是| F

    E4 --> E5{是否为周末且有打卡}
    E5 -->|否| E6[记录异常考勤]
    E5 -->|是| E7[周末打卡记为加班]
    E7 --> E8[计算周末加班时长]
    E8 --> E9[生成加班记录]
    E9 --> E6

    F --> F1[应用班次时间规则]
    F1 --> F2[计算工作时长]
    F2 --> F3[判断迟到早退]
    F3 --> F4[计算迟到分钟数]
    F4 --> F5[计算早退分钟数]
    F5 --> F6[判断旷工情况]
    F6 --> F7[计算旷工时长]
    F7 --> F8[计算加班时长]
    F8 --> F9[生成考勤结果]

    E6 --> G[保存考勤记录]
    F9 --> G
    G --> H[触发异常检测]
    H --> I[生成考勤统计]
    I --> J[发送通知消息]
    J --> K[计算完成]
```

### 4.2 批量考勤计算流程

```mermaid
flowchart TD
    A[启动批量计算] --> B[设置计算参数]
    B --> C[选择计算范围]
    C --> D{计算范围}
    D -->|按人员| E[选择具体人员]
    D -->|按部门| F[选择部门]
    D -->|全公司| G[全部人员]

    E --> H[设置时间范围]
    F --> H
    G --> H

    H --> I[选择计算模式]
    I --> J{计算模式}
    J -->|重新计算| K[清除原有结果]
    J -->|增量计算| L[保留已有结果]
    J -->|异常重算| M[仅重算异常]

    K --> N[开始批量处理]
    L --> N
    M --> N

    N --> O[逐个处理员工]
    O --> P[获取员工打卡数据]
    P --> Q[获取员工排班数据]
    Q --> R[获取员工异常数据]
    R --> S[执行考勤计算]
    S --> T[保存计算结果]
    T --> U{是否还有员工}
    U -->|是| O
    U -->|否| V[生成汇总统计]
    V --> W[计算完成]
```

## 5. 报表统计流程

### 5.1 动态报表生成流程

```mermaid
flowchart TD
    A[进入报表页面] --> B[设置报表参数]
    B --> C[选择报表类型]
    C --> D{报表类型}
    D -->|日报表| E[选择报表日期]
    D -->|月报表| F[选择报表月份]
    D -->|年报表| G[选择报表年份]
    D -->|自定义| H[设置时间范围]

    E --> I[选择查询范围]
    F --> I
    G --> I
    H --> I

    I --> J{查询范围}
    J -->|个人| K[选择员工]
    J -->|部门| L[选择部门]
    J -->|全公司| M[全公司范围]

    K --> N[配置显示字段]
    L --> N
    M --> N

    N --> O[可变表头配置]
    O --> P[设置排序规则]
    P --> Q[设置过滤条件]
    Q --> R[执行数据查询]
    R --> S[汇总考勤数据]
    S --> T[计算统计指标]
    T --> U[生成报表数据]
    U --> V[格式化报表展示]
    V --> W{报表操作}

    W -->|导出| X[选择导出格式]
    W -->|打印| Y[生成打印预览]
    W -->|分析| Z[生成分析图表]
    W -->|分享| AA[生成分享链接]

    X --> BB[执行导出操作]
    Y --> CC[执行打印操作]
    Z --> DD[生成数据分析]
    AA --> EE[生成分享链接]

    BB --> FF[文件下载]
    CC --> GG[打印完成]
    DD --> HH[显示分析结果]
    EE --> II[分享成功]
```

### 5.2 多维度统计分析

```mermaid
flowchart TD
    A[统计分析入口] --> B[选择分析维度]
    B --> C{分析维度}

    C -->|时间维度| D[按时间分析]
    D --> D1[按小时分析]
    D --> D2[按日分析]
    D --> D3[按周分析]
    D --> D4[按月分析]

    C -->|组织维度| E[按组织分析]
    E --> E1[按部门分析]
    E --> E2[按岗位分析]
    E --> E3[按班组分析]

    C -->|考勤状态维度| F[按状态分析]
    F --> F1[正常出勤分析]
    F --> F2[迟到分析]
    F --> F3[早退分析]
    F --> F4[旷工分析]
    F --> F5[加班分析]

    C -->|班次维度| G[按班次分析]
    G --> G1[按班次类型分析]
    G --> G2[按时间段分析]

    D1 --> H[生成统计图表]
    D2 --> H
    D3 --> H
    D4 --> H
    E1 --> H
    E2 --> H
    E3 --> H
    F1 --> H
    F2 --> H
    F3 --> H
    F4 --> H
    F5 --> H
    G1 --> H
    G2 --> H

    H --> I[可视化展示]
    I --> J[图表类型选择]
    J --> K{图表类型}
    K -->|柱状图| L[生成柱状图]
    K -->|折线图| M[生成折线图]
    K -->|饼图| N[生成饼图]
    K -->|热力图| O[生成热力图]
    K -->|仪表盘| P[生成仪表盘]

    L --> Q[图表交互功能]
    M --> Q
    N --> Q
    O --> Q
    P --> Q

    Q --> R[数据钻取]
    R --> S[详情查看]
    S --> T[导出分析结果]
```

## 6. 移动端功能流程

### 6.1 移动端考勤流程

```mermaid
sequenceDiagram
    participant Employee as 员工
    participant MobileAPP as 移动端APP
    participant Gateway as API网关
    participant AttendanceService as 考勤服务
    participant LocationService as 定位服务
    participant DeviceService as 设备服务
    participant DB as 数据库

    Employee->>MobileAPP: 打开考勤页面
    MobileAPP->>LocationService: 获取当前位置
    LocationService-->>MobileAPP: 返回经纬度

    MobileAPP->>Gateway: 请求考勤接口
    Gateway->>AttendanceService: 转发考勤请求

    AttendanceService->>LocationService: 验证位置有效性
    LocationService->>DB: 查询考勤点配置
    DB-->>LocationService: 返回考勤点数据
    LocationService-->>AttendanceService: 返回位置验证结果

    alt 位置验证通过
        AttendanceService->>DeviceService: 获取设备信息
        DeviceService-->>AttendanceService: 返回设备数据

        AttendanceService->>DB: 保存考勤记录
        AttendanceService->>AttendanceService: 生成考勤结果
        AttendanceService-->>Gateway: 返回考勤成功
        Gateway-->>MobileAPP: 显示考勤结果
        MobileAPP-->>Employee: 显示考勤成功
    else 位置验证失败
        AttendanceService-->>Gateway: 返回位置错误
        Gateway-->>MobileAPP: 显示错误信息
        MobileAPP-->>Employee: 显示错误提示
    end
```

### 6.2 移动端异常申请流程

```mermaid
flowchart TD
    A[移动端异常申请] --> B[选择申请类型]
    B --> C{申请类型}

    C -->|请假申请| D[移动端请假流程]
    C -->|加班申请| E[移动端加班流程]
    C -->|补签申请| F[移动端补签流程]
    C -->|销假申请| G[移动端销假流程]

    D --> D1[选择请假类型]
    D1 --> D2[选择请假时间]
    D2 --> D3[填写请假原因]
    D3 --> D4[拍照上传凭证]
    D4 --> D5[选择审批人]
    D5 --> D6[提交请假申请]

    E --> E1[选择加班类型]
    E1 --> E2[设置加班时间]
    E2 --> E3[填写加班事由]
    E3 --> E4[拍照上传证明]
    E4 --> E5[选择审批人]
    E5 --> E6[提交加班申请]

    F --> F1[选择补签类型]
    F1 --> F2[设置补签时间]
    F2 --> F3[填写补签原因]
    F3 --> F4[拍照上传凭证]
    F4 --> F5[选择审批人]
    F5 --> F6[提交补签申请]

    G --> G1[查看请假记录]
    G1 --> G2[选择销假记录]
    G2 --> G3[设置销假时间]
    G3 --> G4[填写销假说明]
    G4 --> G5[拍照上传证明]
    G5 --> G6[提交销假申请]

    D6 --> H[申请提交成功]
    E6 --> H
    F6 --> H
    G6 --> H

    H --> I[等待审批结果]
    I --> J[接收审批通知]
    J --> K[查看审批结果]
```

## 7. 系统集成流程

### 7.1 考勤与门禁联动流程

```mermaid
sequenceDiagram
    participant Employee as 员工
    participant AccessDevice as 门禁设备
    participant AccessService as 门禁服务
    participant AttendanceService as 考勤服务
    participant VideoService as 视频服务
    participant Gateway as API网关
    participant DB as 数据库

    Employee->>AccessDevice: 刷卡/人脸识别
    AccessDevice->>AccessService: 门禁验证请求
    AccessService->>AccessService: 验证通行权限

    alt 通行权限验证通过
        AccessService->>Gateway: 触发考勤事件
        Gateway->>AttendanceService: 考勤打卡请求

        AttendanceService->>AttendanceService: 判断考勤类型
        AttendanceService->>DB: 保存考勤记录

        alt 启用视频联动
            AttendanceService->>VideoService: 请求视频抓拍
            VideoService-->>AttendanceService: 返回抓拍图片
            AttendanceService->>DB: 保存图片URL
        end

        AttendanceService->>AttendanceService: 实时考勤计算
        AttendanceService-->>Gateway: 返回考勤结果

        AccessService-->>AccessDevice: 开启门禁
        AccessDevice-->>Employee: 门禁开启
    else 通行权限验证失败
        AccessService-->>AccessDevice: 拒绝通行
        AccessDevice-->>Employee: 通行失败
    end
```

### 7.2 考勤与OA工作流集成

```mermaid
flowchart TD
    A[考勤异常事件] --> B[触发工作流]
    B --> C[创建工作流实例]
    C --> D[选择工作流模板]
    D --> E{工作流类型}

    E -->|请假审批| F[请假审批流程]
    E -->|加班审批| G[加班审批流程]
    E -->|补签审批| H[补签审批流程]
    E -->|调班审批| I[调班审批流程]

    F --> F1[部门主管审批]
    F1 --> F2[人事审批]
    F2 --> F3[总经理审批]
    F3 --> F4[审批完成]

    G --> G1[直接主管审批]
    G1 --> G2[部门经理审批]
    G2 --> G3[人事备案]
    G3 --> G4[审批完成]

    H --> H1[直接主管审批]
    H1 --> H2[人事确认]
    H2 --> H3[审批完成]

    I --> I1[相关方确认]
    I1 --> I2[主管审批]
    I2 --> I3[人事备案]
    I3 --> I4[审批完成]

    F4 --> J[更新考勤状态]
    G4 --> J
    H3 --> J
    I4 --> J

    J --> K[通知相关人员]
    K --> L[流程结束]
```

## 8. 数据流转架构

### 8.1 考勤数据完整流转

```mermaid
graph TB
    subgraph "数据采集层"
        A1[考勤机设备]
        A2[门禁设备]
        A3[移动端APP]
        A4[Web端手动录入]
    end

    subgraph "数据传输层"
        B1[设备协议适配器]
        B2[API网关]
        B3[消息队列]
    end

    subgraph "业务处理层"
        C1[考勤服务]
        C2[实时计算引擎]
        C3[批量计算引擎]
        C4[规则引擎]
    end

    subgraph "数据存储层"
        D1[打卡记录表]
        D2[考勤结果表]
        D3[异常申请表]
        D4[排班信息表]
    end

    subgraph "数据分析层"
        E1[实时统计]
        E2[报表生成]
        E3[数据挖掘]
        E4[预测分析]
    end

    subgraph "应用展示层"
        F1[管理后台]
        F2[移动端APP]
        F3[数据大屏]
        F4[API接口]
    end

    A1 --> B1
    A2 --> B1
    A3 --> B2
    A4 --> B2

    B1 --> B3
    B2 --> B3
    B3 --> C1

    C1 --> C2
    C1 --> C3
    C2 --> C4
    C3 --> C4

    C4 --> D1
    C4 --> D2
    C4 --> D3
    C4 --> D4

    D1 --> E1
    D2 --> E1
    D3 --> E2
    D4 --> E2

    E1 --> F1
    E2 --> F1
    E3 --> F3
    E4 --> F4
```

## 9. 性能优化流程

### 9.1 高并发打卡处理

```mermaid
flowchart TD
    A[大量并发打卡请求] --> B[请求限流控制]
    B --> C[异步消息队列]
    C --> D[批量处理机制]

    D --> E[数据预加载]
    E --> F[缓存策略]
    F --> G[数据库批量写入]

    G --> H[实时计算优化]
    H --> I[增量更新策略]
    I --> J[结果缓存]

    J --> K[响应返回]

    subgraph "性能优化措施"
        L[Redis缓存]
        M[数据库连接池]
        N[读写分离]
        O[索引优化]
    end

    F -.-> L
    G -.-> M
    G -.-> N
    G -.-> O
```

## 10. 安全保障流程

### 10.1 考勤数据安全流程

```mermaid
flowchart TD
    A[考勤数据采集] --> B[数据传输加密]
    B --> C[身份认证验证]
    C --> D[权限校验]
    D --> E[数据脱敏处理]
    E --> F[数据存储加密]

    F --> G[操作审计记录]
    G --> H[数据访问控制]
    H --> I[数据备份保护]
    I --> J[数据恢复机制]

    subgraph "安全防护措施"
        K[SSL/TLS加密]
        L[JWT令牌认证]
        M[RBAC权限控制]
        N[SQL注入防护]
        O[XSS攻击防护]
    end

    B -.-> K
    C -.-> L
    D -.-> M
    E -.-> N
    E -.-> O
```

---

## 📊 流程图说明

### 设计原则

1. **用户体验优先**: 简化操作流程，提高用户使用效率
2. **数据一致性**: 确保各环节数据准确性和完整性
3. **系统稳定性**: 支持高并发访问，保证系统稳定运行
4. **扩展性**: 支持功能扩展和业务流程调整
5. **安全性**: 全流程数据安全保障

### 技术实现

1. **微服务架构**: 基于Spring Boot 3.5.8 + Spring Cloud 2025.0.0
2. **实时计算**: 支持实时考勤计算和异常检测
3. **智能算法**: 智能排班、智能找班、异常预测
4. **多端支持**: Web端、移动端、设备端全支持
5. **集成能力**: 与门禁、视频、OA等模块深度集成

### 业务价值

1. **提高效率**: 自动化考勤管理，减少人工干预
2. **降低成本**: 智能排班优化人力资源配置
3. **规范管理**: 标准化考勤流程，提高管理规范
4. **数据驱动**: 基于数据分析的决策支持
5. **风险控制**: 异常预警和风险防控机制

---

*文档版本: v1.0.0*
*创建时间: 2025-01-30*
*更新时间: 2025-01-30*
*维护人员: IOE-DREAM开发团队*