# è€ƒå‹¤ç®¡ç†æ¨¡å— - ç§»åŠ¨ç«¯è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

è€ƒå‹¤ç®¡ç†æ¨¡å—ç§»åŠ¨ç«¯åŸºäºuni-app 3.0æ¡†æ¶å¼€å‘ï¼Œæ”¯æŒiOSã€Androidã€H5ç­‰å¤šå¹³å°ï¼Œæä¾›ä¾¿æ·çš„ç§»åŠ¨è€ƒå‹¤ä½“éªŒï¼ŒåŒ…æ‹¬ç§»åŠ¨æ‰“å¡ã€å¼‚å¸¸ç”³è¯·ã€è€ƒå‹¤æŸ¥è¯¢ã€æ•°æ®ç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚

### æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph "ç§»åŠ¨ç«¯æŠ€æœ¯æ ˆ"
        A[uni-app 3.0]
        B[Vue 3.2.x]
        C[Pinia 2.x]
        D[uView UI]
        E[uni-ui]
        F[Sass 1.69.x]
        G[Vite 4.x]
    end

    subgraph "è·¨å¹³å°æ”¯æŒ"
        H[iOS App]
        I[Android App]
        J[H5ç½‘é¡µ]
        K[å¾®ä¿¡å°ç¨‹åº]
        L[æ”¯ä»˜å®å°ç¨‹åº]
    end

    subgraph "åŠŸèƒ½æ¨¡å—"
        M[ç§»åŠ¨æ‰“å¡]
        N[å¼‚å¸¸ç”³è¯·]
        O[è€ƒå‹¤æŸ¥è¯¢]
        P[æ•°æ®ç»Ÿè®¡]
        Q[æ¶ˆæ¯é€šçŸ¥]
        R[è®¾ç½®ä¸­å¿ƒ]
    end
```

## 1. æ•´ä½“ç•Œé¢è®¾è®¡

### 1.1 ç§»åŠ¨ç«¯ç•Œé¢ç»“æ„

```mermaid
layout
    direction TB
    subgraph "ç§»åŠ¨ç«¯åº”ç”¨ç»“æ„"
        A[å¯åŠ¨é¡µ] --> B[ç™»å½•é¡µ]
        B --> C[é¦–é¡µ]
        C --> D[åŠŸèƒ½é¡µé¢]
        D --> E[ä¸ªäººä¸­å¿ƒ]

        subgraph "åº•éƒ¨å¯¼èˆªæ "
            C1[è€ƒå‹¤æ‰“å¡]
            C2[æ’ç­ç®¡ç†]
            C3[å¼‚å¸¸ç”³è¯·]
            C4[æ•°æ®ç»Ÿè®¡]
            C5[æˆ‘çš„]
        end
    end
```

### 1.2 é¡µé¢å¯¼èˆªè®¾è®¡

```mermaid
flowchart TD
    A[åº”ç”¨å¯åŠ¨] --> B{å·²ç™»å½•}
    B -->|å¦| C[ç™»å½•é¡µ]
    B -->|æ˜¯| D[é¦–é¡µ]
    C --> E[ç™»å½•éªŒè¯]
    E --> F{ç™»å½•æˆåŠŸ}
    F -->|å¦| C
    F -->|æ˜¯| D
    D --> G[åº•éƒ¨å¯¼èˆª]
    G --> H[é¡µé¢åˆ‡æ¢]
```

## 2. æ ¸å¿ƒåŠŸèƒ½é¡µé¢è®¾è®¡

### 2.1 é¦–é¡µ - è€ƒå‹¤æ‰“å¡

#### 2.1.1 é¡µé¢å¸ƒå±€ç»“æ„

```mermaid
layout
    direction TB
    subgraph "è€ƒå‹¤æ‰“å¡é¡µé¢"
        A[é¡¶éƒ¨çŠ¶æ€æ ] --> B[æ—¶é—´æ˜¾ç¤ºåŒºåŸŸ]
        B --> C[ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ]
        C --> D[è€ƒå‹¤çŠ¶æ€å¡ç‰‡]
        D --> E[æ‰“å¡æ“ä½œåŒºåŸŸ]
        E --> F[ä½ç½®éªŒè¯åŒºåŸŸ]
        F --> G[ä»Šæ—¥ç»Ÿè®¡åŒºåŸŸ]
        G --> H[å¿«é€ŸåŠŸèƒ½å…¥å£]
    end

    subgraph "é¡¶éƒ¨çŠ¶æ€æ "
        A1[ç³»ç»Ÿæ—¶é—´]
        A2[ç½‘ç»œçŠ¶æ€]
        A3[ç”µæ± ç”µé‡]
        A4[æ¶ˆæ¯é€šçŸ¥]
    end

    subgraph "æ‰“å¡æ“ä½œåŒºåŸŸ"
        E1[ä¸Šç­æ‰“å¡æŒ‰é’®]
        E2[ä¸‹ç­æ‰“å¡æŒ‰é’®]
        E3[å¤–å‡ºæ‰“å¡æŒ‰é’®]
        E4[è¿”å›æ‰“å¡æŒ‰é’®]
    end

    subgraph "å¿«é€ŸåŠŸèƒ½å…¥å£"
        H1[è¯·å‡ç”³è¯·]
        H2[åŠ ç­ç”³è¯·]
        H3[è€ƒå‹¤æŸ¥è¯¢]
        H4[æ’ç­æŸ¥çœ‹]
    end
```

#### 2.1.2 é¡µé¢ç»„ä»¶å®ç°

```vue
<template>
  <view class="mobile-attendance">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <view class="status-bar">
      <view class="time-info">{{ currentTime }}</view>
      <view class="status-icons">
        <text class="icon-signal"></text>
        <text class="icon-wifi"></text>
        <text class="icon-battery"></text>
        <view class="notification-dot" v-if="hasNotification"></view>
      </view>
    </view>

    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
    <view class="user-info">
      <view class="user-avatar">
        <image :src="userInfo.avatar" mode="aspectFill" />
      </view>
      <view class="user-details">
        <text class="user-name">{{ userInfo.name }}</text>
        <text class="user-dept">{{ userInfo.department }}</text>
      </view>
      <view class="user-more" @tap="showUserMenu">
        <text class="icon-more"></text>
      </view>
    </view>

    <!-- è€ƒå‹¤çŠ¶æ€å¡ç‰‡ -->
    <view class="attendance-status-card">
      <view class="card-header">
        <text class="card-title">ä»Šæ—¥è€ƒå‹¤</text>
        <view class="status-tag" :class="getTodayStatusClass()">
          {{ getTodayStatusText() }}
        </view>
      </view>
      <view class="card-content">
        <view class="status-row">
          <view class="status-item">
            <text class="status-value">{{ todayStats.checkInTime || '--:--' }}</text>
            <text class="status-label">ä¸Šç­æ‰“å¡</text>
          </view>
          <view class="status-item">
            <text class="status-value">{{ todayStats.checkOutTime || '--:--' }}</text>
            <text class="status-label">ä¸‹ç­æ‰“å¡</text>
          </view>
        </view>
        <view class="status-row">
          <view class="status-item">
            <text class="status-value">{{ todayStats.workHours || '0' }}h</text>
            <text class="status-label">å·¥ä½œæ—¶é•¿</text>
          </view>
          <view class="status-item">
            <text class="status-value">{{ todayStats.overtimeHours || '0' }}h</text>
            <text class="status-label">åŠ ç­æ—¶é•¿</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ä½ç½®éªŒè¯åŒºåŸŸ -->
    <view class="location-verification">
      <view class="verification-status" :class="locationStatus.class">
        <text class="status-icon">{{ locationStatus.icon }}</text>
        <text class="status-text">{{ locationStatus.text }}</text>
      </view>
      <view class="location-info" v-if="locationInfo.address">
        <text class="icon-location"></text>
        <text class="location-text">{{ locationInfo.address }}</text>
        <text class="location-distance">{{ locationInfo.distance }}m</text>
      </view>
    </view>

    <!-- æ‰“å¡æ“ä½œåŒºåŸŸ -->
    <view class="clock-in-area">
      <view class="clock-buttons">
        <button
          class="clock-btn checkin-btn"
          :class="{ disabled: !canCheckIn }"
          :loading="checkingIn"
          @tap="handleCheckIn"
        >
          <text class="btn-icon">ä¸Šç­æ‰“å¡</text>
          <text class="btn-time">{{ getCurrentTime() }}</text>
        </button>
        <button
          class="clock-btn checkout-btn"
          :class="{ disabled: !canCheckOut }"
          :loading="checkingOut"
          @tap="handleCheckOut"
        >
          <text class="btn-icon">ä¸‹ç­æ‰“å¡</text>
          <text class="btn-time">{{ getCurrentTime() }}</text>
        </button>
      </view>

      <view class="extra-buttons">
        <button class="extra-btn" @tap="handleOuting">
          <text class="icon-outing"></text>
          <text>å¤–å‡º</text>
        </button>
        <button class="extra-btn" @tap="handleReturn">
          <text class="icon-return"></text>
          <text>è¿”å›</text>
        </button>
      </view>
    </view>

    <!-- ä»Šæ—¥ç»Ÿè®¡ -->
    <view class="today-stats">
      <view class="stats-header">
        <text class="stats-title">ä»Šæ—¥ç»Ÿè®¡</text>
        <text class="stats-more" @tap="viewDetailStats">æŸ¥çœ‹è¯¦æƒ… ></text>
      </view>
      <view class="stats-content">
        <view class="stats-grid">
          <view class="stats-item">
            <text class="stats-number">{{ todayStats.totalRecords }}</text>
            <text class="stats-label">æ‰“å¡æ¬¡æ•°</text>
          </view>
          <view class="stats-item">
            <text class="stats-number">{{ todayStats.normalDays }}</text>
            <text class="stats-label">æ­£å¸¸å¤©æ•°</text>
          </view>
          <view class="stats-item">
            <text class="stats-number">{{ todayStats.exceptionDays }}</text>
            <text class="stats-label">å¼‚å¸¸å¤©æ•°</text>
          </view>
          <view class="stats-item">
            <text class="stats-number">{{ todayStats.overtimeHours }}h</text>
            <text class="stats-label">åŠ ç­æ—¶é•¿</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«é€ŸåŠŸèƒ½å…¥å£ -->
    <view class="quick-actions">
      <view class="actions-header">
        <text class="actions-title">å¿«é€ŸåŠŸèƒ½</text>
      </view>
      <view class="actions-grid">
        <view class="action-item" @tap="goToLeaveApply">
          <view class="action-icon leave-icon">
            <text class="icon-calendar"></text>
          </view>
          <text class="action-text">è¯·å‡ç”³è¯·</text>
        </view>
        <view class="action-item" @tap="goToOvertimeApply">
          <view class="action-icon overtime-icon">
            <text class="icon-time"></text>
          </view>
          <text class="action-text">åŠ ç­ç”³è¯·</text>
        </view>
        <view class="action-item" @tap="goToAttendanceQuery">
          <view class="action-icon query-icon">
            <text class="icon-search"></text>
          </view>
          <text class="action-text">è€ƒå‹¤æŸ¥è¯¢</text>
        </view>
        <view class="action-item" @tap="goToScheduleView">
          <view class="action-icon schedule-icon">
            <text class="icon-schedule"></text>
          </view>
          <text class="action-text">æ’ç­æŸ¥çœ‹</text>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useUserStore } from '@/stores/user'
import { useAttendanceStore } from '@/stores/attendance'

export default {
  name: 'MobileAttendance',
  setup() {
    const userStore = useUserStore()
    const attendanceStore = useAttendanceStore()

    // å“åº”å¼æ•°æ®
    const currentTime = ref('')
    const hasNotification = ref(false)
    const checkingIn = ref(false)
    const checkingOut = ref(false)

    // è®¡ç®—å±æ€§
    const userInfo = computed(() => userStore.userInfo)
    const todayStats = computed(() => attendanceStore.todayStats)
    const canCheckIn = computed(() => !todayStats.value.checkInTime)
    const canCheckOut = computed(() => todayStats.value.checkInTime && !todayStats.value.checkOutTime)

    const locationStatus = computed(() => {
      if (attendanceStore.locationVerification) {
        return attendanceStore.locationVerification.valid ?
          { class: 'valid', icon: 'âœ“', text: 'ä½ç½®éªŒè¯é€šè¿‡' } :
          { class: 'invalid', icon: 'âœ—', text: 'ä½ç½®è¶…å‡ºèŒƒå›´' }
      }
      return { class: 'checking', icon: 'âŸ³', text: 'æ­£åœ¨éªŒè¯ä½ç½®...' }
    })

    const locationInfo = computed(() => attendanceStore.locationInfo)

    // æ–¹æ³•
    const getCurrentTime = () => {
      const now = new Date()
      return now.toTimeString()
    }

    const updateCurrentTime = () => {
      currentTime.value = getCurrentTime()
    }

    const handleCheckIn = async () => {
      if (!canCheckIn.value) return

      checkingIn.value = true
      try {
        await attendanceService.checkIn({
          type: 'CHECK_IN',
          location: locationInfo.value
        })
        uni.showToast({
          title: 'æ‰“å¡æˆåŠŸ',
          icon: 'success'
        })
      } catch (error) {
        uni.showToast({
          title: error.message,
          icon: 'none'
        })
      } finally {
        checkingIn.value = false
      }
    }

    const handleCheckOut = async () => {
      if (!canCheckOut.value) return

      checkingOut.value = true
      try {
        await attendanceService.checkOut({
          type: 'CHECK_OUT',
          location: locationInfo.value
        })
        uni.showToast({
          title: 'æ‰“å¡æˆåŠŸ',
          icon: 'success'
        })
      } catch (error) {
        uni.showToast({
          title: error.message,
          icon: 'none'
        })
      } finally {
        checkingOut.value = false
      }
    }

    // ç”Ÿå‘½å‘¨æœŸ
    onMounted(() => {
      updateCurrentTime()
      setInterval(updateCurrentTime, 1000)
      attendanceStore.loadTodayStats()
      attendanceService.startLocationMonitoring()
    })

    onUnmounted(() => {
      attendanceService.stopLocationMonitoring()
    })

    return {
      currentTime,
      hasNotification,
      checkingIn,
      checkingOut,
      userInfo,
      todayStats,
      canCheckIn,
      canCheckOut,
      locationStatus,
      locationInfo,
      getCurrentTime,
      handleCheckIn,
      handleCheckOut
    }
  }
}
</script>

<style lang="scss" scoped>
.mobile-attendance {
  padding: 0;
  background-color: #f5f5f5;
  min-height: 100vh;
}

.status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  background-color: #ffffff;
  border-bottom: 1px solid #eee;

  .time-info {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .status-icons {
    display: flex;
    gap: 10px;

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #ff4757;
      position: relative;

      &::after {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #ff4757;
        animation: pulse 1s infinite;
      }
    }
  }
}

.user-info {
  display: flex;
  align-items: center;
  padding: 20px 15px;
  background-color: #ffffff;
  margin-bottom: 10px;

  .user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 25px;
    overflow: hidden;
    margin-right: 15px;

    image {
      width: 100%;
      height: 100%;
    }
  }

  .user-details {
    flex: 1;

    .user-name {
      display: block;
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .user-dept {
      font-size: 14px;
      color: #666;
    }
  }

  .user-more {
    padding: 10px;

    .icon-more {
      font-size: 20px;
      color: #666;
    }
  }
}

.attendance-status-card {
  margin: 0 15px 15px 15px;
  background-color: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .status-tag {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;

      &.normal {
        background-color: #f6ffed;
        color: #52c41a;
      }

      &.late {
        background-color: #fffbe6;
        color: #faad14;
      }

      &.early {
        background-color: #fff7e6;
        color: #fa8c16;
      }
    }
  }

  .card-content {
    .status-row {
      display: flex;
      margin-bottom: 15px;

      &:last-child {
        margin-bottom: 0;
      }
    }

    .status-item {
      flex: 1;
      text-align: center;

      .status-value {
        display: block;
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      .status-label {
        font-size: 12px;
        color: #666;
      }
    }
  }
}

.location-verification {
  margin: 0 15px 15px 15px;

  .verification-status {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 10px;

    &.valid {
      background-color: #f6ffed;
      color: #52c41a;
    }

    &.invalid {
      background-color: #fff1f0;
      color: #ff4d4f;
    }

    &.checking {
      background-color: #e6f7ff;
      color: #1890ff;
    }

    .status-icon {
      font-size: 16px;
      margin-right: 8px;
    }
  }

  .location-info {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    background-color: #f0f0f0;
    border-radius: 8px;

    .icon-location {
      margin-right: 8px;
      color: #666;
    }

    .location-text {
      flex: 1;
      font-size: 14px;
      color: #333;
      margin-right: 10px;
    }

    .location-distance {
      font-size: 12px;
      color: #666;
    }
  }
}

.clock-in-area {
  margin: 0 15px 15px 15px;

  .clock-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;

    .clock-btn {
      flex: 1;
      height: 120px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: none;

      &.checkin-btn {
        background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
      }

      &.checkout-btn {
        background: linear-gradient(135deg, #52c41a 0%, #389e0d 100%);
      }

      &.disabled {
        background: #f5f5f5;
        color: #ccc;
      }

      .btn-icon {
        font-size: 20px;
        color: #ffffff;
        margin-bottom: 8px;
      }

      .btn-time {
        font-size: 16px;
        color: #ffffff;
      }
    }
  }

  .extra-buttons {
    display: flex;
    gap: 10px;

    .extra-btn {
      flex: 1;
      height: 50px;
      border-radius: 8px;
      background-color: #ffffff;
      border: 1px solid #e8e8e8;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;

      .icon-outing,
      .icon-return {
        font-size: 20px;
        color: #666;
        margin-bottom: 2px;
      }

      text {
        font-size: 12px;
        color: #666;
      }
    }
  }
}

.today-stats {
  margin: 0 15px 15px 15px;
  background-color: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);

  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;

    .stats-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .stats-more {
      font-size: 14px;
      color: #1890ff;
    }
  }

  .stats-content {
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;

      .stats-item {
        text-align: center;

        .stats-number {
          font-size: 24px;
          font-weight: 600;
          color: #333;
          margin-bottom: 5px;
        }

        .stats-label {
          font-size: 12px;
          color: #666;
        }
      }
    }
  }
}

.quick-actions {
  margin: 0 15px 15px 15px;
  background-color: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);

  .actions-header {
    margin-bottom: 15px;

    .actions-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;

    .action-item {
      display: flex;
      flex-direction: column;
      align-items: center;

      .action-icon {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 8px;

        &.leave-icon {
          background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }

        &.overtime-icon {
          background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
        }

        &.query-icon {
          background: linear-gradient(135deg, #4caf50 0%, #2196f3 100%);
        }

        &.schedule-icon {
          background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }

        .icon-calendar,
        .icon-time,
        .icon-search,
        .icon-schedule {
          font-size: 24px;
          color: #ffffff;
        }
      }

      .action-text {
        font-size: 12px;
        color: #666;
      }
    }
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.7;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}
</style>
```

### 2.2 å¼‚å¸¸ç”³è¯·é¡µé¢

#### 2.2.1 ç”³è¯·ç±»å‹é€‰æ‹©

```mermaid
flowchart TD
    A[è¿›å…¥å¼‚å¸¸ç”³è¯·é¡µé¢] --> B[é€‰æ‹©ç”³è¯·ç±»å‹]
    B --> C{ç”³è¯·ç±»å‹}
    C -->|è¯·å‡ç”³è¯·| D[è¿›å…¥è¯·å‡ç”³è¯·æµç¨‹]
    C -->|åŠ ç­ç”³è¯·| E[è¿›å…¥åŠ ç­ç”³è¯·æµç¨‹]
    C -->|è¡¥ç­¾ç”³è¯·| F[è¿›å…¥è¡¥ç­¾ç”³è¯·æµç¨‹]
    C -->|è°ƒä¼‘ç”³è¯·| G[è¿›å…¥è°ƒä¼‘ç”³è¯·æµç¨‹]
    C -->|è°ƒç­ç”³è¯·| H[è¿›å…¥è°ƒç­ç”³è¯·æµç¨‹]
    C -->|é”€å‡ç”³è¯·| I[è¿›å…¥é”€å‡ç”³è¯·æµç¨‹]
    C -->|å‘¨æœ«åŠ ç­| J[è¿›å…¥å‘¨æœ«åŠ ç­æµç¨‹]
```

#### 2.2.2 ç”³è¯·è¡¨å•ç»„ä»¶

```vue
<template>
  <view class="exception-apply">
    <!-- ç”³è¯·ç±»å‹é€‰æ‹© -->
    <view v-if="currentStep === 0" class="type-selection">
      <view class="selection-header">
        <text class="selection-title">é€‰æ‹©ç”³è¯·ç±»å‹</text>
      </view>
      <view class="type-grid">
        <view
          v-for="type in applyTypes"
          :key="type.value"
          class="type-item"
          :class="{ active: selectedType === type.value }"
          @tap="selectType(type.value)"
        >
          <view class="type-icon" :style="{ backgroundColor: type.color }">
            <text :style="{ color: '#ffffff' }">{{ type.icon }}</text>
          </view>
          <text class="type-title">{{ type.title }}</text>
          <text class="type-desc">{{ type.description }}</text>
        </view>
      </view>
    </view>

    <!-- è¡¨å•å¡«å†™ -->
    <view v-else-if="currentStep === 1" class="form-section">
      <view class="form-header">
        <text class="form-title">{{ getFormTitle() }}</text>
        <text class="form-step">1/3</text>
      </view>

      <view class="form-content">
        <!-- è¯·å‡ç”³è¯·è¡¨å• -->
        <template v-if="selectedType === 'leave'">
          <view class="form-item">
            <text class="form-label">è¯·å‡ç±»å‹</text>
            <picker
              :range="leaveTypes"
              range-key="value"
              @change="onLeaveTypeChange"
            >
              <view class="picker-value">
                {{ getLeaveTypeText(form.leaveType) }}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">è¯·å‡æ—¶é—´</text>
            <view class="time-range">
              <picker
                mode="date"
                :value="form.startDate"
                @change="onStartDateChange"
              >
                <view class="time-picker">
                  {{ form.startDate || 'å¼€å§‹æ—¥æœŸ' }}
                </view>
              </picker>
              <text class="time-separator">è‡³</text>
              <picker
                mode="date"
                :value="form.endDate"
                @change="onEndDateChange"
              >
                <view class="time-picker">
                  {{ form.endDate || 'ç»“æŸæ—¥æœŸ' }}
                </view>
              </picker>
            </view>
          </view>

          <view class="form-item">
            <text class="form-label">è¯·å‡å¤©æ•°</text>
            <input
              v-model="form.leaveDays"
              type="number"
              placeholder="ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—"
              disabled
              class="form-input"
            />
          </view>
        </template>

        <!-- åŠ ç­ç”³è¯·è¡¨å• -->
        <template v-else-if="selectedType === 'overtime'">
          <view class="form-item">
            <text class="form-label">åŠ ç­ç±»å‹</text>
            <picker
              :range="overtimeTypes"
              range-key="value"
              @change="onOvertimeTypeChange"
            >
              <view class="picker-value">
                {{ getOvertimeTypeText(form.overtimeType) }}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">åŠ ç­æ—¶é—´</text>
            <view class="time-range">
              <picker
                mode="datetime"
                :value="form.startTime"
                @change="onStartTimeChange"
              >
                <view class="time-picker">
                  {{ form.startTime || 'å¼€å§‹æ—¶é—´' }}
                </view>
              </picker>
              <text class="time-separator">è‡³</text>
              <picker
                mode="datetime"
                :value="form.endTime"
                @change="onEndTimeChange"
              >
                <view class="time-picker">
                  {{ form.endTime || 'ç»“æŸæ—¶é—´' }}
                </view>
              </picker>
            </view>
          </view>

          <view class="form-item">
            <text class="form-label">åŠ ç­æ—¶é•¿</text>
            <input
              v-model="form.overtimeHours"
              type="number"
              placeholder="ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—"
              disabled
              class="form-input"
            />
          </view>
        </template>
      </view>
    </view>

    <!-- é™„ä»¶ä¸Šä¼  -->
    <view v-else-if="currentStep === 2" class="upload-section">
      <view class="upload-header">
        <text class="upload-title">ä¸Šä¼ ç›¸å…³é™„ä»¶</text>
        <text class="upload-step">2/3</text>
      </view>

      <view class="upload-content">
        <view class="upload-area" @tap="chooseFile">
          <text class="upload-icon">ğŸ“·</text>
          <text class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </text>
          <text class="upload-hint">æ”¯æŒæ ¼å¼ï¼šjpgã€pngã€pdfã€docã€docx</text>
        </view>

        <view v-if="fileList.length > 0" class="file-list">
          <view
            v-for="(file, index) in fileList"
            :key="index"
            class="file-item"
          >
            <view class="file-info">
              <text class="file-icon">{{ getFileIcon(file.type) }}</text>
              <view class="file-details">
                <text class="file-name">{{ file.name }}</text>
                <text class="file-size">{{ formatFileSize(file.size) }}</text>
              </view>
            </view>
            <view class="file-actions">
              <text class="action-btn remove" @tap="removeFile(index)">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å®¡è®¤æäº¤ -->
    <view v-else-if="currentStep === 3" class="confirm-section">
      <view class="confirm-header">
        <text class="confirm-title">ç¡®è®¤ç”³è¯·ä¿¡æ¯</text>
        <text class="confirm-step">3/3</text>
      </view>

      <view class="confirm-content">
        <view class="confirm-summary">
          <view class="summary-item">
            <text class="summary-label">ç”³è¯·ç±»å‹ï¼š</text>
            <text class="summary-value">{{ getApplyTypeText(selectedType) }}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">ç”³è¯·äººï¼š</text>
            <text class="summary-value">{{ userInfo.name }}</text>
          </view>

          <template v-if="selectedType === 'leave'">
            <view class="summary-item">
              <text class="summary-label">è¯·å‡ç±»å‹ï¼š</text>
              <text class="summary-value">{{ getLeaveTypeText(form.leaveType) }}</text>
            </view>
            <view class="summary-item">
              <summary-label>è¯·å‡æ—¶é—´ï¼š</summary-label>
              <summary-value>{{ formatDateRange(form.startDate, form.endDate) }}</summary-value>
            </view>
            <view class="summary-item">
              <summary-label>è¯·å‡å¤©æ•°ï¼š</summary-label>
              <summary-value>{{ form.leaveDays }} å¤©</summary-value>
            </view>
          </template>

          <view class="summary-item">
            <text class="summary-label">ç”³è¯·åŸå› ï¼š</text>
            <text class="summary-value">{{ form.reason }}</text>
          </view>

          <view class="summary-item">
            <text class="summary-label">é™„ä»¶æ•°é‡ï¼š</text>
            <text class="summary-value">{{ fileList.length }} ä¸ªæ–‡ä»¶</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="form-actions">
      <button
        v-if="currentStep > 0"
        class="action-btn secondary"
        @tap="previousStep"
      >
        ä¸Šä¸€æ­¥
      </button>

      <button
        v-if="currentStep < 3"
        class="action-btn primary"
        @tap="nextStep"
      >
        ä¸‹ä¸€æ­¥
      </button>

      <button
        v-if="currentStep === 3"
        class="action-btn primary"
        :loading="submitting"
        @tap="submitApply"
      >
        æäº¤ç”³è¯·
      </button>

      <button class="action-btn" @tap="cancelApply">
        å–æ¶ˆ
      </button>
    </view>
  </view>
</template>
```

## 3. é¡µé¢å¯¼èˆªè®¾è®¡

### 3.1 åº•éƒ¨å¯¼èˆªæ 

```vue
<template>
  <view class="tab-bar">
    <view
      v-for="(tab, index) in tabList"
      :key="tab.id"
      class="tab-item"
      :class="{ active: currentTab === tab.id }"
      @tap="switchTab(tab.id)"
    >
      <view class="tab-icon">
        <text :class="tab.icon">{{ tab.icon }}</text>
      </view>
      <text class="tab-text">{{ tab.text }}</text>
      <view
        v-if="tab.badge > 0"
        class="tab-badge"
      >
        {{ tab.badge }}
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      currentTab: 'attendance',
      tabList: [
        {
          id: 'attendance',
          text: 'è€ƒå‹¤æ‰“å¡',
          icon: 'ğŸ‘¤',
          badge: 0
        },
        {
          id: 'schedule',
          text: 'æ’ç­ç®¡ç†',
          icon: 'ğŸ“…',
          badge: 0
        },
        {
          id: 'exception',
          text: 'å¼‚å¸¸ç”³è¯·',
          icon: 'ğŸ“',
          badge: 3
        },
        {
          id: 'statistics',
          text: 'æ•°æ®ç»Ÿè®¡',
          icon: 'ğŸ“Š',
          badge: 0
        },
        {
          id: 'profile',
          text: 'æˆ‘çš„',
          icon: 'ğŸ‘¤',
          badge: 0
        }
      ]
    }
  },
  methods: {
    switchTab(tabId) {
      this.currentTab = tabId
      uni.switchTab({
        url: `/pages/${tabId}/${tabId}`
      })
    }
  }
}
</script>
```

## 4. çŠ¶æ€ç®¡ç†

### 4.1 Pinia Storeè®¾è®¡

```javascript
// stores/attendance.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useAttendanceStore = defineStore('attendance', {
  state: () => ({
    todayStats: {
      checkInTime: null,
      checkOutTime: null,
      workHours: 0,
      overtimeHours: 0,
      totalRecords: 0,
      normalDays: 0,
      exceptionDays: 0
    },
    locationInfo: {
      longitude: null,
      latitude: null,
      address: null,
      distance: 0
    },
    locationVerification: null,
    recentRecords: []
  }),

  getters: {
    isWorkTime: (state) => {
      const now = new Date()
      const workStartTime = new Date()
      workStartTime.setHours(9, 0, 0, 0)
      const workEndTime = new Date()
      workEndTime.setHours(18, 0, 0, 0)
      return now >= workStartTime && now <= workEndTime
    },

    canCheckIn: (state) => !state.todayStats.checkInTime,
    canCheckOut: (state) => state.todayStats.checkInTime && !state.todayStats.checkOutOut
  },

  actions: {
    async loadTodayStats() {
      try {
        const response = await attendanceService.getTodayStats()
        this.todayStats = response.data
      } catch (error) {
        uni.showToast({
          title: 'è·å–ä»Šæ—¥ç»Ÿè®¡å¤±è´¥',
          icon: 'none'
        })
      }
    },

    updateLocationInfo(info) {
      this.locationInfo = info
    },

    setLocationVerification(result) {
      this.locationVerification = result
    },

    addRecord(record) {
      this.recentRecords.unshift(record)
      if (this.recentRecords.length > 10) {
        this.recentRecords = this.recentRecords.slice(0, 10)
      }
    }
  }
})
```

## 5. ç»„ä»¶åº“è®¾è®¡

### 5.1 é€šç”¨ç»„ä»¶

#### 5.1.1 é¡µé¢å¤´éƒ¨ç»„ä»¶

```vue
<template>
  <view class="page-header">
    <view class="header-left">
      <text v-if="showBack" class="back-btn" @tap="goBack">
        <text class="icon-arrow-left"></text>
      </text>
      <text class="page-title">{{ title }}</text>
    </view>
    <view class="header-right">
      <slot name="actions"></slot>
    </view>
  </view>
</template>
```

#### 5.1.2 è¡¨å•ç»„ä»¶

```vue
<template>
  <view class="form-container">
    <view
      v-for="(field, index) in fields"
      :key="index"
      class="form-field"
    >
      <text class="form-label">{{ field.label }}</text>
      <view class="form-control">
        <input
          v-if="field.type === 'input'"
          v-model="formData[field.key]"
          :placeholder="field.placeholder"
          :type="field.inputType || 'text'"
          class="form-input"
          @input="onFieldChange"
        />

        <picker
          v-else-if="field.type === 'select'"
          :range="field.options"
          range-key="value"
          :value="formData[field.key]"
          @change="onFieldChange"
        >
          <view class="picker-value">
            {{ getSelectedText(field, formData[field.key]) }}
          </view>
        </picker>

        <textarea
          v-else-if="field.type === 'textarea'"
          v-model="formData[field.key]"
          :placeholder="field.placeholder"
          :maxlength="field.maxLength"
          class="form-textarea"
          @input="onFieldChange"
        />
      </view>
      <text v-if="field.error" class="form-error">{{ field.error }}</text>
    </view>
  </view>
</template>
```

## 6. æ•°æ®æŒä¹…åŒ–

### 6.1 æœ¬åœ°å­˜å‚¨

```javascript
// utils/storage.js
class Storage {
  set(key, value) {
    try {
      uni.setStorageSync(key, JSON.stringify(value))
    } catch (error) {
      console.error('Storage set error:', error)
    }
  }

  get(key, defaultValue = null) {
    try {
      const value = uni.getStorageSync(key)
      return value ? JSON.parse(value) : defaultValue
    } catch (error) {
      console.error('Storage get error:', error)
      return defaultValue
    }
  }

  remove(key) {
    try {
      uni.removeStorageSync(key)
    } catch (error) {
      console.error('Storage remove error:', error)
    }
  }

  clear() {
    try {
      uni.clearStorageSync()
    } catch (error) {
      console.error('Storage clear error:', error)
    }
  }
}

export default new Storage()
```

### 6.2 ç¼“å­˜ç­–ç•¥

```javascript
// utils/cache.js
class CacheManager {
  constructor() {
    this.cache = new Map()
    this.maxSize = 100
  }

  set(key, value, ttl = 5 * 60 * 1000) {
    const item = {
      value,
      expiry: Date.now() + ttl,
      timestamp: Date.now()
    }

    if (this.cache.size >= this.maxSize) {
      // LRUç­–ç•¥åˆ é™¤æœ€æ—§çš„æ•°æ®
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }

    this.cache.set(key, item)
  }

  get(key) {
    const item = this.cache.get(key)

    if (!item) {
      return null
    }

    if (Date.now() > item.expiry) {
      this.cache.delete(key)
      return null
    }

    return item.value
  }

  clear() {
    this.cache.clear()
  }
}
```

## 7. ç½‘ç»œè¯·æ±‚å°è£…

### 7.1 HTTPè¯·æ±‚æ‹¦æˆªå™¨

```javascript
// utils/request.js
import { getToken } from './auth'

const baseURL = 'https://api.example.com/api/v1'

class Request {
  constructor() {
    this.baseURL = baseURL
    this.timeout = 10000
    this.interceptors = {
      request: [],
      response: []
    }
  }

  request(options) {
    return new Promise((resolve, reject) => {
      const config = {
        url: this.baseURL + options.url,
        method: options.method || 'GET',
        data: options.data,
        header: {
          'Content-Type': 'application/json',
          'Authorization': getToken()
        },
        timeout: this.timeout
      }

      // è¯·æ±‚æ‹¦æˆªå™¨
      this.interceptors.request.forEach(interceptor => {
        config = interceptor(config)
      })

      uni.request({
        ...config,
        success: (response) => {
          // å“åº”æ‹¦æˆªå™¨
          this.interceptors.response.forEach(interceptor => {
            response = interceptor(response)
          })
          resolve(response)
        },
        fail: (error) => {
          reject(error)
        }
      })
    })
  }

  get(url, params = {}) {
    return this.request({
      url,
      method: 'GET',
      data: params
    })
  }

  post(url, data = {}) {
    return this.request({
      url,
      method: 'POST',
      data
    })
  }

  put(url, data = {}) {
    return this.request({
      url,
      method: 'PUT',
      data
    })
  }

  delete(url, data = {}) {
    return this.request({
      url,
      method: 'DELETE',
      data
    })
  }
}

export default new Request()
```

## 8. è·¨å¹³å°é€‚é…

### 8.1 å¹³å°æ£€æµ‹

```javascript
// utils/platform.js
export const getPlatform = () => {
  const systemInfo = uni.getSystemInfoSync()
  return {
    platform: systemInfo.platform,
    system: systemInfo.system,
    version: systemInfo.version,
    model: systemInfo.model
  }
}

export const isIOS = () => {
  return getPlatform().platform === 'ios'
}

export const isAndroid = () => {
  return getPlatform().platform === 'android'
}

export const isH5 = () => {
  return getPlatform().platform === 'h5'
}
```

### 8.2 æ¡ä»¶ç¼–è¯‘

```javascript
// #ifdef APP-PLUS
// Appç«¯ç‰¹æœ‰åŠŸèƒ½
export const takePhoto = () => {
  return new Promise((resolve, reject) => {
    uni.chooseImage({
      count: 1,
      sourceType: ['camera'],
      success: resolve,
      fail: reject
    })
  })
}
// #endif

// #ifdef H5
// H5ç«¯ç‰¹æœ‰åŠŸèƒ½
export const takePhoto = () => {
  return new Promise((resolve, reject) => {
    // H5ç«¯ä½¿ç”¨Web API
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(resolve)
      .catch(reject)
  })
}
// #endif
```

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 å›¾ç‰‡æ‡’åŠ è½½

```vue
<template>
  <image
    :src="imageSrc"
    :lazy-load="true"
    mode="aspectFill"
    @load="onImageLoad"
    @error="onImageError"
  />
</template>

<script>
export default {
  data() {
    return {
      imageSrc: '/static/placeholder.png'
    }
  },
  methods: {
    onImageLoad(e) {
      // å›¾ç‰‡åŠ è½½å®Œæˆ
    },
    onImageError(e) {
      // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
      this.imageSrc = '/static/default.png'
    }
  }
}
</script>
```

### 9.2 åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨

```vue
<template>
  <scroll-view
    :scroll-top="scrollTop"
    :scroll-y="true"
    :scroll-anchoring="true"
    @scroll="onScroll"
    class="virtual-list"
  >
    <view class="list-item" v-for="item in visibleItems" :key="item.id">
      <!-- åˆ—è¡¨é¡¹å†…å®¹ -->
    </view>
  </scroll-view>
</template>

<script>
export default {
  data() {
    return {
      itemHeight: 50,
      visibleCount: 20,
      scrollTop: 0,
      allItems: []
    }
  },
  computed: {
    visibleItems() {
      const start = Math.floor(this.scrollTop / this.itemHeight)
      const end = start + this.visibleCount
      return this.allItems.slice(start, end)
    }
  },
  methods: {
    onScroll(e) {
      this.scrollTop = e.detail.scrollTop
    }
  }
}
</script>
```

## 10. é”™è¯¯å¤„ç†

### 10.1 å…¨å±€é”™è¯¯å¤„ç†

```javascript
// utils/errorHandler.js
class ErrorHandler {
  static handle(error) {
    console.error('Global error:', error)

    // æ˜¾ç¤ºé”™è¯¯æç¤º
    uni.showToast({
      title: this.getErrorMessage(error),
      icon: 'none',
      duration: 3000
    })

    // ä¸ŠæŠ¥é”™è¯¯åˆ°æœåŠ¡å™¨
    this.reportError(error)
  }

  static getErrorMessage(error) {
    if (typeof error === 'string') {
      return error
    }

    if (error.errMsg) {
      return error.errMsg
    }

    if (error.message) {
      return error.message
    }

    return 'æœªçŸ¥é”™è¯¯'
  }

  static reportError(error) {
    // é”™è¯¯ä¸ŠæŠ¥é€»è¾‘
    if (process.env.NODE_ENV === 'production') {
      // ä¸ŠæŠ¥åˆ°é”™è¯¯ç›‘æ§æœåŠ¡
    }
  }
}

// å…¨å±€é”™è¯¯æ•è·
uni.onError((error) => {
  ErrorHandler.handle(error)
})

export default ErrorHandler
```

---

## ğŸ“‹ æ€»ç»“

è€ƒå‹¤ç®¡ç†æ¨¡å—ç§»åŠ¨ç«¯è®¾è®¡åŸºäºuni-app 3.0æ¡†æ¶ï¼Œæä¾›è·¨å¹³å°æ”¯æŒï¼š

1. **å¤šå¹³å°é€‚é…**: iOSã€Androidã€H5ã€å°ç¨‹åºå…¨å¹³å°æ”¯æŒ
2. **ç”¨æˆ·ä½“éªŒ**: ä¾¿æ·çš„ç§»åŠ¨æ‰“å¡ã€ç›´è§‚çš„ç•Œé¢è®¾è®¡
3. **åŠŸèƒ½å®Œæ•´**: æ¶µç›–è€ƒå‹¤å…¨æµç¨‹ï¼Œæ”¯æŒç¦»çº¿æ“ä½œ
4. **æ€§èƒ½ä¼˜åŒ–**: è™šæ‹Ÿæ»šåŠ¨ã€æ‡’åŠ è½½ã€æœ¬åœ°ç¼“å­˜
5. **çŠ¶æ€ç®¡ç†**: ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†ã€æ•°æ®æŒä¹…åŒ–

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0.0*
*åˆ›å»ºæ—¶é—´: 2025-01-30*
*æ›´æ–°æ—¶é—´: 2025-01-30*
*ç»´æŠ¤äººå‘˜: IOE-DREAMç§»åŠ¨ç«¯å›¢é˜Ÿ*