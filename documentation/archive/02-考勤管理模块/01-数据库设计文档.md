# IOE-DREAM智慧园区安防综合管理平台 - 考勤管理模块数据库设计文档

> **版本**: v2.0.0
> **更新日期**: 2025-12-16
> **模块**: 考勤管理模块
> **类型**: 数据库设计文档

---

## 📋 模块概述

### 1.1 业务定位
**IOE-DREAM考勤管理模块**是智慧园区安防综合管理平台的核心业务模块，专注于企业级考勤管理，支持多种考勤模式和智能化排班。

### 1.2 核心功能
- ✅ **多模态考勤**: 支持人脸识别、指纹、卡片、移动端打卡
- ✅ **智能排班**: 三班倒、四班三倒、弹性班次、规律班次
- ✅ **异常管理**: 请假、加班、调班、补签、销假统一管理
- ✅ **实时监控**: 设备联动、双重验证、异常预警
- ✅ **数据分析**: 考勤汇总、统计分析、报表推送

### 1.3 技术特点
- 基于Spring Boot 3.5.8 + Java 17企业级架构
- MySQL 8.0 + MyBatis-Plus 3.5.15数据栈
- Redis多级缓存 + 分布式事务支持
- 支持大数据量分表存储策略

---

## 🗄️ 数据库架构设计

### 2.1 架构分层
```
IOE-DREAM考勤数据库架构
├── 基础数据层 (Foundation)
│   ├── 用户组织架构
│   ├── 区域设备管理
│   └── 系统配置参数
├── 考勤业务层 (Business)
│   ├── 班次时间管理
│   ├── 排班调度管理
│   └── 考勤规则配置
├── 考勤数据层 (Data)
│   ├── 原始打卡记录
│   ├── 考勤计算结果
│   └── 异常管理记录
└── 应用服务层 (Application)
    ├── 报表推送配置
    ├── 通知预警管理
    └── 工作流程管理
```

### 2.2 表结构设计原则
- **命名规范**: 使用`t_模块_功能`格式
- **字段设计**: 优先使用下划线命名，保持一致性
- **索引策略**: 业务查询字段必须建立复合索引
- **分表策略**: 大数据量表按月/年分表存储

---

## 📊 核心数据表设计

### 3.1 基础信息模块

#### 3.1.1 考勤记录表 (t_attendance_record)
基于代码分析的实际表结构：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| record_id | BIGINT | - | PK | AUTO_INCREMENT | 考勤记录ID |
| user_id | BIGINT | - | NOT NULL | - | 用户ID |
| user_name | VARCHAR | 100 | NOT NULL | - | 用户姓名 |
| department_id | BIGINT | - | NULL | - | 部门ID |
| department_name | VARCHAR | 100 | NULL | - | 部门名称 |
| shift_id | BIGINT | - | NULL | - | 班次ID |
| shift_name | VARCHAR | 100 | NULL | - | 班次名称 |
| attendance_date | DATE | - | NOT NULL | - | 考勤日期 |
| punch_time | DATETIME | - | NOT NULL | - | 打卡时间 |
| attendance_status | VARCHAR | 20 | NOT NULL | - | 考勤状态(NORMAL/LATE/EARLY/ABSENT/OVERTIME) |
| attendance_type | VARCHAR | 20 | NOT NULL | - | 考勤类型(CHECK_IN/CHECK_OUT) |
| longitude | DECIMAL | 10,6 | NULL | - | 经度 |
| latitude | DECIMAL | 10,6 | NULL | - | 纬度 |
| punch_address | VARCHAR | 200 | NULL | - | 打卡地址 |
| device_id | BIGINT | - | NULL | - | 打卡设备ID |
| device_name | VARCHAR | 100 | NULL | - | 打卡设备名称 |
| remark | TEXT | - | NULL | - | 备注 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |
| create_user_id | BIGINT | - | NULL | - | 创建人ID |
| update_user_id | BIGINT | - | NULL | - - | 更新人ID |
| deleted_flag | TINYINT | - | NOT NULL | 0 | 删除标记(0-正常,1-删除) |

#### 3.1.2 工作班次表 (t_attendance_work_shift)
基于代码分析的完整班次设计：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| shift_id | BIGINT | - | PK | AUTO_INCREMENT | 班次ID |
| shift_code | VARCHAR | 50 | NOT NULL | - | 班次编码 |
| shift_name | VARCHAR | 100 | NOT NULL | - | 班次名称 |
| shift_type | INT | - | NOT NULL | 1 | 班次类型(1-固定,2-弹性,3-轮班,4-临时) |
| work_days | VARCHAR | 20 | NULL | - | 工作日(JSON数组) |
| work_start_time | TIME | - | NOT NULL | - | 上班时间 |
| work_end_time | TIME | - | NOT NULL | - | 下班时间 |
| work_duration | INT | - | NOT NULL | 480 | 工作时长(分钟) |
| lunch_start_time | TIME | - | NULL | 12:00:00 | 午休开始时间 |
| lunch_end_time | TIME | - | NULL | 13:00:00 | 午休结束时间 |
| lunch_duration | INT | - | NULL | 60 | 午休时长(分钟) |
| break_time | INT | - | NULL | 0 | 休息时间(分钟) |
| flex_start_earliest | TIME | - | NULL | - | 弹性上班时间(最早) |
| flex_start_latest | TIME | - | NULL | - | 弹性上班时间(最晚) |
| flex_end_earliest | TIME | - NULL | - - | 弹性下班时间(最早) |
| flex_end_latest | TIME | - | NULL | - | 弹性下班时间(最晚) |
| late_tolerance | INT | - | NOT NULL | 0 | 迟到宽限时间(分钟) |
| early_tolerance | INT | - | NOT NULL | 0 | 早退宽限时间(分钟) |
| overtime_calculation | INT | - | NOT NULL | 1 | 加班计算方式(1-小时,2-半小时,3-15分钟) |
| min_overtime_duration | INT | - | NOT NULL | 30 | 最小加班时长(分钟) |
| night_shift_start | TIME | - | NULL | 22:00:00 | 夜班开始时间 |
| night_shift_end | TIME | - | NULL | 06:00:00 | 夜班结束时间 |
| night_shift_allowance | DECIMAL | 10,2 | NULL | - | 夜班补贴 |
| holiday_triple_pay | INT | - | NOT NULL | 0 | 节假日三倍薪资(0-否,1-是) |
| shift_color | VARCHAR | 20 | NULL | - | 班次颜色(界面显示) |
| description | TEXT | - | NULL | - | 班次描述 |
| shift_status | INT | - | NOT NULL | 1 | 班次状态(1-启用,0-禁用) |
| create_user_id | BIGINT | - | NULL | - | 创建人ID |
| update_user_id | BIGINT | - | NULL | - | 更新人ID |
| sort_order | INT | - | NULL | 0 | 排序号 |
| extended_attributes | JSON | - | NULL | - | 扩展属性(JSON) |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |
| deleted_flag | TINYINT | - | NOT NULL | 0 | 删除标记 |

#### 3.1.3 请假申请表 (attendance_leave)
基于代码分析的请假实体：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| id | BIGINT | - | PK | AUTO_INCREMENT | 请假ID |
| leave_no | VARCHAR | 50 | NOT NULL | - | 请假申请编号(业务Key) |
| employee_id | BIGINT | - | NOT NULL | - | 员工ID |
| employee_name | VARCHAR | 100 | NOT NULL | - | 员工姓名 |
| leave_type | VARCHAR | 20 | NOT NULL | - | 请假类型(ANNUAL/SICK/PERSONAL/MARRIAGE/MATERNITY/PATERNITY/OTHER) |
| start_date | DATE | - | NOT NULL | - | 请假开始日期 |
| end_date | DATE | - | NOT NULL | - | 请假结束日期 |
| leave_days | DOUBLE | - | NOT NULL | - | 请假天数 |
| reason | TEXT | - | NULL | - | 请假原因 |
| status | VARCHAR | 20 | NOT NULL | - | 申请状态(PENDING/APPROVED/REJECTED/CANCELLED) |
| approval_comment | TEXT | - | NULL | - | 审批意见 |
| approval_time | DATETIME | - | NULL | - | 审批时间 |
| remark | TEXT | - | NULL | - | 备注 |
| workflow_instance_id | BIGINT | - | NULL | - | 工作流实例ID |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |
| create_user_id | BIGINT | - | NULL | - | 创建人ID |
| update_user_id | BIGINT | - | NULL | - | 更新人ID |
| deleted_flag | TINYINT | - | NOT NULL | 0 | 删除标记 |

### 3.2 扩展实体表设计

#### 3.2.1 工作班次核心表 (t_work_shift_core)
支持复杂班次配置的拆分表：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| core_id | BIGINT | - | PK | AUTO_INCREMENT | 核心配置ID |
| shift_id | BIGINT | - | FK | - | 关联班次ID |
| period_name | VARCHAR | 100 | NOT NULL | - | 时间段名称 |
| period_type | INT | - | NOT NULL | - | 时间段类型(1-上班,2-午休,3-下班,4-加班) |
| start_time | TIME | - | NOT NULL | - | 开始时间 |
| end_time | TIME | - | NOT NULL | - | 结束时间 |
| is_required | TINYINT | - | NOT NULL | 1 | 是否必须打卡 |
| grace_period | INT | - | NOT NULL | 0 | 宽限期(分钟) |
| sort_order | INT | - | NOT NULL | 1 | 排序号 |
| status | TINYINT | - | NOT NULL | 1 | 状态 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.2 弹性时间配置表 (t_work_shift_flex_time)
支持弹性班次配置：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| flex_id | BIGINT | - | PK | AUTO_INCREMENT | 弹性配置ID |
| shift_id | BIGINT | - | FK | - | 关联班次ID |
| core_start_time | TIME | - | NOT NULL | - | 核心开始时间 |
| core_end_time | TIME | - | NOT NULL | - | 核心结束时间 |
| flexible_start | TIME | - | NOT NULL | - | 弹性开始时间 |
| flexible_end | TIME | - | NOT NULL | - | 弹性结束时间 |
| min_work_hours | DECIMAL | 5,2 | NOT NULL | 8.0 | 最小工作时长 |
| status | TINYINT | - | NOT NULL | 1 | 状态 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.3 休息时间配置表 (t_work_shift_break_time)
支持复杂休息时间配置：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| break_id | BIGINT | - | PK | AUTO_INCREMENT | 休息配置ID |
| shift_id | BIGINT | - | FK | - | 关联班次ID |
| break_name | VARCHAR | 100 | NOT NULL | - | 休息名称 |
| start_time | TIME | - | NOT NULL | - | 开始时间 |
| end_time | TIME | - | NOT NULL | - | 结束时间 |
| break_type | INT | - | NOT NULL | 1 | 休息类型(1-固定,2-浮动) |
| is_paid | TINYINT | - | NOT NULL | 0 | 是否带薪 |
| sort_order | INT | - | NOT NULL | 1 | 排序号 |
| status | TINYINT | - | NOT NULL | 1 | 状态 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

#### 3.2.4 加班规则配置表 (t_work_shift_overtime)
支持灵活加班计算规则：

| 字段名 | 数据类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|----------|------|------|--------|------|
| overtime_id | BIGINT | - | PK | AUTO_INCREMENT | 加班规则ID |
| shift_id | BIGINT | - | FK | - | 关联班次ID |
| overtime_type | INT | - | NOT NULL | 1 | 加班类型(1-工作日,2-周末,3-节假日) |
| calculation_method | INT | - | NOT NULL | 1 | 计算方式(1-按小时,2-按半小时,3-按15分钟) |
| minimum_duration | INT | - | NOT NULL | 30 | 最小加班时长(分钟) |
| maximum_daily_hours | DECIMAL | 5,2 | NULL | 12.0 | 每日最大加班时长 |
| overtime_rate | DECIMAL | 5,2 | NOT NULL | 1.5 | 加班费率 |
| night_rate | DECIMAL | 5,2 | NOT NULL | 2.0 | 夜班费率 |
| holiday_rate | DECIMAL | 5,2 | NOT NULL | 3.0 | 节假日费率 |
| status | TINYINT | - | NOT NULL | 1 | 状态 |
| create_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

---

## 🔗 表关联关系设计

### 4.1 核心关联关系

#### 4.1.1 基础关联关系
```sql
-- 用户与部门关联
ALTER TABLE t_attendance_record ADD CONSTRAINT fk_attendance_record_department
FOREIGN KEY (department_id) REFERENCES t_department(department_id);

-- 班次与考勤记录关联
ALTER TABLE t_attendance_record ADD CONSTRAINT fk_attendance_record_shift
FOREIGN KEY (shift_id) REFERENCES t_attendance_work_shift(shift_id);

-- 请假申请与用户关联
ALTER TABLE attendance_leave ADD CONSTRAINT fk_attendance_leave_employee
FOREIGN KEY (employee_id) REFERENCES t_employee(employee_id);
```

#### 4.1.2 扩展关联关系
```sql
-- 班次核心配置关联
ALTER TABLE t_work_shift_core ADD CONSTRAINT fk_work_shift_core_shift
FOREIGN KEY (shift_id) REFERENCES t_attendance_work_shift(shift_id);

-- 弹性时间配置关联
ALTER TABLE t_work_shift_flex_time ADD CONSTRAINT fk_work_shift_flex_shift
FOREIGN KEY (shift_id) REFERENCES t_attendance_work_shift(shift_id);

-- 休息时间配置关联
ALTER TABLE t_work_shift_break_time ADD CONSTRAINT fk_work_shift_break_shift
FOREIGN KEY (shift_id) REFERENCES t_attendance_work_shift(shift_id);

-- 加班规则配置关联
ALTER TABLE t_work_shift_overtime ADD CONSTRAINT fk_work_shift_overtime_shift
FOREIGN KEY (shift_id) REFERENCES t_attendance_work_shift(shift_id);
```

---

## 🚀 索引设计策略

### 5.1 主键索引
```sql
-- 考勤记录表主键
ALTER TABLE t_attendance_record ADD PRIMARY KEY (record_id);

-- 工作班次表主键
ALTER TABLE t_attendance_work_shift ADD PRIMARY KEY (shift_id);

-- 请假申请表主键
ALTER TABLE attendance_leave ADD PRIMARY KEY (id);
```

### 5.2 唯一索引
```sql
-- 班次编码唯一
ALTER TABLE t_attendance_work_shift ADD UNIQUE INDEX uk_shift_code (shift_code);

-- 请假申请编号唯一
ALTER TABLE attendance_leave ADD UNIQUE INDEX uk_leave_no (leave_no);
```

### 5.3 复合索引（业务查询优化）

#### 5.3.1 考勤记录查询优化
```sql
-- 用户考勤记录查询
CREATE INDEX idx_attendance_record_user_date ON t_attendance_record(user_id, attendance_date);

-- 部门考勤记录查询
CREATE INDEX idx_attendance_record_dept_date ON t_attendance_record(department_id, attendance_date);

-- 时间范围查询
CREATE INDEX idx_attendance_record_time ON t_attendance_record(punch_time);

-- 状态统计查询
CREATE INDEX idx_attendance_record_status ON t_attendance_record(attendance_status, attendance_date);
```

#### 5.3.2 班次管理查询优化
```sql
-- 班次类型查询
CREATE INDEX idx_work_shift_type_status ON t_attendance_work_shift(shift_type, shift_status);

-- 时间段查询
CREATE INDEX idx_work_shift_time ON t_attendance_work_shift(work_start_time, work_end_time);
```

#### 5.3.3 请假管理查询优化
```sql
-- 用户请假查询
CREATE INDEX idx_leave_employee_status ON attendance_leave(employee_id, status);

-- 请假时间范围查询
CREATE INDEX idx_leave_date_range ON attendance_leave(start_date, end_date);

-- 请假类型统计
CREATE INDEX idx_leave_type_status ON attendance_leave(leave_type, status);
```

---

## 📈 分表策略设计

### 6.1 数据量分析
根据企业规模分析数据量增长：

| 企业规模 | 员工数 | 日打卡量 | 年数据量 | 5年预估量 |
|----------|--------|----------|----------|------------|
| 小型企业 | 100 | 400 | 146,000 | 730,000 |
| 中型企业 | 1,000 | 4,000 | 1,460,000 | 7,300,000 |
| 大型企业 | 10,000 | 40,000 | 14,600,000 | 73,000,000 |
| 超大型企业 | 50,000 | 200,000 | 73,000,000 | 365,000,000 |

### 6.2 分表方案

#### 6.2.1 考勤记录表分表
```sql
-- 按月分表
CREATE TABLE t_attendance_record_202501 LIKE t_attendance_record;
CREATE TABLE t_attendance_record_202502 LIKE t_attendance_record;
-- ... 按月创建

-- 分表路由规则
-- 查询2025年1月数据自动路由到 t_attendance_record_202501
-- 查询2025年2月数据自动路由到 t_attendance_record_202502
```

#### 6.2.2 其他表分表策略
- **考勤汇总表**: 按年分表
- **请假申请表**: 按年分表
- **加班申请表**: 按年分表

### 6.3 分表实施
```sql
-- 自动创建分表存储过程
DELIMITER $$
CREATE PROCEDURE CreateMonthlyTable(IN tableName VARCHAR(100), IN yearMonth VARCHAR(6))
BEGIN
    SET @sql = CONCAT('CREATE TABLE ', tableName, '_', yearMonth, ' LIKE ', tableName);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;
```

---

## 🔒 数据安全设计

### 7.1 数据加密策略
- **敏感字段**: 手机号、身份证号使用AES加密存储
- **位置信息**: 经纬度坐标数据脱敏处理
- **审计日志**: 所有数据变更记录完整操作日志

### 7.2 权限控制
- **行级安全**: 基于部门和角色的数据访问控制
- **字段级安全**: 敏感字段只授权特定角色查看
- **操作权限**: 增删改查严格权限分离

### 7.3 数据备份策略
- **实时备份**: 数据库主从复制，RPO < 5分钟
- **定期备份**: 每日全量备份，保留90天
- **归档策略**: 超过3年数据压缩归档，保留7年

---

## ⚡ 性能优化策略

### 8.1 查询优化
- **分页优化**: 使用游标分页替代深度分页
- **索引覆盖**: 覆盖常用查询字段，避免回表查询
- **查询缓存**: 频繁查询结果缓存至Redis

### 8.2 写入优化
- **批量插入**: 支持批量考勤记录插入，减少数据库交互
- **异步处理**: 考勤计算采用异步任务处理
- **事务拆分**: 大事务拆分为小事务，提高并发性

### 8.3 存储优化
- **数据压缩**: 历史数据压缩存储，节省磁盘空间
- **冷热分离**: 热数据SSD存储，冷数据HDD存储
- **表分区**: 大表按时间范围分区，提高查询性能

---

## 📋 版本迭代记录

### 9.1 版本历史
| 版本 | 日期 | 更新内容 | 负责人 |
|------|------|----------|--------|
| v2.0.0 | 2025-12-16 | 结合实际代码分析，优化表结构设计 | 架构团队 |
| v1.0.0 | 2025-01-30 | 初始版本，基础表结构设计 | 开发团队 |

### 9.2 更新规范
- **变更记录**: 所有表结构变更必须记录变更日志
- **兼容性**: 新增字段必须保持向下兼容
- **测试验证**: 结构变更必须经过充分测试验证

---

**文档维护**: IOE-DREAM架构团队
**技术支持**: development@ioe-dream.com
**最后更新**: 2025-12-16