{
  "id": "snapshot_1764178370965_mp8wvzq8l",
  "approvalId": "approval_1764178370916_5y2ub3w0p",
  "approvalTitle": "Device Service微服务需求文档审批",
  "version": 1,
  "timestamp": "2025-11-26T17:32:50.965Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Device Service微服务需求文档\r\n\r\n## 概述\r\n\r\nDevice Service微服务是IOE-DREAM智慧园区综合管理平台微服务化改造的第二阶段核心组件，旨在将设备管理功能从单体应用中拆分为独立的微服务。该服务将统一管理门禁设备、消费设备、考勤设备、视频监控设备等各类智能硬件设备，为其他业务微服务提供标准化的设备管理能力。\r\n\r\n## 与产品愿景的契合度\r\n\r\n### 支持技术架构演进\r\n根据tech.md中的微服务架构转型计划，Device Service是实现从单体分层架构向微服务架构转变的关键步骤。该服务将：\r\n- 实现设备管理的服务化拆分，提高系统的可扩展性和可维护性\r\n- 为后续其他业务微服务（Access Service、Consume Service等）提供设备管理基础能力\r\n- 支持水平扩展，满足智慧园区场景下大规模设备接入需求\r\n\r\n### 支撑业务目标\r\n- **设备统一管理**：解决多品牌设备接入复杂问题，提供统一的设备抽象层\r\n- **实时监控能力**：支持设备状态实时监控，提升运维效率\r\n- **高可用性保障**：通过微服务架构提高设备管理服务的可用性和故障隔离能力\r\n\r\n## 需求详述\r\n\r\n### 需求1：设备抽象层统一管理\r\n\r\n**用户故事：** 作为系统架构师，我希望有一个统一的设备抽象层，以便不同类型设备能够标准化接入和管理。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 新设备类型需要接入时 **THEN** 系统 **SHALL** 支持通过SmartDeviceEntity基类扩展新设备实体\r\n2. **WHEN** 查询设备基本信息时 **THEN** 系统 **SHALL** 返回统一的设备数据结构（设备ID、设备编码、设备名称、设备类型、设备状态等）\r\n3. **IF** 设备是门禁设备 **THEN** 系统 **SHALL** 通过AccessDeviceEntity提供门禁特有字段管理\r\n4. **IF** 设备是考勤设备 **THEN** 系统 **SHALL** 通过AttendanceDeviceEntity提供考勤特有字段管理\r\n5. **IF** 设备是消费设备 **THEN** 系统 **SHALL** 通过ConsumeDeviceEntity提供消费特有字段管理\r\n6. **WHEN** 设备数据变更时 **THEN** 系统 **SHALL** 自动同步更新到Redis缓存\r\n\r\n### 需求2：设备协议适配器管理\r\n\r\n**用户故事：** 作为设备运维工程师，我希望系统能够支持多品牌设备协议，以便统一管理不同厂商的设备。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 接入海康威视设备时 **THEN** 系统 **SHALL** 通过HikvisionAdapter提供协议适配\r\n2. **WHEN** 接入大华设备时 **THEN** 系统 **SHALL** 通过DahuaAdapter提供协议适配\r\n3. **WHEN** 接入中控智慧设备时 **THEN** 系统 **SHALL** 通过ZKTecoAdapter提供协议适配\r\n4. **WHEN** 设备需要网络通信时 **THEN** 系统 **SHALL** 通过HttpProtocolAdapter提供HTTP协议支持\r\n5. **WHEN** 设备需要TCP通信时 **THEN** 系统 **SHALL** 通过TcpProtocolAdapter提供TCP协议支持\r\n6. **IF** 新协议需要支持 **THEN** 系统 **SHALL** 支持通过DeviceProtocolAdapter接口扩展新协议适配器\r\n\r\n### 需求3：设备状态实时监控\r\n\r\n**用户故事：** 作为园区管理员，我希望能够实时查看设备状态，以便及时发现和处理设备故障。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 设备上线时 **THEN** 系统 **SHALL** 自动更新lastOnlineTime字段\r\n2. **WHEN** 设备离线时 **THEN** 系统 **SHALL** 将deviceStatus更新为离线状态\r\n3. **WHEN** 设备发生故障时 **THEN** 系统 **SHALL** 生成告警信息并通知相关人员\r\n4. **IF** 设备状态发生变化 **THEN** 系统 **SHALL** 通过WebSocket推送实时状态更新\r\n5. **WHEN** 查询设备状态时 **THEN** 系统 **SHALL** 在100ms内返回最新的设备状态信息\r\n6. **WHEN** 设备长时间未响应 **THEN** 系统 **SHALL** 自动标记为异常状态并发送告警\r\n\r\n### 需求4：设备配置管理\r\n\r\n**用户故事：** 作为系统管理员，我希望能够远程管理设备配置，以便减少现场维护工作量。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 修改设备配置时 **THEN** 系统 **SHALL** 通过deviceConfig字段存储配置信息\r\n2. **WHEN** 配置变更时 **THEN** 系统 **SHALL** 支持批量配置更新操作\r\n3. **IF** 配置更新失败 **THEN** 系统 **SHALL** 回滚到之前配置并记录错误日志\r\n4. **WHEN** 设备重启时 **THEN** 系统 **SHALL** 自动同步最新配置到设备\r\n5. **WHEN** 配置冲突时 **THEN** 系统 **SHALL** 提供冲突解决机制和人工干预接口\r\n6. **IF** 设备不支持远程配置 **THEN** 系统 **SHALL** 提供配置导入导出功能供现场使用\r\n\r\n### 需求5：设备生命周期管理\r\n\r\n**用户故事：** 作为设备管理员，我希望能够管理设备的完整生命周期，以便跟踪设备从安装到报废的全过程。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 新设备安装时 **THEN** 系统 **SHALL** 记录installTime和deviceLocation信息\r\n2. **WHEN** 设备信息变更时 **THEN** 系统 **SHALL** 自动更新createUserId和updateUserId审计信息\r\n3. **WHEN** 设备需要退役时 **THEN** 系统 **SHALL** 通过deletedFlag进行软删除处理\r\n4. **IF** 设备需要重新启用 **THEN** 系统 **SHALL** 支持恢复已删除的设备记录\r\n5. **WHEN** 查询设备历史记录时 **THEN** 系统 **SHALL** 提供设备变更历史追踪功能\r\n6. **WHEN** 设备迁移时 **THEN** 系统 **SHALL** 更新deviceLocation并保持历史记录\r\n\r\n### 需求6：设备缓存管理\r\n\r\n**用户故事：** 作为系统架构师，我希望系统有高效的缓存机制，以便提升设备查询性能。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 查询设备信息时 **THEN** 系统 **SHALL** 优先从Redis缓存获取数据\r\n2. **WHEN** 设备信息更新时 **THEN** 系统 **SHALL** 自动更新Redis缓存\r\n3. **IF** 缓存失效 **THEN** 系统 **SHALL** 自动从数据库重新加载并更新缓存\r\n4. **WHEN** 批量操作设备时 **THEN** 系统 **SHALL** 支持批量缓存更新操作\r\n5. **WHEN** 缓存命中率低于90%时 **THEN** 系统 **SHALL** 发送性能告警通知\r\n6. **IF** Redis服务不可用 **THEN** 系统 **SHALL** 降级为直接查询数据库并记录错误日志\r\n\r\n### 需求7：微服务接口设计\r\n\r\n**用户故事：** 作为前端开发人员，我希望Device Service提供标准的RESTful API接口，以便其他微服务能够便捷调用设备管理功能。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 查询设备列表时 **THEN** 系统 **SHALL** 提供GET /api/devices接口支持分页查询\r\n2. **WHEN** 查询单个设备时 **THEN** 系统 **SHALL** 提供GET /api/devices/{deviceId}接口\r\n3. **WHEN** 创建设备时 **THEN** 系统 **SHALL** 提供POST /api/devices接口\r\n4. **WHEN** 更新设备时 **THEN** 系统 **SHALL** 提供PUT /api/devices/{deviceId}接口\r\n5. **WHEN** 删除设备时 **THEN** 系统 **SHALL** 提供DELETE /api/devices/{deviceId}接口\r\n6. **IF** 请求参数不合法 **THEN** 系统 **SHALL** 返回标准的错误响应和详细的错误信息\r\n7. **WHEN** 接口调用时 **THEN** 系统 **SHALL** 支持跨域请求和标准的认证授权机制\r\n\r\n### 需求8：设备监控和告警\r\n\r\n**用户故事：** 作为运维工程师，我希望系统具备设备监控和智能告警功能，以便及时发现和处理设备异常。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 设备CPU使用率超过80%时 **THEN** 系统 **SHALL** 发送性能告警\r\n2. **WHEN** 设备内存使用率超过85%时 **THEN** 系统 **SHALL** 发送资源告警\r\n3. **WHEN** 设备网络连接中断时 **THEN** 系统 **SHALL** 发送网络告警\r\n4. **IF** 设备连续5分钟无响应 **THEN** 系统 **SHALL** 自动标记为故障状态\r\n5. **WHEN** 设备恢复正常时 **THEN** 系统 **SHALL** 自动清除告警状态并通知运维人员\r\n6. **WHEN** 查询设备监控数据时 **THEN** 系统 **SHALL** 提供设备性能指标的历史趋势图表\r\n\r\n### 需求9：设备批量操作\r\n\r\n**用户故事：** 作为系统管理员，我希望系统能够支持设备批量操作，以便提高管理效率。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 批量添加设备时 **THEN** 系统 **SHALL** 支持Excel模板导入批量创建设备\r\n2. **WHEN** 批量更新配置时 **THEN** 系统 **SHALL** 支持选择多个设备进行配置批量更新\r\n3. **WHEN** 批量删除设备时 **THEN** 系统 **SHALL** 提供批量软删除功能和操作确认机制\r\n4. **IF** 批量操作部分失败 **THEN** 系统 **SHALL** 提供详细的成功失败列表和错误信息\r\n5. **WHEN** 批量操作执行时 **THEN** 系统 **SHALL** 提供操作进度条和实时状态反馈\r\n6. **WHEN** 批量操作完成后 **THEN** 系统 **SHALL** 生成操作报告供管理员下载\r\n\r\n### 需求10：设备数据分析\r\n\r\n**用户故事：** 作为数据分析师，我希望系统能够提供设备数据分析功能，以便支持设备管理和运维决策。\r\n\r\n#### 验收标准\r\n\r\n1. **WHEN** 查询设备统计信息时 **THEN** 系统 **SHALL** 提供设备类型分布、在线率、故障率等统计数据\r\n2. **WHEN** 分析设备使用情况时 **THEN** 系统 **SHALL** 提供设备使用频率、高峰时段等使用分析\r\n3. **WHEN** 生成运维报告时 **THEN** 系统 **SHALL** 自动生成设备健康度、维护建议等报告\r\n4. **IF** 设备出现异常模式 **THEN** 系统 **SHALL** 通过历史数据分析识别潜在问题\r\n5. **WHEN** 预测设备故障时 **THEN** 系统 **SHALL** 基于历史数据提供故障预警和维护建议\r\n6. **WHEN** 导出分析数据时 **THEN** 系统 **SHALL** 支持多种格式（Excel、PDF、CSV）的数据导出\r\n\r\n## 非功能性需求\r\n\r\n### 代码架构和模块化\r\n- **单一职责原则**：每个设备类型管理组件应具有明确定义的单一职责\r\n- **模块化设计**：设备协议适配器、缓存管理、监控告警等组件应隔离且可复用\r\n- **依赖管理**：最小化模块间依赖，通过接口和事件驱动架构降低耦合度\r\n- **清晰接口**：定义设备管理服务的标准API契约和事件接口\r\n\r\n### 性能要求\r\n- **API响应时间**：设备查询接口平均响应时间<100ms，P95<200ms\r\n- **并发能力**：支持1000+并发设备管理请求，5000+设备状态监控连接\r\n- **缓存性能**：设备信息缓存命中率>95%，缓存更新延迟<1秒\r\n- **批量操作**：支持1000+设备的批量操作，操作完成时间<30秒\r\n\r\n### 安全要求\r\n- **身份认证**：设备管理API需要基于Sa-Token的严格身份认证\r\n- **权限控制**：基于RBAC模型，支持设备管理权限的细粒度控制\r\n- **数据加密**：设备配置和通信数据使用AES-256加密传输\r\n- **审计日志**：记录所有设备操作的详细审计日志，支持安全追溯\r\n\r\n### 可靠性要求\r\n- **服务可用性**：Device Service可用性≥99.9%，支持故障自动恢复\r\n- **数据一致性**：设备数据在数据库和缓存间保持强一致性\r\n- **故障隔离**：单个设备故障不影响其他设备管理功能\r\n- **降级策略**：Redis故障时自动降级到数据库直接访问\r\n\r\n### 可扩展性要求\r\n- **水平扩展**：支持Device Service的多实例部署和负载均衡\r\n- **设备容量**：支持100,000+设备的统一管理\r\n- **协议扩展**：支持新设备协议的插件化扩展机制\r\n- **存储扩展**：支持设备数据的分库分表存储\r\n\r\n### 监控和运维要求\r\n- **健康检查**：提供服务健康检查接口，监控服务运行状态\r\n- **性能监控**：集成Prometheus监控，提供详细的性能指标\r\n- **日志管理**：结构化日志输出，支持ELK Stack集中日志管理\r\n- **告警机制**：关键指标异常时自动触发告警通知\r\n\r\n### 兼容性要求\r\n- **向后兼容**：新版本API保持向后兼容，支持平滑升级\r\n- **协议兼容**：支持主流厂商设备协议，兼容已有设备接入\r\n- **数据格式**：遵循JSON API标准，支持标准HTTP状态码\r\n- **版本管理**：API版本控制支持多版本并存和渐进式升级",
  "fileStats": {
    "size": 12090,
    "lines": 195,
    "lastModified": "2025-11-26T17:32:47.055Z"
  },
  "comments": []
}