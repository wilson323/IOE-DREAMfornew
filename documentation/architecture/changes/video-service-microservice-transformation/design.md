# Design: Video Service Microservice Architecture

## Context

基于IOE-DREAM项目现有视频模块的分析，当前视频功能包含：
- 35个Java文件，涵盖Controller、Service、Manager、DAO四层架构
- 6个DAO层文件，负责视频设备、录像、人脸特征等数据访问
- 完整的MyBatis映射文件和数据库表结构
- 与门禁、考勤、消费、访客系统的深度集成

### 技术约束
- 必须保持SmartAdmin v3技术栈统一性 (Spring Boot 3.x + Java 17)
- 严格遵循四层架构模式: Controller → Service → Manager → DAO
- 使用jakarta.*包名，@Resource依赖注入
- 保持与现有业务系统的集成兼容性

### 业务约束
- 零业务中断，视频监控功能不能停机
- 保持与门禁系统的生物识别集成
- 维持AI分析引擎的正常运行
- 确保前端无感知迁移

## Goals / Non-Goals

### Goals
- 创建独立的视频微服务，包含完整的视频监控功能
- 实现视频流管理、设备管理、AI分析、录像回放的独立部署
- 通过API网关统一暴露服务，保持前端调用兼容性
- 建立独立的数据访问层，优化视频数据存储和检索
- 实现服务的高可用和可扩展性

### Non-Goals
- 不重构前端代码，保持Vue3应用结构不变
- 不改变视频相关的业务逻辑和算法
- 不修改数据库表结构，保持现有数据模型
- 不改变与第三方设备厂商的集成协议

## Decisions

### Decision 1: 微服务边界划分
**What**: 按照功能模块将视频服务划分为4个核心模块
**Why**: 保持单一职责原则，便于独立部署和扩展
- **监控核心模块**: 实时视频预览、多画面显示
- **设备管理模块**: 设备状态监控、PTZ控制、协议适配
- **录像回放模块**: 历史录像查询、时间轴导航、视频下载
- **AI分析模块**: 人脸识别、行为分析、目标检索

### Decision 2: 数据分离策略
**What**: 视频相关数据库表独立管理，但保持数据一致性
**Why**: 减少数据库耦合，提高查询性能
- 保留现有视频相关表的完整结构
- 建立独立的数据源配置
- 使用分布式事务确保数据一致性

### Decision 3: 服务通信机制
**What**: 使用RESTful API + WebSocket混合通信
**Why**: 兼顾实时性和标准化
- 配置管理和设备控制: RESTful API
- 实时视频流: WebSocket + 媒体服务器
- AI分析结果: 消息队列异步通知

### Decision 4: 部署架构
**What**: Docker容器化部署，支持水平扩展
**Why**: 提高可用性和资源利用率
- 视频流处理服务可独立扩展
- AI分析服务支持GPU加速
- 数据库连接池独立配置

## Risks / Trade-offs

### Technical Risks
- **风险**: 视频流传输延迟增加
  - **缓解**: 使用CDN加速和边缘计算节点
- **风险**: AI分析性能下降
  - **缓解**: 部署专用GPU服务器和模型优化
- **风险**: 服务间网络延迟
  - **缓解**: 部署在同一数据中心，使用内网通信

### Business Risks
- **风险**: 现有功能兼容性问题
  - **缓解**: 完整的回归测试和灰度发布
- **风险**: 集成系统通信失败
  - **缓解**: 实现服务降级和熔断机制

## Migration Plan

### Phase 1: 基础设施准备 (1-2天)
1. 创建video-service微服务项目结构
2. 配置Nacos注册中心和配置中心集成
3. 设置独立的数据库连接和Redis缓存
4. 建立API网关路由规则

### Phase 2: 核心功能迁移 (3-4天)
1. 迁移视频设备管理功能 (10个文件)
2. 迁移实时视频预览功能 (8个文件)
3. 迁移历史录像回放功能 (7个文件)
4. 迁移AI分析引擎功能 (10个文件)

### Phase 3: 集成测试验证 (1天)
1. 验证与门禁系统的生物识别集成
2. 测试与考勤系统的考勤验证功能
3. 验证前端API调用的兼容性
4. 性能测试和压力测试

### Phase 4: 生产部署 (1天)
1. 灰度发布验证
2. 生产环境部署
3. 监控告警配置
4. 回滚方案准备

## Open Questions

- 视频文件的存储策略是否需要调整（当前使用文件系统）
- AI模型的部署和更新机制如何优化
- 大规模并发视频流的负载均衡策略
- 与第三方设备厂商SDK的集成方式是否需要标准化