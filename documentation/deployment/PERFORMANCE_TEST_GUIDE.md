# 性能测试执行指南

**版本**: v1.0.0  
**日期**: 2025-01-30  
**状态**: 待执行

---

## 📋 测试前准备

### 环境要求

- [ ] 测试环境已准备（独立于生产环境）
- [ ] 所有微服务已启动
- [ ] 数据库已准备测试数据
- [ ] Redis服务已启动
- [ ] JMeter已安装（版本5.5+）

### 测试数据准备

- [ ] 用户数据：至少1000条
- [ ] 业务数据：各模块至少1000条
- [ ] 缓存已预热（可选）

---

## 🔧 测试工具安装

### JMeter安装

1. 下载JMeter: https://jmeter.apache.org/download_jmeter.cgi
2. 解压到本地目录
3. 配置环境变量（可选）

### JMeter插件安装（可选）

- **PerfMon插件**: 监控服务器资源
- **Backend Listener**: 集成InfluxDB/Grafana

---

## 📊 测试场景

### 1. 缓存性能测试

**测试目标**: 验证多级缓存架构性能

**测试接口**: 用户信息查询接口
- 接口路径: `GET /api/v1/user/{userId}`
- 预期缓存命中率: ≥90%
- 预期平均响应时间: ≤5ms

**JMeter配置**:
- 线程数: 100
- Ramp-up时间: 10秒
- 循环次数: 10
- 总请求数: 1000

**验证指标**:
- 缓存命中率 ≥90%
- 平均响应时间 ≤5ms
- P95响应时间 ≤10ms
- 错误率 = 0%

---

### 2. 数据库查询性能测试

**测试目标**: 验证索引优化效果

**测试接口**: 分页查询接口
- 接口路径: `GET /api/v1/consume/record/page`
- 预期平均响应时间: ≤150ms
- 预期慢查询数量: 0

**JMeter配置**:
- 线程数: 50
- Ramp-up时间: 5秒
- 循环次数: 2
- 总请求数: 100

**验证指标**:
- 平均响应时间 ≤150ms
- P95响应时间 ≤200ms
- 慢查询数量 = 0
- 错误率 = 0%

---

### 3. 连接池性能测试

**测试目标**: 验证Druid连接池性能

**测试接口**: 任意数据库操作接口
- 并发数: 1000
- 预期连接池利用率: ≥90%
- 预期连接等待时间: ≤100ms

**JMeter配置**:
- 线程数: 200
- Ramp-up时间: 20秒
- 循环次数: 5
- 总请求数: 1000

**验证指标**:
- 连接池利用率 ≥90%
- 连接等待时间 ≤100ms
- 连接池活跃连接数 ≤ max-active
- 无连接超时错误

---

### 4. 系统TPS测试

**测试目标**: 验证系统整体性能

**测试接口**: 混合接口（查询+写入）
- 并发用户: 逐步增加到100
- 预期TPS: ≥2000
- 预期P95响应时间: ≤200ms

**JMeter配置**:
- 线程组1: 查询接口（80%）
  - 线程数: 80
  - Ramp-up时间: 30秒
  - 循环次数: 持续运行5分钟
- 线程组2: 写入接口（20%）
  - 线程数: 20
  - Ramp-up时间: 30秒
  - 循环次数: 持续运行5分钟

**验证指标**:
- TPS ≥2000
- P95响应时间 ≤200ms
- P99响应时间 ≤500ms
- 错误率 ≤0.1%

---

## 🔍 验证方法

### 1. 查看JMeter测试报告

**生成HTML报告**:
```bash
# 执行测试并生成报告
jmeter -n -t performance_test.jmx -l results.jtl -e -o report/
```

**关键指标**:
- Summary Report: 查看总体统计
- Response Times Over Time: 查看响应时间趋势
- Throughput Over Time: 查看TPS趋势
- Response Times Percentiles: 查看P50/P95/P99

### 2. 查看Spring Boot Actuator指标

**访问指标端点**:
- Metrics: `http://localhost:{port}/actuator/metrics`
- Health: `http://localhost:{port}/actuator/health`
- Prometheus: `http://localhost:{port}/actuator/prometheus`

**关键指标**:
- `http.server.requests`: HTTP请求统计
- `jvm.memory.used`: JVM内存使用
- `process.cpu.usage`: CPU使用率
- `hikaricp.connections.active`: 连接池活跃连接数（如果使用HikariCP）

### 3. 查看Druid监控页面

**访问监控页面**:
- URL: `http://localhost:{port}/druid/index.html`
- 登录: admin/admin

**关键指标**:
- SQL监控: 查看慢SQL
- 连接池监控: 查看连接池状态
- Web应用监控: 查看应用性能

### 4. 查看Redis监控

**使用redis-cli**:
```bash
redis-cli --stat
redis-cli info stats
redis-cli info memory
```

**关键指标**:
- `keyspace_hits`: 缓存命中次数
- `keyspace_misses`: 缓存未命中次数
- `used_memory`: 内存使用量

---

## 📈 性能基准

### 缓存性能基准

| 指标 | 目标值 | 优秀值 | 警告值 |
|------|--------|--------|--------|
| 缓存命中率 | ≥90% | ≥95% | <85% |
| 平均响应时间 | ≤5ms | ≤2ms | >10ms |
| P95响应时间 | ≤10ms | ≤5ms | >20ms |

### 数据库性能基准

| 指标 | 目标值 | 优秀值 | 警告值 |
|------|--------|--------|--------|
| 平均响应时间 | ≤150ms | ≤100ms | >200ms |
| P95响应时间 | ≤200ms | ≤150ms | >300ms |
| 慢查询数量 | 0 | 0 | >10 |

### 连接池性能基准

| 指标 | 目标值 | 优秀值 | 警告值 |
|------|--------|--------|--------|
| 连接池利用率 | ≥90% | ≥95% | <80% |
| 连接等待时间 | ≤100ms | ≤50ms | >200ms |
| 连接超时次数 | 0 | 0 | >0 |

### 系统TPS基准

| 指标 | 目标值 | 优秀值 | 警告值 |
|------|--------|--------|--------|
| TPS | ≥2000 | ≥3000 | <1500 |
| P95响应时间 | ≤200ms | ≤150ms | >300ms |
| 错误率 | ≤0.1% | ≤0.01% | >0.5% |

---

## ⚠️ 注意事项

### 1. 测试环境隔离

- 使用独立的测试环境
- 避免影响生产环境
- 测试数据与生产数据隔离

### 2. 测试数据准备

- 准备足够的测试数据
- 数据分布要合理
- 避免数据倾斜

### 3. 测试时间选择

- 选择非高峰期进行测试
- 避免影响正常业务
- 预留足够的测试时间

### 4. 监控资源使用

- 监控服务器CPU、内存、磁盘IO
- 监控数据库连接数、慢查询
- 监控Redis内存使用、连接数

---

## 📝 测试报告模板

### 测试报告结构

1. **测试概述**
   - 测试目的
   - 测试环境
   - 测试时间

2. **测试场景**
   - 场景1: 缓存性能测试
   - 场景2: 数据库查询性能测试
   - 场景3: 连接池性能测试
   - 场景4: 系统TPS测试

3. **测试结果**
   - 各场景测试数据
   - 性能指标对比
   - 问题分析

4. **结论与建议**
   - 性能评估
   - 优化建议
   - 后续计划

---

## ✅ 验证清单

- [ ] JMeter已安装
- [ ] 测试环境已准备
- [ ] 测试数据已准备
- [ ] 所有服务已启动
- [ ] 缓存性能测试完成
- [ ] 数据库查询性能测试完成
- [ ] 连接池性能测试完成
- [ ] 系统TPS测试完成
- [ ] 测试报告已生成
- [ ] 性能指标达到目标值

---

**测试完成后，请更新测试状态**

