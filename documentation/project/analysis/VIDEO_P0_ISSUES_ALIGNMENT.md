# 视频服务P0问题需求对齐文档

> **创建日期**: 2025-01-30
> **问题级别**: P0（严重）
> **服务名称**: ioedream-video-service
> **端口**: 8092

---

## 📋 原始需求

根据全局代码文档一致性分析报告，视频服务存在2个P0级严重问题：

1. **解码上墙功能完全缺失**
   - 位置: `ioedream-video-service`
   - 影响: 无法实现电视墙功能
   - 修复建议: 实现完整的解码上墙模块

2. **地图展示功能完全缺失**
   - 位置: `ioedream-video-service`
   - 影响: 无法实现地图展示功能
   - 修复建议: 实现完整的地图展示模块

---

## 🎯 项目上下文

### 技术栈

- **编程语言**: Java 17
- **框架版本**: Spring Boot 3.5.8
- **数据库**: MySQL 8.0.35 + MyBatis-Plus 3.5.15
- **连接池**: Druid 1.2.25
- **部署环境**: Docker + Kubernetes

### 现有架构理解

- **架构模式**: 四层架构（Controller → Service → Manager → DAO）
- **核心模块**: 设备管理、实时监控、视频回放、行为分析、告警管理
- **集成点**: 与门禁、考勤、访客服务集成
- **边缘AI计算模式**: 设备端AI分析，服务器端管理

### 现有代码状态

**已存在的实体**:
- ✅ `VideoDecoderEntity` - 解码器实体已存在

**缺失的模块**:
- ❌ 解码上墙模块（Controller、Service、Manager、DAO）
- ❌ 地图展示模块（Controller、Service、Manager、DAO）

---

## 📖 需求理解

### 功能边界

#### 包含功能（解码上墙模块）

**1. 解码器管理**
- [x] 解码器列表查询
- [x] 解码器状态监控
- [x] 通道管理
- [x] 能力查询

**2. 电视墙管理**
- [ ] 电视墙列表
- [ ] 布局配置（分屏布局：1x1/2x2/3x3/4x4等）
- [ ] 屏幕映射（解码器-屏幕映射）
- [ ] 预案管理（预置场景配置）

**3. 上墙任务**
- [ ] 手动上墙（拖拽视频到屏幕）
- [ ] 预案调用（一键切换预案）
- [ ] 轮巡上墙（配置轮巡任务）
- [ ] 紧急插播（告警联动上墙）
- [ ] 任务状态监控

**4. 大屏控制**
- [ ] 分屏切换（切换分屏模式）
- [ ] 画面切换（切换单画面内容）
- [ ] 声音控制（控制音频输出）
- [ ] 全屏控制（单画面全屏）

#### 包含功能（地图展示模块）

**1. 地图基础**
- [ ] 地图加载（加载基础地图）
- [ ] 地图缩放（放大/缩小地图）
- [ ] 地图平移（拖拽移动地图）
- [ ] 图层切换（卫星图/路线图）
- [ ] 全屏展示（地图全屏显示）

**2. 设备定位**
- [ ] 设备标注（地图显示设备位置）
- [ ] 设备聚合（缩小时设备聚合显示）
- [ ] 设备筛选（按类型/状态筛选）
- [ ] 设备搜索（搜索定位设备）
- [ ] 设备详情（点击查看设备信息）
- [ ] 快速预览（点击设备预览视频）

**3. 区域管理**
- [ ] 区域绘制（绘制管辖区域）
- [ ] 区域编辑（编辑区域边界）
- [ ] 区域着色（不同区域不同颜色）
- [ ] 区域统计（区域内设备统计）
- [ ] 区域告警（区域告警高亮）

**4. 告警展示**
- [ ] 告警标记（告警位置闪烁标记）
- [ ] 告警聚合（告警数量聚合显示）
- [ ] 告警跳转（点击跳转告警处理）
- [ ] 热力图（告警热力分布图）

**5. 轨迹展示**
- [ ] 人员轨迹（显示人员移动轨迹）
- [ ] 车辆轨迹（显示车辆移动轨迹）
- [ ] 轨迹回放（轨迹动画回放）
- [ ] 轨迹导出（导出轨迹数据）

#### 明确不包含（Out of Scope）

- [ ] 前端地图组件实现（前端负责）
- [ ] 地图服务商SDK集成（前端负责）
- [ ] 解码器硬件驱动（设备厂商负责）
- [ ] 视频流媒体服务器（已有SRS）

---

## ❓ 疑问澄清

### P0级问题（必须澄清）

1. **解码上墙模块的优先级**
   - **背景**: 解码上墙和地图展示都是P0级问题
   - **影响**: 需要确定实现顺序
   - **建议方案**: 先实现解码上墙模块，再实现地图展示模块

2. **解码器协议支持**
   - **背景**: 文档中提到支持GB28181协议，但实际解码器可能支持多种协议
   - **影响**: 需要确定支持的协议类型
   - **建议方案**: 优先支持GB28181，后续扩展支持ONVIF、RTSP等

3. **地图服务商选择**
   - **背景**: 文档中提到支持高德/百度/Leaflet，但需要确定默认使用哪个
   - **影响**: 影响前端实现和后端坐标系转换
   - **建议方案**: 默认使用高德地图（GCJ02坐标系），支持多地图服务商切换

4. **数据库表设计**
   - **背景**: 文档中提供了详细的表结构设计
   - **影响**: 需要确认是否完全按照文档设计实现
   - **建议方案**: 严格按照文档设计实现，确保与文档一致

5. **与现有系统的集成**
   - **背景**: 解码上墙需要与视频流服务集成，地图展示需要与设备管理服务集成
   - **影响**: 需要明确集成方式和接口
   - **建议方案**: 通过GatewayServiceClient调用其他服务，遵循微服务调用规范

---

## ✅ 验收标准

### 功能验收（解码上墙模块）

- [ ] 解码器管理：可以查询解码器列表，监控解码器状态
- [ ] 电视墙管理：可以创建电视墙，配置布局，管理预案
- [ ] 上墙任务：可以手动上墙，调用预案，配置轮巡
- [ ] 大屏控制：可以切换分屏，切换画面，控制声音

### 功能验收（地图展示模块）

- [ ] 地图基础：可以加载地图，缩放平移，切换图层
- [ ] 设备定位：可以在地图上显示设备，搜索定位设备
- [ ] 区域管理：可以绘制区域，编辑区域，统计区域设备
- [ ] 告警展示：可以在地图上显示告警，查看告警详情
- [ ] 轨迹展示：可以显示轨迹，回放轨迹动画

### 质量验收

- [ ] 单元测试覆盖率 > 80%
- [ ] 编译通过，无语法错误
- [ ] 遵循四层架构规范（Controller → Service → Manager → DAO）
- [ ] 使用@Resource依赖注入，无@Autowired违规
- [ ] 使用@Mapper注解，无@Repository违规
- [ ] 使用Jakarta EE包名，无javax包名

---

## 🎯 技术实现方案

### 解码上墙模块实现方案

**核心组件**:
1. **Controller层**: `VideoWallController` - 解码上墙API接口
2. **Service层**: `VideoWallService` + `VideoWallServiceImpl` - 解码上墙业务逻辑
3. **Manager层**: `VideoWallManager` + `DecoderManager` - 复杂流程编排
4. **DAO层**: `VideoWallDao` + `VideoDecoderDao` + `VideoWallWindowDao` + `VideoWallPresetDao` + `VideoWallTourDao` + `VideoDisplayTaskDao`

**核心实体**:
- `VideoDecoderEntity` - 解码器实体（已存在）
- `VideoWallEntity` - 电视墙实体（需创建）
- `VideoWallWindowEntity` - 电视墙窗口实体（需创建）
- `VideoWallPresetEntity` - 电视墙预案实体（需创建）
- `VideoWallTourEntity` - 电视墙轮巡实体（需创建）
- `VideoDisplayTaskEntity` - 上墙任务实体（需创建）

### 地图展示模块实现方案

**核心组件**:
1. **Controller层**: `VideoMapController` - 地图展示API接口
2. **Service层**: `VideoMapService` + `VideoMapServiceImpl` - 地图展示业务逻辑
3. **Manager层**: `VideoMapManager` + `DeviceLocationManager` - 复杂流程编排
4. **DAO层**: `VideoMapDao` + `DeviceLocationDao` + `MapRegionDao` + `LocationTrackDao` + `MapPoiDao`

**核心实体**:
- `DeviceLocationEntity` - 设备位置实体（需创建）
- `MapRegionEntity` - 地图区域实体（需创建）
- `LocationTrackEntity` - 位置轨迹实体（需创建）
- `MapPoiEntity` - 地图POI实体（需创建）

---

## 📋 任务边界限制

### 解码上墙模块边界

**包含**:
- 解码器管理（CRUD、状态监控）
- 电视墙管理（CRUD、布局配置）
- 上墙任务管理（创建、取消、状态查询）
- 预案管理（CRUD、调用）
- 轮巡管理（CRUD、启动、停止）

**不包含**:
- 解码器硬件驱动开发
- 视频流媒体服务器实现（使用现有SRS）
- 前端UI组件实现
- 解码器协议SDK开发（使用现有适配器）

### 地图展示模块边界

**包含**:
- 设备位置管理（CRUD、坐标配置）
- 地图区域管理（CRUD、边界绘制）
- 轨迹数据管理（CRUD、轨迹查询）
- 地图POI管理（CRUD）
- 热力图数据生成

**不包含**:
- 前端地图组件实现（前端负责）
- 地图服务商SDK集成（前端负责）
- 空间数据库扩展（使用MySQL空间索引）
- 轨迹采集（由设备端完成）

---

## 🔧 技术约束

### 架构约束

- ✅ 严格遵循四层架构（Controller → Service → Manager → DAO）
- ✅ 统一使用@Resource依赖注入
- ✅ 统一使用@Mapper注解（DAO层）
- ✅ 统一使用Jakarta EE包名

### 数据库约束

- ✅ 使用MySQL 8.0.35
- ✅ 使用MyBatis-Plus 3.5.15
- ✅ 使用Druid 1.2.25连接池
- ✅ 支持空间索引（地图模块）

### 集成约束

- ✅ 服务间调用通过GatewayServiceClient
- ✅ 使用Nacos服务注册发现
- ✅ 使用Redis缓存（L2缓存）
- ✅ 使用Caffeine本地缓存（L1缓存）

---

## 📊 验收标准详细说明

### 解码上墙模块验收标准

1. **解码器管理**
   - [ ] 可以查询解码器列表（分页、筛选）
   - [ ] 可以添加/编辑/删除解码器
   - [ ] 可以监控解码器状态（在线/离线/故障）
   - [ ] 可以管理解码通道（通道列表、通道状态）

2. **电视墙管理**
   - [ ] 可以创建/编辑/删除电视墙
   - [ ] 可以配置电视墙布局（行数、列数）
   - [ ] 可以配置窗口布局（窗口位置、大小）
   - [ ] 可以创建/编辑/删除预案

3. **上墙任务**
   - [ ] 可以手动创建上墙任务（设备 → 窗口）
   - [ ] 可以调用预案（一键切换）
   - [ ] 可以配置轮巡任务（设备列表、轮巡间隔）
   - [ ] 可以启动/停止轮巡
   - [ ] 告警时可以自动上墙（告警联动）

4. **大屏控制**
   - [ ] 可以切换分屏布局（1x1/2x2/3x3/4x4等）
   - [ ] 可以切换单个窗口的画面
   - [ ] 可以控制音频输出
   - [ ] 可以全屏显示单个窗口

### 地图展示模块验收标准

1. **地图基础**
   - [ ] 可以加载地图（默认中心点、缩放级别）
   - [ ] 可以缩放地图（放大/缩小）
   - [ ] 可以平移地图（拖拽移动）
   - [ ] 可以切换图层（卫星图/路线图）
   - [ ] 可以全屏显示地图

2. **设备定位**
   - [ ] 可以在地图上显示设备位置（设备图标）
   - [ ] 缩小时设备自动聚合显示
   - [ ] 可以按设备类型/状态筛选显示
   - [ ] 可以搜索设备并定位
   - [ ] 点击设备可以查看设备详情
   - [ ] 点击设备可以快速预览视频

3. **区域管理**
   - [ ] 可以绘制区域边界（多边形）
   - [ ] 可以编辑已有区域边界
   - [ ] 不同区域可以设置不同颜色
   - [ ] 可以统计区域内设备数量
   - [ ] 区域告警时可以高亮显示

4. **告警展示**
   - [ ] 告警位置可以闪烁标记
   - [ ] 告警数量可以聚合显示
   - [ ] 点击告警可以跳转到告警处理页面
   - [ ] 可以显示告警热力图

5. **轨迹展示**
   - [ ] 可以显示人员移动轨迹
   - [ ] 可以显示车辆移动轨迹
   - [ ] 可以回放轨迹动画
   - [ ] 可以导出轨迹数据

---

## 🎯 最终共识

### 明确的需求描述

**解码上墙模块**: 实现完整的解码上墙功能，包括解码器管理、电视墙管理、上墙任务管理、预案管理、轮巡管理和大屏控制。

**地图展示模块**: 实现完整的地图展示功能，包括地图基础功能、设备定位、区域管理、告警展示和轨迹展示。

### 技术实现方案

**解码上墙模块**:
- 创建6个实体类（VideoWall、VideoWallWindow、VideoWallPreset、VideoWallTour、VideoDisplayTask，VideoDecoder已存在）
- 创建6个DAO接口
- 创建2个Manager类（VideoWallManager、DecoderManager）
- 创建1个Service接口和实现类
- 创建1个Controller类

**地图展示模块**:
- 创建4个实体类（DeviceLocation、MapRegion、LocationTrack、MapPoi）
- 创建4个DAO接口
- 创建2个Manager类（VideoMapManager、DeviceLocationManager）
- 创建1个Service接口和实现类
- 创建1个Controller类

### 任务边界限制

- 不包含前端实现（前端负责）
- 不包含硬件驱动开发（设备厂商负责）
- 不包含地图服务商SDK集成（前端负责）
- 严格按照文档设计实现

### 验收标准

- 所有功能点都可以通过API接口调用
- 单元测试覆盖率 > 80%
- 编译通过，无语法错误
- 遵循所有架构规范

---

**确认所有不确定性已解决**: ✅ 是
