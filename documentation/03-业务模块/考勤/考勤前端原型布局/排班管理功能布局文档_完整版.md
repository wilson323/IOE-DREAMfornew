# æ’ç­ç®¡ç†åŠŸèƒ½å¸ƒå±€æ–‡æ¡£ - å®Œæ•´ç‰ˆ

## åŠŸèƒ½æ¦‚è¿°

æ’ç­ç®¡ç†æ¨¡å—æ˜¯è€ƒå‹¤ç³»ç»Ÿçš„æ ¸å¿ƒæ’ç­é…ç½®ä¸­å¿ƒï¼Œæä¾›æ’ç­æ—¥å†ã€æ­£å¸¸æ’ç­ã€ä¸´æ—¶æ’ç­ã€æ™ºèƒ½æ’ç­ã€æ’ç­ç»Ÿè®¡ç­‰åŠŸèƒ½ã€‚è¯¥æ¨¡å—æ”¯æŒå¯è§†åŒ–æ’ç­æ“ä½œã€æ‹–æ‹½æ’ç­è°ƒæ•´ã€æ‰¹é‡æ’ç­å¤„ç†ã€æ™ºèƒ½æ’ç­ç®—æ³•ç­‰ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸åŒä¼ä¸šçš„å¤æ‚æ’ç­éœ€æ±‚ï¼Œæé«˜æ’ç­æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚

## æŠ€æœ¯æ¶æ„è§„èŒƒ

### å‰ç«¯æŠ€æœ¯æ ˆ
- **æ ¸å¿ƒæ¡†æ¶**: Vue 3.4.27 (Composition API)
- **UIç»„ä»¶åº“**: Ant Design Vue 4.2.5
- **çŠ¶æ€ç®¡ç†**: Pinia 2.1.7
- **è·¯ç”±ç®¡ç†**: Vue Router 4.3.2
- **HTTPå®¢æˆ·ç«¯**: Axios 1.6.8
- **æ—¥å†ç»„ä»¶**: FullCalendar.js
- **æ‹–æ‹½ç»„ä»¶**: Vue.Draggable
- **æ ·å¼é¢„å¤„ç†å™¨**: Less 4.2.0
- **å›¾æ ‡åº“**: @ant-design/icons-vue

### é¡¹ç›®æ–‡ä»¶ç»„ç»‡ç»“æ„
```
src/views/business/attendance/scheduling/
â”œâ”€â”€ index.vue                        # æ’ç­ç®¡ç†ä¸»é¡µé¢
â”œâ”€â”€ calendar/
â”‚   â”œâ”€â”€ index.vue                   # æ’ç­æ—¥å†é¡µé¢
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ CalendarView.vue        # æ—¥å†è§†å›¾ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ScheduleCard.vue        # æ’ç­å¡ç‰‡ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ CalendarToolbar.vue     # æ—¥å†å·¥å…·æ 
â”‚   â”‚   â””â”€â”€ ViewSwitcher.vue        # è§†å›¾åˆ‡æ¢ç»„ä»¶
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ calendar-api.js         # æ—¥å†API
â”œâ”€â”€ normal/
â”‚   â”œâ”€â”€ index.vue                   # æ­£å¸¸æ’ç­é¡µé¢
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ PeriodicSchedule.vue    # å‘¨æœŸæ€§æ’ç­
â”‚   â”‚   â”œâ”€â”€ BatchSchedule.vue       # æ‰¹é‡æ’ç­
â”‚   â”‚   â””â”€â”€ ScheduleRules.vue       # æ’ç­è§„åˆ™
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ normal-api.js           # æ­£å¸¸æ’ç­API
â”œâ”€â”€ temporary/
â”‚   â”œâ”€â”€ index.vue                   # ä¸´æ—¶æ’ç­é¡µé¢
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ TempScheduleForm.vue    # ä¸´æ—¶æ’ç­è¡¨å•
â”‚   â”‚   â”œâ”€â”€ ScheduleConflict.vue    # å†²çªæ£€æµ‹
â”‚   â”‚   â””â”€â”€ PriorityManager.vue     # ä¼˜å…ˆçº§ç®¡ç†
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ temporary-api.js        # ä¸´æ—¶æ’ç­API
â”œâ”€â”€ intelligent/
â”‚   â”œâ”€â”€ index.vue                   # æ™ºèƒ½æ’ç­é¡µé¢
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ AlgorithmSettings.vue   # ç®—æ³•è®¾ç½®
â”‚   â”‚   â”œâ”€â”€ AutoScheduler.vue       # è‡ªåŠ¨æ’ç­
â”‚   â”‚   â””â”€â”€ ScheduleOptimizer.vue   # æ’ç­ä¼˜åŒ–
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ intelligent-api.js      # æ™ºèƒ½æ’ç­API
â”œâ”€â”€ statistics/
â”‚   â”œâ”€â”€ index.vue                   # æ’ç­ç»Ÿè®¡é¡µé¢
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ CompletionStats.vue     # å®Œæˆç»Ÿè®¡
â”‚   â”‚   â”œâ”€â”€ QualityAnalysis.vue     # è´¨é‡åˆ†æ
â”‚   â”‚   â””â”€â”€ ScheduleReports.vue     # æ’ç­æŠ¥è¡¨
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ statistics-api.js       # ç»Ÿè®¡API
â”œâ”€â”€ mock/
â”‚   â””â”€â”€ scheduling-mock.js          # æ¨¡æ‹Ÿæ•°æ®
â”œâ”€â”€ api/
â”‚   â””â”€â”€ scheduling-api.js            # ç»Ÿä¸€APIæ¥å£
â””â”€â”€ utils/
    â”œâ”€â”€ calendar-utils.js           # æ—¥å†å·¥å…·å‡½æ•°
    â”œâ”€â”€ schedule-utils.js           # æ’ç­å·¥å…·å‡½æ•°
    â””â”€â”€ conflict-detector.js        # å†²çªæ£€æµ‹å·¥å…·
```

### APIæ¥å£è®¾è®¡
```javascript
// src/api/business/attendance/scheduling/calendar-api.js
import { postRequest, getRequest, putRequest, deleteRequest } from '/@/lib/axios';

export const calendarApi = {
  // æ’ç­æ—¥å†
  getScheduleCalendar: (params) => getRequest('/attendance/scheduling/calendar', params),
  createScheduleItem: (params) => postRequest('/attendance/scheduling/calendar/create', params),
  updateScheduleItem: (id, params) => putRequest(`/attendance/scheduling/calendar/${id}`, params),
  deleteScheduleItem: (id) => deleteRequest(`/attendance/scheduling/calendar/${id}`),

  // æ‹–æ‹½æ’ç­
  moveScheduleItem: (params) => postRequest('/attendance/scheduling/calendar/move', params),
  copyScheduleItem: (params) => postRequest('/attendance/scheduling/calendar/copy', params),

  // æ‰¹é‡æ“ä½œ
  batchCreateSchedule: (params) => postRequest('/attendance/scheduling/calendar/batch-create', params),
  batchUpdateSchedule: (params) => postRequest('/attendance/scheduling/calendar/batch-update', params),
  batchDeleteSchedule: (params) => postRequest('/attendance/scheduling/calendar/batch-delete', params),
};

// src/api/business/attendance/scheduling/normal-api.js
export const normalSchedulingApi = {
  // å‘¨æœŸæ€§æ’ç­
  getPeriodicSchedules: (params) => getRequest('/attendance/scheduling/normal/periodic/list', params),
  createPeriodicSchedule: (params) => postRequest('/attendance/scheduling/normal/periodic/create', params),
  updatePeriodicSchedule: (id, params) => putRequest(`/attendance/scheduling/normal/periodic/${id}`, params),

  // æ‰¹é‡æ’ç­
  getBatchScheduleTemplates: () => getRequest('/attendance/scheduling/normal/batch/templates'),
  createBatchSchedule: (params) => postRequest('/attendance/scheduling/normal/batch/create', params),

  // æ’ç­è§„åˆ™
  getScheduleRules: (params) => getRequest('/attendance/scheduling/normal/rules', params),
  createScheduleRule: (params) => postRequest('/attendance/scheduling/normal/rules/create', params),
};

// src/api/business/attendance/scheduling/intelligent-api.js
export const intelligentApi = {
  // ç®—æ³•è®¾ç½®
  getAlgorithmSettings: () => getRequest('/attendance/scheduling/intelligent/settings'),
  updateAlgorithmSettings: (params) => putRequest('/attendance/scheduling/intelligent/settings', params),

  // è‡ªåŠ¨æ’ç­
  startAutoScheduling: (params) => postRequest('/attendance/scheduling/intelligent/auto-start', params),
  getSchedulingProgress: (taskId) => getRequest(`/attendance/scheduling/intelligent/progress/${taskId}`),
  stopScheduling: (taskId) => postRequest(`/attendance/scheduling/intelligent/stop/${taskId}`),

  // æ’ç­ä¼˜åŒ–
  optimizeSchedule: (params) => postRequest('/attendance/scheduling/intelligent/optimize', params),
  getOptimizationSuggestions: (params) => getRequest('/attendance/scheduling/intelligent/suggestions', params),
};
```

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
## ğŸ“‹ IOE-DREAMä¸ƒå¾®æœåŠ¡æ¶æ„

**æ ¸å¿ƒæ¶æ„ç»„æˆ**:
- **Gateway Service (8080)**: APIç½‘å…³
- **Common Service (8088)**: å…¬å…±æ¨¡å—å¾®æœåŠ¡
- **DeviceComm Service (8087)**: è®¾å¤‡é€šè®¯å¾®æœåŠ¡
- **OA Service (8089)**: OAå¾®æœåŠ¡
- **Access Service (8090)**: é—¨ç¦æœåŠ¡
- **Attendance Service (8091)**: è€ƒå‹¤æœåŠ¡
- **Video Service (8092)**: è§†é¢‘æœåŠ¡
- **Consume Service (8094)**: æ¶ˆè´¹æœåŠ¡
- **Visitor Service (8095)**: è®¿å®¢æœåŠ¡

**æ¶æ„ç‰¹ç‚¹**:
- åŸºäºSpring Boot 3.5.8 + Java 17
- ä¸¥æ ¼éµå¾ªä¼ä¸šçº§å¾®æœåŠ¡è§„èŒƒ
- æ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨ã€æ°´å¹³æ‰©å±•

**æŠ€æœ¯æ ˆæ ‡å‡†**:
- **æ•°æ®åº“**: MySQL 8.0 + Druidè¿æ¥æ± 
- **ç¼“å­˜**: Redis + Caffeineå¤šçº§ç¼“å­˜
- **æ³¨å†Œä¸­å¿ƒ**: Nacos
- **é…ç½®ä¸­å¿ƒ**: Nacos Config
- **è®¤è¯æˆæƒ**: Sa-Token

## ğŸ—ï¸ å››å±‚æ¶æ„è§„èŒƒ

**æ ‡å‡†æ¶æ„æ¨¡å¼**:
```
Controller (æ¥å£æ§åˆ¶å±‚)
    â†“
Service (æ ¸å¿ƒä¸šåŠ¡å±‚)
    â†“
Manager (æµç¨‹ç®¡ç†å±‚)
    â†“
DAO (æ•°æ®è®¿é—®å±‚)
```

**å±‚çº§èŒè´£**:
- **Controllerå±‚**: HTTPè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ã€æƒé™æ§åˆ¶
- **Serviceå±‚**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™éªŒè¯
- **Managerå±‚**: å¤æ‚æµç¨‹ç¼–æ’ã€å¤šæ•°æ®ç»„è£…ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- **DAOå±‚**: æ•°æ®åº“CRUDæ“ä½œã€SQLæŸ¥è¯¢å®ç°ã€æ•°æ®è®¿é—®è¾¹ç•Œ

**ä¸¥æ ¼ç¦æ­¢è·¨å±‚è®¿é—®**: Controllerä¸èƒ½ç›´æ¥è°ƒç”¨Manager/DAOï¼
### 1. æ’ç­æ—¥å†
## âš ï¸ IOE-DREAMé›¶å®¹å¿è§„åˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å¿…é¡»éµå®ˆçš„æ¶æ„è§„åˆ™**:
- âœ… **å¿…é¡»ä½¿ç”¨ @Resource æ³¨å…¥ä¾èµ–**
- âœ… **å¿…é¡»ä½¿ç”¨ @Mapper æ³¨è§£** (ç¦æ­¢@Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ Dao åç¼€** (ç¦æ­¢Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ @RestController æ³¨è§£**
- âœ… **å¿…é¡»ä½¿ç”¨ @Valid å‚æ•°æ ¡éªŒ**
- âœ… **å¿…é¡»è¿”å›ç»Ÿä¸€ResponseDTOæ ¼å¼**
- âœ… **å¿…é¡»éµå¾ªå››å±‚æ¶æ„è¾¹ç•Œ**

**ä¸¥æ ¼ç¦æ­¢äº‹é¡¹**:
- âŒ **ç¦æ­¢ä½¿ç”¨ @Autowired æ³¨å…¥**
- âŒ **ç¦æ­¢ä½¿ç”¨ @Repository æ³¨è§£**
- âŒ **ç¦æ­¢ä½¿ç”¨ Repository åç¼€å‘½å**
- âŒ **ç¦æ­¢è·¨å±‚è®¿é—®**
- âŒ **ç¦æ­¢åœ¨Controllerä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘**
- âŒ **ç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“**

**è¿è§„åæœ**: P0çº§é—®é¢˜ï¼Œç«‹å³ä¿®å¤ï¼Œç¦æ­¢åˆå¹¶ï¼

#### æ—¥å†è§†å›¾ç»„ä»¶
```vue
<!-- src/views/business/attendance/scheduling/calendar/components/CalendarView.vue -->
<template>
  <div class="calendar-view">
    <FullCalendar
      ref="calendarRef"
      :options="calendarOptions"
      class="calendar-container"
    />

    <!-- æ’ç­è¯¦æƒ…å¼¹çª— -->
    <a-modal
      v-model:open="scheduleDetailVisible"
      title="æ’ç­è¯¦æƒ…"
      @ok="handleSaveSchedule"
      @cancel="handleCloseDetail"
      width="600px"
    >
      <ScheduleDetailForm
        ref="scheduleFormRef"
        :schedule-data="currentSchedule"
        :date="selectedDate"
        @employee-select="handleEmployeeSelect"
      />
    </a-modal>

    <!-- å¿«é€Ÿæ’ç­å¼¹çª— -->
    <a-modal
      v-model:open="quickScheduleVisible"
      title="å¿«é€Ÿæ’ç­"
      @ok="handleQuickSchedule"
      @cancel="quickScheduleVisible = false"
    >
      <QuickScheduleForm
        :date="selectedDate"
        :employees="availableEmployees"
        @success="handleQuickScheduleSuccess"
      />
    </a-modal>

    <!-- å†²çªæç¤º -->
    <a-modal
      v-model:open="conflictVisible"
      title="æ’ç­å†²çªæ£€æµ‹"
      :footer="null"
    >
      <ConflictResolver
        :conflicts="scheduleConflicts"
        @resolve="handleResolveConflict"
      />
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, watch } from 'vue';
import { message } from 'ant-design-vue';
import FullCalendar from '@fullcalendar/vue3';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
import interactionPlugin from '@fullcalendar/interaction';
import { Calendar } from '@fullcalendar/core';
import zhLocale from '@fullcalendar/core/locales/zh-cn';
import { calendarApi } from '/@/api/business/attendance/scheduling/calendar-api';
import ScheduleDetailForm from './ScheduleDetailForm.vue';
import QuickScheduleForm from './QuickScheduleForm.vue';
import ConflictResolver from './ConflictResolver.vue';

const props = defineProps({
  viewMode: {
    type: String,
    default: 'dayGridMonth'
  },
  currentDate: {
    type: Date,
    default: () => new Date()
  },
  filters: {
    type: Object,
    default: () => ({})
  }
});

const emit = defineEmits(['view-change', 'date-change', 'schedule-change']);

const calendarRef = ref();
const scheduleDetailVisible = ref(false);
const quickScheduleVisible = ref(false);
const conflictVisible = ref(false);
const currentSchedule = ref(null);
const selectedDate = ref(null);
const availableEmployees = ref([]);
const scheduleConflicts = ref([]);
const scheduleFormRef = ref();

const calendarOptions = reactive({
  plugins: [dayGridPlugin, timeGridPlugin, interactionPlugin],
  initialView: props.viewMode,
  headerToolbar: false, // ä½¿ç”¨è‡ªå®šä¹‰å·¥å…·æ 
  locale: zhLocale,
  height: 'auto',
  contentHeight: 600,
  editable: true,
  droppable: true,
  selectable: true,
  selectMirror: true,
  dayMaxEvents: true,
  weekends: true,
  events: [],
  eventClick: handleEventClick,
  eventDrop: handleEventDrop,
  eventResize: handleEventResize,
  select: handleDateSelect,
  drop: handleDrop,
});

// åŠ è½½æ’ç­æ•°æ®
const loadScheduleData = async () => {
  try {
    const params = {
      startDate: formatDate(getCalendarStart()),
      endDate: formatDate(getCalendarEnd()),
      ...props.filters
    };

    const response = await calendarApi.getScheduleCalendar(params);
    const events = response.data.map(item => formatCalendarEvent(item));

    const calendarApi = calendarRef.value?.getApi();
    if (calendarApi) {
      calendarApi.removeAllEvents();
      calendarApi.addEventSource(events);
    }
  } catch (error) {
    console.error('åŠ è½½æ’ç­æ•°æ®å¤±è´¥:', error);
    message.error('åŠ è½½æ’ç­æ•°æ®å¤±è´¥');
  }
};

// æ ¼å¼åŒ–æ—¥å†äº‹ä»¶
const formatCalendarEvent = (item) => {
  return {
    id: item.id,
    title: `${item.employeeName} - ${item.shiftName}`,
    start: `${item.date}T${item.startTime || '00:00'}`,
    end: `${item.date}T${item.endTime || '23:59'}`,
    backgroundColor: getShiftColor(item.shiftType),
    borderColor: getShiftBorderColor(item.shiftType),
    textColor: '#fff',
    extendedProps: {
      ...item,
      type: 'schedule'
    }
  };
};

// è·å–ç­æ¬¡é¢œè‰²
const getShiftColor = (shiftType) => {
  const colorMap = {
    morning: '#52c41a',
    afternoon: '#1890ff',
    night: '#722ed1',
    flexible: '#fa8c16'
  };
  return colorMap[shiftType] || '#1890ff';
};

// è·å–ç­æ¬¡è¾¹æ¡†é¢œè‰²
const getShiftBorderColor = (shiftType) => {
  return getShiftColor(shiftType);
};

// äº‹ä»¶ç‚¹å‡»å¤„ç†
const handleEventClick = (info) => {
  const event = info.event;
  currentSchedule.value = event.extendedProps;
  selectedDate.value = event.start;
  scheduleDetailVisible.value = true;
};

// äº‹ä»¶æ‹–æ‹½å¤„ç†
const handleEventDrop = async (info) => {
  try {
    const event = info.event;
    const newDate = formatDate(event.start);

    await calendarApi.moveScheduleItem({
      scheduleId: event.id,
      newDate: newDate,
      oldDate: formatDate(info.oldEvent.start)
    });

    message.success('æ’ç­è°ƒæ•´æˆåŠŸ');
    emit('schedule-change');
  } catch (error) {
    info.revert();
    message.error('æ’ç­è°ƒæ•´å¤±è´¥');
  }
};

// äº‹ä»¶å¤§å°è°ƒæ•´å¤„ç†
const handleEventResize = async (info) => {
  try {
    const event = info.event;
    await calendarApi.updateScheduleItem(event.id, {
      startTime: formatTime(event.start),
      endTime: formatTime(event.end)
    });

    message.success('æ’ç­æ—¶é—´è°ƒæ•´æˆåŠŸ');
    emit('schedule-change');
  } catch (error) {
    info.revert();
    message.error('æ’ç­æ—¶é—´è°ƒæ•´å¤±è´¥');
  }
};

// æ—¥æœŸé€‰æ‹©å¤„ç†
const handleDateSelect = (info) => {
  selectedDate.value = info.start;
  quickScheduleVisible.value = true;
};

// æ‹–æ‹½å¤„ç†
const handleDrop = async (info) => {
  try {
    const dateStr = formatDate(info.date);
    const employeeData = JSON.parse(info.draggedEl.dataset.employee);

    await calendarApi.createScheduleItem({
      employeeId: employeeData.id,
      date: dateStr,
      shiftId: employeeData.defaultShiftId,
      source: 'drag_drop'
    });

    message.success('æ’ç­æ·»åŠ æˆåŠŸ');
    loadScheduleData();
    emit('schedule-change');
  } catch (error) {
    message.error('æ’ç­æ·»åŠ å¤±è´¥');
  }
};

// ä¿å­˜æ’ç­è¯¦æƒ…
const handleSaveSchedule = async () => {
  try {
    const formData = await scheduleFormRef.value.getFormData();

    if (currentSchedule.value) {
      await calendarApi.updateScheduleItem(currentSchedule.value.id, formData);
    } else {
      await calendarApi.createScheduleItem(formData);
    }

    message.success('æ’ç­ä¿å­˜æˆåŠŸ');
    scheduleDetailVisible.value = false;
    loadScheduleData();
    emit('schedule-change');
  } catch (error) {
    message.error('æ’ç­ä¿å­˜å¤±è´¥');
  }
};

// å…³é—­è¯¦æƒ…
const handleCloseDetail = () => {
  scheduleDetailVisible.value = false;
  currentSchedule.value = null;
};

// å¿«é€Ÿæ’ç­
const handleQuickSchedule = () => {
  // é€»è¾‘ç”±QuickScheduleFormå¤„ç†
};

// å¿«é€Ÿæ’ç­æˆåŠŸ
const handleQuickScheduleSuccess = () => {
  quickScheduleVisible.value = false;
  loadScheduleData();
  emit('schedule-change');
};

// å‘˜å·¥é€‰æ‹©å¤„ç†
const handleEmployeeSelect = (employee) => {
  // å¤„ç†å‘˜å·¥é€‰æ‹©é€»è¾‘
};

// è§£å†³å†²çª
const handleResolveConflict = (resolution) => {
  conflictVisible.value = false;
  // åº”ç”¨è§£å†³æ–¹æ¡ˆ
};

// å·¥å…·å‡½æ•°
const formatDate = (date) => {
  return Calendar.formatDate(date, { year: 'numeric', month: '2-digit', day: '2-digit' });
};

const formatTime = (date) => {
  return Calendar.formatDate(date, { hour: '2-digit', minute: '2-digit', hour12: false });
};

const getCalendarStart = () => {
  const calendarApi = calendarRef.value?.getApi();
  return calendarApi?.view?.currentStart || new Date();
};

const getCalendarEnd = () => {
  const calendarApi = calendarRef.value?.getApi();
  return calendarApi?.view?.currentEnd || new Date();
};

// ç›‘å¬propså˜åŒ–
watch(() => props.currentDate, () => {
  const calendarApi = calendarRef.value?.getApi();
  if (calendarApi) {
    calendarApi.gotoDate(props.currentDate);
  }
});

watch(() => props.viewMode, (newMode) => {
  const calendarApi = calendarRef.value?.getApi();
  if (calendarApi) {
    calendarApi.changeView(newMode);
  }
});

watch(() => props.filters, () => {
  loadScheduleData();
}, { deep: true });

// æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
defineExpose({
  loadScheduleData,
  getCalendarApi: () => calendarRef.value?.getApi()
});

onMounted(() => {
  loadScheduleData();
});
</script>

<style scoped lang="less">
.calendar-view {
  .calendar-container {
    :deep(.fc) {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    :deep(.fc-toolbar-title) {
      font-size: 18px;
      font-weight: 600;
    }

    :deep(.fc-button) {
      background: #fff;
      border: 1px solid #d9d9d9;
      color: rgba(0, 0, 0, 0.88);

      &:hover {
        border-color: #1890ff;
        color: #1890ff;
      }

      &.fc-button-active {
        background: #1890ff;
        border-color: #1890ff;
        color: #fff;
      }
    }

    :deep(.fc-event) {
      border-radius: 4px;
      cursor: pointer;

      &:hover {
        opacity: 0.8;
      }
    }

    :deep(.fc-daygrid-day) {
      min-height: 100px;
    }

    :deep(.fc-day-today) {
      background: #f0f8ff;
    }
  }
}
</style>
```

### 2. æ™ºèƒ½æ’ç­

#### è‡ªåŠ¨æ’ç­ç»„ä»¶
```vue
<!-- src/views/business/attendance/scheduling/intelligent/components/AutoScheduler.vue -->
<template>
  <div class="auto-scheduler">
    <div class="scheduler-header">
      <h3>æ™ºèƒ½è‡ªåŠ¨æ’ç­</h3>
      <div class="scheduler-actions">
        <a-button @click="showSettings">
          <template #icon><SettingOutlined /></template>
          ç®—æ³•è®¾ç½®
        </a-button>
        <a-button type="primary" @click="startScheduling" :loading="scheduling">
          <template #icon><PlayCircleOutlined /></template>
          å¼€å§‹æ’ç­
        </a-button>
      </div>
    </div>

    <!-- æ’ç­é…ç½® -->
    <div class="scheduling-config">
      <a-card title="æ’ç­é…ç½®" :bordered="false">
        <a-form layout="vertical" :model="schedulingConfig">
          <a-row :gutter="16">
            <a-col :span="8">
              <a-form-item label="æ’ç­å‘¨æœŸ">
                <a-range-picker
                  v-model:value="schedulingConfig.dateRange"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="ç›®æ ‡éƒ¨é—¨">
                <a-select
                  v-model:value="schedulingConfig.departments"
                  mode="multiple"
                  placeholder="é€‰æ‹©éƒ¨é—¨"
                  style="width: 100%"
                >
                  <a-select-option
                    v-for="dept in departments"
                    :key="dept.id"
                    :value="dept.id"
                  >
                    {{ dept.name }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="æ’ç­æ¨¡å¼">
                <a-select v-model:value="schedulingConfig.mode" style="width: 100%">
                  <a-select-option value="fill">å¡«å……ç©ºç¼º</a-select-option>
                  <a-select-option value="optimize">ä¼˜åŒ–ç°æœ‰</a-select-option>
                  <a-select-option value="rebuild">é‡æ–°æ’ç­</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
          </a-row>

          <a-form-item label="æ’ç­çº¦æŸ">
            <a-checkbox-group v-model:value="schedulingConfig.constraints">
              <a-checkbox value="workTime">å·¥æ—¶å¹³è¡¡</a-checkbox>
              <a-checkbox value="skillMatch">æŠ€èƒ½åŒ¹é…</a-checkbox>
              <a-checkbox value="prefMatch">åå¥½åŒ¹é…</a-checkbox>
              <a-checkbox value="legalCompliance">åˆè§„è¦æ±‚</a-checkbox>
              <a-checkbox value="costOptimize">æˆæœ¬ä¼˜åŒ–</a-checkbox>
            </a-checkbox-group>
          </a-form-item>

          <a-form-item label="ä¼˜åŒ–ç›®æ ‡">
            <a-radio-group v-model:value="schedulingConfig.objective">
              <a-radio value="balance">å·¥ä½œé‡å¹³è¡¡</a-radio>
              <a-radio value="coverage">è¦†ç›–ç‡æœ€å¤§åŒ–</a-radio>
              <a-radio value="cost">æˆæœ¬æœ€å°åŒ–</a-radio>
              <a-radio value="satisfaction">å‘˜å·¥æ»¡æ„åº¦</a-radio>
            </a-radio-group>
          </a-form-item>
        </a-form>
      </a-card>
    </div>

    <!-- æ’ç­è¿›åº¦ -->
    <div class="scheduling-progress" v-if="scheduling || progressVisible">
      <a-card title="æ’ç­è¿›åº¦" :bordered="false">
        <div class="progress-content">
          <a-progress
            :percent="progressPercent"
            :status="progressStatus"
            stroke-linecap="square"
          />

          <div class="progress-details">
            <a-descriptions :column="2" size="small">
              <a-descriptions-item label="å½“å‰æ­¥éª¤">
                {{ currentStep }}
              </a-descriptions-item>
              <a-descriptions-item label="é¢„è®¡å‰©ä½™æ—¶é—´">
                {{ estimatedTime }}
              </a-descriptions-item>
              <a-descriptions-item label="å·²å¤„ç†å‘˜å·¥">
                {{ processedEmployees }}/{{ totalEmployees }}
              </a-descriptions-item>
              <a-descriptions-item label="å·²æ’ç­å¤©æ•°">
                {{ processedDays }}/{{ totalDays }}
              </a-descriptions-item>
            </a-descriptions>
          </div>

          <div class="progress-actions">
            <a-button v-if="scheduling" @click="pauseScheduling">
              <template #icon><PauseCircleOutlined /></template>
              æš‚åœ
            </a-button>
            <a-button v-if="scheduling" danger @click="stopScheduling">
              <template #icon><StopOutlined /></template>
              åœæ­¢
            </a-button>
            <a-button v-if="!scheduling && progressPercent < 100" @click="resumeScheduling">
              <template #icon><PlayCircleOutlined /></template>
              ç»§ç»­
            </a-button>
          </div>
        </div>
      </a-card>
    </div>

    <!-- æ’ç­ç»“æœ -->
    <div class="scheduling-results" v-if="resultsVisible">
      <a-card title="æ’ç­ç»“æœ" :bordered="false">
        <template #extra>
          <a-space>
            <a-button @click="exportResults">
              <template #icon><ExportOutlined /></template>
              å¯¼å‡ºç»“æœ
            </a-button>
            <a-button @click="applyResults" type="primary">
              <template #icon><CheckOutlined /></template>
              åº”ç”¨æ’ç­
            </a-button>
          </a-space>
        </template>

        <a-row :gutter="16">
          <a-col :span="6">
            <a-statistic
              title="æ’ç­å®Œæˆç‡"
              :value="results.completionRate"
              suffix="%"
              :value-style="{ color: '#52c41a' }"
            />
          </a-col>
          <a-col :span="6">
            <a-statistic
              title="è¦†ç›–ç‡"
              :value="results.coverageRate"
              suffix="%"
              :value-style="{ color: '#1890ff' }"
            />
          </a-col>
          <a-col :span="6">
            <a-statistic
              title="å¹³è¡¡åº¦å¾—åˆ†"
              :value="results.balanceScore"
              :value-style="{ color: '#fa8c16' }"
            />
          </a-col>
          <a-col :span="6">
            <a-statistic
              title="æ»¡æ„åº¦é¢„ä¼°"
              :value="results.satisfactionScore"
              :value-style="{ color: '#722ed1' }"
            />
          </a-col>
        </a-row>

        <div class="results-charts" style="margin-top: 24px;">
          <a-tabs>
            <a-tab-pane key="distribution" tab="å·¥ä½œé‡åˆ†å¸ƒ">
              <WorkloadDistributionChart :data="results.workloadData" />
            </a-tab-pane>
            <a-tab-pane key="coverage" tab="è¦†ç›–åˆ†æ">
              <CoverageAnalysisChart :data="results.coverageData" />
            </a-tab-pane>
            <a-tab-pane key="conflicts" tab="å†²çªæ£€æµ‹">
              <ConflictDetectionChart :data="results.conflictData" />
            </a-tab-pane>
          </a-tabs>
        </div>
      </a-card>
    </div>

    <!-- ç®—æ³•è®¾ç½®å¼¹çª— -->
    <AlgorithmSettings
      v-model:visible="settingsVisible"
      :settings="algorithmSettings"
      @save="handleSaveSettings"
    />
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  SettingOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  StopOutlined,
  ExportOutlined,
  CheckOutlined
} from '@ant-design/icons-vue';
import { intelligentApi } from '/@/api/business/attendance/scheduling/intelligent-api';
import AlgorithmSettings from './AlgorithmSettings.vue';
import WorkloadDistributionChart from './WorkloadDistributionChart.vue';
import CoverageAnalysisChart from './CoverageAnalysisChart.vue';
import ConflictDetectionChart from './ConflictDetectionChart.vue';

const emit = defineEmits(['scheduling-complete', 'results-applied']);

const scheduling = ref(false);
const progressVisible = ref(false);
const resultsVisible = ref(false);
const settingsVisible = ref(false);

const progressPercent = ref(0);
const progressStatus = ref('active');
const currentStep = ref('');
const estimatedTime = ref('');
const processedEmployees = ref(0);
const totalEmployees = ref(0);
const processedDays = ref(0);
const totalDays = ref(0);

const departments = ref([]);
const algorithmSettings = ref({});

const schedulingConfig = reactive({
  dateRange: [],
  departments: [],
  mode: 'fill',
  constraints: ['workTimeBalance', 'legalCompliance'],
  objective: 'balance'
});

const results = reactive({
  completionRate: 0,
  coverageRate: 0,
  balanceScore: 0,
  satisfactionScore: 0,
  workloadData: [],
  coverageData: [],
  conflictData: []
});

let currentTaskId = null;
let progressTimer = null;

// åŠ è½½éƒ¨é—¨åˆ—è¡¨
const loadDepartments = async () => {
  try {
    const response = await intelligentApi.getDepartments();
    departments.value = response.data;
  } catch (error) {
    console.error('åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥:', error);
  }
};

// åŠ è½½ç®—æ³•è®¾ç½®
const loadAlgorithmSettings = async () => {
  try {
    const response = await intelligentApi.getAlgorithmSettings();
    algorithmSettings.value = response.data;
  } catch (error) {
    console.error('åŠ è½½ç®—æ³•è®¾ç½®å¤±è´¥:', error);
  }
};

// æ˜¾ç¤ºè®¾ç½®
const showSettings = () => {
  settingsVisible.value = true;
};

// ä¿å­˜è®¾ç½®
const handleSaveSettings = async (settings) => {
  try {
    await intelligentApi.updateAlgorithmSettings(settings);
    algorithmSettings.value = { ...settings };
    message.success('ç®—æ³•è®¾ç½®ä¿å­˜æˆåŠŸ');
  } catch (error) {
    message.error('ç®—æ³•è®¾ç½®ä¿å­˜å¤±è´¥');
  }
};

// å¼€å§‹æ’ç­
const startScheduling = async () => {
  if (!validateConfig()) {
    return;
  }

  scheduling.value = true;
  progressVisible.value = true;
  resultsVisible.value = false;
  progressPercent.value = 0;
  progressStatus.value = 'active';

  try {
    const response = await intelligentApi.startAutoScheduling({
      ...schedulingConfig,
      algorithmSettings: algorithmSettings.value
    });

    currentTaskId = response.data.taskId;
    startProgressMonitoring();
  } catch (error) {
    scheduling.value = false;
    progressVisible.value = false;
    message.error('å¯åŠ¨æ’ç­å¤±è´¥');
  }
};

// éªŒè¯é…ç½®
const validateConfig = () => {
  if (!schedulingConfig.dateRange || schedulingConfig.dateRange.length !== 2) {
    message.warning('è¯·é€‰æ‹©æ’ç­å‘¨æœŸ');
    return false;
  }

  if (!schedulingConfig.departments || schedulingConfig.departments.length === 0) {
    message.warning('è¯·é€‰æ‹©ç›®æ ‡éƒ¨é—¨');
    return false;
  }

  return true;
};

// å¼€å§‹è¿›åº¦ç›‘æ§
const startProgressMonitoring = () => {
  progressTimer = setInterval(async () => {
    try {
      const response = await intelligentApi.getSchedulingProgress(currentTaskId);
      const progress = response.data;

      progressPercent.value = progress.percent;
      currentStep.value = progress.currentStep;
      estimatedTime.value = progress.estimatedTime;
      processedEmployees.value = progress.processedEmployees;
      totalEmployees.value = progress.totalEmployees;
      processedDays.value = progress.processedDays;
      totalDays.value = progress.totalDays;

      if (progress.status === 'completed') {
        completeScheduling(progress.results);
      } else if (progress.status === 'failed') {
        failScheduling(progress.error);
      }
    } catch (error) {
      console.error('è·å–è¿›åº¦å¤±è´¥:', error);
    }
  }, 2000);
};

// å®Œæˆæ’ç­
const completeScheduling = (scheduleResults) => {
  scheduling.value = false;
  progressStatus.value = 'success';
  clearInterval(progressTimer);

  // æ˜¾ç¤ºç»“æœ
  Object.assign(results, scheduleResults);
  resultsVisible.value = true;

  message.success('æ™ºèƒ½æ’ç­å®Œæˆ');
  emit('scheduling-complete', scheduleResults);
};

// æ’ç­å¤±è´¥
const failScheduling = (error) => {
  scheduling.value = false;
  progressStatus.value = 'exception';
  clearInterval(progressTimer);

  message.error(`æ’ç­å¤±è´¥: ${error}`);
};

// æš‚åœæ’ç­
const pauseScheduling = async () => {
  try {
    await intelligentApi.pauseScheduling(currentTaskId);
    scheduling.value = false;
    clearInterval(progressTimer);
    message.info('æ’ç­å·²æš‚åœ');
  } catch (error) {
    message.error('æš‚åœå¤±è´¥');
  }
};

// åœæ­¢æ’ç­
const stopScheduling = async () => {
  try {
    await intelligentApi.stopScheduling(currentTaskId);
    scheduling.value = false;
    progressVisible.value = false;
    clearInterval(progressTimer);
    message.info('æ’ç­å·²åœæ­¢');
  } catch (error) {
    message.error('åœæ­¢å¤±è´¥');
  }
};

// ç»§ç»­æ’ç­
const resumeScheduling = () => {
  scheduling.value = true;
  startProgressMonitoring();
};

// å¯¼å‡ºç»“æœ
const exportResults = () => {
  // å¯¼å‡ºæ’ç­ç»“æœ
  message.info('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
};

// åº”ç”¨æ’ç­
const applyResults = async () => {
  try {
    await intelligentApi.applySchedulingResults(currentTaskId);
    message.success('æ’ç­åº”ç”¨æˆåŠŸ');
    emit('results-applied', results);
  } catch (error) {
    message.error('æ’ç­åº”ç”¨å¤±è´¥');
  }
};

onMounted(() => {
  loadDepartments();
  loadAlgorithmSettings();
});
</script>

<style scoped lang="less">
.auto-scheduler {
  .scheduler-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;

    h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
  }

  .scheduling-config {
    margin-bottom: 24px;
  }

  .scheduling-progress {
    margin-bottom: 24px;

    .progress-content {
      .progress-details {
        margin: 16px 0;
      }

      .progress-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
    }
  }

  .scheduling-results {
    .results-charts {
      min-height: 400px;
    }
  }
}
</style>
```

## Mockæ•°æ®ç¤ºä¾‹

```javascript
// src/mock/scheduling-mock.js
export const mockScheduleCalendar = [
  {
    id: 'schedule001',
    employeeId: 'emp001',
    employeeName: 'å¼ ä¸‰',
    date: '2024-01-15',
    shiftId: 'shift001',
    shiftName: 'æ ‡å‡†æ—©ç­',
    startTime: '09:00',
    endTime: '18:00',
    shiftType: 'morning',
    status: 'confirmed'
  },
  {
    id: 'schedule002',
    employeeId: 'emp002',
    employeeName: 'æå››',
    date: '2024-01-15',
    shiftId: 'shift002',
    shiftName: 'å¤œç­',
    startTime: '22:00',
    endTime: '06:00',
    shiftType: 'night',
    status: 'confirmed'
  }
];

export const mockSchedulingResults = {
  completionRate: 95,
  coverageRate: 98,
  balanceScore: 87,
  satisfactionScore: 82,
  workloadData: [
    { name: 'å¼ ä¸‰', hours: 160, target: 160 },
    { name: 'æå››', hours: 168, target: 160 },
    { name: 'ç‹äº”', hours: 152, target: 160 }
  ],
  coverageData: [
    { date: '2024-01-15', required: 50, assigned: 50 },
    { date: '2024-01-16', required: 50, assigned: 48 },
    { date: '2024-01-17', required: 50, assigned: 50 }
  ],
  conflictData: [
    { type: 'over_time', count: 3 },
    { type: 'skill_mismatch', count: 1 },
    { type: 'preference_conflict', count: 2 }
  ]
};

export default {
  mockScheduleCalendar,
  mockSchedulingResults
};
```

## å¼€å‘æ³¨æ„äº‹é¡¹æ€»ç»“

### æ ¸å¿ƒåŠŸèƒ½è¦ç‚¹
1. **å¯è§†åŒ–æ’ç­** - ç›´è§‚çš„æ—¥å†ç•Œé¢å’Œæ‹–æ‹½æ“ä½œ
2. **æ™ºèƒ½ç®—æ³•** - å¤šçº¦æŸæ¡ä»¶ä¸‹çš„ä¼˜åŒ–æ’ç­
3. **å†²çªæ£€æµ‹** - å®æ—¶æ£€æµ‹å’Œè§£å†³æ’ç­å†²çª
4. **æ‰¹é‡æ“ä½œ** - é«˜æ•ˆçš„æ‰¹é‡æ’ç­åŠŸèƒ½
5. **è¿›åº¦ç›‘æ§** - å®æ—¶æ˜¾ç¤ºæ’ç­è¿›åº¦å’ŒçŠ¶æ€
6. **ç»“æœåˆ†æ** - è¯¦ç»†çš„æ’ç­æ•ˆæœè¯„ä¼°

### æ€§èƒ½ä¼˜åŒ–å»ºè®®
1. æ—¥å†æ•°æ®æŒ‰éœ€åŠ è½½
2. å¤§é‡æ’ç­æ•°æ®è™šæ‹Ÿæ»šåŠ¨
3. æ™ºèƒ½æ’ç­ç®—æ³•å¼‚æ­¥æ‰§è¡Œ
4. æ’ç­ç»“æœç¼“å­˜æœºåˆ¶

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–
1. æ‹–æ‹½å¼æ“ä½œç•Œé¢
2. å®æ—¶ä¿å­˜å’ŒåŒæ­¥
3. æ™ºèƒ½æç¤ºå’Œå»ºè®®
4. ä¸°å¯Œçš„å¿«æ·æ“ä½œ

## æ€»ç»“

æ’ç­ç®¡ç†æ¨¡å—ä½œä¸ºè€ƒå‹¤ç³»ç»Ÿçš„æ’ç­æ ¸å¿ƒï¼Œéœ€è¦é‡ç‚¹å…³æ³¨ï¼š

- æ’ç­æ“ä½œçš„ç›´è§‚æ€§å’Œä¾¿æ·æ€§
- æ™ºèƒ½ç®—æ³•çš„å‡†ç¡®æ€§å’Œæ•ˆç‡
- å†²çªæ£€æµ‹çš„å®æ—¶æ€§å’Œå‡†ç¡®æ€§
- æ‰¹é‡æ“ä½œçš„é«˜æ•ˆæ€§
- ç»“æœåˆ†æçš„å…¨é¢æ€§

é€šè¿‡éµå¾ªæœ¬æ–‡æ¡£çš„æŠ€æœ¯è§„èŒƒï¼Œå¯ä»¥æ„å»ºå‡ºåŠŸèƒ½å®Œå–„ã€æ™ºèƒ½é«˜æ•ˆçš„æ’ç­ç®¡ç†æ¨¡å—ã€‚