# IOE-DREAM é€šçŸ¥ç³»ç»Ÿä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: v2.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-01-30  
**é€‚ç”¨èŒƒå›´**: IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°

---

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
3. [æ¶ˆæ¯æ¨¡æ¿ç®¡ç†](#æ¶ˆæ¯æ¨¡æ¿ç®¡ç†)
4. [å¤šç§æ¶ˆæ¯æ ¼å¼](#å¤šç§æ¶ˆæ¯æ ¼å¼)
5. [ç›‘æ§æŒ‡æ ‡æŸ¥è¯¢](#ç›‘æ§æŒ‡æ ‡æŸ¥è¯¢)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‘é€é€šçŸ¥

```java
@Resource
private NotificationService notificationService;

// åˆ›å»ºé€šçŸ¥å®ä½“
NotificationEntity notification = new NotificationEntity();
notification.setTitle("ç³»ç»Ÿé€šçŸ¥");
notification.setContent("æ‚¨æœ‰ä¸€æ¡æ–°çš„ç³»ç»Ÿé€šçŸ¥");
notification.setReceiverIds("1001,1002,1003");
notification.setNotificationType(1); // 1-ç³»ç»Ÿé€šçŸ¥
notification.setChannel("DINGTALK"); // é€šçŸ¥æ¸ é“

// å‘é€é€šçŸ¥
boolean success = notificationService.sendNotification(notification);
```

### 2. ä½¿ç”¨æ¨¡æ¿å‘é€é€šçŸ¥

```java
@Resource
private NotificationTemplateService notificationTemplateService;

// æ¸²æŸ“æ¨¡æ¿
Map<String, Object> variables = new HashMap<>();
variables.put("userName", "å¼ ä¸‰");
variables.put("loginTime", "2025-01-30 10:00:00");

String content = notificationTemplateService.renderTemplate("EMAIL_LOGIN_SUCCESS", variables);
String subject = notificationTemplateService.renderSubject("EMAIL_LOGIN_SUCCESS", variables);

// åˆ›å»ºé€šçŸ¥å®ä½“
NotificationEntity notification = new NotificationEntity();
notification.setTitle(subject);
notification.setContent(content);
notification.setReceiverIds("1001");
notification.setChannel("EMAIL");

// å‘é€é€šçŸ¥
notificationService.sendNotification(notification);
```

---

## âš™ï¸ é…ç½®ç®¡ç†

### 1. è·å–é…ç½®å€¼

```java
@Resource
private NotificationConfigService notificationConfigService;

// è·å–é’‰é’‰Webhook URL
String webhookUrl = notificationConfigService.getConfigValue("DINGTALK.WEBHOOK_URL");

// è·å–ä¼ä¸šå¾®ä¿¡CorpId
String corpId = notificationConfigService.getConfigValue("WECHAT.CORP_ID");
```

### 2. æ›´æ–°é…ç½®å€¼

```java
// æ›´æ–°é…ç½®å€¼
Map<String, String> request = new HashMap<>();
request.put("configValue", "https://oapi.dingtalk.com/robot/send?access_token=xxx");
notificationConfigService.updateConfigValue("DINGTALK.WEBHOOK_URL", request);

// æ¸…é™¤é…ç½®ç¼“å­˜ï¼ˆçƒ­æ›´æ–°ï¼‰
notificationConfigService.evictCache("DINGTALK.WEBHOOK_URL");
```

### 3. è·å–é…ç½®åˆ—è¡¨

```java
// è·å–é’‰é’‰æ‰€æœ‰é…ç½®
List<NotificationConfigVO> configs = notificationConfigService.getConfigListByType("DINGTALK");

// è·å–æ‰€æœ‰å¯ç”¨çš„é…ç½®
Map<String, String> configs = notificationConfigService.getConfigsByType("DINGTALK");
```

---

## ğŸ“ æ¶ˆæ¯æ¨¡æ¿ç®¡ç†

### 1. åˆ›å»ºæ¨¡æ¿

**æ•°æ®åº“æ’å…¥ç¤ºä¾‹**:
```sql
INSERT INTO t_notification_template (
    template_code, template_name, template_type, 
    subject, content, variables, status
) VALUES (
    'EMAIL_LOGIN_SUCCESS',
    'ç™»å½•æˆåŠŸé‚®ä»¶æ¨¡æ¿',
    1, -- 1-é‚®ä»¶
    'ç™»å½•æˆåŠŸé€šçŸ¥',
    'å°Šæ•¬çš„{{userName}}ï¼Œæ‚¨äº{{loginTime}}æˆåŠŸç™»å½•IOE-DREAMç³»ç»Ÿã€‚',
    '["userName", "loginTime"]',
    1 -- 1-å¯ç”¨
);
```

### 2. ä½¿ç”¨æ¨¡æ¿

```java
@Resource
private NotificationTemplateService notificationTemplateService;

// æ¸²æŸ“æ¨¡æ¿å†…å®¹
Map<String, Object> variables = new HashMap<>();
variables.put("userName", "å¼ ä¸‰");
variables.put("loginTime", "2025-01-30 10:00:00");

String content = notificationTemplateService.renderTemplate("EMAIL_LOGIN_SUCCESS", variables);
// è¾“å‡º: "å°Šæ•¬çš„å¼ ä¸‰ï¼Œæ‚¨äº2025-01-30 10:00:00æˆåŠŸç™»å½•IOE-DREAMç³»ç»Ÿã€‚"

// æ¸²æŸ“æ¨¡æ¿ä¸»é¢˜
String subject = notificationTemplateService.renderSubject("EMAIL_LOGIN_SUCCESS", variables);
// è¾“å‡º: "ç™»å½•æˆåŠŸé€šçŸ¥"
```

### 3. è·å–æ¨¡æ¿å˜é‡åˆ—è¡¨

```java
// è·å–æ¨¡æ¿å®šä¹‰çš„å˜é‡åˆ—è¡¨
List<String> variables = notificationTemplateService.getTemplateVariables("EMAIL_LOGIN_SUCCESS");
// è¾“å‡º: ["userName", "loginTime"]
```

### 4. æ¨¡æ¿çƒ­æ›´æ–°

```java
// æ›´æ–°æ¨¡æ¿åï¼Œæ¸…é™¤ç¼“å­˜
notificationTemplateService.evictCache("EMAIL_LOGIN_SUCCESS");
```

---

## ğŸ¨ å¤šç§æ¶ˆæ¯æ ¼å¼

### 1. é’‰é’‰æ¶ˆæ¯æ ¼å¼

#### Markdownæ¶ˆæ¯ï¼ˆé»˜è®¤ï¼‰

```java
NotificationEntity notification = new NotificationEntity();
notification.setTitle("ç³»ç»Ÿé€šçŸ¥");
notification.setContent("æ‚¨æœ‰ä¸€æ¡æ–°çš„ç³»ç»Ÿé€šçŸ¥");
notification.setChannel("DINGTALK");
// é»˜è®¤ä½¿ç”¨Markdownæ ¼å¼
```

#### ActionCardæ¶ˆæ¯

```java
// éœ€è¦åœ¨é€šçŸ¥æ‰©å±•å­—æ®µä¸­æŒ‡å®šæ¶ˆæ¯æ ¼å¼ä¸º"actionCard"
// æˆ–ä¿®æ”¹DingTalkNotificationManagerçš„buildDingTalkMessageæ–¹æ³•
// æ”¯æŒå•ä¸ªæŒ‰é’®æˆ–æŒ‰é’®ç»„
```

#### FeedCardæ¶ˆæ¯

```java
// éœ€è¦åœ¨é€šçŸ¥æ‰©å±•å­—æ®µä¸­æŒ‡å®šæ¶ˆæ¯æ ¼å¼ä¸º"feedCard"
// æ”¯æŒå¤šä¸ªå¡ç‰‡é“¾æ¥
```

### 2. ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯æ ¼å¼

#### æ–‡æœ¬æ¶ˆæ¯ï¼ˆé»˜è®¤ï¼‰

```java
NotificationEntity notification = new NotificationEntity();
notification.setTitle("ç³»ç»Ÿé€šçŸ¥");
notification.setContent("æ‚¨æœ‰ä¸€æ¡æ–°çš„ç³»ç»Ÿé€šçŸ¥");
notification.setChannel("WECHAT");
// é»˜è®¤ä½¿ç”¨æ–‡æœ¬æ ¼å¼
```

#### å¡ç‰‡æ¶ˆæ¯ï¼ˆnewsï¼‰

```java
// éœ€è¦åœ¨é€šçŸ¥æ‰©å±•å­—æ®µä¸­æŒ‡å®šæ¶ˆæ¯æ ¼å¼ä¸º"news"
// æ”¯æŒå¤šä¸ªå¡ç‰‡é“¾æ¥
```

#### å›¾æ–‡æ¶ˆæ¯ï¼ˆmpnewsï¼‰

```java
// éœ€è¦åœ¨é€šçŸ¥æ‰©å±•å­—æ®µä¸­æŒ‡å®šæ¶ˆæ¯æ ¼å¼ä¸º"mpnews"
// æ”¯æŒå¯Œæ–‡æœ¬å†…å®¹
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡æŸ¥è¯¢

### 1. è·å–å‘é€æˆåŠŸç‡

```java
@Resource
private NotificationMetricsCollector notificationMetricsCollector;

// è·å–é’‰é’‰å‘é€æˆåŠŸç‡
double successRate = notificationMetricsCollector.getSuccessRate("DINGTALK");
// è¾“å‡º: 0.95 (95%)
```

### 2. è·å–å¹³å‡å‘é€è€—æ—¶

```java
// è·å–ä¼ä¸šå¾®ä¿¡å¹³å‡å‘é€è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
double avgDuration = notificationMetricsCollector.getAvgDuration("WECHAT");
// è¾“å‡º: 150.5 (150.5ms)
```

### 3. è·å–P99å‘é€è€—æ—¶

```java
// è·å–Webhook P99å‘é€è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
double p99Duration = notificationMetricsCollector.getP99Duration("WEBHOOK");
// è¾“å‡º: 500.0 (500ms)
```

### 4. è·å–å‘é€æ€»æ•°

```java
// è·å–é‚®ä»¶å‘é€æ€»æ•°
double totalCount = notificationMetricsCollector.getTotalCount("EMAIL");
// è¾“å‡º: 1000.0
```

### 5. è·å–é™æµè§¦å‘æ¬¡æ•°

```java
// è·å–é’‰é’‰é™æµè§¦å‘æ¬¡æ•°
double rateLimitCount = notificationMetricsCollector.getRateLimitCount("DINGTALK");
// è¾“å‡º: 5.0
```

### 6. è·å–é‡è¯•æ€»æ¬¡æ•°

```java
// è·å–ä¼ä¸šå¾®ä¿¡é‡è¯•æ€»æ¬¡æ•°
double retryCount = notificationMetricsCollector.getRetryCount("WECHAT");
// è¾“å‡º: 10.0
```

### 7. PrometheusæŒ‡æ ‡å¯¼å‡º

è®¿é—® `/actuator/prometheus` ç«¯ç‚¹ï¼ŒæŸ¥çœ‹æ‰€æœ‰ç›‘æ§æŒ‡æ ‡ï¼š

```bash
# é€šçŸ¥å‘é€æ€»æ•°
notification_send_total{channel="DINGTALK",status="success"} 1000.0

# é€šçŸ¥å‘é€è€—æ—¶
notification_send_duration_seconds{channel="DINGTALK",status="success",quantile="0.99"} 0.5

# é™æµè§¦å‘æ¬¡æ•°
notification_rate_limit_total{channel="DINGTALK"} 5.0

# é‡è¯•æ€»æ¬¡æ•°
notification_retry_total{channel="WECHAT"} 10.0

# é”™è¯¯ç»Ÿè®¡
notification_error_total{channel="DINGTALK",error_type="send_failed"} 2.0
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é…ç½®ç®¡ç†æœ€ä½³å®è·µ

**âœ… æ¨èåšæ³•**:
- ä½¿ç”¨Nacosé…ç½®ä¸­å¿ƒç®¡ç†æ•æ„Ÿé…ç½®
- é…ç½®å€¼åŠ å¯†å­˜å‚¨ï¼ˆis_encrypted=1ï¼‰
- é…ç½®æ›´æ–°ååŠæ—¶æ¸…é™¤ç¼“å­˜
- ä½¿ç”¨é…ç½®ç±»å‹åˆ†ç»„ç®¡ç†

**âŒ ç¦æ­¢åšæ³•**:
- ç¡¬ç¼–ç é…ç½®å€¼
- æ˜æ–‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- é…ç½®æ›´æ–°åä¸æ¸…é™¤ç¼“å­˜

### 2. æ¨¡æ¿ç®¡ç†æœ€ä½³å®è·µ

**âœ… æ¨èåšæ³•**:
- ä½¿ç”¨æ¨¡æ¿ç¼–ç ç»Ÿä¸€ç®¡ç†æ¨¡æ¿
- æ¨¡æ¿å˜é‡ä½¿ç”¨{{variable}}æ ¼å¼
- æ¨¡æ¿æ›´æ–°ååŠæ—¶æ¸…é™¤ç¼“å­˜
- æ¨¡æ¿å†…å®¹ç®€æ´æ˜äº†

**âŒ ç¦æ­¢åšæ³•**:
- åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ¶ˆæ¯å†…å®¹
- æ¨¡æ¿å˜é‡æ ¼å¼ä¸è§„èŒƒ
- æ¨¡æ¿æ›´æ–°åä¸æ¸…é™¤ç¼“å­˜

### 3. é™æµå’Œé‡è¯•æœ€ä½³å®è·µ

**âœ… æ¨èåšæ³•**:
- æ ¹æ®ç¬¬ä¸‰æ–¹APIé™åˆ¶é…ç½®é™æµé˜ˆå€¼
- ä½¿ç”¨ç»Ÿä¸€é™æµç®¡ç†å™¨
- ä½¿ç”¨ç»Ÿä¸€é‡è¯•ç®¡ç†å™¨
- ç›‘æ§é™æµå’Œé‡è¯•æŒ‡æ ‡

**âŒ ç¦æ­¢åšæ³•**:
- è¶…è¿‡ç¬¬ä¸‰æ–¹APIé™åˆ¶å‘é€
- ä¸åˆç†çš„é‡è¯•æ¬¡æ•°
- ä¸ç›‘æ§é™æµå’Œé‡è¯•æŒ‡æ ‡

### 4. ç›‘æ§æŒ‡æ ‡æœ€ä½³å®è·µ

**âœ… æ¨èåšæ³•**:
- å®šæœŸæŸ¥çœ‹ç›‘æ§æŒ‡æ ‡
- è®¾ç½®å‘Šè­¦é˜ˆå€¼
- ä½¿ç”¨Prometheuså’ŒGrafanaå¯è§†åŒ–
- å…³æ³¨P99å“åº”æ—¶é—´

**âŒ ç¦æ­¢åšæ³•**:
- ä¸å…³æ³¨ç›‘æ§æŒ‡æ ‡
- ä¸è®¾ç½®å‘Šè­¦é˜ˆå€¼
- ä¸åˆ†ææ€§èƒ½ç“¶é¢ˆ

---

## ğŸ”§ APIæ¥å£æ–‡æ¡£

### é€šçŸ¥é…ç½®ç®¡ç†API

**åŸºç¡€è·¯å¾„**: `/api/v1/notification/config`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/value/{configKey}` | GET | è·å–é…ç½®å€¼ |
| `/type/{configType}` | GET | è·å–é…ç½®åˆ—è¡¨ï¼ˆæŒ‰ç±»å‹ï¼‰ |
| `/value/{configKey}` | PUT | æ›´æ–°é…ç½®å€¼ |
| `/status/{configKey}` | PUT | æ›´æ–°é…ç½®çŠ¶æ€ |
| `/list/{configType}` | GET | è·å–é…ç½®åˆ—è¡¨ï¼ˆè¯¦ç»†ä¿¡æ¯ï¼‰ |
| `/cache/evict/{configKey}` | PUT | æ¸…é™¤é…ç½®ç¼“å­˜ |

### é€šçŸ¥æ¨¡æ¿ç®¡ç†API

**åŸºç¡€è·¯å¾„**: `/api/v1/notification/template`

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/code/{templateCode}` | GET | è·å–æ¨¡æ¿ |
| `/type/{templateType}` | GET | è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆæŒ‰ç±»å‹ï¼‰ |
| `/type/{templateType}/status/{status}` | GET | è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆæŒ‰ç±»å‹å’ŒçŠ¶æ€ï¼‰ |
| `/render/{templateCode}` | POST | æ¸²æŸ“æ¨¡æ¿ |
| `/render-subject/{templateCode}` | POST | æ¸²æŸ“æ¨¡æ¿ä¸»é¢˜ |
| `/variables/{templateCode}` | GET | è·å–æ¨¡æ¿å˜é‡åˆ—è¡¨ |
| `/cache/evict/{templateCode}` | PUT | æ¸…é™¤æ¨¡æ¿ç¼“å­˜ |

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**é—®é¢˜åé¦ˆ**: åœ¨é¡¹ç›®issueä¸­æäº¤é—®é¢˜  
**æ–‡æ¡£æ›´æ–°**: è”ç³»æ¶æ„å¸ˆå›¢é˜Ÿ  
**æŠ€æœ¯æ”¯æŒ**: IOE-DREAMæ¶æ„å§”å‘˜ä¼š

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0  
**æœ€åæ›´æ–°**: 2025-01-30  
**ç»´æŠ¤å›¢é˜Ÿ**: IOE-DREAMæ¶æ„å§”å‘˜ä¼š
