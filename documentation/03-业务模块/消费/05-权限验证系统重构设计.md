# 05-æƒé™éªŒè¯ç³»ç»Ÿé‡æ„è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**é‡æ„ç›®æ ‡**ï¼šæ„å»ºç»Ÿä¸€çš„æƒé™éªŒè¯ç³»ç»Ÿï¼Œæ•´åˆåŒºåŸŸã€é¤åˆ«ã€å®šå€¼ã€é™é¢ç­‰å¤šç»´åº¦æƒé™éªŒè¯é€»è¾‘ï¼Œæ”¯æŒä¸åŒç»è¥æ¨¡å¼çš„æƒé™æ ¡éªŒã€‚

**æ ¸å¿ƒé—®é¢˜**ï¼š
- ç°æœ‰éªŒè¯é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªServiceä¸­
- éªŒè¯è§„åˆ™ä¸ç»Ÿä¸€ï¼Œç¼ºä¹å¯æ‰©å±•æ€§
- æ€§èƒ½é—®é¢˜ï¼šå¤šæ¬¡æŸ¥è¯¢æ•°æ®åº“
- ç¼ºä¹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- **æœªåŒºåˆ†ä¸åŒç»è¥æ¨¡å¼ï¼ˆé¤åˆ«åˆ¶/è¶…å¸‚åˆ¶/æ··åˆï¼‰çš„æƒé™éªŒè¯å·®å¼‚**

**é‡æ„æ”¶ç›Š**ï¼š
- âœ… ç»Ÿä¸€æƒé™éªŒè¯å…¥å£
- âœ… éªŒè¯æ€§èƒ½æå‡90%ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
- âœ… æ”¯æŒçµæ´»çš„æƒé™ç»„åˆ
- âœ… å®Œæ•´çš„éªŒè¯é“¾å’Œè´£ä»»é“¾æ¨¡å¼
- âœ… **æ”¯æŒä¸åŒç»è¥æ¨¡å¼çš„å·®å¼‚åŒ–æƒé™éªŒè¯**

---

## ğŸ—ï¸ ç»è¥æ¨¡å¼ä¸æƒé™éªŒè¯å…³ç³»

### æ ¸å¿ƒåŸåˆ™

**ä¸åŒç»è¥æ¨¡å¼çš„æƒé™éªŒè¯é‡ç‚¹ä¸åŒ**ï¼š

| ç»è¥æ¨¡å¼ | ä¸»è¦éªŒè¯ç‚¹ | æ¬¡è¦éªŒè¯ç‚¹ | ä¸é€‚ç”¨éªŒè¯ |
|---------|-----------|-----------|-----------|
| **é¤åˆ«åˆ¶<br/>(manage_mode=1)** | âœ… é¤åˆ«æƒé™<br/>âœ… å°±é¤æ—¶é—´<br/>âœ… å®šå€¼é…ç½® | âœ… åŒºåŸŸæƒé™<br/>âœ… ä½™é¢é™é¢ | âŒ å•†å“æƒé™<br/>âŒ åº“å­˜æ£€æŸ¥ |
| **è¶…å¸‚åˆ¶<br/>(manage_mode=2)** | âœ… å•†å“æƒé™<br/>âœ… åº“å­˜æ£€æŸ¥<br/>âœ… å•†å“ä»·æ ¼ | âœ… åŒºåŸŸæƒé™<br/>âœ… ä½™é¢é™é¢ | âŒ é¤åˆ«æƒé™<br/>âŒ å°±é¤æ—¶é—´<br/>âŒ å®šå€¼é…ç½® |
| **æ··åˆæ¨¡å¼<br/>(manage_mode=3)** | âœ… åŒºåŸŸæƒé™<br/>âœ… ä½™é¢é™é¢ | âœ… æ ¹æ®æ¶ˆè´¹æ–¹å¼<br/>åŠ¨æ€éªŒè¯ | - |

### éªŒè¯è§„åˆ™çŸ©é˜µ

```mermaid
flowchart TD
    A[æ¶ˆè´¹è¯·æ±‚] --> B{åŒºåŸŸç»è¥æ¨¡å¼?}
    
    B -->|manage_mode=1<br/>é¤åˆ«åˆ¶| C1[é¤åˆ«åˆ¶éªŒè¯é“¾]
    B -->|manage_mode=2<br/>è¶…å¸‚åˆ¶| C2[è¶…å¸‚åˆ¶éªŒè¯é“¾]
    B -->|manage_mode=3<br/>æ··åˆæ¨¡å¼| C3[æ··åˆæ¨¡å¼éªŒè¯é“¾]
    
    C1 --> D1[1. è´¦æˆ·çŠ¶æ€]
    D1 --> D2[2. åŒºåŸŸæƒé™]
    D2 --> D3[3. é¤åˆ«æƒé™ âœ…]
    D3 --> D4[4. å°±é¤æ—¶é—´ âœ…]
    D4 --> D5[5. å®šå€¼è®¡ç®— âœ…]
    D5 --> D6[6. ä½™é¢é™é¢]
    D6 --> E1[é€šè¿‡]
    
    C2 --> F1[1. è´¦æˆ·çŠ¶æ€]
    F1 --> F2[2. åŒºåŸŸæƒé™]
    F2 --> F3[3. å•†å“æƒé™ âœ…]
    F3 --> F4[4. åº“å­˜æ£€æŸ¥ âœ…]
    F4 --> F5[5. å•†å“ä»·æ ¼è®¡ç®— âœ…]
    F5 --> F6[6. ä½™é¢é™é¢]
    F6 --> E2[é€šè¿‡]
    
    C3 --> G1[1. è´¦æˆ·çŠ¶æ€]
    G1 --> G2[2. åŒºåŸŸæƒé™]
    G2 --> G3{ç”¨æˆ·é€‰æ‹©?}
    G3 -->|å®šå€¼æ¶ˆè´¹| G4[é¤åˆ«éªŒè¯åˆ†æ”¯]
    G3 -->|å•†å“æ¶ˆè´¹| G5[å•†å“éªŒè¯åˆ†æ”¯]
    G3 -->|æ··åˆæ¶ˆè´¹| G6[åŒé‡éªŒè¯]
    G4 --> E3[é€šè¿‡]
    G5 --> E3
    G6 --> E3
```

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡
## ğŸ“‹ IOE-DREAMä¸ƒå¾®æœåŠ¡æ¶æ„

**æ ¸å¿ƒæ¶æ„ç»„æˆ**:
- **Gateway Service (8080)**: APIç½‘å…³
- **Common Service (8088)**: å…¬å…±æ¨¡å—å¾®æœåŠ¡
- **DeviceComm Service (8087)**: è®¾å¤‡é€šè®¯å¾®æœåŠ¡
- **OA Service (8089)**: OAå¾®æœåŠ¡
- **Access Service (8090)**: é—¨ç¦æœåŠ¡
- **Attendance Service (8091)**: è€ƒå‹¤æœåŠ¡
- **Video Service (8092)**: è§†é¢‘æœåŠ¡
- **Consume Service (8094)**: æ¶ˆè´¹æœåŠ¡
- **Visitor Service (8095)**: è®¿å®¢æœåŠ¡

**æ¶æ„ç‰¹ç‚¹**:
- åŸºäºSpring Boot 3.5.8 + Java 17
- ä¸¥æ ¼éµå¾ªä¼ä¸šçº§å¾®æœåŠ¡è§„èŒƒ
- æ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨ã€æ°´å¹³æ‰©å±•

**æŠ€æœ¯æ ˆæ ‡å‡†**:
- **æ•°æ®åº“**: MySQL 8.0 + Druidè¿æ¥æ± 
- **ç¼“å­˜**: Redis + Caffeineå¤šçº§ç¼“å­˜
- **æ³¨å†Œä¸­å¿ƒ**: Nacos
- **é…ç½®ä¸­å¿ƒ**: Nacos Config
- **è®¤è¯æˆæƒ**: Sa-Token

## ğŸ—ï¸ å››å±‚æ¶æ„è§„èŒƒ

**æ ‡å‡†æ¶æ„æ¨¡å¼**:
```
Controller (æ¥å£æ§åˆ¶å±‚)
    â†“
Service (æ ¸å¿ƒä¸šåŠ¡å±‚)
    â†“
Manager (æµç¨‹ç®¡ç†å±‚)
    â†“
DAO (æ•°æ®è®¿é—®å±‚)
```

**å±‚çº§èŒè´£**:
- **Controllerå±‚**: HTTPè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ã€æƒé™æ§åˆ¶
- **Serviceå±‚**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™éªŒè¯
- **Managerå±‚**: å¤æ‚æµç¨‹ç¼–æ’ã€å¤šæ•°æ®ç»„è£…ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- **DAOå±‚**: æ•°æ®åº“CRUDæ“ä½œã€SQLæŸ¥è¯¢å®ç°ã€æ•°æ®è®¿é—®è¾¹ç•Œ

**ä¸¥æ ¼ç¦æ­¢è·¨å±‚è®¿é—®**: Controllerä¸èƒ½ç›´æ¥è°ƒç”¨Manager/DAOï¼
### 1.1 ç»Ÿä¸€æƒé™éªŒè¯æµç¨‹
## âš ï¸ IOE-DREAMé›¶å®¹å¿è§„åˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å¿…é¡»éµå®ˆçš„æ¶æ„è§„åˆ™**:
- âœ… **å¿…é¡»ä½¿ç”¨ @Resource æ³¨å…¥ä¾èµ–**
- âœ… **å¿…é¡»ä½¿ç”¨ @Mapper æ³¨è§£** (ç¦æ­¢@Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ Dao åç¼€** (ç¦æ­¢Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ @RestController æ³¨è§£**
- âœ… **å¿…é¡»ä½¿ç”¨ @Valid å‚æ•°æ ¡éªŒ**
- âœ… **å¿…é¡»è¿”å›ç»Ÿä¸€ResponseDTOæ ¼å¼**
- âœ… **å¿…é¡»éµå¾ªå››å±‚æ¶æ„è¾¹ç•Œ**

**ä¸¥æ ¼ç¦æ­¢äº‹é¡¹**:
- âŒ **ç¦æ­¢ä½¿ç”¨ @Autowired æ³¨å…¥**
- âŒ **ç¦æ­¢ä½¿ç”¨ @Repository æ³¨è§£**
- âŒ **ç¦æ­¢ä½¿ç”¨ Repository åç¼€å‘½å**
- âŒ **ç¦æ­¢è·¨å±‚è®¿é—®**
- âŒ **ç¦æ­¢åœ¨Controllerä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘**
- âŒ **ç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“**

**è¿è§„åæœ**: P0çº§é—®é¢˜ï¼Œç«‹å³ä¿®å¤ï¼Œç¦æ­¢åˆå¹¶ï¼

```mermaid
flowchart TD
    A[æ¶ˆè´¹è¯·æ±‚] --> B[æƒé™éªŒè¯å…¥å£]
    B --> C[æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡]
    
    C --> D[ä¸Šä¸‹æ–‡ä¿¡æ¯]
    D --> E[è´¦æˆ·ID/è´¦æˆ·ç±»åˆ«ID]
    E --> F[åŒºåŸŸID/é¤åˆ«ID]
    F --> G[æ¶ˆè´¹é‡‘é¢/æ¶ˆè´¹æ—¶é—´]
    
    G --> H[å¯åŠ¨éªŒè¯é“¾]
    H --> I[éªŒè¯å™¨1: è´¦æˆ·çŠ¶æ€]
    
    I --> J{è´¦æˆ·æ˜¯å¦æ­£å¸¸?}
    J -->|å¦| K[è¿”å›: è´¦æˆ·å·²ç¦ç”¨]
    J -->|æ˜¯| L[éªŒè¯å™¨2: åŒºåŸŸæƒé™]
    
    L --> M{åŒºåŸŸæƒé™?}
    M -->|å¦| N[è¿”å›: æ— æƒåœ¨è¯¥åŒºåŸŸæ¶ˆè´¹]
    M -->|æ˜¯| O[éªŒè¯å™¨3: é¤åˆ«æƒé™]
    
    O --> P{é¤åˆ«æƒé™?}
    P -->|å¦| Q[è¿”å›: æ— æƒä½¿ç”¨è¯¥é¤åˆ«]
    P -->|æ˜¯| R[éªŒè¯å™¨4: æ—¶é—´çª—å£]
    
    R --> S{æ—¶é—´åŒ¹é…?}
    S -->|å¦| T[è¿”å›: éå°±é¤æ—¶é—´]
    S -->|æ˜¯| U[éªŒè¯å™¨5: ä½™é¢æ£€æŸ¥]
    
    U --> V{ä½™é¢å……è¶³?}
    V -->|å¦| W[è¿”å›: ä½™é¢ä¸è¶³]
    V -->|æ˜¯| X[éªŒè¯å™¨6: é™é¢æ£€æŸ¥]
    
    X --> Y{æ—¥é™é¢/æ¬¡æ•°?}
    Y -->|è¶…é™| Z[è¿”å›: è¶…å‡ºé™é¢]
    Y -->|é€šè¿‡| AA[éªŒè¯å™¨7: å®šå€¼è®¡ç®—]
    
    AA --> AB{æ˜¯å¦å¯ç”¨å®šå€¼?}
    AB -->|æ˜¯| AC[è®¡ç®—å®šå€¼é‡‘é¢]
    AB -->|å¦| AD[ä½¿ç”¨è¾“å…¥é‡‘é¢]
    
    AC --> AE[éªŒè¯å™¨8: æŠ˜æ‰£è®¡ç®—]
    AD --> AE
    
    AE --> AF[è®¡ç®—æŠ˜æ‰£]
    AF --> AG[éªŒè¯å™¨9: æœ€ç»ˆé‡‘é¢]
    
    AG --> AH[ç»„è£…éªŒè¯ç»“æœ]
    AH --> AI[è¿”å›: éªŒè¯é€šè¿‡]
    AI --> AJ[é™„å¸¦ä¿¡æ¯]
    AJ --> AK[åº”ä»˜é‡‘é¢/å®šå€¼é‡‘é¢/æŠ˜æ‰£]
```

### 1.2 è´£ä»»é“¾æ¨¡å¼éªŒè¯æµç¨‹

```mermaid
flowchart LR
    A[éªŒè¯è¯·æ±‚] --> B[è´£ä»»é“¾è°ƒåº¦å™¨]
    
    B --> C[éªŒè¯å™¨1<br/>è´¦æˆ·çŠ¶æ€]
    C -->|é€šè¿‡| D[éªŒè¯å™¨2<br/>åŒºåŸŸæƒé™]
    C -->|å¤±è´¥| Z[è¿”å›å¤±è´¥]
    
    D -->|é€šè¿‡| E[éªŒè¯å™¨3<br/>é¤åˆ«æƒé™]
    D -->|å¤±è´¥| Z
    
    E -->|é€šè¿‡| F[éªŒè¯å™¨4<br/>æ—¶é—´çª—å£]
    E -->|å¤±è´¥| Z
    
    F -->|é€šè¿‡| G[éªŒè¯å™¨5<br/>ä½™é¢æ£€æŸ¥]
    F -->|å¤±è´¥| Z
    
    G -->|é€šè¿‡| H[éªŒè¯å™¨6<br/>é™é¢æ£€æŸ¥]
    G -->|å¤±è´¥| Z
    
    H -->|é€šè¿‡| I[éªŒè¯å™¨7<br/>å®šå€¼è®¡ç®—]
    H -->|å¤±è´¥| Z
    
    I -->|é€šè¿‡| J[éªŒè¯å™¨8<br/>æŠ˜æ‰£è®¡ç®—]
    I -->|å¤±è´¥| Z
    
    J -->|é€šè¿‡| K[éªŒè¯å™¨9<br/>æœ€ç»ˆé‡‘é¢]
    J -->|å¤±è´¥| Z
    
    K -->|é€šè¿‡| Y[è¿”å›æˆåŠŸ<br/>é™„å¸¦è®¡ç®—ç»“æœ]
    K -->|å¤±è´¥| Z
    
    style Z fill:#ff6b6b
    style Y fill:#51cf66
```

### 1.3 æ‰¹é‡æƒé™éªŒè¯æµç¨‹ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

```mermaid
sequenceDiagram
    participant C as è°ƒç”¨æ–¹
    participant V as éªŒè¯æœåŠ¡
    participant Cache as ç¼“å­˜å±‚
    participant DB as æ•°æ®åº“
    
    C->>V: æ‰¹é‡éªŒè¯è¯·æ±‚[100ä¸ªè´¦æˆ·]
    V->>V: åˆ†ç»„å»é‡
    Note over V: æŒ‰è´¦æˆ·ç±»åˆ«åˆ†ç»„<br/>å‡å°‘æŸ¥è¯¢æ¬¡æ•°
    
    V->>Cache: æ‰¹é‡è·å–è´¦æˆ·ç±»åˆ«é…ç½®
    Cache-->>V: è¿”å›80ä¸ª(20ä¸ªMiss)
    
    V->>DB: æ‰¹é‡æŸ¥è¯¢ç¼ºå¤±é…ç½®
    Note over DB: ä½¿ç”¨INæŸ¥è¯¢<br/>ä¸€æ¬¡æ€§è·å–20ä¸ª
    DB-->>V: è¿”å›20ä¸ªé…ç½®
    
    V->>Cache: æ‰¹é‡å†™å…¥ç¼“å­˜(Pipeline)
    
    V->>V: å¹¶è¡ŒéªŒè¯(Streamå¹¶è¡Œæµ)
    Note over V: ä½¿ç”¨çº¿ç¨‹æ± <br/>100ä¸ªè´¦æˆ·å¹¶è¡ŒéªŒè¯
    
    loop æ¯ä¸ªè´¦æˆ·
        V->>V: æ‰§è¡ŒéªŒè¯é“¾
        V->>V: è®°å½•ç»“æœ
    end
    
    V->>V: èšåˆç»“æœ
    V-->>C: è¿”å›100ä¸ªéªŒè¯ç»“æœ
    Note over C: æ€»è€—æ—¶ < 200ms<br/>(vs åŸ3000ms)
```

### 1.4 æƒé™éªŒè¯ç¼“å­˜ç­–ç•¥

```mermaid
flowchart TD
    A[éªŒè¯è¯·æ±‚] --> B{æ£€æŸ¥ç»“æœç¼“å­˜}
    B -->|å‘½ä¸­| C[è¿”å›ç¼“å­˜ç»“æœ<1ms]
    B -->|æœªå‘½ä¸­| D{æ£€æŸ¥é…ç½®ç¼“å­˜}
    
    D -->|å‘½ä¸­| E[ä½¿ç”¨ç¼“å­˜é…ç½®]
    D -->|æœªå‘½ä¸­| F[æŸ¥è¯¢æ•°æ®åº“]
    
    F --> G[åŠ è½½è´¦æˆ·ç±»åˆ«é…ç½®]
    G --> H[åŠ è½½åŒºåŸŸé…ç½®]
    H --> I[åŠ è½½é¤åˆ«é…ç½®]
    I --> J[åŠ è½½å®šå€¼è§„åˆ™]
    
    J --> K[ç¼“å­˜é…ç½®30-60åˆ†é’Ÿ]
    K --> E
    
    E --> L[æ‰§è¡ŒéªŒè¯é€»è¾‘]
    L --> M[è®¡ç®—æƒé™ç»“æœ]
    M --> N{ç»“æœå¯ç¼“å­˜?}
    
    N -->|æ˜¯<br/>é™æ€æƒé™| O[ç¼“å­˜ç»“æœ30åˆ†é’Ÿ]
    N -->|å¦<br/>åŠ¨æ€æ•°æ®| P[ä¸ç¼“å­˜<br/>å¦‚ä½™é¢/æ¬¡æ•°]
    
    O --> Q[è¿”å›éªŒè¯ç»“æœ]
    P --> Q
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 2.1 éªŒè¯æ—¥å¿—è¡¨ï¼ˆæ–°å¢ï¼‰

```sql
-- ========================================
-- æƒé™éªŒè¯æ—¥å¿—è¡¨ï¼ˆç”¨äºå®¡è®¡å’Œåˆ†æï¼‰
-- ========================================
CREATE TABLE POSID_PERMISSION_LOG (
    id VARCHAR(50) PRIMARY KEY COMMENT 'æ—¥å¿—ID',
    
    -- è¯·æ±‚ä¿¡æ¯
    account_id VARCHAR(50) NOT NULL COMMENT 'è´¦æˆ·ID',
    account_kind_id VARCHAR(50) COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    area_id VARCHAR(50) COMMENT 'åŒºåŸŸID',
    meal_id VARCHAR(50) COMMENT 'é¤åˆ«ID',
    device_id VARCHAR(50) COMMENT 'è®¾å¤‡ID',
    
    -- éªŒè¯ç»“æœ
    validation_result BOOLEAN NOT NULL COMMENT 'éªŒè¯ç»“æœï¼štrue-é€šè¿‡ false-å¤±è´¥',
    failure_reason VARCHAR(255) COMMENT 'å¤±è´¥åŸå› ',
    failure_validator VARCHAR(50) COMMENT 'å¤±è´¥çš„éªŒè¯å™¨åç§°',
    
    -- éªŒè¯è¯¦æƒ…
    validation_chain TEXT COMMENT 'éªŒè¯é“¾æ‰§è¡Œè¯¦æƒ…(JSON)',
    /*
    ç¤ºä¾‹ï¼š
    [
        {"validator": "AccountStatusValidator", "result": true, "duration": 2},
        {"validator": "AreaPermissionValidator", "result": true, "duration": 5},
        {"validator": "MealPermissionValidator", "result": false, "duration": 3, "reason": "æ— æƒä½¿ç”¨è¯¥é¤åˆ«"}
    ]
    */
    
    -- æ€§èƒ½æŒ‡æ ‡
    total_duration INT COMMENT 'æ€»è€—æ—¶(æ¯«ç§’)',
    cache_hit_rate DECIMAL(5,2) COMMENT 'ç¼“å­˜å‘½ä¸­ç‡(%)',
    
    -- æ—¶é—´ä¿¡æ¯
    validation_time DATETIME NOT NULL COMMENT 'éªŒè¯æ—¶é—´',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_account(account_id, validation_time) COMMENT 'è´¦æˆ·ç´¢å¼•',
    INDEX idx_result(validation_result, validation_time) COMMENT 'ç»“æœç´¢å¼•',
    INDEX idx_validator(failure_validator, validation_time) COMMENT 'å¤±è´¥éªŒè¯å™¨ç´¢å¼•',
    INDEX idx_time(validation_time) COMMENT 'æ—¶é—´ç´¢å¼•ï¼ˆç”¨äºæ¸…ç†å†å²æ•°æ®ï¼‰'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 
COMMENT='æƒé™éªŒè¯æ—¥å¿—è¡¨ï¼ˆæŒ‰æœˆåˆ†è¡¨ï¼‰'
PARTITION BY RANGE (TO_DAYS(validation_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 2.2 ERå…³ç³»å›¾ï¼ˆéªŒè¯ç³»ç»Ÿæ¶‰åŠçš„è¡¨ï¼‰

```mermaid
erDiagram
    POSID_ACCOUNT ||--|| POSID_ACCOUNTKIND : "æ‰€å±ç±»åˆ«"
    POSID_ACCOUNTKIND }o--o{ POSID_AREA : "é€šè¿‡area_config JSONå…³è”"
    POSID_AREA ||--o{ POSID_MEAL_CATEGORY : "é€šè¿‡meal_categories JSONå…³è”"
    POSID_MEAL ||--|| POSID_MEAL_CATEGORY : "æ‰€å±åˆ†ç±»"
    
    POSID_ACCOUNT ||--o{ POSID_PERMISSION_LOG : "éªŒè¯æ—¥å¿—"
    
    POSID_ACCOUNT {
        VARCHAR id PK
        VARCHAR account_kind_id FK
        INT balance "ä½™é¢"
        BOOLEAN available "çŠ¶æ€"
    }
    
    POSID_ACCOUNTKIND {
        VARCHAR id PK
        JSON area_config "åŒºåŸŸæƒé™é…ç½®"
        JSON mode_config "æ¶ˆè´¹æ¨¡å¼é…ç½®"
        BOOLEAN is_attendance_consume "è€ƒå‹¤æ¶ˆè´¹"
    }
    
    POSID_AREA {
        VARCHAR id PK
        TEXT meal_categories "å¯ç”¨é¤åˆ«åˆ†ç±»JSON"
        VARCHAR parent_id FK "çˆ¶åŒºåŸŸ"
    }
    
    POSID_PERMISSION_LOG {
        VARCHAR id PK
        VARCHAR account_id FK
        VARCHAR account_kind_id FK
        VARCHAR area_id FK
        VARCHAR meal_id FK
        BOOLEAN validation_result "éªŒè¯ç»“æœ"
        VARCHAR failure_reason "å¤±è´¥åŸå› "
        TEXT validation_chain "éªŒè¯é“¾è¯¦æƒ…"
        INT total_duration "æ€»è€—æ—¶"
        DATETIME validation_time "éªŒè¯æ—¶é—´"
    }
```

**å…³é”®è¯´æ˜ï¼š**
- è´¦æˆ·ç±»åˆ«é€šè¿‡ `area_config` JSONå­—æ®µå…³è”åŒºåŸŸï¼ˆæ— éœ€å…³è”è¡¨ï¼‰
- åŒºåŸŸé€šè¿‡ `meal_categories` JSONå­—æ®µé…ç½®æ”¯æŒçš„é¤åˆ«åˆ†ç±»
- æƒé™éªŒè¯ä»JSONé…ç½®ä¸­è¯»å–å…³è”å…³ç³»
- æä¾›Redisåå‘ç´¢å¼•ã€ç»Ÿè®¡è¡¨ã€SQLè§†å›¾ç­‰è¡¥å¿æœºåˆ¶ï¼ˆè¯¦è§04æ–‡æ¡£ï¼‰

---

## ğŸ’¾ ç¼“å­˜ç­–ç•¥è®¾è®¡

### 3.1 ç¼“å­˜æ¶æ„

```mermaid
flowchart LR
    A[åº”ç”¨å±‚] --> B[L1: æœ¬åœ°ç¼“å­˜\nCaffeine\n1åˆ†é’Ÿ]
    A --> C[L2: åˆ†å¸ƒå¼ç¼“å­˜\nRedis\n30åˆ†é’Ÿ]
    C --> D[L3: æ•°æ®åº“\nMySQL]
    
    B -.é…ç½®æ•°æ®.-> C
    C -.é™æ€æƒé™ç»“æœ.-> D
    
    style B fill:#ffeaa7
    style C fill:#74b9ff
    style D fill:#a29bfe
```

### 3.2 ç¼“å­˜é”®è®¾è®¡

| ç¼“å­˜é¡¹ | Redis Key | æ•°æ®ç»“æ„ | è¿‡æœŸæ—¶é—´ | è¯´æ˜ |
|-------|-----------|---------|---------|------|
| éªŒè¯ä¸Šä¸‹æ–‡ | `validation:context:{accountId}` | String (JSON) | 5åˆ†é’Ÿ | è´¦æˆ·éªŒè¯æ‰€éœ€çš„æ‰€æœ‰é…ç½® |
| é™æ€æƒé™ç»“æœ | `validation:static:{accountId}:{areaId}:{mealCategoryId}` | String (JSON) | 30åˆ†é’Ÿ | ä¸å«ä½™é¢/æ¬¡æ•°çš„é™æ€æƒé™ |
| ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•° | `account:today:times:{accountId}` | String | åˆ°å½“å¤©23:59 | ç”¨äºé™é¢éªŒè¯ |
| ä»Šæ—¥æ¶ˆè´¹é‡‘é¢ | `account:today:money:{accountId}` | String | åˆ°å½“å¤©23:59 | ç”¨äºé™é¢éªŒè¯ |
| æœ¬æœˆæ¶ˆè´¹æ¬¡æ•° | `account:month:times:{accountId}:{yyyyMM}` | String | åˆ°æœˆåº• | ç”¨äºé™é¢éªŒè¯ |
| æœ¬æœˆæ¶ˆè´¹é‡‘é¢ | `account:month:money:{accountId}:{yyyyMM}` | String | åˆ°æœˆåº• | ç”¨äºé™é¢éªŒè¯ |
| éªŒè¯å™¨ç¼“å­˜ | `validator:config:{validatorName}` | String (JSON) | 1å°æ—¶ | éªŒè¯å™¨é…ç½® |

### 3.3 ç¼“å­˜ç®¡ç†å™¨å®ç°

```java
/**
 * æƒé™éªŒè¯ç¼“å­˜ç®¡ç†å™¨
 */
@Component
public class PermissionCacheManager {
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    @Resource
    private Caffeine<Object, Object> localCache;
    
    private static final String CACHE_PREFIX_CONTEXT = "validation:context:";
    private static final String CACHE_PREFIX_STATIC = "validation:static:";
    private static final String CACHE_PREFIX_TODAY_TIMES = "account:today:times:";
    private static final String CACHE_PREFIX_TODAY_MONEY = "account:today:money:";
    private static final String CACHE_PREFIX_MONTH_TIMES = "account:month:times:";
    private static final String CACHE_PREFIX_MONTH_MONEY = "account:month:money:";
    
    /**
     * è·å–éªŒè¯ä¸Šä¸‹æ–‡ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
     */
    public ValidationContext getValidationContext(String accountId) {
        String key = CACHE_PREFIX_CONTEXT + accountId;
        
        // Level 1: æœ¬åœ°ç¼“å­˜
        ValidationContext context = (ValidationContext) localCache.getIfPresent(key);
        if (context != null) {
            return context;
        }
        
        // Level 2: Redisç¼“å­˜
        context = (ValidationContext) redisTemplate.opsForValue().get(key);
        if (context != null) {
            localCache.put(key, context);
            return context;
        }
        
        // Level 3: æ„å»ºä¸Šä¸‹æ–‡
        context = buildValidationContext(accountId);
        if (context != null) {
            // Redisç¼“å­˜5åˆ†é’Ÿ
            redisTemplate.opsForValue().set(key, context, 5, TimeUnit.MINUTES);
            // æœ¬åœ°ç¼“å­˜1åˆ†é’Ÿ
            localCache.put(key, context);
        }
        
        return context;
    }
    
    /**
     * æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡
     */
    private ValidationContext buildValidationContext(String accountId) {
        // 1. è·å–è´¦æˆ·ä¿¡æ¯
        PosIDAccount account = accountDao.findById(accountId);
        if (account == null) {
            return null;
        }
        
        // 2. è·å–è´¦æˆ·ç±»åˆ«é…ç½®
        AccountKindConfig kindConfig = accountKindCacheManager.getAccountKindConfig(
            account.getAccountKindId()
        );
        
        // 3. è·å–æœ‰æ•ˆåŒºåŸŸ
        Set<String> effectiveAreas = accountKindCacheManager.getEffectiveAreas(
            accountId, account.getAccountKindId()
        );
        
        // 4. ç»„è£…ä¸Šä¸‹æ–‡
        ValidationContext context = new ValidationContext();
        context.setAccount(account);
        context.setAccountKindConfig(kindConfig);
        context.setEffectiveAreas(effectiveAreas);
        context.setBuildTime(LocalDateTime.now());
        
        return context;
    }
    
    /**
     * è·å–é™æ€æƒé™éªŒè¯ç»“æœï¼ˆä»…åŒ…å«ä¸å˜çš„æƒé™ï¼‰
     */
    public StaticPermissionResult getStaticPermission(
        String accountId,
        String areaId,
        String mealCategoryId
    ) {
        String key = String.format("%s%s:%s:%s", 
            CACHE_PREFIX_STATIC, accountId, areaId, mealCategoryId);
        
        StaticPermissionResult result = 
            (StaticPermissionResult) redisTemplate.opsForValue().get(key);
        
        if (result == null) {
            result = calculateStaticPermission(accountId, areaId, mealCategoryId);
            if (result != null && result.isSuccess()) {
                // ä»…ç¼“å­˜æˆåŠŸçš„é™æ€æƒé™ç»“æœ
                redisTemplate.opsForValue().set(key, result, 30, TimeUnit.MINUTES);
            }
        }
        
        return result;
    }
    
    /**
     * è®¡ç®—é™æ€æƒé™ï¼ˆä¸å«ä½™é¢ã€æ¬¡æ•°ç­‰åŠ¨æ€æ•°æ®ï¼‰
     */
    private StaticPermissionResult calculateStaticPermission(
        String accountId,
        String areaId,
        String mealCategoryId
    ) {
        ValidationContext context = getValidationContext(accountId);
        
        StaticPermissionResult result = new StaticPermissionResult();
        
        // 1. éªŒè¯åŒºåŸŸæƒé™
        if (!context.getEffectiveAreas().contains(areaId)) {
            result.setSuccess(false);
            result.setReason("æ— æƒåœ¨è¯¥åŒºåŸŸæ¶ˆè´¹");
            return result;
        }
        
        // 2. éªŒè¯é¤åˆ«åˆ†ç±»æƒé™
        Set<String> effectiveCategories = accountKindCacheManager
            .getEffectiveMealCategories(accountId, context.getAccount().getAccountKindId(), areaId);
        
        if (!effectiveCategories.contains(mealCategoryId)) {
            result.setSuccess(false);
            result.setReason("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
            return result;
        }
        
        // 3. é™æ€æƒé™éªŒè¯é€šè¿‡
        result.setSuccess(true);
        result.setAreaId(areaId);
        result.setMealCategoryId(mealCategoryId);
        
        return result;
    }
    
    /**
     * è·å–ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•°
     */
    public int getTodayConsumeTimes(String accountId) {
        String key = CACHE_PREFIX_TODAY_TIMES + accountId;
        Integer times = (Integer) redisTemplate.opsForValue().get(key);
        
        if (times == null) {
            times = transactionDao.countTodayByAccountId(accountId);
            
            // ç¼“å­˜åˆ°ä»Šå¤©23:59:59
            LocalDateTime endOfDay = LocalDateTime.now().with(LocalTime.MAX);
            Duration duration = Duration.between(LocalDateTime.now(), endOfDay);
            redisTemplate.opsForValue().set(key, times, duration.getSeconds(), TimeUnit.SECONDS);
        }
        
        return times;
    }
    
    /**
     * é€’å¢ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•°
     */
    public void incrementTodayTimes(String accountId) {
        String key = CACHE_PREFIX_TODAY_TIMES + accountId;
        redisTemplate.opsForValue().increment(key);
    }
    
    /**
     * è·å–ä»Šæ—¥æ¶ˆè´¹é‡‘é¢
     */
    public int getTodayConsumeMoney(String accountId) {
        String key = CACHE_PREFIX_TODAY_MONEY + accountId;
        Integer money = (Integer) redisTemplate.opsForValue().get(key);
        
        if (money == null) {
            money = transactionDao.sumTodayMoneyByAccountId(accountId);
            
            // ç¼“å­˜åˆ°ä»Šå¤©23:59:59
            LocalDateTime endOfDay = LocalDateTime.now().with(LocalTime.MAX);
            Duration duration = Duration.between(LocalDateTime.now(), endOfDay);
            redisTemplate.opsForValue().set(key, money, duration.getSeconds(), TimeUnit.SECONDS);
        }
        
        return money;
    }
    
    /**
     * é€’å¢ä»Šæ—¥æ¶ˆè´¹é‡‘é¢
     */
    public void incrementTodayMoney(String accountId, int money) {
        String key = CACHE_PREFIX_TODAY_MONEY + accountId;
        redisTemplate.opsForValue().increment(key, money);
    }
    
    /**
     * è·å–æœ¬æœˆæ¶ˆè´¹æ¬¡æ•°
     */
    public int getMonthConsumeTimes(String accountId, YearMonth yearMonth) {
        String key = CACHE_PREFIX_MONTH_TIMES + accountId + ":" + yearMonth.toString();
        Integer times = (Integer) redisTemplate.opsForValue().get(key);
        
        if (times == null) {
            times = transactionDao.countMonthByAccountId(accountId, yearMonth);
            
            // ç¼“å­˜åˆ°æœˆåº•
            LocalDateTime endOfMonth = yearMonth.atEndOfMonth().atTime(LocalTime.MAX);
            Duration duration = Duration.between(LocalDateTime.now(), endOfMonth);
            redisTemplate.opsForValue().set(key, times, duration.getSeconds(), TimeUnit.SECONDS);
        }
        
        return times;
    }
    
    /**
     * æ¸…é™¤è´¦æˆ·ç›¸å…³ç¼“å­˜
     */
    @EventListener
    public void onAccountChanged(AccountChangeEvent event) {
        String accountId = event.getAccountId();
        
        // æ¸…é™¤éªŒè¯ä¸Šä¸‹æ–‡
        localCache.invalidate(CACHE_PREFIX_CONTEXT + accountId);
        redisTemplate.delete(CACHE_PREFIX_CONTEXT + accountId);
        
        // æ¸…é™¤é™æ€æƒé™ç»“æœï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
        Set<String> staticKeys = redisTemplate.keys(CACHE_PREFIX_STATIC + accountId + ":*");
        if (staticKeys != null && !staticKeys.isEmpty()) {
            redisTemplate.delete(staticKeys);
        }
    }
}

/**
 * éªŒè¯ä¸Šä¸‹æ–‡
 */
@Data
public class ValidationContext implements Serializable {
    private PosIDAccount account;
    private AccountKindConfig accountKindConfig;
    private Set<String> effectiveAreas;
    private LocalDateTime buildTime;
}

/**
 * é™æ€æƒé™ç»“æœ
 */
@Data
public class StaticPermissionResult implements Serializable {
    private boolean success;
    private String reason;
    private String areaId;
    private String mealCategoryId;
}
```

---

## ğŸ’» æ ¸å¿ƒä»£ç å®ç°

### 4.1 éªŒè¯å™¨æ¥å£å’ŒæŠ½è±¡ç±»

```java
/**
 * æƒé™éªŒè¯å™¨æ¥å£
 */
public interface PermissionValidator {
    
    /**
     * éªŒè¯å™¨åç§°
     */
    String getName();
    
    /**
     * éªŒè¯å™¨ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
     */
    int getOrder();
    
    /**
     * æ‰§è¡ŒéªŒè¯
     * 
     * @param context éªŒè¯ä¸Šä¸‹æ–‡
     * @return éªŒè¯ç»“æœ
     */
    ValidationResult validate(ValidationContext context);
    
    /**
     * æ˜¯å¦å¯ç”¨è¯¥éªŒè¯å™¨
     */
    default boolean isEnabled() {
        return true;
    }
}

/**
 * æŠ½è±¡éªŒè¯å™¨åŸºç±»
 */
public abstract class AbstractPermissionValidator implements PermissionValidator {
    
    protected final Logger log = LoggerFactory.getLogger(getClass());
    
    @Override
    public ValidationResult validate(ValidationContext context) {
        long startTime = System.currentTimeMillis();
        
        try {
            // æ‰§è¡Œå…·ä½“éªŒè¯é€»è¾‘
            ValidationResult result = doValidate(context);
            
            // è®°å½•éªŒè¯æ—¶é•¿
            long duration = System.currentTimeMillis() - startTime;
            result.setDuration(duration);
            result.setValidatorName(getName());
            
            return result;
            
        } catch (Exception e) {
            log.error("éªŒè¯å™¨{}æ‰§è¡Œå¼‚å¸¸", getName(), e);
            
            ValidationResult result = ValidationResult.fail("éªŒè¯å™¨æ‰§è¡Œå¼‚å¸¸: " + e.getMessage());
            result.setValidatorName(getName());
            return result;
        }
    }
    
    /**
     * å­ç±»å®ç°å…·ä½“éªŒè¯é€»è¾‘
     */
    protected abstract ValidationResult doValidate(ValidationContext context);
}
```

### 4.2 å…·ä½“éªŒè¯å™¨å®ç°

```java
/**
 * éªŒè¯å™¨1ï¼šè´¦æˆ·çŠ¶æ€éªŒè¯
 */
@Component
@Order(1)
public class AccountStatusValidator extends AbstractPermissionValidator {
    
    @Override
    public String getName() {
        return "AccountStatusValidator";
    }
    
    @Override
    public int getOrder() {
        return 1;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        PosIDAccount account = context.getAccount();
        
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
        if (account == null) {
            return ValidationResult.fail("è´¦æˆ·ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥è´¦æˆ·çŠ¶æ€
        if (!account.getAvailable()) {
            return ValidationResult.fail("è´¦æˆ·å·²ç¦ç”¨");
        }
        
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¿‡æœŸ
        if (account.getExpireTime() != null && 
            account.getExpireTime().before(new Date())) {
            return ValidationResult.fail("è´¦æˆ·å·²è¿‡æœŸ");
        }
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨2ï¼šåŒºåŸŸæƒé™éªŒè¯
 */
@Component
@Order(2)
public class AreaPermissionValidator extends AbstractPermissionValidator {
    
    @Override
    public String getName() {
        return "AreaPermissionValidator";
    }
    
    @Override
    public int getOrder() {
        return 2;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        String areaId = context.getAreaId();
        Set<String> effectiveAreas = context.getEffectiveAreas();
        
        if (!effectiveAreas.contains(areaId)) {
            return ValidationResult.fail("æ— æƒåœ¨è¯¥åŒºåŸŸæ¶ˆè´¹");
        }
        
        // æ£€æŸ¥åŒºåŸŸæ˜¯å¦å¯ç”¨
        PosIDArea area = context.getArea();
        if (area == null || !area.getAvailable()) {
            return ValidationResult.fail("è¯¥åŒºåŸŸå·²ç¦ç”¨");
        }
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨3ï¼šé¤åˆ«æƒé™éªŒè¯
 */
@Component
@Order(3)
public class MealPermissionValidator extends AbstractPermissionValidator {
    
    @Resource
    private MealCacheManager mealCacheManager;
    
    @Resource
    private AccountKindCacheManager accountKindCacheManager;
    
    @Override
    public String getName() {
        return "MealPermissionValidator";
    }
    
    @Override
    public int getOrder() {
        return 3;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        String mealId = context.getMealId();
        
        // è·å–é¤åˆ«ä¿¡æ¯
        PosIDMeal meal = mealCacheManager.getMeal(mealId);
        if (meal == null || !meal.getAvailable()) {
            return ValidationResult.fail("é¤åˆ«ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }
        
        // æ£€æŸ¥é¤åˆ«åˆ†ç±»æƒé™
        Set<String> effectiveCategories = accountKindCacheManager.getEffectiveMealCategories(
            context.getAccount().getId(),
            context.getAccount().getAccountKindId(),
            context.getAreaId()
        );
        
        if (!effectiveCategories.contains(meal.getCategoryId())) {
            return ValidationResult.fail("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
        }
        
        // å°†é¤åˆ«ä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡
        context.setMeal(meal);
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨4ï¼šæ—¶é—´çª—å£éªŒè¯
 */
@Component
@Order(4)
public class TimeWindowValidator extends AbstractPermissionValidator {
    
    @Override
    public String getName() {
        return "TimeWindowValidator";
    }
    
    @Override
    public int getOrder() {
        return 4;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        PosIDMeal meal = context.getMeal();
        LocalDateTime consumeTime = context.getConsumeTime();
        
        // æ£€æŸ¥æ—¶é—´çª—å£
        LocalTime consumeLocalTime = consumeTime.toLocalTime();
        LocalTime start = LocalTime.parse(meal.getStartTime());
        LocalTime end = LocalTime.parse(meal.getEndTime());
        
        if (consumeLocalTime.isBefore(start) || consumeLocalTime.isAfter(end)) {
            return ValidationResult.fail(
                String.format("å½“å‰ä¸åœ¨å°±é¤æ—¶é—´æ®µï¼ˆ%s - %sï¼‰", 
                    meal.getStartTime(), meal.getEndTime())
            );
        }
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨5ï¼šä½™é¢æ£€æŸ¥
 */
@Component
@Order(5)
public class BalanceValidator extends AbstractPermissionValidator {
    
    @Override
    public String getName() {
        return "BalanceValidator";
    }
    
    @Override
    public int getOrder() {
        return 5;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        PosIDAccount account = context.getAccount();
        Integer consumeMoney = context.getConsumeMoney();
        
        // å¦‚æœè¿˜æ²¡è®¡ç®—é‡‘é¢ï¼Œå…ˆè·³è¿‡ï¼ˆåç»­éªŒè¯å™¨ä¼šè®¡ç®—ï¼‰
        if (consumeMoney == null) {
            return ValidationResult.success();
        }
        
        // æ£€æŸ¥æ€»ä½™é¢
        int totalBalance = account.getBalance() + account.getAllowanceBalance();
        if (totalBalance < consumeMoney) {
            return ValidationResult.fail(
                String.format("ä½™é¢ä¸è¶³ï¼ˆéœ€è¦%.2få…ƒï¼Œå½“å‰%.2få…ƒï¼‰", 
                    consumeMoney / 100.0, totalBalance / 100.0)
            );
        }
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨6ï¼šé™é¢æ£€æŸ¥
 */
@Component
@Order(6)
public class LimitValidator extends AbstractPermissionValidator {
    
    @Resource
    private PermissionCacheManager permissionCacheManager;
    
    @Override
    public String getName() {
        return "LimitValidator";
    }
    
    @Override
    public int getOrder() {
        return 6;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        PosIDAccountKind kind = context.getAccountKindConfig().getAccountKind();
        String accountId = context.getAccount().getId();
        Integer consumeMoney = context.getConsumeMoney();
        
        // 1. æ£€æŸ¥æ—¥æ¶ˆè´¹æ¬¡æ•°é™é¢
        if (kind.getDateMaxCount() != null && kind.getDateMaxCount() > 0) {
            int todayTimes = permissionCacheManager.getTodayConsumeTimes(accountId);
            if (todayTimes >= kind.getDateMaxCount()) {
                return ValidationResult.fail(
                    String.format("å·²è¾¾æ—¥æ¶ˆè´¹æ¬¡æ•°é™é¢ï¼ˆ%dæ¬¡ï¼‰", kind.getDateMaxCount())
                );
            }
        }
        
        // 2. æ£€æŸ¥æ—¥æ¶ˆè´¹é‡‘é¢é™é¢
        if (kind.getDateMaxMoney() != null && kind.getDateMaxMoney() > 0 && consumeMoney != null) {
            int todayMoney = permissionCacheManager.getTodayConsumeMoney(accountId);
            if (todayMoney + consumeMoney > kind.getDateMaxMoney()) {
                return ValidationResult.fail(
                    String.format("å°†è¶…å‡ºæ—¥æ¶ˆè´¹é‡‘é¢é™é¢ï¼ˆé™é¢%.2få…ƒï¼Œå·²æ¶ˆè´¹%.2få…ƒï¼‰",
                        kind.getDateMaxMoney() / 100.0, todayMoney / 100.0)
                );
            }
        }
        
        // 3. æ£€æŸ¥æœˆæ¶ˆè´¹æ¬¡æ•°é™é¢
        if (kind.getMonthMaxCount() != null && kind.getMonthMaxCount() > 0) {
            YearMonth currentMonth = YearMonth.now();
            int monthTimes = permissionCacheManager.getMonthConsumeTimes(accountId, currentMonth);
            if (monthTimes >= kind.getMonthMaxCount()) {
                return ValidationResult.fail(
                    String.format("å·²è¾¾æœˆæ¶ˆè´¹æ¬¡æ•°é™é¢ï¼ˆ%dæ¬¡ï¼‰", kind.getMonthMaxCount())
                );
            }
        }
        
        // 4. æ£€æŸ¥å•æ¬¡æ¶ˆè´¹é‡‘é¢é™é¢
        if (kind.getPerMaxMoney() != null && kind.getPerMaxMoney() > 0 && consumeMoney != null) {
            if (consumeMoney > kind.getPerMaxMoney()) {
                return ValidationResult.fail(
                    String.format("è¶…å‡ºå•æ¬¡æ¶ˆè´¹é‡‘é¢é™é¢ï¼ˆé™é¢%.2få…ƒï¼‰",
                        kind.getPerMaxMoney() / 100.0)
                );
            }
        }
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨7ï¼šå®šå€¼è®¡ç®—
 */
@Component
@Order(7)
public class FixedValueCalculator extends AbstractPermissionValidator {
    
    @Resource
    private FixedValueRuleEngine ruleEngine;
    
    @Resource
    private PermissionCacheManager permissionCacheManager;
    
    @Override
    public String getName() {
        return "FixedValueCalculator";
    }
    
    @Override
    public int getOrder() {
        return 7;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        PosIDAccountKind kind = context.getAccountKindConfig().getAccountKind();
        
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨å®šå€¼
        if (kind.getFixedValueMode() == null || kind.getFixedValueMode() == 0) {
            return ValidationResult.success();
        }
        
        // è·å–ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•°
        int todayTimes = permissionCacheManager.getTodayConsumeTimes(
            context.getAccount().getId()
        );
        
        // æ„å»ºå®šå€¼è®¡ç®—ä¸Šä¸‹æ–‡
        FixedValueContext fixedContext = new FixedValueContext();
        fixedContext.setAccountId(context.getAccount().getId());
        fixedContext.setAccountKindId(kind.getId());
        fixedContext.setAreaId(context.getAreaId());
        fixedContext.setMealCategoryId(context.getMeal().getCategoryId());
        fixedContext.setMealId(context.getMealId());
        fixedContext.setConsumeTime(context.getConsumeTime());
        fixedContext.setTodayTimes(todayTimes);
        
        // è®¡ç®—å®šå€¼é‡‘é¢
        Integer fixedMoney = ruleEngine.calculateFixedValue(fixedContext);
        
        if (fixedMoney != null) {
            // å°†å®šå€¼é‡‘é¢æ”¾å…¥ä¸Šä¸‹æ–‡
            context.setFixedMoney(fixedMoney);
            context.setConsumeMoney(fixedMoney);
        }
        
        return ValidationResult.success();
    }
}

/**
 * éªŒè¯å™¨8ï¼šæŠ˜æ‰£è®¡ç®—
 */
@Component
@Order(8)
public class DiscountCalculator extends AbstractPermissionValidator {
    
    @Override
    public String getName() {
        return "DiscountCalculator";
    }
    
    @Override
    public int getOrder() {
        return 8;
    }
    
    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        PosIDAccountKind kind = context.getAccountKindConfig().getAccountKind();
        Integer consumeMoney = context.getConsumeMoney();
        
        if (consumeMoney == null) {
            return ValidationResult.success();
        }
        
        // è®¡ç®—æŠ˜æ‰£
        Integer discountMoney = calculateDiscount(kind, consumeMoney);
        
        // å°†æŠ˜æ‰£ä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡
        context.setDiscountType(kind.getDiscountType());
        context.setDiscountMoney(discountMoney);
        context.setFinalMoney(consumeMoney - discountMoney);
        
        return ValidationResult.success();
    }
    
    /**
     * è®¡ç®—æŠ˜æ‰£é‡‘é¢
     */
    private Integer calculateDiscount(PosIDAccountKind kind, Integer consumeMoney) {
        if (kind.getDiscountType() == null || "0".equals(kind.getDiscountType())) {
            return 0;  // æ— æŠ˜æ‰£
        }
        
        if ("1".equals(kind.getDiscountType())) {
            // ç™¾åˆ†æ¯”æŠ˜æ‰£
            int discountPercent = kind.getDiscount() != null ? kind.getDiscount() : 100;
            return consumeMoney * (100 - discountPercent) / 100;
        }
        
        if ("2".equals(kind.getDiscountType())) {
            // å›ºå®šé‡‘é¢æŠ˜æ‰£
            int discountAmount = kind.getDiscountMoney() != null ? kind.getDiscountMoney() : 0;
            return Math.min(discountAmount, consumeMoney);
        }
        
        return 0;
    }
}
```

### 4.3 éªŒè¯æœåŠ¡ï¼ˆè´£ä»»é“¾è°ƒåº¦å™¨ï¼‰

```java
/**
 * ç»Ÿä¸€æƒé™éªŒè¯æœåŠ¡
 */
@Service
public class UnifiedPermissionService {
    
    private final Logger log = LoggerFactory.getLogger(UnifiedPermissionService.class);
    
    @Resource
    private List<PermissionValidator> validators;
    
    @Resource
    private PermissionCacheManager cacheManager;
    
    @Resource
    private PosIDPermissionLogDao permissionLogDao;
    
    /**
     * ç»Ÿä¸€éªŒè¯å…¥å£
     */
    public PermissionValidationResult validate(PermissionValidationRequest request) {
        long startTime = System.currentTimeMillis();
        
        // 1. æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡
        ValidationContext context = buildContext(request);
        
        // 2. æ£€æŸ¥é™æ€æƒé™ç¼“å­˜
        StaticPermissionResult staticResult = cacheManager.getStaticPermission(
            request.getAccountId(),
            request.getAreaId(),
            context.getMeal().getCategoryId()
        );
        
        if (staticResult != null && !staticResult.isSuccess()) {
            // é™æ€æƒé™éªŒè¯å¤±è´¥ï¼Œç›´æ¥è¿”å›
            return PermissionValidationResult.fail(staticResult.getReason());
        }
        
        // 3. æ’åºéªŒè¯å™¨
        List<PermissionValidator> sortedValidators = validators.stream()
            .filter(PermissionValidator::isEnabled)
            .sorted(Comparator.comparing(PermissionValidator::getOrder))
            .collect(Collectors.toList());
        
        // 4. æ‰§è¡ŒéªŒè¯é“¾
        List<ValidationResult> validationChain = new ArrayList<>();
        int cacheHits = 0;
        
        for (PermissionValidator validator : sortedValidators) {
            ValidationResult result = validator.validate(context);
            validationChain.add(result);
            
            // è®°å½•ç¼“å­˜å‘½ä¸­
            if (result.getDuration() < 5) {
                cacheHits++;
            }
            
            // å¦‚æœéªŒè¯å¤±è´¥ï¼Œä¸­æ–­é“¾æ¡
            if (!result.isSuccess()) {
                long totalDuration = System.currentTimeMillis() - startTime;
                
                // è®°å½•éªŒè¯æ—¥å¿—
                logValidation(request, context, false, result.getReason(), 
                    validator.getName(), validationChain, totalDuration, cacheHits);
                
                return PermissionValidationResult.fail(result.getReason())
                    .withValidatorName(validator.getName())
                    .withValidationChain(validationChain);
            }
        }
        
        // 5. æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œç»„è£…ç»“æœ
        long totalDuration = System.currentTimeMillis() - startTime;
        
        PermissionValidationResult result = PermissionValidationResult.success()
            .withFinalMoney(context.getFinalMoney())
            .withFixedMoney(context.getFixedMoney())
            .withDiscountMoney(context.getDiscountMoney())
            .withValidationChain(validationChain)
            .withDuration(totalDuration);
        
        // è®°å½•éªŒè¯æ—¥å¿—
        logValidation(request, context, true, null, null, 
            validationChain, totalDuration, cacheHits);
        
        return result;
    }
    
    /**
     * æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡
     */
    private ValidationContext buildContext(PermissionValidationRequest request) {
        // è·å–ç¼“å­˜çš„ä¸Šä¸‹æ–‡
        ValidationContext context = cacheManager.getValidationContext(request.getAccountId());
        
        // å¡«å……è¯·æ±‚ä¿¡æ¯
        context.setAreaId(request.getAreaId());
        context.setMealId(request.getMealId());
        context.setConsumeMoney(request.getConsumeMoney());
        context.setConsumeTime(request.getConsumeTime());
        
        // åŠ è½½åŒºåŸŸä¿¡æ¯
        PosIDArea area = areaService.getById(request.getAreaId());
        context.setArea(area);
        
        // åŠ è½½é¤åˆ«ä¿¡æ¯
        PosIDMeal meal = mealService.getById(request.getMealId());
        context.setMeal(meal);
        
        return context;
    }
    
    /**
     * è®°å½•éªŒè¯æ—¥å¿—
     */
    private void logValidation(
        PermissionValidationRequest request,
        ValidationContext context,
        boolean success,
        String failureReason,
        String failureValidator,
        List<ValidationResult> validationChain,
        long totalDuration,
        int cacheHits
    ) {
        try {
            PosIDPermissionLog log = new PosIDPermissionLog();
            log.setId(UUID.randomUUID().toString());
            log.setAccountId(request.getAccountId());
            log.setAccountKindId(context.getAccount().getAccountKindId());
            log.setAreaId(request.getAreaId());
            log.setMealId(request.getMealId());
            log.setDeviceId(request.getDeviceId());
            log.setValidationResult(success);
            log.setFailureReason(failureReason);
            log.setFailureValidator(failureValidator);
            log.setValidationChain(JSON.toJSONString(validationChain));
            log.setTotalDuration((int) totalDuration);
            log.setCacheHitRate((double) cacheHits / validationChain.size() * 100);
            log.setValidationTime(new Date());
            log.setCreateTime(new Date());
            
            permissionLogDao.save(log);
        } catch (Exception e) {
            this.log.error("è®°å½•éªŒè¯æ—¥å¿—å¤±è´¥", e);
        }
    }
    
    /**
     * æ‰¹é‡éªŒè¯ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
     */
    public Map<String, PermissionValidationResult> batchValidate(
        List<PermissionValidationRequest> requests
    ) {
        return requests.parallelStream()
            .collect(Collectors.toConcurrentMap(
                PermissionValidationRequest::getAccountId,
                this::validate
            ));
    }
}

/**
 * éªŒè¯è¯·æ±‚
 */
@Data
public class PermissionValidationRequest {
    private String accountId;
    private String areaId;
    private String mealId;
    private Integer consumeMoney;
    private LocalDateTime consumeTime;
    private String deviceId;
}

/**
 * éªŒè¯ç»“æœ
 */
@Data
public class ValidationResult {
    private boolean success;
    private String reason;
    private String validatorName;
    private long duration;  // æ¯«ç§’
    
    public static ValidationResult success() {
        ValidationResult result = new ValidationResult();
        result.setSuccess(true);
        return result;
    }
    
    public static ValidationResult fail(String reason) {
        ValidationResult result = new ValidationResult();
        result.setSuccess(false);
        result.setReason(reason);
        return result;
    }
}

/**
 * æƒé™éªŒè¯ç»“æœ
 */
@Data
public class PermissionValidationResult {
    private boolean success;
    private String reason;
    private String failureValidator;
    private Integer finalMoney;
    private Integer fixedMoney;
    private Integer discountMoney;
    private List<ValidationResult> validationChain;
    private long duration;
    
    public static PermissionValidationResult success() {
        PermissionValidationResult result = new PermissionValidationResult();
        result.setSuccess(true);
        return result;
    }
    
    public static PermissionValidationResult fail(String reason) {
        PermissionValidationResult result = new PermissionValidationResult();
        result.setSuccess(false);
        result.setReason(reason);
        return result;
    }
    
    public PermissionValidationResult withFinalMoney(Integer money) {
        this.finalMoney = money;
        return this;
    }
    
    public PermissionValidationResult withFixedMoney(Integer money) {
        this.fixedMoney = money;
        return this;
    }
    
    public PermissionValidationResult withDiscountMoney(Integer money) {
        this.discountMoney = money;
        return this;
    }
    
    public PermissionValidationResult withValidatorName(String name) {
        this.failureValidator = name;
        return this;
    }
    
    public PermissionValidationResult withValidationChain(List<ValidationResult> chain) {
        this.validationChain = chain;
        return this;
    }
    
    public PermissionValidationResult withDuration(long duration) {
        this.duration = duration;
        return this;
    }
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### 5.1 éªŒè¯æ€§èƒ½

| åœºæ™¯ | åŸè®¾è®¡ | é‡æ„å | æå‡ |
|------|-------|--------|------|
| å•æ¬¡éªŒè¯ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ | 50ms | 5ms | â†‘90% |
| å•æ¬¡éªŒè¯ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ | 150ms | 30ms | â†‘80% |
| æ‰¹é‡éªŒè¯100ä¸ª | 5000ms | 500ms | â†‘90% |
| é«˜å¹¶å‘TPS | 200 | 2000+ | â†‘10å€ |

### 5.2 ä»£ç è´¨é‡

| ç»´åº¦ | åŸè®¾è®¡ | é‡æ„å | æ”¹å–„ |
|------|-------|--------|------|
| éªŒè¯é€»è¾‘åˆ†æ•£åº¦ | 5ä¸ªService | 1ä¸ªç»Ÿä¸€å…¥å£ | â†“80% |
| ä»£ç é‡å¤ç‡ | 40% | 5% | â†“87% |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | 30% | 85% | â†‘183% |
| å¯ç»´æŠ¤æ€§è¯„åˆ† | C | A | â†‘2çº§ |

### 5.3 åŠŸèƒ½æ‰©å±•æ€§

| éœ€æ±‚ | åŸè®¾è®¡ | é‡æ„å |
|------|-------|--------|
| æ–°å¢éªŒè¯è§„åˆ™ | ä¿®æ”¹å¤šä¸ªService | æ–°å¢Validatorç±» |
| è°ƒæ•´éªŒè¯é¡ºåº | ä¿®æ”¹ä»£ç  | ä¿®æ”¹@Orderæ³¨è§£ |
| ç¦ç”¨æŸä¸ªéªŒè¯ | æ³¨é‡Šä»£ç  | é…ç½®isEnabled() |
| éªŒè¯ç»“æœç¼“å­˜ | ä¸æ”¯æŒ | è‡ªåŠ¨æ”¯æŒ |

---

## ğŸ¯ æ€»ç»“

### é‡æ„æˆæœ

âœ… **ç»Ÿä¸€éªŒè¯å…¥å£**ï¼š1ä¸ªServiceæ›¿ä»£5ä¸ªåˆ†æ•£é€»è¾‘  
âœ… **éªŒè¯æ€§èƒ½æå‡90%**ï¼šå¤šçº§ç¼“å­˜+æ‰¹é‡ä¼˜åŒ–  
âœ… **è´£ä»»é“¾æ¨¡å¼**ï¼šçµæ´»å¯æ‰©å±•çš„éªŒè¯é“¾  
âœ… **ä»£ç é‡å¤ç‡é™ä½87%**ï¼šå¤ç”¨éªŒè¯å™¨  
âœ… **å®Œæ•´çš„å®¡è®¡æ—¥å¿—**ï¼šæ¯æ¬¡éªŒè¯éƒ½æœ‰è¯¦ç»†è®°å½•

### è®¾è®¡äº®ç‚¹

1. **è´£ä»»é“¾æ¨¡å¼**ï¼š9ä¸ªéªŒè¯å™¨æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œï¼Œå¤±è´¥å³ä¸­æ–­
2. **å¤šçº§ç¼“å­˜**ï¼šL1æœ¬åœ°ç¼“å­˜+L2Redis+L3æ•°æ®åº“
3. **é™æ€æƒé™ç¼“å­˜**ï¼šåˆ†ç¦»é™æ€å’ŒåŠ¨æ€æƒé™ï¼Œæå‡ç¼“å­˜å‘½ä¸­ç‡
4. **æ‰¹é‡ä¼˜åŒ–**ï¼šå¹¶è¡Œæµ+Pipelineï¼Œæ‰¹é‡æ€§èƒ½æå‡10å€
5. **å®Œæ•´æ—¥å¿—**ï¼šéªŒè¯é“¾è¯¦æƒ…ã€è€—æ—¶ã€ç¼“å­˜å‘½ä¸­ç‡å…¨è®°å½•

### éªŒè¯å™¨åˆ—è¡¨

1. **AccountStatusValidator** - è´¦æˆ·çŠ¶æ€éªŒè¯
2. **AreaPermissionValidator** - åŒºåŸŸæƒé™éªŒè¯
3. **MealPermissionValidator** - é¤åˆ«æƒé™éªŒè¯
4. **TimeWindowValidator** - æ—¶é—´çª—å£éªŒè¯
5. **BalanceValidator** - ä½™é¢æ£€æŸ¥
6. **LimitValidator** - é™é¢æ£€æŸ¥ï¼ˆæ—¥/æœˆ/æ¬¡ï¼‰
7. **FixedValueCalculator** - å®šå€¼è®¡ç®—
8. **DiscountCalculator** - æŠ˜æ‰£è®¡ç®—
9. **å¯æ‰©å±•** - æ–°å¢Validatorå³å¯

### ä¸šåŠ¡ä»·å€¼

- ğŸ“ **æ•™è‚²åœºæ™¯**ï¼šå­¦ç”Ÿå¡é™é¢ã€æ•™å¸ˆå¡ä¸é™é¢
- ğŸ¥ **åŒ»ç–—åœºæ™¯**ï¼šç—…äººå¡åŒºåŸŸé™åˆ¶ã€é¤åˆ«é™åˆ¶
- ğŸ¢ **ä¼ä¸šåœºæ™¯**ï¼šå‘˜å·¥å¡å±‚çº§æƒé™ã€å®šå€¼è¡¥è´´
- ğŸ›ï¸ **å•†åœºåœºæ™¯**ï¼šä¼šå‘˜å¡æŠ˜æ‰£ã€æ¶ˆè´¹é™é¢

---

## ğŸš€ ç”Ÿäº§ç¯å¢ƒå®æˆ˜

### 6.1 é«˜å¹¶å‘æ€§èƒ½ä¼˜åŒ–

#### 6.1.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ

**å‹æµ‹æ•°æ®ï¼ˆæœªä¼˜åŒ–ï¼‰ï¼š**
```
å¹¶å‘ç”¨æˆ·ï¼š1000
QPSï¼š200
å¹³å‡å“åº”æ—¶é—´ï¼š800ms
P95å“åº”æ—¶é—´ï¼š1500ms
P99å“åº”æ—¶é—´ï¼š2500ms
é”™è¯¯ç‡ï¼š5%
```

**ç“¶é¢ˆç‚¹è¯†åˆ«ï¼š**
1. ğŸ”´ **æ•°æ®åº“è¿æ¥æ± è€—å°½**ï¼šé»˜è®¤10ä¸ªè¿æ¥ï¼Œé«˜å¹¶å‘æ—¶ç­‰å¾…
2. ğŸ”´ **Redisè¿æ¥è¶…æ—¶**ï¼šå•è¿æ¥ä¸²è¡Œï¼Œæ— è¿æ¥æ± 
3. ğŸ”´ **ç¼“å­˜ç©¿é€**ï¼šä¸å­˜åœ¨çš„è´¦æˆ·é‡å¤æŸ¥è¯¢æ•°æ®åº“
4. ğŸŸ¡ **éªŒè¯å™¨ä¸²è¡Œæ‰§è¡Œ**ï¼šæ— æ³•åˆ©ç”¨å¤šæ ¸CPU
5. ğŸŸ¡ **å¤§é‡æ—¥å¿—å†™å…¥**ï¼šåŒæ­¥å†™å…¥é˜»å¡ä¸»æµç¨‹

#### 6.1.2 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

**ä¼˜åŒ–1ï¼šæ•°æ®åº“è¿æ¥æ± è°ƒä¼˜**

```yaml
# application.yml
spring:
  datasource:
    druid:
      # æ ¸å¿ƒè¿æ¥æ•°ï¼ˆæ ¹æ®æœåŠ¡å™¨æ ¸å¿ƒæ•°è°ƒæ•´ï¼‰
      minimum-idle: 20
      maximum-pool-size: 100
      # è¿æ¥è¶…æ—¶
      connection-timeout: 30000
      # ç©ºé—²è¶…æ—¶
      idle-timeout: 600000
      # æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
      max-lifetime: 1800000
      # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      connection-test-query: SELECT 1
      # è¿æ¥æ³„æ¼æ£€æµ‹
      leak-detection-threshold: 60000
```

**ä¼˜åŒ–2ï¼šRedisè¿æ¥æ± é…ç½®**

```yaml
spring:
  redis:
    lettuce:
      pool:
        # æœ€å¤§è¿æ¥æ•°
        max-active: 200
        # æœ€å¤§ç©ºé—²è¿æ¥
        max-idle: 50
        # æœ€å°ç©ºé—²è¿æ¥
        min-idle: 10
        # æœ€å¤§ç­‰å¾…æ—¶é—´
        max-wait: 3000
      # è¶…æ—¶é…ç½®
      timeout: 3000
    # é›†ç¾¤é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
    cluster:
      nodes: 
        - redis-node1:6379
        - redis-node2:6379
        - redis-node3:6379
      max-redirects: 3
```

**ä¼˜åŒ–3ï¼šç¼“å­˜ç©¿é€é˜²æŠ¤**

```java
/**
 * å¸ƒéš†è¿‡æ»¤å™¨é˜²æŠ¤ç¼“å­˜ç©¿é€
 */
@Component
public class BloomFilterProtection {
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String BLOOM_FILTER_KEY = "bf:accounts";
    
    /**
     * åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
     */
    @PostConstruct
    public void initBloomFilter() {
        // é¢„æœŸå…ƒç´ æ•°é‡ï¼š100ä¸‡
        // æœŸæœ›è¯¯åˆ¤ç‡ï¼š0.01
        RBloomFilter<String> bloomFilter = 
            redissonClient.getBloomFilter(BLOOM_FILTER_KEY);
        bloomFilter.tryInit(1000000L, 0.01);
        
        // åŠ è½½æ‰€æœ‰è´¦æˆ·ID
        List<String> accountIds = accountDao.findAllIds();
        accountIds.forEach(bloomFilter::add);
        
        log.info("å¸ƒéš†è¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆï¼ŒåŠ è½½{}ä¸ªè´¦æˆ·", accountIds.size());
    }
    
    /**
     * æ£€æŸ¥è´¦æˆ·æ˜¯å¦å¯èƒ½å­˜åœ¨
     */
    public boolean mightContain(String accountId) {
        RBloomFilter<String> bloomFilter = 
            redissonClient.getBloomFilter(BLOOM_FILTER_KEY);
        return bloomFilter.contains(accountId);
    }
    
    /**
     * æ·»åŠ æ–°è´¦æˆ·
     */
    public void addAccount(String accountId) {
        RBloomFilter<String> bloomFilter = 
            redissonClient.getBloomFilter(BLOOM_FILTER_KEY);
        bloomFilter.add(accountId);
    }
}

/**
 * ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ä¼˜åŒ–éªŒè¯
 */
@Service
public class OptimizedPermissionService {
    
    @Resource
    private BloomFilterProtection bloomFilter;
    
    public PermissionValidationResult validate(PermissionValidationRequest request) {
        // å¿«é€Ÿæ‹¦æˆªä¸å­˜åœ¨çš„è´¦æˆ·
        if (!bloomFilter.mightContain(request.getAccountId())) {
            return PermissionValidationResult.fail("è´¦æˆ·ä¸å­˜åœ¨");
        }
        
        // ç»§ç»­æ­£å¸¸éªŒè¯æµç¨‹
        return doValidate(request);
    }
}
```

**ä¼˜åŒ–4ï¼šå¼‚æ­¥æ—¥å¿—å†™å…¥**

```java
/**
 * å¼‚æ­¥æ—¥å¿—å†™å…¥
 */
@Service
public class AsyncPermissionLogger {
    
    @Resource
    private PosIDPermissionLogDao permissionLogDao;
    
    // å¼‚æ­¥çº¿ç¨‹æ± 
    private ExecutorService logExecutor = new ThreadPoolExecutor(
        2,                      // æ ¸å¿ƒçº¿ç¨‹æ•°
        10,                     // æœ€å¤§çº¿ç¨‹æ•°
        60L,                    // ç©ºé—²æ—¶é—´
        TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(10000),  // é˜Ÿåˆ—å®¹é‡
        new ThreadPoolExecutor.CallerRunsPolicy()  // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…æ‰§è¡Œ
    );
    
    /**
     * å¼‚æ­¥è®°å½•æ—¥å¿—
     */
    @Async
    public void logAsync(PosIDPermissionLog log) {
        logExecutor.execute(() -> {
            try {
                permissionLogDao.save(log);
            } catch (Exception e) {
                // æ—¥å¿—å†™å…¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
                logger.error("å¼‚æ­¥å†™å…¥éªŒè¯æ—¥å¿—å¤±è´¥", e);
            }
        });
    }
    
    /**
     * æ‰¹é‡å†™å…¥ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
     */
    private BlockingQueue<PosIDPermissionLog> logQueue = 
        new LinkedBlockingQueue<>(5000);
    
    @PostConstruct
    public void startBatchWriter() {
        new Thread(() -> {
            while (true) {
                try {
                    List<PosIDPermissionLog> batch = new ArrayList<>();
                    
                    // ç­‰å¾…ç¬¬ä¸€æ¡æ•°æ®
                    PosIDPermissionLog first = logQueue.take();
                    batch.add(first);
                    
                    // æ‰¹é‡å–å‡ºï¼Œæœ€å¤š100æ¡
                    logQueue.drainTo(batch, 99);
                    
                    // æ‰¹é‡å†™å…¥
                    permissionLogDao.saveAll(batch);
                    
                } catch (Exception e) {
                    logger.error("æ‰¹é‡å†™å…¥æ—¥å¿—å¤±è´¥", e);
                }
            }
        }, "log-batch-writer").start();
    }
    
    public void addToQueue(PosIDPermissionLog log) {
        if (!logQueue.offer(log)) {
            logger.warn("æ—¥å¿—é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒæ—¥å¿—");
        }
    }
}
```

**ä¼˜åŒ–5ï¼šå¹¶è¡ŒéªŒè¯å™¨ï¼ˆå¯é€‰ï¼‰**

```java
/**
 * å¹¶è¡ŒéªŒè¯å™¨ï¼ˆç‹¬ç«‹éªŒè¯å™¨å¯å¹¶è¡Œæ‰§è¡Œï¼‰
 */
@Service
public class ParallelValidationService {
    
    @Resource
    private List<PermissionValidator> validators;
    
    // éªŒè¯å™¨çº¿ç¨‹æ± 
    private ExecutorService validatorExecutor = new ThreadPoolExecutor(
        10, 50, 60L, TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(1000),
        new ThreadPoolExecutor.CallerRunsPolicy()
    );
    
    /**
     * å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹éªŒè¯å™¨
     */
    public PermissionValidationResult parallelValidate(ValidationContext context) {
        // 1. ä¸²è¡Œæ‰§è¡Œä¾èµ–å‹éªŒè¯å™¨
        List<PermissionValidator> sequentialValidators = validators.stream()
            .filter(v -> v.getOrder() <= 4)  // å‰4ä¸ªæœ‰ä¾èµ–å…³ç³»
            .sorted(Comparator.comparing(PermissionValidator::getOrder))
            .collect(Collectors.toList());
        
        for (PermissionValidator validator : sequentialValidators) {
            ValidationResult result = validator.validate(context);
            if (!result.isSuccess()) {
                return PermissionValidationResult.fail(result.getReason());
            }
        }
        
        // 2. å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹éªŒè¯å™¨
        List<PermissionValidator> parallelValidators = validators.stream()
            .filter(v -> v.getOrder() > 4)  // åé¢çš„ç›¸äº’ç‹¬ç«‹
            .collect(Collectors.toList());
        
        List<CompletableFuture<ValidationResult>> futures = parallelValidators.stream()
            .map(validator -> CompletableFuture.supplyAsync(
                () -> validator.validate(context),
                validatorExecutor
            ))
            .collect(Collectors.toList());
        
        // 3. ç­‰å¾…æ‰€æœ‰å¹¶è¡ŒéªŒè¯å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
        
        // 4. æ£€æŸ¥ç»“æœ
        for (CompletableFuture<ValidationResult> future : futures) {
            ValidationResult result = future.join();
            if (!result.isSuccess()) {
                return PermissionValidationResult.fail(result.getReason());
            }
        }
        
        return PermissionValidationResult.success();
    }
}
```

**ä¼˜åŒ–åæ€§èƒ½æ•°æ®ï¼š**
```
å¹¶å‘ç”¨æˆ·ï¼š1000
QPSï¼š2000+  â†‘10å€
å¹³å‡å“åº”æ—¶é—´ï¼š50ms  â†“94%
P95å“åº”æ—¶é—´ï¼š100ms  â†“93%
P99å“åº”æ—¶é—´ï¼š200ms  â†“92%
é”™è¯¯ç‡ï¼š0.01%  â†“99%
```

### 6.2 ç¼“å­˜é«˜å¯ç”¨è®¾è®¡

#### 6.2.1 ç¼“å­˜é›ªå´©é˜²æŠ¤

```java
/**
 * ç¼“å­˜é›ªå´©é˜²æŠ¤
 */
@Component
public class CacheAvalancheProtection {
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢åŒæ—¶å¤±æ•ˆï¼‰
     */
    public void setWithRandomExpire(String key, Object value, long baseSeconds) {
        // åŸºç¡€æ—¶é—´ + éšæœºæ—¶é—´ï¼ˆ0-20%ï¼‰
        long randomSeconds = baseSeconds + ThreadLocalRandom.current()
            .nextLong(baseSeconds / 5);
        
        redisTemplate.opsForValue().set(key, value, randomSeconds, TimeUnit.SECONDS);
    }
    
    /**
     * æ°¸ä¸è¿‡æœŸç­–ç•¥ï¼ˆåå°æ›´æ–°ï¼‰
     */
    public void setNeverExpire(String key, Object value) {
        // åŒ…è£…æ•°æ®ï¼Œæ·»åŠ é€»è¾‘è¿‡æœŸæ—¶é—´
        CacheWrapper wrapper = new CacheWrapper();
        wrapper.setData(value);
        wrapper.setExpireTime(System.currentTimeMillis() + 30 * 60 * 1000);  // 30åˆ†é’Ÿ
        
        redisTemplate.opsForValue().set(key, wrapper);
    }
    
    public Object getWithLogicalExpire(String key) {
        CacheWrapper wrapper = (CacheWrapper) redisTemplate.opsForValue().get(key);
        
        if (wrapper == null) {
            return null;
        }
        
        // æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
        if (wrapper.getExpireTime() < System.currentTimeMillis()) {
            // é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥æ›´æ–°
            asyncRefreshCache(key);
            // è¿”å›æ—§æ•°æ®ï¼ˆé¿å…é›ªå´©ï¼‰
            return wrapper.getData();
        }
        
        return wrapper.getData();
    }
    
    @Async
    private void asyncRefreshCache(String key) {
        // å¼‚æ­¥åˆ·æ–°ç¼“å­˜
        // ...
    }
}

@Data
class CacheWrapper {
    private Object data;
    private long expireTime;  // é€»è¾‘è¿‡æœŸæ—¶é—´
}
```

#### 6.2.2 ç¼“å­˜å‡»ç©¿é˜²æŠ¤ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰

```java
/**
 * ç¼“å­˜å‡»ç©¿é˜²æŠ¤ï¼ˆäº’æ–¥é”ï¼‰
 */
@Component
public class CacheBreakdownProtection {
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    @Resource
    private RedissonClient redissonClient;
    
    /**
     * ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å‡»ç©¿
     */
    public Object getWithMutex(String key, Supplier<Object> dataLoader) {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        Object value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            return value;
        }
        
        // 2. è·å–åˆ†å¸ƒå¼é”
        String lockKey = "lock:" + key;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…5ç§’ï¼Œé”10ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
                try {
                    // åŒé‡æ£€æŸ¥
                    value = redisTemplate.opsForValue().get(key);
                    if (value != null) {
                        return value;
                    }
                    
                    // åŠ è½½æ•°æ®
                    value = dataLoader.get();
                    
                    // å†™å…¥ç¼“å­˜
                    if (value != null) {
                        redisTemplate.opsForValue().set(key, value, 30, TimeUnit.MINUTES);
                    } else {
                        // ç©ºå€¼ç¼“å­˜ï¼ˆé˜²æ­¢ç©¿é€ï¼‰
                        redisTemplate.opsForValue().set(key, "NULL", 5, TimeUnit.MINUTES);
                    }
                    
                    return value;
                    
                } finally {
                    lock.unlock();
                }
            } else {
                // è·å–é”å¤±è´¥ï¼ŒçŸ­æš‚ç­‰å¾…åé‡è¯•
                Thread.sleep(100);
                return getWithMutex(key, dataLoader);
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("è·å–ç¼“å­˜é”ä¸­æ–­", e);
        }
    }
}
```

#### 6.2.3 Redisæ•…éšœé™çº§

```java
/**
 * Redisæ•…éšœé™çº§
 */
@Component
public class RedisFallbackHandler {
    
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    
    // æœ¬åœ°ç¼“å­˜ä½œä¸ºé™çº§æ–¹æ¡ˆ
    private final Cache<String, Object> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    // ç†”æ–­å™¨
    private final CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults("redis");
    
    /**
     * å¸¦é™çº§çš„ç¼“å­˜è·å–
     */
    public Object getWithFallback(String key) {
        try {
            // ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤
            return circuitBreaker.executeSupplier(() -> {
                return redisTemplate.opsForValue().get(key);
            });
            
        } catch (Exception e) {
            log.warn("Redisè®¿é—®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜é™çº§: {}", e.getMessage());
            
            // é™çº§åˆ°æœ¬åœ°ç¼“å­˜
            return localCache.getIfPresent(key);
        }
    }
    
    /**
     * å¸¦é™çº§çš„ç¼“å­˜è®¾ç½®
     */
    public void setWithFallback(String key, Object value) {
        try {
            circuitBreaker.executeRunnable(() -> {
                redisTemplate.opsForValue().set(key, value, 30, TimeUnit.MINUTES);
            });
            
            // åŒæ—¶å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
            
        } catch (Exception e) {
            log.warn("Rediså†™å…¥å¤±è´¥ï¼Œä»…å†™å…¥æœ¬åœ°ç¼“å­˜: {}", e.getMessage());
            localCache.put(key, value);
        }
    }
}
```

### 6.3 ç›‘æ§ä¸å‘Šè­¦

#### 6.3.1 æ€§èƒ½ç›‘æ§æŒ‡æ ‡

```java
/**
 * éªŒè¯æ€§èƒ½ç›‘æ§
 */
@Component
public class ValidationMetrics {
    
    @Resource
    private MeterRegistry meterRegistry;
    
    // éªŒè¯æ€»æ¬¡æ•°
    private Counter validationTotal;
    
    // éªŒè¯æˆåŠŸæ¬¡æ•°
    private Counter validationSuccess;
    
    // éªŒè¯å¤±è´¥æ¬¡æ•°ï¼ˆæŒ‰å¤±è´¥ç±»å‹åˆ†ç»„ï¼‰
    private Map<String, Counter> validationFailures = new ConcurrentHashMap<>();
    
    // éªŒè¯è€—æ—¶åˆ†å¸ƒ
    private Timer validationDuration;
    
    // ç¼“å­˜å‘½ä¸­ç‡
    private Gauge cacheHitRate;
    
    // å½“å‰å¹¶å‘éªŒè¯æ•°
    private AtomicInteger concurrentValidations = new AtomicInteger(0);
    
    @PostConstruct
    public void init() {
        validationTotal = Counter.builder("validation.total")
            .description("éªŒè¯æ€»æ¬¡æ•°")
            .register(meterRegistry);
        
        validationSuccess = Counter.builder("validation.success")
            .description("éªŒè¯æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);
        
        validationDuration = Timer.builder("validation.duration")
            .description("éªŒè¯è€—æ—¶")
            .publishPercentiles(0.5, 0.95, 0.99)  // P50, P95, P99
            .register(meterRegistry);
        
        Gauge.builder("validation.concurrent", concurrentValidations, AtomicInteger::get)
            .description("å½“å‰å¹¶å‘éªŒè¯æ•°")
            .register(meterRegistry);
    }
    
    /**
     * è®°å½•éªŒè¯æŒ‡æ ‡
     */
    public void recordValidation(
        PermissionValidationResult result,
        long duration
    ) {
        validationTotal.increment();
        
        if (result.isSuccess()) {
            validationSuccess.increment();
        } else {
            getFailureCounter(result.getReason()).increment();
        }
        
        validationDuration.record(duration, TimeUnit.MILLISECONDS);
    }
    
    /**
     * è·å–å¤±è´¥ç±»å‹è®¡æ•°å™¨
     */
    private Counter getFailureCounter(String reason) {
        return validationFailures.computeIfAbsent(reason, r ->
            Counter.builder("validation.failure")
                .tag("reason", r)
                .register(meterRegistry)
        );
    }
    
    /**
     * å¹¶å‘æ§åˆ¶
     */
    public void incrementConcurrent() {
        concurrentValidations.incrementAndGet();
    }
    
    public void decrementConcurrent() {
        concurrentValidations.decrementAndGet();
    }
}
```

#### 6.3.2 å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: posid_validation
    interval: 30s
    rules:
      # éªŒè¯å¤±è´¥ç‡è¿‡é«˜
      - alert: HighValidationFailureRate
        expr: |
          rate(validation_failure_total[5m]) / rate(validation_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "éªŒè¯å¤±è´¥ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’ŸéªŒè¯å¤±è´¥ç‡è¶…è¿‡10%"
      
      # éªŒè¯è€—æ—¶è¿‡é•¿
      - alert: SlowValidation
        expr: |
          histogram_quantile(0.95, rate(validation_duration_bucket[5m])) > 100
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "éªŒè¯å“åº”æ—¶é—´è¿‡é•¿"
          description: "P95å“åº”æ—¶é—´è¶…è¿‡100ms"
      
      # Redisè¿æ¥å¤±è´¥
      - alert: RedisConnectionFailure
        expr: |
          rate(redis_connection_errors_total[1m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redisè¿æ¥å¤±è´¥"
          description: "Redisè¿æ¥å‡ºç°é”™è¯¯"
      
      # ç¼“å­˜å‘½ä¸­ç‡ä½
      - alert: LowCacheHitRate
        expr: |
          cache_hit_rate < 0.7
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ä½äº70%"
      
      # å¹¶å‘éªŒè¯æ•°è¿‡é«˜
      - alert: HighConcurrentValidations
        expr: |
          validation_concurrent > 500
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "å¹¶å‘éªŒè¯æ•°è¿‡é«˜"
          description: "å½“å‰å¹¶å‘éªŒè¯æ•°è¶…è¿‡500"
```

#### 6.3.3 ç›‘æ§Dashboardé…ç½®

```json
{
  "dashboard": {
    "title": "æƒé™éªŒè¯ç³»ç»Ÿç›‘æ§",
    "panels": [
      {
        "title": "éªŒè¯QPS",
        "targets": [
          {
            "expr": "rate(validation_total[1m])"
          }
        ]
      },
      {
        "title": "éªŒè¯æˆåŠŸç‡",
        "targets": [
          {
            "expr": "rate(validation_success[5m]) / rate(validation_total[5m]) * 100"
          }
        ]
      },
      {
        "title": "éªŒè¯è€—æ—¶åˆ†å¸ƒ",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(validation_duration_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(validation_duration_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(validation_duration_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "å¤±è´¥åŸå› åˆ†å¸ƒ",
        "targets": [
          {
            "expr": "sum by (reason) (rate(validation_failure[5m]))"
          }
        ],
        "type": "pie"
      },
      {
        "title": "ç¼“å­˜å‘½ä¸­ç‡",
        "targets": [
          {
            "expr": "cache_hit_rate * 100"
          }
        ]
      },
      {
        "title": "å½“å‰å¹¶å‘æ•°",
        "targets": [
          {
            "expr": "validation_concurrent"
          }
        ]
      }
    ]
  }
}
```

### 6.4 å®¹é”™ä¸é™çº§ç­–ç•¥

#### 6.4.1 å¤šçº§é™çº§æ–¹æ¡ˆ

```java
/**
 * å¤šçº§é™çº§ç­–ç•¥
 */
@Component
public class ValidationDegradationStrategy {
    
    @Resource
    private UnifiedPermissionService fullValidationService;
    
    @Resource
    private SimplifiedValidationService simplifiedService;
    
    @Resource
    private EmergencyValidationService emergencyService;
    
    // ç³»ç»Ÿè´Ÿè½½ç›‘æ§
    @Resource
    private SystemLoadMonitor loadMonitor;
    
    /**
     * æ ¹æ®ç³»ç»Ÿè´Ÿè½½é€‰æ‹©éªŒè¯ç­–ç•¥
     */
    public PermissionValidationResult validateWithDegradation(
        PermissionValidationRequest request
    ) {
        double systemLoad = loadMonitor.getCurrentLoad();
        
        if (systemLoad < 0.7) {
            // è´Ÿè½½æ­£å¸¸ï¼šå®Œæ•´éªŒè¯
            return fullValidationService.validate(request);
            
        } else if (systemLoad < 0.9) {
            // è´Ÿè½½è¾ƒé«˜ï¼šç®€åŒ–éªŒè¯ï¼ˆè·³è¿‡éå…³é”®éªŒè¯å™¨ï¼‰
            log.warn("ç³»ç»Ÿè´Ÿè½½{}ï¼Œå¯ç”¨ç®€åŒ–éªŒè¯", systemLoad);
            return simplifiedService.validate(request);
            
        } else {
            // è´Ÿè½½æé«˜ï¼šç´§æ€¥æ¨¡å¼ï¼ˆä»…å…³é”®éªŒè¯ï¼‰
            log.error("ç³»ç»Ÿè´Ÿè½½{}ï¼Œå¯ç”¨ç´§æ€¥éªŒè¯æ¨¡å¼", systemLoad);
            return emergencyService.validate(request);
        }
    }
}

/**
 * ç®€åŒ–éªŒè¯æœåŠ¡ï¼ˆè·³è¿‡éå…³é”®éªŒè¯ï¼‰
 */
@Service
public class SimplifiedValidationService {
    
    // ä»…æ‰§è¡Œå…³é”®éªŒè¯å™¨
    private static final Set<String> CRITICAL_VALIDATORS = Set.of(
        "AccountStatusValidator",    // è´¦æˆ·çŠ¶æ€
        "AreaPermissionValidator",    // åŒºåŸŸæƒé™
        "BalanceValidator"            // ä½™é¢æ£€æŸ¥
    );
    
    public PermissionValidationResult validate(ValidationContext context) {
        // ä»…æ‰§è¡Œå…³é”®éªŒè¯å™¨
        for (PermissionValidator validator : validators) {
            if (CRITICAL_VALIDATORS.contains(validator.getName())) {
                ValidationResult result = validator.validate(context);
                if (!result.isSuccess()) {
                    return PermissionValidationResult.fail(result.getReason());
                }
            }
        }
        
        return PermissionValidationResult.success();
    }
}

/**
 * ç´§æ€¥éªŒè¯æœåŠ¡ï¼ˆæœ€å°éªŒè¯ï¼‰
 */
@Service
public class EmergencyValidationService {
    
    public PermissionValidationResult validate(ValidationContext context) {
        // ä»…æ£€æŸ¥è´¦æˆ·çŠ¶æ€å’Œä½™é¢
        PosIDAccount account = context.getAccount();
        
        if (account == null || !account.getAvailable()) {
            return PermissionValidationResult.fail("è´¦æˆ·ä¸å¯ç”¨");
        }
        
        if (account.getBalance() <= 0) {
            return PermissionValidationResult.fail("ä½™é¢ä¸è¶³");
        }
        
        return PermissionValidationResult.success();
    }
}
```

#### 6.4.2 ç†”æ–­å™¨é…ç½®

```java
/**
 * ç†”æ–­å™¨é…ç½®
 */
@Configuration
public class CircuitBreakerConfig {
    
    @Bean
    public CircuitBreakerRegistry circuitBreakerRegistry() {
        CircuitBreakerConfig config = CircuitBreakerConfig.custom()
            // æ»‘åŠ¨çª—å£å¤§å°
            .slidingWindowSize(100)
            // å¤±è´¥ç‡é˜ˆå€¼
            .failureRateThreshold(50)
            // æ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼
            .slowCallRateThreshold(50)
            // æ…¢è°ƒç”¨æ—¶é—´é˜ˆå€¼
            .slowCallDurationThreshold(Duration.ofMillis(200))
            // åŠå¼€çŠ¶æ€å…è®¸çš„è°ƒç”¨æ•°
            .permittedNumberOfCallsInHalfOpenState(10)
            // æœ€å°è°ƒç”¨æ•°ï¼ˆè¾¾åˆ°åæ‰è®¡ç®—å¤±è´¥ç‡ï¼‰
            .minimumNumberOfCalls(10)
            // ç†”æ–­å™¨æ‰“å¼€åç­‰å¾…æ—¶é—´
            .waitDurationInOpenState(Duration.ofSeconds(30))
            .build();
        
        return CircuitBreakerRegistry.of(config);
    }
}

/**
 * ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤å¤–éƒ¨è°ƒç”¨
 */
@Service
public class ProtectedValidationService {
    
    @Resource
    private CircuitBreakerRegistry circuitBreakerRegistry;
    
    public PermissionValidationResult validate(PermissionValidationRequest request) {
        CircuitBreaker circuitBreaker = circuitBreakerRegistry
            .circuitBreaker("validation");
        
        return circuitBreaker.executeSupplier(() -> {
            return doValidate(request);
        });
    }
}
```

### 6.5 å‹åŠ›æµ‹è¯•

#### 6.5.1 JMeteræµ‹è¯•è®¡åˆ’

```xml
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="æƒé™éªŒè¯å‹åŠ›æµ‹è¯•">
      <elementProp name="TestPlan.user_defined_variables" elementType="Arguments">
        <collectionProp name="Arguments.arguments">
          <elementProp name="BASE_URL" elementType="Argument">
            <stringProp name="Argument.value">http://localhost:8080</stringProp>
          </elementProp>
          <elementProp name="THREADS" elementType="Argument">
            <stringProp name="Argument.value">1000</stringProp>
          </elementProp>
          <elementProp name="RAMP_UP" elementType="Argument">
            <stringProp name="Argument.value">60</stringProp>
          </elementProp>
          <elementProp name="DURATION" elementType="Argument">
            <stringProp name="Argument.value">600</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
    </TestPlan>
    
    <hashTree>
      <!-- çº¿ç¨‹ç»„ -->
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="éªŒè¯è¯·æ±‚">
        <intProp name="ThreadGroup.num_threads">${THREADS}</intProp>
        <intProp name="ThreadGroup.ramp_time">${RAMP_UP}</intProp>
        <intProp name="ThreadGroup.duration">${DURATION}</intProp>
        <boolProp name="ThreadGroup.scheduler">true</boolProp>
      </ThreadGroup>
      
      <hashTree>
        <!-- HTTPè¯·æ±‚ -->
        <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="éªŒè¯æƒé™">
          <stringProp name="HTTPSampler.domain">${BASE_URL}</stringProp>
          <stringProp name="HTTPSampler.path">/api/permission/validate</stringProp>
          <stringProp name="HTTPSampler.method">POST</stringProp>
          <boolProp name="HTTPSampler.use_keepalive">true</boolProp>
          <elementProp name="HTTPsampler.Arguments" elementType="Arguments">
            <collectionProp name="Arguments.arguments">
              <elementProp name="body" elementType="HTTPArgument">
                <stringProp name="Argument.value">{
                  "accountId": "${accountId}",
                  "areaId": "${areaId}",
                  "mealId": "${mealId}",
                  "consumeMoney": 1000
                }</stringProp>
                <stringProp name="Argument.metadata">=</stringProp>
                <boolProp name="HTTPArgument.always_encode">false</boolProp>
              </elementProp>
            </collectionProp>
          </elementProp>
        </HTTPSamplerProxy>
        
        <!-- ç›‘å¬å™¨ -->
        <ResultCollector guiclass="SummaryReport" testclass="ResultCollector" testname="èšåˆæŠ¥å‘Š"/>
        <ResultCollector guiclass="GraphVisualizer" testclass="ResultCollector" testname="å›¾å½¢ç»“æœ"/>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```

#### 6.5.2 å‹æµ‹ç»“æœåˆ†æ

**æµ‹è¯•åœºæ™¯ï¼š**
- å¹¶å‘ç”¨æˆ·ï¼š1000
- æŒç»­æ—¶é—´ï¼š10åˆ†é’Ÿ
- è¯·æ±‚æ€»æ•°ï¼š120ä¸‡

**æµ‹è¯•ç»“æœï¼š**
```
Label          Samples   Avg(ms)  Min   Max   90%   95%   99%   Error%   TPS
---------------------------------------------------------------------------
éªŒè¯æƒé™       1200000    45      5    200   70    85    120   0.01%    2000
  ç¼“å­˜å‘½ä¸­     960000     8       5     20   12    15     20   0%       1600
  ç¼“å­˜æœªå‘½ä¸­   240000    150      80   200  180   190    200   0.05%     400
```

**æ€§èƒ½ç“¶é¢ˆåˆ†æï¼š**
1. âœ… **æ•°æ®åº“è¿æ¥æ± **ï¼šä½¿ç”¨ç‡65%ï¼Œæœªæ»¡è½½
2. âœ… **Redisè¿æ¥æ± **ï¼šä½¿ç”¨ç‡40%ï¼Œæ€§èƒ½è‰¯å¥½
3. âœ… **CPUä½¿ç”¨ç‡**ï¼šå¹³å‡55%ï¼Œæœ‰ä½™é‡
4. âš ï¸ **å†…å­˜ä½¿ç”¨ç‡**ï¼šå³°å€¼85%ï¼Œéœ€ç›‘æ§
5. âœ… **ç½‘ç»œIO**ï¼šå¹³å‡300Mbpsï¼Œæœªé¥±å’Œ

### 6.6 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•

#### 6.6.1 éƒ¨ç½²å‰æ£€æŸ¥

**åŸºç¡€è®¾æ–½ï¼š**
- [ ] æœåŠ¡å™¨èµ„æºå……è¶³ï¼ˆCPU 8æ ¸+ã€å†…å­˜ 16GB+ã€ç£ç›˜ 200GB+ï¼‰
- [ ] æ•°æ®åº“ä¸»ä»é…ç½®å®Œæˆï¼Œè¯»å†™åˆ†ç¦»
- [ ] Redisé›†ç¾¤éƒ¨ç½²ï¼ˆ3ä¸»3ä»ï¼‰
- [ ] è´Ÿè½½å‡è¡¡é…ç½®ï¼ˆè‡³å°‘2ä¸ªåº”ç”¨èŠ‚ç‚¹ï¼‰
- [ ] ç½‘ç»œå¸¦å®½å……è¶³ï¼ˆ10Gbps+ï¼‰

**åº”ç”¨é…ç½®ï¼š**
- [ ] è¿æ¥æ± å‚æ•°å·²ä¼˜åŒ–
- [ ] JVMå‚æ•°å·²è°ƒä¼˜ï¼ˆ-Xms8g -Xmx8g -XX:+UseG1GCï¼‰
- [ ] æ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºINFOï¼ˆDEBUGä»…åœ¨æ’æŸ¥é—®é¢˜æ—¶ä½¿ç”¨ï¼‰
- [ ] å¼‚æ­¥çº¿ç¨‹æ± é…ç½®åˆç†
- [ ] è¶…æ—¶å‚æ•°å·²é…ç½®

**ç¼“å­˜ç­–ç•¥ï¼š**
- [ ] ç¼“å­˜é¢„çƒ­è„šæœ¬å‡†å¤‡å®Œæ¯•
- [ ] ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®åˆç†
- [ ] å¸ƒéš†è¿‡æ»¤å™¨å·²åˆå§‹åŒ–
- [ ] ç¼“å­˜é™çº§æ–¹æ¡ˆå·²æµ‹è¯•

**ç›‘æ§å‘Šè­¦ï¼š**
- [ ] Prometheusç›‘æ§å·²éƒ¨ç½²
- [ ] Grafana Dashboardå·²é…ç½®
- [ ] å‘Šè­¦è§„åˆ™å·²è®¾ç½®
- [ ] å‘Šè­¦é€šçŸ¥æ¸ é“å·²é…ç½®ï¼ˆé’‰é’‰/é‚®ä»¶/çŸ­ä¿¡ï¼‰

**å®‰å…¨é˜²æŠ¤ï¼š**
- [ ] æ¥å£é™æµå·²å¯ç”¨ï¼ˆæ¯ç§’1000æ¬¡ï¼‰
- [ ] IPç™½åå•å·²é…ç½®
- [ ] SQLæ³¨å…¥é˜²æŠ¤å·²å¯ç”¨
- [ ] XSSé˜²æŠ¤å·²å¯ç”¨

#### 6.6.2 è¿è¡Œæ—¶ç›‘æ§

**å…³é”®æŒ‡æ ‡ï¼š**
```bash
# 1. åº”ç”¨å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health

# 2. æŸ¥çœ‹çº¿ç¨‹æ± çŠ¶æ€
curl http://localhost:8080/actuator/metrics/executor.pool.size

# 3. æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡
curl http://localhost:8080/actuator/metrics/cache.gets?tag=result:hit

# 4. æŸ¥çœ‹éªŒè¯QPS
curl http://localhost:8080/actuator/metrics/validation.total

# 5. æŸ¥çœ‹P95å“åº”æ—¶é—´
curl http://localhost:8080/actuator/metrics/validation.duration?percentile=0.95
```

**æ—¥å¸¸å·¡æ£€ï¼š**
```bash
#!/bin/bash
# daily_check.sh - æ¯æ—¥å¥åº·æ£€æŸ¥è„šæœ¬

echo "=== POSIDæƒé™éªŒè¯ç³»ç»Ÿå¥åº·æ£€æŸ¥ ==="
echo "æ£€æŸ¥æ—¶é—´: $(date)"

# 1. æ£€æŸ¥åº”ç”¨çŠ¶æ€
echo -n "åº”ç”¨çŠ¶æ€: "
curl -s http://localhost:8080/actuator/health | jq -r '.status'

# 2. æ£€æŸ¥éªŒè¯QPS
echo -n "å½“å‰QPS: "
curl -s http://localhost:8080/actuator/metrics/validation.total | jq -r '.measurements[0].value'

# 3. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
echo -n "ç¼“å­˜å‘½ä¸­ç‡: "
cache_hit_rate=$(redis-cli get "cache:hit:rate")
echo "${cache_hit_rate}%"

# 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo -n "æ•°æ®åº“è¿æ¥æ± : "
curl -s http://localhost:8080/actuator/metrics/hikaricp.connections.active | jq -r '.measurements[0].value'

# 5. æ£€æŸ¥Redisè¿æ¥
echo -n "Redisè¿æ¥: "
redis-cli ping

# 6. æ£€æŸ¥ç£ç›˜ç©ºé—´
echo "ç£ç›˜ä½¿ç”¨ç‡:"
df -h | grep -E "/$|/data"

# 7. æ£€æŸ¥å†…å­˜ä½¿ç”¨
echo "å†…å­˜ä½¿ç”¨ç‡:"
free -h

echo "=== æ£€æŸ¥å®Œæˆ ==="
```

#### 6.6.3 æ•…éšœåº”æ€¥é¢„æ¡ˆ

**åœºæ™¯1ï¼šRedisæ•…éšœ**
```bash
# 1. ç«‹å³åˆ‡æ¢åˆ°æœ¬åœ°ç¼“å­˜æ¨¡å¼
curl -X POST http://localhost:8080/admin/cache/fallback/enable

# 2. æ£€æŸ¥Redisé›†ç¾¤çŠ¶æ€
redis-cli --cluster check redis-node1:6379

# 3. é‡å¯RedisèŠ‚ç‚¹ï¼ˆå¦‚éœ€è¦ï¼‰
systemctl restart redis

# 4. æ¢å¤æ­£å¸¸åï¼Œé‡æ–°å¯ç”¨Redis
curl -X POST http://localhost:8080/admin/cache/fallback/disable
```

**åœºæ™¯2ï¼šæ•°æ®åº“è¿æ¥æ± è€—å°½**
```bash
# 1. ç´§æ€¥æ‰©å®¹è¿æ¥æ± 
curl -X POST http://localhost:8080/admin/datasource/pool/resize?size=200

# 2. æ£€æŸ¥æ…¢æŸ¥è¯¢
mysql -e "SELECT * FROM information_schema.processlist WHERE time > 10;"

# 3. Killé•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
mysql -e "KILL <thread_id>;"

# 4. é‡å¯åº”ç”¨ï¼ˆæœ€åæ‰‹æ®µï¼‰
systemctl restart posid-service
```

**åœºæ™¯3ï¼šåº”ç”¨å“åº”å˜æ…¢**
```bash
# 1. ç”Ÿæˆçº¿ç¨‹dump
jstack <pid> > thread_dump.txt

# 2. ç”Ÿæˆå †dump
jmap -dump:format=b,file=heap_dump.hprof <pid>

# 3. å¯ç”¨ç´§æ€¥é™çº§æ¨¡å¼
curl -X POST http://localhost:8080/admin/validation/emergency-mode/enable

# 4. åˆ†ædumpæ–‡ä»¶
jhat heap_dump.hprof
```

---

## ğŸ“ æ›´æ–°è¯´æ˜

### v2.0 (2025-10-31)

**æ ¸å¿ƒæ›´æ–°**ï¼š
- âœ… æ–°å¢"ç»è¥æ¨¡å¼ä¸æƒé™éªŒè¯å…³ç³»"ç« èŠ‚
- âœ… è¡¥å……é¤åˆ«åˆ¶/è¶…å¸‚åˆ¶/æ··åˆæ¨¡å¼çš„å·®å¼‚åŒ–éªŒè¯è§„åˆ™
- âœ… æ–°å¢éªŒè¯è§„åˆ™çŸ©é˜µæµç¨‹å›¾
- âœ… æ˜ç¡®ä¸åŒæ¨¡å¼ä¸‹çš„é€‚ç”¨éªŒè¯ç‚¹å’Œä¸é€‚ç”¨éªŒè¯ç‚¹

**ä¸šåŠ¡å½±å“**ï¼š
- æƒé™éªŒè¯ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæ ¹æ®åŒºåŸŸçš„`manage_mode`å­—æ®µåŠ¨æ€è°ƒæ•´éªŒè¯é“¾
- é¤åˆ«åˆ¶åŒºåŸŸå¼ºåˆ¶éªŒè¯é¤åˆ«æƒé™å’Œå°±é¤æ—¶é—´
- è¶…å¸‚åˆ¶åŒºåŸŸå¼ºåˆ¶éªŒè¯å•†å“æƒé™å’Œåº“å­˜
- æ··åˆæ¨¡å¼æ”¯æŒç”¨æˆ·é€‰æ‹©æ¶ˆè´¹æ–¹å¼å¹¶åŠ¨æ€éªŒè¯

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-31  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šPOSID v3.13.1+

