# 13-报表统计模块重构设计

## 📋 模块概述

**重构目标**：构建完整的数据统计分析体系，为业务决策提供数据支撑。

**核心问题**：
- 报表统计逻辑分散
- 统计维度单一
- 实时统计性能差
- 缺乏数据可视化
- **缺少经营模式和区域类型统计维度**

**重构收益**：
- ✅ 统一的报表服务
- ✅ 多维度数据分析
- ✅ 实时+离线双重统计
- ✅ 丰富的图表展示
- ✅ **新增经营模式和定值来源统计维度**

---

## 🏗️ 新增统计维度

### 核心统计维度补充

**新增4个统计维度**：

| 统计维度 | 字段来源 | 统计价值 | 报表示例 |
|---------|---------|---------|---------|
| **经营模式** | `manage_mode` | 对比不同模式的经营效益 | 餐别制vs超市制营收对比 |
| **区域类型** | `area_sub_type` | 分析不同场所的消费特征 | 食堂/餐厅/超市消费分析 |
| **定值来源** | 消费流水中的定值来源标记 | 评估配置优先级合理性 | 账户定值/区域定值/系统默认占比 |
| **是否考勤消费** | `is_attendance_consume` | 区分就餐消费与其他消费 | 考勤消费vs非考勤消费统计 |

### 统计报表矩阵

| 报表类型 | 原有维度 | 新增维度 | 业务价值 |
|---------|---------|---------|---------|
| **消费流水报表** | 时间、区域、人员 | + 经营模式、区域类型 | 多维度消费分析 |
| **金额统计报表** | 现金、补贴 | + 定值来源 | 优化定值配置策略 |
| **区域经营报表** | 区域、餐别 | + 经营模式、区域类型 | 经营模式效益对比 |
| **考勤消费报表** | NEW | 是否考勤消费 | 就餐率统计分析 |

### 业务分析场景

**场景1：经营模式对比分析**
```
SELECT 
  manage_mode,
  COUNT(*) as 消费笔数,
  SUM(amount) as 总消费金额,
  AVG(amount) as 平均消费金额
FROM POSID_TRANSACTION
WHERE consume_time BETWEEN '2025-10-01' AND '2025-10-31'
GROUP BY manage_mode
```

**场景2：定值来源分析**
```
SELECT 
  amount_source,  -- 账户定值/区域定值/系统默认
  COUNT(*) as 使用次数,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as 占比
FROM POSID_TRANSACTION
WHERE manage_mode = 1  -- 仅餐别制
GROUP BY amount_source
```

**场景3：区域类型经营效益**
```
SELECT 
  area_sub_type,
  manage_mode,
  SUM(amount) as 营收,
  COUNT(DISTINCT person_id) as 消费人数
FROM POSID_TRANSACTION
GROUP BY area_sub_type, manage_mode
ORDER BY 营收 DESC
```

---

## 🔄 业务流程设计
## 📋 IOE-DREAM七微服务架构

**核心架构组成**:
- **Gateway Service (8080)**: API网关
- **Common Service (8088)**: 公共模块微服务
- **DeviceComm Service (8087)**: 设备通讯微服务
- **OA Service (8089)**: OA微服务
- **Access Service (8090)**: 门禁服务
- **Attendance Service (8091)**: 考勤服务
- **Video Service (8092)**: 视频服务
- **Consume Service (8094)**: 消费服务
- **Visitor Service (8095)**: 访客服务

**架构特点**:
- 基于Spring Boot 3.5.8 + Java 17
- 严格遵循企业级微服务规范
- 支持高并发、高可用、水平扩展

**技术栈标准**:
- **数据库**: MySQL 8.0 + Druid连接池
- **缓存**: Redis + Caffeine多级缓存
- **注册中心**: Nacos
- **配置中心**: Nacos Config
- **认证授权**: Sa-Token

## 🏗️ 四层架构规范

**标准架构模式**:
```
Controller (接口控制层)
    ↓
Service (核心业务层)
    ↓
Manager (流程管理层)
    ↓
DAO (数据访问层)
```

**层级职责**:
- **Controller层**: HTTP请求处理、参数验证、权限控制
- **Service层**: 核心业务逻辑、事务管理、业务规则验证
- **Manager层**: 复杂流程编排、多数据组装、第三方服务集成
- **DAO层**: 数据库CRUD操作、SQL查询实现、数据访问边界

**严格禁止跨层访问**: Controller不能直接调用Manager/DAO！
### 1.1 报表查询流程
## ⚠️ IOE-DREAM零容忍规则（强制执行）

**必须遵守的架构规则**:
- ✅ **必须使用 @Resource 注入依赖**
- ✅ **必须使用 @Mapper 注解** (禁止@Repository)
- ✅ **必须使用 Dao 后缀** (禁止Repository)
- ✅ **必须使用 @RestController 注解**
- ✅ **必须使用 @Valid 参数校验**
- ✅ **必须返回统一ResponseDTO格式**
- ✅ **必须遵循四层架构边界**

**严格禁止事项**:
- ❌ **禁止使用 @Autowired 注入**
- ❌ **禁止使用 @Repository 注解**
- ❌ **禁止使用 Repository 后缀命名**
- ❌ **禁止跨层访问**
- ❌ **禁止在Controller中包含业务逻辑**
- ❌ **禁止直接访问数据库**

**违规后果**: P0级问题，立即修复，禁止合并！

```mermaid
flowchart TD
    A[用户查询报表] --> B[选择报表类型]
    
    B --> C{报表类型}
    C -->|消费统计| D1[消费报表参数]
    C -->|订餐统计| D2[订餐报表参数]
    C -->|充值统计| D3[充值报表参数]
    C -->|考勤统计| D4[考勤报表参数]
    C -->|财务对账| D5[对账报表参数]
    
    D1 --> E[设置查询条件]
    D2 --> E
    D3 --> E
    D4 --> E
    D5 --> E
    
    E --> F[时间范围]
    F --> G[统计维度]
    G --> H[筛选条件]
    
    H --> I{查询类型}
    I -->|实时查询| J1[查询Redis缓存]
    I -->|离线查询| J2[查询统计表]
    
    J1 --> K1{缓存命中?}
    K1 -->|是| L[返回数据]
    K1 -->|否| M[实时计算]
    M --> N[写入缓存]
    N --> L
    
    J2 --> L
    
    L --> O[数据聚合]
    O --> P[格式化输出]
    P --> Q[生成图表]
    Q --> R[返回报表]
    
    style R fill:#51cf66
```

### 1.2 实时统计流程

```mermaid
flowchart TD
    A[业务事件发生] --> B{事件类型}
    
    B -->|消费| C1[消费事件]
    B -->|订餐| C2[订餐事件]
    B -->|充值| C3[充值事件]
    
    C1 --> D[发送到MQ]
    C2 --> D
    C3 --> D
    
    D --> E[统计消费者接收]
    E --> F[解析事件数据]
    
    F --> G[更新实时统计]
    G --> H1[今日消费总额]
    G --> H2[今日消费人数]
    G --> H3[各区域消费]
    G --> H4[各餐别消费]
    G --> H5[各时段消费]
    
    H1 --> I[Redis INCR]
    H2 --> I
    H3 --> I
    H4 --> I
    H5 --> I
    
    I --> J[更新成功]
    
    style J fill:#51cf66
```

### 1.3 离线统计流程

```mermaid
flowchart TD
    A[定时任务触发] --> B{统计周期}
    
    B -->|每小时| C1[小时统计]
    B -->|每日凌晨| C2[日统计]
    B -->|每周一| C3[周统计]
    B -->|每月1号| C4[月统计]
    
    C1 --> D[确定统计时间范围]
    C2 --> D
    C3 --> D
    C4 --> D
    
    D --> E[从原始交易表查询]
    E --> F[按维度分组聚合]
    
    F --> G1[按区域统计]
    F --> G2[按餐别统计]
    F --> G3[按卡类统计]
    F --> G4[按时段统计]
    F --> G5[按设备统计]
    
    G1 --> H[写入统计表]
    G2 --> H
    G3 --> H
    G4 --> H
    G5 --> H
    
    H --> I[更新汇总表]
    I --> J[生成统计报告]
    J --> K[发送邮件通知]
    K --> L[统计完成]
    
    style L fill:#51cf66
```

### 1.4 多维分析流程

```mermaid
flowchart TD
    A[多维分析查询] --> B[选择分析维度]
    
    B --> C{主维度}
    C -->|时间维度| D1[年/季/月/周/日]
    C -->|空间维度| D2[区域/餐厅/设备]
    C -->|人员维度| D3[部门/卡类/个人]
    C -->|业务维度| D4[餐别/商品/定值]
    
    D1 --> E[选择对比维度]
    D2 --> E
    D3 --> E
    D4 --> E
    
    E --> F{对比维度}
    F -->|同比| G1[去年同期]
    F -->|环比| G2[上个周期]
    F -->|占比| G3[总量占比]
    
    G1 --> H[执行多维查询]
    G2 --> H
    G3 --> H
    
    H --> I[OLAP计算]
    I --> J[数据聚合]
    J --> K[生成对比图表]
    K --> L[返回分析结果]
    
    style L fill:#51cf66
```

---

## 🗄️ 数据库设计

### 2.1 ER关系图

```mermaid
erDiagram
    POSID_STAT_DAILY ||--o{ POSID_STAT_DAILY_AREA : "区域维度"
    POSID_STAT_DAILY ||--o{ POSID_STAT_DAILY_MEAL : "餐别维度"
    POSID_STAT_DAILY ||--o{ POSID_STAT_DAILY_KIND : "卡类维度"
    POSID_STAT_MONTHLY ||--o{ POSID_STAT_MONTHLY_AREA : "月度区域"
    
    POSID_STAT_DAILY {
        VARCHAR id PK "统计ID"
        DATE stat_date UK "统计日期"
        INT total_count "消费总笔数"
        INT total_money "消费总金额"
        INT person_count "消费人数"
        INT attendance_count "考勤人数"
        INT order_count "订餐笔数"
        INT recharge_count "充值笔数"
        INT recharge_money "充值金额"
        DATETIME create_time "创建时间"
    }
    
    POSID_STAT_DAILY_AREA {
        VARCHAR id PK "明细ID"
        DATE stat_date "统计日期"
        VARCHAR area_id FK "区域ID"
        VARCHAR area_name "区域名称"
        INT consume_count "消费笔数"
        INT consume_money "消费金额"
        INT person_count "消费人数"
    }
    
    POSID_STAT_DAILY_MEAL {
        VARCHAR id PK "明细ID"
        DATE stat_date "统计日期"
        VARCHAR meal_id FK "餐别ID"
        VARCHAR meal_name "餐别名称"
        INT consume_count "消费笔数"
        INT consume_money "消费金额"
        INT person_count "消费人数"
    }
    
    POSID_STAT_DAILY_KIND {
        VARCHAR id PK "明细ID"
        DATE stat_date "统计日期"
        VARCHAR account_kind_id FK "卡类ID"
        VARCHAR account_kind_name "卡类名称"
        INT consume_count "消费笔数"
        INT consume_money "消费金额"
        INT person_count "消费人数"
        BOOLEAN is_attendance "是否考勤"
    }
    
    POSID_STAT_MONTHLY {
        VARCHAR id PK "统计ID"
        VARCHAR stat_month UK "统计月份"
        INT total_count "消费总笔数"
        INT total_money "消费总金额"
        INT person_count "消费人数"
        INT avg_daily_money "日均消费"
        INT peak_day_money "单日最高"
    }
    
    POSID_STAT_MONTHLY_AREA {
        VARCHAR id PK "明细ID"
        VARCHAR stat_month "统计月份"
        VARCHAR area_id FK "区域ID"
        INT consume_count "消费笔数"
        INT consume_money "消费金额"
    }
```

### 2.2 统计维度体系

```mermaid
graph TB
    subgraph 统计维度体系
        A[报表统计]
        
        B1[时间维度]
        B2[空间维度]
        B3[人员维度]
        B4[业务维度]
        
        C1[实时/小时/日/周/月/季/年]
        C2[区域/餐厅/设备]
        C3[部门/卡类/个人]
        C4[餐别/商品/定值模式]
        
        D1[消费金额]
        D2[消费笔数]
        D3[消费人数]
        D4[人均消费]
        D5[客单价]
    end
    
    A --> B1
    A --> B2
    A --> B3
    A --> B4
    
    B1 --> C1
    B2 --> C2
    B3 --> C3
    B4 --> C4
    
    C1 --> D1
    C1 --> D2
    C1 --> D3
    C1 --> D4
    C1 --> D5
    
    style A fill:#4ecdc4
    style B1 fill:#ff6b6b
    style B2 fill:#ffd93d
    style B3 fill:#74b9ff
    style B4 fill:#a29bfe
```

### 2.3 核心报表清单

```mermaid
mindmap
  root((报表系统))
    消费类报表
      消费日报
      消费月报
      消费趋势分析
      消费排行榜
      异常消费报表
    订餐类报表
      订餐统计
      取餐率分析
      订餐趋势
      浪费率分析
    财务类报表
      充值统计
      退款统计
      收支汇总
      对账报表
    考勤类报表
      考勤日报
      出勤率统计
      缺勤分析
    运营类报表
      设备使用率
      高峰时段分析
      区域热力图
      商品销售TOP
```

### 2.4 报表数据流

```mermaid
flowchart LR
    subgraph 数据源
        A1[消费交易]
        A2[订餐记录]
        A3[充值记录]
    end
    
    subgraph 实时层
        B1[Redis实时统计]
        B2[今日数据]
    end
    
    subgraph 离线层
        C1[小时统计表]
        C2[日统计表]
        C3[月统计表]
    end
    
    subgraph 展现层
        D1[实时大屏]
        D2[日报邮件]
        D3[BI系统]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    
    B1 --> C1
    C1 --> C2
    C2 --> C3
    
    B1 --> D1
    C2 --> D2
    C3 --> D3
    
    style B1 fill:#ff6b6b
    style C2 fill:#ffd93d
    style D1 fill:#51cf66
```

---

## 💾 缓存策略设计

### 3.1 实时统计缓存

| 缓存项 | Redis Key | 数据结构 | 过期时间 | 说明 |
|-------|-----------|---------|---------|------|
| 今日消费总额 | `stat:today:money` | String | 到23:59 | INCR累加 |
| 今日消费人数 | `stat:today:persons` | Set | 到23:59 | SADD去重 |
| 各区域消费 | `stat:today:area` | Hash | 到23:59 | HINCRBY |
| 各餐别消费 | `stat:today:meal` | Hash | 到23:59 | HINCRBY |
| 实时排行榜 | `stat:today:rank:area` | ZSet | 到23:59 | ZINCRBY |

### 3.2 报表缓存

| 缓存项 | Redis Key | 过期时间 | 说明 |
|-------|-----------|---------|------|
| 昨日报表 | `report:daily:{date}` | 7天 | 历史报表 |
| 月度报表 | `report:monthly:{month}` | 90天 | 月度汇总 |
| 热门查询 | `report:hot:{hash}` | 1小时 | 常用查询 |

---

## 📊 核心报表设计

### 4.1 消费日报

**统计内容：**
- 消费总笔数、总金额、人数、人均
- 各区域消费排行TOP10
- 各餐别消费分布
- 各时段消费高峰
- 考勤人数统计
- 同比、环比数据

**图表类型：**
- 折线图：消费趋势
- 柱状图：各区域对比
- 饼图：餐别占比
- 热力图：时段分布

### 4.2 考勤统计报表

**统计内容：**
- 考勤总人数（is_attendance_consume=TRUE）
- 各部门出勤率
- 缺勤人员名单
- 考勤异常分析

### 4.3 财务对账报表

**统计内容：**
- 充值总额、笔数、渠道分布
- 消费总额、笔数
- 退款总额、笔数
- 账户余额总额
- 补贴发放、使用、清零
- 收支平衡校验

---

## 🎯 总结

### 关键设计

✅ **实时统计**：Redis实时聚合，秒级刷新  
✅ **离线统计**：定时任务批量计算，T+1可查  
✅ **多维分析**：时间/空间/人员/业务4大维度  
✅ **图表丰富**：折线/柱状/饼图/热力图多种展示  
✅ **自动推送**：日报邮件、异常告警自动发送

### 支持场景

- 📊 **管理决策**：经营数据分析、趋势预测
- 💰 **财务核算**：收支统计、对账报表
- 👥 **人事考勤**：出勤率统计、缺勤分析
- 🏪 **运营优化**：高峰分析、资源调配

---

## 📝 更新说明

### v2.0 (2025-10-31)
- ✅ 新增4个统计维度（经营模式、区域类型、定值来源、是否考勤消费）
- ✅ 补充统计报表矩阵
- ✅ 新增3个业务分析场景示例

---

**文档版本**：v2.0  
**创建时间**：2025-10-31  
**适用版本**：POSID v3.13.1+

