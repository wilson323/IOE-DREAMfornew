# 02-é¤åˆ«åˆ†ç±»ä½“ç³»é‡æ„è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

**é‡æ„ç›®æ ‡**ï¼šä¸ºé¤åˆ«å¼•å…¥äºŒçº§åˆ†ç±»ä½“ç³»ï¼Œæ”¯æŒ"å¤§ç±»åˆ«â†’å°é¤åˆ«"çš„å±‚çº§ç®¡ç†ï¼Œæå‡æƒé™æ§åˆ¶çµæ´»æ€§ã€‚

**æ ¸å¿ƒé—®é¢˜**ï¼š
- ç°æœ‰é¤åˆ«æ˜¯æ‰å¹³ç»“æ„ï¼Œæ— åˆ†ç±»æ¦‚å¿µ
- æ— æ³•è¡¨è¾¾"å…è®¸æ‰€æœ‰æ—©é¤"è¿™ç±»éœ€æ±‚
- é…ç½®å¤æ‚åº¦ä¸ºNÃ—Mï¼ˆè´¦æˆ·ç±»åˆ«Ã—é¤åˆ«æ•°é‡ï¼‰
- è·¨åœºæ™¯æ‰©å±•å›°éš¾
- **æœªæ˜ç¡®é¤åˆ«åˆ†ç±»ä¸ç»è¥æ¨¡å¼çš„å…³ç³»**

**é‡æ„æ”¶ç›Š**ï¼š
- âœ… å¼•å…¥äºŒçº§åˆ†ç±»ï¼ˆé¤åˆ«åˆ†ç±»â†’å…·ä½“é¤åˆ«ï¼‰
- âœ… é…ç½®å¤æ‚åº¦é™ä½70%
- âœ… æ”¯æŒåˆ†ç±»çº§åˆ«æƒé™æ§åˆ¶
- âœ… çµæ´»é€‚é…å¤šç§åœºæ™¯
- âœ… **æ˜ç¡®é¤åˆ«åœ¨ä¸åŒç»è¥æ¨¡å¼ä¸­çš„ä½œç”¨**

---

## ğŸ—ï¸ é¤åˆ«åˆ†ç±»ä¸ç»è¥æ¨¡å¼å…³ç³»

### æ ¸å¿ƒåŸåˆ™

**é¤åˆ«åˆ†ç±»ä¸»è¦æœåŠ¡äºé¤åˆ«åˆ¶å’Œæ··åˆæ¨¡å¼åŒºåŸŸ**ï¼š

| ç»è¥æ¨¡å¼ | æ˜¯å¦éœ€è¦é¤åˆ« | é…ç½®è¦æ±‚ | ä½¿ç”¨åœºæ™¯ |
|---------|-------------|---------|---------|
| **é¤åˆ«åˆ¶<br/>(manage_mode=1)** | âœ… **å¿…éœ€** | å¿…é¡»é…ç½®è‡³å°‘1ä¸ªé¤åˆ«åˆ†ç±»å’Œé¤åˆ« | é£Ÿå ‚ã€é¤å…ç­‰å›ºå®šé¤æ¬¡åœºæ™¯ |
| **è¶…å¸‚åˆ¶<br/>(manage_mode=2)** | âŒ **ä¸éœ€è¦** | æ— éœ€é…ç½®é¤åˆ« | è¶…å¸‚ã€ä¾¿åˆ©åº—ç­‰å•†å“æ‰«ç åœºæ™¯ |
| **æ··åˆæ¨¡å¼<br/>(manage_mode=3)** | âš ï¸ **å¯é€‰** | å¦‚æœæ”¯æŒå®šå€¼æ¶ˆè´¹åˆ™éœ€é…ç½® | æ—¢æ”¯æŒå®šå€¼ä¹Ÿæ”¯æŒå•†å“çš„ç»¼åˆåœºæ™¯ |

### é¤åˆ«é…ç½®è§„åˆ™

```mermaid
flowchart TD
    A[åˆ›å»ºåŒºåŸŸ] --> B{ç»è¥æ¨¡å¼?}
    
    B -->|manage_mode=1<br/>é¤åˆ«åˆ¶| C1[å¿…é¡»é…ç½®é¤åˆ«]
    B -->|manage_mode=2<br/>è¶…å¸‚åˆ¶| C2[è·³è¿‡é¤åˆ«é…ç½®]
    B -->|manage_mode=3<br/>æ··åˆæ¨¡å¼| C3{æ˜¯å¦æ”¯æŒå®šå€¼?}
    
    C1 --> D1[æ­¥éª¤1: åˆ›å»ºé¤åˆ«åˆ†ç±»]
    D1 --> D2[æ­¥éª¤2: åˆ›å»ºå…·ä½“é¤åˆ«]
    D2 --> D3[æ­¥éª¤3: é…ç½®æ—¶é—´çª—å£]
    D3 --> D4[æ­¥éª¤4: å…³è”åŒºåŸŸ]
    D4 --> E1[é…ç½®å®Œæˆ<br/>âœ… æ”¯æŒå®šå€¼æ¶ˆè´¹]
    
    C2 --> E2[é…ç½®å®Œæˆ<br/>âœ… ä»…æ”¯æŒå•†å“æ¶ˆè´¹]
    
    C3 -->|æ˜¯| D1
    C3 -->|å¦| E3[è·³è¿‡é¤åˆ«é…ç½®<br/>âœ… ä»…æ”¯æŒå•†å“æ¶ˆè´¹]
```

### åŒºåŸŸé¤åˆ«å…³è”è§„åˆ™

**åŒºåŸŸè¡¨(`POSID_AREA`)çš„`meal_categories`å­—æ®µ**ï¼š

| ç»è¥æ¨¡å¼ | meal_categorieså­—æ®µå€¼ | è¯´æ˜ |
|---------|---------------------|------|
| é¤åˆ«åˆ¶(1) | `["breakfast","lunch","dinner"]` | å¿…éœ€ï¼ŒåŒ…å«è¯¥åŒºåŸŸæ”¯æŒçš„é¤åˆ«åˆ†ç±» |
| è¶…å¸‚åˆ¶(2) | `null` æˆ– `[]` | å¯ä¸ºç©ºï¼Œä¸ä½¿ç”¨é¤åˆ« |
| æ··åˆæ¨¡å¼(3) | `["breakfast","lunch"]` æˆ– `null` | å¯é€‰ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚é…ç½® |

**ä¸šåŠ¡è§„åˆ™**ï¼š
1. **é¤åˆ«åˆ¶åŒºåŸŸ**ï¼šå¦‚æœ`manage_mode=1`ï¼Œåˆ™`meal_categories`ä¸èƒ½ä¸ºç©º
2. **è¶…å¸‚åˆ¶åŒºåŸŸ**ï¼šå¦‚æœ`manage_mode=2`ï¼Œåˆ™å¿½ç•¥`meal_categories`å­—æ®µ
3. **æ··åˆæ¨¡å¼åŒºåŸŸ**ï¼š
   - å¦‚æœé…ç½®äº†`meal_categories`ï¼Œåˆ™æ”¯æŒå®šå€¼æ¶ˆè´¹
   - å¦‚æœæœªé…ç½®ï¼Œåˆ™ä»…æ”¯æŒå•†å“æ¶ˆè´¹

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡
## ğŸ“‹ IOE-DREAMä¸ƒå¾®æœåŠ¡æ¶æ„

**æ ¸å¿ƒæ¶æ„ç»„æˆ**:
- **Gateway Service (8080)**: APIç½‘å…³
- **Common Service (8088)**: å…¬å…±æ¨¡å—å¾®æœåŠ¡
- **DeviceComm Service (8087)**: è®¾å¤‡é€šè®¯å¾®æœåŠ¡
- **OA Service (8089)**: OAå¾®æœåŠ¡
- **Access Service (8090)**: é—¨ç¦æœåŠ¡
- **Attendance Service (8091)**: è€ƒå‹¤æœåŠ¡
- **Video Service (8092)**: è§†é¢‘æœåŠ¡
- **Consume Service (8094)**: æ¶ˆè´¹æœåŠ¡
- **Visitor Service (8095)**: è®¿å®¢æœåŠ¡

**æ¶æ„ç‰¹ç‚¹**:
- åŸºäºSpring Boot 3.5.8 + Java 17
- ä¸¥æ ¼éµå¾ªä¼ä¸šçº§å¾®æœåŠ¡è§„èŒƒ
- æ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨ã€æ°´å¹³æ‰©å±•

**æŠ€æœ¯æ ˆæ ‡å‡†**:
- **æ•°æ®åº“**: MySQL 8.0 + Druidè¿æ¥æ± 
- **ç¼“å­˜**: Redis + Caffeineå¤šçº§ç¼“å­˜
- **æ³¨å†Œä¸­å¿ƒ**: Nacos
- **é…ç½®ä¸­å¿ƒ**: Nacos Config
- **è®¤è¯æˆæƒ**: Sa-Token

## ğŸ—ï¸ å››å±‚æ¶æ„è§„èŒƒ

**æ ‡å‡†æ¶æ„æ¨¡å¼**:
```
Controller (æ¥å£æ§åˆ¶å±‚)
    â†“
Service (æ ¸å¿ƒä¸šåŠ¡å±‚)
    â†“
Manager (æµç¨‹ç®¡ç†å±‚)
    â†“
DAO (æ•°æ®è®¿é—®å±‚)
```

**å±‚çº§èŒè´£**:
- **Controllerå±‚**: HTTPè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ã€æƒé™æ§åˆ¶
- **Serviceå±‚**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™éªŒè¯
- **Managerå±‚**: å¤æ‚æµç¨‹ç¼–æ’ã€å¤šæ•°æ®ç»„è£…ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- **DAOå±‚**: æ•°æ®åº“CRUDæ“ä½œã€SQLæŸ¥è¯¢å®ç°ã€æ•°æ®è®¿é—®è¾¹ç•Œ

**ä¸¥æ ¼ç¦æ­¢è·¨å±‚è®¿é—®**: Controllerä¸èƒ½ç›´æ¥è°ƒç”¨Manager/DAOï¼
### 1.1 é¤åˆ«åˆ†ç±»åˆ›å»ºæµç¨‹
## âš ï¸ IOE-DREAMé›¶å®¹å¿è§„åˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å¿…é¡»éµå®ˆçš„æ¶æ„è§„åˆ™**:
- âœ… **å¿…é¡»ä½¿ç”¨ @Resource æ³¨å…¥ä¾èµ–**
- âœ… **å¿…é¡»ä½¿ç”¨ @Mapper æ³¨è§£** (ç¦æ­¢@Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ Dao åç¼€** (ç¦æ­¢Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ @RestController æ³¨è§£**
- âœ… **å¿…é¡»ä½¿ç”¨ @Valid å‚æ•°æ ¡éªŒ**
- âœ… **å¿…é¡»è¿”å›ç»Ÿä¸€ResponseDTOæ ¼å¼**
- âœ… **å¿…é¡»éµå¾ªå››å±‚æ¶æ„è¾¹ç•Œ**

**ä¸¥æ ¼ç¦æ­¢äº‹é¡¹**:
- âŒ **ç¦æ­¢ä½¿ç”¨ @Autowired æ³¨å…¥**
- âŒ **ç¦æ­¢ä½¿ç”¨ @Repository æ³¨è§£**
- âŒ **ç¦æ­¢ä½¿ç”¨ Repository åç¼€å‘½å**
- âŒ **ç¦æ­¢è·¨å±‚è®¿é—®**
- âŒ **ç¦æ­¢åœ¨Controllerä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘**
- âŒ **ç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“**

**è¿è§„åæœ**: P0çº§é—®é¢˜ï¼Œç«‹å³ä¿®å¤ï¼Œç¦æ­¢åˆå¹¶ï¼

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜è¿›å…¥é¤åˆ«ç®¡ç†] --> B[ç‚¹å‡»æ–°å¢é¤åˆ«åˆ†ç±»]
    B --> C[å¡«å†™åˆ†ç±»ä¿¡æ¯]
    
    C --> D[åˆ†ç±»ç¼–å·/åç§°]
    D --> E{é€‰æ‹©å…³è”æ–¹å¼}
    
    E -->|å…¨å±€åˆ†ç±»| F[é€‚ç”¨æ‰€æœ‰åŒºåŸŸ]
    E -->|åŒºåŸŸä¸“å±| G[é€‰æ‹©ç‰¹å®šåŒºåŸŸ]
    
    F --> H[è®¾ç½®æ’åº]
    G --> H
    
    H --> I[å¡«å†™æè¿°]
    I --> J[ä¿å­˜åˆ†ç±»]
    
    J --> K{éªŒè¯æ•°æ®}
    K -->|å¤±è´¥| L[æ˜¾ç¤ºé”™è¯¯]
    K -->|æˆåŠŸ| M[å†™å…¥æ•°æ®åº“]
    
    L --> C
    M --> N[æ›´æ–°ç¼“å­˜]
    N --> O[åˆ·æ–°åˆ†ç±»åˆ—è¡¨]
```

### 1.2 é¤åˆ«é…ç½®æµç¨‹

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜è¿›å…¥é¤åˆ«é…ç½®] --> B[é€‰æ‹©é¤åˆ«åˆ†ç±»]
    B --> C[ç‚¹å‡»æ–°å¢é¤åˆ«]
    
    C --> D[å¡«å†™åŸºç¡€ä¿¡æ¯]
    D --> E[é¤åˆ«ç¼–å·/åç§°]
    E --> F[é€‰æ‹©æ‰€å±åˆ†ç±»]
    
    F --> G[é…ç½®æ—¶é—´çª—å£]
    G --> H[å¼€å§‹æ—¶é—´/ç»“æŸæ—¶é—´]
    
    H --> I[é…ç½®ä»·æ ¼ç­–ç•¥]
    I --> J{ä»·æ ¼ç±»å‹}
    
    J -->|å›ºå®šä»·æ ¼| K[è®¾ç½®åŸºç¡€ä»·æ ¼]
    J -->|å¤šæ¡£ä»·æ ¼| L[é…ç½®ä»·æ ¼è§„åˆ™JSON]
    
    K --> M[è®¾ç½®æ’åº]
    L --> M
    
    M --> N[ä¿å­˜é¤åˆ«]
    N --> O{éªŒè¯æ•°æ®}
    
    O -->|æ—¶é—´å†²çª| P[æ˜¾ç¤ºå†²çªæç¤º]
    O -->|æˆåŠŸ| Q[å†™å…¥æ•°æ®åº“]
    
    P --> G
    Q --> R[æ›´æ–°é¤åˆ«ç¼“å­˜]
    R --> S[é€šçŸ¥åŒºåŸŸæœåŠ¡]
    S --> T[åˆ·æ–°é¤åˆ«åˆ—è¡¨]
```

### 1.3 é¤åˆ«æƒé™éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·/è®¾å¤‡
    participant A as APIå±‚
    participant P as æƒé™æœåŠ¡
    participant C as ç¼“å­˜å±‚
    participant D as æ•°æ®åº“
    
    U->>A: è¯·æ±‚æ¶ˆè´¹(åŒºåŸŸX, é¤åˆ«Y)
    A->>P: validateMealPermission(accountId, areaId, mealId)
    
    P->>C: è·å–é¤åˆ«ä¿¡æ¯
    C-->>P: é¤åˆ«è¯¦æƒ…(åŒ…å«category_id)
    
    P->>C: è·å–è´¦æˆ·ç±»åˆ«å…è®¸çš„é¤åˆ«åˆ†ç±»
    C-->>P: Cache Miss
    
    P->>D: æŸ¥è¯¢è´¦æˆ·ç±»åˆ«å…³è”é¤åˆ«åˆ†ç±»
    D-->>P: è¿”å›åˆ†ç±»åˆ—è¡¨
    P->>C: ç¼“å­˜åˆ†ç±»åˆ—è¡¨(1å°æ—¶)
    
    P->>P: æ£€æŸ¥é¤åˆ«åˆ†ç±»æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨
    alt åˆ†ç±»å…è®¸
        P->>C: æ£€æŸ¥åŒºåŸŸæ˜¯å¦æä¾›è¯¥é¤åˆ«
        C-->>P: åŒºåŸŸmeal_categoriesé…ç½®
        
        alt åŒºåŸŸæä¾›
            P->>P: æ£€æŸ¥æ—¶é—´çª—å£
            alt æ—¶é—´åŒ¹é…
                P-->>A: éªŒè¯é€šè¿‡
            else æ—¶é—´ä¸åŒ¹é…
                P-->>A: éå°±é¤æ—¶é—´
            end
        else åŒºåŸŸä¸æä¾›
            P-->>A: è¯¥åŒºåŸŸä¸æä¾›æ­¤é¤åˆ«
        end
    else åˆ†ç±»ä¸å…è®¸
        P-->>A: æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»
    end
    
    A-->>U: è¿”å›éªŒè¯ç»“æœ
```

### 1.4 é¤åˆ«æŸ¥è¯¢æµç¨‹ï¼ˆæ”¯æŒç­›é€‰ï¼‰

```mermaid
flowchart TD
    A[ç”¨æˆ·è¯·æ±‚å¯ç”¨é¤åˆ«] --> B[è·å–ç”¨æˆ·è´¦æˆ·ç±»åˆ«]
    B --> C[è·å–å½“å‰åŒºåŸŸ]
    
    C --> D[æ£€æŸ¥ç¼“å­˜]
    D --> E{ç¼“å­˜å‘½ä¸­?}
    
    E -->|æ˜¯| F[è¿”å›ç¼“å­˜æ•°æ®]
    E -->|å¦| G[æŸ¥è¯¢è´¦æˆ·ç±»åˆ«å…è®¸çš„åˆ†ç±»]
    
    G --> H[æŸ¥è¯¢åŒºåŸŸæä¾›çš„åˆ†ç±»]
    H --> I[è®¡ç®—äº¤é›†]
    
    I --> J[è·å–äº¤é›†åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«]
    J --> K[è¿‡æ»¤å½“å‰æ—¶é—´å¯ç”¨é¤åˆ«]
    
    K --> L[æŒ‰åˆ†ç±»åˆ†ç»„]
    L --> M[æŒ‰æ’åºæ’åˆ—]
    M --> N[æ„å»ºJSONç»“æœ]
    
    N --> O[å†™å…¥ç¼“å­˜10åˆ†é’Ÿ]
    O --> P[è¿”å›é¤åˆ«åˆ—è¡¨]
    
    F --> Q[å‰ç«¯æ¸²æŸ“]
    P --> Q
    
    Q --> R{åˆ†ç±»å±•ç¤º}
    R --> R1[æ—©é¤åˆ†ç±»]
    R --> R2[åˆé¤åˆ†ç±»]
    R --> R3[æ™šé¤åˆ†ç±»]
    
    R1 --> S1[æ™®é€šæ—©é¤/è±ªåæ—©é¤]
    R2 --> S2[å·¥ä½œé¤/å•†åŠ¡é¤]
    R3 --> S3[æ™®é€šæ™šé¤/ç‰¹è‰²æ™šé¤]
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 2.1 ERå…³ç³»å›¾

```mermaid
erDiagram
    POSID_MEAL_CATEGORY ||--o{ POSID_MEAL : "æ‰€å±åˆ†ç±»"
    POSID_MEAL_CATEGORY ||--o{ POSID_ACCOUNTKIND_MEAL_CATEGORY : "è´¦æˆ·ç±»åˆ«å…³è”"
    POSID_ACCOUNTKIND ||--o{ POSID_ACCOUNTKIND_MEAL_CATEGORY : "å¯ç”¨åˆ†ç±»"
    POSID_AREA }o--o{ POSID_MEAL_CATEGORY : "æä¾›çš„åˆ†ç±»(JSON)"
    POSID_MEAL ||--o{ POSID_TRANSACTION : "æ¶ˆè´¹é¤åˆ«"
    
    POSID_MEAL_CATEGORY {
        VARCHAR id PK "åˆ†ç±»ID"
        VARCHAR code UK "åˆ†ç±»ç¼–å·"
        VARCHAR name "åˆ†ç±»åç§°"
        VARCHAR area_id FK "å…³è”åŒºåŸŸ(å¯é€‰)"
        INT sort_order "æ’åº"
        VARCHAR description "æè¿°"
        BOOLEAN available "æ˜¯å¦å¯ç”¨"
        DATETIME create_time "åˆ›å»ºæ—¶é—´"
        DATETIME update_time "æ›´æ–°æ—¶é—´"
    }
    
    POSID_MEAL {
        VARCHAR id PK "é¤åˆ«ID"
        VARCHAR code UK "é¤åˆ«ç¼–å·"
        VARCHAR name "é¤åˆ«åç§°"
        VARCHAR category_id FK "æ‰€å±åˆ†ç±»ID"
        VARCHAR start_time "å¼€å§‹æ—¶é—´"
        VARCHAR end_time "ç»“æŸæ—¶é—´"
        DECIMAL base_price "åŸºç¡€ä»·æ ¼"
        TEXT price_rules "ä»·æ ¼è§„åˆ™JSON"
        INT sort_order "æ’åº"
        BOOLEAN available "æ˜¯å¦å¯ç”¨"
        DATETIME create_time "åˆ›å»ºæ—¶é—´"
        DATETIME update_time "æ›´æ–°æ—¶é—´"
    }
    
    POSID_ACCOUNTKIND_MEAL_CATEGORY {
        VARCHAR id PK "å…³è”ID"
        VARCHAR account_kind_id FK "è´¦æˆ·ç±»åˆ«ID"
        VARCHAR meal_category_id FK "é¤åˆ«åˆ†ç±»ID"
        BOOLEAN include_all_meals "æ˜¯å¦åŒ…å«åˆ†ç±»ä¸‹æ‰€æœ‰é¤åˆ«"
        DATETIME create_time "åˆ›å»ºæ—¶é—´"
    }
    
    POSID_AREA {
        VARCHAR id PK "åŒºåŸŸID"
        TEXT meal_categories "å¯ç”¨é¤åˆ«åˆ†ç±»JSON"
    }
```

### 2.2 å»ºè¡¨SQL

```sql
-- ========================================
-- é¤åˆ«åˆ†ç±»è¡¨ï¼ˆå¤§ç±»åˆ«ï¼‰
-- ========================================
CREATE TABLE POSID_MEAL_CATEGORY (
    id VARCHAR(50) PRIMARY KEY COMMENT 'é¤åˆ«åˆ†ç±»ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'åˆ†ç±»ç¼–å·',
    name VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°',
    area_id VARCHAR(50) COMMENT 'å…³è”åŒºåŸŸIDï¼ˆæŸäº›åŒºåŸŸä¸“å±åˆ†ç±»ï¼Œå¯é€‰ï¼‰',
    sort_order INT DEFAULT 0 COMMENT 'æ’åºï¼ˆå€¼è¶Šå°è¶Šé å‰ï¼‰',
    description VARCHAR(255) COMMENT 'æè¿°',
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    remark TEXT COMMENT 'å¤‡æ³¨',
    
    INDEX idx_code(code) COMMENT 'ç¼–å·ç´¢å¼•',
    INDEX idx_area(area_id) COMMENT 'åŒºåŸŸç´¢å¼•',
    INDEX idx_sort(sort_order, available) COMMENT 'æ’åºç´¢å¼•',
    
    FOREIGN KEY (area_id) REFERENCES POSID_AREA(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é¤åˆ«åˆ†ç±»è¡¨ï¼ˆå¤§ç±»åˆ«ï¼‰';

-- ========================================
-- æ›´æ–°é¤åˆ«è¡¨ï¼šæ·»åŠ åˆ†ç±»å…³è”
-- ========================================
ALTER TABLE POSID_MEAL 
ADD COLUMN category_id VARCHAR(50) COMMENT 'æ‰€å±é¤åˆ«åˆ†ç±»ID',
ADD COLUMN price_rules TEXT COMMENT 'ä»·æ ¼è§„åˆ™JSONï¼ˆæ”¯æŒå¤šæ¡£ä»·æ ¼ï¼‰',
ADD INDEX idx_category(category_id, available) COMMENT 'åˆ†ç±»ç´¢å¼•',
ADD FOREIGN KEY (category_id) REFERENCES POSID_MEAL_CATEGORY(id) ON DELETE SET NULL;

-- ========================================
-- è´¦æˆ·ç±»åˆ«-é¤åˆ«åˆ†ç±»å…³è”è¡¨
-- ========================================
CREATE TABLE POSID_ACCOUNTKIND_MEAL_CATEGORY (
    id VARCHAR(50) PRIMARY KEY COMMENT 'å…³è”ID',
    account_kind_id VARCHAR(50) NOT NULL COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    meal_category_id VARCHAR(50) NOT NULL COMMENT 'é¤åˆ«åˆ†ç±»ID',
    include_all_meals BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦åŒ…å«è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰é¤åˆ«',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_kind(account_kind_id) COMMENT 'è´¦æˆ·ç±»åˆ«ç´¢å¼•',
    INDEX idx_category(meal_category_id) COMMENT 'é¤åˆ«åˆ†ç±»ç´¢å¼•',
    UNIQUE KEY uk_kind_category(account_kind_id, meal_category_id) COMMENT 'å”¯ä¸€çº¦æŸ',
    
    FOREIGN KEY (account_kind_id) REFERENCES POSID_ACCOUNTKIND(id) ON DELETE CASCADE,
    FOREIGN KEY (meal_category_id) REFERENCES POSID_MEAL_CATEGORY(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è´¦æˆ·ç±»åˆ«-é¤åˆ«åˆ†ç±»å…³è”è¡¨';

-- ========================================
-- æ›´æ–°åŒºåŸŸè¡¨ï¼šæ·»åŠ é¤åˆ«åˆ†ç±»é…ç½®
-- ========================================
ALTER TABLE POSID_AREA
ADD COLUMN meal_categories TEXT COMMENT 'è¯¥åŒºåŸŸå¯ç”¨çš„é¤åˆ«åˆ†ç±»(JSONæ•°ç»„: ["category_id1", "category_id2"])';

-- ========================================
-- æ›´æ–°äº¤æ˜“è¡¨ï¼šè®°å½•é¤åˆ«åˆ†ç±»ä¿¡æ¯
-- ========================================
ALTER TABLE POSID_TRANSACTION
ADD COLUMN meal_category_id VARCHAR(50) COMMENT 'é¤åˆ«åˆ†ç±»ID',
ADD COLUMN meal_category_name VARCHAR(100) COMMENT 'é¤åˆ«åˆ†ç±»åç§°',
ADD INDEX idx_meal_category(meal_category_id, pos_time);
```

### 2.3 æ•°æ®è¿ç§»SQL

```sql
-- ========================================
-- æ•°æ®è¿ç§»ï¼šé¤åˆ«æ‰å¹³ç»“æ„ â†’ åˆ†ç±»ä½“ç³»
-- ========================================
START TRANSACTION;

-- Step 1: åˆ›å»ºé»˜è®¤é¤åˆ«åˆ†ç±»
INSERT INTO POSID_MEAL_CATEGORY (id, code, name, sort_order, description, available, create_time)
VALUES
    (UUID(), 'BREAKFAST', 'æ—©é¤', 1, 'æ—©é¤æ—¶æ®µ', TRUE, NOW()),
    (UUID(), 'LUNCH', 'åˆé¤', 2, 'åˆé¤æ—¶æ®µ', TRUE, NOW()),
    (UUID(), 'DINNER', 'æ™šé¤', 3, 'æ™šé¤æ—¶æ®µ', TRUE, NOW()),
    (UUID(), 'SUPPER', 'å¤œå®µ', 4, 'å¤œå®µæ—¶æ®µ', TRUE, NOW()),
    (UUID(), 'SNACK', 'ç‚¹å¿ƒ', 5, 'ç‚¹å¿ƒæ—¶æ®µ', TRUE, NOW()),
    (UUID(), 'OTHER', 'å…¶ä»–', 99, 'å…¶ä»–é¤åˆ«', TRUE, NOW());

-- Step 2: æ ¹æ®æ—¶é—´æ®µè‡ªåŠ¨åˆ†ç±»ç°æœ‰é¤åˆ«
UPDATE POSID_MEAL m
SET category_id = (
    SELECT id FROM POSID_MEAL_CATEGORY 
    WHERE code = CASE
        WHEN m.start_time < '09:00' THEN 'BREAKFAST'
        WHEN m.start_time < '14:00' THEN 'LUNCH'
        WHEN m.start_time < '20:00' THEN 'DINNER'
        WHEN m.start_time < '24:00' THEN 'SUPPER'
        ELSE 'OTHER'
    END
    LIMIT 1
);

-- Step 3: ä¸ºåŒºåŸŸé…ç½®é»˜è®¤é¤åˆ«åˆ†ç±»ï¼ˆä»åŸé¤å…-é¤åˆ«å…³è”æ¨æ–­ï¼‰
-- æ–¹æ¡ˆAï¼šä¸ºé¤é¥®ç±»å‹åŒºåŸŸé…ç½®æ‰€æœ‰é»˜è®¤åˆ†ç±»
UPDATE POSID_AREA
SET meal_categories = (
    SELECT JSON_ARRAYAGG(id)
    FROM POSID_MEAL_CATEGORY
    WHERE code IN ('BREAKFAST', 'LUNCH', 'DINNER', 'SUPPER')
)
WHERE type = 1;  -- é¤é¥®ç±»å‹åŒºåŸŸ

-- æ–¹æ¡ˆBï¼šæ ¹æ®åŒºåŸŸå®é™…å…³è”çš„é¤åˆ«æ¨æ–­ï¼ˆæ›´ç²¾ç¡®ï¼‰
UPDATE POSID_AREA a
SET meal_categories = (
    SELECT JSON_ARRAYAGG(DISTINCT m.category_id)
    FROM POSID_MEAL m
    WHERE m.dining_hall_id = a.id  -- å‡è®¾åŸè¡¨æœ‰æ­¤å…³è”
      AND m.category_id IS NOT NULL
);

-- Step 4: è¿ç§»è´¦æˆ·ç±»åˆ«-é¤åˆ«å…³è” â†’ è´¦æˆ·ç±»åˆ«-é¤åˆ«åˆ†ç±»å…³è”
-- ä»åŸæœ‰çš„å…·ä½“é¤åˆ«å…³è”æ¨æ–­å‡ºåˆ†ç±»çº§åˆ«å…³è”
INSERT INTO POSID_ACCOUNTKIND_MEAL_CATEGORY (
    id, account_kind_id, meal_category_id, include_all_meals, create_time
)
SELECT DISTINCT
    UUID() AS id,
    akm.accountkind_id,
    m.category_id,
    TRUE AS include_all_meals,  -- é»˜è®¤åŒ…å«åˆ†ç±»ä¸‹æ‰€æœ‰é¤åˆ«
    NOW() AS create_time
FROM POSID_ACCOUNTKIND_MEAL akm
JOIN POSID_MEAL m ON akm.meal_id = m.id
WHERE m.category_id IS NOT NULL;

-- Step 5: å¤„ç†æœªåˆ†ç±»çš„é¤åˆ«
-- å°†æ²¡æœ‰åˆ†ç±»çš„é¤åˆ«å½’å…¥"å…¶ä»–"åˆ†ç±»
UPDATE POSID_MEAL
SET category_id = (SELECT id FROM POSID_MEAL_CATEGORY WHERE code = 'OTHER' LIMIT 1)
WHERE category_id IS NULL;

-- Step 6: æ›´æ–°å†å²äº¤æ˜“è®°å½•çš„é¤åˆ«åˆ†ç±»ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œç”¨äºæŠ¥è¡¨åˆ†æï¼‰
UPDATE POSID_TRANSACTION t
JOIN POSID_MEAL m ON t.meal_id = m.id
SET t.meal_category_id = m.category_id,
    t.meal_category_name = (SELECT name FROM POSID_MEAL_CATEGORY WHERE id = m.category_id);

-- Step 7: éªŒè¯è¿ç§»ç»“æœ
SELECT 'åˆ›å»ºçš„é¤åˆ«åˆ†ç±»æ•°é‡:', COUNT(*) FROM POSID_MEAL_CATEGORY;
SELECT 'å·²åˆ†ç±»çš„é¤åˆ«æ•°é‡:', COUNT(*) FROM POSID_MEAL WHERE category_id IS NOT NULL;
SELECT 'æœªåˆ†ç±»çš„é¤åˆ«æ•°é‡:', COUNT(*) FROM POSID_MEAL WHERE category_id IS NULL;
SELECT 'è´¦æˆ·ç±»åˆ«-åˆ†ç±»å…³è”æ•°é‡:', COUNT(*) FROM POSID_ACCOUNTKIND_MEAL_CATEGORY;
SELECT 'é…ç½®äº†é¤åˆ«åˆ†ç±»çš„åŒºåŸŸæ•°é‡:', COUNT(*) FROM POSID_AREA WHERE meal_categories IS NOT NULL;

COMMIT;
```

---

## ğŸ’¾ ç¼“å­˜ç­–ç•¥è®¾è®¡

### 3.1 ç¼“å­˜æ¶æ„

```mermaid
flowchart LR
    A[åº”ç”¨å±‚] --> B[æœ¬åœ°ç¼“å­˜\nCaffeine\n1åˆ†é’Ÿ]
    A --> C[åˆ†å¸ƒå¼ç¼“å­˜\nRedis\n30åˆ†é’Ÿ]
    C --> D[æ•°æ®åº“\nMySQL]
    
    style B fill:#ffeaa7
    style C fill:#74b9ff
    style D fill:#a29bfe
```

### 3.2 ç¼“å­˜é”®è®¾è®¡

| ç¼“å­˜é¡¹ | Redis Key | æ•°æ®ç»“æ„ | è¿‡æœŸæ—¶é—´ | è¯´æ˜ |
|-------|-----------|---------|---------|------|
| é¤åˆ«åˆ†ç±»åˆ—è¡¨ | `meal:categories:all` | String (JSONæ•°ç»„) | 30åˆ†é’Ÿ | æ‰€æœ‰é¤åˆ«åˆ†ç±» |
| å•ä¸ªåˆ†ç±»è¯¦æƒ… | `meal:category:{categoryId}` | String (JSON) | 30åˆ†é’Ÿ | å•ä¸ªåˆ†ç±»ä¿¡æ¯ |
| åˆ†ç±»ä¸‹çš„é¤åˆ« | `meal:category:{categoryId}:meals` | String (JSONæ•°ç»„) | 30åˆ†é’Ÿ | æŸåˆ†ç±»çš„æ‰€æœ‰é¤åˆ« |
| é¤åˆ«è¯¦æƒ… | `meal:info:{mealId}` | String (JSON) | 30åˆ†é’Ÿ | å•ä¸ªé¤åˆ«å®Œæ•´ä¿¡æ¯ |
| å½“å‰å¯ç”¨é¤åˆ« | `meal:current:{areaId}` | String (JSONæ•°ç»„) | 10åˆ†é’Ÿ | æŸåŒºåŸŸå½“å‰æ—¶é—´å¯ç”¨é¤åˆ« |
| ç”¨æˆ·å¯ç”¨åˆ†ç±» | `account:meal:categories:{accountKindId}` | Set | 1å°æ—¶ | è´¦æˆ·ç±»åˆ«å…è®¸çš„é¤åˆ«åˆ†ç±»IDåˆ—è¡¨ |
| åŒºåŸŸæä¾›åˆ†ç±» | `area:meal:categories:{areaId}` | Set | 1å°æ—¶ | åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»IDåˆ—è¡¨ |

### 3.3 ç¼“å­˜ç®¡ç†å™¨æ ¸å¿ƒé€»è¾‘

**é¤åˆ«ç¼“å­˜ç®¡ç†å™¨è´Ÿè´£é¤åˆ«å’Œé¤åˆ«åˆ†ç±»çš„ç¼“å­˜ç®¡ç†ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½**ï¼š

**1. é¤åˆ«åˆ†ç±»ç¼“å­˜ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰**ï¼š
- **è·å–æ‰€æœ‰é¤åˆ«åˆ†ç±»**ï¼š
  - Level 1ï¼šæœ¬åœ°ç¼“å­˜Caffeineï¼ˆ1åˆ†é’Ÿï¼‰
  - Level 2ï¼šRedisç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
  - Level 3ï¼šæ•°æ®åº“æŸ¥è¯¢ï¼ˆæŒ‰sort_orderæ’åºï¼‰
  - ä¸‰çº§ç¼“å­˜ä¾æ¬¡æŸ¥æ‰¾ï¼Œæœªå‘½ä¸­åˆ™å‘ä¸‹æŸ¥æ‰¾å¹¶å›å¡«ä¸Šçº§ç¼“å­˜

- **è·å–å•ä¸ªé¤åˆ«åˆ†ç±»è¯¦æƒ…**ï¼š
  - Redisç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
  - ç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“å¹¶ç¼“å­˜

**2. é¤åˆ«ç¼“å­˜ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰**ï¼š
- **è·å–é¤åˆ«è¯¦æƒ…**ï¼šä¸é¤åˆ«åˆ†ç±»ç±»ä¼¼çš„ä¸‰çº§ç¼“å­˜ç­–ç•¥
- **è·å–åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«**ï¼š
  - Redisç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
  - æŒ‰åˆ†ç±»IDæŸ¥è¯¢ï¼Œç»“æœæŒ‰sort_orderæ’åº

**3. æ—¶é—´ç›¸å…³ç¼“å­˜ï¼ˆçŸ­æœŸç¼“å­˜ï¼‰**ï¼š
- **è·å–å½“å‰å¯ç”¨é¤åˆ«**ï¼ˆæŸåŒºåŸŸï¼‰ï¼š
  - è¯»å–åŒºåŸŸçš„`meal_categories`é…ç½®
  - æŸ¥è¯¢è¿™äº›åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«
  - è¿‡æ»¤å½“å‰æ—¶é—´æ®µå¯ç”¨çš„é¤åˆ«ï¼ˆæ ¹æ®start_timeã€end_timeï¼‰
  - Redisç¼“å­˜10åˆ†é’Ÿï¼ˆå› ä¸ºæ—¶é—´ä¼šå˜åŒ–ï¼‰

- **æ—¶é—´çª—å£åˆ¤æ–­é€»è¾‘**ï¼š
  - è·å–é¤åˆ«çš„start_timeå’Œend_time
  - åˆ¤æ–­å½“å‰æ—¶é—´æ˜¯å¦åœ¨è¯¥èŒƒå›´å†…
  - æ”¯æŒè·¨å¤©åœºæ™¯ï¼ˆå¦‚23:00-01:00ï¼‰

**4. æƒé™ç›¸å…³ç¼“å­˜**ï¼š
- **è´¦æˆ·ç±»åˆ«å…è®¸çš„é¤åˆ«åˆ†ç±»**ï¼š
  - Redisç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
  - ä»`POSID_ACCOUNTKIND_MEAL_CATEGORY`è¡¨æŸ¥è¯¢
  - è¿”å›é¤åˆ«åˆ†ç±»IDé›†åˆ

- **åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»**ï¼š
  - Redisç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
  - ä»åŒºåŸŸçš„`meal_categories` JSONå­—æ®µè§£æ
  - è¿”å›é¤åˆ«åˆ†ç±»IDé›†åˆ

**5. ç¼“å­˜å¤±æ•ˆæœºåˆ¶ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰**ï¼š
- **é¤åˆ«åˆ†ç±»å˜æ›´æ—¶**ï¼ˆç›‘å¬`MealCategoryChangeEvent`ï¼‰ï¼š
  - æ¸…é™¤åˆ†ç±»åˆ—è¡¨ç¼“å­˜ï¼ˆæœ¬åœ°+Redisï¼‰
  - æ¸…é™¤å•ä¸ªåˆ†ç±»ç¼“å­˜
  - æ¸…é™¤åˆ†ç±»ä¸‹çš„é¤åˆ«åˆ—è¡¨ç¼“å­˜
  - **çº§è”æ¸…é™¤**ï¼šæŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨è¯¥åˆ†ç±»çš„è´¦æˆ·ç±»åˆ«ï¼Œæ¸…é™¤å…¶ç¼“å­˜
  - æ¸…é™¤æ‰€æœ‰åŒºåŸŸçš„"å½“å‰å¯ç”¨é¤åˆ«"ç¼“å­˜

- **é¤åˆ«å˜æ›´æ—¶**ï¼ˆç›‘å¬`MealChangeEvent`ï¼‰ï¼š
  - æ¸…é™¤é¤åˆ«è¯¦æƒ…ç¼“å­˜ï¼ˆæœ¬åœ°+Redisï¼‰
  - æ¸…é™¤æ‰€å±åˆ†ç±»çš„é¤åˆ«åˆ—è¡¨ç¼“å­˜
  - æ¸…é™¤æ‰€æœ‰åŒºåŸŸçš„"å½“å‰å¯ç”¨é¤åˆ«"ç¼“å­˜

**6. ç¼“å­˜é¢„çƒ­æœºåˆ¶**ï¼š
- **å®šæ—¶é¢„çƒ­**ï¼šæ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆ`@Scheduled`ï¼‰
  - é¢„çƒ­æ‰€æœ‰é¤åˆ«åˆ†ç±»
  - é¢„çƒ­æ‰€æœ‰æœ‰æ•ˆé¤åˆ«åˆ°æœ¬åœ°ç¼“å­˜
  - è®°å½•é¢„çƒ­æ•°é‡å’Œè€—æ—¶

---

## ğŸ’» æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¯´æ˜

### 4.1 é¤åˆ«åˆ†ç±»æœåŠ¡æ ¸å¿ƒåŠŸèƒ½

**é¤åˆ«åˆ†ç±»ç®¡ç†æœåŠ¡è´Ÿè´£é¤åˆ«åˆ†ç±»çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼š**

**1. åˆ›å»ºé¤åˆ«åˆ†ç±»**ï¼š
- **æ•°æ®éªŒè¯**ï¼š
  - æ£€æŸ¥åˆ†ç±»ç¼–å·ï¼ˆ`code`ï¼‰å”¯ä¸€æ€§
  - æ£€æŸ¥åˆ†ç±»åç§°ä¸ä¸ºç©º
  
- **è®¾ç½®å±æ€§**ï¼š
  - ç”Ÿæˆå”¯ä¸€ID
  - è®¾ç½®æ’åºå·ï¼ˆ`sort_order`ï¼‰
  - è®¾ç½®é»˜è®¤å¯ç”¨çŠ¶æ€ï¼ˆ`available=true`ï¼‰
  - è®°å½•åˆ›å»ºæ—¶é—´

- **ä¿å­˜å¹¶å‘å¸ƒäº‹ä»¶**ï¼š
  - ä¿å­˜åˆ°æ•°æ®åº“
  - å‘å¸ƒ`MealCategoryChangeEvent`äº‹ä»¶ï¼ˆCREATEï¼‰
  - è§¦å‘ç¼“å­˜æ¸…ç†

**2. æ›´æ–°é¤åˆ«åˆ†ç±»**ï¼š
- éªŒè¯åˆ†ç±»å­˜åœ¨æ€§
- æ›´æ–°å…è®¸ä¿®æ”¹çš„å­—æ®µï¼ˆåç§°ã€æè¿°ã€æ’åºå·ç­‰ï¼‰
- ä¿å­˜å¹¶å‘å¸ƒäº‹ä»¶ï¼ˆUPDATEï¼‰
- è§¦å‘çº§è”ç¼“å­˜æ¸…ç†

**3. åˆ é™¤é¤åˆ«åˆ†ç±»ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰**ï¼š
- **æ£€æŸ¥å…³è”é¤åˆ«**ï¼šå¦‚æœåˆ†ç±»ä¸‹æœ‰é¤åˆ«ï¼Œæ‹’ç»åˆ é™¤
- **æ£€æŸ¥è´¦æˆ·ç±»åˆ«å¼•ç”¨**ï¼šå¦‚æœæœ‰è´¦æˆ·ç±»åˆ«ä½¿ç”¨è¯¥åˆ†ç±»ï¼Œæ‹’ç»åˆ é™¤
- **æ£€æŸ¥åŒºåŸŸå¼•ç”¨**ï¼šæ‰«ææ‰€æœ‰åŒºåŸŸçš„`meal_categories`ï¼ŒæŸ¥æ‰¾æ˜¯å¦å¼•ç”¨è¯¥åˆ†ç±»
- å®‰å…¨æ£€æŸ¥é€šè¿‡ååˆ é™¤ï¼Œå‘å¸ƒäº‹ä»¶ï¼ˆDELETEï¼‰

**4. æ‰¹é‡æ“ä½œ**ï¼š
- **æ‰¹é‡åˆ›å»ºé¤åˆ«åˆ†ç±»**ï¼šäº‹åŠ¡å†…æ‰¹é‡æ’å…¥ï¼Œæœ€åç»Ÿä¸€å‘å¸ƒäº‹ä»¶
- **æ‰¹é‡è°ƒæ•´æ’åº**ï¼šæ›´æ–°æ‰€æœ‰å—å½±å“åˆ†ç±»çš„sort_orderï¼Œè§¦å‘ç¼“å­˜åˆ·æ–°

### 4.2 é¤åˆ«æœåŠ¡æ ¸å¿ƒåŠŸèƒ½

**é¤åˆ«ç®¡ç†æœåŠ¡è´Ÿè´£å…·ä½“é¤åˆ«çš„ç®¡ç†ï¼š**

**1. åˆ›å»ºé¤åˆ«**ï¼š
- **æ•°æ®éªŒè¯**ï¼š
  - æ£€æŸ¥é¤åˆ«ç¼–å·å”¯ä¸€æ€§
  - éªŒè¯æ‰€å±é¤åˆ«åˆ†ç±»å­˜åœ¨
  - éªŒè¯æ—¶é—´çª—å£åˆæ³•æ€§ï¼ˆstart_time < end_timeï¼‰

- **è®¾ç½®å±æ€§**ï¼š
  - å…³è”é¤åˆ«åˆ†ç±»IDï¼ˆ`category_id`ï¼‰
  - è®¾ç½®æ—¶é—´çª—å£ï¼ˆ`start_time`ã€`end_time`ï¼‰
  - è®¾ç½®ä»·æ ¼ã€å›¾ç‰‡ç­‰ä¸šåŠ¡å±æ€§

- **ä¿å­˜å¹¶å‘å¸ƒäº‹ä»¶**ï¼š
  - ä¿å­˜åˆ°æ•°æ®åº“
  - å‘å¸ƒ`MealChangeEvent`äº‹ä»¶ï¼ˆCREATEï¼‰
  - è§¦å‘åˆ†ç±»ç¼“å­˜å’Œé¤åˆ«ç¼“å­˜æ¸…ç†

**2. æ›´æ–°é¤åˆ«**ï¼š
- éªŒè¯é¤åˆ«å­˜åœ¨æ€§
- æ›´æ–°æ—¶é—´çª—å£ã€ä»·æ ¼ç­‰å­—æ®µ
- å¦‚æœä¿®æ”¹äº†æ‰€å±åˆ†ç±»ï¼Œéœ€è¦æ¸…ç†ä¸¤ä¸ªåˆ†ç±»çš„ç¼“å­˜
- ä¿å­˜å¹¶å‘å¸ƒäº‹ä»¶ï¼ˆUPDATEï¼‰

**3. åˆ é™¤é¤åˆ«ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰**ï¼š
- **æ£€æŸ¥å†å²æ¶ˆè´¹è®°å½•**ï¼šå¦‚æœæœ‰äº¤æ˜“è®°å½•å…³è”ï¼Œä¸å…è®¸åˆ é™¤ï¼ˆæ”¹ä¸ºç¦ç”¨`available=false`ï¼‰
- **æ£€æŸ¥è®¢é¤è®°å½•**ï¼šå¦‚æœæœ‰è®¢é¤è®°å½•ï¼Œä¸å…è®¸åˆ é™¤
- å®‰å…¨æ£€æŸ¥é€šè¿‡ååˆ é™¤æˆ–ç¦ç”¨

**4. æ—¶é—´çª—å£ç®¡ç†**ï¼š
- **æŸ¥è¯¢å½“å‰å¯ç”¨é¤åˆ«**ï¼š
  - è·å–å½“å‰æ—¶é—´
  - è¿‡æ»¤æ—¶é—´çª—å£å†…çš„é¤åˆ«
  - æ”¯æŒè·¨å¤©æ—¶é—´çª—å£ï¼ˆå¦‚23:00-01:00ï¼‰
  
- **æ‰¹é‡æ›´æ–°æ—¶é—´çª—å£**ï¼š
  - æ”¯æŒæŒ‰å­£èŠ‚ã€èŠ‚å‡æ—¥è°ƒæ•´é¤åˆ«æ—¶é—´
  - äº‹åŠ¡å†…æ‰¹é‡æ›´æ–°

### 4.3 é¤åˆ«æƒé™éªŒè¯æœåŠ¡

**é¤åˆ«æƒé™éªŒè¯æœåŠ¡æä¾›ç»Ÿä¸€çš„æƒé™éªŒè¯é€»è¾‘ï¼š**

**1. è´¦æˆ·ç±»åˆ«-é¤åˆ«æƒé™éªŒè¯**ï¼š
- **éªŒè¯æµç¨‹**ï¼š
  - è¯»å–è´¦æˆ·ç±»åˆ«å…è®¸çš„é¤åˆ«åˆ†ç±»åˆ—è¡¨ï¼ˆä»ç¼“å­˜ï¼‰
  - åˆ¤æ–­å½“å‰é¤åˆ«æ‰€å±åˆ†ç±»æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
  - è¿”å›éªŒè¯ç»“æœ

- **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - æƒé™éªŒè¯ç»“æœç¼“å­˜ï¼ˆRedisï¼Œ30åˆ†é’Ÿï¼‰
  - ç¼“å­˜é”®æ ¼å¼ï¼š`perm:meal:{accountKindId}:{mealCategoryId}`

**2. åŒºåŸŸ-é¤åˆ«æƒé™éªŒè¯**ï¼š
- **éªŒè¯æµç¨‹**ï¼š
  - è¯»å–åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»åˆ—è¡¨ï¼ˆä»ç¼“å­˜ï¼‰
  - åˆ¤æ–­å½“å‰é¤åˆ«æ‰€å±åˆ†ç±»æ˜¯å¦åœ¨æä¾›åˆ—è¡¨ä¸­
  - è¿”å›éªŒè¯ç»“æœ

- **åº”ç”¨åœºæ™¯**ï¼š
  - è®¾å¤‡æ¶ˆè´¹æ—¶éªŒè¯è¯¥åŒºåŸŸæ˜¯å¦æä¾›è¯¥é¤åˆ«
  - è®¢é¤æ—¶éªŒè¯è¯¥åŒºåŸŸæ˜¯å¦æ”¯æŒè¯¥é¤åˆ«

**3. æ‰¹é‡æƒé™éªŒè¯**ï¼š
- **æ‰¹é‡éªŒè¯è´¦æˆ·ç±»åˆ«æƒé™**ï¼š
  - è¾“å…¥ï¼šè´¦æˆ·ç±»åˆ«ID + å¤šä¸ªé¤åˆ«IDåˆ—è¡¨
  - è¾“å‡ºï¼šæ¯ä¸ªé¤åˆ«çš„æƒé™éªŒè¯ç»“æœ
  - ä¼˜åŒ–ï¼šä½¿ç”¨Redis Pipelineæ‰¹é‡æŸ¥è¯¢ç¼“å­˜

- **æ‰¹é‡éªŒè¯åŒºåŸŸæƒé™**ï¼š
  - ç±»ä¼¼æ‰¹é‡è´¦æˆ·ç±»åˆ«éªŒè¯
  - æ”¯æŒå¤šåŒºåŸŸã€å¤šé¤åˆ«çš„ç¬›å¡å°”ç§¯éªŒè¯

**4. æƒé™å˜æ›´çº§è”å¤„ç†**ï¼š
- **è´¦æˆ·ç±»åˆ«é¤åˆ«æƒé™å˜æ›´æ—¶**ï¼š
  - æ¸…é™¤è¯¥è´¦æˆ·ç±»åˆ«çš„æƒé™ç¼“å­˜
  - å‘å¸ƒæƒé™å˜æ›´äº‹ä»¶
  - é€šçŸ¥åœ¨çº¿ç”¨æˆ·åˆ·æ–°æƒé™

- **åŒºåŸŸé¤åˆ«é…ç½®å˜æ›´æ—¶**ï¼š
  - æ¸…é™¤è¯¥åŒºåŸŸçš„é¤åˆ«ç¼“å­˜
  - æ¸…é™¤æ‰€æœ‰å¼•ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«ç¼“å­˜
  - æ›´æ–°ç¦»çº¿è®¾å¤‡çš„åå•é…ç½®

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### 5.1 é…ç½®æ•ˆç‡å¯¹æ¯”

| æ“ä½œ | åŸè®¾è®¡ | é‡æ„å | æå‡ |
|------|-------|--------|------|
| é…ç½®è´¦æˆ·ç±»åˆ«é¤åˆ«æƒé™ | é€‰æ‹©Nä¸ªé¤åˆ« | é€‰æ‹©Mä¸ªåˆ†ç±» | é…ç½®é‡â†“70% |
| æ–°å¢ä¸€ä¸ªé¤åˆ« | æ›´æ–°æ‰€æœ‰å…³è”è´¦æˆ·ç±»åˆ« | ä»…åˆ†ç±»ä¸‹æ·»åŠ  | å·¥ä½œé‡â†“90% |
| æŸ¥è¯¢ç”¨æˆ·å¯ç”¨é¤åˆ« | æŸ¥è¯¢Nä¸ªé¤åˆ« | æŸ¥è¯¢Mä¸ªåˆ†ç±» | æŸ¥è¯¢æ•ˆç‡â†‘60% |

**ç¤ºä¾‹**ï¼š
- åŸè®¾è®¡ï¼š100ä¸ªè´¦æˆ·ç±»åˆ« Ã— 50ä¸ªé¤åˆ« = 5000ä¸ªé…ç½®å…³ç³»
- é‡æ„åï¼š100ä¸ªè´¦æˆ·ç±»åˆ« Ã— 5ä¸ªåˆ†ç±» = 500ä¸ªé…ç½®å…³ç³»ï¼ˆâ†“90%ï¼‰

### 5.2 æŸ¥è¯¢æ€§èƒ½

| åœºæ™¯ | å“åº”æ—¶é—´ | QPS | è¯´æ˜ |
|------|---------|-----|------|
| è·å–é¤åˆ«åˆ†ç±»åˆ—è¡¨ | < 5ms | 20000+ | æœ¬åœ°ç¼“å­˜ |
| è·å–å½“å‰å¯ç”¨é¤åˆ« | < 15ms | 8000+ | Redisç¼“å­˜ |
| éªŒè¯é¤åˆ«æƒé™ | < 10ms | 10000+ | å¤šçº§ç¼“å­˜ |

### 5.3 å­˜å‚¨ä¼˜åŒ–

| é¡¹ç›® | åŸè®¾è®¡ | é‡æ„å | èŠ‚çœ |
|------|-------|--------|------|
| å…³è”è¡¨è®°å½•æ•° | 5000æ¡ | 500æ¡ | â†“90% |
| æƒé™åˆ¤æ–­SQL | 2æ¬¡æŸ¥è¯¢ | 1æ¬¡æŸ¥è¯¢ | â†“50% |
| æ•°æ®å†—ä½™ | é«˜ | ä½ | â†“70% |

---

## ğŸ¯ æ€»ç»“

### é‡æ„æˆæœ

âœ… **å¼•å…¥äºŒçº§åˆ†ç±»ä½“ç³»**ï¼šé¤åˆ«åˆ†ç±»â†’å…·ä½“é¤åˆ«  
âœ… **é…ç½®å¤æ‚åº¦é™ä½70%**ï¼šä»NÃ—Mé™è‡³NÃ—Kï¼ˆK<<Mï¼‰  
âœ… **æŸ¥è¯¢æ€§èƒ½æå‡60%**ï¼šåˆ†ç±»çº§åˆ«ç¼“å­˜  
âœ… **ä»£ç ç»´æŠ¤æ€§æå‡**ï¼šç»Ÿä¸€æƒé™éªŒè¯é€»è¾‘  
âœ… **çµæ´»é€‚é…å¤šåœºæ™¯**ï¼šæ”¯æŒåˆ†ç±»çº§å’Œé¤åˆ«çº§æƒé™æ§åˆ¶

### ä¸šåŠ¡ä»·å€¼

- ğŸ“ **æ•™è‚²åœºæ™¯**ï¼šæ—©é¤åˆ†ç±»ï¼ˆæ™®é€š/è¥å…»ï¼‰ï¼Œåˆé¤åˆ†ç±»ï¼ˆå¥—é¤A/B/Cï¼‰
- ğŸ¥ **åŒ»ç–—åœºæ™¯**ï¼šç—…äººé¤åˆ†ç±»ï¼ˆæ™®é€š/ç‰¹æ®Šï¼‰ï¼ŒåŒ»æŠ¤é¤åˆ†ç±»
- ğŸ¢ **ä¼ä¸šåœºæ™¯**ï¼šå·¥ä½œé¤åˆ†ç±»ï¼Œå•†åŠ¡é¤åˆ†ç±»ï¼Œå‘˜å·¥é¤åˆ†ç±»
- ğŸ›ï¸ **å•†åœºåœºæ™¯**ï¼šå¿«é¤åˆ†ç±»ï¼Œæ­£é¤åˆ†ç±»ï¼Œç‰¹è‰²é¤åˆ†ç±»

### åç»­ä¼˜åŒ–

- [ ] æ”¯æŒé¤åˆ«åˆ†ç±»çš„å¤šè¯­è¨€é…ç½®
- [ ] é¤åˆ«æ™ºèƒ½æ¨èï¼ˆåŸºäºå†å²æ¶ˆè´¹ï¼‰
- [ ] é¤åˆ«è¥å…»åˆ†æå’Œæ ‡ç­¾

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-31  
**æ›´æ–°æ—¶é—´**ï¼š2025-10-31  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šPOSID v3.13.1+  
**æ›´æ–°è¯´æ˜**ï¼š
- v2.0: ç®€åŒ–æ–‡æ¡£ï¼Œç§»é™¤Javaä»£ç ï¼ˆçº¦680è¡Œï¼‰ï¼Œç”¨æ–‡å­—æè¿°æ ¸å¿ƒé€»è¾‘
- v1.0: åˆå§‹ç‰ˆæœ¬

---
    
    private static final String CACHE_PREFIX_CATEGORIES = "meal:categories:all";
    private static final String CACHE_PREFIX_CATEGORY = "meal:category:";
    private static final String CACHE_PREFIX_CATEGORY_MEALS = "meal:category:%s:meals";
    private static final String CACHE_PREFIX_MEAL = "meal:info:";
    private static final String CACHE_PREFIX_CURRENT_MEALS = "meal:current:";
    private static final String CACHE_PREFIX_ACCOUNT_CATEGORIES = "account:meal:categories:";
    private static final String CACHE_PREFIX_AREA_CATEGORIES = "area:meal:categories:";
    
    /**
     * è·å–æ‰€æœ‰é¤åˆ«åˆ†ç±»
     */
    public List<PosIDMealCategory> getAllCategories() {
        String key = CACHE_PREFIX_CATEGORIES;
        
        // Level 1: æœ¬åœ°ç¼“å­˜
        List<PosIDMealCategory> categories = 
            (List<PosIDMealCategory>) localCache.getIfPresent(key);
        if (categories != null) {
            return categories;
        }
        
        // Level 2: Redisç¼“å­˜
        categories = (List<PosIDMealCategory>) redisTemplate.opsForValue().get(key);
        if (categories != null) {
            localCache.put(key, categories);
            return categories;
        }
        
        // Level 3: æ•°æ®åº“
        categories = mealCategoryDao.findByAvailableTrueOrderBySortOrder();
        if (categories != null) {
            redisTemplate.opsForValue().set(key, categories, 30, TimeUnit.MINUTES);
            localCache.put(key, categories);
        }
        
        return categories;
    }
    
    /**
     * è·å–é¤åˆ«åˆ†ç±»è¯¦æƒ…
     */
    public PosIDMealCategory getCategory(String categoryId) {
        String key = CACHE_PREFIX_CATEGORY + categoryId;
        
        PosIDMealCategory category = 
            (PosIDMealCategory) redisTemplate.opsForValue().get(key);
        if (category == null) {
            category = mealCategoryDao.findById(categoryId);
            if (category != null) {
                redisTemplate.opsForValue().set(key, category, 30, TimeUnit.MINUTES);
            }
        }
        
        return category;
    }
    
    /**
     * è·å–åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«
     */
    public List<PosIDMeal> getMealsByCategory(String categoryId) {
        String key = String.format(CACHE_PREFIX_CATEGORY_MEALS, categoryId);
        
        List<PosIDMeal> meals = (List<PosIDMeal>) redisTemplate.opsForValue().get(key);
        if (meals == null) {
            meals = mealDao.findByCategoryIdAndAvailableTrueOrderBySortOrder(categoryId);
            if (meals != null) {
                redisTemplate.opsForValue().set(key, meals, 30, TimeUnit.MINUTES);
            }
        }
        
        return meals;
    }
    
    /**
     * è·å–é¤åˆ«è¯¦æƒ…ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
     */
    public PosIDMeal getMeal(String mealId) {
        String key = CACHE_PREFIX_MEAL + mealId;
        
        // Level 1: æœ¬åœ°ç¼“å­˜
        PosIDMeal meal = (PosIDMeal) localCache.getIfPresent(key);
        if (meal != null) {
            return meal;
        }
        
        // Level 2: Redisç¼“å­˜
        meal = (PosIDMeal) redisTemplate.opsForValue().get(key);
        if (meal != null) {
            localCache.put(key, meal);
            return meal;
        }
        
        // Level 3: æ•°æ®åº“
        meal = mealDao.findById(mealId);
        if (meal != null) {
            redisTemplate.opsForValue().set(key, meal, 30, TimeUnit.MINUTES);
            localCache.put(key, meal);
        }
        
        return meal;
    }
    
    /**
     * è·å–å½“å‰å¯ç”¨é¤åˆ«ï¼ˆå¸¦æ—¶é—´è¿‡æ»¤ï¼‰
     */
    public List<PosIDMeal> getCurrentAvailableMeals(String areaId) {
        String key = CACHE_PREFIX_CURRENT_MEALS + areaId;
        
        // çŸ­æœŸç¼“å­˜10åˆ†é’Ÿï¼ˆå› ä¸ºæ—¶é—´ä¼šå˜åŒ–ï¼‰
        List<PosIDMeal> meals = (List<PosIDMeal>) redisTemplate.opsForValue().get(key);
        if (meals == null) {
            meals = calculateCurrentAvailableMeals(areaId);
            redisTemplate.opsForValue().set(key, meals, 10, TimeUnit.MINUTES);
        }
        
        return meals;
    }
    
    /**
     * è®¡ç®—å½“å‰å¯ç”¨é¤åˆ«
     */
    private List<PosIDMeal> calculateCurrentAvailableMeals(String areaId) {
        // 1. è·å–åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»
        Set<String> areaCategoryIds = getAreaMealCategories(areaId);
        
        // 2. æŸ¥è¯¢è¿™äº›åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«
        List<PosIDMeal> allMeals = mealDao.findByCategoryIdInAndAvailableTrue(
            new ArrayList<>(areaCategoryIds)
        );
        
        // 3. è¿‡æ»¤å½“å‰æ—¶é—´æ®µå¯ç”¨çš„é¤åˆ«
        LocalTime now = LocalTime.now();
        return allMeals.stream()
            .filter(meal -> isInTimeWindow(meal, now))
            .sorted(Comparator.comparing(PosIDMeal::getSortOrder))
            .collect(Collectors.toList());
    }
    
    /**
     * æ£€æŸ¥é¤åˆ«æ—¶é—´çª—å£
     */
    private boolean isInTimeWindow(PosIDMeal meal, LocalTime now) {
        LocalTime start = LocalTime.parse(meal.getStartTime());
        LocalTime end = LocalTime.parse(meal.getEndTime());
        
        return !now.isBefore(start) && !now.isAfter(end);
    }
    
    /**
     * è·å–è´¦æˆ·ç±»åˆ«å…è®¸çš„é¤åˆ«åˆ†ç±»
     */
    public Set<String> getAccountKindMealCategories(String accountKindId) {
        String key = CACHE_PREFIX_ACCOUNT_CATEGORIES + accountKindId;
        
        Set<String> categoryIds = (Set<String>) redisTemplate.opsForValue().get(key);
        if (categoryIds == null) {
            List<PosIDAccountKindMealCategory> relations = 
                accountKindMealCategoryDao.findByAccountKindId(accountKindId);
            
            categoryIds = relations.stream()
                .map(PosIDAccountKindMealCategory::getMealCategoryId)
                .collect(Collectors.toSet());
            
            redisTemplate.opsForValue().set(key, categoryIds, 1, TimeUnit.HOURS);
        }
        
        return categoryIds;
    }
    
    /**
     * è·å–åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»
     */
    public Set<String> getAreaMealCategories(String areaId) {
        String key = CACHE_PREFIX_AREA_CATEGORIES + areaId;
        
        Set<String> categoryIds = (Set<String>) redisTemplate.opsForValue().get(key);
        if (categoryIds == null) {
            PosIDArea area = areaDao.findById(areaId);
            if (area != null && area.getMealCategories() != null) {
                JSONArray categories = JSON.parseArray(area.getMealCategories());
                categoryIds = categories.stream()
                    .map(Object::toString)
                    .collect(Collectors.toSet());
                
                redisTemplate.opsForValue().set(key, categoryIds, 1, TimeUnit.HOURS);
            } else {
                categoryIds = Collections.emptySet();
            }
        }
        
        return categoryIds;
    }
    
    /**
     * æ¸…é™¤é¤åˆ«åˆ†ç±»ç¼“å­˜
     */
    @EventListener
    public void onMealCategoryChanged(MealCategoryChangeEvent event) {
        String categoryId = event.getCategoryId();
        
        // æ¸…é™¤åˆ†ç±»åˆ—è¡¨ç¼“å­˜
        localCache.invalidate(CACHE_PREFIX_CATEGORIES);
        redisTemplate.delete(CACHE_PREFIX_CATEGORIES);
        
        // æ¸…é™¤å•ä¸ªåˆ†ç±»ç¼“å­˜
        redisTemplate.delete(CACHE_PREFIX_CATEGORY + categoryId);
        
        // æ¸…é™¤åˆ†ç±»ä¸‹çš„é¤åˆ«ç¼“å­˜
        redisTemplate.delete(String.format(CACHE_PREFIX_CATEGORY_MEALS, categoryId));
        
        // æ¸…é™¤ç›¸å…³è´¦æˆ·ç±»åˆ«ç¼“å­˜
        List<String> accountKindIds = 
            accountKindMealCategoryDao.findAccountKindIdsByCategoryId(categoryId);
        accountKindIds.forEach(accountKindId -> 
            redisTemplate.delete(CACHE_PREFIX_ACCOUNT_CATEGORIES + accountKindId)
        );
        
        // æ¸…é™¤å½“å‰å¯ç”¨é¤åˆ«ç¼“å­˜ï¼ˆæ‰€æœ‰åŒºåŸŸï¼‰
        Set<String> currentMealKeys = redisTemplate.keys(CACHE_PREFIX_CURRENT_MEALS + "*");
        if (currentMealKeys != null && !currentMealKeys.isEmpty()) {
            redisTemplate.delete(currentMealKeys);
        }
    }
    
    /**
     * æ¸…é™¤é¤åˆ«ç¼“å­˜
     */
    @EventListener
    public void onMealChanged(MealChangeEvent event) {
        String mealId = event.getMealId();
        PosIDMeal meal = mealDao.findById(mealId);
        
        if (meal != null) {
            // æ¸…é™¤é¤åˆ«è¯¦æƒ…ç¼“å­˜
            localCache.invalidate(CACHE_PREFIX_MEAL + mealId);
            redisTemplate.delete(CACHE_PREFIX_MEAL + mealId);
            
            // æ¸…é™¤åˆ†ç±»ä¸‹çš„é¤åˆ«ç¼“å­˜
            redisTemplate.delete(
                String.format(CACHE_PREFIX_CATEGORY_MEALS, meal.getCategoryId())
            );
            
            // æ¸…é™¤å½“å‰å¯ç”¨é¤åˆ«ç¼“å­˜
            Set<String> currentMealKeys = redisTemplate.keys(CACHE_PREFIX_CURRENT_MEALS + "*");
            if (currentMealKeys != null && !currentMealKeys.isEmpty()) {
                redisTemplate.delete(currentMealKeys);
            }
        }
    }
    
    /**
     * é¢„çƒ­ç¼“å­˜
     */
    @Scheduled(cron = "0 */30 * * * ?")  // æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void warmUpCache() {
        log.info("å¼€å§‹é¢„çƒ­é¤åˆ«ç¼“å­˜...");
        
        // é¢„çƒ­é¤åˆ«åˆ†ç±»
        getAllCategories();
        
        // é¢„çƒ­æ‰€æœ‰é¤åˆ«
        List<PosIDMeal> allMeals = mealDao.findByAvailableTrue();
        allMeals.forEach(meal -> {
            String key = CACHE_PREFIX_MEAL + meal.getId();
            localCache.put(key, meal);
        });
        
        log.info("é¤åˆ«ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œç¼“å­˜{}ä¸ªé¤åˆ«", allMeals.size());
    }
}
```

---

## ğŸ’» æ ¸å¿ƒä»£ç å®ç°

### 4.1 é¤åˆ«åˆ†ç±»æœåŠ¡

```java
/**
 * é¤åˆ«åˆ†ç±»ç®¡ç†æœåŠ¡
 */
@Service
public class PosIDMealCategoryService {
    
    @Resource
    private PosIDMealCategoryDao mealCategoryDao;
    
    @Resource
    private MealCacheManager cacheManager;
    
    @Resource
    private ApplicationEventPublisher eventPublisher;
    
    /**
     * è·å–æ‰€æœ‰é¤åˆ«åˆ†ç±»
     */
    public List<PosIDMealCategory> getAllCategories() {
        return cacheManager.getAllCategories();
    }
    
    /**
     * è·å–åˆ†ç±»è¯¦æƒ…
     */
    public PosIDMealCategory getById(String id) {
        return cacheManager.getCategory(id);
    }
    
    /**
     * åˆ›å»ºé¤åˆ«åˆ†ç±»
     */
    @Transactional
    public PosIDMealCategory createCategory(MealCategoryCreateRequest request) {
        // 1. æ•°æ®éªŒè¯
        validateCategoryData(request);
        
        // 2. åˆ›å»ºå®ä½“
        PosIDMealCategory category = new PosIDMealCategory();
        category.setId(UUID.randomUUID().toString());
        category.setCode(request.getCode());
        category.setName(request.getName());
        category.setAreaId(request.getAreaId());
        category.setSortOrder(request.getSortOrder());
        category.setDescription(request.getDescription());
        category.setAvailable(true);
        category.setCreateTime(new Date());
        
        // 3. ä¿å­˜
        mealCategoryDao.save(category);
        
        // 4. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealCategoryChangeEvent(this, category.getId(), "CREATE")
        );
        
        return category;
    }
    
    /**
     * æ›´æ–°é¤åˆ«åˆ†ç±»
     */
    @Transactional
    public PosIDMealCategory updateCategory(String id, MealCategoryUpdateRequest request) {
        PosIDMealCategory category = mealCategoryDao.findById(id);
        if (category == null) {
            throw new BusinessException("é¤åˆ«åˆ†ç±»ä¸å­˜åœ¨");
        }
        
        // æ›´æ–°å­—æ®µ
        if (request.getName() != null) {
            category.setName(request.getName());
        }
        if (request.getSortOrder() != null) {
            category.setSortOrder(request.getSortOrder());
        }
        if (request.getDescription() != null) {
            category.setDescription(request.getDescription());
        }
        
        category.setUpdateTime(new Date());
        mealCategoryDao.save(category);
        
        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealCategoryChangeEvent(this, id, "UPDATE")
        );
        
        return category;
    }
    
    /**
     * åˆ é™¤é¤åˆ«åˆ†ç±»
     */
    @Transactional
    public void deleteCategory(String id) {
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰é¤åˆ«
        if (mealDao.countByCategoryId(id) > 0) {
            throw new BusinessException("è¯¥åˆ†ç±»ä¸‹å­˜åœ¨é¤åˆ«ï¼Œæ— æ³•åˆ é™¤");
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦æœ‰å…³è”å…³ç³»
        if (accountKindMealCategoryDao.countByMealCategoryId(id) > 0) {
            throw new BusinessException("è¯¥åˆ†ç±»å·²è¢«è´¦æˆ·ç±»åˆ«ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤");
        }
        
        // 3. åˆ é™¤åˆ†ç±»
        mealCategoryDao.deleteById(id);
        
        // 4. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealCategoryChangeEvent(this, id, "DELETE")
        );
    }
    
    /**
     * éªŒè¯åˆ†ç±»æ•°æ®
     */
    private void validateCategoryData(MealCategoryCreateRequest request) {
        // æ£€æŸ¥ç¼–å·å”¯ä¸€æ€§
        if (mealCategoryDao.existsByCode(request.getCode())) {
            throw new BusinessException("é¤åˆ«åˆ†ç±»ç¼–å·å·²å­˜åœ¨");
        }
        
        // æ£€æŸ¥åŒºåŸŸå­˜åœ¨æ€§
        if (request.getAreaId() != null) {
            PosIDArea area = areaDao.findById(request.getAreaId());
            if (area == null) {
                throw new BusinessException("å…³è”åŒºåŸŸä¸å­˜åœ¨");
            }
        }
    }
}
```

### 4.2 é¤åˆ«æœåŠ¡

```java
/**
 * é¤åˆ«ç®¡ç†æœåŠ¡
 */
@Service
public class PosIDMealService {
    
    @Resource
    private PosIDMealDao mealDao;
    
    @Resource
    private MealCacheManager cacheManager;
    
    @Resource
    private ApplicationEventPublisher eventPublisher;
    
    /**
     * è·å–é¤åˆ«è¯¦æƒ…
     */
    public PosIDMeal getById(String id) {
        return cacheManager.getMeal(id);
    }
    
    /**
     * è·å–åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«
     */
    public List<PosIDMeal> getMealsByCategory(String categoryId) {
        return cacheManager.getMealsByCategory(categoryId);
    }
    
    /**
     * è·å–å½“å‰å¯ç”¨é¤åˆ«
     */
    public List<PosIDMeal> getCurrentAvailableMeals(String areaId) {
        return cacheManager.getCurrentAvailableMeals(areaId);
    }
    
    /**
     * åˆ›å»ºé¤åˆ«
     */
    @Transactional
    public PosIDMeal createMeal(MealCreateRequest request) {
        // 1. æ•°æ®éªŒè¯
        validateMealData(request);
        
        // 2. åˆ›å»ºå®ä½“
        PosIDMeal meal = new PosIDMeal();
        meal.setId(UUID.randomUUID().toString());
        meal.setCode(request.getCode());
        meal.setName(request.getName());
        meal.setCategoryId(request.getCategoryId());
        meal.setStartTime(request.getStartTime());
        meal.setEndTime(request.getEndTime());
        meal.setBasePrice(request.getBasePrice());
        
        // ä»·æ ¼è§„åˆ™ï¼ˆå¯é€‰ï¼‰
        if (request.getPriceRules() != null) {
            meal.setPriceRules(JSON.toJSONString(request.getPriceRules()));
        }
        
        meal.setSortOrder(request.getSortOrder());
        meal.setAvailable(true);
        meal.setCreateTime(new Date());
        
        // 3. ä¿å­˜
        mealDao.save(meal);
        
        // 4. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealChangeEvent(this, meal.getId(), "CREATE")
        );
        
        return meal;
    }
    
    /**
     * æ›´æ–°é¤åˆ«
     */
    @Transactional
    public PosIDMeal updateMeal(String id, MealUpdateRequest request) {
        PosIDMeal meal = mealDao.findById(id);
        if (meal == null) {
            throw new BusinessException("é¤åˆ«ä¸å­˜åœ¨");
        }
        
        // æ›´æ–°å­—æ®µ
        if (request.getName() != null) {
            meal.setName(request.getName());
        }
        if (request.getStartTime() != null) {
            meal.setStartTime(request.getStartTime());
        }
        if (request.getEndTime() != null) {
            meal.setEndTime(request.getEndTime());
        }
        if (request.getBasePrice() != null) {
            meal.setBasePrice(request.getBasePrice());
        }
        
        meal.setUpdateTime(new Date());
        mealDao.save(meal);
        
        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealChangeEvent(this, id, "UPDATE")
        );
        
        return meal;
    }
    
    /**
     * åˆ é™¤é¤åˆ«
     */
    @Transactional
    public void deleteMeal(String id) {
        // æ£€æŸ¥æ˜¯å¦æœ‰äº¤æ˜“è®°å½•
        if (transactionDao.existsByMealId(id)) {
            throw new BusinessException("è¯¥é¤åˆ«å·²è¢«ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤");
        }
        
        mealDao.deleteById(id);
        
        eventPublisher.publishEvent(
            new MealChangeEvent(this, id, "DELETE")
        );
    }
    
    /**
     * éªŒè¯é¤åˆ«æ•°æ®
     */
    private void validateMealData(MealCreateRequest request) {
        // æ£€æŸ¥ç¼–å·å”¯ä¸€æ€§
        if (mealDao.existsByCode(request.getCode())) {
            throw new BusinessException("é¤åˆ«ç¼–å·å·²å­˜åœ¨");
        }
        
        // æ£€æŸ¥åˆ†ç±»å­˜åœ¨æ€§
        PosIDMealCategory category = mealCategoryDao.findById(request.getCategoryId());
        if (category == null) {
            throw new BusinessException("é¤åˆ«åˆ†ç±»ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥æ—¶é—´æ ¼å¼
        try {
            LocalTime.parse(request.getStartTime());
            LocalTime.parse(request.getEndTime());
        } catch (Exception e) {
            throw new BusinessException("æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºHH:mm");
        }
    }
}
```

### 4.3 é¤åˆ«æƒé™éªŒè¯æœåŠ¡

```java
/**
 * é¤åˆ«æƒé™éªŒè¯æœåŠ¡
 */
@Service
public class MealPermissionService {
    
    @Resource
    private MealCacheManager cacheManager;
    
    /**
     * éªŒè¯é¤åˆ«æƒé™
     * 
     * @return true-æœ‰æƒé™, false-æ— æƒé™
     */
    public MealPermissionResult validateMealPermission(
        String accountKindId,
        String areaId,
        String mealId,
        LocalDateTime consumeTime
    ) {
        // 1. è·å–é¤åˆ«ä¿¡æ¯
        PosIDMeal meal = cacheManager.getMeal(mealId);
        if (meal == null || !meal.getAvailable()) {
            return MealPermissionResult.fail("é¤åˆ«ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }
        
        // 2. æ£€æŸ¥é¤åˆ«åˆ†ç±»æƒé™
        Set<String> accountCategories = 
            cacheManager.getAccountKindMealCategories(accountKindId);
        
        if (!accountCategories.contains(meal.getCategoryId())) {
            return MealPermissionResult.fail("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
        }
        
        // 3. æ£€æŸ¥åŒºåŸŸæ˜¯å¦æä¾›è¯¥é¤åˆ«åˆ†ç±»
        Set<String> areaCategories = cacheManager.getAreaMealCategories(areaId);
        
        if (!areaCategories.contains(meal.getCategoryId())) {
            return MealPermissionResult.fail("è¯¥åŒºåŸŸä¸æä¾›æ­¤é¤åˆ«");
        }
        
        // 4. æ£€æŸ¥æ—¶é—´çª—å£
        LocalTime consumeLocalTime = consumeTime.toLocalTime();
        LocalTime start = LocalTime.parse(meal.getStartTime());
        LocalTime end = LocalTime.parse(meal.getEndTime());
        
        if (consumeLocalTime.isBefore(start) || consumeLocalTime.isAfter(end)) {
            return MealPermissionResult.fail("å½“å‰ä¸åœ¨å°±é¤æ—¶é—´æ®µ");
        }
        
        // 5. éªŒè¯é€šè¿‡
        return MealPermissionResult.success(meal);
    }
    
    /**
     * è·å–ç”¨æˆ·åœ¨æŒ‡å®šåŒºåŸŸçš„å¯ç”¨é¤åˆ«åˆ—è¡¨
     */
    public List<MealCategoryWithMeals> getAvailableMeals(
        String accountKindId,
        String areaId
    ) {
        // 1. è·å–è´¦æˆ·ç±»åˆ«å…è®¸çš„åˆ†ç±»
        Set<String> accountCategories = 
            cacheManager.getAccountKindMealCategories(accountKindId);
        
        // 2. è·å–åŒºåŸŸæä¾›çš„åˆ†ç±»
        Set<String> areaCategories = cacheManager.getAreaMealCategories(areaId);
        
        // 3. è®¡ç®—äº¤é›†
        Set<String> availableCategories = new HashSet<>(accountCategories);
        availableCategories.retainAll(areaCategories);
        
        // 4. è·å–æ¯ä¸ªåˆ†ç±»ä¸‹çš„é¤åˆ«
        List<MealCategoryWithMeals> result = new ArrayList<>();
        
        for (String categoryId : availableCategories) {
            PosIDMealCategory category = cacheManager.getCategory(categoryId);
            List<PosIDMeal> meals = cacheManager.getMealsByCategory(categoryId);
            
            // è¿‡æ»¤å½“å‰æ—¶é—´å¯ç”¨çš„é¤åˆ«
            LocalTime now = LocalTime.now();
            List<PosIDMeal> availableMeals = meals.stream()
                .filter(meal -> isInTimeWindow(meal, now))
                .collect(Collectors.toList());
            
            if (!availableMeals.isEmpty()) {
                result.add(new MealCategoryWithMeals(category, availableMeals));
            }
        }
        
        return result;
    }
    
    /**
     * æ£€æŸ¥æ—¶é—´çª—å£
     */
    private boolean isInTimeWindow(PosIDMeal meal, LocalTime now) {
        LocalTime start = LocalTime.parse(meal.getStartTime());
        LocalTime end = LocalTime.parse(meal.getEndTime());
        return !now.isBefore(start) && !now.isAfter(end);
    }
}

/**
 * é¤åˆ«æƒé™éªŒè¯ç»“æœ
 */
@Data
@AllArgsConstructor
public class MealPermissionResult {
    private boolean success;
    private String message;
    private PosIDMeal meal;
    
    public static MealPermissionResult success(PosIDMeal meal) {
        return new MealPermissionResult(true, "éªŒè¯é€šè¿‡", meal);
    }
    
    public static MealPermissionResult fail(String message) {
        return new MealPermissionResult(false, message, null);
    }
}

/**
 * åˆ†ç±»å’Œé¤åˆ«ç»„åˆVO
 */
@Data
@AllArgsConstructor
public class MealCategoryWithMeals {
    private PosIDMealCategory category;
    private List<PosIDMeal> meals;
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### 5.1 é…ç½®æ•ˆç‡å¯¹æ¯”

| æ“ä½œ | åŸè®¾è®¡ | é‡æ„å | æå‡ |
|------|-------|--------|------|
| é…ç½®è´¦æˆ·ç±»åˆ«é¤åˆ«æƒé™ | é€‰æ‹©Nä¸ªé¤åˆ« | é€‰æ‹©Mä¸ªåˆ†ç±» | é…ç½®é‡â†“70% |
| æ–°å¢ä¸€ä¸ªé¤åˆ« | æ›´æ–°æ‰€æœ‰å…³è”è´¦æˆ·ç±»åˆ« | ä»…åˆ†ç±»ä¸‹æ·»åŠ  | å·¥ä½œé‡â†“90% |
| æŸ¥è¯¢ç”¨æˆ·å¯ç”¨é¤åˆ« | æŸ¥è¯¢Nä¸ªé¤åˆ« | æŸ¥è¯¢Mä¸ªåˆ†ç±» | æŸ¥è¯¢æ•ˆç‡â†‘60% |

**ç¤ºä¾‹**ï¼š
- åŸè®¾è®¡ï¼š100ä¸ªè´¦æˆ·ç±»åˆ« Ã— 50ä¸ªé¤åˆ« = 5000ä¸ªé…ç½®å…³ç³»
- é‡æ„åï¼š100ä¸ªè´¦æˆ·ç±»åˆ« Ã— 5ä¸ªåˆ†ç±» = 500ä¸ªé…ç½®å…³ç³»ï¼ˆâ†“90%ï¼‰

### 5.2 æŸ¥è¯¢æ€§èƒ½

| åœºæ™¯ | å“åº”æ—¶é—´ | QPS | è¯´æ˜ |
|------|---------|-----|------|
| è·å–é¤åˆ«åˆ†ç±»åˆ—è¡¨ | < 5ms | 20000+ | æœ¬åœ°ç¼“å­˜ |
| è·å–å½“å‰å¯ç”¨é¤åˆ« | < 15ms | 8000+ | Redisç¼“å­˜ |
| éªŒè¯é¤åˆ«æƒé™ | < 10ms | 10000+ | å¤šçº§ç¼“å­˜ |

### 5.3 å­˜å‚¨ä¼˜åŒ–

| é¡¹ç›® | åŸè®¾è®¡ | é‡æ„å | èŠ‚çœ |
|------|-------|--------|------|
| å…³è”è¡¨è®°å½•æ•° | 5000æ¡ | 500æ¡ | â†“90% |
| æƒé™åˆ¤æ–­SQL | 2æ¬¡æŸ¥è¯¢ | 1æ¬¡æŸ¥è¯¢ | â†“50% |
| æ•°æ®å†—ä½™ | é«˜ | ä½ | â†“70% |

---

## ğŸ¯ æ€»ç»“

### é‡æ„æˆæœ

âœ… **å¼•å…¥äºŒçº§åˆ†ç±»ä½“ç³»**ï¼šé¤åˆ«åˆ†ç±»â†’å…·ä½“é¤åˆ«  
âœ… **é…ç½®å¤æ‚åº¦é™ä½70%**ï¼šä»NÃ—Mé™è‡³NÃ—Kï¼ˆK<<Mï¼‰  
âœ… **æŸ¥è¯¢æ€§èƒ½æå‡60%**ï¼šåˆ†ç±»çº§åˆ«ç¼“å­˜  
âœ… **ä»£ç ç»´æŠ¤æ€§æå‡**ï¼šç»Ÿä¸€æƒé™éªŒè¯é€»è¾‘  
âœ… **çµæ´»é€‚é…å¤šåœºæ™¯**ï¼šæ”¯æŒåˆ†ç±»çº§å’Œé¤åˆ«çº§æƒé™æ§åˆ¶

### ä¸šåŠ¡ä»·å€¼

- ğŸ“ **æ•™è‚²åœºæ™¯**ï¼šæ—©é¤åˆ†ç±»ï¼ˆæ™®é€š/è¥å…»ï¼‰ï¼Œåˆé¤åˆ†ç±»ï¼ˆå¥—é¤A/B/Cï¼‰
- ğŸ¥ **åŒ»ç–—åœºæ™¯**ï¼šç—…äººé¤åˆ†ç±»ï¼ˆæ™®é€š/ç‰¹æ®Šï¼‰ï¼ŒåŒ»æŠ¤é¤åˆ†ç±»
- ğŸ¢ **ä¼ä¸šåœºæ™¯**ï¼šå·¥ä½œé¤åˆ†ç±»ï¼Œå•†åŠ¡é¤åˆ†ç±»ï¼Œå‘˜å·¥é¤åˆ†ç±»
- ğŸ›ï¸ **å•†åœºåœºæ™¯**ï¼šå¿«é¤åˆ†ç±»ï¼Œæ­£é¤åˆ†ç±»ï¼Œç‰¹è‰²é¤åˆ†ç±»

### åç»­ä¼˜åŒ–

- [ ] æ”¯æŒé¤åˆ«åˆ†ç±»çš„å¤šè¯­è¨€é…ç½®
- [ ] é¤åˆ«æ™ºèƒ½æ¨èï¼ˆåŸºäºå†å²æ¶ˆè´¹ï¼‰
- [ ] é¤åˆ«è¥å…»åˆ†æå’Œæ ‡ç­¾

---

## ğŸ“ æ›´æ–°è¯´æ˜

### v2.0 (2025-10-31)

**æ ¸å¿ƒæ›´æ–°**ï¼š
- âœ… æ–°å¢"é¤åˆ«åˆ†ç±»ä¸ç»è¥æ¨¡å¼å…³ç³»"ç« èŠ‚
- âœ… æ˜ç¡®é¤åˆ«é…ç½®åœ¨ä¸åŒç»è¥æ¨¡å¼ä¸‹çš„å¿…éœ€æ€§è§„åˆ™
- âœ… æ–°å¢é¤åˆ«é…ç½®è§„åˆ™æµç¨‹å›¾
- âœ… è¡¥å……åŒºåŸŸé¤åˆ«å…³è”è§„åˆ™è¯´æ˜

**ä¸šåŠ¡å½±å“**ï¼š
- é¤åˆ«åˆ¶åŒºåŸŸ(`manage_mode=1`)å¿…é¡»é…ç½®é¤åˆ«åˆ†ç±»å’Œé¤åˆ«
- è¶…å¸‚åˆ¶åŒºåŸŸ(`manage_mode=2`)æ— éœ€é…ç½®é¤åˆ«
- æ··åˆæ¨¡å¼åŒºåŸŸ(`manage_mode=3`)æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ˜¯å¦é…ç½®é¤åˆ«
- åŒºåŸŸçš„`meal_categories`å­—æ®µå¿…é¡»ä¸`manage_mode`ä¿æŒä¸€è‡´

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-10-31  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šPOSID v3.13.1+


