# 数据库设计与ER图文档

## 📋 概述

本文档详细定义了智能视频模块的数据库设计方案，包括表结构设计、ER图、索引设计、分区策略等。数据库采用 PostgreSQL，支持高并发、大数据量、实时性要求。

---

## 1. 数据库架构设计

### 1.1 数据库架构图

```
┌─────────────────────────────────────────────────────────────┐
│                   数据库集群架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐        ┌─────────────┐                     │
│  │   主库      │        │   从库1     │                     │
│  │  (Master)   │◀──────▶│  (Slave1)   │                     │
│  │             │        │             │                     │
│  │  写操作     │        │   读操作     │                     │
│  └─────────────┘        └─────────────┘                     │
│         │                       │                           │
│         └───────────┬───────────┘                           │
│                     │                                       │
│         ┌─────────────┐  ┌─────────────┐                     │
│         │   从库2     │  │   从库3     │                     │
│         │  (Slave2)   │  │  (Slave3)   │                     │
│         │             │  │             │                     │
│         │   读操作    │  │   读操作    │                     │
│         └─────────────┘  └─────────────┘                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 分库分表策略

```
┌─────────────────────────────────────────────────────────────┐
│                    分库策略 (按业务模块)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐                     │
│  │ 视频监控数据库  │ │ 设备管理数据库  │                     │
│  │  - 设备信息     │ │ - 设备基础信息  │                     │
│  │  - 视频流       │ │ - 设备配置      │                     │
│  │  - 录像数据     │ │ - 设备状态      │                     │
│  └─────────────────┘ └─────────────────┘                     │
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐                     │
│  │ 告警管理数据库  │ │ 用户权限数据库  │                     │
│  │  - 告警事件     │ │ - 用户信息      │                     │
│  │  - 告警规则     │ │ - 角色权限      │                     │
│  │  - 告警处理     │ │ - 安全级别      │                     │
│  └─────────────────┘ └─────────────────┘                     │
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐                     │
│  │ 智能分析数据库  │ │ 系统配置数据库  │                     │
│  │  - 分析结果     │ │ - 系统参数      │ │
│  │  - 算法配置     │ │ - 日志数据      │ │
│  │  - 检测规则     │ │ - 审计数据      │ │
│  └─────────────────┘ └─────────────────┘                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    分表策略 (按时间和设备)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 录像表分表:                                                   │
│  ivs_record_2024_01   (2024年1月录像)                        │
│  ivs_record_2024_02   (2024年2月录像)                        │
│  ivs_record_2024_03   (2024年3月录像)                        │
│  ...                                                       │
│                                                             │
│ 告警表分表:                                                   │
│  ivs_alarm_2024_01    (2024年1月告警)                        │
│  ivs_alarm_2024_02    (2024年2月告警)                        │
│  ...                                                       │
│                                                             │
│ 分析结果表分表:                                               │
│  ivs_analysis_result_2024_01   (2024年1月结果)              │
│  ivs_analysis_result_2024_02   (2024年2月结果)              │
│  ...                                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. ER图设计

### 2.1 整体ER图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            智能视频模块ER图                                    │
└─────────────────────────────────────────────────────────────────────────────┘

用户权限体系
    ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
    │   sys_user  │◀───────▶│ sys_role    │◀───────▶│sys_function │
    │   用户表    │         │   角色表    │         │  功能表     │
    └──────┬──────┘         └──────┬──────┘         └──────┬──────┘
           │                       │                       │
           │                       │                       │
           ▼                       ▼                       ▼
    ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
    │user_security│         │sys_role_func│         │ function_per│
    │_level       │         │ion          │         │mission      │
    │用户安全级别  │         │角色功能关联  │         │功能权限配置  │
    └──────┬──────┘         └─────────────┘         └─────────────┘
           │
           ▼
    ┌─────────────┐
    │user_device  │
    │_permission  │
    │用户设备权限  │
    └──────┬──────┘

设备管理体系
           ▲
           │
    ┌──────┴──────┐
    │ ivs_device │
    │  设备主表   │
    └──────┬──────┘
           │
           ├────────────┬────────────┬────────────┐
           ▼            ▼            ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ivs_device│ │ivs_device│ │ivs_device│ │ivs_device│
    │_config   │ │_group    │ │_status   │ │_channel  │
    │设备配置   │ │设备分组   │ │设备状态   │ │设备通道   │
    └──────────┘ └──────────┘ └──────────┘ └──────────┘
           │
           ▼
    ┌─────────────┐
    │ivs_device   │
    │_template    │
    │设备模板     │
    └──────┬──────┘

视频流与录像
           ▲
           │
    ┌──────┴──────┐
    │ivs_stream   │
    │  视频流表    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ivs_record   │
    │  录像主表    │
    └──────┬──────┘
           │
           ├────────────┬────────────┐
           ▼            ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ivs_record│ │ivs_record│ │ivs_record│
    │_file     │ │_task     │ │_segment  │
    │录像文件   │ │录像任务   │ │录像片段   │
    └──────────┘ └──────────┘ └──────────┘

实时监控
           ▲
           │
    ┌──────┴──────┐
    │ivs_monitor  │
    │  监控会话    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ivs_ptz      │
    │  云台控制    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ivs_preset   │
    │  预置位      │
    └──────┬──────┘

告警管理
           ▲
           │
    ┌──────┴──────┐
    │ivs_alarm    │
    │  告警主表    │
    └──────┬──────┘
           │
           ├────────────┬────────────┬────────────┐
           ▼            ▼            ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ivs_alarm │ │ivs_alarm │ │ivs_alarm │ │ivs_alarm │
    │_rule     │ │_event    │ │_process  │ │_linkage  │
    │告警规则   │ │告警事件   │ │告警处理   │ │告警联动   │
    └──────────┘ └──────────┘ └──────────┘ └──────────┘

智能分析
           ▲
           │
    ┌──────┴──────┐
    │ivs_algorithm│
    │  算法管理    │
    └──────┬──────┘
           │
           ├────────────┬────────────┐
           ▼            ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ivs_analysis│ivs_analysis│ivs_analysis│
    │_rule       │_result     │_model     │
    │分析规则    │分析结果     │分析模型   │
    └──────────┘ └──────────┘ └──────────┘

消息中心
           ▲
           │
    ┌──────┴──────┐
    │msg_subscription│
    │  消息订阅    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │msg_event    │
    │  事件表      │
    └──────┬──────┘
           │
           ├────────────┬────────────┐
           ▼            ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │msg_message│ │msg_template│ │msg_channel│
    │消息表     │ │消息模板   │ │渠道配置   │
    └──────────┘ └──────────┘ └──────────┘

区域管理
           ▲
           │
    ┌──────┴──────┐
    │ivs_region   │
    │  区域表      │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ivs_region   │
    │_device      │
    │区域设备关联  │
    └──────┬──────┘

解码上墙
           ▲
           │
    ┌──────┴──────┐
    │ivs_decoder  │
    │  解码器      │
    └──────┬──────┘
           │
           ├────────────┬────────────┐
           ▼            ▼            ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ivs_display│ │ivs_layout│ │ivs_task  │
    │显示设备   │ │显示布局   │ │显示任务   │
    └──────────┘ └──────────┘ └──────────┘

系统配置
           ▲
           │
    ┌──────┴──────┐
    │ivs_config   │
    │  系统配置    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ivs_operation│
    │  操作日志    │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │ivs_audit    │
    │  审计日志    │
    └─────────────┘
```

---

## 3. 核心表结构设计

### 3.1 用户权限表

#### 3.1.1 用户表 (sys_user)

```sql
CREATE TABLE sys_user (
    id BIGSERIAL PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码(加密)',
    real_name VARCHAR(50) COMMENT '真实姓名',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    avatar VARCHAR(200) COMMENT '头像地址',
    dept_id BIGINT COMMENT '部门ID',
    status TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-正常',
    login_count INTEGER DEFAULT 0 COMMENT '登录次数',
    last_login_time TIMESTAMP COMMENT '最后登录时间',
    last_login_ip INET COMMENT '最后登录IP',
    expire_time TIMESTAMP COMMENT '账户过期时间',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记:0-未删除,1-已删除',
    remark VARCHAR(500) COMMENT '备注',
    CONSTRAINT uk_username UNIQUE(username),
    INDEX idx_dept_id (dept_id),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time)
) COMMENT='用户表';

-- 插入默认数据
INSERT INTO sys_user (username, password, real_name, email, dept_id, create_by)
VALUES ('admin', '$2a$10$7JB720yubVSOfvV8aRIl.fZHRRZ8QJx8Z9.7VrWQd3X7O5V8Y3V1e', '系统管理员', 'admin@company.com', 1, 1);
```

#### 3.1.2 安全级别配置表 (security_level_config)

```sql
CREATE TABLE security_level_config (
    id BIGSERIAL PRIMARY KEY COMMENT 'ID',
    level_code VARCHAR(20) NOT NULL UNIQUE COMMENT '级别编码',
    level_name VARCHAR(50) NOT NULL COMMENT '级别名称',
    level_value INTEGER NOT NULL COMMENT '级别值(1-5)',
    description TEXT COMMENT '级别描述',
    permissions JSONB COMMENT '权限配置(JSON)',
    status TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-启用',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT uk_level_code UNIQUE(level_code),
    CONSTRAINT uk_level_value UNIQUE(level_value),
    INDEX idx_level_value (level_value),
    INDEX idx_status (status)
) COMMENT='安全级别配置表';

-- 插入5级安全级别
INSERT INTO security_level_config (level_code, level_name, level_value, description, create_by) VALUES
('TOP', '绝密级', 5, '系统管理员，拥有所有权限', 1),
('HIGH', '机密级', 4, '高级管理员，拥有大部分权限', 1),
('MEDIUM', '秘密级', 3, '普通管理员，拥有常规权限', 1),
('NORMAL', '内部级', 2, '操作员，拥有基础权限', 1),
('BASIC', '公开级', 1, '查看者，拥有只读权限', 1);
```

#### 3.1.3 用户安全级别表 (user_security_level)

```sql
CREATE TABLE user_security_level (
    id BIGSERIAL PRIMARY KEY COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    security_level_id BIGINT NOT NULL COMMENT '安全级别ID',
    effective_time TIMESTAMP NOT NULL COMMENT '生效时间',
    expire_time TIMESTAMP COMMENT '过期时间',
    status TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-启用',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT uk_user_level UNIQUE(user_id, security_level_id),
    CONSTRAINT fk_user_level_user FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
    CONSTRAINT fk_user_level_level FOREIGN KEY (security_level_id) REFERENCES security_level_config(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_security_level_id (security_level_id),
    INDEX idx_effective_time (effective_time),
    INDEX idx_status (status)
) COMMENT='用户安全级别表';
```

#### 3.1.4 用户设备权限表 (user_device_permission)

```sql
CREATE TABLE user_device_permission (
    id BIGSERIAL PRIMARY KEY COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    permission_type VARCHAR(20) NOT NULL COMMENT '权限类型:VIEW-查看,READ-只读,WRITE-读写,ALL-全部',
    region_id BIGINT COMMENT '区域ID',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT uk_user_device UNIQUE(user_id, device_id),
    CONSTRAINT fk_user_device_user FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
    CONSTRAINT fk_user_device_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_device_id (device_id),
    INDEX idx_permission_type (permission_type)
) COMMENT='用户设备权限表';
```

### 3.2 设备管理表

#### 3.2.1 设备主表 (ivs_device)

```sql
CREATE TABLE ivs_device (
    id BIGSERIAL PRIMARY KEY COMMENT '设备ID',
    device_code VARCHAR(100) NOT NULL UNIQUE COMMENT '设备编号',
    device_name VARCHAR(100) NOT NULL COMMENT '设备名称',
    device_type VARCHAR(50) NOT NULL COMMENT '设备类型:IPC-网络摄像头,NVR,DVR,DECODER',
    manufacturer VARCHAR(100) COMMENT '生产厂家',
    model VARCHAR(100) COMMENT '设备型号',
    serial_number VARCHAR(200) COMMENT '序列号',
    firmware_version VARCHAR(50) COMMENT '固件版本',
    ip_address INET NOT NULL COMMENT 'IP地址',
    port INTEGER DEFAULT 554 COMMENT '端口',
    protocol VARCHAR(20) DEFAULT 'RTSP' COMMENT '协议:RTSP/RTMP/HLS',
    username VARCHAR(50) COMMENT '用户名',
    password VARCHAR(200) COMMENT '密码(加密)',
    mac_address VARCHAR(50) COMMENT 'MAC地址',
    location VARCHAR(200) COMMENT '安装位置',
    latitude DECIMAL(10,7) COMMENT '纬度',
    longitude DECIMAL(10,7) COMMENT '经度',
    region_id BIGINT COMMENT '所属区域ID',
    group_id BIGINT COMMENT '所属分组ID',
    status TINYINT DEFAULT 0 COMMENT '状态:0-离线,1-在线,2-故障,3-维护',
    last_heartbeat TIMESTAMP COMMENT '最后心跳时间',
    online_duration INTEGER DEFAULT 0 COMMENT '在线时长(秒)',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    remark TEXT COMMENT '备注',
    CONSTRAINT uk_device_code UNIQUE(device_code),
    CONSTRAINT uk_ip_port UNIQUE(ip_address, port),
    INDEX idx_device_name (device_name),
    INDEX idx_device_type (device_type),
    INDEX idx_status (status),
    INDEX idx_region_id (region_id),
    INDEX idx_group_id (group_id),
    INDEX idx_create_time (create_time)
) COMMENT='设备主表';

-- 创建设备索引
CREATE INDEX idx_device_status_region ON ivs_device(status, region_id);
CREATE INDEX idx_device_location ON ivs_device USING GIST(ll_to_earth(latitude, longitude));
```

#### 3.2.2 设备配置表 (ivs_device_config)

```sql
CREATE TABLE ivs_device_config (
    id BIGSERIAL PRIMARY KEY COMMENT 'ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    config_type VARCHAR(50) NOT NULL COMMENT '配置类型:VIDEO-视频,AUDIO-音频,RECORD-录像,ALARM-告警',
    config_key VARCHAR(100) NOT NULL COMMENT '配置键',
    config_value TEXT COMMENT '配置值',
    config_data JSONB COMMENT '配置数据(JSON)',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT fk_device_config_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_config_type (config_type),
    INDEX idx_config_key (config_key),
    UNIQUE KEY uk_device_config (device_id, config_type, config_key)
) COMMENT='设备配置表';
```

#### 3.2.3 设备分组表 (ivs_device_group)

```sql
CREATE TABLE ivs_device_group (
    id BIGSERIAL PRIMARY KEY COMMENT '分组ID',
    group_name VARCHAR(100) NOT NULL COMMENT '分组名称',
    parent_id BIGINT COMMENT '父分组ID',
    group_level INTEGER DEFAULT 0 COMMENT '分组层级',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    description TEXT COMMENT '分组描述',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    CONSTRAINT fk_group_parent FOREIGN KEY (parent_id) REFERENCES ivs_device_group(id) ON DELETE SET NULL,
    INDEX idx_parent_id (parent_id),
    INDEX idx_group_name (group_name),
    INDEX idx_sort_order (sort_order)
) COMMENT='设备分组表';

-- 插入默认分组
INSERT INTO ivs_device_group (group_name, parent_id, group_level, create_by) VALUES
('默认分组', NULL, 0, 1);
```

### 3.3 视频流与录像表

#### 3.3.1 视频流表 (ivs_stream)

```sql
CREATE TABLE ivs_stream (
    id BIGSERIAL PRIMARY KEY COMMENT '流ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id BIGINT COMMENT '通道ID',
    stream_type VARCHAR(20) NOT NULL COMMENT '流类型:MAIN-主码流,SUB-子码流,EVENT-事件流',
    stream_url TEXT COMMENT '流地址',
    play_url TEXT COMMENT '播放地址',
    format VARCHAR(20) COMMENT '编码格式:H264,H265,MJPEG',
    resolution VARCHAR(20) COMMENT '分辨率:1920x1080',
    bitrate INTEGER COMMENT '码率(Kbps)',
    fps INTEGER COMMENT '帧率',
    status TINYINT DEFAULT 0 COMMENT '状态:0-未连接,1-已连接,2-异常',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT fk_stream_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    INDEX idx_device_id (device_id),
    INDEX idx_stream_type (stream_type),
    INDEX idx_status (status)
) COMMENT='视频流表';
```

#### 3.3.2 录像主表 (ivs_record)

```sql
-- 创建分区表 (按月分区)
CREATE TABLE ivs_record (
    id BIGSERIAL PRIMARY KEY COMMENT '录像ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id BIGINT COMMENT '通道ID',
    record_type VARCHAR(20) NOT NULL COMMENT '录像类型:MANUAL-手动,SCHEDULE-计划,ALARM-告警',
    start_time TIMESTAMP NOT NULL COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    duration INTEGER DEFAULT 0 COMMENT '时长(秒)',
    file_path TEXT COMMENT '文件路径',
    file_size BIGINT DEFAULT 0 COMMENT '文件大小(字节)',
    file_format VARCHAR(10) COMMENT '文件格式:mp4,avi,mkv',
    resolution VARCHAR(20) COMMENT '分辨率',
    bitrate INTEGER COMMENT '码率',
    fps INTEGER COMMENT '帧率',
    status TINYINT DEFAULT 1 COMMENT '状态:0-未完成,1-已完成,2-异常',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT fk_record_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    INDEX idx_device_start (device_id, start_time),
    INDEX idx_start_time (start_time),
    INDEX idx_record_type (record_type),
    INDEX idx_status (status)
) COMMENT='录像主表'
PARTITION BY RANGE (start_time);

-- 创建月度分区表
CREATE TABLE ivs_record_2024_01 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE ivs_record_2024_02 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

CREATE TABLE ivs_record_2024_03 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');

-- 创建索引
CREATE INDEX idx_record_device_time ON ivs_record_2024_01 (device_id, start_time);
CREATE INDEX idx_record_device_time ON ivs_record_2024_02 (device_id, start_time);
CREATE INDEX idx_record_device_time ON ivs_record_2024_03 (device_id, start_time);
```

#### 3.3.3 录像片段表 (ivs_record_segment)

```sql
CREATE TABLE ivs_record_segment (
    id BIGSERIAL PRIMARY KEY COMMENT '片段ID',
    record_id BIGINT NOT NULL COMMENT '录像ID',
    segment_index INTEGER NOT NULL COMMENT '片段序号',
    start_time TIMESTAMP NOT NULL COMMENT '片段开始时间',
    end_time TIMESTAMP NOT NULL COMMENT '片段结束时间',
    file_path TEXT COMMENT '片段文件路径',
    file_size BIGINT DEFAULT 0 COMMENT '文件大小(字节)',
    status TINYINT DEFAULT 1 COMMENT '状态:0-未生成,1-已生成,2-异常',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    CONSTRAINT fk_segment_record FOREIGN KEY (record_id) REFERENCES ivs_record(id) ON DELETE CASCADE,
    INDEX idx_record_id (record_id),
    INDEX idx_segment_index (record_id, segment_index),
    UNIQUE KEY uk_record_segment (record_id, segment_index)
) COMMENT='录像片段表';
```

### 3.4 告警管理表

#### 3.4.1 告警主表 (ivs_alarm)

```sql
-- 创建分区表 (按月分区)
CREATE TABLE ivs_alarm (
    id BIGSERIAL PRIMARY KEY COMMENT '告警ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    alarm_type VARCHAR(50) NOT NULL COMMENT '告警类型:MOTION-移动侦测,IO-IO告警,SYSTEM-系统告警',
    alarm_level VARCHAR(20) NOT NULL COMMENT '告警级别:INFO-信息,WARNING-警告,ERROR-错误,CRITICAL-紧急',
    alarm_time TIMESTAMP NOT NULL COMMENT '告警时间',
    end_time TIMESTAMP COMMENT '告警结束时间',
    duration INTEGER DEFAULT 0 COMMENT '持续时长(秒)',
    title VARCHAR(200) NOT NULL COMMENT '告警标题',
    description TEXT COMMENT '告警描述',
    alarm_data JSONB COMMENT '告警数据(JSON)',
    status TINYINT DEFAULT 0 COMMENT '状态:0-待确认,1-处理中,2-已处理,3-已关闭',
    process_time TIMESTAMP COMMENT '处理时间',
    process_user_id BIGINT COMMENT '处理人ID',
    process_note TEXT COMMENT '处理备注',
    region_id BIGINT COMMENT '区域ID',
    image_url TEXT COMMENT '告警图片URL',
    video_url TEXT COMMENT '告警录像URL',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT fk_alarm_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    CONSTRAINT fk_alarm_process_user FOREIGN KEY (process_user_id) REFERENCES sys_user(id) ON DELETE SET NULL,
    INDEX idx_device_time (device_id, alarm_time),
    INDEX idx_alarm_time (alarm_time),
    INDEX idx_alarm_type (alarm_type),
    INDEX idx_alarm_level (alarm_level),
    INDEX idx_status (status),
    INDEX idx_process_user (process_user_id)
) COMMENT='告警主表'
PARTITION BY RANGE (alarm_time);

-- 创建月度分区
CREATE TABLE ivs_alarm_2024_01 PARTITION OF ivs_alarm
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE ivs_alarm_2024_02 PARTITION OF ivs_alarm
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

CREATE INDEX idx_alarm_device_time ON ivs_alarm_2024_01 (device_id, alarm_time);
CREATE INDEX idx_alarm_device_time ON ivs_alarm_2024_02 (device_id, alarm_time);
```

#### 3.4.2 告警规则表 (ivs_alarm_rule)

```sql
CREATE TABLE ivs_alarm_rule (
    id BIGSERIAL PRIMARY KEY COMMENT '规则ID',
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    rule_type VARCHAR(50) NOT NULL COMMENT '规则类型:MOTION,IO,SYSTEM,ANALYSIS',
    device_id BIGINT COMMENT '设备ID(NULL表示全局规则)',
    region_id BIGINT COMMENT '区域ID',
    detection_area JSONB COMMENT '检测区域(JSON格式坐标)',
    detection_params JSONB COMMENT '检测参数(JSON)',
    trigger_condition TEXT COMMENT '触发条件',
    linkage_actions JSONB COMMENT '联动动作(JSON)',
    alarm_level VARCHAR(20) DEFAULT 'WARNING' COMMENT '告警级别',
    enabled TINYINT DEFAULT 1 COMMENT '启用状态:0-禁用,1-启用',
    schedule_type VARCHAR(20) DEFAULT 'ALL' COMMENT '调度类型:ALL-全天,WORK-工作时间,NIGHT-夜间,CUSTOM-自定义',
    schedule_params JSONB COMMENT '调度参数',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    CONSTRAINT fk_rule_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE SET NULL,
    INDEX idx_rule_name (rule_name),
    INDEX idx_rule_type (rule_type),
    INDEX idx_device_id (device_id),
    INDEX idx_enabled (enabled)
) COMMENT='告警规则表';
```

#### 3.4.3 告警联动表 (ivs_alarm_linkage)

```sql
CREATE TABLE ivs_alarm_linkage (
    id BIGSERIAL PRIMARY KEY COMMENT '联动ID',
    alarm_id BIGINT NOT NULL COMMENT '告警ID',
    linkage_type VARCHAR(50) NOT NULL COMMENT '联动类型:RECORD-录像,SNAPSHOT-截图,PTZ-云台,DOOR-门禁,WALL-上墙',
    linkage_action TEXT NOT NULL COMMENT '联动动作(JSON)',
    execute_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '执行时间',
    execute_status TINYINT DEFAULT 0 COMMENT '执行状态:0-未执行,1-执行中,2-执行成功,3-执行失败',
    execute_result TEXT COMMENT '执行结果',
    retry_count INTEGER DEFAULT 0 COMMENT '重试次数',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    CONSTRAINT fk_linkage_alarm FOREIGN KEY (alarm_id) REFERENCES ivs_alarm(id) ON DELETE CASCADE,
    INDEX idx_alarm_id (alarm_id),
    INDEX idx_linkage_type (linkage_type),
    INDEX idx_execute_status (execute_status)
) COMMENT='告警联动表';
```

### 3.5 智能分析表

#### 3.5.1 算法管理表 (ivs_algorithm)

```sql
CREATE TABLE ivs_algorithm (
    id BIGSERIAL PRIMARY KEY COMMENT '算法ID',
    algorithm_name VARCHAR(100) NOT NULL COMMENT '算法名称',
    algorithm_type VARCHAR(50) NOT NULL COMMENT '算法类型:FACE-人脸,BEHAVIOR-行为,SECURITY-安全',
    algorithm_version VARCHAR(50) NOT NULL COMMENT '算法版本',
    algorithm_provider VARCHAR(100) COMMENT '算法提供商',
    model_path TEXT COMMENT '模型文件路径',
    model_version VARCHAR(50) COMMENT '模型版本',
    config_params JSONB COMMENT '配置参数',
    performance_metrics JSONB COMMENT '性能指标',
    accuracy DECIMAL(5,2) COMMENT '准确率(%)',
    speed DECIMAL(10,2) COMMENT '处理速度(帧/秒)',
    resource_usage JSONB COMMENT '资源占用',
    status TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-启用,2-维护',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    INDEX idx_algorithm_name (algorithm_name),
    INDEX idx_algorithm_type (algorithm_type),
    INDEX idx_status (status)
) COMMENT='算法管理表';
```

#### 3.5.2 分析结果表 (ivs_analysis_result)

```sql
-- 创建分区表 (按月分区)
CREATE TABLE ivs_analysis_result (
    id BIGSERIAL PRIMARY KEY COMMENT '结果ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    algorithm_id BIGINT NOT NULL COMMENT '算法ID',
    result_type VARCHAR(50) NOT NULL COMMENT '结果类型:FACE-人脸,BEHAVIOR-行为,OBJECT-物体',
    result_data JSONB NOT NULL COMMENT '结果数据(JSON)',
    confidence DECIMAL(5,2) COMMENT '置信度(%)',
    analysis_time TIMESTAMP NOT NULL COMMENT '分析时间',
    region_id BIGINT COMMENT '区域ID',
    image_url TEXT COMMENT '结果图片URL',
    video_url TEXT COMMENT '结果视频URL',
    status TINYINT DEFAULT 0 COMMENT '状态:0-待确认,1-已确认,2-误报',
    confirm_user_id BIGINT COMMENT '确认人ID',
    confirm_time TIMESTAMP COMMENT '确认时间',
    confirm_note TEXT COMMENT '确认备注',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    CONSTRAINT fk_result_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    CONSTRAINT fk_result_algorithm FOREIGN KEY (algorithm_id) REFERENCES ivs_algorithm(id) ON DELETE CASCADE,
    CONSTRAINT fk_result_confirm_user FOREIGN KEY (confirm_user_id) REFERENCES sys_user(id) ON DELETE SET NULL,
    INDEX idx_device_time (device_id, analysis_time),
    INDEX idx_algorithm_id (algorithm_id),
    INDEX idx_result_type (result_type),
    INDEX idx_analysis_time (analysis_time),
    INDEX idx_status (status)
) COMMENT='分析结果表'
PARTITION BY RANGE (analysis_time);

CREATE TABLE ivs_analysis_result_2024_01 PARTITION OF ivs_analysis_result
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE INDEX idx_result_device_time ON ivs_analysis_result_2024_01 (device_id, analysis_time);
```

### 3.6 消息中心表

#### 3.6.1 消息订阅表 (msg_subscription)

```sql
CREATE TABLE msg_subscription (
    id BIGSERIAL PRIMARY KEY COMMENT '订阅ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    subscription_name VARCHAR(100) NOT NULL COMMENT '订阅名称',
    event_types JSONB NOT NULL COMMENT '事件类型(JSON数组)',
    filter_conditions JSONB COMMENT '过滤条件(JSON)',
    notification_channels JSONB NOT NULL COMMENT '通知渠道(JSON数组)',
    template_id BIGINT COMMENT '消息模板ID',
    enabled TINYINT DEFAULT 1 COMMENT '启用状态:0-禁用,1-启用',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    CONSTRAINT fk_subscription_user FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_subscription_name (subscription_name),
    INDEX idx_enabled (enabled)
) COMMENT='消息订阅表';
```

#### 3.6.2 消息表 (msg_message)

```sql
CREATE TABLE msg_message (
    id BIGSERIAL PRIMARY KEY COMMENT '消息ID',
    subscription_id BIGINT COMMENT '订阅ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    event_type VARCHAR(50) NOT NULL COMMENT '事件类型',
    title VARCHAR(200) NOT NULL COMMENT '消息标题',
    content TEXT NOT NULL COMMENT '消息内容',
    message_data JSONB COMMENT '消息数据(JSON)',
    channel VARCHAR(20) NOT NULL COMMENT '消息渠道:SMS-短信,EMAIL-邮件,APP-APP推送,SYSTEM-系统内',
    send_status TINYINT DEFAULT 0 COMMENT '发送状态:0-待发送,1-发送中,2-发送成功,3-发送失败',
    send_time TIMESTAMP COMMENT '发送时间',
    send_result TEXT COMMENT '发送结果',
    read_status TINYINT DEFAULT 0 COMMENT '阅读状态:0-未读,1-已读',
    read_time TIMESTAMP COMMENT '阅读时间',
    priority TINYINT DEFAULT 1 COMMENT '优先级:1-低,2-中,3-高,4-紧急',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    CONSTRAINT fk_message_user FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_event_type (event_type),
    INDEX idx_send_status (send_status),
    INDEX idx_read_status (read_status),
    INDEX idx_priority (priority),
    INDEX idx_create_time (create_time)
) COMMENT='消息表';

-- 创建索引
CREATE INDEX idx_message_user_status ON msg_message(user_id, send_status);
CREATE INDEX idx_message_time_status ON msg_message(create_time, send_status);
```

### 3.7 区域管理表

#### 3.7.1 区域表 (ivs_region)

```sql
CREATE TABLE ivs_region (
    id BIGSERIAL PRIMARY KEY COMMENT '区域ID',
    region_name VARCHAR(100) NOT NULL COMMENT '区域名称',
    parent_id BIGINT COMMENT '父区域ID',
    region_level INTEGER DEFAULT 0 COMMENT '区域层级',
    region_path VARCHAR(500) COMMENT '区域路径',
    region_code VARCHAR(100) COMMENT '区域编码',
    boundary JSONB COMMENT '区域边界坐标(JSON)',
    area DECIMAL(10,2) COMMENT '区域面积(平方米)',
    location VARCHAR(200) COMMENT '区域位置描述',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-启用',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    CONSTRAINT fk_region_parent FOREIGN KEY (parent_id) REFERENCES ivs_region(id) ON DELETE SET NULL,
    INDEX idx_region_name (region_name),
    INDEX idx_parent_id (parent_id),
    INDEX idx_region_path (region_path),
    INDEX idx_sort_order (sort_order)
) COMMENT='区域表';

-- 插入默认区域
INSERT INTO ivs_region (region_name, parent_id, region_level, create_by) VALUES
('根区域', NULL, 0, 1);
```

#### 3.7.2 区域设备关联表 (ivs_region_device)

```sql
CREATE TABLE ivs_region_device (
    id BIGSERIAL PRIMARY KEY COMMENT 'ID',
    region_id BIGINT NOT NULL COMMENT '区域ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    device_order INTEGER DEFAULT 0 COMMENT '设备在区域中的排序',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT uk_region_device UNIQUE(region_id, device_id),
    CONSTRAINT fk_region_device_region FOREIGN KEY (region_id) REFERENCES ivs_region(id) ON DELETE CASCADE,
    CONSTRAINT fk_region_device_device FOREIGN KEY (device_id) REFERENCES ivs_device(id) ON DELETE CASCADE,
    INDEX idx_region_id (region_id),
    INDEX idx_device_id (device_id),
    INDEX idx_device_order (device_order)
) COMMENT='区域设备关联表';
```

### 3.8 解码上墙表

#### 3.8.1 解码器表 (ivs_decoder)

```sql
CREATE TABLE ivs_decoder (
    id BIGSERIAL PRIMARY KEY COMMENT '解码器ID',
    decoder_name VARCHAR(100) NOT NULL COMMENT '解码器名称',
    decoder_type VARCHAR(50) NOT NULL COMMENT '解码器类型:DECODER-解码器,SERVER-解码服务器',
    manufacturer VARCHAR(100) COMMENT '生产厂家',
    model VARCHAR(100) COMMENT '设备型号',
    ip_address INET NOT NULL COMMENT 'IP地址',
    port INTEGER COMMENT '端口',
    username VARCHAR(50) COMMENT '用户名',
    password VARCHAR(200) COMMENT '密码(加密)',
    max_channels INTEGER DEFAULT 0 COMMENT '最大通道数',
    status TINYINT DEFAULT 0 COMMENT '状态:0-离线,1-在线,2-故障',
    last_heartbeat TIMESTAMP COMMENT '最后心跳时间',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    CONSTRAINT uk_decoder_name UNIQUE(decoder_name),
    CONSTRAINT uk_decoder_ip UNIQUE(ip_address),
    INDEX idx_decoder_type (decoder_type),
    INDEX idx_status (status)
) COMMENT='解码器表';
```

#### 3.8.2 显示墙表 (ivs_display_wall)

```sql
CREATE TABLE ivs_display_wall (
    id BIGSERIAL PRIMARY KEY COMMENT '显示墙ID',
    wall_name VARCHAR(100) NOT NULL COMMENT '显示墙名称',
    wall_type VARCHAR(50) NOT NULL COMMENT '显示墙类型:LCD-液晶拼接,LED-LED大屏,DLP-DLP',
    total_rows INTEGER NOT NULL COMMENT '总行数',
    total_cols INTEGER NOT NULL COMMENT '总列数',
    resolution_width INTEGER NOT NULL COMMENT '总分辨率宽度',
    resolution_height INTEGER NOT NULL COMMENT '总分辨率高度',
    decoder_id BIGINT COMMENT '关联解码器ID',
    wall_layout JSONB COMMENT '屏体布局配置',
    status TINYINT DEFAULT 1 COMMENT '状态:0-禁用,1-启用',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    deleted TINYINT DEFAULT 0 COMMENT '删除标记',
    CONSTRAINT fk_wall_decoder FOREIGN KEY (decoder_id) REFERENCES ivs_decoder(id) ON DELETE SET NULL,
    INDEX idx_wall_name (wall_name),
    INDEX idx_wall_type (wall_type),
    INDEX idx_status (status)
) COMMENT='显示墙表';
```

#### 3.8.3 显示任务表 (ivs_display_task)

```sql
CREATE TABLE ivs_display_task (
    id BIGSERIAL PRIMARY KEY COMMENT '任务ID',
    wall_id BIGINT NOT NULL COMMENT '显示墙ID',
    task_name VARCHAR(100) NOT NULL COMMENT '任务名称',
    task_type VARCHAR(50) NOT NULL COMMENT '任务类型:REAL_TIME-实时视频,PLAYBACK-回放,IMAGE-图片,TEXT-文字',
    source_device_id BIGINT COMMENT '源设备ID',
    source_record_id BIGINT COMMENT '源录像ID',
    source_url TEXT COMMENT '源地址',
    display_area JSONB NOT NULL COMMENT '显示区域:窗口位置和大小',
    display_params JSONB COMMENT '显示参数:亮度、对比度等',
    z_index INTEGER DEFAULT 0 COMMENT '显示层级',
    duration INTEGER COMMENT '显示时长(秒),NULL表示持续显示',
    status TINYINT DEFAULT 0 COMMENT '状态:0-未开始,1-显示中,2-已结束,3-异常',
    start_time TIMESTAMP COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    create_by BIGINT COMMENT '创建人',
    update_by BIGINT COMMENT '更新人',
    CONSTRAINT fk_task_wall FOREIGN KEY (wall_id) REFERENCES ivs_display_wall(id) ON DELETE CASCADE,
    CONSTRAINT fk_task_device FOREIGN KEY (source_device_id) REFERENCES ivs_device(id) ON DELETE SET NULL,
    CONSTRAINT fk_task_record FOREIGN KEY (source_record_id) REFERENCES ivs_record(id) ON DELETE SET NULL,
    INDEX idx_wall_id (wall_id),
    INDEX idx_task_type (task_type),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time)
) COMMENT='显示任务表';
```

---

## 4. 索引设计策略

### 4.1 核心表索引设计

#### 4.1.1 设备表索引
```sql
-- 基础索引
CREATE INDEX idx_device_name ON ivs_device(device_name);
CREATE INDEX idx_device_type ON ivs_device(device_type);
CREATE INDEX idx_device_status ON ivs_device(status);
CREATE INDEX idx_device_region ON ivs_device(region_id);
CREATE INDEX idx_device_group ON ivs_device(group_id);
CREATE INDEX idx_device_create_time ON ivs_device(create_time);

-- 组合索引
CREATE INDEX idx_device_status_region ON ivs_device(status, region_id);
CREATE INDEX idx_device_type_status ON ivs_device(device_type, status);
CREATE INDEX idx_device_region_status ON ivs_device(region_id, status);

-- 空间索引 (用于地理位置查询)
CREATE INDEX idx_device_location ON ivs_device USING GIST(ll_to_earth(latitude, longitude));
```

#### 4.1.2 录像表索引
```sql
-- 分区表索引 (在每个分区上创建)
CREATE INDEX idx_record_device_time ON {partition_name} (device_id, start_time);
CREATE INDEX idx_record_start_time ON {partition_name} (start_time);
CREATE INDEX idx_record_type ON {partition_name} (record_type);
CREATE INDEX idx_record_status ON {partition_name} (status);

-- 组合索引
CREATE INDEX idx_record_device_time_status ON {partition_name} (device_id, start_time, status);
```

#### 4.1.3 告警表索引
```sql
-- 分区表索引
CREATE INDEX idx_alarm_device_time ON {partition_name} (device_id, alarm_time);
CREATE INDEX idx_alarm_time ON {partition_name} (alarm_time);
CREATE INDEX idx_alarm_type ON {partition_name} (alarm_type);
CREATE INDEX idx_alarm_level ON {partition_name} (alarm_level);
CREATE INDEX idx_alarm_status ON {partition_name} (status);
CREATE INDEX idx_alarm_process_user ON {partition_name} (process_user_id);

-- 组合索引
CREATE INDEX idx_alarm_device_time_status ON {partition_name} (device_id, alarm_time, status);
CREATE INDEX idx_alarm_time_level_status ON {partition_name} (alarm_time, alarm_level, status);
```

#### 4.1.4 分析结果表索引
```sql
-- 分区表索引
CREATE INDEX idx_result_device_time ON {partition_name} (device_id, analysis_time);
CREATE INDEX idx_result_algorithm ON {partition_name} (algorithm_id);
CREATE INDEX idx_result_type ON {partition_name} (result_type);
CREATE INDEX idx_result_status ON {partition_name} (status);

-- 组合索引
CREATE INDEX idx_result_device_time_type ON {partition_name} (device_id, analysis_time, result_type);
CREATE INDEX idx_result_device_algorithm_time ON {partition_name} (device_id, algorithm_id, analysis_time);
```

### 4.2 查询优化索引

#### 4.2.1 实时监控查询
```sql
-- 设备列表查询
CREATE INDEX idx_device_list ON ivs_device(region_id, group_id, status, device_type);

-- 设备状态查询
CREATE INDEX idx_device_status_heartbeat ON ivs_device(status, last_heartbeat);

-- 设备搜索查询
CREATE INDEX idx_device_search ON ivs_device(device_name, ip_address, device_type);
```

#### 4.2.2 录像查询
```sql
-- 录像时间段查询
CREATE INDEX idx_record_time_range ON ivs_record(start_time, end_time);

-- 录像按设备查询
CREATE INDEX idx_record_device_time_range ON ivs_record(device_id, start_time, end_time);

-- 录像类型查询
CREATE INDEX idx_record_type_time ON ivs_record(record_type, start_time);
```

#### 4.2.3 告警查询
```sql
-- 告警时间范围查询
CREATE INDEX idx_alarm_time_range ON ivs_alarm(alarm_time, end_time);

-- 告警按设备查询
CREATE INDEX idx_alarm_device_time_range ON ivs_alarm(device_id, alarm_time, alarm_level);

-- 告警状态查询
CREATE INDEX idx_alarm_status_time ON ivs_alarm(status, alarm_time);

-- 未处理告警查询
CREATE INDEX idx_alarm_unprocessed ON ivs_alarm(status, alarm_time) WHERE status IN (0, 1);
```

### 4.3 全文检索索引

```sql
-- 设备描述全文检索
CREATE INDEX idx_device_search_fts ON ivs_device USING GIN(to_tsvector('simple', device_name || ' ' || COALESCE(location, '') || ' ' || COALESCE(remark, '')));

-- 告警内容全文检索
CREATE INDEX idx_alarm_search_fts ON ivs_alarm USING GIN(to_tsvector('simple', title || ' ' || COALESCE(description, '')));

-- 分析结果全文检索
CREATE INDEX idx_analysis_result_fts ON ivs_analysis_result USING GIN(to_tsvector('simple', result_data::text));
```

---

## 5. 数据分区策略

### 5.1 时间分区策略

```sql
-- 按月分区的录像表
CREATE TABLE ivs_record (
    ...
) PARTITION BY RANGE (start_time);

-- 自动创建月度分区的函数
CREATE OR REPLACE FUNCTION create_monthly_partition(
    table_name TEXT,
    start_date DATE
) RETURNS VOID AS $$
DECLARE
    partition_name TEXT;
    end_date DATE;
BEGIN
    partition_name := table_name || '_' || to_char(start_date, 'YYYY_MM');
    end_date := start_date + INTERVAL '1 month';

    EXECUTE format('CREATE TABLE %I PARTITION OF %I
                    FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);

    -- 在新分区上创建索引
    EXECUTE format('CREATE INDEX idx_%I_device_time ON %I (device_id, start_time)',
                   partition_name, partition_name);
    EXECUTE format('CREATE INDEX idx_%I_start_time ON %I (start_time)',
                   partition_name, partition_name);
END;
$$ LANGUAGE plpgsql;
```

### 5.2 哈希分区策略

```sql
-- 按用户ID哈希分区的消息表 (可选方案)
CREATE TABLE msg_message_hash PARTITION BY HASH (user_id);

CREATE TABLE msg_message_hash_0 PARTITION OF msg_message_hash
    FOR VALUES WITH (MODULUS 4, REMAINDER 0);

CREATE TABLE msg_message_hash_1 PARTITION OF msg_message_hash
    FOR VALUES WITH (MODULUS 4, REMAINDER 1);

CREATE TABLE msg_message_hash_2 PARTITION OF msg_message_hash
    FOR VALUES WITH (MODULUS 4, REMAINDER 2);

CREATE TABLE msg_message_hash_3 PARTITION OF msg_message_hash
    FOR VALUES WITH (MODULUS 4, REMAINDER 3);
```

### 5.3 分区维护

```sql
-- 定期创建新分区的任务
CREATE OR REPLACE FUNCTION create_next_month_partitions()
RETURNS VOID AS $$
DECLARE
    next_month DATE;
BEGIN
    next_month := date_trunc('month', CURRENT_DATE) + INTERVAL '1 month';

    PERFORM create_monthly_partition('ivs_record', next_month);
    PERFORM create_monthly_partition('ivs_alarm', next_month);
    PERFORM create_monthly_partition('ivs_analysis_result', next_month);
END;
$$ LANGUAGE plpgsql;

-- 定期删除旧分区的任务 (保留6个月)
CREATE OR REPLACE FUNCTION drop_old_partitions()
RETURNS VOID AS $$
DECLARE
    drop_date DATE;
    partition_record RECORD;
BEGIN
    drop_date := date_trunc('month', CURRENT_DATE) - INTERVAL '6 months';

    -- 删除6个月前的录像分区
    FOR partition_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE tablename LIKE 'ivs_record_20%'
        AND schemaname = 'public'
    LOOP
        IF to_date(substr(partition_record.tablename, length('ivs_record_') + 1), 'YYYY_MM') < drop_date THEN
            EXECUTE format('DROP TABLE %I.%I', partition_record.schemaname, partition_record.tablename);
        END IF;
    END LOOP;

    -- 删除6个月前的告警分区
    FOR partition_record IN
        SELECT schemaname, tablename
        FROM pg_tables
        WHERE tablename LIKE 'ivs_alarm_20%'
        AND schemaname = 'public'
    LOOP
        IF to_date(substr(partition_record.tablename, length('ivs_alarm_') + 1), 'YYYY_MM') < drop_date THEN
            EXECUTE format('DROP TABLE %I.%I', partition_record.schemaname, partition_record.tablename);
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## 6. 性能优化方案

### 6.1 查询优化

#### 6.1.1 常用查询优化
```sql
-- 设备在线状态统计
CREATE MATERIALIZED VIEW device_status_stats AS
SELECT
    status,
    COUNT(*) as device_count,
    COUNT(*) * 100.0 / (SELECT COUNT(*) FROM ivs_device WHERE deleted = 0) as percentage
FROM ivs_device
WHERE deleted = 0
GROUP BY status;

-- 创建刷新索引
CREATE UNIQUE INDEX idx_device_status_stats ON device_status_stats(status);

-- 定期刷新物化视图
CREATE OR REPLACE FUNCTION refresh_device_status_stats()
RETURNS VOID AS $$
BEGIN
    REFRESH MATERIALIZED VIEW device_status_stats;
END;
$$ LANGUAGE plpgsql;

-- 告警统计视图
CREATE MATERIALIZED VIEW alarm_stats AS
SELECT
    alarm_level,
    DATE_TRUNC('day', alarm_time) as alarm_date,
    COUNT(*) as alarm_count
FROM ivs_alarm
GROUP BY alarm_level, DATE_TRUNC('day', alarm_time);

CREATE INDEX idx_alarm_stats_level_date ON alarm_stats(alarm_level, alarm_date);
```

#### 6.1.2 统计查询优化
```sql
-- 录像存储统计视图
CREATE MATERIALIZED VIEW record_storage_stats AS
SELECT
    device_id,
    DATE_TRUNC('hour', start_time) as start_hour,
    COUNT(*) as record_count,
    SUM(duration) as total_duration,
    SUM(file_size) as total_size
FROM ivs_record
WHERE status = 1
GROUP BY device_id, DATE_TRUNC('hour', start_time);

CREATE INDEX idx_record_stats_device_hour ON record_storage_stats(device_id, start_hour);

-- 设备告警统计视图
CREATE MATERIALIZED VIEW device_alarm_stats AS
SELECT
    d.id as device_id,
    d.device_name,
    d.region_id,
    COUNT(a.id) as alarm_count_24h,
    COUNT(a.id) FILTER (WHERE a.alarm_level = 'CRITICAL') as critical_alarm_count_24h
FROM ivs_device d
LEFT JOIN ivs_alarm a ON d.id = a.device_id
    AND a.alarm_time >= CURRENT_DATE - INTERVAL '24 hours'
WHERE d.deleted = 0
GROUP BY d.id, d.device_name, d.region_id;

CREATE INDEX idx_device_alarm_stats_device ON device_alarm_stats(device_id);
CREATE INDEX idx_device_alarm_stats_region ON device_alarm_stats(region_id);
```

### 6.2 数据归档策略

```sql
-- 创建归档表 (用于历史数据)
CREATE TABLE ivs_record_archive (
    LIKE ivs_record INCLUDING ALL
);

CREATE TABLE ivs_alarm_archive (
    LIKE ivs_alarm INCLUDING ALL
);

CREATE TABLE ivs_analysis_archive (
    LIKE ivs_analysis_result INCLUDING ALL
);

-- 数据归档存储过程
CREATE OR REPLACE FUNCTION archive_old_data(
    archive_date DATE DEFAULT CURRENT_DATE - INTERVAL '6 months'
) RETURNS VOID AS $$
DECLARE
    partition_name TEXT;
BEGIN
    -- 归档6个月前的录像数据
    FOR partition_name IN
        SELECT schemaname || '.' || tablename
        FROM pg_tables
        WHERE tablename LIKE 'ivs_record_20%'
        AND schemaname = 'public'
        AND to_date(substr(tablename, length('ivs_record_') + 1), 'YYYY_MM') < date_trunc('month', archive_date)
    LOOP
        EXECUTE format('ALTER TABLE %I MOVE TO ivs_record_archive', partition_name);
    END LOOP;

    -- 归档6个月前的告警数据
    FOR partition_name IN
        SELECT schemaname || '.' || tablename
        FROM pg_tables
        WHERE tablename LIKE 'ivs_alarm_20%'
        AND schemaname = 'public'
        AND to_date(substr(tablename, length('ivs_alarm_') + 1), 'YYYY_MM') < date_trunc('month', archive_date)
    LOOP
        EXECUTE format('ALTER TABLE %I MOVE TO ivs_alarm_archive', partition_name);
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 6.3 缓存策略

```sql
-- Redis缓存表结构建议

-- 1. 设备在线状态缓存
-- Key: device:status:{device_id}
-- Value: {status: 1, last_heartbeat: timestamp, online_duration: seconds}
-- TTL: 300秒

-- 2. 用户权限缓存
-- Key: user:permissions:{user_id}
-- Value: {device_ids: [], security_level: 3, permissions: [...]}
-- TTL: 3600秒

-- 3. 设备列表缓存
-- Key: devices:list:{user_id}:{region_id}:{status}
-- Value: [device_id1, device_id2, ...]
-- TTL: 300秒

-- 4. 告警列表缓存
-- Key: alarms:list:{user_id}:{status}:{limit}
-- Value: [alarm_id1, alarm_id2, ...]
-- TTL: 60秒

-- 5. 录像统计缓存
-- Key: record:stats:{device_id}:{date}
-- Value: {count: 100, total_duration: 3600, total_size: 1073741824}
-- TTL: 3600秒
```

---

## 📝 总结

本数据库设计文档详细定义了智能视频模块的数据库架构：

### 核心特性
- **8大业务模块**：用户权限、设备管理、视频流录像、实时监控、告警管理、智能分析、消息中心、区域管理
- **分区策略**：按时间分区（录像、告警、分析结果）、按业务分库
- **索引优化**：单列索引、组合索引、全文索引、空间索引
- **性能优化**：物化视图、统计视图、缓存策略

### 关键设计
- **5级安全体系**：完整的安全级别数据模型
- **分库分表**：支持海量数据存储和查询
- **索引策略**：覆盖所有高频查询场景
- **归档机制**：自动管理历史数据

**下一步**：创建接口设计规范文档。

---

*本文档详细定义了智能视频模块的数据库设计方案，包括完整的表结构、ER图、索引设计和性能优化方案。*
