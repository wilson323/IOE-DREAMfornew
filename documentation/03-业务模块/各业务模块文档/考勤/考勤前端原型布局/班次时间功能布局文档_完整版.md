# 班次时间功能布局文档 - 完整版

## 功能概述

班次时间管理模块是考勤系统的核心时间配置中心，负责管理时间段、班次、班次时间关联和班次模板等功能。该模块提供灵活的时间配置方案，支持标准班次、特殊班次、轮班班次等多种班次类型，能够满足不同企业的多样化工作时间需求。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **时间处理**: Day.js
- **拖拽组件**: Vue.Draggable
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue

### 项目文件组织结构
```
src/views/business/attendance/shift/
├── index.vue                        # 班次时间主页面
├── time-period/
│   ├── index.vue                   # 时间段管理页面
│   ├── components/
│   │   ├── TimePeriodForm.vue      # 时间段表单组件
│   │   ├── TimePeriodGroup.vue     # 时间段组组件
│   │   └── TimePeriodTemplate.vue  # 时间段模板组件
│   └── api/
│       └── time-period-api.js      # 时间段API
├── shift/
│   ├── index.vue                   # 班次管理页面
│   ├── components/
│   │   ├── ShiftForm.vue           # 班次表单组件
│   │   ├── ShiftCard.vue           # 班次卡片组件
│   │   ├── SpecialShiftForm.vue    # 特殊班次表单
│   │   └── ShiftConfig.vue         # 班次配置组件
│   └── api/
│       └── shift-api.js            # 班次API
├── association/
│   ├── index.vue                   # 班次时间关联页面
│   ├── components/
│   │   ├── StandardShiftAssoc.vue  # 标准班次关联
│   │   ├── RotationShiftAssoc.vue  # 轮班班次关联
│   │   └── ComplexShiftConfig.vue  # 复杂班次配置
│   └── api/
│       └── association-api.js      # 关联API
├── template/
│   ├── index.vue                   # 班次模板页面
│   ├── components/
│   │   ├── DeptTemplate.vue        # 部门班次模板
│   │   ├── PersonalTemplate.vue    # 个人班次模板
│   │   └── TemplateApply.vue       # 模板应用组件
│   └── api/
│       └── template-api.js         # 模板API
├── mock/
│   └── shift-mock.js               # 模拟数据
├── api/
│   └── shift-api.js                # 统一API接口
└── utils/
    ├── time-utils.js               # 时间工具函数
    ├── shift-utils.js              # 班次工具函数
    └── calendar-utils.js           # 日历工具函数
```

### API接口设计
```javascript
// src/api/business/attendance/shift/time-period-api.js
import { postRequest, getRequest, putRequest, deleteRequest } from '/@/lib/axios';

export const timePeriodApi = {
  // 基础时间段
  getTimePeriods: (params) => getRequest('/attendance/shift/time-period/list', params),
  createTimePeriod: (params) => postRequest('/attendance/shift/time-period/create', params),
  updateTimePeriod: (id, params) => putRequest(`/attendance/shift/time-period/update/${id}`, params),
  deleteTimePeriod: (id) => deleteRequest(`/attendance/shift/time-period/delete/${id}`),

  // 时间段组
  getTimePeriodGroups: (params) => getRequest('/attendance/shift/time-period/group/list', params),
  createTimePeriodGroup: (params) => postRequest('/attendance/shift/time-period/group/create', params),
  updateTimePeriodGroup: (id, params) => putRequest(`/attendance/shift/time-period/group/update/${id}`, params),

  // 时间段模板
  getTimePeriodTemplates: () => getRequest('/attendance/shift/time-period/templates'),
  applyTimePeriodTemplate: (templateId, params) => postRequest(`/attendance/shift/time-period/template/${templateId}/apply`, params),
};

// src/api/business/attendance/shift/shift-api.js
export const shiftApi = {
  // 班次管理
  getShifts: (params) => getRequest('/attendance/shift/list', params),
  createShift: (params) => postRequest('/attendance/shift/create', params),
  updateShift: (id, params) => putRequest(`/attendance/shift/update/${id}`, params),
  deleteShift: (id) => deleteRequest(`/attendance/shift/delete/${id}`),

  // 特殊班次
  getSpecialShifts: (params) => getRequest('/attendance/shift/special/list', params),
  createSpecialShift: (params) => postRequest('/attendance/shift/special/create', params),
  updateSpecialShift: (id, params) => putRequest(`/attendance/shift/special/update/${id}`, params),

  // 班次配置
  getShiftConfig: (shiftId) => getRequest(`/attendance/shift/${shiftId}/config`),
  updateShiftConfig: (shiftId, params) => putRequest(`/attendance/shift/${shiftId}/config`, params),

  // 班次复制
  copyShift: (shiftId, params) => postRequest(`/attendance/shift/${shiftId}/copy`, params),
};

// src/api/business/attendance/shift/association-api.js
export const associationApi = {
  // 标准班次关联
  getStandardShiftAssociations: (params) => getRequest('/attendance/shift/association/standard/list', params),
  createStandardShiftAssociation: (params) => postRequest('/attendance/shift/association/standard/create', params),
  updateStandardShiftAssociation: (id, params) => putRequest(`/attendance/shift/association/standard/update/${id}`, params),

  // 轮班班次关联
  getRotationShiftAssociations: (params) => getRequest('/attendance/shift/association/rotation/list', params),
  createRotationShiftAssociation: (params) => postRequest('/attendance/shift/association/rotation/create', params),

  // 复杂班次配置
  getComplexShiftConfigs: (params) => getRequest('/attendance/shift/association/complex/list', params),
  createComplexShiftConfig: (params) => postRequest('/attendance/shift/association/complex/create', params),
};
```

## 核心功能模块

### 1. 时间段管理

#### 时间段表单组件
```vue
<!-- src/views/business/attendance/shift/time-period/components/TimePeriodForm.vue -->
<template>
  <a-modal
    :open="visible"
    :title="isEditing ? '编辑时间段' : '新增时间段'"
    @ok="handleSubmit"
    @cancel="handleCancel"
    :confirm-loading="loading"
    width="800px"
  >
    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
    >
      <a-form-item label="时间段名称" name="name">
        <a-input v-model:value="formData.name" placeholder="请输入时间段名称" />
      </a-form-item>

      <a-form-item label="时间段类型" name="type">
        <a-radio-group v-model:value="formData.type" @change="handleTypeChange">
          <a-radio value="work">工作时间</a-radio>
          <a-radio value="break">休息时间</a-radio>
          <a-radio value="overtime">加班时间</a-radio>
          <a-radio value="flexible">弹性时间</a-radio>
        </a-radio-group>
      </a-form-item>

      <a-form-item label="时间范围" name="timeRange">
        <a-time-range-picker
          v-model:value="formData.timeRange"
          format="HH:mm"
          placeholder="['开始时间', '结束时间']"
          style="width: 100%"
        />
      </a-form-item>

      <a-form-item label="跨天设置" name="crossDay" v-if="needCrossDay">
        <a-switch v-model:checked="formData.crossDay" @change="handleCrossDayChange" />
        <span style="margin-left: 8px; color: #666;">时间段跨越午夜</span>
      </a-form-item>

      <a-form-item label="工作时长" name="duration">
        <a-input-group compact>
          <a-input-number
            v-model:value="formData.duration.hours"
            :min="0"
            :max="24"
            placeholder="小时"
            style="width: 100px"
          />
          <a-input
            style="width: 30px; text-align: center; border-left: 0; pointer-events: none"
            placeholder="时"
            disabled
          />
          <a-input-number
            v-model:value="formData.duration.minutes"
            :min="0"
            :max="59"
            placeholder="分钟"
            style="width: 100px; border-left: 0"
          />
          <a-input
            style="width: 30px; text-align: center; border-left: 0; pointer-events: none"
            placeholder="分"
            disabled
          />
        </a-input-group>
      </a-form-item>

      <a-form-item label="计薪规则" name="payRule">
        <a-select v-model:value="formData.payRule" placeholder="请选择计薪规则">
          <a-select-option value="full">全额计薪</a-select-option>
          <a-select-option value="proportional">按比例计薪</a-select-option>
          <a-select-option value="overtime">加班计薪</a-select-option>
          <a-select-option value="none">不计薪</a-select-option>
        </a-select>
      </a-form-item>

      <a-form-item label="考勤要求" name="attendanceRequirement">
        <a-checkbox-group v-model:value="formData.attendanceRequirement">
          <a-checkbox value="clockIn">需要上班打卡</a-checkbox>
          <a-checkbox value="clockOut">需要下班打卡</a-checkbox>
          <a-checkbox value="gpsRequired">需要GPS定位</a-checkbox>
          <a-checkbox value="photoRequired">需要拍照验证</a-checkbox>
        </a-checkbox-group>
      </a-form-item>

      <a-form-item label="弹性设置" name="flexibleSettings" v-if="formData.type === 'flexible'">
        <div class="flexible-settings">
          <div class="setting-item">
            <label>最早打卡时间：</label>
            <a-time-picker
              v-model:value="formData.flexibleSettings.earliestClockIn"
              format="HH:mm"
              placeholder="选择时间"
            />
          </div>
          <div class="setting-item">
            <label>最晚打卡时间：</label>
            <a-time-picker
              v-model:value="formData.flexibleSettings.latestClockIn"
              format="HH:mm"
              placeholder="选择时间"
            />
          </div>
          <div class="setting-item">
            <label>最短工作时长：</label>
            <a-input-number
              v-model:value="formData.flexibleSettings.minWorkHours"
              :min="0"
              :max="24"
              :step="0.5"
              placeholder="小时"
            />
            <span style="margin-left: 8px;">小时</span>
          </div>
        </div>
      </a-form-item>

      <a-form-item label="描述" name="description">
        <a-textarea v-model:value="formData.description" placeholder="请输入时间段描述" :rows="3" />
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, computed, watch } from 'vue';
import { message } from 'ant-design-vue';
import dayjs from 'dayjs';
import { timePeriodApi } from '/@/api/business/attendance/shift/time-period-api';

const props = defineProps({
  visible: Boolean,
  isEditing: Boolean,
  periodData: Object,
});

const emit = defineEmits(['update:visible', 'success']);

const formRef = ref();
const loading = ref(false);

const formData = reactive({
  name: '',
  type: 'work',
  timeRange: [],
  crossDay: false,
  duration: {
    hours: 8,
    minutes: 0
  },
  payRule: 'full',
  attendanceRequirement: ['clockIn', 'clockOut'],
  flexibleSettings: {
    earliestClockIn: null,
    latestClockIn: null,
    minWorkHours: 8
  },
  description: ''
});

const formRules = {
  name: [
    { required: true, message: '请输入时间段名称', trigger: 'blur' }
  ],
  type: [
    { required: true, message: '请选择时间段类型', trigger: 'change' }
  ],
  timeRange: [
    { required: true, message: '请选择时间范围', trigger: 'change' }
  ],
  duration: [
    { required: true, message: '请设置工作时长', trigger: 'blur' }
  ],
  payRule: [
    { required: true, message: '请选择计薪规则', trigger: 'change' }
  ]
};

// 是否需要跨天设置
const needCrossDay = computed(() => {
  if (formData.timeRange.length === 2) {
    const start = formData.timeRange[0];
    const end = formData.timeRange[1];
    return start && end && end.isBefore(start);
  }
  return false;
});

// 监听props变化
watch(() => props.visible, (visible) => {
  if (visible) {
    initForm();
  }
});

// 监听时间范围变化，自动计算时长
watch(() => formData.timeRange, (newRange) => {
  if (newRange.length === 2 && newRange[0] && newRange[1]) {
    calculateDuration();
  }
});

// 初始化表单
const initForm = () => {
  if (props.isEditing && props.periodData) {
    Object.assign(formData, {
      ...props.periodData,
      timeRange: props.periodData.startTime && props.periodData.endTime
        ? [dayjs(props.periodData.startTime, 'HH:mm'), dayjs(props.periodData.endTime, 'HH:mm')]
        : []
    });
  } else {
    resetForm();
  }
};

// 重置表单
const resetForm = () => {
  Object.assign(formData, {
    name: '',
    type: 'work',
    timeRange: [],
    crossDay: false,
    duration: {
      hours: 8,
      minutes: 0
    },
    payRule: 'full',
    attendanceRequirement: ['clockIn', 'clockOut'],
    flexibleSettings: {
      earliestClockIn: null,
      latestClockIn: null,
      minWorkHours: 8
    },
    description: ''
  });
};

// 类型变化处理
const handleTypeChange = () => {
  // 根据类型设置默认值
  if (formData.type === 'break') {
    formData.payRule = 'none';
    formData.attendanceRequirement = [];
  } else if (formData.type === 'work') {
    formData.attendanceRequirement = ['clockIn', 'clockOut'];
  }
};

// 跨天设置变化
const handleCrossDayChange = (checked) => {
  if (!checked) {
    // 取消跨天时，调整时间范围
    if (formData.timeRange.length === 2) {
      const start = formData.timeRange[0];
      const end = formData.timeRange[1];
      if (start && end && end.isBefore(start)) {
        formData.timeRange[1] = start.add(8, 'hour');
      }
    }
  }
};

// 计算时长
const calculateDuration = () => {
  const start = formData.timeRange[0];
  const end = formData.timeRange[1];

  if (start && end) {
    let duration;
    if (formData.crossDay) {
      // 跨天计算
      duration = end.add(1, 'day').diff(start, 'minute');
    } else {
      duration = end.diff(start, 'minute');
    }

    formData.duration.hours = Math.floor(duration / 60);
    formData.duration.minutes = duration % 60;
  }
};

// 提交表单
const handleSubmit = async () => {
  try {
    await formRef.value.validate();
    loading.value = true;

    const submitData = {
      ...formData,
      startTime: formData.timeRange[0].format('HH:mm'),
      endTime: formData.timeRange[1].format('HH:mm'),
      duration: formData.duration.hours * 60 + formData.duration.minutes
    };

    if (props.isEditing) {
      await timePeriodApi.updateTimePeriod(props.periodData.id, submitData);
      message.success('时间段更新成功');
    } else {
      await timePeriodApi.createTimePeriod(submitData);
      message.success('时间段创建成功');
    }

    emit('success');
    handleCancel();
  } catch (error) {
    if (error.errorFields) {
      message.error('请检查表单填写是否正确');
    } else {
      message.error(props.isEditing ? '时间段更新失败' : '时间段创建失败');
    }
  } finally {
    loading.value = false;
  }
};

// 取消
const handleCancel = () => {
  emit('update:visible', false);
  formRef.value?.resetFields();
};
</script>

<style scoped lang="less">
.flexible-settings {
  .setting-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;

    label {
      width: 120px;
      text-align: right;
      margin-right: 8px;
      color: #666;
    }
  }
}
</style>
```

### 2. 班次管理

#### 班次卡片组件
```vue
<!-- src/views/business/attendance/shift/shift/components/ShiftCard.vue -->
<template>
  <div class="shift-card" :class="{ active: selected, disabled: !enabled }">
    <div class="card-header">
      <div class="shift-info">
        <h4 class="shift-name">{{ shiftData.name }}</h4>
        <a-tag :color="getShiftTypeColor(shiftData.type)">{{ getShiftTypeText(shiftData.type) }}</a-tag>
      </div>
      <div class="shift-actions">
        <a-dropdown>
          <template #overlay>
            <a-menu @click="({ key }) => handleMenuClick(key)">
              <a-menu-item key="edit">
                <EditOutlined />
                编辑
              </a-menu-item>
              <a-menu-item key="copy">
                <CopyOutlined />
                复制
              </a-menu-item>
              <a-menu-item key="config">
                <SettingOutlined />
                配置
              </a-menu-item>
              <a-menu-divider />
              <a-menu-item key="enable" v-if="!enabled">
                <CheckCircleOutlined />
                启用
              </a-menu-item>
              <a-menu-item key="disable" v-if="enabled">
                <StopOutlined />
                禁用
              </a-menu-item>
              <a-menu-item key="delete" class="danger">
                <DeleteOutlined />
                删除
              </a-menu-item>
            </a-menu>
          </template>
          <a-button type="text" size="small">
            <MoreOutlined />
          </a-button>
        </a-dropdown>
      </div>
    </div>

    <div class="card-content">
      <div class="time-periods">
        <div
          v-for="(period, index) in shiftData.timePeriods"
          :key="index"
          class="time-period"
        >
          <div class="period-time">
            <ClockCircleOutlined />
            {{ period.startTime }} - {{ period.endTime }}
          </div>
          <div class="period-info">
            <span class="period-name">{{ period.name }}</span>
            <span class="period-duration">{{ formatDuration(period.duration) }}</span>
          </div>
        </div>
      </div>

      <div class="shift-stats">
        <div class="stat-item">
          <span class="label">工作时长：</span>
          <span class="value">{{ getTotalWorkTime() }}</span>
        </div>
        <div class="stat-item">
          <span class="label">休息时长：</span>
          <span class="value">{{ getTotalBreakTime() }}</span>
        </div>
        <div class="stat-item">
          <span class="label">适用人数：</span>
          <span class="value">{{ shiftData.employeeCount || 0 }}人</span>
        </div>
      </div>
    </div>

    <div class="card-footer">
      <div class="shift-tags">
        <a-tag v-for="tag in shiftData.tags" :key="tag" size="small">{{ tag }}</a-tag>
      </div>
      <div class="shift-status">
        <a-badge :status="enabled ? 'success' : 'default'" />
        <span>{{ enabled ? '启用' : '禁用' }}</span>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue';
import {
  MoreOutlined,
  EditOutlined,
  CopyOutlined,
  SettingOutlined,
  CheckCircleOutlined,
  StopOutlined,
  DeleteOutlined,
  ClockCircleOutlined
} from '@ant-design/icons-vue';

const props = defineProps({
  shiftData: {
    type: Object,
    required: true
  },
  selected: {
    type: Boolean,
    default: false
  },
  enabled: {
    type: Boolean,
    default: true
  }
});

const emit = defineEmits(['edit', 'copy', 'config', 'enable', 'disable', 'delete', 'select']);

// 获取班次类型颜色
const getShiftTypeColor = (type) => {
  const colorMap = {
    standard: 'blue',
    rotation: 'green',
    special: 'orange',
    flexible: 'purple'
  };
  return colorMap[type] || 'default';
};

// 获取班次类型文本
const getShiftTypeText = (type) => {
  const typeMap = {
    standard: '标准班次',
    rotation: '轮班班次',
    special: '特殊班次',
    flexible: '弹性班次'
  };
  return typeMap[type] || '未知';
};

// 格式化时长
const formatDuration = (minutes) => {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours}小时${mins > 0 ? mins + '分钟' : ''}`;
};

// 计算总工作时间
const getTotalWorkTime = () => {
  const workPeriods = props.shiftData.timePeriods?.filter(p => p.type === 'work') || [];
  const totalMinutes = workPeriods.reduce((sum, period) => sum + (period.duration || 0), 0);
  return formatDuration(totalMinutes);
};

// 计算总休息时间
const getTotalBreakTime = () => {
  const breakPeriods = props.shiftData.timePeriods?.filter(p => p.type === 'break') || [];
  const totalMinutes = breakPeriods.reduce((sum, period) => sum + (period.duration || 0), 0);
  return formatDuration(totalMinutes);
};

// 菜单点击处理
const handleMenuClick = (key) => {
  switch (key) {
    case 'edit':
      emit('edit', props.shiftData);
      break;
    case 'copy':
      emit('copy', props.shiftData);
      break;
    case 'config':
      emit('config', props.shiftData);
      break;
    case 'enable':
      emit('enable', props.shiftData);
      break;
    case 'disable':
      emit('disable', props.shiftData);
      break;
    case 'delete':
      emit('delete', props.shiftData);
      break;
  }
};
</script>

<style scoped lang="less">
.shift-card {
  border: 1px solid #f0f0f0;
  border-radius: 8px;
  padding: 16px;
  background: #fff;
  cursor: pointer;
  transition: all 0.3s;
  height: 100%;
  display: flex;
  flex-direction: column;

  &:hover {
    border-color: #1890ff;
    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
  }

  &.active {
    border-color: #1890ff;
    background: #f0f8ff;
  }

  &.disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;

    .shift-info {
      flex: 1;

      .shift-name {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
        color: #262626;
      }
    }
  }

  .card-content {
    flex: 1;
    margin-bottom: 12px;

    .time-periods {
      margin-bottom: 12px;

      .time-period {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        background: #fafafa;
        border-radius: 4px;
        margin-bottom: 4px;

        .period-time {
          display: flex;
          align-items: center;
          gap: 6px;
          font-size: 14px;
          color: #1890ff;
          font-weight: 500;
        }

        .period-info {
          display: flex;
          align-items: center;
          gap: 8px;

          .period-name {
            font-size: 12px;
            color: #666;
          }

          .period-duration {
            font-size: 12px;
            color: #999;
          }
        }
      }
    }

    .shift-stats {
      .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 13px;

        .label {
          color: #666;
        }

        .value {
          font-weight: 500;
          color: #262626;
        }
      }
    }
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #f0f0f0;
    padding-top: 8px;

    .shift-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .shift-status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #666;
    }
  }
}
</style>
```

### 3. 班次模板应用

```vue
<!-- src/views/business/attendance/shift/template/components/TemplateApply.vue -->
<template>
  <div class="template-apply">
    <div class="apply-header">
      <h4>应用班次模板</h4>
      <a-steps :current="currentStep" size="small">
        <a-step title="选择模板" />
        <a-step title="配置参数" />
        <a-step title="确认应用" />
      </a-steps>
    </div>

    <!-- 步骤1：选择模板 -->
    <div v-show="currentStep === 0" class="step-content">
      <div class="template-selection">
        <div class="template-filters">
          <a-input-search
            v-model:value="searchKeyword"
            placeholder="搜索模板名称"
            style="width: 300px; margin-bottom: 16px"
            @search="handleSearch"
          />
        </div>

        <div class="template-grid">
          <div
            v-for="template in filteredTemplates"
            :key="template.id"
            class="template-item"
            :class="{ selected: selectedTemplateId === template.id }"
            @click="selectTemplate(template)"
          >
            <div class="template-preview">
              <div class="template-header">
                <h5>{{ template.name }}</h5>
                <a-tag :color="getTemplateTypeColor(template.type)">
                  {{ getTemplateTypeText(template.type) }}
                </a-tag>
              </div>
              <div class="template-info">
                <p class="template-desc">{{ template.description }}</p>
                <div class="template-meta">
                  <span><CalendarOutlined /> {{ getWeekdaysText(template.weekdays) }}</span>
                  <span><ClockCircleOutlined /> {{ template.shiftCount }}个班次</span>
                  <span><TeamOutlined /> 适用{{ template适用范围 || '全部' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 步骤2：配置参数 -->
    <div v-show="currentStep === 1" class="step-content">
      <a-form
        ref="configFormRef"
        :model="configForm"
        :rules="configRules"
        layout="vertical"
      >
        <a-form-item label="应用范围" name="scope">
          <a-radio-group v-model:value="configForm.scope.type">
            <a-radio value="department">部门</a-radio>
            <a-radio value="position">岗位</a-radio>
            <a-radio value="employee">员工</a-radio>
          </a-radio-group>
        </a-form-item>

        <a-form-item name="scope" v-if="configForm.scope.type">
          <a-select
            v-model:value="configForm.scope.targets"
            mode="multiple"
            :placeholder="getScopePlaceholder(configForm.scope.type)"
            style="width: 100%"
          >
            <a-select-option
              v-for="item in scopeOptions"
              :key="item.id"
              :value="item.id"
            >
              {{ item.name }}
            </a-select-option>
          </a-select>
        </a-form-item>

        <a-form-item label="应用时间" name="dateRange">
          <a-range-picker
            v-model:value="configForm.dateRange"
            style="width: 100%"
            :disabled-date="disabledDate"
          />
        </a-form-item>

        <a-form-item label="覆盖规则" name="overwriteRule">
          <a-radio-group v-model:value="configForm.overwriteRule">
            <a-radio value="none">不覆盖现有排班</a-radio>
            <a-radio value="empty">仅覆盖空缺排班</a-radio>
            <a-radio value="all">覆盖所有排班</a-radio>
          </a-radio-group>
        </a-form-item>

        <a-form-item label="特殊日期处理" name="specialDateHandling">
          <a-checkbox-group v-model:value="configForm.specialDateHandling">
            <a-checkbox value="holiday">跳过节假日</a-checkbox>
            <a-checkbox value="weekend">跳过周末</a-checkbox>
            <a-checkbox value="custom">跳过自定义日期</a-checkbox>
          </a-checkbox-group>
        </a-form-item>

        <a-form-item label="自定义跳过日期" name="skipDates" v-if="configForm.specialDateHandling.includes('custom')">
          <a-range-picker
            v-model:value="configForm.skipDates"
            mode="multiple"
            style="width: 100%"
          />
        </a-form-item>

        <a-form-item label="通知设置" name="notification">
          <a-checkbox v-model:checked="configForm.notification.enabled">
            应用后通知相关人员
          </a-checkbox>
          <div v-if="configForm.notification.enabled" style="margin-top: 8px;">
            <a-checkbox-group v-model:value="configForm.notification.channels">
              <a-checkbox value="app">APP推送</a-checkbox>
              <a-checkbox value="email">邮件</a-checkbox>
              <a-checkbox value="sms">短信</a-checkbox>
            </a-checkbox-group>
          </div>
        </a-form-item>
      </a-form>
    </div>

    <!-- 步骤3：确认应用 -->
    <div v-show="currentStep === 2" class="step-content">
      <div class="apply-preview">
        <a-descriptions title="应用预览" bordered :column="2">
          <a-descriptions-item label="模板名称">
            {{ selectedTemplate?.name }}
          </a-descriptions-item>
          <a-descriptions-item label="应用范围">
            {{ getScopeText() }}
          </a-descriptions-item>
          <a-descriptions-item label="应用时间">
            {{ formatDateRange(configForm.dateRange) }}
          </a-descriptions-item>
          <a-descriptions-item label="覆盖规则">
            {{ getOverwriteRuleText() }}
          </a-descriptions-item>
          <a-descriptions-item label="影响人数" :span="2">
            {{ affectedCount }}人
          </a-descriptions-item>
        </a-descriptions>

        <div class="preview-calendar">
          <h5>排班预览</h5>
          <a-calendar v-model:value="previewDate" :fullscreen="false">
            <template #dateCellRender="{ current }">
              <div class="calendar-cell">
                <div class="date-number">{{ current.date() }}</div>
                <div v-if="hasShiftOnDate(current)" class="shift-indicator">
                  <a-badge status="success" />
                  <span class="shift-name">{{ getShiftOnDate(current) }}</span>
                </div>
              </div>
            </template>
          </a-calendar>
        </div>
      </div>
    </div>

    <div class="apply-actions">
      <a-button v-if="currentStep > 0" @click="prevStep">上一步</a-button>
      <a-button v-if="currentStep < 2" type="primary" @click="nextStep">下一步</a-button>
      <a-button v-if="currentStep === 2" type="primary" @click="handleApply" :loading="applying">
        确认应用
      </a-button>
      <a-button @click="handleCancel">取消</a-button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import { CalendarOutlined, ClockCircleOutlined, TeamOutlined } from '@ant-design/icons-vue';
import { templateApi } from '/@/api/business/attendance/shift/template-api';
import dayjs from 'dayjs';

const props = defineProps({
  visible: Boolean,
});

const emit = defineEmits(['update:visible', 'success']);

const currentStep = ref(0);
const searchKeyword = ref('');
const selectedTemplateId = ref(null);
const selectedTemplate = computed(() => templates.value.find(t => t.id === selectedTemplateId.value));
const applying = ref(false);
const previewDate = ref(dayjs());
const affectedCount = ref(0);

const templates = ref([]);
const scopeOptions = ref([]);

const configForm = reactive({
  scope: {
    type: '',
    targets: []
  },
  dateRange: [],
  overwriteRule: 'none',
  specialDateHandling: [],
  skipDates: [],
  notification: {
    enabled: false,
    channels: []
  }
});

const configFormRef = ref();

const configRules = {
  'scope.type': [
    { required: true, message: '请选择应用范围', trigger: 'change' }
  ],
  'scope.targets': [
    { required: true, message: '请选择具体目标', trigger: 'change' }
  ],
  dateRange: [
    { required: true, message: '请选择应用时间', trigger: 'change' }
  ],
  overwriteRule: [
    { required: true, message: '请选择覆盖规则', trigger: 'change' }
  ]
};

// 过滤后的模板列表
const filteredTemplates = computed(() => {
  if (!searchKeyword.value) return templates.value;
  return templates.value.filter(template =>
    template.name.toLowerCase().includes(searchKeyword.value.toLowerCase()) ||
    template.description.toLowerCase().includes(searchKeyword.value.toLowerCase())
  );
});

// 加载模板列表
const loadTemplates = async () => {
  try {
    const response = await templateApi.getShiftTemplates();
    templates.value = response.data;
  } catch (error) {
    console.error('加载模板失败:', error);
  }
};

// 加载应用范围选项
const loadScopeOptions = async () => {
  try {
    // 根据选择的范围类型加载对应选项
    const response = await templateApi.getScopeOptions();
    scopeOptions.value = response.data;
  } catch (error) {
    console.error('加载范围选项失败:', error);
  }
};

// 选择模板
const selectTemplate = (template) => {
  selectedTemplateId.value = template.id;
};

// 搜索模板
const handleSearch = () => {
  // 搜索逻辑已在computed中实现
};

// 获取模板类型颜色
const getTemplateTypeColor = (type) => {
  const colorMap = {
    department: 'blue',
    personal: 'green',
    special: 'orange'
  };
  return colorMap[type] || 'default';
};

// 获取模板类型文本
const getTemplateTypeText = (type) => {
  const typeMap = {
    department: '部门模板',
    personal: '个人模板',
    special: '特殊模板'
  };
  return typeMap[type] || '未知';
};

// 获取工作日文本
const getWeekdaysText = (weekdays) => {
  const dayNames = ['', '周一', '周二', '周三', '周四', '周五', '周六', '周日'];
  return weekdays.map(day => dayNames[day]).join('、');
};

// 获取范围占位符
const getScopePlaceholder = (type) => {
  const placeholders = {
    department: '请选择部门',
    position: '请选择岗位',
    employee: '请选择员工'
  };
  return placeholders[type] || '请选择';
};

// 禁用日期
const disabledDate = (current) => {
  return current && current < dayjs().startOf('day');
};

// 下一步
const nextStep = async () => {
  if (currentStep.value === 0) {
    if (!selectedTemplateId.value) {
      message.warning('请选择一个模板');
      return;
    }
  } else if (currentStep.value === 1) {
    try {
      await configFormRef.value.validate();
      // 计算影响人数
      await calculateAffectedCount();
    } catch (error) {
      return;
    }
  }
  currentStep.value++;
};

// 上一步
const prevStep = () => {
  currentStep.value--;
};

// 计算影响人数
const calculateAffectedCount = async () => {
  try {
    const response = await templateApi.calculateAffectedCount({
      templateId: selectedTemplateId.value,
      scope: configForm.scope,
      dateRange: configForm.dateRange
    });
    affectedCount.value = response.data.count;
  } catch (error) {
    console.error('计算影响人数失败:', error);
  }
};

// 获取范围文本
const getScopeText = () => {
  const typeText = {
    department: '部门',
    position: '岗位',
    employee: '员工'
  };
  return `${typeText[configForm.scope.type]} (${configForm.scope.targets.length}个)`;
};

// 格式化日期范围
const formatDateRange = (dateRange) => {
  if (!dateRange || dateRange.length !== 2) return '';
  return `${dateRange[0].format('YYYY-MM-DD')} 至 ${dateRange[1].format('YYYY-MM-DD')}`;
};

// 获取覆盖规则文本
const getOverwriteRuleText = () => {
  const ruleText = {
    none: '不覆盖现有排班',
    empty: '仅覆盖空缺排班',
    all: '覆盖所有排班'
  };
  return ruleText[configForm.overwriteRule];
};

// 检查日期是否有班次
const hasShiftOnDate = (date) => {
  // 模拟逻辑：根据模板和应用配置判断
  return selectedTemplate.value?.weekdays?.includes(date.day() + 1);
};

// 获取日期的班次名称
const getShiftOnDate = (date) => {
  // 模拟逻辑
  return selectedTemplate.value?.defaultShift || '标准班次';
};

// 应用模板
const handleApply = async () => {
  applying.value = true;
  try {
    await templateApi.applyShiftTemplate({
      templateId: selectedTemplateId.value,
      config: configForm
    });
    message.success('模板应用成功');
    emit('success');
    handleCancel();
  } catch (error) {
    message.error('模板应用失败');
  } finally {
    applying.value = false;
  }
};

// 取消
const handleCancel = () => {
  emit('update:visible', false);
  currentStep.value = 0;
  selectedTemplateId.value = null;
  configFormRef.value?.resetFields();
};

onMounted(() => {
  loadTemplates();
  loadScopeOptions();
});
</script>

<style scoped lang="less">
.template-apply {
  .apply-header {
    margin-bottom: 24px;

    h4 {
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
    }
  }

  .step-content {
    min-height: 400px;
    margin-bottom: 24px;

    .template-selection {
      .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;

        .template-item {
          border: 1px solid #f0f0f0;
          border-radius: 8px;
          padding: 16px;
          cursor: pointer;
          transition: all 0.3s;

          &:hover {
            border-color: #1890ff;
          }

          &.selected {
            border-color: #1890ff;
            background: #f0f8ff;
          }

          .template-preview {
            .template-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 8px;

              h5 {
                margin: 0;
                font-size: 14px;
                font-weight: 600;
              }
            }

            .template-desc {
              color: #666;
              font-size: 12px;
              margin-bottom: 8px;
              line-height: 1.4;
            }

            .template-meta {
              display: flex;
              flex-wrap: wrap;
              gap: 12px;

              span {
                display: flex;
                align-items: center;
                gap: 4px;
                font-size: 12px;
                color: #999;
              }
            }
          }
        }
      }
    }

    .apply-preview {
      .preview-calendar {
        margin-top: 24px;

        h5 {
          margin-bottom: 16px;
          font-weight: 600;
        }

        .calendar-cell {
          height: 60px;
          padding: 4px;

          .date-number {
            font-weight: 500;
            margin-bottom: 4px;
          }

          .shift-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;

            .shift-name {
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }
          }
        }
      }
    }
  }

  .apply-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
  }
}
</style>
```

## Mock数据示例

```javascript
// src/mock/shift-mock.js
export const mockTimePeriods = [
  {
    id: 'tp001',
    name: '标准工作时间',
    type: 'work',
    startTime: '09:00',
    endTime: '18:00',
    duration: 480,
    payRule: 'full',
    attendanceRequirement: ['clockIn', 'clockOut']
  },
  {
    id: 'tp002',
    name: '午休时间',
    type: 'break',
    startTime: '12:00',
    endTime: '13:00',
    duration: 60,
    payRule: 'none',
    attendanceRequirement: []
  },
  {
    id: 'tp003',
    name: '弹性工作时间段',
    type: 'flexible',
    startTime: '08:00',
    endTime: '20:00',
    duration: 480,
    payRule: 'full',
    flexibleSettings: {
      earliestClockIn: '08:00',
      latestClockIn: '10:00',
      minWorkHours: 8
    }
  }
];

export const mockShifts = [
  {
    id: 'shift001',
    name: '标准早班',
    type: 'standard',
    timePeriods: [
      { id: 'tp001', name: '标准工作时间', startTime: '09:00', endTime: '18:00', duration: 480, type: 'work' },
      { id: 'tp002', name: '午休时间', startTime: '12:00', endTime: '13:00', duration: 60, type: 'break' }
    ],
    tags: ['常规', '日间'],
    employeeCount: 500,
    enabled: true
  },
  {
    id: 'shift002',
    name: '夜班',
    type: 'standard',
    timePeriods: [
      { id: 'tp004', name: '夜班工作时间', startTime: '22:00', endTime: '06:00', duration: 480, type: 'work' }
    ],
    tags: ['夜间', '跨天'],
    employeeCount: 100,
    enabled: true
  }
];

export const mockShiftTemplates = [
  {
    id: 'tpl001',
    name: '标准五天工作制',
    type: 'department',
    description: '周一至周五标准工作时间，适用于大部分办公室岗位',
    weekdays: [1, 2, 3, 4, 5],
    shiftCount: 1,
    defaultShift: '标准早班',
    applicableScope: '办公室员工'
  },
  {
    id: 'tpl002',
    name: '轮班工作制',
    type: 'department',
    description: '三班倒轮班制度，适用于生产一线',
    weekdays: [1, 2, 3, 4, 5, 6, 7],
    shiftCount: 3,
    rotationCycle: 7,
    applicableScope: '生产线员工'
  }
];

export default {
  mockTimePeriods,
  mockShifts,
  mockShiftTemplates
};
```

## 开发注意事项总结

### 核心功能要点
1. **时间段管理** - 灵活的时间段配置和组合
2. **班次配置** - 多种班次类型的支持
3. **关联管理** - 班次与时间的动态关联
4. **模板系统** - 快速应用常用配置
5. **批量操作** - 高效的批量配置功能
6. **预览验证** - 应用前的效果预览

### 性能优化建议
1. 班次计算采用缓存机制
2. 大量数据分页加载
3. 模板预览异步计算
4. 日历组件虚拟滚动

### 用户体验优化
1. 可视化的时间配置界面
2. 拖拽式的班次组合
3. 实时的效果预览
4. 智能的冲突检测

## 总结

班次时间管理模块作为考勤系统的时间配置核心，需要重点关注：

- 时间配置的灵活性和准确性
- 班次组合的便捷性和直观性
- 模板应用的效率和可靠性
- 关联关系的清晰表达
- 用户体验的友好性

通过遵循本文档的技术规范，可以构建出功能完善、操作便捷的班次时间管理模块。