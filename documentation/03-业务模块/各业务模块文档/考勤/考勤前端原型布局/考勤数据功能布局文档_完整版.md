# 考勤数据功能布局文档 - 完整版

## 功能概述

考勤数据模块是系统的数据处理和分析中心，包含打卡记录、考勤计算、考勤结果、预警记录等功能。该模块负责考勤数据的采集、清洗、计算、存储和分析，提供智能的找班匹配算法、准确的考勤计算引擎、完善的异常检测机制，确保考勤数据的准确性和完整性。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **数据表格**: VXE Table (高性能表格)
- **图表组件**: ECharts 5.x
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue

### 项目文件组织结构
```
src/views/business/attendance/data/
├── index.vue                        # 考勤数据主页面
├── clock-records/
│   ├── index.vue                   # 打卡记录页面
│   ├── components/
│   │   ├── RecordTable.vue         # 记录表格组件
│   │   ├── RecordFilter.vue        # 记录筛选组件
│   │   ├── RecordDetail.vue        # 记录详情组件
│   │   └── RecordStatistics.vue    # 记录统计组件
│   └── api/
│       └── clock-records-api.js    # 打卡记录API
├── calculation/
│   ├── index.vue                   # 考勤计算页面
│   ├── components/
│   │   ├── SmartMatching.vue       # 智能找班组件
│   │   ├── CalculationEngine.vue   # 计算引擎组件
│   │   ├── RuleConfig.vue         # 计算规则配置
│   │   └── ExceptionHandler.vue    # 异常处理组件
│   └── api/
│       └── calculation-api.js      # 考勤计算API
├── results/
│   ├── index.vue                   # 考勤结果页面
│   ├── components/
│   │   ├── DailyResults.vue        # 日考勤结果
│   │   ├── MonthlyResults.vue      # 月考勤结果
│   │   ├── ResultCorrection.vue    # 结果修正
│   │   └── ResultStatistics.vue    # 结果统计
│   └── api/
│       └── results-api.js          # 考勤结果API
├── alerts/
│   ├── index.vue                   # 预警记录页面
│   ├── components/
│   │   ├── AlertList.vue           # 预警列表组件
│   │   ├── AlertDetail.vue         # 预警详情组件
│   │   ├── AlertProcessor.vue      # 预警处理组件
│   │   └── AlertStatistics.vue     # 预警统计组件
│   └── api/
│       └── alerts-api.js           # 预警API
├── mock/
│   └── data-mock.js                # 模拟数据
├── api/
│   └── data-api.js                 # 统一API接口
└── utils/
    ├── data-processor.js           # 数据处理工具
    ├── calculation-engine.js       # 计算引擎工具
    └── alert-detector.js           # 预警检测工具
```

### API接口设计
```javascript
// src/api/business/attendance/data/clock-records-api.js
import { postRequest, getRequest, putRequest, deleteRequest } from '/@/lib/axios';

export const clockRecordsApi = {
  // 打卡记录
  getClockRecords: (params) => getRequest('/attendance/data/clock-records', params),
  getClockRecordById: (id) => getRequest(`/attendance/data/clock-records/${id}`),
  createClockRecord: (params) => postRequest('/attendance/data/clock-records/create', params),
  updateClockRecord: (id, params) => putRequest(`/attendance/data/clock-records/${id}`, params),
  deleteClockRecord: (id) => deleteRequest(`/attendance/data/clock-records/${id}`),

  // 实时打卡记录
  getRealTimeRecords: (params) => getRequest('/attendance/data/clock-records/realtime', params),
  getExceptionRecords: (params) => getRequest('/attendance/data/clock-records/exceptions', params),

  // 打卡统计
  getClockStatistics: (params) => getRequest('/attendance/data/clock-records/statistics', params),
  exportClockRecords: (params) => postRequest('/attendance/data/clock-records/export', params),
};

// src/api/business/attendance/data/calculation-api.js
export const calculationApi = {
  // 智能找班
  getSmartMatching: (params) => getRequest('/attendance/data/calculation/smart-matching', params),
  executeSmartMatching: (params) => postRequest('/attendance/data/calculation/match-shift', params),

  // 考勤计算
  calculateAttendance: (params) => postRequest('/attendance/data/calculation/calculate', params),
  getCalculationProgress: (taskId) => getRequest(`/attendance/data/calculation/progress/${taskId}`),
  cancelCalculation: (taskId) => postRequest(`/attendance/data/calculation/cancel/${taskId}`),

  // 计算规则
  getCalculationRules: () => getRequest('/attendance/data/calculation/rules'),
  updateCalculationRule: (id, params) => putRequest(`/attendance/data/calculation/rule/${id}`, params),

  // 异常处理
  getCalculationExceptions: (params) => getRequest('/attendance/data/calculation/exceptions', params),
  resolveCalculationException: (id, params) => postRequest(`/attendance/data/calculation/resolve-exception/${id}`, params),
};

// src/api/business/attendance/data/results-api.js
export const resultsApi = {
  // 考勤结果
  getDailyResults: (params) => getRequest('/attendance/data/results/daily', params),
  getMonthlyResults: (params) => getRequest('/attendance/data/results/monthly', params),
  getResultById: (id) => getRequest(`/attendance/data/results/${id}`),

  // 结果修正
  correctResult: (id, params) => postRequest(`/attendance/data/results/${id}/correct`, params),
  batchCorrectResults: (params) => postRequest('/attendance/data/results/batch-correct', params),

  // 结果统计
  getResultStatistics: (params) => getRequest('/attendance/data/results/statistics', params),
  exportResults: (params) => postRequest('/attendance/data/results/export', params),
};
```

## 核心功能模块

### 1. 智能找班匹配

```vue
<!-- src/views/business/attendance/data/calculation/components/SmartMatching.vue -->
<template>
  <div class="smart-matching">
    <div class="matching-header">
      <h3>智能找班匹配</h3>
      <div class="matching-actions">
        <a-button @click="showSettings">
          <template #icon><SettingOutlined /></template>
          匹配设置
        </a-button>
        <a-button type="primary" @click="executeMatching" :loading="matching">
          <template #icon><ThunderboltOutlined /></template>
          执行匹配
        </a-button>
      </div>
    </div>

    <!-- 匹配配置 -->
    <div class="matching-config">
      <a-form layout="vertical" :model="matchingConfig">
        <a-row :gutter="16">
          <a-col :span="8">
            <a-form-item label="匹配日期范围">
              <a-range-picker
                v-model:value="matchingConfig.dateRange"
                style="width: 100%"
                :shortcuts="dateShortcuts"
              />
            </a-form-item>
          </a-col>
          <a-col :span="8">
            <a-form-item label="匹配范围">
              <a-select
                v-model:value="matchingConfig.scope"
                placeholder="选择匹配范围"
                style="width: 100%"
              >
                <a-select-option value="all">全部员工</a-select-option>
                <a-select-option value="department">指定部门</a-select-option>
                <a-select-option value="individual">指定员工</a-select-option>
                <a-select-option value="exception">异常记录</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :span="8">
            <a-form-item label="匹配模式">
              <a-select
                v-model:value="matchingConfig.mode"
                placeholder="选择匹配模式"
                style="width: 100%"
              >
                <a-select-option value="standard">标准匹配</a-select-option>
                <a-select-option value="fuzzy">模糊匹配</a-select-option>
                <a-select-option value="strict">严格匹配</a-select-option>
                <a-select-option value="intelligent">智能匹配</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
        </a-row>

        <a-form-item label="匹配规则">
          <a-checkbox-group v-model:value="matchingConfig.rules">
            <a-checkbox value="time_based">基于时间匹配</a-checkbox>
            <a-checkbox value="location_based">基于地点匹配</a-checkbox>
            <a-checkbox value="device_based">基于设备匹配</a-checkbox>
            <a-checkbox value="employee_preference">员工偏好匹配</a-checkbox>
            <a-checkbox value="department_rule">部门规则匹配</a-checkbox>
          </a-checkbox-group>
        </a-form-item>
      </a-form>
    </div>

    <!-- 匹配进度 -->
    <div class="matching-progress" v-if="matching || progressVisible">
      <a-card title="匹配进度" :bordered="false">
        <div class="progress-content">
          <a-progress
            :percent="progressPercent"
            :status="progressStatus"
            stroke-linecap="square"
          />

          <div class="progress-details">
            <a-descriptions :column="3" size="small">
              <a-descriptions-item label="当前阶段">
                {{ currentPhase }}
              </a-descriptions-item>
              <a-descriptions-item label="已处理记录">
                {{ processedRecords }}/{{ totalRecords }}
              </a-descriptions-item>
              <a-descriptions-item label="匹配成功率">
                {{ successRate }}%
              </a-descriptions-item>
            </a-descriptions>
          </div>

          <div class="progress-log">
            <h5>处理日志</h5>
            <div class="log-container">
              <div
                v-for="(log, index) in processingLogs"
                :key="index"
                class="log-item"
                :class="log.type"
              >
                <span class="log-time">{{ log.time }}</span>
                <span class="log-message">{{ log.message }}</span>
              </div>
            </div>
          </div>
        </div>
      </a-card>
    </div>

    <!-- 匹配结果 -->
    <div class="matching-results" v-if="resultsVisible">
      <a-card title="匹配结果" :bordered="false">
        <template #extra>
          <a-space>
            <a-button @click="exportResults">
              <template #icon><ExportOutlined /></template>
              导出结果
            </a-button>
            <a-button type="primary" @click="applyResults">
              <template #icon><CheckOutlined /></template>
              应用结果
            </a-button>
          </a-space>
        </template>

        <a-row :gutter="16" style="margin-bottom: 16px;">
          <a-col :span="6">
            <a-statistic
              title="总记录数"
              :value="results.totalRecords"
              :value-style="{ color: '#1890ff' }"
            />
          </a-col>
          <a-col :span="6">
            <a-statistic
              title="成功匹配"
              :value="results.successfulMatches"
              :value-style="{ color: '#52c41a' }"
            />
          </a-col>
          <a-col :span="6">
            <a-statistic
              title="匹配失败"
              :value="results.failedMatches"
              :value-style="{ color: '#ff4d4f' }"
            />
          </a-col>
          <a-col :span="6">
            <a-statistic
              title="成功率"
              :value="results.successRate"
              suffix="%"
              :value-style="{ color: '#fa8c16' }"
            />
          </a-col>
        </a-row>

        <a-tabs>
          <a-tab-pane key="successful" tab="成功匹配">
            <MatchingResultTable
              :data="results.successfulData"
              :type="'successful'"
              @view-detail="handleViewDetail"
            />
          </a-tab-pane>
          <a-tab-pane key="failed" tab="匹配失败">
            <MatchingResultTable
              :data="results.failedData"
              :type="'failed'"
              @retry-match="handleRetryMatch"
              @manual-match="handleManualMatch"
            />
          </a-tab-pane>
          <a-tab-pane key="statistics" tab="统计分析">
            <MatchingStatistics :statistics="results.statistics" />
          </a-tab-pane>
        </a-tabs>
      </a-card>
    </div>

    <!-- 手动匹配弹窗 -->
    <a-modal
      v-model:open="manualMatchVisible"
      title="手动匹配"
      @ok="handleManualMatchConfirm"
      @cancel="manualMatchVisible = false"
      width="800px"
    >
      <ManualMatchingForm
        :record="currentRecord"
        @match-success="handleManualMatchSuccess"
      />
    </a-modal>

    <!-- 匹配设置弹窗 -->
    <MatchingSettings
      v-model:visible="settingsVisible"
      :settings="matchingSettings"
      @save="handleSaveSettings"
    />
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  SettingOutlined,
  ThunderboltOutlined,
  ExportOutlined,
  CheckOutlined
} from '@ant-design/icons-vue';
import { calculationApi } from '/@/api/business/attendance/data/calculation-api';
import dayjs from 'dayjs';
import MatchingResultTable from './MatchingResultTable.vue';
import MatchingStatistics from './MatchingStatistics.vue';
import ManualMatchingForm from './ManualMatchingForm.vue';
import MatchingSettings from './MatchingSettings.vue';

const emit = defineEmits(['matching-complete', 'results-applied']);

const matching = ref(false);
const progressVisible = ref(false);
const resultsVisible = ref(false);
const settingsVisible = ref(false);
const manualMatchVisible = ref(false);

const progressPercent = ref(0);
const progressStatus = ref('active');
const currentPhase = ref('');
const processedRecords = ref(0);
const totalRecords = ref(0);
const successRate = ref(0);
const processingLogs = ref([]);
const currentRecord = ref(null);

const matchingSettings = ref({});

const matchingConfig = reactive({
  dateRange: [
    dayjs().subtract(7, 'day'),
    dayjs()
  ],
  scope: 'all',
  mode: 'intelligent',
  rules: ['time_based', 'location_based', 'employee_preference']
});

const results = reactive({
  totalRecords: 0,
  successfulMatches: 0,
  failedMatches: 0,
  successRate: 0,
  successfulData: [],
  failedData: [],
  statistics: {}
});

const dateShortcuts = [
  {
    text: '最近7天',
    value: () => [dayjs().subtract(7, 'day'), dayjs()],
  },
  {
    text: '最近30天',
    value: () => [dayjs().subtract(30, 'day'), dayjs()],
  },
  {
    text: '本月',
    value: () => [dayjs().startOf('month'), dayjs().endOf('month')],
  },
];

// 执行匹配
const executeMatching = async () => {
  if (!validateConfig()) {
    return;
  }

  matching.value = true;
  progressVisible.value = true;
  resultsVisible.value = false;
  progressPercent.value = 0;
  progressStatus.value = 'active';
  processingLogs.value = [];

  try {
    const params = {
      ...matchingConfig,
      startDate: matchingConfig.dateRange[0].format('YYYY-MM-DD'),
      endDate: matchingConfig.dateRange[1].format('YYYY-MM-DD'),
      settings: matchingSettings.value
    };

    const response = await calculationApi.executeSmartMatching(params);
    const taskId = response.data.taskId;

    startProgressMonitoring(taskId);
  } catch (error) {
    matching.value = false;
    progressVisible.value = false;
    message.error('启动匹配失败');
  }
};

// 验证配置
const validateConfig = () => {
  if (!matchingConfig.dateRange || matchingConfig.dateRange.length !== 2) {
    message.warning('请选择匹配日期范围');
    return false;
  }

  return true;
};

// 开始进度监控
const startProgressMonitoring = (taskId) => {
  const monitor = setInterval(async () => {
    try {
      const response = await calculationApi.getCalculationProgress(taskId);
      const progress = response.data;

      progressPercent.value = progress.percent;
      currentPhase.value = progress.currentPhase;
      processedRecords.value = progress.processedRecords;
      totalRecords.value = progress.totalRecords;
      successRate.value = progress.successRate;

      // 添加处理日志
      if (progress.logs) {
        progress.logs.forEach(log => {
          if (!processingLogs.value.find(l => l.id === log.id)) {
            processingLogs.value.push(log);
          }
        });
      }

      if (progress.status === 'completed') {
        completeMatching(progress.results);
        clearInterval(monitor);
      } else if (progress.status === 'failed') {
        failMatching(progress.error);
        clearInterval(monitor);
      }
    } catch (error) {
      console.error('获取进度失败:', error);
    }
  }, 1000);
};

// 完成匹配
const completeMatching = (matchResults) => {
  matching.value = false;
  progressStatus.value = 'success';

  Object.assign(results, matchResults);
  resultsVisible.value = true;

  message.success('智能匹配完成');
  emit('matching-complete', matchResults);
};

// 匹配失败
const failMatching = (error) => {
  matching.value = false;
  progressStatus.value = 'exception';
  message.error(`匹配失败: ${error}`);
};

// 显示设置
const showSettings = () => {
  settingsVisible.value = true;
};

// 保存设置
const handleSaveSettings = async (settings) => {
  try {
    matchingSettings.value = { ...settings };
    message.success('匹配设置保存成功');
  } catch (error) {
    message.error('保存设置失败');
  }
};

// 查看详情
const handleViewDetail = (record) => {
  // 查看匹配详情
  console.log('查看详情:', record);
};

// 重试匹配
const handleRetryMatch = async (record) => {
  try {
    await calculationApi.retryMatch(record.id);
    message.success('重试匹配已提交');
  } catch (error) {
    message.error('重试失败');
  }
};

// 手动匹配
const handleManualMatch = (record) => {
  currentRecord.value = record;
  manualMatchVisible.value = true;
};

// 手动匹配确认
const handleManualMatchConfirm = () => {
  manualMatchVisible.value = false;
};

// 手动匹配成功
const handleManualMatchSuccess = () => {
  manualMatchVisible.value = false;
  // 刷新结果
  loadMatchingResults();
};

// 导出结果
const exportResults = () => {
  // 导出匹配结果
  message.info('导出功能开发中...');
};

// 应用结果
const applyResults = async () => {
  try {
    // 应用匹配结果
    message.success('匹配结果应用成功');
    emit('results-applied', results);
  } catch (error) {
    message.error('应用结果失败');
  }
};

// 加载匹配结果
const loadMatchingResults = async () => {
  // 重新加载匹配结果
};

onMounted(() => {
  // 初始化
});
</script>

<style scoped lang="less">
.smart-matching {
  .matching-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;

    h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
  }

  .matching-config {
    margin-bottom: 16px;
  }

  .matching-progress {
    margin-bottom: 16px;

    .progress-content {
      .progress-details {
        margin: 16px 0;
      }

      .progress-log {
        h5 {
          margin-bottom: 8px;
        }

        .log-container {
          height: 200px;
          overflow-y: auto;
          border: 1px solid #f0f0f0;
          border-radius: 4px;
          padding: 8px;
          background: #fafafa;

          .log-item {
            display: flex;
            margin-bottom: 4px;
            font-size: 12px;

            .log-time {
              color: #999;
              margin-right: 8px;
              flex-shrink: 0;
            }

            .log-message {
              flex: 1;
            }

            &.success {
              color: #52c41a;
            }

            &.error {
              color: #ff4d4f;
            }

            &.warning {
              color: #faad14;
            }
          }
        }
      }
    }
  }

  .matching-results {
    .result-tabs {
      min-height: 400px;
    }
  }
}
</style>
```

### 2. 考勤结果表格

```vue
<!-- src/views/business/attendance/data/results/components/DailyResults.vue -->
<template>
  <div class="daily-results">
    <!-- 筛选工具栏 -->
    <div class="filter-toolbar">
      <a-form layout="inline" :model="filterForm" @finish="handleFilter">
        <a-form-item label="日期范围">
          <a-range-picker
            v-model:value="filterForm.dateRange"
            :shortcuts="dateShortcuts"
            @change="handleDateChange"
          />
        </a-form-item>
        <a-form-item label="部门">
          <a-tree-select
            v-model:value="filterForm.departments"
            :tree-data="departmentTree"
            placeholder="选择部门"
            multiple
            tree-checkable
            style="width: 200px"
          />
        </a-form-item>
        <a-form-item label="员工">
          <a-select
            v-model:value="filterForm.employees"
            mode="multiple"
            placeholder="选择员工"
            style="width: 200px"
            show-search
            :filter-option="filterEmployeeOption"
          >
            <a-select-option
              v-for="employee in employeeList"
              :key="employee.id"
              :value="employee.id"
            >
              {{ employee.name }} - {{ employee.department }}
            </a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="状态">
          <a-select
            v-model:value="filterForm.status"
            mode="multiple"
            placeholder="选择状态"
            style="width: 150px"
          >
            <a-select-option value="normal">正常</a-select-option>
            <a-select-option value="late">迟到</a-select-option>
            <a-select-option value="early">早退</a-select-option>
            <a-select-option value="absent">缺勤</a-select-option>
            <a-select-option value="leave">请假</a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item>
          <a-button type="primary" html-type="submit" :loading="loading">
            <template #icon><SearchOutlined /></template>
            查询
          </a-button>
          <a-button @click="handleReset">
            <template #icon><ReloadOutlined /></template>
            重置
          </a-button>
        </a-form-item>
      </a-form>
    </div>

    <!-- 操作工具栏 -->
    <div class="action-toolbar">
      <div class="actions-left">
        <a-button @click="handleRecalculate" :loading="calculating">
          <template #icon><CalculatorOutlined /></template>
          重新计算
        </a-button>
        <a-button @click="handleBatchCorrect">
          <template #icon><EditOutlined /></template>
          批量修正
        </a-button>
        <a-button @click="handleExport">
          <template #icon><ExportOutlined /></template>
          导出
        </a-button>
      </div>
      <div class="actions-right">
        <a-button @click="handleRefresh" :loading="loading">
          <template #icon><ReloadOutlined /></template>
          刷新
        </a-button>
        <a-button @click="toggleColumnSettings">
          <template #icon><SettingOutlined /></template>
          列设置
        </a-button>
      </div>
    </div>

    <!-- 数据表格 -->
    <div class="results-table">
      <vxe-table
        ref="tableRef"
        :data="tableData"
        :columns="tableColumns"
        :loading="loading"
        :stripe="true"
        :border="true"
        :resizable="true"
        :show-overflow="true"
        :row-config="{ keyField: 'id' }"
        :checkbox-config="{ highlight: true, range: true }"
        :edit-config="{ trigger: 'click', mode: 'cell' }"
        @checkbox-change="handleSelectionChange"
        @cell-dblclick="handleCellEdit"
      >
        <!-- 状态列特殊渲染 -->
        <template #status_default="{ row }">
          <a-tag :color="getStatusColor(row.status)">
            {{ getStatusText(row.status) }}
          </a-tag>
        </template>

        <!-- 工作时长列特殊渲染 -->
        <template #workHours_default="{ row }">
          <span :class="{ 'text-danger': row.workHours < 8 }">
            {{ row.workHours }}小时
          </span>
        </template>

        <!-- 操作列 -->
        <template #action_default="{ row }">
          <a-space>
            <a-button type="link" size="small" @click="handleViewDetail(row)">
              详情
            </a-button>
            <a-button type="link" size="small" @click="handleCorrect(row)">
              修正
            </a-button>
            <a-dropdown>
              <template #overlay>
                <a-menu @click="({ key }) => handleMenuClick(key, row)">
                  <a-menu-item key="recalculate">重新计算</a-menu-item>
                  <a-menu-item key="view-log">查看日志</a-menu-item>
                  <a-menu-item key="export-single">导出单条</a-menu-item>
                </a-menu>
              </template>
              <a-button type="link" size="small">
                更多 <DownOutlined />
              </a-button>
            </a-dropdown>
          </a-space>
        </template>
      </vxe-table>

      <!-- 分页 -->
      <div class="table-pagination">
        <vxe-pager
          v-model:current-page="pagination.current"
          v-model:page-size="pagination.pageSize"
          :total="pagination.total"
          :page-sizes="[10, 20, 50, 100]"
          :layouts="['PrevJump', 'PrevPage', 'Number', 'NextPage', 'NextJump', 'Sizes', 'FullJump', 'Total']"
          @page-change="handlePageChange"
        />
      </div>
    </div>

    <!-- 详情弹窗 -->
    <a-modal
      v-model:open="detailVisible"
      title="考勤详情"
      :footer="null"
      width="1000px"
    >
      <ResultDetail
        :record="currentRecord"
        @close="detailVisible = false"
      />
    </a-modal>

    <!-- 修正弹窗 -->
    <a-modal
      v-model:open="correctVisible"
      title="考勤修正"
      @ok="handleCorrectConfirm"
      @cancel="correctVisible = false"
      width="600px"
    >
      <ResultCorrection
        ref="correctionRef"
        :record="currentRecord"
        @success="handleCorrectSuccess"
      />
    </a-modal>

    <!-- 列设置弹窗 -->
    <a-modal
      v-model:open="columnSettingsVisible"
      title="列设置"
      @ok="handleColumnSettingsSave"
      @cancel="columnSettingsVisible = false"
    >
      <ColumnSettings
        :columns="allColumns"
        :visible-columns="visibleColumns"
        @change="handleColumnChange"
      />
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  SearchOutlined,
  ReloadOutlined,
  CalculatorOutlined,
  EditOutlined,
  ExportOutlined,
  SettingOutlined,
  DownOutlined
} from '@ant-design/icons-vue';
import { resultsApi } from '/@/api/business/attendance/data/results-api';
import dayjs from 'dayjs';
import ResultDetail from './ResultDetail.vue';
import ResultCorrection from './ResultCorrection.vue';
import ColumnSettings from './ColumnSettings.vue';

const emit = defineEmits(['recalculate', 'export']);

const tableRef = ref();
const loading = ref(false);
const calculating = ref(false);
const detailVisible = ref(false);
const correctVisible = ref(false);
const columnSettingsVisible = ref(false);
const currentRecord = ref(null);
const correctionRef = ref();

const tableData = ref([]);
const selectedRows = ref([]);
const departmentTree = ref([]);
const employeeList = ref([]);

const filterForm = reactive({
  dateRange: [
    dayjs().subtract(7, 'day'),
    dayjs()
  ],
  departments: [],
  employees: [],
  status: []
});

const pagination = reactive({
  current: 1,
  pageSize: 20,
  total: 0
});

const allColumns = ref([
  { field: 'date', title: '日期', width: 120, fixed: 'left' },
  { field: 'employeeName', title: '姓名', width: 100, fixed: 'left' },
  { field: 'employeeNo', title: '工号', width: 100 },
  { field: 'department', title: '部门', width: 120 },
  { field: 'shiftName', title: '班次', width: 120 },
  { field: 'status', title: '状态', width: 100 },
  { field: 'clockInTime', title: '上班打卡', width: 150 },
  { field: 'clockOutTime', title: '下班打卡', width: 150 },
  { field: 'workHours', title: '工作时长', width: 100 },
  { field: 'overTimeHours', title: '加班时长', width: 100 },
  { field: 'lateMinutes', title: '迟到分钟', width: 100 },
  { field: 'earlyMinutes', title: '早退分钟', width: 100 },
  { field: 'leaveType', title: '请假类型', width: 100 },
  { field: 'remark', title: '备注', width: 200 }
]);

const visibleColumns = ref(allColumns.value.map(col => col.field));

const tableColumns = computed(() => {
  return allColumns.value.filter(col => visibleColumns.value.includes(col.field));
});

const dateShortcuts = [
  {
    text: '今天',
    value: () => [dayjs(), dayjs()],
  },
  {
    text: '本周',
    value: () => [dayjs().startOf('week'), dayjs().endOf('week')],
  },
  {
    text: '本月',
    value: () => [dayjs().startOf('month'), dayjs().endOf('month')],
  },
  {
    text: '最近7天',
    value: () => [dayjs().subtract(7, 'day'), dayjs()],
  }
];

// 加载数据
const loadData = async () => {
  loading.value = true;
  try {
    const params = {
      ...filterForm,
      startDate: filterForm.dateRange[0].format('YYYY-MM-DD'),
      endDate: filterForm.dateRange[1].format('YYYY-MM-DD'),
      page: pagination.current,
      pageSize: pagination.pageSize
    };

    const response = await resultsApi.getDailyResults(params);
    tableData.value = response.data.records;
    pagination.total = response.data.total;
  } catch (error) {
    console.error('加载数据失败:', error);
    message.error('加载数据失败');
  } finally {
    loading.value = false;
  }
};

// 筛选
const handleFilter = () => {
  pagination.current = 1;
  loadData();
};

// 日期变化
const handleDateChange = () => {
  handleFilter();
};

// 重置
const handleReset = () => {
  Object.assign(filterForm, {
    dateRange: [dayjs().subtract(7, 'day'), dayjs()],
    departments: [],
    employees: [],
    status: []
  });
  pagination.current = 1;
  loadData();
};

// 分页变化
const handlePageChange = (page) => {
  pagination.current = page;
  loadData();
};

// 选择变化
const handleSelectionChange = (selection) => {
  selectedRows.value = selection.records;
};

// 单元格编辑
const handleCellEdit = ({ row, column }) => {
  // 处理单元格编辑
  console.log('编辑单元格:', row, column);
};

// 查看详情
const handleViewDetail = (record) => {
  currentRecord.value = record;
  detailVisible.value = true;
};

// 修正
const handleCorrect = (record) => {
  currentRecord.value = record;
  correctVisible.value = true;
};

// 修正确认
const handleCorrectConfirm = async () => {
  try {
    const correctionData = await correctionRef.value.getCorrectionData();
    await resultsApi.correctResult(currentRecord.value.id, correctionData);
    message.success('修正成功');
    correctVisible.value = false;
    loadData();
  } catch (error) {
    message.error('修正失败');
  }
};

// 修正成功
const handleCorrectSuccess = () => {
  correctVisible.value = false;
  loadData();
};

// 菜单点击
const handleMenuClick = (key, record) => {
  switch (key) {
    case 'recalculate':
      handleRecalculateSingle(record);
      break;
    case 'view-log':
      handleViewLog(record);
      break;
    case 'export-single':
      handleExportSingle(record);
      break;
  }
};

// 重新计算单条
const handleRecalculateSingle = async (record) => {
  try {
    await resultsApi.recalculate(record.id);
    message.success('重新计算已提交');
    loadData();
  } catch (error) {
    message.error('重新计算失败');
  }
};

// 查看日志
const handleViewLog = (record) => {
  // 查看计算日志
  console.log('查看日志:', record);
};

// 导出单条
const handleExportSingle = (record) => {
  // 导出单条记录
  console.log('导出单条:', record);
};

// 重新计算
const handleRecalculate = async () => {
  if (selectedRows.value.length === 0) {
    message.warning('请选择要重新计算的记录');
    return;
  }

  calculating.value = true;
  try {
    const ids = selectedRows.value.map(row => row.id);
    await resultsApi.batchRecalculate(ids);
    message.success('重新计算已提交');
    loadData();
  } catch (error) {
    message.error('重新计算失败');
  } finally {
    calculating.value = false;
  }
};

// 批量修正
const handleBatchCorrect = () => {
  if (selectedRows.value.length === 0) {
    message.warning('请选择要修正的记录');
    return;
  }
  // 批量修正逻辑
  console.log('批量修正:', selectedRows.value);
};

// 导出
const handleExport = () => {
  emit('export', {
    filterForm,
    selectedRows: selectedRows.value
  });
};

// 刷新
const handleRefresh = () => {
  loadData();
};

// 切换列设置
const toggleColumnSettings = () => {
  columnSettingsVisible.value = true;
};

// 保存列设置
const handleColumnSettingsSave = () => {
  columnSettingsVisible.value = false;
};

// 列变化
const handleColumnChange = (columns) => {
  visibleColumns.value = columns;
};

// 获取状态颜色
const getStatusColor = (status) => {
  const colorMap = {
    normal: 'success',
    late: 'warning',
    early: 'warning',
    absent: 'error',
    leave: 'default'
  };
  return colorMap[status] || 'default';
};

// 获取状态文本
const getStatusText = (status) => {
  const textMap = {
    normal: '正常',
    late: '迟到',
    early: '早退',
    absent: '缺勤',
    leave: '请假'
  };
  return textMap[status] || '未知';
};

// 过滤员工选项
const filterEmployeeOption = (input, option) => {
  const employee = employeeList.value.find(emp => emp.id === option.value);
  return employee && (
    employee.name.toLowerCase().includes(input.toLowerCase()) ||
    employee.department.toLowerCase().includes(input.toLowerCase())
  );
};

onMounted(() => {
  loadData();
});
</script>

<style scoped lang="less">
.daily-results {
  .filter-toolbar {
    margin-bottom: 16px;
    padding: 16px;
    background: #fafafa;
    border-radius: 4px;
  }

  .action-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;

    .actions-left,
    .actions-right {
      display: flex;
      gap: 8px;
    }
  }

  .results-table {
    .text-danger {
      color: #ff4d4f;
    }

    .table-pagination {
      margin-top: 16px;
      text-align: right;
    }
  }
}
</style>
```

## Mock数据示例

```javascript
// src/mock/data-mock.js
export const mockClockRecords = [
  {
    id: 'record001',
    employeeId: 'emp001',
    employeeName: '张三',
    clockTime: '2024-01-15 09:05:00',
    clockType: 'in',
    deviceId: 'device001',
    deviceName: '前门人脸识别机',
    location: '公司前门',
    photoUrl: 'https://example.com/photo1.jpg',
    verificationMethod: 'face',
    status: 'normal'
  },
  {
    id: 'record002',
    employeeId: 'emp001',
    employeeName: '张三',
    clockTime: '2024-01-15 18:10:00',
    clockType: 'out',
    deviceId: 'device001',
    deviceName: '前门人脸识别机',
    location: '公司前门',
    photoUrl: 'https://example.com/photo2.jpg',
    verificationMethod: 'face',
    status: 'normal'
  }
];

export const mockMatchingResults = {
  totalRecords: 1000,
  successfulMatches: 950,
  failedMatches: 50,
  successRate: 95,
  successfulData: [
    {
      id: 'match001',
      employeeId: 'emp001',
      employeeName: '张三',
      date: '2024-01-15',
      clockInTime: '09:05',
      clockOutTime: '18:10',
      shiftId: 'shift001',
      shiftName: '标准早班',
      matchConfidence: 0.95
    }
  ],
  failedData: [
    {
      id: 'match002',
      employeeId: 'emp002',
      employeeName: '李四',
      date: '2024-01-15',
      clockInTime: null,
      clockOutTime: '18:00',
      failureReason: '缺少上班打卡记录',
      suggestions: ['手动补充打卡', '检查设备状态']
    }
  ]
};

export default {
  mockClockRecords,
  mockMatchingResults
};
```

## 开发注意事项总结

### 核心功能要点
1. **数据采集** - 多源数据的实时采集和整合
2. **智能匹配** - 高效的找班匹配算法
3. **准确计算** - 精确的考勤计算引擎
4. **实时处理** - 大量数据的实时处理能力
5. **数据修正** - 灵活的数据修正机制
6. **异常检测** - 智能的异常发现和预警

### 性能优化建议
1. 数据处理分批异步执行
2. 高性能表格组件的使用
3. 数据缓存和增量更新
4. 计算结果预计算和缓存

### 用户体验优化
1. 实时的进度反馈
2. 友好的错误提示
3. 灵活的筛选和排序
4. 便捷的数据操作

## 总结

考勤数据模块作为系统的数据处理核心，需要重点关注：

- 数据处理的准确性和效率
- 智能匹配算法的可靠性
- 计算引擎的精确性
- 数据操作便捷性
- 异常检测的及时性

通过遵循本文档的技术规范，可以构建出功能完善、性能优异的考勤数据处理模块。