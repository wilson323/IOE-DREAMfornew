# è§†é¢‘ç›‘æ§æ¨¡å—å‰ç«¯ç§»åŠ¨ç«¯ç»„ä»¶è®¾è®¡

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†IOE-DREAMæ™ºèƒ½è§†é¢‘ç›‘æ§ç³»ç»Ÿçš„ç§»åŠ¨ç«¯ç»„ä»¶è®¾è®¡ï¼ŒåŸºäºVue 3 + TypeScript + Vant 4æŠ€æœ¯æ ˆï¼Œæä¾›å®Œæ•´çš„ç§»åŠ¨ç«¯è§†é¢‘ç›‘æ§è§£å†³æ–¹æ¡ˆã€‚åŒ…æ‹¬å®æ—¶è§†é¢‘æ’­æ”¾ã€PTZæ§åˆ¶ã€å½•åƒå›æ”¾ã€AIåˆ†æç­‰å…¨åŠŸèƒ½ç§»åŠ¨ç»„ä»¶ã€‚

### æŠ€æœ¯æ¶æ„
- **å‰ç«¯æ¡†æ¶**: Vue 3.4.0+
- **å¼€å‘è¯­è¨€**: TypeScript 5.0+
- **UIç»„ä»¶åº“**: Vant 4.8.0+
- **çŠ¶æ€ç®¡ç†**: Pinia 2.1.0+
- **è·¯ç”±ç®¡ç†**: Vue Router 4.2.0+
- **è§†é¢‘æ’­æ”¾**: Video.js + WebRTC
- **å®æ—¶é€šä¿¡**: WebSocket + Socket.IO
- **AIåˆ†æ**: TensorFlow.js
- **æ‰‹åŠ¿æ§åˆ¶**: Hammer.js

## 1. é¡¹ç›®ç»“æ„è®¾è®¡

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ video/                      # è§†é¢‘ç›‘æ§ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ VideoPlayer/            # è§†é¢‘æ’­æ”¾å™¨
â”‚   â”‚   â”œâ”€â”€ PTZController/          # PTZäº‘å°æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ DeviceGrid/             # è®¾å¤‡ç½‘æ ¼
â”‚   â”‚   â”œâ”€â”€ RecordingPlayer/        # å½•åƒæ’­æ”¾å™¨
â”‚   â”‚   â”œâ”€â”€ AIDetection/            # AIæ™ºèƒ½æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ AlarmPanel/             # å‘Šè­¦é¢æ¿
â”‚   â”‚   â”œâ”€â”€ TimelinePlayer/         # æ—¶é—´è½´æ’­æ”¾
â”‚   â”‚   â”œâ”€â”€ SnapshotCapture/        # å¿«ç…§æ•è·
â”‚   â”‚   â””â”€â”€ MultiView/              # å¤šç”»é¢æ˜¾ç¤º
â”‚   â”œâ”€â”€ device/                     # è®¾å¤‡ç®¡ç†ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ DeviceCard/             # è®¾å¤‡å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ DeviceStatus/           # è®¾å¤‡çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ PTZPresets/             # PTZé¢„è®¾ä½
â”‚   â”‚   â””â”€â”€ DeviceConfig/           # è®¾å¤‡é…ç½®
â”‚   â”œâ”€â”€ ai/                         # AIåˆ†æç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ FaceRecognition/        # äººè„¸è¯†åˆ«
â”‚   â”‚   â”œâ”€â”€ BehaviorAnalysis/       # è¡Œä¸ºåˆ†æ
â”‚   â”‚   â”œâ”€â”€ CrowdDetection/         # äººç¾¤æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ VehicleRecognition/     # è½¦è¾†è¯†åˆ«
â”‚   â”‚   â””â”€â”€ ObjectTracking/         # ç›®æ ‡è·Ÿè¸ª
â”‚   â”œâ”€â”€ alert/                      # å‘Šè­¦ç®¡ç†ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ AlarmList/              # å‘Šè­¦åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ AlarmDetail/            # å‘Šè­¦è¯¦æƒ…
â”‚   â”‚   â”œâ”€â”€ AlarmFilter/            # å‘Šè­¦è¿‡æ»¤
â”‚   â”‚   â””â”€â”€ AlarmStatistics/        # å‘Šè­¦ç»Ÿè®¡
â”‚   â”œâ”€â”€ common/                     # å…¬å…±ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ VideoControls/          # è§†é¢‘æ§åˆ¶æ¡
â”‚   â”‚   â”œâ”€â”€ GestureHandler/         # æ‰‹åŠ¿å¤„ç†
â”‚   â”‚   â”œâ”€â”€ NetworkIndicator/       # ç½‘ç»œçŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ BatteryOptimization/    # ç”µæ± ä¼˜åŒ–
â”‚   â”‚   â””â”€â”€ StreamQuality/          # æµè´¨é‡
â”‚   â””â”€â”€ charts/                     # å›¾è¡¨ç»„ä»¶
â”‚       â”œâ”€â”€ PerformanceChart/       # æ€§èƒ½å›¾è¡¨
â”‚       â”œâ”€â”€ AlarmChart/             # å‘Šè­¦å›¾è¡¨
â”‚       â”œâ”€â”€ TrendChart/             # è¶‹åŠ¿å›¾è¡¨
â”‚       â””â”€â”€ StatisticsChart/        # ç»Ÿè®¡å›¾è¡¨
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ video/                      # è§†é¢‘ç›‘æ§é¡µé¢
â”‚   â”‚   â”œâ”€â”€ LiveViewPage.vue        # å®æ—¶ç›‘æ§é¡µ
â”‚   â”‚   â”œâ”€â”€ PlaybackPage.vue       # å½•åƒå›æ”¾é¡µ
â”‚   â”‚   â”œâ”€â”€ DevicePage.vue          # è®¾å¤‡ç®¡ç†é¡µ
â”‚   â”‚   â”œâ”€â”€ AIDetectionPage.vue     # AIåˆ†æé¡µ
â”‚   â”‚   â”œâ”€â”€ AlarmPage.vue           # å‘Šè­¦ç®¡ç†é¡µ
â”‚   â”‚   â””â”€â”€ SettingsPage.vue        # è®¾ç½®é¡µé¢
â”‚   â””â”€â”€ tabs/                       # æ ‡ç­¾é¡µ
â”‚       â”œâ”€â”€ LiveTab.vue             # å®æ—¶ç›‘æ§
â”‚       â”œâ”€â”€ PlaybackTab.vue         // å½•åƒå›æ”¾
â”‚       â”œâ”€â”€ DeviceTab.vue           // è®¾å¤‡ç®¡ç†
â”‚       â”œâ”€â”€ AlarmTab.vue            // å‘Šè­¦ç®¡ç†
â”‚       â””â”€â”€ ProfileTab.vue          // ä¸ªäººä¸­å¿ƒ
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ video.ts                    # è§†é¢‘çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ device.ts                   # è®¾å¤‡çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ ai.ts                       // AIçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ alarm.ts                    // å‘Šè­¦çŠ¶æ€ç®¡ç†
â”‚   â””â”€â”€ stream.ts                   // æµåª’ä½“çŠ¶æ€ç®¡ç†
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ video.service.ts            # è§†é¢‘æœåŠ¡
â”‚   â”œâ”€â”€ webrtc.service.ts           // WebRTCæœåŠ¡
â”‚   â”œâ”€â”€ ai.service.ts               // AIåˆ†ææœåŠ¡
â”‚   â”œâ”€â”€ alarm.service.ts            # å‘Šè­¦æœåŠ¡
â”‚   â”œâ”€â”€ device.service.ts           // è®¾å¤‡æœåŠ¡
â”‚   â”œâ”€â”€ websocket.service.ts        // WebSocketæœåŠ¡
â”‚   â””â”€â”€ notification.service.ts     # é€šçŸ¥æœåŠ¡
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ video.ts                    # è§†é¢‘å·¥å…·
â”‚   â”œâ”€â”€ webrtc.ts                   // WebRTCå·¥å…·
â”‚   â”œâ”€â”€ gesture.ts                  // æ‰‹åŠ¿å·¥å…·
â”‚   â”œâ”€â”€ compression.ts              // å‹ç¼©å·¥å…·
â”‚   â””â”€â”€ network.ts                  // ç½‘ç»œå·¥å…·
â””â”€â”€ types/
    â”œâ”€â”€ video.ts                    # è§†é¢‘ç±»å‹å®šä¹‰
    â”œâ”€â”€ device.ts                   // è®¾å¤‡ç±»å‹å®šä¹‰
    â”œâ”€â”€ ai.ts                       // AIç±»å‹å®šä¹‰
    â”œâ”€â”€ alarm.ts                    // å‘Šè­¦ç±»å‹å®šä¹‰
    â””â”€â”€ api.ts                      // APIç±»å‹å®šä¹‰
```

## 2. æ ¸å¿ƒç»„ä»¶è®¾è®¡
## ğŸ“‹ IOE-DREAMä¸ƒå¾®æœåŠ¡æ¶æ„

**æ ¸å¿ƒæ¶æ„ç»„æˆ**:
- **Gateway Service (8080)**: APIç½‘å…³
- **Common Service (8088)**: å…¬å…±æ¨¡å—å¾®æœåŠ¡
- **DeviceComm Service (8087)**: è®¾å¤‡é€šè®¯å¾®æœåŠ¡
- **OA Service (8089)**: OAå¾®æœåŠ¡
- **Access Service (8090)**: é—¨ç¦æœåŠ¡
- **Attendance Service (8091)**: è€ƒå‹¤æœåŠ¡
- **Video Service (8092)**: è§†é¢‘æœåŠ¡
- **Consume Service (8094)**: æ¶ˆè´¹æœåŠ¡
- **Visitor Service (8095)**: è®¿å®¢æœåŠ¡

**æ¶æ„ç‰¹ç‚¹**:
- åŸºäºSpring Boot 3.5.8 + Java 17
- ä¸¥æ ¼éµå¾ªä¼ä¸šçº§å¾®æœåŠ¡è§„èŒƒ
- æ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨ã€æ°´å¹³æ‰©å±•

**æŠ€æœ¯æ ˆæ ‡å‡†**:
- **æ•°æ®åº“**: MySQL 8.0 + Druidè¿æ¥æ± 
- **ç¼“å­˜**: Redis + Caffeineå¤šçº§ç¼“å­˜
- **æ³¨å†Œä¸­å¿ƒ**: Nacos
- **é…ç½®ä¸­å¿ƒ**: Nacos Config
- **è®¤è¯æˆæƒ**: Sa-Token

## ğŸ—ï¸ å››å±‚æ¶æ„è§„èŒƒ

**æ ‡å‡†æ¶æ„æ¨¡å¼**:
```
Controller (æ¥å£æ§åˆ¶å±‚)
    â†“
Service (æ ¸å¿ƒä¸šåŠ¡å±‚)
    â†“
Manager (æµç¨‹ç®¡ç†å±‚)
    â†“
DAO (æ•°æ®è®¿é—®å±‚)
```

**å±‚çº§èŒè´£**:
- **Controllerå±‚**: HTTPè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ã€æƒé™æ§åˆ¶
- **Serviceå±‚**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™éªŒè¯
- **Managerå±‚**: å¤æ‚æµç¨‹ç¼–æ’ã€å¤šæ•°æ®ç»„è£…ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- **DAOå±‚**: æ•°æ®åº“CRUDæ“ä½œã€SQLæŸ¥è¯¢å®ç°ã€æ•°æ®è®¿é—®è¾¹ç•Œ

**ä¸¥æ ¼ç¦æ­¢è·¨å±‚è®¿é—®**: Controllerä¸èƒ½ç›´æ¥è°ƒç”¨Manager/DAOï¼
### 2.1 VideoPlayer è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶
## âš ï¸ IOE-DREAMé›¶å®¹å¿è§„åˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å¿…é¡»éµå®ˆçš„æ¶æ„è§„åˆ™**:
- âœ… **å¿…é¡»ä½¿ç”¨ @Resource æ³¨å…¥ä¾èµ–**
- âœ… **å¿…é¡»ä½¿ç”¨ @Mapper æ³¨è§£** (ç¦æ­¢@Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ Dao åç¼€** (ç¦æ­¢Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ @RestController æ³¨è§£**
- âœ… **å¿…é¡»ä½¿ç”¨ @Valid å‚æ•°æ ¡éªŒ**
- âœ… **å¿…é¡»è¿”å›ç»Ÿä¸€ResponseDTOæ ¼å¼**
- âœ… **å¿…é¡»éµå¾ªå››å±‚æ¶æ„è¾¹ç•Œ**

**ä¸¥æ ¼ç¦æ­¢äº‹é¡¹**:
- âŒ **ç¦æ­¢ä½¿ç”¨ @Autowired æ³¨å…¥**
- âŒ **ç¦æ­¢ä½¿ç”¨ @Repository æ³¨è§£**
- âŒ **ç¦æ­¢ä½¿ç”¨ Repository åç¼€å‘½å**
- âŒ **ç¦æ­¢è·¨å±‚è®¿é—®**
- âŒ **ç¦æ­¢åœ¨Controllerä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘**
- âŒ **ç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“**

**è¿è§„åæœ**: P0çº§é—®é¢˜ï¼Œç«‹å³ä¿®å¤ï¼Œç¦æ­¢åˆå¹¶ï¼

#### ç»„ä»¶æ¥å£å®šä¹‰
```typescript
// VideoPlayer.vue
interface VideoPlayerProps {
  streamUrl?: string;               // è§†é¢‘æµåœ°å€
  deviceId?: string;                // è®¾å¤‡ID
  autoplay?: boolean;               // è‡ªåŠ¨æ’­æ”¾
  muted?: boolean;                  // é™éŸ³
  controls?: boolean;               // æ˜¾ç¤ºæ§åˆ¶æ¡
  loop?: boolean;                   // å¾ªç¯æ’­æ”¾
  poster?: string;                  // å°é¢å›¾
  fill?: boolean;                   // å¡«å……å®¹å™¨
  fluid?: boolean;                  // æµä½“å¸ƒå±€
  responsive?: boolean;            // å“åº”å¼
  adaptiveBitrate?: boolean;        // è‡ªé€‚åº”ç ç‡
  lowLatency?: boolean;            // ä½å»¶è¿Ÿæ¨¡å¼
}

interface VideoPlayerEmits {
  ready: [player: any];             // æ’­æ”¾å™¨å°±ç»ª
  play: [];                         // å¼€å§‹æ’­æ”¾
  pause: [];                        // æš‚åœæ’­æ”¾
  ended: [];                        // æ’­æ”¾ç»“æŸ
  error: [error: Error];            // æ’­æ”¾é”™è¯¯
  timeupdate: [currentTime: number]; // æ—¶é—´æ›´æ–°
  qualitychange: [quality: string]; // è´¨é‡å˜åŒ–
  fullscreenchange: [isFullscreen: boolean]; // å…¨å±å˜åŒ–
  ptz: [command: PTZCommand];       // PTZæ§åˆ¶å‘½ä»¤
}
```

#### ç»„ä»¶å®ç°
```vue
<template>
  <div class="video-player-container" :class="{ 'fullscreen': isFullscreen }">
    <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
    <div
      ref="videoContainer"
      class="video-wrapper"
      :style="{ 'aspect-ratio': aspectRatio }"
      @click="toggleControls"
      @dblclick="toggleFullscreen"
    >
      <video
        ref="videoElement"
        class="video-player"
        :muted="muted"
        :autoplay="autoplay"
        :loop="loop"
        :poster="poster"
        playsinline
        webkit-playsinline
        x5-playsinline
        x5-video-player-type="h5"
        x5-video-player-fullscreen="true"
        @loadstart="handleLoadStart"
        @canplay="handleCanPlay"
        @play="handlePlay"
        @pause="handlePause"
        @ended="handleEnded"
        @error="handleError"
        @timeupdate="handleTimeUpdate"
        @progress="handleProgress"
      ></video>

      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="isLoading" class="loading-overlay">
        <van-loading type="spinner" size="24" />
        <span class="loading-text">{{ loadingText }}</span>
      </div>

      <!-- é”™è¯¯çŠ¶æ€ -->
      <div v-if="hasError" class="error-overlay">
        <van-icon name="warning-o" size="48" color="#ee0a24" />
        <div class="error-text">{{ errorMessage }}</div>
        <van-button type="primary" size="small" @click="retryPlay">
          é‡è¯•
        </van-button>
      </div>

      <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <div v-if="showNetworkStatus" class="network-status">
        <van-icon
          :name="networkStatus.icon"
          :color="networkStatus.color"
          size="16"
        />
        <span>{{ networkStatus.text }}</span>
      </div>

      <!-- è§†é¢‘æ§åˆ¶æ¡ -->
      <div
        v-show="showControls && controls"
        class="video-controls"
        @click.stop
      >
        <!-- æ’­æ”¾æ§åˆ¶ -->
        <div class="control-row primary">
          <van-button
            type="default"
            size="small"
            round
            @click="togglePlay"
          >
            <van-icon :name="isPlaying ? 'pause' : 'play'" size="16" />
          </van-button>

          <!-- è¿›åº¦æ¡ -->
          <div class="progress-container">
            <div class="progress-time">{{ formatTime(currentTime) }}</div>
            <van-slider
              v-model="progressValue"
              :min="0"
              :max="duration"
              step="1"
              @change="handleSeek"
              class="progress-slider"
            />
            <div class="progress-time">{{ formatTime(duration) }}</div>
          </div>

          <!-- éŸ³é‡æ§åˆ¶ -->
          <van-button
            type="default"
            size="small"
            round
            @click="toggleMute"
          >
            <van-icon :name="muted ? 'volume' : 'volume-o'" size="16" />
          </van-button>
        </div>

        <!-- é«˜çº§æ§åˆ¶ -->
        <div class="control-row secondary">
          <!-- PTZæ§åˆ¶æŒ‰é’® -->
          <van-button
            v-if="enablePTZ"
            type="default"
            size="small"
            round
            @click="togglePTZControls"
          >
            <van-icon name="aim" size="16" />
          </van-button>

          <!-- è´¨é‡é€‰æ‹© -->
          <van-button
            type="default"
            size="small"
            round
            @click="showQualitySelector"
          >
            <van-icon name="video-o" size="16" />
            {{ currentQuality }}
          </van-button>

          <!-- æˆªå›¾ -->
          <van-button
            type="default"
            size="small"
            round
            @click="captureSnapshot"
          >
            <van-icon name="photograph" size="16" />
          </van-button>

          <!-- å…¨å± -->
          <van-button
            type="default"
            size="small"
            round
            @click="toggleFullscreen"
          >
            <van-icon :name="isFullscreen ? 'shrink' : 'enlarge'" size="16" />
          </van-button>
        </div>
      </div>

      <!-- PTZæ§åˆ¶é¢æ¿ -->
      <div v-if="showPTZPanel" class="ptz-control-panel">
        <PTZController
          :device-id="deviceId"
          @command="handlePTZCommand"
          @close="showPTZPanel = false"
        />
      </div>

      <!-- æ‰‹åŠ¿æŒ‡ç¤ºå™¨ -->
      <div v-if="showGestureIndicator" class="gesture-indicator">
        <div class="gesture-icon">
          <van-icon name="hand-o" size="32" color="#1989fa" />
        </div>
        <div class="gesture-text">{{ gestureText }}</div>
      </div>
    </div>

    <!-- è´¨é‡é€‰æ‹©å¼¹çª— -->
    <van-action-sheet
      v-model:show="showQualityPopup"
      :actions="qualityActions"
      cancel-text="å–æ¶ˆ"
      close-on-click-action
      @select="handleQualitySelect"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, nextTick, watch } from 'vue'
import { useVideoStore } from '@/stores/video'
import { useWebRTCService } from '@/services/webrtc.service'
import { showToast, showLoadingToast, closeToast } from 'vant'
import PTZController from './PTZController.vue'

// Propså®šä¹‰
const props = withDefaults(defineProps<VideoPlayerProps>(), {
  autoplay: false,
  muted: false,
  controls: true,
  loop: false,
  fill: false,
  fluid: false,
  responsive: true,
  adaptiveBitrate: true,
  lowLatency: false
})

// Emitså®šä¹‰
const emit = defineEmits<VideoPlayerEmits>()

// çŠ¶æ€ç®¡ç†
const videoStore = useVideoStore()
const webrtcService = useWebRTCService()

// å“åº”å¼æ•°æ®
const videoElement = ref<HTMLVideoElement | null>(null)
const videoContainer = ref<HTMLElement | null>(null)

const isPlaying = ref(false)
const isLoading = ref(false)
const hasError = ref(false)
const errorMessage = ref('')
const currentTime = ref(0)
const duration = ref(0)
const buffered = ref(0)

const showControls = ref(true)
const showPTZPanel = ref(false)
const showQualityPopup = ref(false)
const showGestureIndicator = ref(false)
const gestureText = ref('')

const isFullscreen = ref(false)
const currentQuality = ref('é«˜æ¸…')
const enablePTZ = ref(!!props.deviceId)

let controlsTimer: NodeJS.Timeout | null = null
let networkMonitor: NodeJS.Timeout | null = null
let gestureHandler: any = null

// è®¡ç®—å±æ€§
const progressValue = computed({
  get: () => currentTime.value,
  set: (value: number) => {
    if (videoElement.value) {
      videoElement.value.currentTime = value
    }
  }
})

const aspectRatio = computed(() => {
  if (props.fluid) return '16/9'
  return undefined
})

const loadingText = computed(() => {
  if (hasError.value) return 'åŠ è½½å¤±è´¥'
  return isLoading.value ? 'æ­£åœ¨åŠ è½½...' : ''
})

const networkStatus = computed(() => {
  const networkType = getNetworkType()
  switch (networkType) {
    case 'wifi':
      return { icon: 'wifi-o', color: '#07c160', text: 'WiFi' }
    case '4g':
      return { icon: 'service-o', color: '#1989fa', text: '4G' }
    case '3g':
      return { icon: 'service-o', color: '#ff976a', text: '3G' }
    default:
      return { icon: 'warning-o', color: '#ee0a24', text: 'ç½‘ç»œå¼‚å¸¸' }
  }
})

const showNetworkStatus = computed(() => {
  return navigator.connection && props.adaptiveBitrate
})

const qualityActions = computed(() => [
  { name: 'è¶…æ¸…', value: '4K' },
  { name: 'é«˜æ¸…', value: 'HD' },
  { name: 'æ ‡æ¸…', value: 'SD' },
  { name: 'æµç•…', value: 'LD' }
])

// æ–¹æ³•å®ç°
const initializePlayer = async () => {
  if (!videoElement.value) return

  isLoading.value = true
  hasError.value = false

  try {
    if (props.streamUrl) {
      await loadVideoStream(props.streamUrl)
    } else if (props.deviceId) {
      await setupWebRTCStream(props.deviceId)
    }

    // åˆå§‹åŒ–æ‰‹åŠ¿æ§åˆ¶
    if (videoContainer.value) {
      setupGestureControl()
    }

    // åˆå§‹åŒ–ç½‘ç»œç›‘æ§
    if (props.adaptiveBitrate) {
      startNetworkMonitoring()
    }

  } catch (error) {
    console.error('è§†é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error)
    handleError(error as Error)
  } finally {
    isLoading.value = false
  }
}

const loadVideoStream = async (streamUrl: string) => {
  if (!videoElement.value) return

  videoElement.value.src = streamUrl
  videoElement.value.load()

  await new Promise((resolve, reject) => {
    videoElement.value!.onloadeddata = resolve
    videoElement.value!.onerror = reject
  })
}

const setupWebRTCStream = async (deviceId: string) => {
  try {
    const stream = await webrtcService.createStream(deviceId, {
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        frameRate: { ideal: 25 }
      },
      audio: false
    })

    if (videoElement.value) {
      videoElement.value.srcObject = stream
    }

  } catch (error) {
    console.error('WebRTCæµè®¾ç½®å¤±è´¥:', error)
    throw error
  }
}

const togglePlay = () => {
  if (!videoElement.value) return

  if (isPlaying.value) {
    videoElement.value.pause()
  } else {
    videoElement.value.play()
  }
}

const handlePlay = () => {
  isPlaying.value = true
  emit('play')
}

const handlePause = () => {
  isPlaying.value = false
  emit('pause')
}

const handleEnded = () => {
  isPlaying.value = false
  emit('ended')
}

const handleError = (error: Event) => {
  const videoError = videoElement.value?.error
  hasError.value = true
  errorMessage.value = videoError?.message || 'è§†é¢‘æ’­æ”¾å¤±è´¥'
  emit('error', new Error(errorMessage.value))
}

const handleTimeUpdate = () => {
  if (videoElement.value) {
    currentTime.value = videoElement.value.currentTime
    emit('timeupdate', currentTime.value)
  }
}

const handleProgress = () => {
  if (videoElement.value && videoElement.value.buffered.length > 0) {
    buffered.value = videoElement.value.buffered.end(0)
  }
}

const handleSeek = (value: number) => {
  if (videoElement.value) {
    videoElement.value.currentTime = value
  }
}

const toggleMute = () => {
  if (videoElement.value) {
    videoElement.value.muted = !videoElement.value.muted
  }
}

const captureSnapshot = async () => {
  if (!videoElement.value) return

  try {
    const canvas = document.createElement('canvas')
    canvas.width = videoElement.value.videoWidth
    canvas.height = videoElement.value.videoHeight

    const ctx = canvas.getContext('2d')
    if (ctx) {
      ctx.drawImage(videoElement.value, 0, 0, canvas.width, canvas.height)

      const snapshotData = canvas.toDataURL('image/jpeg', 0.8)
      showToast('æˆªå›¾æˆåŠŸ')

      // è¿™é‡Œå¯ä»¥è§¦å‘æˆªå›¾ä¿å­˜äº‹ä»¶
      // emit('snapshot', snapshotData)
    }

  } catch (error) {
    console.error('æˆªå›¾å¤±è´¥:', error)
    showToast('æˆªå›¾å¤±è´¥')
  }
}

const toggleFullscreen = async () => {
  if (!videoContainer.value) return

  try {
    if (!document.fullscreenElement) {
      await videoContainer.value.requestFullscreen()
      isFullscreen.value = true
    } else {
      await document.exitFullscreen()
      isFullscreen.value = false
    }
    emit('fullscreenchange', isFullscreen.value)
  } catch (error) {
    console.error('å…¨å±åˆ‡æ¢å¤±è´¥:', error)
    showToast('å…¨å±æ¨¡å¼ä¸å¯ç”¨')
  }
}

const togglePTZControls = () => {
  showPTZPanel.value = !showPTZPanel.value
}

const handlePTZCommand = (command: any) => {
  emit('ptz', command)
}

const showQualitySelector = () => {
  showQualityPopup.value = true
}

const handleQualitySelect = (action: any) => {
  currentQuality.value = action.name
  // è¿™é‡Œåº”è¯¥è§¦å‘è´¨é‡åˆ‡æ¢é€»è¾‘
  showToast(`åˆ‡æ¢åˆ°${action.name}`)
}

const toggleControls = () => {
  if (controlsTimer) {
    clearTimeout(controlsTimer)
  }

  showControls.value = true
  controlsTimer = setTimeout(() => {
    showControls.value = false
  }, 3000)
}

const setupGestureControl = () => {
  if (!videoContainer.value || !import.meta.client) return

  // åŠ¨æ€å¯¼å…¥ Hammer.js
  import('hammerjs').then(Hammer => {
    gestureHandler = new Hammer.default(videoContainer.value!)

    // æææ‰‹åŠ¿ - å˜ç„¦
    gestureHandler.get('pinch').set({ enable: true })
    gestureHandler.on('pinch', (e: any) => {
      handlePinchGesture(e)
    })

    // æ»‘åŠ¨æ‰‹åŠ¿ - PTZæ§åˆ¶
    gestureHandler.get('swipe').set({ direction: Hammer.DIRECTION_ALL })
    gestureHandler.on('swipe', (e: any) => {
      handleSwipeGesture(e)
    })

    // åŒå‡» - è‡ªåŠ¨èšç„¦
    gestureHandler.on('doubletap', (e: any) => {
      handleDoubleTapGesture(e)
    })
  })
}

const handlePinchGesture = (event: any) => {
  if (!enablePTZ.value) return

  const scale = event.scale
  showGestureIndicator.value = true
  gestureText.value = scale > 1 ? 'æ”¾å¤§' : 'ç¼©å°'

  // å‘é€PTZå˜ç„¦å‘½ä»¤
  emit('ptz', {
    command: 'ZOOM',
    parameters: {
      zoom: scale > 1 ? 'IN' : 'OUT',
      speed: Math.abs(scale - 1) * 50
    }
  })

  setTimeout(() => {
    showGestureIndicator.value = false
  }, 1000)
}

const handleSwipeGesture = (event: any) => {
  if (!enablePTZ.value) return

  let command = ''
  let direction = ''

  switch (event.direction) {
    case Hammer.DIRECTION_LEFT:
      command = 'PAN'
      direction = 'LEFT'
      break
    case Hammer.DIRECTION_RIGHT:
      command = 'PAN'
      direction = 'RIGHT'
      break
    case Hammer.DIRECTION_UP:
      command = 'TILT'
      direction = 'UP'
      break
    case Hammer.DIRECTION_DOWN:
      command = 'TILT'
      direction = 'DOWN'
      break
  }

  if (command) {
    showGestureIndicator.value = true
    gestureText.value = `å‘${direction === 'UP' ? 'ä¸Š' : direction === 'DOWN' ? 'ä¸‹' : direction === 'LEFT' ? 'å·¦' : 'å³'}ç§»åŠ¨`

    emit('ptz', {
      command,
      parameters: {
        direction,
        speed: 60
      }
    })

    setTimeout(() => {
      showGestureIndicator.value = false
    }, 1000)
  }
}

const handleDoubleTapGesture = (event: any) => {
  if (!enablePTZ.value) return

  // å‘é€è‡ªåŠ¨èšç„¦å‘½ä»¤
  emit('ptz', {
    command: 'AUTO_FOCUS',
    parameters: {
      x: event.center.x,
      y: event.center.y
    }
  })

  showGestureIndicator.value = true
  gestureText.value = 'è‡ªåŠ¨èšç„¦'

  setTimeout(() => {
    showGestureIndicator.value = false
  }, 1000)
}

const startNetworkMonitoring = () => {
  networkMonitor = setInterval(() => {
    checkNetworkCondition()
  }, 5000)
}

const checkNetworkCondition = () => {
  if (!props.adaptiveBitrate || !videoElement.value) return

  const connection = (navigator as any).connection
  if (!connection) return

  const networkType = connection.effectiveType
  const downlink = connection.downlink // Mbps

  let targetQuality = 'HD'
  let targetBitrate = 2000

  // æ ¹æ®ç½‘ç»œæ¡ä»¶è°ƒæ•´è´¨é‡
  if (networkType === 'slow-2g' || networkType === '2g' || downlink < 0.5) {
    targetQuality = 'LD'
    targetBitrate = 500
  } else if (networkType === '3g' || downlink < 2) {
    targetQuality = 'SD'
    targetBitrate = 1000
  } else if (networkType === '4g' || downlink >= 10) {
    targetQuality = 'HD'
    targetBitrate = 2000
  }

  // è¿™é‡Œåº”è¯¥å®é™…åˆ‡æ¢è§†é¢‘æµè´¨é‡
  if (targetQuality !== currentQuality.value) {
    console.log(`ç½‘ç»œè‡ªé€‚åº”ï¼šåˆ‡æ¢åˆ°${targetQuality}`)
    currentQuality.value = targetQuality
  }
}

const getNetworkType = (): string => {
  const connection = (navigator as any).connection
  if (!connection) return 'unknown'

  const effectiveType = connection.effectiveType
  switch (effectiveType) {
    case '4g':
      return '4g'
    case '3g':
      return '3g'
    case '2g':
      return '2g'
    case 'slow-2g':
      return '2g'
    default:
      return 'unknown'
  }
}

const formatTime = (seconds: number): string => {
  const h = Math.floor(seconds / 3600)
  const m = Math.floor((seconds % 3600) / 60)
  const s = Math.floor(seconds % 60)

  if (h > 0) {
    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
  } else {
    return `${m}:${s.toString().padStart(2, '0')}`
  }
}

const handleError = (error: Error) => {
  hasError.value = true
  errorMessage.value = error.message
  isLoading.value = false
  emit('error', error)
}

const retryPlay = () => {
  hasError.value = false
  errorMessage.value = ''
  initializePlayer()
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(async () => {
  await nextTick()
  await initializePlayer()

  // ç›‘å¬å…¨å±å˜åŒ–
  document.addEventListener('fullscreenchange', handleFullscreenChange)
})

onUnmounted(() => {
  // æ¸…ç†èµ„æº
  if (controlsTimer) {
    clearTimeout(controlsTimer)
  }
  if (networkMonitor) {
    clearInterval(networkMonitor)
  }
  if (gestureHandler) {
    gestureHandler.destroy()
  }
  if (videoElement.value && videoElement.value.srcObject) {
    const stream = videoElement.value.srcObject as MediaStream
    stream.getTracks().forEach(track => track.stop())
  }

  document.removeEventListener('fullscreenchange', handleFullscreenChange)
})

const handleFullscreenChange = () => {
  isFullscreen.value = !!document.fullscreenElement
  emit('fullscreenchange', isFullscreen.value)
}

// ç›‘å¬propså˜åŒ–
watch(() => props.streamUrl, (newUrl) => {
  if (newUrl) {
    loadVideoStream(newUrl)
  }
})

watch(() => props.deviceId, (newDeviceId) => {
  if (newDeviceId) {
    setupWebRTCStream(newDeviceId)
  }
})
</script>

<style lang="scss" scoped>
.video-player-container {
  position: relative;
  width: 100%;
  background: #000;
  border-radius: 8px;
  overflow: hidden;

  &.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    border-radius: 0;
  }
}

.video-wrapper {
  position: relative;
  width: 100%;
  background: #000;
  cursor: pointer;
}

.video-player {
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: #000;
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  z-index: 10;

  .loading-text {
    margin-top: 12px;
    font-size: 14px;
  }
}

.error-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  z-index: 10;

  .error-text {
    margin: 16px 0;
    font-size: 16px;
    text-align: center;
    max-width: 80%;
  }
}

.network-status {
  position: absolute;
  top: 12px;
  right: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 6px 10px;
  border-radius: 12px;
  font-size: 12px;
  z-index: 5;
}

.video-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  color: white;
  padding: 20px 16px 16px;
  z-index: 10;

  .control-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;

    &:last-child {
      margin-bottom: 0;
    }

    &.primary {
      justify-content: space-between;
    }

    &.secondary {
      justify-content: center;
      gap: 20px;
    }
  }

  .progress-container {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;

    .progress-time {
      font-size: 12px;
      min-width: 45px;
      text-align: center;
    }

    .progress-slider {
      flex: 1;
    }
  }

  .van-button {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 8px 12px;

    &:active {
      background: rgba(255, 255, 255, 0.3);
    }
  }
}

.ptz-control-panel {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 15;
}

.gesture-indicator {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 20px;
  border-radius: 12px;
  z-index: 20;

  .gesture-icon {
    margin-bottom: 8px;
  }

  .gesture-text {
    font-size: 16px;
    font-weight: 500;
  }
}

// å“åº”å¼è®¾è®¡
@media (max-width: 375px) {
  .video-controls {
    padding: 16px 12px 12px;

    .control-row.secondary {
      gap: 12px;

      .van-button {
        padding: 6px 10px;
        font-size: 12px;
      }
    }

    .progress-container .progress-time {
      font-size: 11px;
      min-width: 40px;
    }
  }
}
</style>
```

### 2.2 PTZController PTZæ§åˆ¶ç»„ä»¶

#### ç»„ä»¶æ¥å£å®šä¹‰
```typescript
// PTZController.vue
interface PTZControllerProps {
  deviceId: string;                // è®¾å¤‡ID
  showPresets?: boolean;            // æ˜¾ç¤ºé¢„è®¾ä½
  showSpeed?: boolean;              // æ˜¾ç¤ºé€Ÿåº¦æ§åˆ¶
  compact?: boolean;                // ç´§å‡‘æ¨¡å¼
  position?: PTZPosition;           // å½“å‰ä½ç½®
}

interface PTZPosition {
  pan: number;                      // æ°´å¹³è§’åº¦
  tilt: number;                     // å‚ç›´è§’åº¦
  zoom: number;                     // å˜ç„¦å€æ•°
  focus: number;                    // ç„¦è·
}

interface PTZCommand {
  command: string;                  // å‘½ä»¤ç±»å‹
  parameters?: Record<string, any>; // å‘½ä»¤å‚æ•°
}

interface PTZControllerEmits {
  command: [command: PTZCommand]; // PTZå‘½ä»¤äº‹ä»¶
  close: [];                        // å…³é—­äº‹ä»¶
}
```

#### ç»„ä»¶å®ç°
```vue
<template>
  <div class="ptz-controller" :class="{ 'compact': compact }">
    <!-- æ§åˆ¶é¢æ¿å¤´éƒ¨ -->
    <div class="controller-header">
      <div class="title">PTZæ§åˆ¶</div>
      <van-button
        type="default"
        size="small"
        round
        @click="handleClose"
      >
        <van-icon name="cross" />
      </van-button>
    </div>

    <!-- æ–¹å‘æ§åˆ¶ -->
    <div class="direction-control">
      <div class="control-circle">
        <!-- ä¸­å¿ƒåœæ­¢æŒ‰é’® -->
        <van-button
          type="default"
          size="small"
          round
          class="center-btn"
          @click="stopMovement"
        >
          <van-icon name="pause" />
        </van-button>

        <!-- æ–¹å‘æŒ‰é’® -->
        <div class="direction-btn top-left" @click="moveDirection('TOP_LEFT')">
          <van-icon name="arrow" style="transform: rotate(-45deg)" />
        </div>
        <div class="direction-btn top" @click="moveDirection('UP')">
          <van-icon name="arrow" />
        </div>
        <div class="direction-btn top-right" @click="moveDirection('TOP_RIGHT')">
          <van-icon name="arrow" style="transform: rotate(45deg)" />
        </div>
        <div class="direction-btn left" @click="moveDirection('LEFT')">
          <van-icon name="arrow" style="transform: rotate(-90deg)" />
        </div>
        <div class="direction-btn right" @click="moveDirection('RIGHT')">
          <van-icon name="arrow" style="transform: rotate(90deg)" />
        </div>
        <div class="direction-btn bottom-left" @click="moveDirection('BOTTOM_LEFT')">
          <van-icon name="arrow" style="transform: rotate(-135deg)" />
        </div>
        <div class="direction-btn bottom" @click="moveDirection('DOWN')">
          <van-icon name="arrow" style="transform: rotate(180deg)" />
        </div>
        <div class="direction-btn bottom-right" @click="moveDirection('BOTTOM_RIGHT')">
          <van-icon name="arrow" style="transform: rotate(135deg)" />
        </div>
      </div>
    </div>

    <!-- å˜ç„¦æ§åˆ¶ -->
    <div class="zoom-control">
      <div class="control-label">å˜ç„¦</div>
      <div class="zoom-buttons">
        <van-button
          type="default"
          size="small"
          round
          @click="zoom('OUT')"
        >
          <van-icon name="minus" />
        </van-button>
        <div class="zoom-indicator">
          {{ currentZoom }}x
        </div>
        <van-button
          type="default"
          size="small"
          round
          @click="zoom('IN')"
        >
          <van-icon name="plus" />
        </van-button>
      </div>
    </div>

    <!-- é€Ÿåº¦æ§åˆ¶ -->
    <div v-if="showSpeed" class="speed-control">
      <div class="control-label">é€Ÿåº¦</div>
      <van-slider
        v-model="currentSpeed"
        :min="1"
        :max="10"
        :step="1"
        @change="handleSpeedChange"
        class="speed-slider"
      />
    </div>

    <!-- é¢„è®¾ä½ -->
    <div v-if="showPresets" class="presets-control">
      <div class="control-label">é¢„è®¾ä½</div>
      <div class="presets-grid">
        <div
          v-for="preset in presets"
          :key="preset.id"
          class="preset-item"
          :class="{ 'active': currentPreset === preset.id }"
          @click="goToPreset(preset.id)"
        >
          <van-icon name="location-o" size="16" />
          <span>{{ preset.name }}</span>
        </div>
      </div>
      <div class="preset-actions">
        <van-button
          type="default"
          size="small"
          round
          @click="savePreset"
        >
          ä¿å­˜ä½ç½®
        </van-button>
        <van-button
          type="default"
          size="small"
          round
          @click="showPresetManager"
        >
          ç®¡ç†
        </van-button>
      </div>
    </div>

    <!-- é«˜çº§åŠŸèƒ½ -->
    <div class="advanced-control">
      <van-collapse v-model="advancedExpanded" :border="false">
        <van-collapse-item title="é«˜çº§åŠŸèƒ½" name="advanced">
          <!-- è‡ªåŠ¨å·¡èˆª -->
          <div class="advanced-item">
            <div class="item-label">è‡ªåŠ¨å·¡èˆª</div>
            <van-switch
              v-model="autoPatrol"
              @change="handleAutoPatrolChange"
            />
          </div>

          <!-- è·Ÿè¸ªæ¨¡å¼ -->
          <div class="advanced-item">
            <div class="item-label">ç›®æ ‡è·Ÿè¸ª</div>
            <van-switch
              v-model="trackingMode"
              @change="handleTrackingModeChange"
            />
          </div>

          <!-- å¤œé—´æ¨¡å¼ -->
          <div class="advanced-item">
            <div class="item-label">å¤œé—´æ¨¡å¼</div>
            <van-switch
              v-model="nightMode"
              @change="handleNightModeChange"
            />
          </div>

          <!-- é›¨åˆ·æ§åˆ¶ -->
          <div class="advanced-item">
            <div class="item-label">é›¨åˆ·</div>
            <van-switch
              v-model="wiperEnabled"
              @change="handleWiperChange"
            />
          </div>
        </van-collapse-item>
      </van-collapse>
    </div>

    <!-- ä½ç½®ä¿¡æ¯ -->
    <div class="position-info">
      <div class="info-item">
        <span class="label">æ°´å¹³:</span>
        <span class="value">{{ currentPan }}Â°</span>
      </div>
      <div class="info-item">
        <span class="label">å‚ç›´:</span>
        <span class="value">{{ currentTilt }}Â°</span>
      </div>
      <div class="info-item">
        <span class="label">å˜ç„¦:</span>
        <span class="value">{{ currentZoom }}x</span>
      </div>
    </div>

    <!-- é¢„è®¾ä½ç®¡ç†å¼¹çª— -->
    <van-dialog
      v-model:show="showPresetDialog"
      title="é¢„è®¾ä½ç®¡ç†"
      :show-confirm-button="false"
      :show-cancel-button="false"
    >
      <div class="preset-manager">
        <div class="preset-list">
          <div
            v-for="preset in presets"
            :key="preset.id"
            class="preset-manager-item"
          >
            <div class="preset-info">
              <div class="preset-name">{{ preset.name }}</div>
              <div class="preset-position">
                {{ preset.position.pan }}Â°, {{ preset.position.tilt }}Â°
              </div>
            </div>
            <div class="preset-actions">
              <van-button
                type="default"
                size="mini"
                @click="editPreset(preset)"
              >
                ç¼–è¾‘
              </van-button>
              <van-button
                type="danger"
                size="mini"
                @click="deletePreset(preset.id)"
              >
                åˆ é™¤
              </van-button>
            </div>
          </div>
        </div>
        <div class="preset-manager-actions">
          <van-button
            type="default"
            @click="showPresetDialog = false"
          >
            å…³é—­
          </van-button>
        </div>
      </div>
    </van-dialog>

    <!-- ä¿å­˜é¢„è®¾ä½å¼¹çª— -->
    <van-dialog
      v-model:show="showSavePresetDialog"
      title="ä¿å­˜é¢„è®¾ä½"
      show-cancel-button
      @confirm="confirmSavePreset"
    >
      <van-field
        v-model="presetName"
        label="é¢„è®¾ä½åç§°"
        placeholder="è¯·è¾“å…¥é¢„è®¾ä½åç§°"
      />
    </van-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useVideoStore } from '@/stores/video'
import { showToast, showConfirmDialog } from 'vant'

// Propså®šä¹‰
const props = defineProps<PTZControllerProps>()

// Emitså®šä¹‰
const emit = defineEmits<PTZControllerEmits>()

// çŠ¶æ€ç®¡ç†
const videoStore = useVideoStore()

// å“åº”å¼æ•°æ®
const currentPan = ref(0)
const currentTilt = ref(0)
const currentZoom = ref(1)
const currentFocus = ref(0)
const currentSpeed = ref(5)
const currentPreset = ref<number | null>(null)

const autoPatrol = ref(false)
const trackingMode = ref(false)
const nightMode = ref(false)
const wiperEnabled = ref(false)

const advancedExpanded = ref(['advanced'])
const showPresetDialog = ref(false)
const showSavePresetDialog = ref(false)
const presetName = ref('')

const presets = ref([
  { id: 1, name: 'å¤§é—¨', position: { pan: 0, tilt: 0, zoom: 1 } },
  { id: 2, name: 'åœè½¦åœº', position: { pan: 90, tilt: -30, zoom: 2 } },
  { id: 3, name: 'ä¾§é—¨', position: { pan: -90, tilt: 0, zoom: 1.5 } },
  { id: 4, name: 'åé—¨', position: { pan: 180, tilt: 15, zoom: 1 } },
  { id: 5, name: 'å¤§å…', position: { pan: 45, tilt: -15, zoom: 3 } }
])

// æ–¹æ³•å®ç°
const moveDirection = (direction: string) => {
  const commandMap: Record<string, string> = {
    'UP': 'TILT_UP',
    'DOWN': 'TILT_DOWN',
    'LEFT': 'PAN_LEFT',
    'RIGHT': 'PAN_RIGHT',
    'TOP_LEFT': 'PAN_TILT_TOP_LEFT',
    'TOP_RIGHT': 'PAN_TILT_TOP_RIGHT',
    'BOTTOM_LEFT': 'PAN_TILT_BOTTOM_LEFT',
    'BOTTOM_RIGHT': 'PAN_TILT_BOTTOM_RIGHT'
  }

  const command = commandMap[direction]
  if (command) {
    sendCommand(command, {
      speed: currentSpeed.value
    })
  }
}

const stopMovement = () => {
  sendCommand('STOP')
}

const zoom = (direction: 'IN' | 'OUT') => {
  const newZoom = direction === 'IN'
    ? Math.min(currentZoom.value + 1, 32)
    : Math.max(currentZoom.value - 1, 1)

  currentZoom.value = newZoom
  sendCommand('ZOOM', {
    direction,
    zoom: newZoom
  })
}

const goToPreset = (presetId: number) => {
  const preset = presets.value.find(p => p.id === presetId)
  if (preset) {
    currentPreset.value = presetId
    currentPan.value = preset.position.pan
    currentTilt.value = preset.position.tilt
    currentZoom.value = preset.position.zoom

    sendCommand('GOTO_PRESET', {
      presetId,
      position: preset.position
    })

    showToast(`åˆ‡æ¢åˆ°${preset.name}`)
  }
}

const savePreset = () => {
  showSavePresetDialog.value = true
}

const confirmSavePreset = () => {
  if (!presetName.value.trim()) {
    showToast('è¯·è¾“å…¥é¢„è®¾ä½åç§°')
    return
  }

  const newPreset = {
    id: Date.now(),
    name: presetName.value,
    position: {
      pan: currentPan.value,
      tilt: currentTilt.value,
      zoom: currentZoom.value,
      focus: currentFocus.value
    }
  }

  presets.value.push(newPreset)
  showSavePresetDialog.value = false
  presetName.value = ''

  sendCommand('SAVE_PRESET', {
    preset: newPreset
  })

  showToast(`ä¿å­˜é¢„è®¾ä½æˆåŠŸ: ${newPreset.name}`)
}

const showPresetManager = () => {
  showPresetDialog.value = true
}

const editPreset = (preset: any) => {
  // ç¼–è¾‘é¢„è®¾ä½é€»è¾‘
  showSavePresetDialog.value = true
  presetName.value = preset.name
}

const deletePreset = async (presetId: number) => {
  const confirmed = await showConfirmDialog({
    title: 'ç¡®è®¤åˆ é™¤',
    message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾ä½å—ï¼Ÿ'
  })

  if (confirmed) {
    const index = presets.value.findIndex(p => p.id === presetId)
    if (index !== -1) {
      presets.value.splice(index, 1)

      if (currentPreset.value === presetId) {
        currentPreset.value = null
      }

      sendCommand('DELETE_PRESET', {
        presetId
      })

      showToast('é¢„è®¾ä½å·²åˆ é™¤')
    }
  }
}

const handleSpeedChange = (value: number) => {
  currentSpeed.value = value
}

const handleAutoPatrolChange = (enabled: boolean) => {
  sendCommand('SET_AUTO_PATROL', {
    enabled,
    speed: currentSpeed.value
  })
}

const handleTrackingModeChange = (enabled: boolean) => {
  sendCommand('SET_TRACKING_MODE', {
    enabled
  })
}

const handleNightModeChange = (enabled: boolean) => {
  sendCommand('SET_NIGHT_MODE', {
    enabled
  })
}

const handleWiperChange = (enabled: boolean) => {
  sendCommand('SET_WIPER', {
    enabled
  })
}

const sendCommand = (command: string, parameters?: Record<string, any>) => {
  const ptzCommand: PTZCommand = {
    command,
    parameters: {
      deviceId: props.deviceId,
      ...parameters
    }
  }

  emit('command', ptzCommand)
}

const handleClose = () => {
  emit('close')
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  // è·å–å½“å‰ä½ç½®ä¿¡æ¯
  if (props.position) {
    currentPan.value = props.position.pan
    currentTilt.value = props.position.tilt
    currentZoom.value = props.position.zoom
    currentFocus.value = props.position.focus
  }

  // è·å–è®¾å¤‡é¢„è®¾ä½
  loadPresets()
})

const loadPresets = async () => {
  try {
    // è¿™é‡Œåº”è¯¥ä»APIè·å–é¢„è®¾ä½æ•°æ®
    // const devicePresets = await videoStore.getDevicePresets(props.deviceId)
    // presets.value = devicePresets
  } catch (error) {
    console.error('åŠ è½½é¢„è®¾ä½å¤±è´¥:', error)
  }
}
</script>

<style lang="scss" scoped>
.ptz-controller {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  padding: 16px;

  &.compact {
    padding: 12px;
  }
}

.controller-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;

  .title {
    font-size: 16px;
    font-weight: 600;
    color: #323233;
  }

  .van-button {
    background: #f7f8fa;
    border: 1px solid #ebedf0;
    color: #646566;
    padding: 6px 10px;

    &:active {
      background: #ebedf0;
    }
  }
}

.direction-control {
  margin-bottom: 20px;

  .control-circle {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto;
    border: 2px solid #ebedf0;
    border-radius: 50%;

    .center-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1989fa;
      border-color: #1989fa;
      color: white;
      width: 40px;
      height: 40px;
    }

    .direction-btn {
      position: absolute;
      width: 40px;
      height: 40px;
      background: #f7f8fa;
      border: 1px solid #ebedf0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;

      &:hover {
        background: #e8f4ff;
        border-color: #1989fa;
      }

      &:active {
        transform: scale(0.95);
      }

      &.top {
        top: 0;
        left: 50%;
        transform: translateX(-50%);
      }

      &.top-left {
        top: 15px;
        left: 15px;
      }

      &.top-right {
        top: 15px;
        right: 15px;
      }

      &.left {
        top: 50%;
        left: 0;
        transform: translateY(-50%);
      }

      &.right {
        top: 50%;
        right: 0;
        transform: translateY(-50%);
      }

      &.bottom {
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
      }

      &.bottom-left {
        bottom: 15px;
        left: 15px;
      }

      &.bottom-right {
        bottom: 15px;
        right: 15px;
      }
    }
  }
}

.zoom-control,
.speed-control,
.presets-control {
  margin-bottom: 16px;

  .control-label {
    font-size: 14px;
    color: #646566;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .zoom-buttons {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;

    .van-button {
      width: 44px;
      height: 44px;
      background: #f7f8fa;
      border: 1px solid #ebedf0;
      color: #646566;

      &:active {
        background: #ebedf0;
      }
    }

    .zoom-indicator {
      font-size: 16px;
      font-weight: 600;
      color: #1989fa;
      min-width: 60px;
      text-align: center;
    }
  }

  .speed-slider {
    margin: 0;
  }

  .presets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 8px;
    margin-bottom: 12px;

    .preset-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 8px;
      background: #f7f8fa;
      border: 1px solid #ebedf0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;

      &:hover {
        background: #e8f4ff;
        border-color: #1989fa;
      }

      &.active {
        background: #e3f2fd;
        border-color: #1989fa;
        color: #1989fa;
      }

      .van-icon {
        margin-bottom: 4px;
      }

      span {
        font-size: 12px;
        text-align: center;
      }
    }
  }

  .preset-actions {
    display: flex;
    gap: 8px;

    .van-button {
      flex: 1;
    }
  }
}

.advanced-control {
  margin-bottom: 16px;

  .advanced-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;

    .item-label {
      font-size: 14px;
      color: #646566;
    }
  }
}

.position-info {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  padding-top: 12px;
  border-top: 1px solid #ebedf0;

  .info-item {
    text-align: center;

    .label {
      font-size: 12px;
      color: #969799;
      margin-bottom: 2px;
    }

    .value {
      font-size: 14px;
      color: #323233;
      font-weight: 500;
    }
  }
}

.preset-manager {
  max-height: 300px;
  overflow-y: auto;

  .preset-list {
    margin-bottom: 16px;

    .preset-manager-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f7f8fa;
      border-radius: 8px;
      margin-bottom: 8px;

      .preset-info {
        flex: 1;

        .preset-name {
          font-size: 14px;
          font-weight: 500;
          color: #323233;
          margin-bottom: 2px;
        }

        .preset-position {
          font-size: 12px;
          color: #969799;
        }
      }

      .preset-actions {
        display: flex;
        gap: 8px;
      }
    }
  }

  .preset-manager-actions {
    text-align: center;
  }
}

// å“åº”å¼è®¾è®¡
@media (max-width: 375px) {
  .ptz-controller {
    padding: 12px;
  }

  .direction-control .control-circle {
    width: 160px;
    height: 160px;

    .center-btn {
      width: 36px;
      height: 36px;
    }

    .direction-btn {
      width: 32px;
      height: 32px;
    }
  }

  .presets-control .presets-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;

    .preset-item {
      padding: 8px 6px;

      span {
        font-size: 11px;
      }
    }
  }

  .position-info {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;

    .info-item .value {
      font-size: 13px;
    }
  }
}
</style>
```

---

## ç§»åŠ¨ç«¯ç»„ä»¶ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```typescript
import { ref } from 'vue'
import { VideoPlayer, PTZController } from '@/components/video'

export default {
  components: {
    VideoPlayer,
    PTZController
  },
  setup() {
    const streamUrl = ref('rtmp://192.168.1.101/live/stream1')
    const deviceId = ref('CAM001')
    const showPTZ = ref(false)

    const handlePTZCommand = async (command: PTZCommand) => {
      console.log('PTZå‘½ä»¤:', command)
      // è°ƒç”¨PTZæ§åˆ¶API
    }

    return {
      streamUrl,
      deviceId,
      showPTZ,
      handlePTZCommand
    }
  }
}
```

### å®Œæ•´ç›‘æ§é¡µé¢ç¤ºä¾‹
```vue
<template>
  <div class="video-monitor-page">
    <!-- è®¾å¤‡ç½‘æ ¼ -->
    <div class="device-grid">
      <div
        v-for="device in devices"
        :key="device.id"
        class="device-item"
        @click="selectDevice(device)"
      >
        <VideoPlayer
          :device-id="device.id"
          :stream-url="device.streamUrl"
          :controls="false"
          :adaptive-bitrate="true"
          @ready="handlePlayerReady"
          @error="handlePlayerError"
        />
        <div class="device-info">
          <div class="device-name">{{ device.name }}</div>
          <div class="device-status" :class="device.status.toLowerCase()">
            {{ device.status === 'ONLINE' ? 'åœ¨çº¿' : 'ç¦»çº¿' }}
          </div>
        </div>
      </div>
    </div>

    <!-- PTZæ§åˆ¶é¢æ¿ -->
    <van-popup
      v-model:show="showPTZ"
      position="bottom"
      :style="{ height: '60%' }"
      round
    >
      <PTZController
        :device-id="selectedDeviceId"
        @command="handlePTZCommand"
        @close="showPTZ = false"
      />
    </van-popup>

    <!-- æ§åˆ¶æŒ‰é’®æ  -->
    <div class="control-bar">
      <van-button
        type="primary"
        size="small"
        round
        @click="showPTZ = true"
      >
        <van-icon name="aim" />
        PTZæ§åˆ¶
      </van-button>
      <van-button
        type="default"
        size="small"
        round
        @click="captureSnapshot"
      >
        <van-icon name="photograph" />
        æˆªå›¾
      </van-button>
      <van-button
        type="default"
        size="small"
        round
        @click="toggleFullscreen"
      >
        <van-icon name="enlarge" />
        å…¨å±
      </van-button>
      <van-button
        type="default"
        size="small"
        round
        @click="showAIDetection"
      >
        <van-icon name="eye-o" />
        AIæ£€æµ‹
      </van-button>
    </div>
  </div>
</template>
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è§†é¢‘æµä¼˜åŒ–
```typescript
// è‡ªé€‚åº”ç ç‡
const adaptiveBitrate = (networkSpeed: number) => {
  const profiles = {
    high: { resolution: '1920x1080', bitrate: 4000 },
    medium: { resolution: '1280x720', bitrate: 2000 },
    low: { resolution: '640x480', bitrate: 800 }
  }

  let profile
  if (networkSpeed > 10) {
    profile = profiles.high
  } else if (networkSpeed > 2) {
    profile = profiles.medium
  } else {
    profile = profiles.low
  }

  return profile
}
```

### 2. å†…å­˜ç®¡ç†
```typescript
// åŠæ—¶æ¸…ç†è§†é¢‘æµ
onUnmounted(() => {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop())
  }
})
```

### 3. ç½‘ç»œä¼˜åŒ–
```typescript
// æ–­çº¿é‡è¿æœºåˆ¶
const reconnectStream = async (deviceId: string, retryCount = 0) => {
  const maxRetries = 3

  try {
    return await setupWebRTCStream(deviceId)
  } catch (error) {
    if (retryCount < maxRetries) {
      setTimeout(() => reconnectStream(deviceId, retryCount + 1), 2000 * (retryCount + 1))
    }
    throw error
  }
}
```

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. è®¿é—®æ§åˆ¶
- è®¾å¤‡è®¿é—®æƒé™éªŒè¯
- PTZæ§åˆ¶æƒé™æ£€æŸ¥
- å½•åƒä¸‹è½½æƒé™ç®¡ç†

### 2. æ•°æ®å®‰å…¨
- è§†é¢‘æµåŠ å¯†ä¼ è¾“
- æ•æ„Ÿä¿¡æ¯è„±æ•
- æ“ä½œæ—¥å¿—è®°å½•

### 3. éšç§ä¿æŠ¤
- äººè„¸è¯†åˆ«æ•°æ®ä¿æŠ¤
- å½•åƒå­˜å‚¨åˆè§„
- æ•°æ®è®¿é—®å®¡è®¡

---

## ç‰ˆæœ¬ä¿¡æ¯

- **å½“å‰ç‰ˆæœ¬**: v2.0.0
- **å…¼å®¹Vue**: 3.4.0+
- **å…¼å®¹Vant**: 4.8.0+
- **æ›´æ–°æ—¥æœŸ**: 2024-01-15
- **æŠ€æœ¯æ”¯æŒ**: frontend-team@ioe-dream.com