# ZKBioSecurity-ACC门禁系统 - 设备管理模块流程图

## 设备管理页面功能点

基于zkbiosecurity-acc-3.14.x-RELEASE项目的实际设备管理页面分析，主要功能按钮包括：

### 主要操作按钮
1. **刷新** - 重新加载设备列表
2. **新增设备** - 手动添加新设备（支持Pull和Push设备）
3. **删除设备** - 删除选中的设备
4. **导出** - 导出设备列表
5. **搜索设备** - 自动搜索网络内的门禁设备
6. **设备控制**（包含多个子功能）
   - 清除管理员
   - 清除命令缓存
   - 固件升级
   - 重启设备
   - 同步时间
   - 启用/禁用设备
   - 同步数据到设备
7. **高级设置**（包含多个子功能）
   - 下发验证参数
   - 设置时区
   - 设置登记机
   - 修改指纹阈值
   - 设置扩展参数
   - NTP服务器设置
   - 设备替换
   - 上传资源文件
   - 人脸比对服务器设置
8. **查看或获取信息**（包含多个子功能）
   - 获取设备参数
   - 获取人员信息
   - 获取记录
   - 查看门禁规则
   - 查看设备容量
9. **通信设置**（包含多个子功能）
   - 修改IP地址
   - 修改通讯密码
   - 修改网络连接方式

## 设备管理模块流程图

```mermaid
graph TB
    subgraph 设备管理模块
        Start(设备管理开始) --> Choose{选择操作类型}

        Choose -->|新增设备| AddDeviceFlow
        Choose -->|搜索设备| SearchDeviceFlow
        Choose -->|同步设备信息| SyncDeviceFlow
        Choose -->|设备控制| DeviceControlFlow
        Choose -->|高级设置| AdvancedSettingsFlow
        Choose -->|查看信息| ViewInfoFlow

        subgraph 新增设备流程
            AddDeviceFlow --> AddType{设备类型}
            AddType -->|Pull设备| PullDevice[手动配置Pull设备]
            AddType -->|Push设备| PushDevice[等待Push设备连接]
            PullDevice --> DeviceConfig[设备基本配置]
            PushDevice --> AuthDevice[设备授权验证]
            DeviceConfig --> AreaSelect{选择关联区域}
            AuthDevice --> AreaSelect
            AreaSelect --> DeviceSave[保存设备信息]
            DeviceSave --> AutoSync{自动同步}
            AutoSync -->|是| DoorInfo[门信息自动推送]
            AutoSync -->|是| ReaderInfo[读头信息自动推送]
            DoorInfo --> SaveDoor[保存门信息到系统]
            ReaderInfo --> SaveReader[保存读头信息到系统]
            SaveDoor --> AddEnd[新增设备完成]
            SaveReader --> AddEnd
            DeviceSave --> AddEnd
        end

        subgraph 搜索设备流程
            SearchDeviceFlow --> NetworkSearch[网络搜索设备]
            NetworkSearch --> DeviceList[显示设备列表]
            DeviceList --> SelectDevice[选择要添加的设备]
            SelectDevice --> AddSelect[添加选中设备]
            AddSelect --> DeviceConfig
        end

        subgraph 同步设备信息流程
            SyncDeviceFlow --> SelectSyncDevice[选择要同步的设备]
            SelectSyncDevice --> SyncType{同步类型}
            SyncType -->|同步时间| SyncTime[同步设备时间]
            SyncType -->|同步数据| SyncData[同步权限数据]
            SyncType -->|同步所有数据| SyncAll[同步所有配置数据]
            SyncTime --> SyncToDevice[下发同步命令到设备]
            SyncData --> SyncToDevice
            SyncAll --> SyncToDevice
            SyncToDevice --> SyncResult[同步结果]
            SyncResult --> SyncEnd[同步完成]
        end

        subgraph 设备控制流程
            DeviceControlFlow --> ControlType{控制类型}
            ControlType -->|重启设备| Reboot[下发重启命令]
            ControlType -->|启用/禁用| EnableDisable[设置设备状态]
            ControlType -->|清除命令| ClearCmd[清除设备命令缓存]
            ControlType -->|固件升级| Upgrade[固件升级流程]
            ControlType -->|清除管理员| ClearAdmin[清除设备管理员]
            Reboot --> ExecControl[执行控制命令]
            EnableDisable --> ExecControl
            ClearCmd --> ExecControl
            Upgrade --> ExecControl
            ClearAdmin --> ExecControl
            ExecControl --> ControlResult[控制结果反馈]
            ControlResult --> ControlEnd[控制完成]
        end

        subgraph 高级设置流程
            AdvancedSettingsFlow --> SettingType{设置类型}
            SettingType -->|验证参数| VerifyParam[下发后台验证参数]
            SettingType -->|时区设置| TimeZone[设置设备时区]
            SettingType -->|通讯参数| CommParam[修改IP/密码等]
            SettingType -->|扩展参数| ExtParam[设置设备扩展参数]
            SettingType -->|NTP服务| NTP[配置NTP服务器]
            VerifyParam --> SaveSetting[保存设置到设备]
            TimeZone --> SaveSetting
            CommParam --> SaveSetting
            ExtParam --> SaveSetting
            NTP --> SaveSetting
            SaveSetting --> SettingResult[设置结果]
            SettingResult --> SettingEnd[设置完成]
        end

        subgraph 查看信息流程
            ViewInfoFlow --> InfoType{信息类型}
            InfoType -->|设备参数| DevParam[获取设备参数]
            InfoType -->|人员信息| PersonInfo[获取设备人员信息]
            InfoType -->|记录信息| TransInfo[获取设备记录]
            InfoType -->|门禁规则| AccessRules[查看门禁规则]
            InfoType -->|设备容量| DeviceUsage[查看设备使用情况]
            DevParam --> ShowInfo[显示信息]
            PersonInfo --> ShowInfo
            TransInfo --> ShowInfo
            AccessRules --> ShowInfo
            DeviceUsage --> ShowInfo
            ShowInfo --> ViewEnd[查看完成]
        end
    end
```

## 重要特性说明
## 📋 IOE-DREAM七微服务架构

**核心架构组成**:
- **Gateway Service (8080)**: API网关
- **Common Service (8088)**: 公共模块微服务
- **DeviceComm Service (8087)**: 设备通讯微服务
- **OA Service (8089)**: OA微服务
- **Access Service (8090)**: 门禁服务
- **Attendance Service (8091)**: 考勤服务
- **Video Service (8092)**: 视频服务
- **Consume Service (8094)**: 消费服务
- **Visitor Service (8095)**: 访客服务

**架构特点**:
- 基于Spring Boot 3.5.8 + Java 17
- 严格遵循企业级微服务规范
- 支持高并发、高可用、水平扩展

**技术栈标准**:
- **数据库**: MySQL 8.0 + Druid连接池
- **缓存**: Redis + Caffeine多级缓存
- **注册中心**: Nacos
- **配置中心**: Nacos Config
- **认证授权**: Sa-Token

## 🏗️ 四层架构规范

**标准架构模式**:
```
Controller (接口控制层)
    ↓
Service (核心业务层)
    ↓
Manager (流程管理层)
    ↓
DAO (数据访问层)
```

**层级职责**:
- **Controller层**: HTTP请求处理、参数验证、权限控制
- **Service层**: 核心业务逻辑、事务管理、业务规则验证
- **Manager层**: 复杂流程编排、多数据组装、第三方服务集成
- **DAO层**: 数据库CRUD操作、SQL查询实现、数据访问边界

**严格禁止跨层访问**: Controller不能直接调用Manager/DAO！
### 设备自动推送机制
## ⚠️ IOE-DREAM零容忍规则（强制执行）

**必须遵守的架构规则**:
- ✅ **必须使用 @Resource 注入依赖**
- ✅ **必须使用 @Mapper 注解** (禁止@Repository)
- ✅ **必须使用 Dao 后缀** (禁止Repository)
- ✅ **必须使用 @RestController 注解**
- ✅ **必须使用 @Valid 参数校验**
- ✅ **必须返回统一ResponseDTO格式**
- ✅ **必须遵循四层架构边界**

**严格禁止事项**:
- ❌ **禁止使用 @Autowired 注入**
- ❌ **禁止使用 @Repository 注解**
- ❌ **禁止使用 Repository 后缀命名**
- ❌ **禁止跨层访问**
- ❌ **禁止在Controller中包含业务逻辑**
- ❌ **禁止直接访问数据库**

**违规后果**: P0级问题，立即修复，禁止合并！
根据代码分析，设备添加后具有以下自动推送特性：

1. **设备自动推送门信息**：
   - 设备连接到系统后，会自动推送其包含的门信息
   - 系统接收门信息并自动保存到数据库
   - 无需手动创建门

2. **设备自动推送读头信息**：
   - 设备会推送门上面的读头信息
   - 系统自动建立读头与门的关联关系
   - 无需手动配置读头

3. **Push设备特性**：
   - 支持跨网段Push设备
   - 设备主动连接到服务器
   - 自动获取设备完整配置信息

### 设备通信类型
- **Pull设备**：系统主动连接设备，获取设备信息
- **Push设备**：设备主动连接系统，推送设备信息

### 设备搜索功能
- 支持自动网络搜索
- 通过MAC地址避免重复添加
- 显示设备IP、MAC地址、设备型号等信息

### 设备区域关联机制
- **设备添加时必须选择区域**：在设备基本配置后选择关联的区域ID
- **区域绑定验证**：验证选择的区域是否有效，设备只能关联一个区域
- **权限传递**：设备关联区域后，该区域的门和人员权限配置才能生效
- **区域变更**：支持修改设备关联的区域，变更时同步更新相关权限

## 设备区域关联流程

```mermaid
graph LR
    DeviceAdd[设备添加] --> BasicConfig[基本配置]
    BasicConfig --> AreaSelect[选择关联区域]
    AreaSelect --> AreaValidate[验证区域有效性]
    AreaValidate --> AreaSave[保存设备区域关联]
    AreaSave --> AutoDoorAuth[为区域创建门权限]
    AreaSave --> UpdateAreaDevice[更新区域设备列表]
```

## 设备管理核心变更

### 新增设备流程调整
1. **设备基本配置** → **选择关联区域** → **保存设备信息**
2. 设备必须关联到具体区域才能完整使用
3. 区域关联在设备添加时完成，确保数据完整性

### 设备区域管理
1. **区域关联**：设备添加时选择所属区域
2. **区域变更**：支持修改设备的关联区域
3. **权限同步**：区域变更时自动同步门和人员权限
4. **设备列表**：可按区域筛选查看设备