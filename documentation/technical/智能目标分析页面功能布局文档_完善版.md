# 智能目标分析页面功能与布局文档

## 页面概述
智能目标分析页面是智能视频监控系统的核心AI分析模块，用于实现目标类型识别、属性分析、轨迹追踪和统计报表等功能。该页面支持人员、车辆、物品等多种目标类型的智能识别，提供目标抓拍、属性提取、区域检测、轨迹可视化等功能。页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供设备管理、检测参数配置、区域绘制、实时分析结果展示等功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **Canvas绘图**: 原生Canvas API（区域绘制）

### 项目文件组织结构
```
src/views/business/smart-video/
├── target-intelligent/
│   ├── index.vue                       # 智能目标分析主页面
│   ├── components/
│   │   ├── DeviceList.vue             # 左侧设备列表组件
│   │   ├── ConfigPanel.vue            # 检测参数配置面板
│   │   ├── DetectionSettings.vue      # 检测设置组件
│   │   ├── AreaDrawing.vue            # 区域绘制组件
│   │   ├── VideoCanvas.vue            # 视频画线Canvas组件
│   │   ├── DrawToolbar.vue            # 绘制工具栏组件
│   │   ├── AreaList.vue               # 已绘制区域列表
│   │   ├── ResultsDisplay.vue         # 检测结果展示组件
│   │   ├── ResultsGrid.vue            # 结果网格组件
│   │   ├── StatisticsCards.vue        # 统计卡片组件
│   │   ├── TargetAttributes.vue       # 目标属性展示组件
│   │   ├── TrajectoryMap.vue          # 轨迹地图组件
│   │   └── MaskDetection.vue          # 口罩识别组件
│   ├── hooks/
│   │   ├── useTargetAnalysis.js       # 目标分析业务逻辑Hook
│   │   ├── useDeviceManage.js         # 设备管理Hook
│   │   ├── useAreaDrawing.js          # 区域绘制Hook
│   │   └── useDetectionConfig.js      # 检测配置Hook
│   ├── mock/
│   │   └── target-intelligent-mock.js # 模拟数据
│   └── api/
│       └── target-intelligent-api.js  # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/target-intelligent-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const targetIntelligentApi = {
  // 获取设备列表
  getDeviceList: (params) => getRequest('/target-intelligent/devices', params),

  // 获取设备配置
  getDeviceConfig: (deviceId) => getRequest(`/target-intelligent/config/${deviceId}`),

  // 保存检测参数
  saveDetectionConfig: (params) => postRequest('/target-intelligent/config/save', params),

  // 保存区域配置
  saveAreaConfig: (params) => postRequest('/target-intelligent/area/save', params),

  // 获取检测结果
  getDetectionResults: (params) => getRequest('/target-intelligent/results', params),

  // 获取目标属性
  getTargetAttributes: (targetId) => getRequest(`/target-intelligent/attributes/${targetId}`),

  // 获取轨迹数据
  getTrajectoryData: (params) => postRequest('/target-intelligent/trajectory', params),

  // 获取统计数据
  getStatistics: (params) => getRequest('/target-intelligent/statistics', params),

  // 启动/停止检测
  toggleDetection: (params) => postRequest('/target-intelligent/toggle', params),

  // 导出检测结果
  exportResults: (params) => postRequest('/target-intelligent/export', params),
};
```

### 路由配置
```javascript
// src/router/modules/smart-video.js
{
  path: '/smart-video/target-intelligent',
  name: 'TargetIntelligent',
  component: () => import('/@/views/business/smart-video/target-intelligent/index.vue'),
  meta: {
    title: '智能目标分析',
    icon: 'AimOutlined',
    requiresAuth: true,
    keepAlive: true,
  },
}
```

### 菜单配置
```javascript
// 菜单配置示例
{
  menuName: '智能目标分析',
  menuType: 1,
  path: '/smart-video/target-intelligent',
  component: '/business/smart-video/target-intelligent/index.vue',
  icon: 'AimOutlined',
  perms: ['smart-video:target-intelligent:query'],
  sortNum: 3,
}
```

## 核心功能模块

### 1. 设备管理模块
**功能说明**：
- 设备列表展示（在线/离线状态）
- 设备选择切换
- 设备状态监控
- 设备快速筛选

**核心代码**：
```vue
<template>
  <div class="device-list-panel">
    <a-card title="设备列表" :bordered="false">
      <a-input-search
        v-model:value="searchKeyword"
        placeholder="搜索设备"
        @search="handleSearch"
        style="margin-bottom: 16px"
      />

      <a-list
        :data-source="deviceList"
        :loading="loading"
      >
        <template #renderItem="{ item }">
          <a-list-item
            class="device-item"
            :class="{ 'selected': selectedDevice?.id === item.id }"
            @click="selectDevice(item)"
          >
            <a-list-item-meta>
              <template #avatar>
                <a-badge :status="item.online ? 'success' : 'error'">
                  <VideoCameraOutlined :style="{ fontSize: '24px' }" />
                </a-badge>
              </template>
              <template #title>
                {{ item.name }}
              </template>
              <template #description>
                {{ item.online ? '在线' : '离线' }}
              </template>
            </a-list-item-meta>
          </a-list-item>
        </template>
      </a-list>
    </a-card>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { VideoCameraOutlined } from '@ant-design/icons-vue';
import { targetIntelligentApi } from '../api/target-intelligent-api';

const deviceList = ref([]);
const selectedDevice = ref(null);
const searchKeyword = ref('');
const loading = ref(false);

const loadDevices = async () => {
  loading.value = true;
  try {
    const res = await targetIntelligentApi.getDeviceList();
    deviceList.value = res.data;
  } finally {
    loading.value = false;
  }
};

const selectDevice = (device) => {
  if (!device.online) {
    message.warning('设备离线，无法操作');
    return;
  }
  selectedDevice.value = device;
  emit('device-selected', device);
};

onMounted(() => {
  loadDevices();
});
</script>
```

### 2. 检测参数配置模块
**功能说明**：
- 目标抓拍开关
- 目标属性分析开关
- 检测模式选择（目标检测/整体目标检测）
- 抓拍模式选择（优化模式/极速模式/定时模式）
- 检测灵敏度配置
- 目标尺寸范围设置

**核心代码**：
```vue
<template>
  <a-card title="检测参数配置" :bordered="false">
    <a-form
      :model="formState"
      :label-col="{ span: 8 }"
      :wrapper-col="{ span: 16 }"
    >
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="目标抓拍">
            <a-switch v-model:checked="formState.enableCapture" />
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item label="目标属性">
            <a-switch v-model:checked="formState.enableAttributes" />
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="检测模式">
            <a-select v-model:value="formState.detectionMode">
              <a-select-option value="target">目标检测</a-select-option>
              <a-select-option value="whole">整体目标检测</a-select-option>
              <a-select-option value="both">目标和整体目标检测</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item label="抓拍模式">
            <a-select v-model:value="formState.captureMode">
              <a-select-option value="optimized">优化模式</a-select-option>
              <a-select-option value="fast">极速模式</a-select-option>
              <a-select-option value="timed">定时模式</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="告警检测间隔">
            <a-input-number
              v-model:value="formState.detectionInterval"
              :min="0.1"
              :step="0.1"
              :precision="1"
              suffix="秒"
              style="width: 100%"
            />
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item label="目标检测灵敏度">
            <a-slider
              v-model:value="formState.sensitivity"
              :min="0"
              :max="100"
              :marks="{ 0: '0', 50: '50', 100: '100' }"
            />
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="目标最小尺寸">
            <a-input-number
              v-model:value="formState.minSize"
              :min="1"
              suffix="像素"
              style="width: 100%"
            />
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item label="目标最大尺寸">
            <a-input-number
              v-model:value="formState.maxSize"
              :min="1"
              suffix="像素"
              style="width: 100%"
            />
          </a-form-item>
        </a-col>
      </a-row>

      <a-form-item :wrapper-col="{ offset: 8, span: 16 }">
        <a-space>
          <a-button type="primary" @click="handleSave">
            <SaveOutlined />保存配置
          </a-button>
          <a-button @click="handleReset">
            <RedoOutlined />重置
          </a-button>
        </a-space>
      </a-form-item>
    </a-form>
  </a-card>
</template>

<script setup>
import { reactive } from 'vue';
import { SaveOutlined, RedoOutlined } from '@ant-design/icons-vue';
import { message } from 'ant-design-vue';
import { targetIntelligentApi } from '../api/target-intelligent-api';

const formState = reactive({
  enableCapture: true,
  enableAttributes: true,
  detectionMode: 'target',
  captureMode: 'optimized',
  detectionInterval: 1.0,
  sensitivity: 80,
  minSize: 32,
  maxSize: 400,
});

const handleSave = async () => {
  try {
    await targetIntelligentApi.saveDetectionConfig(formState);
    message.success('配置保存成功');
  } catch (error) {
    message.error('配置保存失败');
  }
};
</script>
```

### 3. 区域绘制模块
**功能说明**：
- 检测区域绘制（矩形-穿越）
- 排除区域绘制（矩形-不穿越）
- 警戒线绘制
- 区域管理（编辑/删除）
- Canvas绘图交互

**核心代码**：
```vue
<template>
  <a-modal
    v-model:open="visible"
    title="视频画线"
    width="1200px"
    :footer="null"
    :destroy-on-close="true"
  >
    <div class="video-drawing-container">
      <div class="video-canvas-area">
        <canvas
          ref="canvasRef"
          @mousedown="handleMouseDown"
          @mousemove="handleMouseMove"
          @mouseup="handleMouseUp"
        />
      </div>

      <div class="tools-panel">
        <a-card title="绘制模式" size="small" style="margin-bottom: 16px">
          <a-radio-group v-model:value="drawMode" @change="handleDrawModeChange">
            <a-radio-button value="rect-detect">
              <BorderOutlined style="color: #ef4444" />检测区域
            </a-radio-button>
            <a-radio-button value="rect-exclude">
              <BorderOutlined style="color: #3b82f6" />排除区域
            </a-radio-button>
            <a-radio-button value="line">
              <LineOutlined style="color: #10b981" />警戒线
            </a-radio-button>
          </a-radio-group>
        </a-card>

        <a-card title="已绘制区域" size="small" style="margin-bottom: 16px">
          <a-list
            size="small"
            :data-source="drawnAreas"
          >
            <template #renderItem="{ item, index }">
              <a-list-item>
                <template #actions>
                  <a-button
                    type="link"
                    danger
                    size="small"
                    @click="deleteArea(index)"
                  >
                    <DeleteOutlined />
                  </a-button>
                </template>
                <a-list-item-meta>
                  <template #avatar>
                    <span :style="{ color: item.color }">
                      <BorderOutlined v-if="item.mode.includes('rect')" />
                      <LineOutlined v-else />
                    </span>
                  </template>
                  <template #title>{{ item.label }}</template>
                </a-list-item-meta>
              </a-list-item>
            </template>
          </a-list>
        </a-card>

        <a-space direction="vertical" style="width: 100%">
          <a-button block @click="handleUndo">
            <UndoOutlined />撤销
          </a-button>
          <a-button block danger @click="handleClearAll">
            <ClearOutlined />清除全部
          </a-button>
          <a-button block type="primary" @click="handleSave">
            <SaveOutlined />保存设置
          </a-button>
        </a-space>
      </div>
    </div>
  </a-modal>
</template>

<script setup>
import { ref, reactive, onMounted, watch } from 'vue';
import {
  BorderOutlined,
  LineOutlined,
  DeleteOutlined,
  UndoOutlined,
  ClearOutlined,
  SaveOutlined
} from '@ant-design/icons-vue';
import { message } from 'ant-design-vue';
import { targetIntelligentApi } from '../api/target-intelligent-api';

const visible = ref(false);
const canvasRef = ref(null);
const drawMode = ref('rect-detect');
const drawnAreas = ref([]);
const isDrawing = ref(false);
const currentPath = ref(null);

const handleMouseDown = (e) => {
  const rect = canvasRef.value.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  isDrawing.value = true;
  currentPath.value = {
    mode: drawMode.value,
    points: [{ x, y }],
    color: getColorByMode(drawMode.value),
    label: getLabelByMode(drawMode.value),
  };
};

const handleMouseMove = (e) => {
  if (!isDrawing.value || !currentPath.value) return;

  const rect = canvasRef.value.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  currentPath.value.points.push({ x, y });
  redrawCanvas();
};

const handleMouseUp = () => {
  if (!isDrawing.value || !currentPath.value) return;

  isDrawing.value = false;
  drawnAreas.value.push(currentPath.value);
  currentPath.value = null;
  redrawCanvas();
};

const handleSave = async () => {
  try {
    await targetIntelligentApi.saveAreaConfig({
      areas: drawnAreas.value,
    });
    message.success('区域配置保存成功');
    visible.value = false;
  } catch (error) {
    message.error('区域配置保存失败');
  }
};
</script>
```

### 4. 检测结果展示模块
**功能说明**：
- 实时检测结果展示
- 目标类型分类（人员/车辆/人脸）
- 检测置信度显示
- 抓拍图片展示
- 检测时间记录

**核心代码**：
```vue
<template>
  <div class="results-display">
    <a-row :gutter="[16, 16]">
      <a-col
        v-for="item in resultsList"
        :key="item.id"
        :xs="24"
        :sm="12"
        :md="8"
        :lg="6"
      >
        <a-card
          hoverable
          :cover="item.imageUrl"
          @click="showDetail(item)"
        >
          <template #cover>
            <img :src="item.imageUrl" :alt="item.type" />
          </template>
          <a-card-meta>
            <template #title>
              <a-space>
                <UserOutlined v-if="item.type === 'person'" />
                <CarOutlined v-if="item.type === 'vehicle'" />
                <SmileOutlined v-if="item.type === 'face'" />
                {{ item.typeName }}
              </a-space>
            </template>
            <template #description>
              <div>时间: {{ item.captureTime }}</div>
              <div>置信度: {{ item.confidence }}%</div>
            </template>
          </a-card-meta>
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { UserOutlined, CarOutlined, SmileOutlined } from '@ant-design/icons-vue';
import { targetIntelligentApi } from '../api/target-intelligent-api';

const resultsList = ref([]);

const loadResults = async () => {
  const res = await targetIntelligentApi.getDetectionResults();
  resultsList.value = res.data;
};

onMounted(() => {
  loadResults();
});
</script>
```

### 5. 统计分析模块
**功能说明**：
- 今日检测总数统计
- 人员检测数量
- 车辆检测数量
- 人脸检测数量
- 实时数据更新

**核心代码**：
```vue
<template>
  <a-row :gutter="16">
    <a-col :span="6">
      <a-card>
        <a-statistic
          title="今日检测数"
          :value="statistics.totalCount"
          :value-style="{ color: '#1890ff' }"
        >
          <template #prefix>
            <SearchOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>
    <a-col :span="6">
      <a-card>
        <a-statistic
          title="人员检测"
          :value="statistics.personCount"
          :value-style="{ color: '#52c41a' }"
        >
          <template #prefix>
            <UserOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>
    <a-col :span="6">
      <a-card>
        <a-statistic
          title="车辆检测"
          :value="statistics.vehicleCount"
          :value-style="{ color: '#fa8c16' }"
        >
          <template #prefix>
            <CarOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>
    <a-col :span="6">
      <a-card>
        <a-statistic
          title="人脸检测"
          :value="statistics.faceCount"
          :value-style="{ color: '#1890ff' }"
        >
          <template #prefix>
            <SmileOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>
  </a-row>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { SearchOutlined, UserOutlined, CarOutlined, SmileOutlined } from '@ant-design/icons-vue';
import { targetIntelligentApi } from '../api/target-intelligent-api';

const statistics = ref({
  totalCount: 0,
  personCount: 0,
  vehicleCount: 0,
  faceCount: 0,
});

const loadStatistics = async () => {
  const res = await targetIntelligentApi.getStatistics();
  statistics.value = res.data;
};

onMounted(() => {
  loadStatistics();
  // 每30秒刷新一次
  setInterval(loadStatistics, 30000);
});
</script>
```

## Store状态管理

### Pinia Store定义
```javascript
// src/store/modules/target-intelligent.js
import { defineStore } from 'pinia';
import { targetIntelligentApi } from '/@/api/business/smart-video/target-intelligent-api';

export const useTargetIntelligentStore = defineStore('targetIntelligent', {
  state: () => ({
    deviceList: [],
    selectedDevice: null,
    detectionConfig: {},
    areaConfig: [],
    detectionResults: [],
    statistics: {},
    isDetecting: false,
  }),

  getters: {
    onlineDevices: (state) => state.deviceList.filter(d => d.online),
    offlineDevices: (state) => state.deviceList.filter(d => !d.online),
  },

  actions: {
    async loadDeviceList() {
      const res = await targetIntelligentApi.getDeviceList();
      this.deviceList = res.data;
    },

    async selectDevice(device) {
      this.selectedDevice = device;
      await this.loadDeviceConfig(device.id);
    },

    async loadDeviceConfig(deviceId) {
      const res = await targetIntelligentApi.getDeviceConfig(deviceId);
      this.detectionConfig = res.data;
    },

    async saveDetectionConfig(config) {
      await targetIntelligentApi.saveDetectionConfig(config);
      this.detectionConfig = config;
    },

    async startDetection() {
      await targetIntelligentApi.toggleDetection({ action: 'start' });
      this.isDetecting = true;
    },

    async stopDetection() {
      await targetIntelligentApi.toggleDetection({ action: 'stop' });
      this.isDetecting = false;
    },
  },
});
```

## Mock数据示例

```javascript
// src/views/business/smart-video/target-intelligent/mock/target-intelligent-mock.js
export const mockDeviceList = [
  { id: 'IVS1800-001', name: 'IVS1800-001', location: '办公区域前门', online: true },
  { id: 'IVS1800-002', name: 'IVS1800-002', location: '大厅中央', online: true },
  { id: 'NVR800-001', name: 'NVR800-001', location: '停车场入口', online: false },
];

export const mockDetectionResults = [
  {
    id: 1,
    type: 'person',
    typeName: '人员检测',
    confidence: 95,
    captureTime: '2024-01-30 14:35:22',
    imageUrl: 'https://picsum.photos/300/200?random=1',
    attributes: {
      gender: '男',
      age: 30,
      clothes: { upper: '黑色上衣', lower: '蓝色裤子' },
    },
  },
  {
    id: 2,
    type: 'vehicle',
    typeName: '车辆检测',
    confidence: 92,
    captureTime: '2024-01-30 14:34:18',
    imageUrl: 'https://picsum.photos/300/200?random=2',
    attributes: {
      vehicleType: '小轿车',
      color: '白色',
      plateNumber: '苏A12345',
    },
  },
];

export const mockStatistics = {
  totalCount: 1256,
  personCount: 856,
  vehicleCount: 345,
  faceCount: 55,
};
```

## 开发注意事项

### 1. 权限控制
```javascript
// 按钮权限示例
<a-button v-has="'smart-video:target-intelligent:config'">配置</a-button>
<a-button v-has="'smart-video:target-intelligent:export'">导出</a-button>
```

### 2. Canvas绘图优化
- 使用requestAnimationFrame优化动画
- 避免频繁重绘，使用防抖处理
- 合理管理Canvas上下文状态

### 3. 实时数据更新
- 使用WebSocket接收实时检测结果
- 轮询方式获取统计数据（建议30秒）
- 避免内存泄漏，组件销毁时清理定时器

### 4. 性能优化
- 检测结果列表使用虚拟滚动
- 图片懒加载
- 合理使用缓存策略

### 5. 错误处理
- 设备离线状态判断
- 绘图区域验证
- API调用失败处理

## 图标使用说明

推荐使用的Ant Design图标：
- `AimOutlined` - 目标分析
- `VideoCameraOutlined` - 摄像头/设备
- `UserOutlined` - 人员
- `CarOutlined` - 车辆
- `SmileOutlined` - 人脸
- `SearchOutlined` - 搜索/检测
- `BorderOutlined` - 区域
- `LineOutlined` - 线条
- `SaveOutlined` - 保存
- `DeleteOutlined` - 删除
- `UndoOutlined` - 撤销
- `ClearOutlined` - 清除
- `SettingOutlined` - 配置
- `DownloadOutlined` - 导出

## 接口数据格式

### 检测结果数据格式
```typescript
interface DetectionResult {
  id: string;
  type: 'person' | 'vehicle' | 'face';
  typeName: string;
  confidence: number;
  captureTime: string;
  imageUrl: string;
  deviceId: string;
  attributes: PersonAttributes | VehicleAttributes | FaceAttributes;
}

interface PersonAttributes {
  gender: string;
  age: number;
  clothes: {
    upper: string;
    lower: string;
  };
}

interface VehicleAttributes {
  vehicleType: string;
  color: string;
  plateNumber?: string;
}
```

### 区域配置数据格式
```typescript
interface AreaConfig {
  mode: 'rect-detect' | 'rect-exclude' | 'line';
  points: Array<{ x: number; y: number }>;
  color: string;
  label: string;
}
```

---

**文档版本**: v1.0
**最后更新**: 2025-11-05
**适用框架**: SmartAdmin Vue3
