# æ¶ˆè´¹æ¨¡å—æ•°æ®ä¸€è‡´æ€§ä¿éšœç›‘æ§æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»æ¶ˆè´¹æ¨¡å—æ•°æ®ä¸€è‡´æ€§ä¿éšœæœºåˆ¶çš„ç›‘æ§ã€éªŒè¯å’Œè¿ç»´æŒ‡å—ï¼Œç¡®ä¿åˆ†å¸ƒå¼é”ã€ç‰ˆæœ¬æ§åˆ¶ã€å¯¹è´¦æœºåˆ¶ç­‰æ ¸å¿ƒåŠŸèƒ½ç¨³å®šå¯é è¿è¡Œã€‚

## ğŸ¯ æ ¸å¿ƒä¿éšœæœºåˆ¶

### 1. åˆ†å¸ƒå¼é”æœºåˆ¶ (Distributed Lock)

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… åŸºäº Redis çš„åˆ†å¸ƒå¼é”å®ç°
- âœ… é”è¶…æ—¶è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼ˆé»˜è®¤30ç§’ï¼‰
- âœ… é”é‡è¯•æœºåˆ¶ï¼ˆé»˜è®¤æœ€å¤š3æ¬¡ï¼‰
- âœ… åŸå­æ€§é”é‡Šæ”¾ï¼ˆä½¿ç”¨Luaè„šæœ¬ï¼‰
- âœ… é”ç«äº‰æ£€æµ‹å’Œç›‘æ§

**é”å±‚çº§è®¾è®¡**:
```
consume:lock:account:{accountId}     - è´¦æˆ·çº§åˆ«é”
reconciliation:account:{date}       - å¯¹è´¦çº§åˆ«é”
fix:account:{accountId}             - ä¿®å¤çº§åˆ«é”
```

**æ€§èƒ½æŒ‡æ ‡**:
- é”è·å–æˆåŠŸç‡: > 99.9%
- é”è·å–å¹³å‡æ—¶é—´: < 50ms
- é”ç«äº‰ç‡: < 0.1%

### 2. æ•°æ®ç‰ˆæœ¬æ§åˆ¶ (Version Control)

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… Redis å­˜å‚¨çš„åŸå­æ€§ç‰ˆæœ¬å·
- âœ… ä¹è§‚é”å†²çªæ£€æµ‹
- âœ… ç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢
- âœ… åŸå­æ€§æ£€æŸ¥å¹¶è®¾ç½®æ“ä½œ

**ç‰ˆæœ¬ç®¡ç†ç­–ç•¥**:
```java
// ç‰ˆæœ¬å·ç”Ÿæˆ
String versionKey = VERSION_PREFIX + dataKey;
Long version = redisTemplate.opsForValue().increment(versionKey);

// ç‰ˆæœ¬éªŒè¯
public boolean validateDataVersion(String dataKey, long expectedVersion)

// åŸå­æ€§æ›´æ–°
public boolean checkAndSetVersion(String dataKey, long expectedVersion, long newVersion)
```

**ç›‘æ§æŒ‡æ ‡**:
- ç‰ˆæœ¬å†²çªç‡: < 0.01%
- ç‰ˆæœ¬æ›´æ–°æˆåŠŸç‡: > 99.9%
- ç‰ˆæœ¬å·å­˜å‚¨å®¹é‡: è‡ªåŠ¨7å¤©è¿‡æœŸ

### 3. äº‹åŠ¡æ€§æ“ä½œ (Transactional Operations)

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… åˆ†å¸ƒå¼é” + ç‰ˆæœ¬æ§åˆ¶çš„ç»„åˆä¿éšœ
- âœ… è‡ªåŠ¨äº‹åŠ¡ç®¡ç†
- âœ… å¼‚å¸¸è‡ªåŠ¨å›æ»š
- âœ… åŸå­æ€§ä¸šåŠ¡æ“ä½œ

**æ ¸å¿ƒå®ç°**:
```java
public <T> T executeTransactional(String lockKey, String dataKey, TransactionalOperation<T> operation) {
    return executeWithLock(lockKey, () -> {
        return executeWithVersionControl(dataKey, operation);
    });
}
```

**é›†æˆåº”ç”¨**:
- æ¶ˆè´¹æ‰£æ¬¾æ“ä½œ: `ConsumeEngineServiceImpl.executeConsumeTransactionWithConsistency()`
- è´¦æˆ·ä½™é¢æ›´æ–°: `AccountService.deductBalanceWithVersion()`
- æ¶ˆè´¹è®°å½•åˆ›å»º: å¸¦ç‰ˆæœ¬ä¿¡æ¯çš„è®°å½•ç®¡ç†

### 4. å¯¹è´¦æœºåˆ¶ (Reconciliation)

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… ä¸‰çº§å¯¹è´¦ä½“ç³»ï¼ˆè´¦æˆ·ä½™é¢ã€æ¶ˆè´¹è®°å½•ã€äº¤æ˜“æµæ°´ï¼‰
- âœ… å¹¶è¡ŒåŒ–å¯¹è´¦å¤„ç†ï¼ˆCompletableFutureï¼‰
- âœ… è‡ªåŠ¨å·®å¼‚æ£€æµ‹å’Œä¿®å¤å»ºè®®
- âœ… å®Œæ•´çš„å¯¹è´¦æŠ¥å‘Šç”Ÿæˆ

**å¯¹è´¦æµç¨‹**:
```
1. è´¦æˆ·ä½™é¢å¯¹è´¦ â†’ ç³»ç»Ÿä½™é¢ vs è®¡ç®—ä½™é¢
2. æ¶ˆè´¹è®°å½•å¯¹è´¦ â†’ è®°å½•å®Œæ•´æ€§ + ä¸šåŠ¡é€»è¾‘éªŒè¯
3. äº¤æ˜“æµæ°´å¯¹è´¦ â†’ ç¬¬ä¸‰æ–¹äº¤æ˜“ + æ”¯ä»˜æ–¹å¼éªŒè¯
4. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š â†’ å·®å¼‚ç»Ÿè®¡ + ä¿®å¤å»ºè®®
```

## ğŸ” ç›‘æ§å’ŒéªŒè¯

### 1. å®æ—¶éªŒè¯æ¥å£

**å®Œæ•´éªŒè¯**:
```
POST /api/consume/consistency/validate/all
```
- éªŒè¯æ‰€æœ‰ä¸€è‡´æ€§ä¿éšœæœºåˆ¶
- è¿”å›ç³»ç»Ÿå¥åº·çŠ¶æ€å’Œè¯¦ç»†æŒ‡æ ‡
- å»ºè®®æ¯æ—¥æ‰§è¡Œä¸€æ¬¡å®Œæ•´éªŒè¯

**å•é¡¹éªŒè¯**:
```
POST /api/consume/consistency/validate/lock      # åˆ†å¸ƒå¼é”éªŒè¯
POST /api/consume/consistency/validate/version   # ç‰ˆæœ¬æ§åˆ¶éªŒè¯
POST /api/consume/consistency/validate/transaction # äº‹åŠ¡æ“ä½œéªŒè¯
POST /api/consume/consistency/validate/concurrent  # å¹¶å‘å®‰å…¨éªŒè¯
```

### 2. ç³»ç»ŸçŠ¶æ€ç›‘æ§

**å¥åº·æ£€æŸ¥**:
```
GET /api/consume/consistency/status
```
è¿”å›ç³»ç»Ÿä¸€è‡´æ€§å¥åº·çŠ¶æ€:
```json
{
  "healthy": true,
  "redisHealthy": true,
  "activeLocks": 15,
  "versionEntries": 1205,
  "errorMessage": null,
  "checkTime": 1700000000000
}
```

**ç›‘æ§æŒ‡æ ‡**:
```
GET /api/consume/consistency/metrics
```
æä¾›è¯¦ç»†çš„ç›‘æ§æŒ‡æ ‡:
- æ´»è·ƒé”æ•°é‡
- ç‰ˆæœ¬å·æ¡ç›®æ•°
- Redis è¿æ¥çŠ¶æ€
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡

### 3. å¯¹è´¦ç®¡ç†

**æ—¥ç»ˆå¯¹è´¦**:
```
POST /api/consume/consistency/reconciliation/daily?date=2025-11-16
```
- æ‰§è¡ŒæŒ‡å®šæ—¥æœŸçš„æ—¥ç»ˆå¯¹è´¦
- å¹¶è¡Œå¤„ç†æ‰€æœ‰è´¦æˆ·
- è‡ªåŠ¨ç”Ÿæˆå·®å¼‚æŠ¥å‘Š

**æ‰¹é‡ä¿®å¤**:
```
POST /api/consume/consistency/reconciliation/fix
```
- æ‰¹é‡ä¿®å¤å¯¹è´¦å‘ç°çš„æ•°æ®å·®å¼‚
- éœ€è¦é¢å¤–çš„æƒé™éªŒè¯
- è®°å½•è¯¦ç»†çš„ä¿®å¤å®¡è®¡æ—¥å¿—

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡å’ŒSLA

### 1. å¯ç”¨æ€§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | ç›‘æ§æ–¹æ³• |
|------|--------|--------|----------|
| ç³»ç»Ÿå¯ç”¨æ€§ | 99.9% | [å®é™…å€¼] | å¥åº·æ£€æŸ¥æ¥å£ |
| Redis å¯ç”¨æ€§ | 99.95% | [å®é™…å€¼] | è¿æ¥çŠ¶æ€ç›‘æ§ |
| é”è·å–æˆåŠŸç‡ | 99.9% | [å®é™…å€¼] | é”è·å–ç»Ÿè®¡ |

### 2. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | ç›‘æ§æ–¹æ³• |
|------|--------|--------|----------|
| é”è·å–æ—¶é—´ | < 50ms | [å®é™…å€¼] | æ€§èƒ½ç›‘æ§ |
| ç‰ˆæœ¬æ£€æŸ¥æ—¶é—´ | < 10ms | [å®é™…å€¼] | æ“ä½œè®¡æ—¶ |
| å¯¹è´¦å¤„ç†æ—¶é—´ | < 30åˆ†é’Ÿ | [å®é™…å€¼] | ä»»åŠ¡è®¡æ—¶ |
| å¹¶å‘å¤„ç†èƒ½åŠ› | 3å€æå‡ | [å®é™…å€¼] | å‹åŠ›æµ‹è¯• |

### 3. æ•°æ®ä¸€è‡´æ€§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…å€¼ | ç›‘æ§æ–¹æ³• |
|------|--------|--------|----------|
| æ•°æ®ä¸€è‡´ç‡ | 99.9% | [å®é™…å€¼] | å¯¹è´¦éªŒè¯ |
| ç‰ˆæœ¬å†²çªç‡ | < 0.01% | [å®é™…å€¼] | å†²çªç»Ÿè®¡ |
| å·®å¼‚ä¿®å¤ç‡ | > 95% | [å®é™…å€¼] | ä¿®å¤ç»Ÿè®¡ |

## ğŸš¨ å‘Šè­¦è§„åˆ™

### 1. é”ç«äº‰å‘Šè­¦

```
è§„åˆ™: å•ä¸ªé”ç­‰å¾…æ—¶é—´ > 5ç§’
çº§åˆ«: WARNING
å¤„ç†: æ£€æŸ¥ä¸šåŠ¡é€»è¾‘ï¼Œä¼˜åŒ–é”ç²’åº¦

è§„åˆ™: æ´»è·ƒé”æ•°é‡ > 1000
çº§åˆ«: CRITICAL
å¤„ç†: ç«‹å³æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼Œå¯èƒ½çš„æ­»é”é—®é¢˜
```

### 2. å¯¹è´¦å¼‚å¸¸å‘Šè­¦

```
è§„åˆ™: å¯¹è´¦å¤±è´¥ç‡ > 1%
çº§åˆ«: WARNING
å¤„ç†: æ£€æŸ¥æ•°æ®æºï¼Œä¿®å¤æ•°æ®è´¨é‡é—®é¢˜

è§„åˆ™: å·®å¼‚æ•°é‡ > 10ä¸ª
çº§åˆ«: CRITICAL
å¤„ç†: ç«‹å³å¯åŠ¨æ•°æ®ä¿®å¤æµç¨‹
```

### 3. ç³»ç»Ÿå¥åº·å‘Šè­¦

```
è§„åˆ™: Redis è¿æ¥å¼‚å¸¸
çº§åˆ«: CRITICAL
å¤„ç†: ç«‹å³æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€

è§„åˆ™: ç‰ˆæœ¬å†²çªç‡ > 0.1%
çº§åˆ«: WARNING
å¤„ç†: æ£€æŸ¥å¹¶å‘æ“ä½œé€»è¾‘
```

## ğŸ› ï¸ è¿ç»´æ“ä½œ

### 1. æ—¥å¸¸è¿ç»´

**æ¯æ—¥æ‰§è¡Œ**:
```bash
# 1. æ‰§è¡Œå®Œæ•´éªŒè¯
curl -X POST "http://localhost:1024/api/consume/consistency/validate/all"

# 2. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
curl -X GET "http://localhost:1024/api/consume/consistency/status"

# 3. æ‰§è¡Œæ—¥ç»ˆå¯¹è´¦
curl -X POST "http://localhost:1024/api/consume/consistency/reconciliation/daily"
```

**æ¯å‘¨æ‰§è¡Œ**:
```bash
# æ¸…ç†è¿‡æœŸæ•°æ®
curl -X POST "http://localhost:1024/api/consume/consistency/cleanup"

# æ€§èƒ½æŒ‡æ ‡åˆ†æ
curl -X GET "http://localhost:1024/api/consume/consistency/metrics"
```

### 2. æ•…éšœå¤„ç†

**Redis è¿æ¥å¼‚å¸¸**:
1. æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€
2. éªŒè¯ç½‘ç»œè¿æ¥
3. æ£€æŸ¥ Redis é…ç½®
4. é‡å¯ç›¸å…³æœåŠ¡

**é”è¶…æ—¶é—®é¢˜**:
1. æ£€æŸ¥ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦
2. è°ƒæ•´é”è¶…æ—¶æ—¶é—´
3. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
4. è€ƒè™‘é”çš„ç²’åº¦

**å¯¹è´¦å¤±è´¥å¤„ç†**:
1. æ£€æŸ¥æ•°æ®æºå®Œæ•´æ€§
2. éªŒè¯å¯¹è´¦é€»è¾‘
3. ä¿®å¤å·®å¼‚æ•°æ®
4. é‡æ–°æ‰§è¡Œå¯¹è´¦

### 3. æ€§èƒ½ä¼˜åŒ–

**é”ä¼˜åŒ–ç­–ç•¥**:
- å‡å°‘é”æŒæœ‰æ—¶é—´
- ä¼˜åŒ–é”çš„ç²’åº¦
- ä½¿ç”¨è¯»å†™é”ï¼ˆå¦‚é€‚ç”¨ï¼‰
- å®ç°é”é™çº§æœºåˆ¶

**ç¼“å­˜ä¼˜åŒ–ç­–ç•¥**:
- å¢åŠ æœ¬åœ°ç¼“å­˜å±‚
- ä¼˜åŒ–ç¼“å­˜å¤±æ•ˆç­–ç•¥
- å®ç°ç¼“å­˜é¢„çƒ­
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

**å¯¹è´¦ä¼˜åŒ–ç­–ç•¥**:
- å¢åŠ å¹¶è¡Œå¤„ç†çº¿ç¨‹
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- å®ç°å¢é‡å¯¹è´¦
- æ™ºèƒ½å·®å¼‚æ£€æµ‹

## ğŸ“ˆ æœ€ä½³å®è·µ

### 1. å¼€å‘è§„èŒƒ

**åˆ†å¸ƒå¼é”ä½¿ç”¨**:
```java
// âœ… æ­£ç¡®ä½¿ç”¨
String lockValue = consistencyManager.acquireLock(lockKey, timeout);
if (lockValue != null) {
    try {
        // ä¸šåŠ¡é€»è¾‘
        return result;
    } finally {
        consistencyManager.releaseLock(lockKey, lockValue);
    }
}

// âŒ é”™è¯¯ä½¿ç”¨ - å¿˜è®°é‡Šæ”¾é”
String lockValue = consistencyManager.acquireLock(lockKey, timeout);
// ä¸šåŠ¡é€»è¾‘ï¼Œå¿˜è®°é‡Šæ”¾é”
```

**ç‰ˆæœ¬æ§åˆ¶ä½¿ç”¨**:
```java
// âœ… æ­£ç¡®ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶
consistencyManager.executeTransactional(lockKey, dataKey, (currentVersion) -> {
    // åŸºäºå½“å‰ç‰ˆæœ¬æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return businessOperation(currentVersion);
});

// âŒ é”™è¯¯ä½¿ç”¨ - ä¸æ£€æŸ¥ç‰ˆæœ¬å†²çª
// ç›´æ¥æ“ä½œæ•°æ®ï¼Œå¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜
```

### 2. ç›‘æ§å»ºè®®

**å®æ—¶ç›‘æ§**:
- è®¾ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦
- å®ç°å¥åº·æ£€æŸ¥æ¥å£
- ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
- è·Ÿè¸ªä¸šåŠ¡æ“ä½œè€—æ—¶

**å®šæœŸæ£€æŸ¥**:
- æ¯æ—¥æ‰§è¡Œå®Œæ•´éªŒè¯
- æ¯å‘¨åˆ†ææ€§èƒ½è¶‹åŠ¿
- æ¯æœˆè¯„ä¼°ç³»ç»Ÿå®¹é‡
- å­£åº¦è¿›è¡Œå‹åŠ›æµ‹è¯•

### 3. åº”æ€¥é¢„æ¡ˆ

**æ•°æ®ä¸ä¸€è‡´å¤„ç†**:
1. ç«‹å³åœæ­¢ç›¸å…³ä¸šåŠ¡
2. æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
3. è¯†åˆ«å·®å¼‚èŒƒå›´
4. æ‰§è¡Œæ•°æ®ä¿®å¤
5. éªŒè¯ä¿®å¤ç»“æœ
6. æ¢å¤ä¸šåŠ¡è¿è¡Œ

**ç³»ç»Ÿä¸å¯ç”¨å¤„ç†**:
1. å¯ç”¨é™çº§æ–¹æ¡ˆ
2. åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡
3. é€šçŸ¥ç›¸å…³äººå‘˜
4. è¯Šæ–­é—®é¢˜åŸå› 
5. å®æ–½ä¿®å¤æªæ–½
6. æ¢å¤æ­£å¸¸æœåŠ¡

## ğŸ”§ API æ¥å£æ€»è§ˆ

### éªŒè¯æ¥å£
- `POST /api/consume/consistency/validate/all` - å®Œæ•´éªŒè¯
- `POST /api/consume/consistency/validate/lock` - é”éªŒè¯
- `POST /api/consume/consistency/validate/version` - ç‰ˆæœ¬éªŒè¯
- `POST /api/consume/consistency/validate/transaction` - äº‹åŠ¡éªŒè¯
- `POST /api/consume/consistency/validate/concurrent` - å¹¶å‘éªŒè¯

### ç›‘æ§æ¥å£
- `GET /api/consume/consistency/status` - ç³»ç»ŸçŠ¶æ€
- `GET /api/consume/consistency/metrics` - ç›‘æ§æŒ‡æ ‡
- `POST /api/consume/consistency/cleanup` - æ•°æ®æ¸…ç†

### å¯¹è´¦æ¥å£
- `POST /api/consume/consistency/reconciliation/daily` - æ—¥ç»ˆå¯¹è´¦
- `POST /api/consume/consistency/reconciliation/fix` - æ‰¹é‡ä¿®å¤

## ğŸ“ æ”¯æŒå’Œè”ç³»

- **æŠ€æœ¯æ”¯æŒ**: consistency-support@example.com
- **ç´§æ€¥å“åº”**: +86-xxx-xxxx-xxxx
- **æ–‡æ¡£æ›´æ–°**: è”ç³»å¼€å‘å›¢é˜Ÿ
- **é—®é¢˜åé¦ˆ**: é¡¹ç›® Issue ç³»ç»Ÿ

---

**ç‰ˆæœ¬**: v1.0.0
**æ›´æ–°æ—¶é—´**: 2025-11-17
**ç»´æŠ¤å›¢é˜Ÿ**: SmartAdmin å¼€å‘å›¢é˜Ÿ