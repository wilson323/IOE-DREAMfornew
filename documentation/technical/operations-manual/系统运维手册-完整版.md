# IOE-DREAM å¾®æœåŠ¡ç³»ç»Ÿè¿ç»´æ‰‹å†Œ

## ğŸ“– ç›®å½•

- [ç³»ç»Ÿæ¶æ„æ¦‚è¿°](#ç³»ç»Ÿæ¶æ„æ¦‚è¿°)
- [ç¯å¢ƒéƒ¨ç½²æŒ‡å—](#ç¯å¢ƒéƒ¨ç½²æŒ‡å—)
- [ç›‘æ§ç³»ç»Ÿé…ç½®](#ç›‘æ§ç³»ç»Ÿé…ç½®)
- [æ—¥å¸¸è¿ç»´æ“ä½œ](#æ—¥å¸¸è¿ç»´æ“ä½œ)
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](#æ€§èƒ½ä¼˜åŒ–æŒ‡å—)
- [å¤‡ä»½ä¸æ¢å¤](#å¤‡ä»½ä¸æ¢å¤)
- [æ•…éšœè¯Šæ–­ä¸å¤„ç†](#æ•…éšœè¯Šæ–­ä¸å¤„ç†)
- [å®‰å…¨ç®¡ç†](#å®‰å…¨ç®¡ç†)
- [ç‰ˆæœ¬å‡çº§ç®¡ç†](#ç‰ˆæœ¬å‡çº§ç®¡ç†)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### å¾®æœåŠ¡æ¶æ„è®¾è®¡

IOE-DREAMé‡‡ç”¨ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„ï¼ŒåŸºäºSpring Boot 3.x + Spring CloudæŠ€æœ¯æ ˆï¼Œå®ç°é«˜å¯ç”¨ã€å¯æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

#### æ ¸å¿ƒæœåŠ¡ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway (æ™ºèƒ½ç½‘å…³)                    â”‚
â”‚                     Port: 8080/8443                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        è®¤è¯æœåŠ¡        â”‚      èº«ä»½ç®¡ç†æœåŠ¡      â”‚  è®¾å¤‡ç®¡ç†æœåŠ¡ â”‚
â”‚   Auth Service      â”‚   Identity Service  â”‚ Device Serviceâ”‚
â”‚     Port: 8101      â”‚      Port: 8102     â”‚   Port: 8103  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        åŒºåŸŸç®¡ç†æœåŠ¡      â”‚     è®¿å®¢ç®¡ç†æœåŠ¡     â”‚  è®¿é—®æ§åˆ¶æœåŠ¡  â”‚
â”‚     Area Service     â”‚   Visitor Service   â”‚ Access Serviceâ”‚
â”‚     Port: 8104      â”‚      Port: 8105     â”‚   Port: 8106  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æ¶ˆè´¹æœåŠ¡        â”‚      è€ƒå‹¤æœåŠ¡        â”‚   è§†é¢‘æœåŠ¡    â”‚
â”‚   Consume Service   â”‚  Attendance Service â”‚ Video Service â”‚
â”‚     Port: 8107      â”‚      Port: 8108     â”‚   Port: 8109  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        OAæœåŠ¡         â”‚      é€šçŸ¥æœåŠ¡        â”‚   æ–‡ä»¶æœåŠ¡    â”‚
â”‚      OA Service     â”‚ Notification Serviceâ”‚ File Service  â”‚
â”‚     Port: 8110      â”‚      Port: 8111     â”‚   Port: 8112  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æŠ¥è¡¨æœåŠ¡        â”‚      å®¡è®¡æœåŠ¡        â”‚   é…ç½®æœåŠ¡    â”‚
â”‚    Report Service   â”‚    Audit Service    â”‚ Config Serviceâ”‚
â”‚     Port: 8113      â”‚      Port: 8114     â”‚   Port: 8115  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åŸºç¡€è®¾æ–½ç»„ä»¶

**æœåŠ¡æ³¨å†Œä¸å‘ç°**
- **Eureka Server**: æœåŠ¡æ³¨å†Œä¸­å¿ƒ
- **ç«¯å£**: 8761
- **é›†ç¾¤éƒ¨ç½²**: 3èŠ‚ç‚¹é«˜å¯ç”¨

**é…ç½®ä¸­å¿ƒ**
- **Spring Cloud Config**: ç»Ÿä¸€é…ç½®ç®¡ç†
- **ç«¯å£**: 8888
- **é…ç½®ä»“åº“**: Gitå­˜å‚¨

**æ¶ˆæ¯é˜Ÿåˆ—**
- **RabbitMQ**: å¼‚æ­¥æ¶ˆæ¯å¤„ç†
- **ç«¯å£**: 5672 (AMQP), 15672 (ç®¡ç†ç•Œé¢)
- **é›†ç¾¤æ¨¡å¼**: é•œåƒé˜Ÿåˆ—

**ç¼“å­˜æœåŠ¡**
- **Redis**: åˆ†å¸ƒå¼ç¼“å­˜
- **ç«¯å£**: 6379
- **é›†ç¾¤æ¨¡å¼**: Redis Cluster

**æ•°æ®åº“**
- **MySQL**: ä¸»æ•°æ®åº“
- **ç«¯å£**: 3306
- **æ¶æ„**: ä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»

### ç½‘ç»œæ¶æ„

#### ç½‘ç»œæ‹“æ‰‘

```mermaid
graph TB
    Internet[Internet] --> LB[è´Ÿè½½å‡è¡¡å™¨]
    LB --> Gateway1[API Gateway 1]
    LB --> Gateway2[API Gateway 2]

    Gateway1 --> Service1[è®¤è¯æœåŠ¡é›†ç¾¤]
    Gateway1 --> Service2[ä¸šåŠ¡æœåŠ¡é›†ç¾¤]

    Gateway2 --> Service3[è®¤è¯æœåŠ¡é›†ç¾¤]
    Gateway2 --> Service4[ä¸šåŠ¡æœåŠ¡é›†ç¾¤]

    Service1 --> Redis[Redisé›†ç¾¤]
    Service2 --> Redis
    Service3 --> Redis
    Service4 --> Redis

    Service1 --> MySQL[MySQLé›†ç¾¤]
    Service2 --> MySQL
    Service3 --> MySQL
    Service4 --> MySQL

    Service1 --> MQ[RabbitMQé›†ç¾¤]
    Service2 --> MQ
```

#### ç«¯å£åˆ†é…

| æœåŠ¡ç±»å‹ | ç«¯å£èŒƒå›´ | è¯´æ˜ |
|---------|---------|------|
| API Gateway | 8080, 8443 | HTTP/HTTPSå…¥å£ |
| æ ¸å¿ƒæœåŠ¡ | 8101-8115 | ä¸šåŠ¡å¾®æœåŠ¡ |
| åŸºç¡€æœåŠ¡ | 8761, 8888 | æ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒ |
| ä¸­é—´ä»¶ | 5672, 6379, 3306 | æ¶ˆæ¯é˜Ÿåˆ—ã€ç¼“å­˜ã€æ•°æ®åº“ |
| ç›‘æ§ | 9090-9095 | ç›‘æ§å’Œç®¡ç†æœåŠ¡ |

---

## ğŸš€ ç¯å¢ƒéƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚

#### ç¡¬ä»¶è¦æ±‚

**ç”Ÿäº§ç¯å¢ƒ**
- **CPU**: 16æ ¸å¿ƒä»¥ä¸Šï¼Œæ”¯æŒè™šæ‹ŸåŒ–
- **å†…å­˜**: 64GBä»¥ä¸Š
- **å­˜å‚¨**: 1TB SSD + 2TB HDD
- **ç½‘ç»œ**: åƒå…†ç½‘ç»œï¼ŒåŒç½‘å¡

**æµ‹è¯•ç¯å¢ƒ**
- **CPU**: 8æ ¸å¿ƒ
- **å†…å­˜**: 32GB
- **å­˜å‚¨**: 500GB SSD
- **ç½‘ç»œ**: åƒå…†ç½‘ç»œ

**å¼€å‘ç¯å¢ƒ**
- **CPU**: 4æ ¸å¿ƒ
- **å†…å­˜**: 16GB
- **å­˜å‚¨**: 256GB SSD
- **ç½‘ç»œ**: ç™¾å…†ç½‘ç»œ

#### è½¯ä»¶è¦æ±‚

**æ“ä½œç³»ç»Ÿ**
- **æ¨è**: CentOS 8.x / Ubuntu 20.04 LTS
- **æœ€ä½**: CentOS 7.x / Ubuntu 18.04 LTS

**Javaç¯å¢ƒ**
- **JDK**: OpenJDK 17+ æˆ– Oracle JDK 17+
- **Maven**: 3.8+
- **Git**: 2.25+

**å®¹å™¨ç¯å¢ƒ**
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **Kubernetes**: 1.22+ (å¯é€‰)

### éƒ¨ç½²æ¶æ„

#### å•æœºéƒ¨ç½²ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰

```
æœåŠ¡å™¨: 192.168.1.100
â”œâ”€â”€ Nginx (ç«¯å£ 80/443)
â”œâ”€â”€ API Gateway (ç«¯å£ 8080)
â”œâ”€â”€ æ‰€æœ‰å¾®æœåŠ¡ (ç«¯å£ 8101-8115)
â”œâ”€â”€ MySQL (ç«¯å£ 3306)
â”œâ”€â”€ Redis (ç«¯å£ 6379)
â”œâ”€â”€ RabbitMQ (ç«¯å£ 5672/15672)
â””â”€â”€ ç›‘æ§ç»„ä»¶ (ç«¯å£ 9090-9095)
```

#### é›†ç¾¤éƒ¨ç½²ï¼ˆç”Ÿäº§ï¼‰

```
è´Ÿè½½å‡è¡¡å±‚:
â”œâ”€â”€ Nginx LB1 (192.168.1.10)
â””â”€â”€ Nginx LB2 (192.168.1.11)

APIç½‘å…³å±‚:
â”œâ”€â”€ Gateway Node1 (192.168.1.20)
â”œâ”€â”€ Gateway Node2 (192.168.1.21)
â””â”€â”€ Gateway Node3 (192.168.1.22)

ä¸šåŠ¡æœåŠ¡å±‚:
â”œâ”€â”€ Service Node1 (192.168.1.30)
â”œâ”€â”€ Service Node2 (192.168.1.31)
â”œâ”€â”€ Service Node3 (192.168.1.32)
â””â”€â”€ Service Node4 (192.168.1.33)

æ•°æ®å±‚:
â”œâ”€â”€ MySQL Master (192.168.1.40)
â”œâ”€â”€ MySQL Slave1 (192.168.1.41)
â”œâ”€â”€ MySQL Slave2 (192.168.1.42)
â”œâ”€â”€ Redis Cluster (192.168.1.50-52)
â””â”€â”€ RabbitMQ Cluster (192.168.1.60-62)
```

### å®‰è£…éƒ¨ç½²æ­¥éª¤

#### 1. åŸºç¡€ç¯å¢ƒå‡†å¤‡

**ç³»ç»Ÿé…ç½®**
```bash
# å…³é—­é˜²ç«å¢™å’ŒSELinux
systemctl stop firewalld
systemctl disable firewalld
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

# é…ç½®hostsæ–‡ä»¶
cat >> /etc/hosts << EOF
192.168.1.100 ioedream-gateway
192.168.1.101 ioedream-mysql
192.168.1.102 ioedream-redis
192.168.1.103 ioedream-rabbitmq
EOF

# åˆ›å»ºç³»ç»Ÿç”¨æˆ·
useradd -m -s /bin/bash ioedream
usermod -aG wheel ioedream
```

**Javaç¯å¢ƒå®‰è£…**
```bash
# å®‰è£…OpenJDK 17
yum install -y java-17-openjdk java-17-openjdk-devel

# é…ç½®ç¯å¢ƒå˜é‡
cat > /etc/profile.d/java17.sh << EOF
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk
export PATH=\$JAVA_HOME/bin:\$PATH
export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
EOF

source /etc/profile.d/java17.sh
java -version
```

#### 2. æ•°æ®åº“å®‰è£…é…ç½®

**MySQLå®‰è£…**
```bash
# å®‰è£…MySQL 8.0
yum install -y mysql-server

# å¯åŠ¨MySQLæœåŠ¡
systemctl start mysqld
systemctl enable mysqld

# è·å–ä¸´æ—¶å¯†ç 
TEMP_PASSWORD=$(grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}')

# å®‰å…¨é…ç½®
mysql_secure_installation

# åˆ›å»ºåº”ç”¨æ•°æ®åº“
mysql -u root -p << EOF
CREATE DATABASE ioedream_auth CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_identity CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_device CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_access CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_consume CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_attendance CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_video CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE ioedream_oa CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE USER 'ioedream'@'%' IDENTIFIED BY 'Ioedream@2025';
GRANT ALL PRIVILEGES ON ioedream_*.* TO 'ioedream'@'%';
FLUSH PRIVILEGES;
EOF
```

**Rediså®‰è£…**
```bash
# å®‰è£…Redis
yum install -y redis

# é…ç½®Redis
cp /etc/redis.conf /etc/redis.conf.bak
cat > /etc/redis.conf << EOF
bind 0.0.0.0
port 6379
daemonize yes
pidfile /var/run/redis/redis.pid
logfile /var/log/redis/redis.log
databases 16
save 900 1
save 300 10
save 60 10000
maxmemory 2gb
maxmemory-policy allkeys-lru
EOF

# å¯åŠ¨Redis
systemctl start redis
systemctl enable redis
```

#### 3. æ¶ˆæ¯é˜Ÿåˆ—å®‰è£…

**RabbitMQå®‰è£…**
```bash
# å®‰è£…Erlang
yum install -y erlang

# å®‰è£…RabbitMQ
yum install -y rabbitmq-server

# å¯åŠ¨RabbitMQ
systemctl start rabbitmq-server
systemctl enable rabbitmq-server

# å¯ç”¨ç®¡ç†æ’ä»¶
rabbitmq-plugins enable rabbitmq_management

# åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
rabbitmqctl add_user admin Admin123!
rabbitmqctl set_user_tags admin administrator
rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```

#### 4. åº”ç”¨æœåŠ¡éƒ¨ç½²

**æ„å»ºåº”ç”¨**
```bash
# å…‹éš†ä»£ç 
git clone https://github.com/company/ioedream-microservices.git
cd ioedream-microservices

# æ„å»ºæ‰€æœ‰æœåŠ¡
mvn clean package -DskipTests

# åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p /opt/ioedream/services
mkdir -p /opt/ioedream/logs
mkdir -p /opt/ioedream/config
```

**éƒ¨ç½²API Gateway**
```bash
# å¤åˆ¶åº”ç”¨æ–‡ä»¶
cp smart-gateway/target/smart-gateway-*.jar /opt/ioedream/services/gateway.jar

# åˆ›å»ºå¯åŠ¨è„šæœ¬
cat > /opt/ioedream/start-gateway.sh << 'EOF'
#!/bin/bash
cd /opt/ioedream
nohup java -jar services/gateway.jar \
  --spring.profiles.active=prod \
  --server.port=8080 \
  > logs/gateway.log 2>&1 &
echo $! > /var/run/gateway.pid
EOF

chmod +x /opt/ioedream/start-gateway.sh

# åˆ›å»ºsystemdæœåŠ¡
cat > /etc/systemd/system/ioedream-gateway.service << EOF
[Unit]
Description=IOE-DREAM API Gateway
After=network.target

[Service]
Type=forking
User=ioedream
WorkingDirectory=/opt/ioedream
ExecStart=/opt/ioedream/start-gateway.sh
ExecStop=/bin/kill -9 $MAINPID
PIDFile=/var/run/gateway.pid
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ioedream-gateway
systemctl start ioedream-gateway
```

**éƒ¨ç½²ä¸šåŠ¡æœåŠ¡**
```bash
# æ‰¹é‡éƒ¨ç½²è„šæœ¬
cat > /opt/ioedream/deploy-services.sh << 'EOF'
#!/bin/bash

SERVICES=(
  "ioedream-auth-service:8101"
  "ioedream-identity-service:8102"
  "ioedream-device-service:8103"
  "ioedream-access-service:8106"
  "ioedream-consume-service:8107"
  "ioedream-attendance-service:8108"
  "ioedream-video-service:8109"
  "ioedream-oa-service:8110"
)

for service in "${SERVICES[@]}"; do
  name=$(echo $service | cut -d: -f1)
  port=$(echo $service | cut -d: -f2)

  echo "Deploying $name on port $port..."

  # å¤åˆ¶jaræ–‡ä»¶
  cp $name/target/$name-*.jar /opt/ioedream/services/$name.jar

  # åˆ›å»ºå¯åŠ¨è„šæœ¬
  cat > /opt/ioedream/start-$name.sh << EOFS
#!/bin/bash
cd /opt/ioedream
nohup java -jar services/$name.jar \
  --spring.profiles.active=prod \
  --server.port=$port \
  > logs/$name.log 2>&1 &
echo $! > /var/run/$name.pid
EOFS

  chmod +x /opt/ioedream/start-$name.sh

  # åˆ›å»ºsystemdæœåŠ¡
  cat > /etc/systemd/system/ioedream-$name.service << EOFS
[Unit]
Description=IOE-DREAM $name
After=network.target

[Service]
Type=forking
User=ioedream
WorkingDirectory=/opt/ioedream
ExecStart=/opt/ioedream/start-$name.sh
ExecStop=/bin/kill -9 \$MAINPID
PIDFile=/var/run/$name.pid
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOFS

  systemctl daemon-reload
  systemctl enable ioedream-$name
  systemctl start ioedream-$name

  echo "$name deployed and started successfully"
done
EOF

chmod +x /opt/ioedream/deploy-services.sh
/opt/ioedream/deploy-services.sh
```

#### 5. è´Ÿè½½å‡è¡¡é…ç½®

**Nginxé…ç½®**
```bash
# å®‰è£…Nginx
yum install -y nginx

# é…ç½®è´Ÿè½½å‡è¡¡
cat > /etc/nginx/nginx.conf << 'EOF'
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Gatewayè´Ÿè½½å‡è¡¡
    upstream gateway_cluster {
        least_conn;
        server 192.168.1.20:8080 max_fails=3 fail_timeout=30s;
        server 192.168.1.21:8080 max_fails=3 fail_timeout=30s;
        server 192.168.1.22:8080 max_fails=3 fail_timeout=30s;
    }

    # ä¸»æœåŠ¡å™¨é…ç½®
    server {
        listen 80;
        server_name ioedream.company.com;

        location / {
            proxy_pass http://gateway_cluster;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
    }

    # HTTPSé…ç½®
    server {
        listen 443 ssl http2;
        server_name ioedream.company.com;

        ssl_certificate /etc/nginx/ssl/ioedream.crt;
        ssl_certificate_key /etc/nginx/ssl/ioedream.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        location / {
            proxy_pass http://gateway_cluster;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
EOF

# å¯åŠ¨Nginx
systemctl start nginx
systemctl enable nginx
```

---

## ğŸ“Š ç›‘æ§ç³»ç»Ÿé…ç½®

### ç›‘æ§æ¶æ„

IOE-DREAMé‡‡ç”¨åˆ†å±‚ç›‘æ§æ¶æ„ï¼Œå®ç°å…¨æ–¹ä½çš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦ã€‚

#### ç›‘æ§ç»„ä»¶

**Prometheus** - æŒ‡æ ‡æ”¶é›†å’Œå­˜å‚¨
- **ç«¯å£**: 9090
- **åŠŸèƒ½**: æ—¶åºæ•°æ®åº“ï¼Œæ”¶é›†åº”ç”¨å’Œç³»ç»ŸæŒ‡æ ‡

**Grafana** - å¯è§†åŒ–å±•ç¤º
- **ç«¯å£**: 3000
- **åŠŸèƒ½**: ä»ªè¡¨æ¿å±•ç¤ºï¼Œå‘Šè­¦ç®¡ç†

**AlertManager** - å‘Šè­¦ç®¡ç†
- **ç«¯å£**: 9093
- **åŠŸèƒ½**: å‘Šè­¦è·¯ç”±ï¼Œé€šçŸ¥å‘é€

**Node Exporter** - ç³»ç»ŸæŒ‡æ ‡
- **ç«¯å£**: 9100
- **åŠŸèƒ½**: æ”¶é›†æœåŠ¡å™¨ç¡¬ä»¶å’Œç³»ç»ŸæŒ‡æ ‡

### ç›‘æ§éƒ¨ç½²

#### 1. Prometheuså®‰è£…é…ç½®

```bash
# åˆ›å»ºPrometheusç”¨æˆ·
useradd --no-create-home --shell /bin/false prometheus

# ä¸‹è½½Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
tar xzf prometheus-*.tar.gz

# å®‰è£…Prometheus
cd prometheus-2.40.0.linux-amd64
mkdir -p /etc/prometheus /var/lib/prometheus

cp prometheus /usr/local/bin/
cp promtool /usr/local/bin/
cp -r consoles /etc/prometheus/
cp -r console_libraries /etc/prometheus/

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /etc/prometheus/prometheus.yml << 'EOF'
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "rules/*.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:9093

scrape_configs:
  # Prometheusè‡ªç›‘æ§
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # ç³»ç»Ÿç›‘æ§
  - job_name: 'node-exporter'
    static_configs:
      - targets:
        - '192.168.1.100:9100'
        - '192.168.1.101:9100'
        - '192.168.1.102:9100'

  # åº”ç”¨æœåŠ¡ç›‘æ§
  - job_name: 'ioedream-services'
    static_configs:
      - targets:
        - '192.168.1.100:8101'
        - '192.168.1.100:8102'
        - '192.168.1.100:8103'
        - '192.168.1.100:8106'
        - '192.168.1.100:8107'
        - '192.168.1.100:8108'

  # MySQLç›‘æ§
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['192.168.1.101:9104']

  # Redisç›‘æ§
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['192.168.1.102:9121']

  # RabbitMQç›‘æ§
  - job_name: 'rabbitmq-exporter'
    static_configs:
      - targets: ['192.168.1.103:9419']
EOF

# åˆ›å»ºsystemdæœåŠ¡
cat > /etc/systemd/system/prometheus.service << EOF
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
    --config.file /etc/prometheus/prometheus.yml \
    --storage.tsdb.path /var/lib/prometheus/ \
    --web.console.templates=/etc/prometheus/consoles \
    --web.console.libraries=/etc/prometheus/console_libraries \
    --web.listen-address=0.0.0.0:9090

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨Prometheus
chown -R prometheus:prometheus /etc/prometheus /var/lib/prometheus
systemctl daemon-reload
systemctl enable prometheus
systemctl start prometheus
```

#### 2. Grafanaå®‰è£…é…ç½®

```bash
# å®‰è£…Grafana
sudo yum install -y https://dl.grafana.com/oss/release/grafana-9.2.0-1.x86_64.rpm

# å¯åŠ¨Grafana
systemctl start grafana-server
systemctl enable grafana-server

# é…ç½®æ•°æ®æº
# è®¿é—® http://192.168.1.100:3000
# é»˜è®¤ç”¨æˆ·å/å¯†ç : admin/admin
# æ·»åŠ Prometheusæ•°æ®æº: http://localhost:9090
```

#### 3. å‘Šè­¦è§„åˆ™é…ç½®

```bash
# åˆ›å»ºå‘Šè­¦è§„åˆ™ç›®å½•
mkdir -p /etc/prometheus/rules

# æœåŠ¡å¯ç”¨æ€§å‘Šè­¦
cat > /etc/prometheus/rules/service-availability.yml << 'EOF'
groups:
- name: service-availability
  rules:
  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.job }} is down"
      description: "Service {{ $labels.job }} has been down for more than 1 minute."

  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage on {{ $labels.instance }}"
      description: "CPU usage is above 80% for more than 5 minutes."

  - alert: HighMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage on {{ $labels.instance }}"
      description: "Memory usage is above 85% for more than 5 minutes."

  - alert: DiskSpaceLow
    expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Low disk space on {{ $labels.instance }}"
      description: "Disk usage is above 90% on mount point {{ $labels.mountpoint }}."
EOF

# é‡æ–°åŠ è½½Prometheusé…ç½®
curl -X POST http://localhost:9090/-/reload
```

### ç›‘æ§æŒ‡æ ‡

#### ç³»ç»ŸæŒ‡æ ‡

**CPUä½¿ç”¨ç‡**
```promql
100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

**å†…å­˜ä½¿ç”¨ç‡**
```promql
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
```

**ç£ç›˜ä½¿ç”¨ç‡**
```promql
(1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100
```

**ç½‘ç»œæµé‡**
```promql
rate(node_network_receive_bytes_total[5m])
rate(node_network_transmit_bytes_total[5m])
```

#### åº”ç”¨æŒ‡æ ‡

**JVMå†…å­˜ä½¿ç”¨**
```promql
(jvm_memory_used_bytes / jvm_memory_max_bytes) * 100
```

**HTTPè¯·æ±‚é€Ÿç‡**
```promql
rate(http_requests_total[5m])
```

**HTTPé”™è¯¯ç‡**
```promql
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100
```

**æ•°æ®åº“è¿æ¥æ± **
```promql
hikaricp_connections_active / hikaricp_connections_max
```

---

## ğŸ”„ æ—¥å¸¸è¿ç»´æ“ä½œ

### æœåŠ¡ç®¡ç†

#### æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
#!/bin/bash
# æœåŠ¡å¥åº·æ£€æŸ¥è„šæœ¬

SERVICES=(
    "ioedream-gateway"
    "ioedream-auth-service"
    "ioedream-identity-service"
    "ioedream-device-service"
    "ioedream-access-service"
    "ioedream-consume-service"
    "ioedream-attendance-service"
    "ioedream-video-service"
    "ioedream-oa-service"
)

echo "=== IOE-DREAM Service Health Check ==="
echo "Time: $(date)"
echo ""

for service in "${SERVICES[@]}"; do
    if systemctl is-active --quiet $service; then
        status="âœ… RUNNING"
        pid=$(systemctl show $service -p MainPID --value)
        port=$(netstat -tlnp | grep $pid | awk '{print $4}' | cut -d: -f2 | head -1)
        echo "$service: $status (PID: $pid, Port: $port)"
    else
        status="âŒ STOPPED"
        echo "$service: $status"
    fi
done

echo ""
echo "=== Middleware Status ==="

# MySQLçŠ¶æ€
if systemctl is-active --quiet mysqld; then
    echo "MySQL: âœ… RUNNING"
else
    echo "MySQL: âŒ STOPPED"
fi

# RedisçŠ¶æ€
if systemctl is-active --quiet redis; then
    echo "Redis: âœ… RUNNING"
else
    echo "Redis: âŒ STOPPED"
fi

# RabbitMQçŠ¶æ€
if systemctl is-active --quiet rabbitmq-server; then
    echo "RabbitMQ: âœ… RUNNING"
else
    echo "RabbitMQ: âŒ STOPPED"
fi

echo ""
echo "=== Load Balancer Status ==="
if systemctl is-active --quiet nginx; then
    echo "Nginx: âœ… RUNNING"
else
    echo "Nginx: âŒ STOPPED"
fi
```

#### æœåŠ¡é‡å¯æ“ä½œ

```bash
#!/bin/bash
# æœåŠ¡é‡å¯è„šæœ¬

SERVICE_NAME=$1
if [ -z "$SERVICE_NAME" ]; then
    echo "Usage: $0 <service-name>"
    echo "Available services:"
    echo "  gateway"
    echo "  auth"
    echo "  identity"
    echo "  device"
    echo "  access"
    echo "  consume"
    echo "  attendance"
    echo "  video"
    echo "  oa"
    exit 1
fi

case $SERVICE_NAME in
    "gateway")
        SERVICE="ioedream-gateway"
        ;;
    "auth")
        SERVICE="ioedream-auth-service"
        ;;
    "identity")
        SERVICE="ioedream-identity-service"
        ;;
    "device")
        SERVICE="ioedream-device-service"
        ;;
    "access")
        SERVICE="ioedream-access-service"
        ;;
    "consume")
        SERVICE="ioedream-consume-service"
        ;;
    "attendance")
        SERVICE="ioedream-attendance-service"
        ;;
    "video")
        SERVICE="ioedream-video-service"
        ;;
    "oa")
        SERVICE="ioedream-oa-service"
        ;;
    *)
        echo "Unknown service: $SERVICE_NAME"
        exit 1
        ;;
esac

echo "Restarting $SERVICE..."
systemctl restart $SERVICE

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if systemctl is-active --quiet $SERVICE; then
    echo "âœ… $SERVICE restarted successfully"
    echo "Status: $(systemctl is-active $SERVICE)"
    echo "PID: $(systemctl show $SERVICE -p MainPID --value)"
else
    echo "âŒ $SERVICE restart failed"
    echo "Error logs:"
    journalctl -u $SERVICE --no-pager -n 20
fi
```

### æ—¥å¿—ç®¡ç†

#### æ—¥å¿—æ”¶é›†é…ç½®

```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•ç»“æ„
mkdir -p /opt/ioedream/logs/{services,nginx,mysql,redis,rabbitmq}
mkdir -p /var/log/ioedream/{archive,backup}

# é…ç½®logrotate
cat > /etc/logrotate.d/ioedream << 'EOF'
/opt/ioedream/logs/services/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 ioedream ioedream
    postrotate
        systemctl reload ioedream-gateway
        systemctl reload ioedream-auth-service
        systemctl reload ioedream-identity-service
    endscript
}

/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 nginx nginx
    postrotate
        systemctl reload nginx
    endscript
}
EOF
```

#### æ—¥å¿—åˆ†æè„šæœ¬

```bash
#!/bin/bash
# æ—¥å¿—åˆ†æè„šæœ¬

LOG_DIR="/opt/ioedream/logs/services"
TODAY=$(date +%Y-%m-%d)
YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)

echo "=== IOE-DREAM Log Analysis ==="
echo "Date: $TODAY"
echo ""

# é”™è¯¯æ—¥å¿—åˆ†æ
echo "=== Error Log Summary ==="
for log_file in $LOG_DIR/*.log; do
    service_name=$(basename $log_file .log)
    error_count=$(grep -c "ERROR" $log_file 2>/dev/null || echo 0)
    warn_count=$(grep -c "WARN" $log_file 2>/dev/null || echo 0)

    echo "$service_name:"
    echo "  Errors: $error_count"
    echo "  Warnings: $warn_count"

    if [ $error_count -gt 0 ]; then
        echo "  Latest errors:"
        grep "ERROR" $log_file | tail -3 | sed 's/^/    /'
    fi
    echo ""
done

# HTTPçŠ¶æ€ç åˆ†æ
echo "=== HTTP Status Code Analysis ==="
if [ -f "/var/log/nginx/access.log" ]; then
    echo "Top 10 HTTP status codes:"
    awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10 | sed 's/^/  /'
    echo ""
fi

# æ•°æ®åº“æ…¢æŸ¥è¯¢
echo "=== Database Slow Queries ==="
if [ -f "/var/log/mysql/mysql-slow.log" ]; then
    slow_count=$(grep -c "# Time:" /var/log/mysql/mysql-slow.log)
    echo "Slow query count: $slow_count"
    if [ $slow_count -gt 0 ]; then
        echo "Latest slow queries:"
        grep -A 5 "# Time:" /var/log/mysql/mysql-slow.log | tail -20 | sed 's/^/  /'
    fi
fi
```

### é…ç½®ç®¡ç†

#### é…ç½®æ›´æ–°æµç¨‹

```bash
#!/bin/bash
# é…ç½®æ›´æ–°è„šæœ¬

CONFIG_TYPE=$1
CONFIG_FILE=$2

if [ -z "$CONFIG_TYPE" ] || [ -z "$CONFIG_FILE" ]; then
    echo "Usage: $0 <config-type> <config-file>"
    echo "Config types: service, nginx, mysql, redis"
    exit 1
fi

# å¤‡ä»½å½“å‰é…ç½®
BACKUP_DIR="/opt/ioedream/backup/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

case $CONFIG_TYPE in
    "service")
        if [ -f "/etc/ioedream/$CONFIG_FILE" ]; then
            cp /etc/ioedream/$CONFIG_FILE $BACKUP_DIR/
        fi
        cp $CONFIG_FILE /etc/ioedream/
        echo "Service configuration updated"
        ;;
    "nginx")
        if [ -f "/etc/nginx/nginx.conf" ]; then
            cp /etc/nginx/nginx.conf $BACKUP_DIR/
        fi
        cp $CONFIG_FILE /etc/nginx/nginx.conf
        # æµ‹è¯•nginxé…ç½®
        nginx -t
        if [ $? -eq 0 ]; then
            systemctl reload nginx
            echo "Nginx configuration updated and reloaded"
        else
            echo "Nginx configuration test failed"
            exit 1
        fi
        ;;
    "mysql")
        if [ -f "/etc/my.cnf" ]; then
            cp /etc/my.cnf $BACKUP_DIR/
        fi
        cp $CONFIG_FILE /etc/my.cnf
        systemctl restart mysqld
        echo "MySQL configuration updated"
        ;;
    "redis")
        if [ -f "/etc/redis/redis.conf" ]; then
            cp /etc/redis/redis.conf $BACKUP_DIR/
        fi
        cp $CONFIG_FILE /etc/redis/redis.conf
        systemctl restart redis
        echo "Redis configuration updated"
        ;;
esac

echo "Configuration backup created at: $BACKUP_DIR"
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### JVMè°ƒä¼˜

#### ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°

```bash
# GatewayæœåŠ¡JVMå‚æ•°
JAVA_OPTS_GATEWAY="-Xms2g -Xmx4g \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:+UseStringDeduplication \
-XX:+PrintGCDetails \
-XX:+PrintGCTimeStamps \
-Xloggc:/opt/ioedream/logs/gateway-gc.log \
-XX:+UseGCLogFileRotation \
-XX:NumberOfGCLogFiles=5 \
-XX:GCLogFileSize=10M"

# ä¸šåŠ¡æœåŠ¡JVMå‚æ•°
JAVA_OPTS_SERVICE="-Xms1g -Xmx2g \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=150 \
-XX:+UseStringDeduplication \
-Dspring.profiles.active=prod \
-Dserver.port=8101"
```

#### å†…å­˜ç›‘æ§

```bash
#!/bin/bash
# JVMå†…å­˜ç›‘æ§è„šæœ¬

SERVICES=("gateway" "auth-service" "identity-service" "device-service" "access-service")

echo "=== JVM Memory Usage ==="
for service in "${SERVICES[@]}"; do
    pid=$(pgrep -f "$service")
    if [ ! -z "$pid" ]; then
        echo "$service (PID: $pid):"
        # å †å†…å­˜ä½¿ç”¨æƒ…å†µ
        heap_used=$(jstat -gc $pid | tail -1 | awk '{print $3 + $4 + $6 + $8}')
        heap_max=$(jstat -gc $pid | tail -1 | awk '{print $9}')
        heap_usage=$(echo "scale=2; $heap_used / $heap_max * 100" | bc)
        echo "  Heap Usage: $heap_usage%"

        # GCæƒ…å†µ
        gc_count=$(jstat -gc $pid | tail -1 | awk '{print $14 + $15}')
        gc_time=$(jstat -gc $pid | tail -1 | awk '{print $16 + $17}')
        echo "  GC Count: $gc_count, GC Time: ${gc_time}s"
        echo ""
    fi
done
```

### æ•°æ®åº“ä¼˜åŒ–

#### MySQLé…ç½®ä¼˜åŒ–

```ini
# /etc/my.cnf
[mysqld]
# åŸºç¡€é…ç½®
port = 3306
socket = /var/lib/mysql/mysql.sock
pid-file = /var/run/mysqld/mysqld.pid
user = mysql
bind-address = 0.0.0.0

# å†…å­˜é…ç½®
innodb_buffer_pool_size = 8G
innodb_buffer_pool_instances = 8
innodb_log_file_size = 256M
innodb_log_buffer_size = 16M

# è¿æ¥é…ç½®
max_connections = 1000
max_connect_errors = 100000
wait_timeout = 28800
interactive_timeout = 28800

# æŸ¥è¯¢ç¼“å­˜
query_cache_type = 1
query_cache_size = 64M
query_cache_limit = 2M

# æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2

# äºŒè¿›åˆ¶æ—¥å¿—
log-bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7

# InnoDBé…ç½®
innodb_file_per_table = 1
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_lock_wait_timeout = 50

# å­—ç¬¦é›†é…ç½®
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

#### Redisé…ç½®ä¼˜åŒ–

```conf
# /etc/redis/redis.conf
# å†…å­˜é…ç½®
maxmemory 4gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000

# AOFé…ç½®
appendonly yes
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ç½‘ç»œé…ç½®
tcp-keepalive 300
timeout 0

# å®¢æˆ·ç«¯é…ç½®
maxclients 10000

# æ…¢æ—¥å¿—é…ç½®
slowlog-log-slower-than 10000
slowlog-max-len 128
```

### ç½‘ç»œä¼˜åŒ–

#### Nginxæ€§èƒ½ä¼˜åŒ–

```nginx
# /etc/nginx/nginx.conf
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # åŸºç¡€ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;
    keepalive_requests 1000;

    # å‹ç¼©ä¼˜åŒ–
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ç¼“å­˜ä¼˜åŒ–
    open_file_cache max=65536 inactive=60s;
    open_file_cache_valid 80s;
    open_file_cache_min_uses 1;
    open_file_cache_errors on;

    # è¿æ¥ä¼˜åŒ–
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;

    # è¶…æ—¶ä¼˜åŒ–
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;
}
```

---

## ğŸ’¾ å¤‡ä»½ä¸æ¢å¤

### å¤‡ä»½ç­–ç•¥

#### æ•°æ®åº“å¤‡ä»½

```bash
#!/bin/bash
# MySQLå…¨é‡å¤‡ä»½è„šæœ¬

BACKUP_DIR="/opt/ioedream/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_USER="ioedream"
DB_PASS="Ioedream@2025"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ‰€æœ‰æ•°æ®åº“
databases=$(mysql -u$DB_USER -p$DB_PASS -e "SHOW DATABASES;" | grep -E "(ioedream_)")

for db in $databases; do
    echo "Backing up database: $db"
    mysqldump -u$DB_USER -p$DB_PASS \
        --single-transaction \
        --routines \
        --triggers \
        --events \
        --hex-blob \
        --opt \
        $db | gzip > $BACKUP_DIR/${db}_${DATE}.sql.gz
done

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "Database backup completed: $BACKUP_DIR"
```

#### åº”ç”¨é…ç½®å¤‡ä»½

```bash
#!/bin/bash
# åº”ç”¨é…ç½®å¤‡ä»½è„šæœ¬

BACKUP_DIR="/opt/ioedream/backup/config"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf $BACKUP_DIR/config_${DATE}.tar.gz \
    /etc/ioedream/ \
    /etc/nginx/ \
    /etc/redis/ \
    /etc/my.cnf \
    /opt/ioedream/config/

# å¤‡ä»½åº”ç”¨éƒ¨ç½²æ–‡ä»¶
tar -czf $BACKUP_DIR/deployment_${DATE}.tar.gz \
    /opt/ioedream/services/

echo "Configuration backup completed: $BACKUP_DIR"
```

### æ¢å¤æ“ä½œ

#### æ•°æ®åº“æ¢å¤

```bash
#!/bin/bash
# MySQLæ•°æ®åº“æ¢å¤è„šæœ¬

BACKUP_FILE=$1
DB_USER="ioedream"
DB_PASS="Ioedream@2025"

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup-file>"
    exit 1
fi

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$BACKUP_FILE" ]; then
    echo "Backup file not found: $BACKUP_FILE"
    exit 1
fi

# è·å–æ•°æ®åº“å
filename=$(basename "$BACKUP_FILE")
db_name=$(echo "$filename" | sed 's/_[0-9]\{8\}_[0-9]\{6\}\.sql\.gz//')

echo "Restoring database: $db_name from $BACKUP_FILE"

# åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mysql -u$DB_USER -p$DB_PASS -e "CREATE DATABASE IF NOT EXISTS $db_name CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# æ¢å¤æ•°æ®
gunzip < "$BACKUP_FILE" | mysql -u$DB_USER -p$DB_PASS $db_name

echo "Database restore completed: $db_name"
```

#### æœåŠ¡æ¢å¤

```bash
#!/bin/bash
# æœåŠ¡å¿«é€Ÿæ¢å¤è„šæœ¬

echo "Starting IOE-DREAM service recovery..."

# å¯åŠ¨é¡ºåº
SERVICES=(
    "mysqld"
    "redis"
    "rabbitmq-server"
    "nginx"
    "ioedream-gateway"
    "ioedream-auth-service"
    "ioedream-identity-service"
    "ioedream-device-service"
    "ioedream-access-service"
    "ioedream-consume-service"
    "ioedream-attendance-service"
    "ioedream-video-service"
    "ioedream-oa-service"
)

for service in "${SERVICES[@]}"; do
    echo "Starting $service..."
    systemctl start $service

    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 5

    if systemctl is-active --quiet $service; then
        echo "âœ… $service started successfully"
    else
        echo "âŒ $service failed to start"
        echo "Checking logs for $service:"
        journalctl -u $service --no-pager -n 10
    fi
done

echo "Service recovery completed"
```

---

## ğŸš¨ æ•…éšœè¯Šæ–­ä¸å¤„ç†

### å¸¸è§æ•…éšœå¤„ç†

#### æœåŠ¡æ— æ³•å¯åŠ¨

**æ£€æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æœåŠ¡çŠ¶æ€: `systemctl status service-name`
2. æŸ¥çœ‹æœåŠ¡æ—¥å¿—: `journalctl -u service-name -n 50`
3. æ£€æŸ¥ç«¯å£å ç”¨: `netstat -tlnp | grep port`
4. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
5. æ£€æŸ¥ä¾èµ–æœåŠ¡çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**:
```bash
#!/bin/bash
# æœåŠ¡æ•…éšœè¯Šæ–­è„šæœ¬

SERVICE_NAME=$1

if [ -z "$SERVICE_NAME" ]; then
    echo "Usage: $0 <service-name>"
    exit 1
fi

echo "=== Diagnosing $SERVICE_NAME ==="

# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "1. Service Status:"
systemctl status $SERVICE_NAME --no-pager

echo ""
echo "2. Recent Logs:"
journalctl -u $SERVICE_NAME --no-pager -n 20

echo ""
echo "3. Port Usage:"
port=$(systemctl show $SERVICE_NAME -p ExecStart | grep -o 'server.port=[0-9]*' | cut -d= -f2)
if [ ! -z "$port" ]; then
    netstat -tlnp | grep $port || echo "Port $port is not in use"
fi

echo ""
echo "4. Memory Usage:"
pid=$(systemctl show $SERVICE_NAME -p MainPID --value)
if [ "$pid" != "0" ]; then
    ps -p $pid -o pid,ppid,cmd,%mem,%cpu --no-headers
fi

echo ""
echo "5. File Descriptor Usage:"
if [ "$pid" != "0" ]; then
    lsof -p $pid | wc -l
fi
```

#### æ•°æ®åº“è¿æ¥é—®é¢˜

**è¯Šæ–­è„šæœ¬**:
```bash
#!/bin/bash
# MySQLè¿æ¥è¯Šæ–­è„šæœ¬

echo "=== MySQL Connection Diagnosis ==="

# 1. æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
echo "1. MySQL Service Status:"
systemctl status mysqld --no-pager

echo ""
echo "2. MySQL Process:"
pgrep -f mysqld || echo "MySQL process not found"

echo ""
echo "3. Port Status:"
netstat -tlnp | grep 3306 || ss -tlnp | grep 3306

echo ""
echo "4. Connection Test:"
mysql -uioedream -p'Ioedream@2025' -e "SELECT 1;" 2>/dev/null && echo "âœ… Connection successful" || echo "âŒ Connection failed"

echo ""
echo "5. Error Log:"
tail -20 /var/log/mysql/error.log

echo ""
echo "6. Connection Count:"
mysql -uioedream -p'Ioedream@2025' -e "SHOW PROCESSLIST;" | wc -l
```

#### æ€§èƒ½é—®é¢˜è¯Šæ–­

**ç³»ç»Ÿæ€§èƒ½æ£€æŸ¥**:
```bash
#!/bin/bash
# ç³»ç»Ÿæ€§èƒ½è¯Šæ–­è„šæœ¬

echo "=== System Performance Diagnosis ==="
echo "Time: $(date)"
echo ""

# CPUä½¿ç”¨ç‡
echo "1. CPU Usage:"
top -bn1 | grep "Cpu(s)" | awk '{print "CPU Load: " $2}'

echo ""
echo "2. Top CPU Processes:"
ps aux --sort=-%cpu | head -10 | awk 'NR==1 || NR<=10 {print}'

echo ""
echo "3. Memory Usage:"
free -h

echo ""
echo "4. Top Memory Processes:"
ps aux --sort=-%mem | head -10 | awk 'NR==1 || NR<=10 {print}'

echo ""
echo "5. Disk Usage:"
df -h

echo ""
echo "6. Disk I/O:"
iostat -x 1 1 | tail -n +4

echo ""
echo "7. Network Statistics:"
sar -n DEV 1 1 | tail -n +3

echo ""
echo "8. System Load:"
uptime

echo ""
echo "9. Zombie Processes:"
ps aux | awk '$8 ~ /^Z/ {count++} END {print "Zombie processes: " count+0}'
```

### åº”æ€¥å“åº”æµç¨‹

#### æœåŠ¡å®•æœºåº”æ€¥å“åº”

1. **ç«‹å³å“åº”** (5åˆ†é’Ÿå†…)
   - ç¡®è®¤æœåŠ¡çŠ¶æ€
   - æ£€æŸ¥å‘Šè­¦ä¿¡æ¯
   - é€šçŸ¥ç›¸å…³äººå‘˜

2. **åˆæ­¥è¯Šæ–­** (15åˆ†é’Ÿå†…)
   - æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   - æ£€æŸ¥ç³»ç»Ÿèµ„æº
   - ç¡®å®šæ•…éšœèŒƒå›´

3. **å¿«é€Ÿæ¢å¤** (30åˆ†é’Ÿå†…)
   - é‡å¯ç›¸å…³æœåŠ¡
   - åˆ‡æ¢å¤‡ç”¨æœåŠ¡
   - æ¢å¤æ ¸å¿ƒåŠŸèƒ½

4. **æ ¹å› åˆ†æ** (1å°æ—¶å†…)
   - æ·±å…¥åˆ†ææ—¥å¿—
   - å¤ç°æ•…éšœåœºæ™¯
   - åˆ¶å®šé•¿æœŸæ–¹æ¡ˆ

5. **é¢„é˜²æªæ–½** (24å°æ—¶å†…)
   - æ›´æ–°ç›‘æ§è§„åˆ™
   - å®Œå–„åº”æ€¥é¢„æ¡ˆ
   - ä¼˜åŒ–ç³»ç»Ÿé…ç½®

---

**ğŸ“ æ–‡æ¡£ä¿¡æ¯**
- **ç‰ˆæœ¬**: v2.0.0
- **æ›´æ–°æ—¶é—´**: 2025-11-29
- **é€‚ç”¨ç³»ç»Ÿ**: IOE-DREAMå¾®æœåŠ¡æ¶æ„
- **ç»´æŠ¤å•ä½**: è¿ç»´å›¢é˜Ÿ

**ğŸ’¡ é‡è¦æé†’**:
- å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
- åŠæ—¶å¤„ç†å‘Šè­¦ä¿¡æ¯
- ä¿æŒå¤‡ä»½ç­–ç•¥çš„æœ‰æ•ˆæ€§
- å®šæœŸè¿›è¡Œåº”æ€¥æ¼”ç»ƒ
- æŒç»­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½å’Œç¨³å®šæ€§