# 事件订阅管理页面功能与布局文档

## 页面概述
事件订阅管理页面是智能视频监控系统中的核心通知管理界面，用于配置和管理各类事件的订阅规则，实现智能化的事件推送和通知服务。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供完整的订阅规则配置、多种通知方式管理、订阅状态监控、实时推送日志等功能。通过灵活的订阅配置，系统可以将告警事件、设备状态、AI分析结果等信息实时推送给相关人员，确保关键事件得到及时处理。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **WebSocket**: 用于实时推送日志展示

### 项目文件组织结构
```
src/views/business/smart-video/
├── event-subscription.vue              # 事件订阅主页面
├── components/
│   ├── SubscriptionForm.vue           # 订阅表单组件（新增/编辑）
│   ├── SubscriptionTestModal.vue     # 订阅测试弹窗组件
│   ├── NotificationConfigModal.vue   # 通知配置弹窗组件
│   ├── PushLogDrawer.vue             # 推送日志详情抽屉
│   └── SubscriptionStatsCard.vue     # 订阅统计卡片组件
├── mock/
│   └── subscription-mock-data.js      # 模拟数据
└── api/
    └── subscription-api.js             # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/subscription-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const subscriptionApi = {
  // 查询订阅列表
  querySubscriptionList: (params) => postRequest('/subscription/query', params),

  // 添加订阅
  addSubscription: (params) => postRequest('/subscription/add', params),

  // 更新订阅
  updateSubscription: (params) => postRequest('/subscription/update', params),

  // 删除订阅
  deleteSubscription: (id) => getRequest(`/subscription/delete/${id}`),

  // 批量删除订阅
  batchDeleteSubscription: (ids) => postRequest('/subscription/batch/delete', ids),

  // 启用/禁用订阅
  toggleSubscriptionStatus: (params) => postRequest('/subscription/toggle-status', params),

  // 批量启用/禁用
  batchToggleStatus: (params) => postRequest('/subscription/batch/toggle-status', params),

  // 测试订阅推送
  testSubscription: (params) => postRequest('/subscription/test', params),

  // 获取订阅详情
  getSubscriptionDetail: (id) => getRequest(`/subscription/detail/${id}`),

  // 获取推送日志
  getPushLogs: (params) => postRequest('/subscription/push-logs', params),

  // 清空推送日志
  clearPushLogs: () => postRequest('/subscription/clear-logs'),

  // 重新推送失败的事件
  retryPushEvent: (logId) => postRequest(`/subscription/retry/${logId}`),

  // 获取订阅统计信息
  getSubscriptionStats: () => getRequest('/subscription/stats'),

  // 获取可订阅的事件类型列表
  getEventTypeList: (module) => getRequest(`/subscription/event-types/${module}`),

  // 获取可选择的设备列表
  getDeviceList: (params) => postRequest('/subscription/devices', params),

  // 获取模块列表
  getModuleList: () => getRequest('/subscription/modules'),

  // 配置通知方式
  configNotification: (params) => postRequest('/subscription/notification/config', params),

  // 获取通知配置
  getNotificationConfig: (type) => getRequest(`/subscription/notification/config/${type}`),

  // 验证通知配置（如邮箱、手机号等）
  validateNotificationConfig: (params) => postRequest('/subscription/notification/validate', params),

  // 导出订阅规则
  exportSubscriptions: (params) => postRequest('/subscription/export', params),

  // 导入订阅规则
  importSubscriptions: (file) => postRequest('/subscription/import', file),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="订阅配置">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="订阅配置"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { SubscriptionOutlined } from '@ant-design/icons-vue';  // ❌ 不存在
import { NotificationOutlined } from '@ant-design/icons-vue';  // ❌ 不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  SearchOutlined,        // ✅ 搜索
  ReloadOutlined,        // ✅ 重置/刷新
  PlusOutlined,          // ✅ 新增
  DeleteOutlined,        // ✅ 删除
  BellOutlined,          // ✅ 订阅/通知
  MailOutlined,          // ✅ 邮件
  PhoneOutlined,         // ✅ 电话/短信
  MessageOutlined,       // ✅ 消息
  WechatOutlined,        // ✅ 微信
  DesktopOutlined,       // ✅ 桌面/弹窗
  ApiOutlined,           // ✅ Webhook/API
  EditOutlined,          // ✅ 编辑
  EyeOutlined,           // ✅ 查看
  PlayCircleOutlined,    // ✅ 启用/激活
  PauseCircleOutlined,   // ✅ 暂停
  SyncOutlined,          // ✅ 同步/刷新
  CheckCircleOutlined,   // ✅ 成功/激活
  CloseCircleOutlined,   // ✅ 失败/离线
  ExclamationCircleOutlined, // ✅ 警告/异常
  InfoCircleOutlined,    // ✅ 信息
  ThunderboltOutlined,   // ✅ 快速/测试
  DownloadOutlined,      // ✅ 导出
  UploadOutlined,        // ✅ 导入
  FilterOutlined,        // ✅ 筛选
  ClearOutlined,         // ✅ 清空
  RedoOutlined,          // ✅ 重试
} from '@ant-design/icons-vue';
</script>
```

### 3. API导入路径注意事项

#### ✅ 正确：使用项目标准导入路径
```javascript
// 正确：使用项目中实际的axios文件
import { postRequest, getRequest } from '/@/lib/axios';
```

### 4. 订阅类型和状态枚举定义

#### ✅ 标准枚举定义
```javascript
// src/constants/business/subscription-const.js
export const SUBSCRIPTION_MODULE_ENUM = {
  IVS: {
    value: 'ivs',
    label: '智能视频',
    color: 'purple',
  },
  ACCESS: {
    value: 'access',
    label: '门禁系统',
    color: 'blue',
  },
  ALARM: {
    value: 'alarm',
    label: '告警系统',
    color: 'red',
  },
  VISITOR: {
    value: 'visitor',
    label: '访客系统',
    color: 'green',
  },
  PARKING: {
    value: 'parking',
    label: '停车系统',
    color: 'cyan',
  },
  SYSTEM: {
    value: 'system',
    label: '系统监控',
    color: 'gray',
  },
};

export const EVENT_TYPE_ENUM = {
  ALARM: {
    value: 'alarm',
    label: '告警事件',
    color: 'red',
  },
  DEVICE: {
    value: 'device',
    label: '设备事件',
    color: 'orange',
  },
  AI: {
    value: 'ai',
    label: 'AI分析事件',
    color: 'purple',
  },
  SYSTEM: {
    value: 'system',
    label: '系统事件',
    color: 'gray',
  },
};

export const NOTIFICATION_TYPE_ENUM = {
  EMAIL: {
    value: 'email',
    label: '邮件通知',
    icon: 'MailOutlined',
    color: 'blue',
  },
  SMS: {
    value: 'sms',
    label: '短信通知',
    icon: 'PhoneOutlined',
    color: 'green',
  },
  POPUP: {
    value: 'popup',
    label: '弹窗提醒',
    icon: 'DesktopOutlined',
    color: 'purple',
  },
  WECHAT: {
    value: 'wechat',
    label: '微信推送',
    icon: 'WechatOutlined',
    color: 'orange',
  },
  WEBHOOK: {
    value: 'webhook',
    label: 'Webhook',
    icon: 'ApiOutlined',
    color: 'cyan',
  },
  WEBSOCKET: {
    value: 'websocket',
    label: 'WebSocket',
    icon: 'ApiOutlined',
    color: 'geekblue',
  },
};

export const SUBSCRIPTION_STATUS_ENUM = {
  ACTIVE: {
    value: 'active',
    label: '激活',
    color: 'success',
  },
  INACTIVE: {
    value: 'inactive',
    label: '未激活',
    color: 'default',
  },
  ERROR: {
    value: 'error',
    label: '异常',
    color: 'error',
  },
  PAUSED: {
    value: 'paused',
    label: '暂停',
    color: 'warning',
  },
};

export const PUSH_STATUS_ENUM = {
  SUCCESS: {
    value: 'success',
    label: '成功',
    color: 'success',
  },
  FAILED: {
    value: 'failed',
    label: '失败',
    color: 'error',
  },
  PENDING: {
    value: 'pending',
    label: '待推送',
    color: 'processing',
  },
};
```

## 核心功能模块

### 1. 顶部工具栏（筛选与搜索）
**位置**: 页面顶部

**功能说明**:
- 模块筛选：按系统模块筛选订阅（智能视频、门禁、告警等）
- 状态筛选：按订阅状态筛选（激活、未激活、异常）
- 事件类型筛选：按事件类型筛选（告警、设备、AI分析、系统）
- 关键词搜索：搜索订阅名称、描述等

**技术实现**:
```vue
<template>
  <a-card class="smart-query-card">
    <a-form layout="inline">
      <a-row :gutter="16" style="width: 100%">
        <a-col :span="6">
          <a-form-item label="模块">
            <a-select
              v-model:value="queryForm.module"
              placeholder="请选择模块"
              allowClear
              style="width: 100%"
            >
              <a-select-option value="">全部模块</a-select-option>
              <a-select-option value="ivs">智能视频</a-select-option>
              <a-select-option value="access">门禁系统</a-select-option>
              <a-select-option value="alarm">告警系统</a-select-option>
              <a-select-option value="visitor">访客系统</a-select-option>
              <a-select-option value="parking">停车系统</a-select-option>
              <a-select-option value="system">系统监控</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>

        <a-col :span="5">
          <a-form-item label="状态">
            <a-select
              v-model:value="queryForm.status"
              placeholder="请选择状态"
              allowClear
              style="width: 100%"
            >
              <a-select-option value="">全部状态</a-select-option>
              <a-select-option value="active">激活</a-select-option>
              <a-select-option value="inactive">未激活</a-select-option>
              <a-select-option value="paused">暂停</a-select-option>
              <a-select-option value="error">异常</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>

        <a-col :span="5">
          <a-form-item label="事件类型">
            <a-select
              v-model:value="queryForm.eventType"
              placeholder="请选择事件类型"
              allowClear
              style="width: 100%"
            >
              <a-select-option value="">全部类型</a-select-option>
              <a-select-option value="alarm">告警事件</a-select-option>
              <a-select-option value="device">设备事件</a-select-option>
              <a-select-option value="ai">AI分析事件</a-select-option>
              <a-select-option value="system">系统事件</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>

        <a-col :span="8">
          <a-form-item>
            <a-space>
              <a-input
                v-model:value="queryForm.keyword"
                placeholder="搜索订阅名称..."
                style="width: 240px"
                allowClear
              >
                <template #prefix>
                  <SearchOutlined />
                </template>
              </a-input>
              <a-button type="primary" @click="queryData">
                <template #icon><SearchOutlined /></template>
                查询
              </a-button>
              <a-button @click="resetQuery">
                <template #icon><ReloadOutlined /></template>
                重置
              </a-button>
            </a-space>
          </a-form-item>
        </a-col>
      </a-row>
    </a-form>
  </a-card>
</template>

<script setup>
import { reactive } from 'vue';
import { SearchOutlined, ReloadOutlined } from '@ant-design/icons-vue';

const queryForm = reactive({
  module: '',
  status: '',
  eventType: '',
  keyword: '',
});

const queryData = () => {
  console.log('查询订阅', queryForm);
  // 调用API查询
};

const resetQuery = () => {
  Object.assign(queryForm, {
    module: '',
    status: '',
    eventType: '',
    keyword: '',
  });
  queryData();
};
</script>
```

### 2. 统计信息卡片
**位置**: 工具栏下方

**功能说明**:
- 总订阅数：显示系统中所有订阅规则的数量
- 活跃订阅：显示当前激活状态的订阅数量
- 今日推送：显示今天推送的事件总数
- 异常订阅：显示推送失败或配置异常的订阅数量

**技术实现**:
```vue
<template>
  <a-row :gutter="16" class="smart-margin-top16">
    <a-col :span="6">
      <a-card class="stat-card">
        <a-statistic
          title="总订阅数"
          :value="stats.totalSubscriptions"
          :value-style="{ color: '#722ed1' }"
        >
          <template #prefix>
            <BellOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>

    <a-col :span="6">
      <a-card class="stat-card">
        <a-statistic
          title="活跃订阅"
          :value="stats.activeSubscriptions"
          :value-style="{ color: '#52c41a' }"
        >
          <template #prefix>
            <CheckCircleOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>

    <a-col :span="6">
      <a-card class="stat-card">
        <a-statistic
          title="今日推送"
          :value="stats.todayPushCount"
          :value-style="{ color: '#1890ff' }"
        >
          <template #prefix>
            <ThunderboltOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>

    <a-col :span="6">
      <a-card class="stat-card">
        <a-statistic
          title="异常订阅"
          :value="stats.errorSubscriptions"
          :value-style="{ color: '#ff4d4f' }"
        >
          <template #prefix>
            <ExclamationCircleOutlined />
          </template>
        </a-statistic>
      </a-card>
    </a-col>
  </a-row>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import {
  BellOutlined,
  CheckCircleOutlined,
  ThunderboltOutlined,
  ExclamationCircleOutlined,
} from '@ant-design/icons-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

const stats = ref({
  totalSubscriptions: 0,
  activeSubscriptions: 0,
  todayPushCount: 0,
  errorSubscriptions: 0,
});

const loadStats = async () => {
  try {
    const response = await subscriptionApi.getSubscriptionStats();
    if (response.code === 1) {
      stats.value = response.data;
    }
  } catch (error) {
    console.error('加载统计信息失败:', error);
  }
};

onMounted(() => {
  loadStats();
});
</script>

<style scoped lang="less">
.stat-card {
  text-align: center;

  :deep(.ant-statistic-title) {
    color: #666;
    font-size: 14px;
  }

  :deep(.ant-statistic-content) {
    font-size: 28px;
    font-weight: 600;
  }
}
</style>
```

### 3. 主操作按钮区
**位置**: 统计卡片下方

**功能说明**:
- **新增订阅**: 创建新的事件订阅规则
- **删除**: 批量删除选中的订阅
- **刷新**: 刷新订阅列表数据

**技术实现**:
```vue
<template>
  <a-card class="smart-margin-top16">
    <div class="smart-query-table-operation">
      <a-space>
        <a-button type="primary" @click="showAddModal">
          <template #icon><PlusOutlined /></template>
          新增订阅
        </a-button>

        <a-button
          danger
          @click="batchDelete"
          :disabled="selectedRowKeys.length === 0"
        >
          <template #icon><DeleteOutlined /></template>
          删除
        </a-button>

        <a-button @click="batchEnable" :disabled="selectedRowKeys.length === 0">
          <template #icon><PlayCircleOutlined /></template>
          启用
        </a-button>

        <a-button @click="batchPause" :disabled="selectedRowKeys.length === 0">
          <template #icon><PauseCircleOutlined /></template>
          暂停
        </a-button>

        <a-button @click="testSubscription" :disabled="selectedRowKeys.length !== 1">
          <template #icon><ThunderboltOutlined /></template>
          测试推送
        </a-button>

        <a-button @click="exportSubscriptions">
          <template #icon><DownloadOutlined /></template>
          导出
        </a-button>

        <a-button @click="importSubscriptions">
          <template #icon><UploadOutlined /></template>
          导入
        </a-button>

        <a-button @click="refreshList">
          <template #icon><SyncOutlined /></template>
          刷新
        </a-button>
      </a-space>
    </div>
  </a-card>
</template>

<script setup>
import { ref } from 'vue';
import { message, Modal } from 'ant-design-vue';
import {
  PlusOutlined,
  DeleteOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  ThunderboltOutlined,
  DownloadOutlined,
  UploadOutlined,
  SyncOutlined,
} from '@ant-design/icons-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

const selectedRowKeys = ref([]);
const showAddModal = ref(false);

const batchDelete = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要删除的订阅');
    return;
  }

  Modal.confirm({
    title: '确认删除',
    content: `确定要删除选中的 ${selectedRowKeys.value.length} 个订阅吗？`,
    onOk: async () => {
      try {
        const response = await subscriptionApi.batchDeleteSubscription(selectedRowKeys.value);
        if (response.code === 1) {
          message.success('删除成功');
          selectedRowKeys.value = [];
          queryData();
        } else {
          message.error(response.msg || '删除失败');
        }
      } catch (error) {
        message.error('删除失败');
      }
    },
  });
};

const batchEnable = async () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要启用的订阅');
    return;
  }

  try {
    const response = await subscriptionApi.batchToggleStatus({
      ids: selectedRowKeys.value,
      status: 'active',
    });
    if (response.code === 1) {
      message.success('启用成功');
      queryData();
    } else {
      message.error(response.msg || '启用失败');
    }
  } catch (error) {
    message.error('启用失败');
  }
};

const batchPause = async () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要暂停的订阅');
    return;
  }

  try {
    const response = await subscriptionApi.batchToggleStatus({
      ids: selectedRowKeys.value,
      status: 'paused',
    });
    if (response.code === 1) {
      message.success('暂停成功');
      queryData();
    } else {
      message.error(response.msg || '暂停失败');
    }
  } catch (error) {
    message.error('暂停失败');
  }
};

const testSubscription = () => {
  if (selectedRowKeys.value.length !== 1) {
    message.warning('请选择一个订阅进行测试');
    return;
  }
  // 打开测试弹窗
};

const exportSubscriptions = () => {
  message.info('导出功能开发中...');
};

const importSubscriptions = () => {
  message.info('导入功能开发中...');
};

const refreshList = () => {
  queryData();
  message.success('刷新成功');
};
</script>
```

### 4. 订阅列表表格
**位置**: 操作按钮区下方

**表格列配置**:
```vue
<template>
  <a-card class="smart-margin-top16">
    <div class="smart-table-header">
      <h3 class="smart-table-title">事件订阅列表</h3>
      <span class="smart-table-count">共 {{ pagination.total }} 个订阅</span>
    </div>

    <a-table
      :columns="columns"
      :data-source="tableData"
      :pagination="pagination"
      :loading="tableLoading"
      :row-selection="rowSelection"
      :scroll="{ x: 1600 }"
      row-key="id"
      bordered
      @change="handleTableChange"
    >
      <template #bodyCell="{ column, record, text }">
        <!-- 订阅名称 -->
        <template v-if="column.dataIndex === 'subscriptionName'">
          <div>
            <div class="smart-table-cell-title">{{ record.subscriptionName }}</div>
            <div class="smart-table-cell-desc">{{ record.description }}</div>
          </div>
        </template>

        <!-- 订阅模块 -->
        <template v-else-if="column.dataIndex === 'module'">
          <a-tag :color="getModuleColor(record.module)">
            {{ getModuleLabel(record.module) }}
          </a-tag>
        </template>

        <!-- 事件类型 -->
        <template v-else-if="column.dataIndex === 'eventType'">
          <a-tag :color="getEventTypeColor(record.eventType)">
            {{ getEventTypeLabel(record.eventType) }}
          </a-tag>
        </template>

        <!-- 推送方式 -->
        <template v-else-if="column.dataIndex === 'notificationTypes'">
          <a-space wrap>
            <a-tag
              v-for="type in record.notificationTypes"
              :key="type"
              :color="getNotificationColor(type)"
            >
              <component :is="getNotificationIcon(type)" style="margin-right: 4px" />
              {{ getNotificationLabel(type) }}
            </a-tag>
          </a-space>
        </template>

        <!-- 订阅条件 -->
        <template v-else-if="column.dataIndex === 'conditions'">
          <div class="subscription-conditions">
            <div v-for="(value, key) in record.conditions" :key="key">
              <span class="condition-label">{{ key }}:</span>
              <span class="condition-value">{{ value }}</span>
            </div>
          </div>
        </template>

        <!-- 状态 -->
        <template v-else-if="column.dataIndex === 'status'">
          <a-tag :color="getStatusColor(record.status)">
            <template #icon>
              <CheckCircleOutlined v-if="record.status === 'active'" />
              <PauseCircleOutlined v-else-if="record.status === 'paused'" />
              <ExclamationCircleOutlined v-else-if="record.status === 'error'" />
              <CloseCircleOutlined v-else />
            </template>
            {{ getStatusLabel(record.status) }}
          </a-tag>
        </template>

        <!-- 操作 -->
        <template v-else-if="column.dataIndex === 'action'">
          <div class="smart-table-operate">
            <a-button type="link" size="small" @click="editSubscription(record)">
              <template #icon><EditOutlined /></template>
              编辑
            </a-button>

            <a-button
              type="link"
              size="small"
              @click="toggleStatus(record)"
              :style="{ color: record.status === 'active' ? '#faad14' : '#52c41a' }"
            >
              <template #icon>
                <PauseCircleOutlined v-if="record.status === 'active'" />
                <PlayCircleOutlined v-else />
              </template>
              {{ record.status === 'active' ? '暂停' : '启用' }}
            </a-button>

            <a-button type="link" size="small" @click="viewDetail(record)">
              <template #icon><EyeOutlined /></template>
              查看
            </a-button>

            <a-popconfirm
              title="确定要删除该订阅吗？"
              @confirm="deleteSubscription(record)"
            >
              <a-button type="link" size="small" danger>
                <template #icon><DeleteOutlined /></template>
                删除
              </a-button>
            </a-popconfirm>
          </div>
        </template>
      </template>
    </a-table>
  </a-card>
</template>

<script setup>
import { ref, reactive, computed } from 'vue';
import { message } from 'ant-design-vue';
import {
  EditOutlined,
  DeleteOutlined,
  EyeOutlined,
  PlayCircleOutlined,
  PauseCircleOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ExclamationCircleOutlined,
  MailOutlined,
  PhoneOutlined,
  DesktopOutlined,
  WechatOutlined,
  ApiOutlined,
} from '@ant-design/icons-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

const columns = [
  {
    title: '序号',
    dataIndex: 'index',
    key: 'index',
    width: 70,
    customRender: ({ index }) => index + 1,
  },
  {
    title: '订阅名称',
    dataIndex: 'subscriptionName',
    key: 'subscriptionName',
    width: 220,
    ellipsis: true,
  },
  {
    title: '订阅模块',
    dataIndex: 'module',
    key: 'module',
    width: 120,
  },
  {
    title: '事件类型',
    dataIndex: 'eventType',
    key: 'eventType',
    width: 120,
  },
  {
    title: '推送方式',
    dataIndex: 'notificationTypes',
    key: 'notificationTypes',
    width: 240,
  },
  {
    title: '订阅条件',
    dataIndex: 'conditions',
    key: 'conditions',
    width: 200,
    ellipsis: true,
  },
  {
    title: '状态',
    dataIndex: 'status',
    key: 'status',
    width: 100,
  },
  {
    title: '最后推送',
    dataIndex: 'lastPushTime',
    key: 'lastPushTime',
    width: 160,
  },
  {
    title: '推送次数',
    dataIndex: 'pushCount',
    key: 'pushCount',
    width: 100,
  },
  {
    title: '操作',
    dataIndex: 'action',
    key: 'action',
    width: 280,
    fixed: 'right',
  },
];

const tableData = ref([]);
const tableLoading = ref(false);
const selectedRowKeys = ref([]);

const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  pageSizeOptions: ['10', '20', '50', '100'],
  showTotal: (total) => `共 ${total} 条`,
});

const rowSelection = computed(() => ({
  selectedRowKeys: selectedRowKeys.value,
  onChange: (keys) => {
    selectedRowKeys.value = keys;
  },
}));

// 辅助函数
const getModuleLabel = (module) => {
  const map = {
    ivs: '智能视频',
    access: '门禁系统',
    alarm: '告警系统',
    visitor: '访客系统',
    parking: '停车系统',
    system: '系统监控',
  };
  return map[module] || module;
};

const getModuleColor = (module) => {
  const map = {
    ivs: 'purple',
    access: 'blue',
    alarm: 'red',
    visitor: 'green',
    parking: 'cyan',
    system: 'gray',
  };
  return map[module] || 'default';
};

const getEventTypeLabel = (type) => {
  const map = {
    alarm: '告警事件',
    device: '设备事件',
    ai: 'AI分析事件',
    system: '系统事件',
  };
  return map[type] || type;
};

const getEventTypeColor = (type) => {
  const map = {
    alarm: 'red',
    device: 'orange',
    ai: 'purple',
    system: 'gray',
  };
  return map[type] || 'default';
};

const getNotificationLabel = (type) => {
  const map = {
    email: '邮件',
    sms: '短信',
    popup: '弹窗',
    wechat: '微信',
    webhook: 'Webhook',
    websocket: 'WebSocket',
  };
  return map[type] || type;
};

const getNotificationColor = (type) => {
  const map = {
    email: 'blue',
    sms: 'green',
    popup: 'purple',
    wechat: 'orange',
    webhook: 'cyan',
    websocket: 'geekblue',
  };
  return map[type] || 'default';
};

const getNotificationIcon = (type) => {
  const map = {
    email: MailOutlined,
    sms: PhoneOutlined,
    popup: DesktopOutlined,
    wechat: WechatOutlined,
    webhook: ApiOutlined,
    websocket: ApiOutlined,
  };
  return map[type] || ApiOutlined;
};

const getStatusLabel = (status) => {
  const map = {
    active: '激活',
    inactive: '未激活',
    paused: '暂停',
    error: '异常',
  };
  return map[status] || status;
};

const getStatusColor = (status) => {
  const map = {
    active: 'success',
    inactive: 'default',
    paused: 'warning',
    error: 'error',
  };
  return map[status] || 'default';
};

const toggleStatus = async (record) => {
  const newStatus = record.status === 'active' ? 'paused' : 'active';
  try {
    const response = await subscriptionApi.toggleSubscriptionStatus({
      id: record.id,
      status: newStatus,
    });
    if (response.code === 1) {
      message.success(newStatus === 'active' ? '启用成功' : '暂停成功');
      queryData();
    } else {
      message.error(response.msg || '操作失败');
    }
  } catch (error) {
    message.error('操作失败');
  }
};

const editSubscription = (record) => {
  // 打开编辑弹窗
};

const viewDetail = (record) => {
  // 打开详情抽屉
};

const deleteSubscription = async (record) => {
  try {
    const response = await subscriptionApi.deleteSubscription(record.id);
    if (response.code === 1) {
      message.success('删除成功');
      queryData();
    } else {
      message.error(response.msg || '删除失败');
    }
  } catch (error) {
    message.error('删除失败');
  }
};
</script>

<style scoped lang="less">
.smart-table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.smart-table-title {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
}

.smart-table-count {
  color: #999;
  font-size: 14px;
}

.smart-table-cell-title {
  font-weight: 500;
  color: #333;
}

.smart-table-cell-desc {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.subscription-conditions {
  font-size: 12px;

  > div {
    margin-bottom: 2px;
  }

  .condition-label {
    color: #999;
    margin-right: 4px;
  }

  .condition-value {
    color: #333;
  }
}
</style>
```

### 5. 订阅表单组件（新增/编辑）
**组件路径**: `src/views/business/smart-video/components/SubscriptionForm.vue`

**技术实现**:
```vue
<template>
  <a-modal
    :open="visible"
    :title="isEdit ? '编辑订阅' : '新增订阅'"
    width="900px"
    @ok="handleSubmit"
    @cancel="handleCancel"
    :confirmLoading="loading"
    :maskClosable="false"
  >
    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
    >
      <a-tabs v-model:activeKey="activeTab">
        <!-- 基本信息 -->
        <a-tab-pane key="basic" tab="基本信息">
          <a-row :gutter="16">
            <a-col :span="24">
              <a-form-item label="订阅名称" name="subscriptionName">
                <a-input
                  v-model:value="formData.subscriptionName"
                  placeholder="请输入订阅名称"
                />
              </a-form-item>
            </a-col>
          </a-row>

          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="订阅模块" name="module">
                <a-select
                  v-model:value="formData.module"
                  placeholder="请选择模块"
                  @change="handleModuleChange"
                >
                  <a-select-option value="ivs">智能视频</a-select-option>
                  <a-select-option value="access">门禁系统</a-select-option>
                  <a-select-option value="alarm">告警系统</a-select-option>
                  <a-select-option value="visitor">访客系统</a-select-option>
                  <a-select-option value="parking">停车系统</a-select-option>
                  <a-select-option value="system">系统监控</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>

            <a-col :span="12">
              <a-form-item label="事件类型" name="eventType">
                <a-select
                  v-model:value="formData.eventType"
                  placeholder="请选择事件类型"
                  :disabled="!formData.module"
                  :loading="eventTypesLoading"
                >
                  <a-select-option
                    v-for="item in eventTypeOptions"
                    :key="item.value"
                    :value="item.value"
                  >
                    {{ item.label }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
          </a-row>

          <a-row :gutter="16">
            <a-col :span="24">
              <a-form-item label="订阅描述" name="description">
                <a-textarea
                  v-model:value="formData.description"
                  placeholder="请输入订阅描述"
                  :rows="3"
                />
              </a-form-item>
            </a-col>
          </a-row>
        </a-tab-pane>

        <!-- 推送配置 -->
        <a-tab-pane key="notification" tab="推送配置">
          <a-form-item label="推送方式" name="notificationTypes">
            <a-checkbox-group v-model:value="formData.notificationTypes">
              <a-row :gutter="[16, 16]">
                <a-col :span="12">
                  <a-checkbox value="email">
                    <MailOutlined style="margin-right: 8px" />
                    邮件通知
                  </a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="sms">
                    <PhoneOutlined style="margin-right: 8px" />
                    短信通知
                  </a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="popup">
                    <DesktopOutlined style="margin-right: 8px" />
                    弹窗提醒
                  </a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="wechat">
                    <WechatOutlined style="margin-right: 8px" />
                    微信推送
                  </a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="webhook">
                    <ApiOutlined style="margin-right: 8px" />
                    Webhook
                  </a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="websocket">
                    <ApiOutlined style="margin-right: 8px" />
                    WebSocket
                  </a-checkbox>
                </a-col>
              </a-row>
            </a-checkbox-group>
          </a-form-item>

          <!-- 邮件配置 -->
          <a-form-item
            v-if="formData.notificationTypes.includes('email')"
            label="邮件地址"
            name="emailConfig"
          >
            <a-select
              v-model:value="formData.emailConfig.recipients"
              mode="tags"
              placeholder="请输入邮件地址，按回车添加"
              :token-separators="[',', ';']"
            />
          </a-form-item>

          <!-- 短信配置 -->
          <a-form-item
            v-if="formData.notificationTypes.includes('sms')"
            label="手机号"
            name="smsConfig"
          >
            <a-select
              v-model:value="formData.smsConfig.recipients"
              mode="tags"
              placeholder="请输入手机号，按回车添加"
              :token-separators="[',', ';']"
            />
          </a-form-item>

          <!-- 微信配置 -->
          <a-form-item
            v-if="formData.notificationTypes.includes('wechat')"
            label="微信用户"
            name="wechatConfig"
          >
            <a-select
              v-model:value="formData.wechatConfig.recipients"
              mode="multiple"
              placeholder="请选择微信用户"
            >
              <a-select-option value="user1">张三</a-select-option>
              <a-select-option value="user2">李四</a-select-option>
              <a-select-option value="user3">王五</a-select-option>
            </a-select>
          </a-form-item>

          <!-- Webhook配置 -->
          <a-form-item
            v-if="formData.notificationTypes.includes('webhook')"
            label="Webhook URL"
            name="webhookConfig"
          >
            <a-input
              v-model:value="formData.webhookConfig.url"
              placeholder="请输入Webhook URL"
            />
            <a-button
              type="link"
              size="small"
              style="padding: 0; margin-top: 4px"
              @click="testWebhook"
            >
              测试连接
            </a-button>
          </a-form-item>
        </a-tab-pane>

        <!-- 订阅条件 -->
        <a-tab-pane key="conditions" tab="订阅条件">
          <a-form-item label="设备选择" name="deviceIds">
            <a-select
              v-model:value="formData.deviceIds"
              mode="multiple"
              placeholder="请选择设备（留空表示全部设备）"
              :loading="devicesLoading"
              allowClear
            >
              <a-select-option
                v-for="device in deviceOptions"
                :key="device.id"
                :value="device.id"
              >
                {{ device.deviceName }} ({{ device.deviceCode }})
              </a-select-option>
            </a-select>
          </a-form-item>

          <a-form-item label="区域选择" name="areas">
            <a-select
              v-model:value="formData.areas"
              mode="tags"
              placeholder="请输入区域名称，按回车添加"
              :token-separators="[',', ';']"
              allowClear
            />
          </a-form-item>

          <a-form-item label="时间范围" name="timeRange">
            <a-time-range-picker
              v-model:value="formData.timeRange"
              format="HH:mm"
              placeholder="['开始时间', '结束时间']"
              style="width: 100%"
            />
          </a-form-item>

          <a-form-item label="告警级别" name="alarmLevels">
            <a-checkbox-group v-model:value="formData.alarmLevels">
              <a-checkbox value="low">低级</a-checkbox>
              <a-checkbox value="medium">中级</a-checkbox>
              <a-checkbox value="high">高级</a-checkbox>
              <a-checkbox value="critical">紧急</a-checkbox>
            </a-checkbox-group>
          </a-form-item>

          <a-form-item label="置信度阈值" name="confidenceThreshold">
            <a-slider
              v-model:value="formData.confidenceThreshold"
              :min="0"
              :max="100"
              :marks="{ 0: '0%', 50: '50%', 85: '85%', 100: '100%' }"
            />
            <div style="text-align: center; margin-top: 8px">
              当前阈值: {{ formData.confidenceThreshold }}%
            </div>
          </a-form-item>

          <a-form-item label="其他条件" name="customConditions">
            <a-textarea
              v-model:value="formData.customConditions"
              placeholder="请输入其他订阅条件（JSON格式或纯文本）"
              :rows="4"
            />
          </a-form-item>
        </a-tab-pane>

        <!-- 高级设置 -->
        <a-tab-pane key="advanced" tab="高级设置">
          <a-form-item label="推送频率限制">
            <a-radio-group v-model:value="formData.pushFrequency">
              <a-radio value="realtime">实时推送</a-radio>
              <a-radio value="interval">间隔推送</a-radio>
              <a-radio value="daily">每日汇总</a-radio>
            </a-radio-group>
          </a-form-item>

          <a-form-item
            v-if="formData.pushFrequency === 'interval'"
            label="推送间隔（分钟）"
          >
            <a-input-number
              v-model:value="formData.pushInterval"
              :min="1"
              :max="1440"
              placeholder="请输入间隔时间"
              style="width: 100%"
            />
          </a-form-item>

          <a-form-item label="失败重试">
            <a-switch v-model:checked="formData.retryEnabled" />
            <span style="margin-left: 12px; color: #999">
              推送失败时自动重试
            </span>
          </a-form-item>

          <a-form-item v-if="formData.retryEnabled" label="最大重试次数">
            <a-input-number
              v-model:value="formData.maxRetryCount"
              :min="1"
              :max="10"
              style="width: 100%"
            />
          </a-form-item>

          <a-form-item label="启用状态">
            <a-switch v-model:checked="formData.enabled" />
            <span style="margin-left: 12px; color: #999">
              {{ formData.enabled ? '立即启用' : '暂不启用' }}
            </span>
          </a-form-item>
        </a-tab-pane>
      </a-tabs>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  MailOutlined,
  PhoneOutlined,
  DesktopOutlined,
  WechatOutlined,
  ApiOutlined,
} from '@ant-design/icons-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  isEdit: {
    type: Boolean,
    default: false,
  },
  subscriptionData: {
    type: Object,
    default: () => ({}),
  },
});

const emit = defineEmits(['update:visible', 'success', 'cancel']);

const formRef = ref();
const loading = ref(false);
const activeTab = ref('basic');
const eventTypesLoading = ref(false);
const devicesLoading = ref(false);
const eventTypeOptions = ref([]);
const deviceOptions = ref([]);

const formData = reactive({
  subscriptionName: '',
  module: '',
  eventType: '',
  description: '',
  notificationTypes: [],
  emailConfig: { recipients: [] },
  smsConfig: { recipients: [] },
  wechatConfig: { recipients: [] },
  webhookConfig: { url: '' },
  deviceIds: [],
  areas: [],
  timeRange: null,
  alarmLevels: [],
  confidenceThreshold: 85,
  customConditions: '',
  pushFrequency: 'realtime',
  pushInterval: 5,
  retryEnabled: true,
  maxRetryCount: 3,
  enabled: true,
});

const formRules = {
  subscriptionName: [
    { required: true, message: '请输入订阅名称', trigger: 'blur' },
  ],
  module: [
    { required: true, message: '请选择订阅模块', trigger: 'change' },
  ],
  eventType: [
    { required: true, message: '请选择事件类型', trigger: 'change' },
  ],
  notificationTypes: [
    { required: true, type: 'array', min: 1, message: '请至少选择一种推送方式', trigger: 'change' },
  ],
};

// 监听编辑数据变化
watch(
  () => props.subscriptionData,
  (newVal) => {
    if (newVal && Object.keys(newVal).length > 0) {
      Object.assign(formData, newVal);
    }
  },
  { immediate: true, deep: true }
);

// 模块变化时加载事件类型
const handleModuleChange = async (module) => {
  formData.eventType = '';
  eventTypeOptions.value = [];

  if (!module) return;

  eventTypesLoading.value = true;
  try {
    const response = await subscriptionApi.getEventTypeList(module);
    if (response.code === 1) {
      eventTypeOptions.value = response.data;
    }
  } catch (error) {
    console.error('加载事件类型失败:', error);
  } finally {
    eventTypesLoading.value = false;
  }
};

// 测试Webhook
const testWebhook = async () => {
  if (!formData.webhookConfig.url) {
    message.warning('请先输入Webhook URL');
    return;
  }

  try {
    const response = await subscriptionApi.validateNotificationConfig({
      type: 'webhook',
      url: formData.webhookConfig.url,
    });
    if (response.code === 1) {
      message.success('连接测试成功');
    } else {
      message.error(response.msg || '连接测试失败');
    }
  } catch (error) {
    message.error('连接测试失败');
  }
};

// 提交表单
const handleSubmit = async () => {
  try {
    await formRef.value.validate();

    loading.value = true;

    const apiMethod = props.isEdit
      ? subscriptionApi.updateSubscription
      : subscriptionApi.addSubscription;
    const result = await apiMethod(formData);

    if (result.code === 1) {
      message.success(props.isEdit ? '编辑成功' : '新增成功');
      emit('success');
      handleCancel();
    } else {
      message.error(result.msg || '操作失败');
    }
  } catch (error) {
    console.error('表单提交失败:', error);
  } finally {
    loading.value = false;
  }
};

// 取消
const handleCancel = () => {
  formRef.value?.resetFields();
  activeTab.value = 'basic';
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 6. 实时推送日志组件
**位置**: 订阅列表下方

**技术实现**:
```vue
<template>
  <a-card class="smart-margin-top16" title="实时推送日志">
    <template #extra>
      <a-space>
        <a-badge :status="wsConnected ? 'processing' : 'default'" />
        <span style="color: #999">
          {{ wsConnected ? '实时更新中' : '已断开连接' }}
        </span>
        <a-button type="link" size="small" @click="clearLogs">
          <template #icon><ClearOutlined /></template>
          清空日志
        </a-button>
      </a-space>
    </template>

    <div class="push-logs-container">
      <a-list
        :data-source="pushLogs"
        :loading="logsLoading"
        size="small"
      >
        <template #renderItem="{ item }">
          <a-list-item class="push-log-item">
            <a-list-item-meta>
              <template #title>
                <a-space>
                  <span class="log-time">{{ item.pushTime }}</span>
                  <a-tag :color="getEventTypeColor(item.eventType)">
                    {{ item.eventType }}
                  </a-tag>
                  <span class="log-message">{{ item.message }}</span>
                </a-space>
              </template>
            </a-list-item-meta>
            <template #actions>
              <a-tag :color="item.status === 'success' ? 'success' : 'error'">
                {{ item.status === 'success' ? '成功' : '失败' }}
              </a-tag>
              <a-button
                v-if="item.status === 'failed'"
                type="link"
                size="small"
                @click="retryPush(item.id)"
              >
                <template #icon><RedoOutlined /></template>
                重试
              </a-button>
            </template>
          </a-list-item>
        </template>
      </a-list>

      <div v-if="pushLogs.length === 0 && !logsLoading" class="empty-logs">
        <a-empty description="暂无推送日志" />
      </div>
    </div>
  </a-card>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';
import { message } from 'ant-design-vue';
import { ClearOutlined, RedoOutlined } from '@ant-design/icons-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

const pushLogs = ref([]);
const logsLoading = ref(false);
const wsConnected = ref(false);
let ws = null;
let reconnectTimer = null;

// 加载历史日志
const loadPushLogs = async () => {
  logsLoading.value = true;
  try {
    const response = await subscriptionApi.getPushLogs({
      pageNum: 1,
      pageSize: 20,
    });
    if (response.code === 1) {
      pushLogs.value = response.data.list;
    }
  } catch (error) {
    console.error('加载推送日志失败:', error);
  } finally {
    logsLoading.value = false;
  }
};

// 建立WebSocket连接
const connectWebSocket = () => {
  const wsUrl = 'ws://localhost:8080/ws/push-logs'; // 根据实际情况修改
  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    console.log('WebSocket连接已建立');
    wsConnected.value = true;
  };

  ws.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      // 新日志插入到列表顶部
      pushLogs.value.unshift(data);
      // 保持最多20条日志
      if (pushLogs.value.length > 20) {
        pushLogs.value.pop();
      }
    } catch (error) {
      console.error('解析WebSocket消息失败:', error);
    }
  };

  ws.onerror = (error) => {
    console.error('WebSocket错误:', error);
    wsConnected.value = false;
  };

  ws.onclose = () => {
    console.log('WebSocket连接已关闭');
    wsConnected.value = false;
    // 5秒后尝试重连
    reconnectTimer = setTimeout(() => {
      connectWebSocket();
    }, 5000);
  };
};

// 清空日志
const clearLogs = async () => {
  try {
    const response = await subscriptionApi.clearPushLogs();
    if (response.code === 1) {
      pushLogs.value = [];
      message.success('日志已清空');
    }
  } catch (error) {
    message.error('清空日志失败');
  }
};

// 重试推送
const retryPush = async (logId) => {
  try {
    const response = await subscriptionApi.retryPushEvent(logId);
    if (response.code === 1) {
      message.success('重新推送成功');
      loadPushLogs();
    } else {
      message.error(response.msg || '重新推送失败');
    }
  } catch (error) {
    message.error('重新推送失败');
  }
};

const getEventTypeColor = (type) => {
  const map = {
    告警: 'red',
    设备: 'orange',
    AI分析: 'purple',
    系统: 'gray',
    门禁: 'blue',
  };
  return map[type] || 'default';
};

onMounted(() => {
  loadPushLogs();
  connectWebSocket();
});

onUnmounted(() => {
  if (ws) {
    ws.close();
  }
  if (reconnectTimer) {
    clearTimeout(reconnectTimer);
  }
});
</script>

<style scoped lang="less">
.push-logs-container {
  max-height: 400px;
  overflow-y: auto;
}

.push-log-item {
  padding: 8px 0;

  &:hover {
    background-color: #fafafa;
  }
}

.log-time {
  color: #999;
  font-size: 12px;
  min-width: 80px;
}

.log-message {
  color: #333;
  font-size: 14px;
}

.empty-logs {
  text-align: center;
  padding: 40px 0;
}
</style>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/subscription-mock-data.js
export const mockSubscriptionList = [
  {
    id: 1,
    subscriptionName: '人员闯入告警订阅',
    description: '当检测到人员闯入限制区域时推送告警',
    module: 'ivs',
    eventType: 'alarm',
    notificationTypes: ['email', 'sms', 'popup'],
    conditions: {
      区域: '办公区域, 生产区域',
      时间: '22:00 - 06:00',
      级别: '高, 紧急',
    },
    status: 'active',
    lastPushTime: '2024-01-30 14:23:15',
    pushCount: 23,
    deviceIds: [1, 2, 3],
    areas: ['办公区域', '生产区域'],
    timeRange: ['22:00', '06:00'],
    alarmLevels: ['high', 'critical'],
    confidenceThreshold: 85,
    emailConfig: {
      recipients: ['admin@example.com', 'security@example.com'],
    },
    smsConfig: {
      recipients: ['13800138000', '13900139000'],
    },
    pushFrequency: 'realtime',
    retryEnabled: true,
    maxRetryCount: 3,
    enabled: true,
    createTime: '2024-01-15 10:30:00',
    updateTime: '2024-01-30 14:23:15',
  },
  {
    id: 2,
    subscriptionName: '设备离线通知订阅',
    description: '监控设备状态变化，及时推送离线告警',
    module: 'ivs',
    eventType: 'device',
    notificationTypes: ['sms', 'popup'],
    conditions: {
      设备: '全部摄像头',
      条件: '离线超过5分钟',
    },
    status: 'active',
    lastPushTime: '2024-01-30 13:45:22',
    pushCount: 8,
    deviceIds: [],
    areas: [],
    smsConfig: {
      recipients: ['13800138000'],
    },
    pushFrequency: 'realtime',
    retryEnabled: true,
    maxRetryCount: 3,
    enabled: true,
    createTime: '2024-01-16 09:00:00',
    updateTime: '2024-01-30 13:45:22',
  },
  {
    id: 3,
    subscriptionName: '异常行为分析订阅',
    description: 'AI检测到的异常行为实时推送分析结果',
    module: 'ivs',
    eventType: 'ai',
    notificationTypes: ['email', 'wechat'],
    conditions: {
      行为: '倒地, 徘徊, 斗殴',
      置信度: '> 85%',
      区域: '重点监控区域',
    },
    status: 'active',
    lastPushTime: '2024-01-30 12:18:45',
    pushCount: 15,
    confidenceThreshold: 85,
    emailConfig: {
      recipients: ['admin@example.com'],
    },
    wechatConfig: {
      recipients: ['user1', 'user2'],
    },
    pushFrequency: 'realtime',
    retryEnabled: true,
    maxRetryCount: 3,
    enabled: true,
    createTime: '2024-01-17 14:20:00',
    updateTime: '2024-01-30 12:18:45',
  },
  {
    id: 4,
    subscriptionName: '门禁异常事件订阅',
    description: '门禁系统异常开门、尾随等事件推送',
    module: 'access',
    eventType: 'alarm',
    notificationTypes: ['popup', 'wechat'],
    conditions: {
      事件: '尾随, 强行开门',
      门禁: '全部重要门禁',
    },
    status: 'error',
    lastPushTime: '2024-01-30 08:30:12',
    pushCount: 45,
    wechatConfig: {
      recipients: ['user1'],
    },
    pushFrequency: 'realtime',
    retryEnabled: true,
    maxRetryCount: 3,
    enabled: true,
    createTime: '2024-01-18 11:10:00',
    updateTime: '2024-01-30 08:30:12',
  },
  {
    id: 5,
    subscriptionName: '系统状态监控订阅',
    description: '系统CPU、内存、磁盘等资源状态监控',
    module: 'system',
    eventType: 'system',
    notificationTypes: ['email'],
    conditions: {
      指标: 'CPU > 80%, 内存 > 90%',
      频率: '每小时汇总',
    },
    status: 'paused',
    lastPushTime: '2024-01-29 18:00:00',
    pushCount: 126,
    emailConfig: {
      recipients: ['ops@example.com'],
    },
    pushFrequency: 'daily',
    retryEnabled: false,
    enabled: false,
    createTime: '2024-01-10 08:00:00',
    updateTime: '2024-01-29 18:00:00',
  },
];

export const mockPushLogs = [
  {
    id: 1,
    subscriptionId: 1,
    eventType: '告警',
    message: '人员闯入告警已推送到邮件和短信 - CAM001检测到人员闯入办公区域',
    status: 'success',
    pushTime: '14:23:15',
    notificationType: 'email',
    recipient: 'admin@example.com',
  },
  {
    id: 2,
    subscriptionId: 2,
    eventType: '设备',
    message: '设备离线通知已推送到弹窗 - 摄像头023连接超时',
    status: 'success',
    pushTime: '14:20:33',
    notificationType: 'popup',
  },
  {
    id: 3,
    subscriptionId: 3,
    eventType: 'AI分析',
    message: '异常行为分析已推送到邮件和微信 - CAM045检测到倒地行为，置信度92%',
    status: 'success',
    pushTime: '14:18:45',
    notificationType: 'email',
    recipient: 'admin@example.com',
  },
  {
    id: 4,
    subscriptionId: 4,
    eventType: '门禁',
    message: '门禁异常事件已推送到弹窗和微信 - 后门检测到尾随行为',
    status: 'failed',
    pushTime: '14:15:22',
    notificationType: 'wechat',
    errorMessage: '微信推送失败：接口超时',
  },
  {
    id: 5,
    subscriptionId: 1,
    eventType: '告警',
    message: '异常聚集告警已推送到邮件 - CAM015检测到大厅区域人员异常聚集',
    status: 'success',
    pushTime: '14:12:08',
    notificationType: 'email',
    recipient: 'admin@example.com',
  },
];

export const mockEventTypes = {
  ivs: [
    { value: 'alarm', label: '告警事件' },
    { value: 'device', label: '设备事件' },
    { value: 'ai', label: 'AI分析事件' },
  ],
  access: [
    { value: 'alarm', label: '告警事件' },
    { value: 'device', label: '设备事件' },
  ],
  alarm: [
    { value: 'alarm', label: '告警事件' },
  ],
  system: [
    { value: 'system', label: '系统事件' },
  ],
};

export const mockStats = {
  totalSubscriptions: 48,
  activeSubscriptions: 42,
  todayPushCount: 1247,
  errorSubscriptions: 3,
};

// Mock API实现
export default {
  // 查询订阅列表
  mockQuerySubscriptionList: (params) => {
    let list = [...mockSubscriptionList];

    // 筛选条件
    if (params.module) {
      list = list.filter(item => item.module === params.module);
    }

    if (params.status) {
      list = list.filter(item => item.status === params.status);
    }

    if (params.eventType) {
      list = list.filter(item => item.eventType === params.eventType);
    }

    if (params.keyword) {
      list = list.filter(item =>
        item.subscriptionName.includes(params.keyword) ||
        item.description.includes(params.keyword)
      );
    }

    // 分页
    const pageNum = params.pageNum || 1;
    const pageSize = params.pageSize || 10;
    const total = list.length;
    const start = (pageNum - 1) * pageSize;
    const end = start + pageSize;

    return {
      code: 1,
      msg: '查询成功',
      data: {
        list: list.slice(start, end),
        total,
        pageNum,
        pageSize,
      },
    };
  },

  // 获取统计信息
  mockGetSubscriptionStats: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockStats,
    };
  },

  // 获取推送日志
  mockGetPushLogs: (params) => {
    const pageNum = params.pageNum || 1;
    const pageSize = params.pageSize || 20;
    const total = mockPushLogs.length;
    const start = (pageNum - 1) * pageSize;
    const end = start + pageSize;

    return {
      code: 1,
      msg: '查询成功',
      data: {
        list: mockPushLogs.slice(start, end),
        total,
        pageNum,
        pageSize,
      },
    };
  },

  // 获取事件类型列表
  mockGetEventTypeList: (module) => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockEventTypes[module] || [],
    };
  },
};
```

## 路由配置

### ✅ 正确的路由配置
```javascript
// src/router/business/smart-video.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/event-subscription',
        name: 'SmartVideoEventSubscription',
        component: () => import('/@/views/business/smart-video/event-subscription.vue'),
        meta: {
          title: '智能视频 - 事件订阅',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'BellOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

### ✅ 主路由文件集成
```javascript
// src/router/routers.js
import { smartVideoRouters } from './business/smart-video';

export const routerArray = [
  // ...其他路由
  ...smartVideoRouters,
  // ...更多路由
];
```

## 菜单配置

### ✅ 动态菜单注入
```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  // 智能视频父菜单
  const smartVideoMenu = {
    menuId: maxMenuId + 1000,
    menuName: '智能视频',
    menuTitle: '智能视频',
    menuType: MENU_TYPE_ENUM.CATALOG.value,
    parentId: 0,
    path: '/business/smart-video',
    icon: 'VideoCameraOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: false,
    frameFlag: false,
    frameUrl: '',
    sort: 10,
    updateTime: new Date().toISOString(),
  };

  // 事件订阅子菜单
  const eventSubscriptionMenu = {
    menuId: maxMenuId + 1005,
    menuName: '事件订阅',
    menuTitle: '事件订阅',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/event-subscription',
    component: '/business/smart-video/event-subscription.vue',
    icon: 'BellOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 5,
    updateTime: new Date().toISOString(),
  };

  menuList.push(smartVideoMenu, eventSubscriptionMenu);
  return smartVideoMenu.menuId;
}
```

## Pinia Store状态管理

```javascript
// src/store/modules/business/subscription.js
import { defineStore } from 'pinia';
import { message } from 'ant-design-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

export const useSubscriptionStore = defineStore('subscription', {
  state: () => ({
    subscriptionList: [],
    stats: {
      totalSubscriptions: 0,
      activeSubscriptions: 0,
      todayPushCount: 0,
      errorSubscriptions: 0,
    },
    pushLogs: [],
    loading: false,
    currentSubscription: null,
  }),

  getters: {
    activeSubscriptionCount(state) {
      return state.subscriptionList.filter(s => s.status === 'active').length;
    },

    errorSubscriptionCount(state) {
      return state.subscriptionList.filter(s => s.status === 'error').length;
    },

    moduleStats(state) {
      const stats = {};
      state.subscriptionList.forEach(sub => {
        stats[sub.module] = (stats[sub.module] || 0) + 1;
      });
      return stats;
    },
  },

  actions: {
    async fetchSubscriptionList(params = {}, useMock = true) {
      this.loading = true;
      try {
        let response;
        if (useMock) {
          const subscriptionMockData = await import('/@/views/business/smart-video/mock/subscription-mock-data');
          response = subscriptionMockData.default.mockQuerySubscriptionList(params);
        } else {
          response = await subscriptionApi.querySubscriptionList(params);
        }

        if (response.code === 1) {
          this.subscriptionList = response.data.list;
          return response.data;
        } else {
          message.error(response.msg || '获取数据失败');
          return null;
        }
      } catch (error) {
        console.error('获取订阅列表失败:', error);
        message.error('获取数据失败');
        return null;
      } finally {
        this.loading = false;
      }
    },

    async fetchStats(useMock = true) {
      try {
        let response;
        if (useMock) {
          const subscriptionMockData = await import('/@/views/business/smart-video/mock/subscription-mock-data');
          response = subscriptionMockData.default.mockGetSubscriptionStats();
        } else {
          response = await subscriptionApi.getSubscriptionStats();
        }

        if (response.code === 1) {
          this.stats = response.data;
          return response.data;
        }
      } catch (error) {
        console.error('获取统计信息失败:', error);
        return null;
      }
    },

    async fetchPushLogs(params = {}, useMock = true) {
      try {
        let response;
        if (useMock) {
          const subscriptionMockData = await import('/@/views/business/smart-video/mock/subscription-mock-data');
          response = subscriptionMockData.default.mockGetPushLogs(params);
        } else {
          response = await subscriptionApi.getPushLogs(params);
        }

        if (response.code === 1) {
          this.pushLogs = response.data.list;
          return response.data;
        }
      } catch (error) {
        console.error('获取推送日志失败:', error);
        return null;
      }
    },

    async addSubscription(subscriptionData) {
      try {
        const response = await subscriptionApi.addSubscription(subscriptionData);
        if (response.code === 1) {
          message.success('添加订阅成功');
          return true;
        } else {
          message.error(response.msg || '添加订阅失败');
          return false;
        }
      } catch (error) {
        console.error('添加订阅失败:', error);
        message.error('添加订阅失败');
        return false;
      }
    },

    async updateSubscription(subscriptionData) {
      try {
        const response = await subscriptionApi.updateSubscription(subscriptionData);
        if (response.code === 1) {
          message.success('更新订阅成功');
          return true;
        } else {
          message.error(response.msg || '更新订阅失败');
          return false;
        }
      } catch (error) {
        console.error('更新订阅失败:', error);
        message.error('更新订阅失败');
        return false;
      }
    },

    async deleteSubscription(subscriptionId) {
      try {
        const response = await subscriptionApi.deleteSubscription(subscriptionId);
        if (response.code === 1) {
          message.success('删除订阅成功');
          return true;
        } else {
          message.error(response.msg || '删除订阅失败');
          return false;
        }
      } catch (error) {
        console.error('删除订阅失败:', error);
        message.error('删除订阅失败');
        return false;
      }
    },

    setCurrentSubscription(subscription) {
      this.currentSubscription = subscription;
    },
  },
});
```

## 常见错误排查清单

### 1. 控制台报错排查
- [ ] 图标导入错误：检查 `@ant-design/icons-vue` 中是否存在该图标
- [ ] API导入错误：确认导入路径是否为 `/@/lib/axios`
- [ ] v-model错误：检查是否在props上使用了v-model
- [ ] WebSocket连接错误：确认WebSocket服务地址和端口是否正确

### 2. 页面无法访问排查
- [ ] 路由配置：检查路由是否正确添加到 `routerArray`
- [ ] 菜单配置：检查菜单是否正确注入到菜单列表
- [ ] 组件路径：确认组件路径是否正确
- [ ] 文件存在：确认所有引用的组件文件都存在

### 3. 功能异常排查
- [ ] Store状态：检查Pinia store是否正确定义和使用
- [ ] API调用：确认API接口路径和参数是否正确
- [ ] 数据格式：检查mock数据格式是否符合预期
- [ ] 事件绑定：确认事件监听器是否正确绑定
- [ ] 表单验证：确保表单规则配置正确

### 4. 订阅功能相关排查
- [ ] 通知配置：确保邮箱、手机号等格式正确
- [ ] 推送测试：验证通知渠道配置是否正确
- [ ] 实时日志：检查WebSocket连接是否正常
- [ ] 订阅条件：确保条件配置符合业务逻辑

## 最佳实践总结

### ✅ 推荐的开发流程
1. **先创建基础组件** - 确保每个组件可以独立运行
2. **逐步集成功能** - 从简单到复杂，逐步添加功能
3. **Mock数据优先** - 先用mock数据开发，后期对接真实API
4. **及时测试验证** - 每添加一个功能就进行测试
5. **遵循项目规范** - 使用项目既定的命名和结构规范

### ✅ 代码质量保证
1. **使用TypeScript类型检查**（如果项目支持）
2. **遵循ESLint和Prettier规范**
3. **编写单元测试**（重要功能）
4. **添加适当的注释**，特别是复杂逻辑
5. **保持组件单一职责**，避免过度复杂

### ✅ 性能优化建议
1. **使用懒加载**：路由和组件按需加载
2. **合理使用computed和watch**
3. **避免不必要的重新渲染**
4. **WebSocket连接管理**：合理处理连接/断开/重连
5. **日志数量控制**：限制实时日志显示数量，避免内存泄漏

### ✅ 安全性建议
1. **敏感配置加密**：邮箱、手机号等敏感信息加密传输
2. **Webhook签名验证**：确保Webhook请求来源可信
3. **推送频率限制**：防止恶意触发大量推送
4. **权限控制**：确保用户只能操作自己权限范围内的订阅
5. **日志脱敏**：推送日志中避免显示敏感信息

## 特殊功能实现说明

### 1. 订阅测试功能
```javascript
// 测试订阅推送
const testSubscription = async (subscriptionId) => {
  const modal = Modal.info({
    title: '正在测试推送...',
    content: '正在向配置的通知渠道发送测试消息，请稍候...',
    okText: '停止测试',
  });

  try {
    const response = await subscriptionApi.testSubscription({
      subscriptionId,
      testMessage: '这是一条测试推送消息',
    });

    modal.destroy();

    if (response.code === 1) {
      const results = response.data;
      // 显示测试结果
      Modal.success({
        title: '测试完成',
        content: h('div', [
          h('p', '测试结果：'),
          ...results.map(r =>
            h('div', { style: { marginTop: '8px' } }, [
              h('span', `${r.type}: `),
              h('span', {
                style: { color: r.success ? '#52c41a' : '#ff4d4f' }
              }, r.success ? '成功' : '失败'),
              r.message && h('span', { style: { marginLeft: '8px', color: '#999' } }, `(${r.message})`),
            ])
          ),
        ]),
      });
    } else {
      message.error(response.msg || '测试失败');
    }
  } catch (error) {
    modal.destroy();
    message.error('测试失败');
  }
};
```

### 2. 批量导入订阅规则
```vue
<template>
  <a-upload
    name="file"
    :before-upload="beforeUpload"
    :show-upload-list="false"
  >
    <a-button>
      <template #icon><UploadOutlined /></template>
      选择文件
    </a-button>
  </a-upload>
</template>

<script setup>
import { message } from 'ant-design-vue';
import { UploadOutlined } from '@ant-design/icons-vue';
import { subscriptionApi } from '/@/api/business/smart-video/subscription-api';

const beforeUpload = (file) => {
  const isJson = file.type === 'application/json';
  const isExcel = file.type === 'application/vnd.ms-excel' ||
                  file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

  if (!isJson && !isExcel) {
    message.error('只能上传JSON或Excel文件！');
    return false;
  }

  const formData = new FormData();
  formData.append('file', file);

  message.loading('正在导入订阅规则...', 0);

  subscriptionApi.importSubscriptions(formData)
    .then(response => {
      message.destroy();
      if (response.code === 1) {
        message.success(`成功导入 ${response.data.successCount} 个订阅规则`);
        queryData();
      } else {
        message.error(response.msg || '导入失败');
      }
    })
    .catch(error => {
      message.destroy();
      message.error('导入失败');
    });

  return false; // 阻止默认上传
};
</script>
```

### 3. WebSocket实时推送
```javascript
// WebSocket消息处理
class PushLogService {
  constructor() {
    this.ws = null;
    this.reconnectTimer = null;
    this.reconnectDelay = 5000;
    this.maxReconnectAttempts = 10;
    this.reconnectAttempts = 0;
    this.callbacks = new Set();
  }

  connect(url) {
    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
      console.log('WebSocket已连接');
      return;
    }

    this.ws = new WebSocket(url);

    this.ws.onopen = () => {
      console.log('WebSocket连接成功');
      this.reconnectAttempts = 0;
      this.notifyCallbacks('connected', true);
    };

    this.ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        this.notifyCallbacks('message', data);
      } catch (error) {
        console.error('解析WebSocket消息失败:', error);
      }
    };

    this.ws.onerror = (error) => {
      console.error('WebSocket错误:', error);
      this.notifyCallbacks('connected', false);
    };

    this.ws.onclose = () => {
      console.log('WebSocket连接关闭');
      this.notifyCallbacks('connected', false);
      this.attemptReconnect(url);
    };
  }

  attemptReconnect(url) {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('WebSocket重连次数已达上限');
      return;
    }

    this.reconnectAttempts++;
    console.log(`尝试重连 (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);

    this.reconnectTimer = setTimeout(() => {
      this.connect(url);
    }, this.reconnectDelay);
  }

  disconnect() {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer);
      this.reconnectTimer = null;
    }

    if (this.ws) {
      this.ws.close();
      this.ws = null;
    }
  }

  subscribe(callback) {
    this.callbacks.add(callback);
  }

  unsubscribe(callback) {
    this.callbacks.delete(callback);
  }

  notifyCallbacks(type, data) {
    this.callbacks.forEach(callback => {
      callback(type, data);
    });
  }

  send(data) {
    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(data));
    } else {
      console.error('WebSocket未连接');
    }
  }
}

// 使用示例
const pushLogService = new PushLogService();

onMounted(() => {
  pushLogService.connect('ws://localhost:8080/ws/push-logs');

  pushLogService.subscribe((type, data) => {
    if (type === 'connected') {
      wsConnected.value = data;
    } else if (type === 'message') {
      // 处理新日志
      pushLogs.value.unshift(data);
      if (pushLogs.value.length > 20) {
        pushLogs.value.pop();
      }
    }
  });
});

onUnmounted(() => {
  pushLogService.disconnect();
});
```

## 总结

通过遵循本文档的技术规范和注意事项，可以有效避免开发过程中的常见错误，确保事件订阅管理页面能够顺利开发和部署。

关键要点：
- ✅ **避免在props上使用v-model**，改用属性绑定和事件监听
- ✅ **验证图标存在性**，使用实际存在于`@ant-design/icons-vue`中的图标
- ✅ **使用正确的API导入路径**：`/@/lib/axios`
- ✅ **标准化订阅类型和状态**，使用枚举常量定义
- ✅ **完善的表单验证**，特别是通知配置的格式验证
- ✅ **实现推送测试功能**，确保通知配置正确后再保存
- ✅ **支持多种通知方式**，提高事件推送的灵活性
- ✅ **WebSocket实时日志**，提供良好的监控体验
- ✅ **完善的错误处理**，包括重连机制和失败重试
- ✅ **安全性考虑**，对敏感信息进行加密和脱敏处理

通过这些规范和最佳实践，可以确保开发过程顺利进行，减少调试时间，提高开发效率，并为用户提供稳定可靠的事件订阅服务。
