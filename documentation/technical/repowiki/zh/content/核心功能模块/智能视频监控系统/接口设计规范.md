# IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å° - æ™ºèƒ½è§†é¢‘ç›‘æ§ç³»ç»Ÿæ¥å£è®¾è®¡è§„èŒƒ

> **RESTful API Â· ç»Ÿä¸€æ ‡å‡† Â· å®‰å…¨è®¤è¯**
> **æ›´æ–°æ—¶é—´**: 2025-11-13
> **ç‰ˆæœ¬**: v4.0
> **æ–‡æ¡£ç±»å‹**: æ¥å£è®¾è®¡è§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

### APIæ¶æ„æˆ˜ç•¥æ„ä¹‰

**æ™ºèƒ½è§†é¢‘ç›‘æ§ç³»ç»ŸAPI**æ˜¯IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°çš„æ ¸å¿ƒæœåŠ¡æ¥å£ï¼Œéµå¾ªRESTfulæ¶æ„è®¾è®¡è§„èŒƒï¼Œæä¾›ç»Ÿä¸€ã€å®‰å…¨ã€é«˜æ€§èƒ½çš„æœåŠ¡è®¿é—®èƒ½åŠ›ã€‚æ‰€æœ‰æ¥å£å‡é›†æˆ5çº§å®‰å…¨ä½“ç³»æƒé™æ§åˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§ã€‚

#### è®¾è®¡ç›®æ ‡
- **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€APIè®¾è®¡è§„èŒƒå’Œå“åº”æ ¼å¼
- **å®‰å…¨æ€§**ï¼šé›†æˆ5çº§å®‰å…¨ä½“ç³»çš„æƒé™æ§åˆ¶
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç‰ˆæœ¬ç®¡ç†å’ŒåŠŸèƒ½æ‰©å±•
- **é«˜æ€§èƒ½**ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½å’Œå“åº”é€Ÿåº¦
- **æ˜“ç”¨æ€§**ï¼šç®€æ´ç›´è§‚çš„æ¥å£è®¾è®¡å’Œæ–‡æ¡£

## ğŸŒ APIæ¶æ„è®¾è®¡

### 1. æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        WEB[Webç®¡ç†ç«¯]
        APP[ç§»åŠ¨åº”ç”¨]
        DESKTOP[æ¡Œé¢å®¢æˆ·ç«¯]
        API[ç¬¬ä¸‰æ–¹åº”ç”¨]
    end

    subgraph "APIç½‘å…³å±‚"
        GATEWAY[APIç½‘å…³<br/>è´Ÿè½½å‡è¡¡/é™æµ/è®¤è¯]
        MONITOR[ç›‘æ§ä¸­å¿ƒ<br/>æ€§èƒ½ç›‘æ§/æ—¥å¿—æ”¶é›†]
        CACHE[ç¼“å­˜å±‚<br/>Redisé›†ç¾¤]
    end

    subgraph "æœåŠ¡å±‚"
        DEVICE[è®¾å¤‡ç®¡ç†æœåŠ¡]
        MONITOR[å®æ—¶ç›‘æ§æœåŠ¡]
        RECORD[å½•åƒå›æ”¾æœåŠ¡]
        ALARM[å‘Šè­¦ç®¡ç†æœåŠ¡]
        ANALYSIS[æ™ºèƒ½åˆ†ææœåŠ¡]
        WALL[è§£ç ä¸Šå¢™æœåŠ¡]
        MESSAGE[æ¶ˆæ¯ä¸­å¿ƒæœåŠ¡]
        SYSTEM[ç³»ç»Ÿç®¡ç†æœåŠ¡]
    end

    subgraph "æ•°æ®å±‚"
        MASTER[ä¸»æ•°æ®åº“<br/>PostgreSQL]
        SLAVE1[ä»åº“1<br/>è¯»æ“ä½œ]
        SLAVE2[ä»åº“2<br/>è¯»æ“ä½œ]
        REDIS[Redisé›†ç¾¤<br/>ç¼“å­˜/ä¼šè¯]
        STORAGE[å¯¹è±¡å­˜å‚¨<br/>æ–‡ä»¶/å›¾ç‰‡/å½•åƒ]
    end

    WEB --> GATEWAY
    APP --> GATEWAY
    DESKTOP --> GATEWAY
    API --> GATEWAY

    GATEWAY --> MONITOR
    GATEWAY --> CACHE

    GATEWAY --> DEVICE
    GATEWAY --> MONITOR
    GATEWAY --> RECORD
    GATEWAY --> ALARM
    GATEWAY --> ANALYSIS
    GATEWAY --> WALL
    GATEWAY --> MESSAGE
    GATEWAY --> SYSTEM

    DEVICE --> MASTER
    MONITOR --> MASTER
    RECORD --> MASTER
    ALARM --> MASTER
    ANALYSIS --> MASTER
    WALL --> MASTER
    MESSAGE --> MASTER
    SYSTEM --> MASTER

    MASTER -.->|æ•°æ®åŒæ­¥| SLAVE1
    MASTER -.->|æ•°æ®åŒæ­¥| SLAVE2

    CACHE --> REDIS
    RECORD --> STORAGE
    MONITOR --> STORAGE
    ALARM --> STORAGE
```

### 2. APIç‰ˆæœ¬ç®¡ç†

#### URLç‰ˆæœ¬è§„èŒƒ
```
https://api.example.com/ivs/{version}/{module}/{resource}

ç¤ºä¾‹ï¼š
https://api.example.com/ivs/v1/device
https://api.example.com/ivs/v1/monitor/stream
https://api.example.com/ivs/v2/device           # æ–°ç‰ˆæœ¬æ¥å£
```

#### ç‰ˆæœ¬å…¼å®¹æ€§ç­–ç•¥
- **ä¸»ç‰ˆæœ¬**ï¼šv1.x, v2.x - å¯èƒ½åŒ…å«ä¸å…¼å®¹çš„APIå˜æ›´
- **æ¬¡ç‰ˆæœ¬**ï¼šv1.1, v1.2 - å‘åå…¼å®¹ï¼Œæ–°å¢åŠŸèƒ½
- **ç‰ˆæœ¬æ”¯æŒ**ï¼šæ¯ä¸ªä¸»ç‰ˆæœ¬è‡³å°‘ç»´æŠ¤12ä¸ªæœˆ
- **åºŸå¼ƒé€šçŸ¥**ï¼šAPIåºŸå¼ƒå‰æå‰6ä¸ªæœˆé€šçŸ¥

## ğŸ“‹ é€šç”¨è®¾è®¡è§„èŒƒ

### 1. URLè®¾è®¡è§„èŒƒ

#### RESTful URLæ¨¡å¼
| HTTPæ–¹æ³• | URLæ¨¡å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|----------|----------|------|------|
| GET | /ivs/v1/{resource} | è·å–èµ„æºåˆ—è¡¨ | GET /ivs/v1/device |
| GET | /ivs/v1/{resource}/{id} | è·å–å•ä¸ªèµ„æº | GET /ivs/v1/device/123 |
| POST | /ivs/v1/{resource} | åˆ›å»ºèµ„æº | POST /ivs/v1/device |
| PUT | /ivs/v1/{resource}/{id} | æ›´æ–°å®Œæ•´èµ„æº | PUT /ivs/v1/device/123 |
| PATCH | /ivs/v1/{resource}/{id} | éƒ¨åˆ†æ›´æ–°èµ„æº | PATCH /ivs/v1/device/123 |
| DELETE | /ivs/v1/{resource}/{id} | åˆ é™¤èµ„æº | DELETE /ivs/v1/device/123 |

#### åµŒå¥—èµ„æºè®¾è®¡
```
è®¾å¤‡ä¸‹çš„é…ç½®ï¼š/ivs/v1/device/{deviceId}/config
è®¾å¤‡çš„é€šé“ï¼š/ivs/v1/device/{deviceId}/channel
å½•åƒçš„ç‰‡æ®µï¼š/ivs/v1/record/{recordId}/segment
å‘Šè­¦çš„å¤„ç†ï¼š/ivs/v1/alarm/{alarmId}/process
```

### 2. HTTPçŠ¶æ€ç è§„èŒƒ

| çŠ¶æ€ç  | åˆ†ç±» | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|------|----------|
| 200 | æˆåŠŸ | è¯·æ±‚æˆåŠŸ | æŸ¥è¯¢æˆåŠŸã€æ›´æ–°æˆåŠŸ |
| 201 | æˆåŠŸ | èµ„æºåˆ›å»ºæˆåŠŸ | æ–°å¢è®¾å¤‡ã€åˆ›å»ºè§„åˆ™ |
| 204 | æˆåŠŸ | æ— å†…å®¹è¿”å› | åˆ é™¤æˆåŠŸã€æŸäº›æ›´æ–° |
| 400 | å®¢æˆ·ç«¯é”™è¯¯ | è¯·æ±‚å‚æ•°é”™è¯¯ | å‚æ•°æ ¼å¼é”™è¯¯ã€å¿…å¡«å‚æ•°ç¼ºå¤± |
| 401 | å®¢æˆ·ç«¯é”™è¯¯ | æœªè®¤è¯ | Tokenæ— æ•ˆã€Tokenè¿‡æœŸ |
| 403 | å®¢æˆ·ç«¯é”™è¯¯ | æ— æƒé™ | å®‰å…¨çº§åˆ«ä¸è¶³ã€åŠŸèƒ½æƒé™ä¸è¶³ |
| 404 | å®¢æˆ·ç«¯é”™è¯¯ | èµ„æºä¸å­˜åœ¨ | è®¾å¤‡IDä¸å­˜åœ¨ã€èµ„æºå·²åˆ é™¤ |
| 409 | å®¢æˆ·ç«¯é”™è¯¯ | èµ„æºå†²çª | è®¾å¤‡ç¼–å·é‡å¤ã€çŠ¶æ€å†²çª |
| 422 | å®¢æˆ·ç«¯é”™è¯¯ | è¯·æ±‚å‚æ•°éªŒè¯å¤±è´¥ | å‚æ•°æ ¡éªŒå¤±è´¥ |
| 429 | å®¢æˆ·ç«¯é”™è¯¯ | è¯·æ±‚é¢‘ç‡é™åˆ¶ | APIè°ƒç”¨é¢‘ç‡è¶…é™ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æ•°æ®åº“å¼‚å¸¸ã€æœåŠ¡å¼‚å¸¸ |
| 503 | æœåŠ¡å™¨é”™è¯¯ | æœåŠ¡ä¸å¯ç”¨ | æœåŠ¡ç»´æŠ¤ä¸­ã€ä¾èµ–æœåŠ¡å¼‚å¸¸ |

### 3. å“åº”æ ¼å¼è§„èŒƒ

#### 3.1 é€šç”¨å“åº”ç»“æ„

```json
{
    "code": 200,
    "message": "æ“ä½œæˆåŠŸ",
    "data": {},
    "timestamp": "2024-01-15T10:30:25Z",
    "requestId": "abc123def456",
    "traceId": "trace-123456"
}
```

#### 3.2 å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| code | Integer | æ˜¯ | HTTPçŠ¶æ€ç æˆ–ä¸šåŠ¡çŠ¶æ€ç  |
| message | String | æ˜¯ | å“åº”æ¶ˆæ¯ |
| data | Object | å¦ | å“åº”æ•°æ® |
| timestamp | String | æ˜¯ | å“åº”æ—¶é—´æˆ³(ISO 8601æ ¼å¼) |
| requestId | String | æ˜¯ | è¯·æ±‚å”¯ä¸€æ ‡è¯† |
| traceId | String | å¦ | åˆ†å¸ƒå¼è¿½è¸ªID |

#### 3.3 æˆåŠŸå“åº”ç¤ºä¾‹

```json
{
    "code": 200,
    "message": "è·å–è®¾å¤‡åˆ—è¡¨æˆåŠŸ",
    "data": {
        "list": [
            {
                "id": 1,
                "deviceName": "æ‘„åƒå¤´001",
                "status": "online"
            }
        ],
        "pagination": {
            "currentPage": 1,
            "pageSize": 20,
            "total": 100,
            "totalPages": 5
        }
    },
    "timestamp": "2024-01-15T10:30:25Z",
    "requestId": "req-123456"
}
```

#### 3.4 é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
    "code": 400,
    "message": "å‚æ•°éªŒè¯å¤±è´¥",
    "error": {
        "type": "VALIDATION_ERROR",
        "code": "DEVICE_NAME_REQUIRED",
        "message": "è®¾å¤‡åç§°ä¸èƒ½ä¸ºç©º",
        "details": [
            {
                "field": "deviceName",
                "message": "è®¾å¤‡åç§°ä¸èƒ½ä¸ºç©º"
            }
        ]
    },
    "timestamp": "2024-01-15T10:30:25Z",
    "requestId": "req-123456"
}
```

### 4. è¯·æ±‚å¤´è§„èŒƒ

#### 4.1 è®¤è¯å¤´
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 4.2 é€šç”¨è¯·æ±‚å¤´
```
Content-Type: application/json;charset=UTF-8
Accept: application/json
Accept-Language: zh-CN
X-Request-ID: abc123def456
X-Client-Version: 1.0.0
X-Client-Type: web/ios/android/desktop
```

#### 4.3 æ¡ä»¶è¯·æ±‚å¤´
```
If-Modified-Since: Mon, 15 Jan 2024 10:30:25 GMT
If-None-Match: "abc123def456"
Accept-Encoding: gzip, deflate, br
```

## ğŸ” å®‰å…¨è®¤è¯è§„èŒƒ

### 1. JWT Tokenè®¤è¯

#### 1.1 Tokenç»“æ„
```json
{
    "header": {
        "alg": "HS256",
        "typ": "JWT"
    },
    "payload": {
        "userId": 1001,
        "userName": "admin",
        "userLevel": 5,
        "permissions": ["device:manage", "alarm:confirm"],
        "expireTime": 1703123456789,
        "issueTime": 1703123456789
    },
    "signature": "abc123def456..."
}
```

#### 1.2 Tokenç”Ÿæˆ
```java
// JWT Tokenç”Ÿæˆ
public String generateToken(User user, List<String> permissions) {
    Date now = new Date();
    Date expireTime = new Date(now.getTime() + EXPIRE_TIME);

    Map<String, Object> claims = new HashMap<>();
    claims.put("userId", user.getId());
    claims.put("userName", user.getUserName());
    claims.put("userLevel", user.getSecurityLevel());
    claims.put("permissions", permissions);
    claims.put("expireTime", expireTime.getTime());
    claims.put("issueTime", now.getTime());

    return Jwts.builder()
            .setClaims(claims)
            .setSubject(user.getUserName())
            .setIssuedAt(now)
            .setExpiration(expireTime)
            .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
            .compact();
}
```

### 2. æƒé™æ§åˆ¶å®ç°

#### 2.1 æƒé™æ£€æŸ¥æµç¨‹
```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant A as APIç½‘å…³
    participant S as æœåŠ¡å±‚
    participant P as æƒé™æœåŠ¡
    participant D as æ•°æ®å±‚

    C->>A: å¸¦Tokençš„è¯·æ±‚
    A->>A: TokenéªŒè¯
    A->>P: æƒé™æ£€æŸ¥
    P->>D: æŸ¥è¯¢ç”¨æˆ·æƒé™
    D-->>P: è¿”å›æƒé™ä¿¡æ¯
    P-->>A: æƒé™æ£€æŸ¥ç»“æœ
    alt æƒé™é€šè¿‡
        A->>S: è½¬å‘è¯·æ±‚
        S->>D: å¤„ç†ä¸šåŠ¡
        D-->>S: è¿”å›ç»“æœ
        S-->>A: å“åº”æ•°æ®
        A-->>C: æˆåŠŸå“åº”
    else æƒé™æ‹’ç»
        A-->>C: 403 Forbidden
    end
```

#### 2.2 æƒé™æ³¨è§£å®ç°
```java
/**
 * æƒé™æ§åˆ¶æ³¨è§£
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface PermissionCheck {
    /**
     * å®‰å…¨çº§åˆ«è¦æ±‚
     */
    int securityLevel() default 1;

    /**
     * åŠŸèƒ½æƒé™ä»£ç 
     */
    String[] permissions() default {};

    /**
     * æ•°æ®æƒé™ç±»å‹
     */
    String dataPermission() default "";
}

/**
 * æƒé™åˆ‡é¢
 */
@Aspect
@Component
public class PermissionAspect {

    @Autowired
    private PermissionService permissionService;

    @Around("@annotation(permissionCheck)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, PermissionCheck permissionCheck) throws Throwable {
        // è·å–å½“å‰ç”¨æˆ·
        User currentUser = SecurityUtils.getCurrentUser();

        // æ£€æŸ¥å®‰å…¨çº§åˆ«
        if (currentUser.getSecurityLevel() < permissionCheck.securityLevel()) {
            throw new PermissionDeniedException("å®‰å…¨çº§åˆ«ä¸è¶³");
        }

        // æ£€æŸ¥åŠŸèƒ½æƒé™
        for (String permission : permissionCheck.permissions()) {
            if (!permissionService.hasPermission(currentUser.getId(), permission)) {
                throw new PermissionDeniedException("ç¼ºå°‘åŠŸèƒ½æƒé™: " + permission);
            }
        }

        // æ£€æŸ¥æ•°æ®æƒé™
        if (!permissionCheck.dataPermission().isEmpty()) {
            Object[] args = joinPoint.getArgs();
            Long resourceId = extractResourceId(args);
            if (!permissionService.hasDataPermission(currentUser.getId(),
                    permissionCheck.dataPermission(), resourceId)) {
                throw new PermissionDeniedException("æ— æ•°æ®è®¿é—®æƒé™");
            }
        }

        return joinPoint.proceed();
    }
}
```

## ğŸ“Š æ ¸å¿ƒæ¥å£è®¾è®¡

### 1. è®¾å¤‡ç®¡ç†æ¥å£

#### 1.1 è®¾å¤‡åˆ—è¡¨æŸ¥è¯¢
```
GET /ivs/v1/device

æŸ¥è¯¢å‚æ•°ï¼š
{
    "pageNum": 1,
    "pageSize": 20,
    "deviceName": "æ‘„åƒå¤´",
    "deviceType": "IPC",
    "status": "online",
    "regionId": 1,
    "groupId": 1,
    "sortBy": "createTime",
    "sortOrder": "desc"
}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

#### 1.2 è®¾å¤‡è¯¦æƒ…è·å–
```
GET /ivs/v1/device/{id}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

#### 1.3 æ–°å¢è®¾å¤‡
```
POST /ivs/v1/device

è¯·æ±‚ä½“ï¼š
{
    "deviceName": "æ‘„åƒå¤´001",
    "deviceType": "IPC",
    "ipAddress": "192.168.1.101",
    "port": 554,
    "protocol": "RTSP",
    "username": "admin",
    "password": "admin123",
    "location": "ä¸€æ¥¼å¤§å…",
    "regionId": 1,
    "groupId": 1
}

æƒé™è¦æ±‚ï¼šLevel 3ä»¥ä¸Š
```

### 2. å®æ—¶ç›‘æ§æ¥å£

#### 2.1 è·å–è§†é¢‘æµ
```
GET /ivs/v1/monitor/stream/{deviceId}

æŸ¥è¯¢å‚æ•°ï¼š
{
    "streamType": "main",     // main/sub/event
    "protocol": "rtsp",      // rtsp/rtmp/hls/webrtc
    "expireTime": 3600       // è¿‡æœŸæ—¶é—´(ç§’)
}

æƒé™è¦æ±‚ï¼šLevel 2ä»¥ä¸Š
```

#### 2.2 äº‘å°æ§åˆ¶
```
POST /ivs/v1/monitor/ptz/{deviceId}/control

è¯·æ±‚ä½“ï¼š
{
    "action": "move",              // move/zoom/preset/cruise
    "direction": "up",            // æ–¹å‘(ç§»åŠ¨æ—¶)
    "speed": 5,                  // é€Ÿåº¦(1-10)
    "duration": 1000,            // æŒç»­æ—¶é—´(æ¯«ç§’)
    "zoomType": "in",             // å˜ç„¦ç±»å‹(ç¼©æ”¾æ—¶)
    "presetId": 1,               // é¢„ç½®ä½ID(è°ƒç”¨é¢„ç½®ä½æ—¶)
    "cruiseId": 1                // å·¡èˆªID(å·¡èˆªæ—¶)
}

æƒé™è¦æ±‚ï¼šLevel 2ä»¥ä¸Š
```

#### 2.3 å®æ—¶æˆªå›¾
```
POST /ivs/v1/monitor/snapshot/{deviceId}

è¯·æ±‚ä½“ï¼š
{
    "channelId": 101,
    "format": "jpg",
    "quality": 80,
    "timestamp": "2024-01-15T10:30:25Z"
}

æƒé™è¦æ±‚ï¼šLevel 2ä»¥ä¸Š
```

### 3. å½•åƒå›æ”¾æ¥å£

#### 3.1 å½•åƒæŸ¥è¯¢
```
POST /ivs/v1/record/search

è¯·æ±‚ä½“ï¼š
{
    "deviceId": 1,
    "channelId": 101,
    "startTime": "2024-01-15T00:00:00Z",
    "endTime": "2024-01-15T23:59:59Z",
    "recordType": "all",          // manual/schedule/alarm/motion/all
    "pageNum": 1,
    "pageSize": 20
}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

#### 3.2 è·å–å›æ”¾æµ
```
GET /ivs/v1/record/{recordId}/stream

æŸ¥è¯¢å‚æ•°ï¼š
{
    "format": "rtsp",              // rtsp/hls/mp4
    "startTime": "2024-01-15T10:00:00Z",   // å›æ”¾å¼€å§‹æ—¶é—´
    "expireTime": 3600
}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

#### 3.3 å½•åƒä¸‹è½½
```
POST /ivs/v1/record/download

è¯·æ±‚ä½“ï¼š
{
    "recordIds": [1001, 1002, 1003],
    "format": "mp4",
    "quality": "high",
    "watermark": {
        "timestamp": true,
        "deviceInfo": true
    }
}

æƒé™è¦æ±‚ï¼šLevel 3ä»¥ä¸Š
```

### 4. å‘Šè­¦ç®¡ç†æ¥å£

#### 4.1 å®æ—¶å‘Šè­¦æŸ¥è¯¢
```
GET /ivs/v1/alarm/realtime

æŸ¥è¯¢å‚æ•°ï¼š
{
    "pageNum": 1,
    "pageSize": 20,
    "alarmLevel": "all",          // info/warning/error/critical/all
    "status": "unprocessed"        // unprocessed/processing/processed/all
}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

#### 4.2 å‘Šè­¦ç¡®è®¤
```
POST /ivs/v1/alarm/{alarmId}/confirm

è¯·æ±‚ä½“ï¼š
{
    "note": "å·²ç¡®è®¤å‘Šè­¦ï¼Œæ´¾äººå¤„ç†"
}

æƒé™è¦æ±‚ï¼šLevel 2ä»¥ä¸Š
```

#### 4.3 å‘Šè­¦å¤„ç†
```
POST /ivs/v1/alarm/{alarmId}/process

è¯·æ±‚ä½“ï¼š
{
    "processResult": "resolved",    // resolved/false_alarm/transfer
    "note": "å·²ç¡®è®¤æ˜¯å·¥ä½œäººå‘˜æ­£å¸¸å·¡é€»ï¼Œå·²å¤„ç†å®Œæ¯•"
}

æƒé™è¦æ±‚ï¼šLevel 2ä»¥ä¸Š
```

### 5. æ™ºèƒ½åˆ†ææ¥å£

#### 5.1 å®æ—¶åˆ†æç»“æœ
```
GET /ivs/v1/analysis/realtime/{deviceId}

æŸ¥è¯¢å‚æ•°ï¼š
{
    "algorithmType": "face_recognition",   // ç®—æ³•ç±»å‹
    "confidence": 80,                    // æœ€å°ç½®ä¿¡åº¦
    "timeWindow": 300                    // æ—¶é—´çª—å£(ç§’)
}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

#### 5.2 åˆ†æç»“æœæŸ¥è¯¢
```
POST /ivs/v1/analysis/search

è¯·æ±‚ä½“ï¼š
{
    "deviceId": 1,
    "algorithmType": "face_recognition",
    "resultType": "face",
    "startTime": "2024-01-15T00:00:00Z",
    "endTime": "2024-01-15T23:59:59Z",
    "confidenceMin": 80,
    "personId": "p-001",
    "pageNum": 1,
    "pageSize": 20
}

æƒé™è¦æ±‚ï¼šLevel 1ä»¥ä¸Š
```

### 6. è§£ç ä¸Šå¢™æ¥å£

#### 6.1 åˆ›å»ºæ˜¾ç¤ºä»»åŠ¡
```
POST /ivs/v1/wall/{wallId}/display

è¯·æ±‚ä½“ï¼š
{
    "taskName": "å®æ—¶ç›‘æ§ä¸Šå¢™",
    "taskType": "real_time",          // real_time/playback/image/text
    "sourceDeviceId": 1,             // æºè®¾å¤‡ID(å®æ—¶è§†é¢‘)
    "sourceRecordId": null,          // æºå½•åƒID(å›æ”¾)
    "sourceUrl": null,               // æºåœ°å€(å›¾ç‰‡/æ–‡å­—)
    "displayArea": {
        "x": 0,
        "y": 0,
        "width": 1920,
        "height": 1080
    },
    "zIndex": 1,
    "duration": null                 // nullè¡¨ç¤ºæŒç»­æ˜¾ç¤º
}

æƒé™è¦æ±‚ï¼šLevel 2ä»¥ä¸Š
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

#### 1.1 æ·±åº¦åˆ†é¡µå®ç°
```java
// æ·±åº¦åˆ†é¡µæŸ¥è¯¢
public PageResult<DeviceDTO> getDevicesWithDeepPagination(DeviceQuery query) {
    // è®°å½•æœ€åä¸€æ¡è®°å½•
    String lastRecord = query.getLastRecord();

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    QueryWrapper<Device> wrapper = new QueryWrapper<>();
    wrapper.eq(query.getDeviceName() != null, "device_name", query.getDeviceName())
               .eq(query.getStatus() != null, "status", query.getStatus())
               .ge(query.getCreateTime() != null, "create_time", query.getCreateTime())
               .orderBy(true, query.isSortOrderAsc(), query.getSortBy());

    // æ·±åº¦åˆ†é¡µ
    if (lastRecord != null) {
        wrapper.last(lastRecord.split(",")[0])
                  .gt("create_time", lastRecord.split(",")[1]);
    }

    // æ‰§è¡ŒæŸ¥è¯¢
    List<Device> devices = deviceMapper.selectList(wrapper);
    List<DeviceDTO> deviceDTOs = convertToDTOs(devices);

    // æ„å»ºä¸‹ä¸€é¡µæ¸¸æ ‡
    String nextCursor = null;
    if (devices.size() == query.getPageSize()) {
        Device lastDevice = devices.get(devices.size() - 1);
        nextCursor = lastDevice.getId() + "," + lastDevice.getCreateTime();
    }

    return new PageResult<>(deviceDTOs, nextCursor);
}
```

### 2. ç¼“å­˜ç­–ç•¥

#### 2.1 Redisç¼“å­˜é”®è®¾è®¡
```java
// ç¼“å­˜é”®å¸¸é‡
public class CacheKeys {
    // è®¾å¤‡çŠ¶æ€ç¼“å­˜ - 5åˆ†é’Ÿè¿‡æœŸ
    public static final String DEVICE_STATUS = "ivs:device:status:%s";

    // ç”¨æˆ·æƒé™ç¼“å­˜ - 30åˆ†é’Ÿè¿‡æœŸ
    public static final String USER_PERMISSIONS = "ivs:user:permissions:%s";

    // è®¾å¤‡åˆ—è¡¨ç¼“å­˜ - 5åˆ†é’Ÿè¿‡æœŸ
    public static final String DEVICE_LIST = "ivs:devices:list:%s:%s:%s";

    // å®æ—¶å‘Šè­¦ç¼“å­˜ - 1åˆ†é’Ÿè¿‡æœŸ
    public static final String REALTIME_ALARM = "ivs:alarm:realtime:%s";

    // åˆ†æç»“æœç¼“å­˜ - 10åˆ†é’Ÿè¿‡æœŸ
    public static final String ANALYSIS_RESULT = "ivs:analysis:result:%s:%s";
}

// ç¼“å­˜æœåŠ¡
@Service
public class CacheService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    // ç¼“å­˜è®¾å¤‡çŠ¶æ€
    public void cacheDeviceStatus(Long deviceId, DeviceStatus status) {
        String key = String.format(CacheKeys.DEVICE_STATUS, deviceId);
        redisTemplate.opsForValue().set(key, status, 5, TimeUnit.MINUTES);
    }

    // è·å–è®¾å¤‡çŠ¶æ€
    public DeviceStatus getDeviceStatus(Long deviceId) {
        String key = String.format(CacheKeys.DEVICE_STATUS, deviceId);
        return (DeviceStatus) redisTemplate.opsForValue().get(key);
    }

    // ç¼“å­˜ç”¨æˆ·æƒé™
    public void cacheUserPermissions(Long userId, UserPermissions permissions) {
        String key = String.format(CacheKeys.USER_PERMISSIONS, userId);
        redisTemplate.opsForValue().set(key, permissions, 30, TimeUnit.MINUTES);
    }
}
```

### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–

#### 3.1 æ‰¹é‡è·å–è®¾å¤‡ä¿¡æ¯
```java
// æ‰¹é‡æŸ¥è¯¢è®¾å¤‡ä¿¡æ¯
public Map<Long, DeviceDTO> batchGetDevices(List<Long> deviceIds) {
    // ä½¿ç”¨INæŸ¥è¯¢ä¸€æ¬¡æ€§è·å–æ‰€æœ‰è®¾å¤‡
    List<Device> devices = deviceMapper.selectBatchIds(deviceIds);

    // è½¬æ¢ä¸ºMapæ–¹ä¾¿æŸ¥æ‰¾
    return devices.stream()
            .collect(Collectors.toMap(
                Device::getId,
                this::convertToDTO
            ));
}

// æ‰¹é‡è·å–è®¾å¤‡çŠ¶æ€
public Map<Long, DeviceStatus> batchGetDeviceStatus(List<Long> deviceIds) {
    // å…ˆä»ç¼“å­˜è·å–
    Map<Long, DeviceStatus> statusMap = new HashMap<>();
    List<Long> uncachedIds = new ArrayList<>();

    for (Long deviceId : deviceIds) {
        DeviceStatus status = cacheService.getDeviceStatus(deviceId);
        if (status != null) {
            statusMap.put(deviceId, status);
        } else {
            uncachedIds.add(deviceId);
        }
    }

    // æ‰¹é‡æŸ¥è¯¢æœªç¼“å­˜çš„è®¾å¤‡çŠ¶æ€
    if (!uncachedIds.isEmpty()) {
        Map<Long, DeviceStatus> uncachedStatus = deviceMapper.batchSelectStatus(uncachedIds);
        statusMap.putAll(uncachedStatus);

        // å¼‚æ­¥æ›´æ–°ç¼“å­˜
        CompletableFuture.runAsync(() -> {
            uncachedStatus.forEach((deviceId, status) -> {
                cacheService.cacheDeviceStatus(deviceId, status);
            });
        });
    }

    return statusMap;
}
```

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### 1. APIç›‘æ§æŒ‡æ ‡

#### 1.1 å…³é”®æŒ‡æ ‡
- **å“åº”æ—¶é—´**ï¼šP95ã€P99å“åº”æ—¶é—´
- **è¯·æ±‚é‡**ï¼šæ¯ç§’è¯·æ±‚æ•°(QPS)
- **é”™è¯¯ç‡**ï¼šHTTPé”™è¯¯ç‡ã€ä¸šåŠ¡é”™è¯¯ç‡
- **æˆåŠŸç‡**ï¼šæˆåŠŸè¯·æ±‚å æ¯”
- **å¹¶å‘è¿æ¥æ•°**ï¼šå®æ—¶è¿æ¥æ•°

#### 1.2 ç›‘æ§å®ç°
```java
// APIç›‘æ§åˆ‡é¢
@Aspect
@Component
@Slf4j
public class ApiMonitorAspect {

    @Autowired
    private MetricsService metricsService;

    @Around("execution(* com.ioe.dream.ivs.api..*.*(..))")
    public Object monitorApi(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        String apiName = joinPoint.getSignature().getName();

        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;

            // è®°å½•æˆåŠŸæŒ‡æ ‡
            metricsService.recordApiSuccess(apiName, duration);

            return result;
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;

            // è®°å½•å¤±è´¥æŒ‡æ ‡
            metricsService.recordApiFailure(apiName, duration, e.getClass().getSimpleName());

            throw e;
        }
    }
}

// æŒ‡æ ‡æœåŠ¡
@Service
public class MetricsService {

    @Autowired
    private MeterRegistry meterRegistry;

    // è®°å½•æˆåŠŸAPIè°ƒç”¨
    public void recordApiSuccess(String apiName, long duration) {
        // è®¡æ•°å™¨
        Counter.builder("api_call_count")
                .tag("api", apiName)
                .tag("status", "success")
                .register(meterRegistry)
                .increment();

        // è®¡æ—¶å™¨
        Timer.builder("api_call_duration")
                .tag("api", apiName)
                .tag("status", "success")
                .register(meterRegistry)
                .record(duration, TimeUnit.MILLISECONDS);
    }

    // è®°å½•å¤±è´¥APIè°ƒç”¨
    public void recordApiFailure(String apiName, long duration, String errorType) {
        // è®¡æ•°å™¨
        Counter.builder("api_call_count")
                .tag("api", apiName)
                .tag("status", "failure")
                .tag("error_type", errorType)
                .register(meterRegistry)
                .increment();

        // è®¡æ—¶å™¨
        Timer.builder("api_call_duration")
                .tag("api", apiName)
                .tag("status", "failure")
                .tag("error_type", errorType)
                .register(meterRegistry)
                .record(duration, TimeUnit.MILLISECONDS);
    }
}
```

### 2. æ—¥å¿—è®°å½•è§„èŒƒ

#### 2.1 ç»“æ„åŒ–æ—¥å¿—
```json
{
    "timestamp": "2024-01-15T10:30:25Z",
    "level": "INFO",
    "service": "ivs-api",
    "api": "/ivs/v1/device",
    "method": "GET",
    "status": 200,
    "duration": 125,
    "userId": 1001,
    "userName": "admin",
    "userLevel": 5,
    "requestId": "req-123456",
    "traceId": "trace-123456",
    "clientIp": "192.168.1.100",
    "userAgent": "Mozilla/5.0...",
    "request": {
        "pageNum": 1,
        "pageSize": 20
    },
    "response": {
        "code": 200,
        "message": "success",
        "data": {
            "list": [...],
            "pagination": {...}
        }
    },
    "error": null
}
```

#### 2.2 å®¡è®¡æ—¥å¿—
```java
// å®¡è®¡æ—¥å¿—æœåŠ¡
@Service
public class AuditLogService {

    @Autowired
    private AuditLogMapper auditLogMapper;

    // è®°å½•APIè®¿é—®æ—¥å¿—
    public void logApiAccess(ApiAccessLog log) {
        // å¼‚æ­¥è®°å½•ï¼Œé¿å…å½±å“ä¸šåŠ¡æ€§èƒ½
        CompletableFuture.runAsync(() -> {
            auditLogMapper.insert(log);
        });
    }

    // è®°å½•æƒé™å˜æ›´æ—¥å¿—
    public void logPermissionChange(PermissionChangeLog log) {
        CompletableFuture.runAsync(() -> {
            auditLogMapper.insert(log);
        });
    }

    // è®°å½•æ•°æ®è®¿é—®æ—¥å¿—
    public void logDataAccess(DataAccessLog log) {
        CompletableFuture.runAsync(() -> {
            auditLogMapper.insert(log);
        });
    }
}
```

## ğŸ“ æ€»ç»“

### æŠ€æœ¯ç‰¹è‰²æ€»ç»“

IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æ™ºèƒ½è§†é¢‘ç›‘æ§ç³»ç»ŸAPIè®¾è®¡å…·å¤‡ä»¥ä¸‹æ ¸å¿ƒæŠ€æœ¯ç‰¹è‰²ï¼š

#### âœ… æ ‡å‡†åŒ–è®¾è®¡
1. **RESTfulè§„èŒƒ**ï¼šç»Ÿä¸€çš„URLè®¾è®¡ã€HTTPæ–¹æ³•ä½¿ç”¨
2. **ç»Ÿä¸€å“åº”**ï¼šä¸€è‡´çš„JSONå“åº”æ ¼å¼å’Œé”™è¯¯å¤„ç†
3. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ¸…æ™°çš„ç‰ˆæœ¬ç­–ç•¥å’Œå…¼å®¹æ€§ä¿è¯
4. **æ–‡æ¡£å®Œæ•´**ï¼šè¯¦ç»†çš„APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

#### âœ… å®‰å…¨ä¿éšœ
1. **JWTè®¤è¯**ï¼šæ— çŠ¶æ€Tokenè®¤è¯æœºåˆ¶
2. **5çº§æƒé™æ§åˆ¶**ï¼šç»†ç²’åº¦çš„å®‰å…¨çº§åˆ«å’ŒåŠŸèƒ½æƒé™æ§åˆ¶
3. **æ•°æ®æƒé™**ï¼šåŸºäºè®¾å¤‡å’ŒåŒºåŸŸçš„æ•°æ®è®¿é—®æ§åˆ¶
4. **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„æ“ä½œå®¡è®¡å’Œè®¿é—®è®°å½•

#### âœ… æ€§èƒ½ä¼˜åŒ–
1. **åˆ†é¡µä¼˜åŒ–**ï¼šæ·±åº¦åˆ†é¡µå’Œæ¸¸æ ‡åˆ†é¡µç­–ç•¥
2. **ç¼“å­˜æœºåˆ¶**ï¼šå¤šçº§ç¼“å­˜æå‡å“åº”æ€§èƒ½
3. **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æŸ¥è¯¢å’Œå¤„ç†å‡å°‘æ•°æ®åº“äº¤äº’
4. **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡æ”¶é›†

#### âœ… å¯è§‚æµ‹æ€§
1. **æŒ‡æ ‡ç›‘æ§**ï¼šAPIå“åº”æ—¶é—´ã€æˆåŠŸç‡ã€é”™è¯¯ç‡ç›‘æ§
2. **ç»“æ„åŒ–æ—¥å¿—**ï¼šç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼å’Œç»“æ„
3. **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šè¯·æ±‚é“¾è·¯è¿½è¸ªå’Œæ€§èƒ½åˆ†æ
4. **å¥åº·æ£€æŸ¥**ï¼šæœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥å’Œæ•…éšœæ£€æµ‹

### å¼€å‘ä½“éªŒ

- **æ¸…æ™°æ–‡æ¡£**ï¼šæ¯ä¸ªæ¥å£éƒ½æœ‰è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹
- **ç±»å‹å®‰å…¨**ï¼šæ”¯æŒå¤šç§è¯­è¨€çš„ç±»å‹å®šä¹‰ç”Ÿæˆ
- **è°ƒè¯•å‹å¥½**ï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ”¯æŒ
- **æµ‹è¯•å®Œå¤‡**ï¼šæä¾›æµ‹è¯•ç”¨ä¾‹å’ŒMockæœåŠ¡

---

*æœ¬æ–‡æ¡£ä¸ºIOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æ™ºèƒ½è§†é¢‘ç›‘æ§ç³»ç»Ÿçš„å®Œæ•´APIæ¥å£è®¾è®¡è§„èŒƒï¼ŒåŒ…å«äº†æ¥å£æ¶æ„ã€å®‰å…¨è®¤è¯ã€æ ¸å¿ƒæ¥å£è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§æ—¥å¿—ç­‰å…¨é¢å†…å®¹ã€‚*