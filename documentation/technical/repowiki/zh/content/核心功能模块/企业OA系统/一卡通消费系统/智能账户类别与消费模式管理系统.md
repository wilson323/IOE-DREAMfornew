# IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å° - æ™ºèƒ½è´¦æˆ·ç±»åˆ«ä¸æ¶ˆè´¹æ¨¡å¼ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

**ç³»ç»Ÿå®šä½**ï¼šä¸ºIOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æä¾›ç»Ÿä¸€çš„è´¦æˆ·ç±»åˆ«ç®¡ç†å’Œå¤šæ ·åŒ–æ¶ˆè´¹æ¨¡å¼æ”¯æŒï¼Œå®ç°è®¾å¤‡ç»‘å®šæ¨¡å¼ã€è´¦æˆ·å‚æ•°åŒ–é…ç½®çš„å…¨æµç¨‹ç®¡ç†ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **æ¨¡å¼é€šç”¨åŒ–**ï¼š6å¤§æ ¸å¿ƒæ¨¡å¼è¦†ç›–å…¨å›­åŒºæ¶ˆè´¹åœºæ™¯ï¼Œé™ä½40%é…ç½®å¤æ‚åº¦
- ğŸ”§ **è®¾å¤‡ç»‘å®šåŸåˆ™**ï¼šæ¶ˆè´¹æ¨¡å¼ç”±è®¾å¤‡ç±»å‹å†³å®šï¼Œè´¦æˆ·ç±»åˆ«æä¾›å‚æ•°é…ç½®
- ğŸ¢ **åœºæ™¯å…¨è¦†ç›–**ï¼šæ”¯æŒé£Ÿå ‚ã€è¶…å¸‚ã€åœè½¦åœºã€ä¼šè®®å®¤ã€å¥èº«æˆ¿ç­‰å¤šæ ·åŒ–åœºæ™¯
- âš¡ **é«˜æ€§èƒ½æ¶æ„**ï¼šå¤šçº§ç¼“å­˜ç­–ç•¥ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®
- ğŸ”’ **æƒé™ç²¾ç»†åŒ–**ï¼šæ”¯æŒè´¦æˆ·çº§åˆ«çš„æ¶ˆè´¹é™é¢ã€æŠ˜æ‰£ã€æ—¶é—´æ®µæ§åˆ¶

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ä¸šå›­åŒºä¸€å¡é€šæ¶ˆè´¹ç®¡ç†
- å­¦æ ¡æ ¡å›­å¡æ¶ˆè´¹ç³»ç»Ÿ
- åŒ»é™¢è¥å…»é¤ä¸æ¶ˆè´¹ç®¡ç†
- å•†ä¸šç»¼åˆä½“ä¼šå‘˜æ¶ˆè´¹ç³»ç»Ÿ
- æ™ºæ…§å›­åŒºç»Ÿä¸€æ”¯ä»˜å¹³å°

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[ç®¡ç†åå°<br/>Vue 3.4 + TypeScript]
        B[å•†æˆ·ç«¯APP<br/>uni-app]
        C[æ¶ˆè´¹ç»ˆç«¯<br/>åµŒå…¥å¼Linux]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        D[è´¦æˆ·ç±»åˆ«æœåŠ¡<br/>Spring Boot 3.5.4]
        E[æ¶ˆè´¹æ¨¡å¼å¼•æ“<br/>Spring Boot 3.5.4]
        F[å‚æ•°é…ç½®æœåŠ¡<br/>Spring Boot 3.5.4]
        G[æ¨¡å¼è·¯ç”±æœåŠ¡<br/>Spring Boot 3.5.4]
    end

    subgraph "æ•°æ®å±‚"
        H[MySQL 8.0<br/>ä¸šåŠ¡æ•°æ®]
        I[Redis 7.0<br/>åˆ†å¸ƒå¼ç¼“å­˜]
        J[PostgreSQL 14<br/>æ•°æ®åˆ†æ]
    end

    subgraph "åŸºç¡€è®¾æ–½"
        K[Nacos 2.3<br/>é…ç½®ä¸­å¿ƒ]
        L[Apache Kafka 3.5<br/>æ¶ˆæ¯é˜Ÿåˆ—]
        M[Elasticsearch 8.0<br/>æ—¥å¿—æ£€ç´¢]
    end

    A --> D
    B --> E
    C --> F

    D --> H
    E --> H
    F --> H
    G --> H

    D --> I
    E --> I
    F --> I

    D --> K
    E --> K
    F --> K
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### è®¾å¤‡ç»‘å®šæ¨¡å¼åŸåˆ™
- **è®¾å¤‡å†³å®šæ¨¡å¼**ï¼šæ¯ç§è®¾å¤‡ç±»å‹ç»‘å®šç‰¹å®šçš„æ¶ˆè´¹æ¨¡å¼
- **è´¦æˆ·æä¾›å‚æ•°**ï¼šè´¦æˆ·ç±»åˆ«ä¸ºæ¨¡å¼æä¾›å…·ä½“å‚æ•°é…ç½®
- **æ¨¡å¼å¯åˆ‡æ¢**ï¼šæ”¯æŒä¸»æ¨¡å¼å’Œé™çº§æ¨¡å¼çš„çµæ´»åˆ‡æ¢
- **å‚æ•°å¯è¦†ç›–**ï¼šæ”¯æŒåŒºåŸŸçº§å’Œè´¦æˆ·çº§çš„å‚æ•°è¦†ç›–

#### æ¨¡å¼é€šç”¨åŒ–è®¾è®¡
- **è·¨åœºæ™¯å¤ç”¨**ï¼šåŒä¸€ç§æ¨¡å¼å¯åº”ç”¨äºå¤šç§ä¸šåŠ¡åœºæ™¯
- **é…ç½®æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„JSONé…ç½®æ ¼å¼
- **æ‰©å±•æ€§å¼º**ï¼šæ–°å¢åœºæ™¯æ— éœ€æ–°å¢æ¨¡å¼ï¼Œå¤ç”¨ç°æœ‰æ¨¡å¼

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡

### 1. è´¦æˆ·ç±»åˆ«ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜è¿›å…¥è´¦æˆ·ç±»åˆ«ç®¡ç†] --> B[é€‰æ‹©æ“ä½œç±»å‹]
    B --> C{æ“ä½œç±»å‹}

    C -->|æ–°å¢ç±»åˆ«| D[å¡«å†™ç±»åˆ«åŸºç¡€ä¿¡æ¯]
    C -->|ç¼–è¾‘ç±»åˆ«| E[åŠ è½½ç°æœ‰ç±»åˆ«]
    C -->|åˆ é™¤ç±»åˆ«| F[å®‰å…¨æ£€æŸ¥]

    D --> D1[ç±»åˆ«ç¼–å·/åç§°]
    D1 --> D2[è®¾ç½®æŠ˜æ‰£è§„åˆ™]
    D2 --> D3[é…ç½®æ¶ˆè´¹é™é¢]
    D3 --> D4[é…ç½®æ¶ˆè´¹æ¨¡å¼å‚æ•°]

    D4 --> D5[FIXED_AMOUNTé…ç½®]
    D5 --> D6[FREE_AMOUNTé…ç½®]
    D6 --> D7[METEREDé…ç½®]
    D7 --> D8[PRODUCTé…ç½®]
    D8 --> D9[ORDERé…ç½®]
    D9 --> D10[INTELLIGENCEé…ç½®]

    E --> E1[ä¿®æ”¹ç±»åˆ«ä¿¡æ¯]
    E1 --> E2[æ›´æ–°æŠ˜æ‰£è§„åˆ™]
    E2 --> E3[è°ƒæ•´æ¶ˆè´¹é™é¢]
    E3 --> E4[ä¿®æ”¹æ¨¡å¼å‚æ•°]

    F --> F1[æ£€æŸ¥è´¦æˆ·å…³è”]
    F1 --> F2{å­˜åœ¨å…³è”è´¦æˆ·?}
    F2 -->|æ˜¯| F3[æ‹’ç»åˆ é™¤ï¼Œæç¤ºç”¨æˆ·]
    F2 -->|å¦| F4[æ£€æŸ¥æ¶ˆè´¹è®°å½•]
    F4 --> F5{å­˜åœ¨æ¶ˆè´¹è®°å½•?}
    F5 -->|æ˜¯| F6[æ ‡è®°ä¸ºç¦ç”¨è€Œéåˆ é™¤]
    F5 -->|å¦| F7[æ‰§è¡Œåˆ é™¤]

    D10 --> G[ä¿å­˜ç±»åˆ«æ•°æ®]
    E4 --> G
    F6 --> G
    F7 --> G

    G --> H[å‘å¸ƒå˜æ›´äº‹ä»¶]
    H --> I[æ¸…é™¤ç›¸å…³ç¼“å­˜]
    I --> J[è¿”å›æ“ä½œç»“æœ]

    F3 --> K[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    J --> L[åˆ·æ–°ç±»åˆ«åˆ—è¡¨]
```

### 2. æ¶ˆè´¹æ¨¡å¼å†³ç­–æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·åˆ·å¡/æ‰«ç ] --> B[è¯»å–è®¾å¤‡ä¿¡æ¯]
    B --> C[è·å–è®¾å¤‡æ¶ˆè´¹æ¨¡å¼]
    C --> D[è¯»å–ç”¨æˆ·è´¦æˆ·ç±»åˆ«]

    D --> E[è·å–è´¦æˆ·ç±»åˆ«é…ç½®]
    E --> F{æ£€æŸ¥æ¨¡å¼æ˜¯å¦å¯ç”¨}
    F -->|æœªå¯ç”¨| G[æ£€æŸ¥é™çº§æ¨¡å¼]
    F -->|å·²å¯ç”¨| H[æ‰§è¡Œä¸»æ¨¡å¼æµç¨‹]

    G --> G1{é™çº§æ¨¡å¼å­˜åœ¨?}
    G1 -->|æ˜¯| G2[æ£€æŸ¥é™çº§æ¨¡å¼å¯ç”¨]
    G1 -->|å¦| G3[æ‹’ç»æ¶ˆè´¹]
    G2 --> G4{é™çº§æ¨¡å¼å¯ç”¨?}
    G4 -->|æ˜¯| I[æ‰§è¡Œé™çº§æ¨¡å¼]
    G4 -->|å¦| G3

    H --> J[æ¨¡å¼å‚æ•°è§£æ]
    I --> J
    J --> K[æ‰§è¡Œæ¶ˆè´¹é€»è¾‘]

    K --> L{æ¨¡å¼ç±»å‹}
    L -->|FIXED_AMOUNT| M1[å›ºå®šé‡‘é¢å¤„ç†]
    L -->|FREE_AMOUNT| M2[è‡ªç”±é‡‘é¢å¤„ç†]
    L -->|METERED| M3[è®¡é‡è®¡è´¹å¤„ç†]
    L -->|PRODUCT| M4[å•†å“æ‰«æå¤„ç†]
    L -->|ORDER| M5[è®¢é¤éªŒè¯å¤„ç†]
    L -->|INTELLIGENCE| M6[æ™ºèƒ½è¯†åˆ«å¤„ç†]

    M1 --> N[è®¡ç®—æ¶ˆè´¹é‡‘é¢]
    M2 --> N
    M3 --> N
    M4 --> N
    M5 --> N
    M6 --> N

    N --> O[æƒé™éªŒè¯]
    O --> P[ä½™é¢æ£€æŸ¥]
    P --> Q[æ‰§è¡Œæ‰£æ¬¾]
    Q --> R[è®°å½•äº¤æ˜“æ—¥å¿—]

    G3 --> S[è¿”å›æ‹’ç»ä¿¡æ¯]
    R --> T[è¿”å›æˆåŠŸä¿¡æ¯]

    style G fill:#ff6b6b
    style H fill:#51cf66
    style I fill:#ffd93d
    style Q fill:#51cf66
    style S fill:#ff6b6b
    style T fill:#51cf66
```

### 3. å‚æ•°é…ç½®ä¼˜å…ˆçº§æµç¨‹

```mermaid
flowchart TD
    A[å¼€å§‹è·å–å‚æ•°] --> B{å‚æ•°ç±»å‹}
    B -->|å›ºå®šé‡‘é¢| C[è·å–å›ºå®šé‡‘é¢å‚æ•°]
    B -->|å…¶ä»–æ¨¡å¼| D[è·å–æ ‡å‡†æ¨¡å¼å‚æ•°]

    C --> E{æ£€æŸ¥è´¦æˆ·ç±»åˆ«é…ç½®}
    E -->|å­˜åœ¨é…ç½®| F[ä½¿ç”¨è´¦æˆ·ç±»åˆ«å‚æ•°<br/>ä¼˜å…ˆçº§1]
    E -->|æ— é…ç½®| G{æ£€æŸ¥åŒºåŸŸé»˜è®¤é…ç½®}

    G -->|å­˜åœ¨é…ç½®| H[ä½¿ç”¨åŒºåŸŸé»˜è®¤å‚æ•°<br/>ä¼˜å…ˆçº§2]
    G -->|æ— é…ç½®| I[ä½¿ç”¨ç³»ç»Ÿå…¨å±€é»˜è®¤<br/>ä¼˜å…ˆçº§3]

    D --> J{è´¦æˆ·ç±»åˆ«æœ‰é…ç½®?}
    J -->|æ˜¯| K[ä½¿ç”¨è´¦æˆ·ç±»åˆ«é…ç½®]
    J -->|å¦| L[ä½¿ç”¨æ¨¡å¼é»˜è®¤é…ç½®]

    F --> M[å‚æ•°åº”ç”¨]
    H --> M
    I --> M
    K --> M
    L --> M

    M --> N[å‚æ•°éªŒè¯]
    N --> O[å‚æ•°ç”Ÿæ•ˆ]

    style F fill:#51cf66
    style H fill:#74b9ff
    style I fill:#ffd93d
    style K fill:#51cf66
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. è´¦æˆ·ç±»åˆ«è¡¨ï¼ˆaccount_kindï¼‰

```sql
CREATE TABLE account_kind (
    id VARCHAR(50) PRIMARY KEY COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç±»åˆ«ç¼–å·',
    name VARCHAR(100) NOT NULL COMMENT 'ç±»åˆ«åç§°',
    description VARCHAR(255) COMMENT 'ç±»åˆ«æè¿°',

    -- æŠ˜æ‰£é…ç½®
    discount_type TINYINT DEFAULT 0 COMMENT 'æŠ˜æ‰£ç±»å‹ï¼š0-æ— æŠ˜æ‰£ï¼Œ1-ç™¾åˆ†æ¯”ï¼Œ2-å›ºå®šé‡‘é¢',
    discount_value DECIMAL(10,4) DEFAULT 0.0000 COMMENT 'æŠ˜æ‰£å€¼',

    -- æ¶ˆè´¹é™é¢é…ç½®
    daily_limit_amount DECIMAL(12,2) COMMENT 'æ¯æ—¥æ¶ˆè´¹é™é¢ï¼ˆå…ƒï¼‰',
    daily_limit_count INT COMMENT 'æ¯æ—¥æ¶ˆè´¹æ¬¡æ•°é™åˆ¶',
    weekly_limit_amount DECIMAL(12,2) COMMENT 'æ¯å‘¨æ¶ˆè´¹é™é¢ï¼ˆå…ƒï¼‰',
    weekly_limit_count INT COMMENT 'æ¯å‘¨æ¶ˆè´¹æ¬¡æ•°é™åˆ¶',
    monthly_limit_amount DECIMAL(12,2) COMMENT 'æ¯æœˆæ¶ˆè´¹é™é¢ï¼ˆå…ƒï¼‰',
    monthly_limit_count INT COMMENT 'æ¯æœˆæ¶ˆè´¹æ¬¡æ•°é™åˆ¶',

    -- æ¶ˆè´¹æ¨¡å¼é…ç½®ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
    mode_config JSON COMMENT 'å„æ¶ˆè´¹æ¨¡å¼å‚æ•°é…ç½®',

    -- ä¸šåŠ¡å±æ€§
    must_order_meal BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¿…é¡»è®¢é¤',
    is_attendance_consume BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦è€ƒå‹¤æ¶ˆè´¹',
    allow_negative_balance BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å…è®¸è´Ÿä½™é¢',

    -- çŠ¶æ€ç®¡ç†
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿé¢„å®šä¹‰',

    -- å®¡è®¡å­—æ®µ
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_code(code) COMMENT 'ç¼–å·ç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',
    INDEX idx_create_time(create_time) COMMENT 'åˆ›å»ºæ—¶é—´ç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è´¦æˆ·ç±»åˆ«è¡¨';
```

#### 2. è®¾å¤‡è¡¨ï¼ˆdeviceï¼‰

```sql
CREATE TABLE device (
    id VARCHAR(50) PRIMARY KEY COMMENT 'è®¾å¤‡ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è®¾å¤‡ç¼–å·',
    name VARCHAR(100) NOT NULL COMMENT 'è®¾å¤‡åç§°',

    -- æ¶ˆè´¹æ¨¡å¼é…ç½®ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
    consume_mode ENUM('FIXED_AMOUNT', 'FREE_AMOUNT', 'METERED', 'PRODUCT', 'ORDER', 'INTELLIGENCE')
        NOT NULL COMMENT 'è®¾å¤‡æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼',

    -- æ¨¡å¼è¯¦ç»†é…ç½®
    mode_config JSON COMMENT 'è®¾å¤‡æ¨¡å¼é…ç½®',
    fallback_mode ENUM('FIXED_AMOUNT', 'FREE_AMOUNT', 'METERED', 'PRODUCT', 'ORDER', 'INTELLIGENCE')
        COMMENT 'é™çº§æ¨¡å¼',

    -- è®¾å¤‡åŸºç¡€ä¿¡æ¯
    device_type VARCHAR(50) NOT NULL COMMENT 'è®¾å¤‡ç±»å‹',
    area_id VARCHAR(50) NOT NULL COMMENT 'æ‰€å±åŒºåŸŸID',
    location VARCHAR(255) COMMENT 'è®¾å¤‡ä½ç½®æè¿°',

    -- ç¡¬ä»¶ä¿¡æ¯
    mac_address VARCHAR(17) COMMENT 'MACåœ°å€',
    ip_address VARCHAR(15) COMMENT 'IPåœ°å€',
    hardware_version VARCHAR(50) COMMENT 'ç¡¬ä»¶ç‰ˆæœ¬',
    software_version VARCHAR(50) COMMENT 'è½¯ä»¶ç‰ˆæœ¬',

    -- çŠ¶æ€ç®¡ç†
    online_status ENUM('ONLINE', 'OFFLINE', 'MAINTENANCE') DEFAULT 'OFFLINE' COMMENT 'åœ¨çº¿çŠ¶æ€',
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',

    -- æ—¶é—´ç®¡ç†
    last_heartbeat_time DATETIME COMMENT 'æœ€åå¿ƒè·³æ—¶é—´',
    last_transaction_time DATETIME COMMENT 'æœ€åäº¤æ˜“æ—¶é—´',

    -- å®¡è®¡å­—æ®µ
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_code(code) COMMENT 'ç¼–å·ç´¢å¼•',
    INDEX idx_consume_mode(consume_mode) COMMENT 'æ¶ˆè´¹æ¨¡å¼ç´¢å¼•',
    INDEX idx_area_id(area_id) COMMENT 'åŒºåŸŸç´¢å¼•',
    INDEX idx_device_type(device_type) COMMENT 'è®¾å¤‡ç±»å‹ç´¢å¼•',
    INDEX idx_online_status(online_status) COMMENT 'åœ¨çº¿çŠ¶æ€ç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',

    FOREIGN KEY (area_id) REFERENCES area(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡è¡¨';
```

#### 3. è´¦æˆ·ç±»åˆ«-åŒºåŸŸå…³è”è¡¨ï¼ˆaccount_kind_areaï¼‰

```sql
CREATE TABLE account_kind_area (
    id VARCHAR(50) PRIMARY KEY COMMENT 'å…³è”ID',
    account_kind_id VARCHAR(50) NOT NULL COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    area_id VARCHAR(50) NOT NULL COMMENT 'åŒºåŸŸID',

    -- åŒºåŸŸç‰¹å®šé…ç½®ï¼ˆå¯è¦†ç›–è´¦æˆ·ç±»åˆ«é»˜è®¤é…ç½®ï¼‰
    area_mode_config JSON COMMENT 'åŒºåŸŸæ¨¡å¼å‚æ•°é…ç½®',
    area_discount_value DECIMAL(10,4) COMMENT 'åŒºåŸŸç‰¹å®šæŠ˜æ‰£å€¼',

    -- æƒé™é…ç½®
    allowed_consume_modes JSON COMMENT 'å…è®¸çš„æ¶ˆè´¹æ¨¡å¼åˆ—è¡¨',
    max_transaction_amount DECIMAL(12,2) COMMENT 'å•ç¬”äº¤æ˜“æœ€å¤§é‡‘é¢',

    -- æ—¶é—´æ§åˆ¶
    allowed_time_ranges JSON COMMENT 'å…è®¸æ¶ˆè´¹çš„æ—¶é—´æ®µ',

    -- çŠ¶æ€ç®¡ç†
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    effect_date DATE COMMENT 'ç”Ÿæ•ˆæ—¥æœŸ',
    expire_date DATE COMMENT 'å¤±æ•ˆæ—¥æœŸ',

    -- å®¡è®¡å­—æ®µ
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_account_kind(account_kind_id) COMMENT 'è´¦æˆ·ç±»åˆ«ç´¢å¼•',
    INDEX idx_area(area_id) COMMENT 'åŒºåŸŸç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',
    UNIQUE KEY uk_kind_area(account_kind_id, area_id) COMMENT 'å”¯ä¸€çº¦æŸ',

    FOREIGN KEY (account_kind_id) REFERENCES account_kind(id) ON DELETE CASCADE,
    FOREIGN KEY (area_id) REFERENCES area(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è´¦æˆ·ç±»åˆ«-åŒºåŸŸå…³è”è¡¨';
```

### é…ç½®æ•°æ®ç¤ºä¾‹

#### è´¦æˆ·ç±»åˆ«mode_configç¤ºä¾‹

```json
{
  "FIXED_AMOUNT": {
    "enabled": true,
    "subType": "SECTION",
    "allowOverride": false,
    "simple": {
      "amount": 1500
    },
    "keyvalue": {
      "keys": [
        {"key": "1", "amount": 300, "label": "3å…ƒ"},
        {"key": "2", "amount": 500, "label": "5å…ƒ"},
        {"key": "3", "amount": 1000, "label": "10å…ƒ"}
      ]
    },
    "section": {
      "enableSection": true,
      "sections": [
        {
          "id": "breakfast",
          "name": "æ—©é¤",
          "timeRange": "06:00-09:00",
          "consumeTimes": [
            {"times": 1, "amount": 500, "enabled": true},
            {"times": 2, "amount": 300, "enabled": true}
          ]
        },
        {
          "id": "lunch",
          "name": "åˆé¤",
          "timeRange": "11:00-14:00",
          "consumeTimes": [
            {"times": 1, "amount": 1500, "enabled": true},
            {"times": 2, "amount": 1000, "enabled": false}
          ]
        }
      ]
    }
  },
  "FREE_AMOUNT": {
    "enabled": true,
    "minAmount": 1,
    "maxAmount": 100000,
    "applyDiscount": true,
    "requireConfirm": true
  },
  "METERED": {
    "enabled": true,
    "subType": "TIMING",
    "timing": {
      "pricePerHour": 5000,
      "minMinutes": 30,
      "maxHours": 8,
      "roundingRule": "UP",
      "freeMinutes": 15
    },
    "count": {
      "pricePerTime": 2000,
      "maxTimesPerDay": 3,
      "applyDiscount": true
    }
  },
  "PRODUCT": {
    "enabled": true,
    "allowedCategories": null,
    "maxItemsPerTransaction": 50,
    "applyDiscount": true,
    "requireStock": true
  },
  "ORDER": {
    "enabled": true,
    "mustOrder": false,
    "allowOnSiteOrder": true,
    "applyDiscount": true
  },
  "INTELLIGENCE": {
    "enabled": false,
    "recognitionType": "FACE",
    "autoDeduct": true,
    "confirmTimeout": 5
  }
}
```

---

## ğŸ’» æ ¸å¿ƒæœåŠ¡å®ç°

### 1. è´¦æˆ·ç±»åˆ«ç®¡ç†æœåŠ¡

```java
/**
 * è´¦æˆ·ç±»åˆ«ç®¡ç†æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Transactional
@Slf4j
public class AccountKindService {

    @Resource
    private AccountKindDao accountKindDao;

    @Resource
    private AccountKindAreaDao accountKindAreaDao;

    @Resource
    private ApplicationEventPublisher eventPublisher;

    /**
     * åˆ›å»ºè´¦æˆ·ç±»åˆ«
     */
    public AccountKindResponse createAccountKind(AccountKindCreateRequest request) {
        // 1. æ•°æ®éªŒè¯
        validateCreateRequest(request);

        // 2. æ„å»ºå®ä½“
        AccountKindEntity accountKind = buildAccountKindEntity(request);

        // 3. ä¿å­˜æ•°æ®
        accountKindDao.save(accountKind);

        // 4. ä¿å­˜åŒºåŸŸå…³è”å…³ç³»
        if (request.getAreaConfigs() != null && !request.getAreaConfigs().isEmpty()) {
            saveAreaConfigs(accountKind.getId(), request.getAreaConfigs());
        }

        // 5. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new AccountKindChangeEvent(this, accountKind.getId(), AccountKindChangeType.CREATE)
        );

        log.info("åˆ›å»ºè´¦æˆ·ç±»åˆ«æˆåŠŸ: {}", accountKind.getCode());
        return AccountKindResponse.from(accountKind);
    }

    /**
     * æ›´æ–°è´¦æˆ·ç±»åˆ«
     */
    public AccountKindResponse updateAccountKind(String accountKindId, AccountKindUpdateRequest request) {
        AccountKindEntity accountKind = accountKindDao.findById(accountKindId)
            .orElseThrow(() -> new BusinessException("è´¦æˆ·ç±»åˆ«ä¸å­˜åœ¨"));

        // æ›´æ–°åŸºç¡€å­—æ®µ
        updateBasicFields(accountKind, request);

        // æ›´æ–°æ¨¡å¼é…ç½®
        if (request.getModeConfig() != null) {
            validateModeConfig(request.getModeConfig());
            accountKind.setModeConfig(request.getModeConfig());
        }

        // ä¿å­˜æ›´æ–°
        accountKindDao.save(accountKind);

        // æ›´æ–°åŒºåŸŸé…ç½®
        if (request.getAreaConfigs() != null) {
            updateAreaConfigs(accountKindId, request.getAreaConfigs());
        }

        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new AccountKindChangeEvent(this, accountKindId, AccountKindChangeType.UPDATE)
        );

        log.info("æ›´æ–°è´¦æˆ·ç±»åˆ«æˆåŠŸ: {}", accountKind.getCode());
        return AccountKindResponse.from(accountKind);
    }

    /**
     * è·å–è´¦æˆ·ç±»åˆ«é…ç½®ï¼ˆå«åŒºåŸŸç‰¹å®šé…ç½®ï¼‰
     */
    @Cacheable(value = "accountkind:config:with_area", key = "#accountKindId + '_' + #areaId")
    public AccountKindConfigResponse getAccountKindConfig(String accountKindId, String areaId) {
        // 1. è·å–åŸºç¡€é…ç½®
        AccountKindEntity accountKind = accountKindDao.findById(accountKindId)
            .orElseThrow(() -> new BusinessException("è´¦æˆ·ç±»åˆ«ä¸å­˜åœ¨"));

        // 2. è·å–åŒºåŸŸç‰¹å®šé…ç½®
        Optional<AccountKindAreaEntity> areaConfigOpt =
            accountKindAreaDao.findByAccountKindIdAndAreaIdAndAvailableTrue(accountKindId, areaId);

        // 3. åˆå¹¶é…ç½®ï¼ˆåŒºåŸŸé…ç½®ä¼˜å…ˆçº§æ›´é«˜ï¼‰
        AccountKindConfigResponse config = AccountKindConfigResponse.from(accountKind);

        if (areaConfigOpt.isPresent()) {
            AccountKindAreaEntity areaConfig = areaConfigOpt.get();
            config.mergeAreaConfig(areaConfig);
        }

        return config;
    }

    private void validateModeConfig(JSONObject modeConfig) {
        // éªŒè¯æ¶ˆè´¹æ¨¡å¼é…ç½®æ ¼å¼
        for (ConsumeMode mode : ConsumeMode.values()) {
            if (modeConfig.containsKey(mode.name())) {
                JSONObject modeParams = modeConfig.getJSONObject(mode.name());
                validateModeParameters(mode, modeParams);
            }
        }
    }

    private void validateModeParameters(ConsumeMode mode, JSONObject params) {
        switch (mode) {
            case FIXED_AMOUNT:
                validateFixedAmountConfig(params);
                break;
            case FREE_AMOUNT:
                validateFreeAmountConfig(params);
                break;
            case METERED:
                validateMeteredConfig(params);
                break;
            case PRODUCT:
                validateProductConfig(params);
                break;
            case ORDER:
                validateOrderConfig(params);
                break;
            case INTELLIGENCE:
                validateIntelligenceConfig(params);
                break;
        }
    }

    private void validateFixedAmountConfig(JSONObject params) {
        if (params.containsKey("subType")) {
            String subType = params.getString("subType");
            if (!Arrays.asList("SIMPLE", "KEYVALUE", "SECTION").contains(subType)) {
                throw new BusinessException("æ— æ•ˆçš„å›ºå®šé‡‘é¢å­ç±»å‹: " + subType);
            }
        }

        if (params.containsKey("simple") && params.getJSONObject("simple").containsKey("amount")) {
            BigDecimal amount = params.getJSONObject("simple").getBigDecimal("amount");
            if (amount.compareTo(BigDecimal.ZERO) <= 0) {
                throw new BusinessException("å®šå€¼é‡‘é¢å¿…é¡»å¤§äº0");
            }
        }
    }
}
```

### 2. æ¶ˆè´¹æ¨¡å¼å¼•æ“æœåŠ¡

```java
/**
 * æ¶ˆè´¹æ¨¡å¼å¼•æ“æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Slf4j
public class ConsumeModeEngineService {

    @Resource
    private AccountKindService accountKindService;

    @Resource
    private DeviceService deviceService;

    @Resource
    private Map<String, ConsumeModeHandler> modeHandlers;

    /**
     * æ‰§è¡Œæ¶ˆè´¹æ¨¡å¼å¤„ç†
     */
    public ConsumeResult executeConsume(ConsumeRequest request) {
        // 1. è·å–è®¾å¤‡ä¿¡æ¯
        DeviceEntity device = deviceService.getByCode(request.getDeviceCode());
        if (device == null || !device.getAvailable()) {
            throw new BusinessException("è®¾å¤‡ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }

        // 2. è·å–è´¦æˆ·ç±»åˆ«é…ç½®
        AccountKindConfigResponse config = accountKindService.getAccountKindConfig(
            request.getAccountKindId(), request.getAreaId()
        );

        // 3. æ£€æŸ¥ä¸»æ¨¡å¼æ˜¯å¦å¯ç”¨
        ConsumeMode mainMode = device.getConsumeMode();
        if (!config.isModeEnabled(mainMode)) {
            // å°è¯•é™çº§æ¨¡å¼
            return executeFallbackMode(device, config, request);
        }

        // 4. æ‰§è¡Œä¸»æ¨¡å¼
        return executeMode(mainMode, device, config, request);
    }

    /**
     * æ‰§è¡Œé™çº§æ¨¡å¼
     */
    private ConsumeResult executeFallbackMode(DeviceEntity device, AccountKindConfigResponse config, ConsumeRequest request) {
        ConsumeMode fallbackMode = device.getFallbackMode();
        if (fallbackMode == null || !config.isModeEnabled(fallbackMode)) {
            throw new BusinessException("æ— å¯ç”¨çš„æ¶ˆè´¹æ¨¡å¼");
        }

        log.warn("ä½¿ç”¨é™çº§æ¨¡å¼: device={}, mainMode={}, fallbackMode={}",
            device.getCode(), device.getConsumeMode(), fallbackMode);

        return executeMode(fallbackMode, device, config, request);
    }

    /**
     * æ‰§è¡Œå…·ä½“æ¨¡å¼å¤„ç†
     */
    private ConsumeResult executeMode(ConsumeMode mode, DeviceEntity device, AccountKindConfigResponse config, ConsumeRequest request) {
        ConsumeModeHandler handler = modeHandlers.get(mode.name());
        if (handler == null) {
            throw new BusinessException("ä¸æ”¯æŒæ¶ˆè´¹æ¨¡å¼: " + mode);
        }

        // æ„å»ºæ¨¡å¼ä¸Šä¸‹æ–‡
        ConsumeModeContext context = ConsumeModeContext.builder()
            .mode(mode)
            .device(device)
            .config(config)
            .request(request)
            .build();

        // æ‰§è¡Œæ¨¡å¼å¤„ç†
        return handler.handle(context);
    }

    /**
     * è·å–è®¾å¤‡æ”¯æŒçš„æ¶ˆè´¹æ¨¡å¼
     */
    @Cacheable(value = "device:modes:support", key = "#deviceCode")
    public List<ConsumeMode> getSupportedModes(String deviceCode) {
        DeviceEntity device = deviceService.getByCode(deviceCode);
        if (device == null) {
            return Collections.emptyList();
        }

        List<ConsumeMode> supportedModes = new ArrayList<>();
        supportedModes.add(device.getConsumeMode());

        if (device.getFallbackMode() != null) {
            supportedModes.add(device.getFallbackMode());
        }

        return supportedModes;
    }
}
```

### 3. å›ºå®šé‡‘é¢æ¨¡å¼å¤„ç†å™¨

```java
/**
 * å›ºå®šé‡‘é¢æ¨¡å¼å¤„ç†å™¨
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Component
@Slf4j
public class FixedAmountModeHandler implements ConsumeModeHandler {

    @Resource
    private AccountDailyConsumeService dailyConsumeService;

    @Override
    public ConsumeMode getMode() {
        return ConsumeMode.FIXED_AMOUNT;
    }

    @Override
    public ConsumeResult handle(ConsumeModeContext context) {
        // 1. è·å–æ¨¡å¼å‚æ•°
        FixedAmountConfig config = context.getConfig().getFixedAmountConfig();
        if (config == null || !config.isEnabled()) {
            throw new BusinessException("å›ºå®šé‡‘é¢æ¨¡å¼æœªå¯ç”¨");
        }

        // 2. è®¡ç®—æ¶ˆè´¹é‡‘é¢
        BigDecimal amount = calculateAmount(context, config);

        // 3. åº”ç”¨æŠ˜æ‰£
        amount = applyDiscount(context, amount);

        // 4. æ„å»ºæ¶ˆè´¹ç»“æœ
        return ConsumeResult.builder()
            .consumeMode(ConsumeMode.FIXED_AMOUNT)
            .amount(amount)
            .originalAmount(amount)
            .description(getDescription(config, context.getRequest()))
            .build();
    }

    /**
     * è®¡ç®—æ¶ˆè´¹é‡‘é¢
     */
    private BigDecimal calculateAmount(ConsumeModeContext context, FixedAmountConfig config) {
        String subType = config.getSubType();
        LocalTime now = LocalTime.now();

        switch (subType) {
            case "SIMPLE":
                return config.getSimple().getAmount();

            case "KEYVALUE":
                String keyValue = context.getRequest().getKeyValue();
                return config.getKeyvalue().getKeys().stream()
                    .filter(key -> key.getKey().equals(keyValue))
                    .findFirst()
                    .map(KeyValueConfig::getAmount)
                    .orElseThrow(() -> new BusinessException("æ— æ•ˆçš„é”®å€¼: " + keyValue));

            case "SECTION":
                return calculateSectionAmount(config, now, context);

            default:
                throw new BusinessException("ä¸æ”¯æŒçš„å›ºå®šé‡‘é¢å­ç±»å‹: " + subType);
        }
    }

    /**
     * è®¡ç®—åˆ†æ®µå®šå€¼é‡‘é¢
     */
    private BigDecimal calculateSectionAmount(FixedAmountConfig config, LocalTime now, ConsumeModeContext context) {
        if (!config.getSection().isEnableSection()) {
            throw new BusinessException("åˆ†æ®µå®šå€¼æœªå¯ç”¨");
        }

        // æŸ¥æ‰¾å½“å‰æ—¶é—´æ®µå¯¹åº”çš„åˆ†æ®µ
        SectionConfig section = config.getSection().getSections().stream()
            .filter(s -> isInTimeRange(now, s.getTimeRange()))
            .findFirst()
            .orElseThrow(() -> new BusinessException("å½“å‰æ—¶é—´ä¸åœ¨ä»»ä½•åˆ†æ®µå†…"));

        // è·å–è´¦æˆ·ä»Šæ—¥è¯¥åˆ†æ®µçš„æ¶ˆè´¹æ¬¡æ•°
        int todayConsumeCount = dailyConsumeService.getTodayConsumeCount(
            context.getRequest().getAccountId(), section.getId()
        );

        // æŸ¥æ‰¾å¯¹åº”çš„æ¶ˆè´¹æ¬¡æ•°é…ç½®
        ConsumeTimeConfig consumeTimeConfig = section.getConsumeTimes().stream()
            .filter(ct -> ct.getTimes() == todayConsumeCount + 1) // ä¸‹ä¸€æ¬¡æ¶ˆè´¹
            .filter(ConsumeTimeConfig::isEnabled)
            .findFirst()
            .orElse(null);

        if (consumeTimeConfig == null) {
            throw new BusinessException("è¯¥åˆ†æ®µæ¶ˆè´¹æ¬¡æ•°å·²è¾¾ä¸Šé™");
        }

        return consumeTimeConfig.getAmount();
    }

    /**
     * åº”ç”¨æŠ˜æ‰£
     */
    private BigDecimal applyDiscount(ConsumeModeContext context, BigDecimal amount) {
        AccountKindConfigResponse config = context.getConfig();

        if (config.getDiscountType() == DiscountType.PERCENTAGE) {
            return amount.multiply(BigDecimal.ONE.subtract(config.getDiscountValue()))
                .setScale(2, RoundingMode.HALF_UP);
        } else if (config.getDiscountType() == DiscountType.FIXED_AMOUNT) {
            return amount.subtract(config.getDiscountValue())
                .max(BigDecimal.ZERO)
                .setScale(2, RoundingMode.HALF_UP);
        }

        return amount;
    }

    /**
     * æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨èŒƒå›´å†…
     */
    private boolean isInTimeRange(LocalTime now, String timeRange) {
        String[] times = timeRange.split("-");
        if (times.length != 2) {
            return false;
        }

        LocalTime start = LocalTime.parse(times[0]);
        LocalTime end = LocalTime.parse(times[1]);

        return !now.isBefore(start) && !now.isAfter(end);
    }

    /**
     * è·å–æ¶ˆè´¹æè¿°
     */
    private String getDescription(FixedAmountConfig config, ConsumeRequest request) {
        String subType = config.getSubType();

        switch (subType) {
            case "SIMPLE":
                return "å›ºå®šé‡‘é¢æ¶ˆè´¹";
            case "KEYVALUE":
                return "é”®å€¼é‡‘é¢æ¶ˆè´¹: " + request.getKeyValue();
            case "SECTION":
                return "åˆ†æ®µå®šå€¼æ¶ˆè´¹";
            default:
                return "å›ºå®šé‡‘é¢æ¨¡å¼æ¶ˆè´¹";
        }
    }
}
```

---

## ğŸ“Š å…­å¤§æ ¸å¿ƒæ¨¡å¼è¯¦ç»†è®¾è®¡

### 1. å›ºå®šé‡‘é¢æ¨¡å¼ï¼ˆFIXED_AMOUNTï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šé£Ÿå ‚ã€ç­è½¦ã€é—¨ç¥¨ã€æ‰“å°ã€å……ç”µæ¡©ã€åœè½¦åœºï¼ˆå›ºå®šè´¹ç”¨ï¼‰

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ“Œ ä¸‰ç§å­ç±»å‹ï¼šSIMPLEï¼ˆç®€å•å®šå€¼ï¼‰ã€KEYVALUEï¼ˆé”®å€¼å®šå€¼ï¼‰ã€SECTIONï¼ˆåˆ†æ®µå®šå€¼ï¼‰
- ğŸ”„ æ—¶é—´æ®µæ§åˆ¶ï¼šæ”¯æŒä¸åŒæ—¶é—´æ®µä¸åŒé‡‘é¢
- ğŸ“Š æ¬¡æ•°æ§åˆ¶ï¼šåŒä¸€åˆ†æ®µå†…æ”¯æŒå¤šæ¬¡æ¶ˆè´¹ä¸åŒé‡‘é¢
- ğŸ’° ä¼˜å…ˆçº§é…ç½®ï¼šè´¦æˆ·ç±»åˆ« > åŒºåŸŸé»˜è®¤ > ç³»ç»Ÿé»˜è®¤

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "subType": "SECTION",
  "allowOverride": false,
  "section": {
    "enableSection": true,
    "sections": [
      {
        "id": "breakfast",
        "name": "æ—©é¤",
        "timeRange": "06:00-09:00",
        "consumeTimes": [
          {"times": 1, "amount": 500, "enabled": true},
          {"times": 2, "amount": 300, "enabled": true}
        ]
      }
    ]
  }
}
```

### 2. è‡ªç”±é‡‘é¢æ¨¡å¼ï¼ˆFREE_AMOUNTï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šè¶…å¸‚ã€é£Ÿå ‚ã€åœè½¦åœºã€ä¼šè®®å®¤ç­‰éœ€è¦çµæ´»é‡‘é¢è¾“å…¥çš„åœºæ™¯

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ¨ **é€šç”¨æ€§æœ€å¼º**ï¼šä»»ä½•éœ€è¦è¾“å…¥é‡‘é¢çš„åœºæ™¯
- ğŸ›ï¸ çµæ´»è¾“å…¥ï¼šæ”¯æŒä»»æ„é‡‘é¢è¾“å…¥
- ğŸ“ é™é¢æ§åˆ¶ï¼šæœ€å°/æœ€å¤§é‡‘é¢é™åˆ¶
- ğŸ’¸ æŠ˜æ‰£åº”ç”¨ï¼šæ”¯æŒè´¦æˆ·çº§åˆ«æŠ˜æ‰£

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "minAmount": 1,
  "maxAmount": 100000,
  "applyDiscount": true,
  "requireConfirm": true
}
```

### 3. è®¡é‡è®¡è´¹æ¨¡å¼ï¼ˆMETEREDï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šä¼šè®®å®¤ã€åœè½¦åœºã€å¥èº«æˆ¿ã€æ¸¸æ³³æ± ã€å¨±ä¹è®¾æ–½

**å­ç±»å‹**ï¼š
- `TIMING`ï¼šæŒ‰æ—¶é•¿è®¡è´¹
- `COUNT`ï¼šæŒ‰æ¬¡æ•°è®¡è´¹

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "subType": "TIMING",
  "timing": {
    "pricePerHour": 5000,
    "minMinutes": 30,
    "maxHours": 8,
    "roundingRule": "UP",
    "freeMinutes": 15
  }
}
```

### 4. å•†å“æ¨¡å¼ï¼ˆPRODUCTï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šè¶…å¸‚ã€ä¾¿åˆ©åº—ã€é¢åŒ…æˆ¿ã€æ°´æœåº—

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ“¦ å•†å“ç®¡ç†ï¼šæ”¯æŒå•†å“æ¡ç æ‰«æ
- ğŸ“Š åº“å­˜æ§åˆ¶ï¼šå®æ—¶åº“å­˜æ£€æŸ¥
- ğŸ›’ è´­ç‰©è½¦ï¼šæ”¯æŒå¤šå•†å“ç»„åˆ
- ğŸ’° åŠ¨æ€ä»·æ ¼ï¼šæ”¯æŒä¿ƒé”€ä»·æ ¼

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "allowedCategories": null,
  "maxItemsPerTransaction": 50,
  "applyDiscount": true,
  "requireStock": true
}
```

### 5. è®¢é¤æ¨¡å¼ï¼ˆORDERï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šä¼ä¸šé£Ÿå ‚ã€å­¦æ ¡é£Ÿå ‚ã€å¤–å–ç³»ç»Ÿ

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ“± é¢„è®¢ç³»ç»Ÿï¼šæ”¯æŒæå‰è®¢é¤
- ğŸ• æ—¶é—´æ§åˆ¶ï¼šå–é¤æ—¶é—´é™åˆ¶
- âœ”ï¸ æ ¸é”€æœºåˆ¶ï¼šè®¢é¤è®°å½•æ ¸é”€
- ğŸ½ï¸ é¤åˆ«é€‰æ‹©ï¼šæ”¯æŒä¸åŒé¤åˆ«

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "mustOrder": false,
  "allowOnSiteOrder": true,
  "applyDiscount": true
}
```

### 6. æ™ºèƒ½æ¨¡å¼ï¼ˆINTELLIGENCEï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ™ºèƒ½å–é¤ã€æ— äººè¶…å¸‚ã€è‡ªåŠ©å”®è´§

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ¤– æ™ºèƒ½è¯†åˆ«ï¼šäººè„¸è¯†åˆ«ã€å•†å“è¯†åˆ«
- âš¡ è‡ªåŠ¨æ‰£è´¹ï¼šæ— éœ€äººå·¥å¹²é¢„
- ğŸ“± ç§»åŠ¨æ”¯ä»˜ï¼šæ”¯æŒæ‰‹æœºAPP
- ğŸ¯ ä¸ªæ€§åŒ–æœåŠ¡ï¼šåŸºäºAIçš„æ¨è

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "enabled": true,
  "recognitionType": "FACE",
  "autoDeduct": true,
  "confirmTimeout": 5
}
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç¼“å­˜æ¶æ„è®¾è®¡

```mermaid
graph LR
    A[åº”ç”¨å±‚] --> B[æœ¬åœ°ç¼“å­˜<br/>Caffeine<br/>TTL: 5åˆ†é’Ÿ]
    A --> C[åˆ†å¸ƒå¼ç¼“å­˜<br/>Redis<br/>TTL: 30åˆ†é’Ÿ]
    C --> D[æ•°æ®åº“<br/>MySQL<br/>æŒä¹…åŒ–å­˜å‚¨]

    B --> E[ç¼“å­˜é¢„çƒ­<br/>å®šæ—¶ä»»åŠ¡]
    C --> F[ç¼“å­˜æ›´æ–°<br/>äº‹ä»¶é©±åŠ¨]
    D --> G[æ•°æ®åŒæ­¥<br/>Binlogç›‘å¬]

    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e8
```

### ç¼“å­˜é”®è®¾è®¡

| ç¼“å­˜ç±»å‹ | Redis Key | æ•°æ®ç»“æ„ | TTL | è¯´æ˜ |
|---------|-----------|---------|-----|------|
| è´¦æˆ·ç±»åˆ«é…ç½® | `accountkind:config:{id}` | String(JSON) | 1å°æ—¶ | åŒ…å«mode_config |
| è®¾å¤‡æ¶ˆè´¹æ¨¡å¼ | `device:mode:{id}` | String(JSON) | 30åˆ†é’Ÿ | è®¾å¤‡æ¨¡å¼é…ç½® |
| è´¦æˆ·ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•° | `account:times:{id}:{date}` | Hash | åˆ°23:59 | åˆ†æ®µå®šå€¼æ¬¡æ•°åˆ¤æ–­ |
| è´¦æˆ·æ¯æ—¥æ¶ˆè´¹é‡‘é¢ | `account:amount:{id}:{date}` | String | åˆ°23:59 | æ¯æ—¥é™é¢åˆ¤æ–­ |
| è®¾å¤‡æ”¯æŒæ¨¡å¼ | `device:modes:support:{id}` | Set | 1å°æ—¶ | è®¾å¤‡æ”¯æŒçš„æ¨¡å¼åˆ—è¡¨ |

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡ä½“ç³»

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|---------|--------|---------|---------|
| æ¨¡å¼å†³ç­–å“åº”æ—¶é—´ | < 20ms | Prometheus | > 100ms |
| è´¦æˆ·é…ç½®æŸ¥è¯¢æ—¶é—´ | < 15ms | Prometheus | > 50ms |
| ç¼“å­˜å‘½ä¸­ç‡ | > 95% | Redisç›‘æ§ | < 90% |
| æ¶ˆè´¹æ¨¡å¼å¤„ç†QPS | 3000+ | Nginxç›‘æ§ | < 2000 |
| æ¨¡å¼åˆ‡æ¢æˆåŠŸç‡ | > 99.9% | ä¸šåŠ¡ç›‘æ§ | < 99.5% |

### ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

```java
@Component
@Slf4j
public class ConsumeModeMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter modeExecuteCounter;
    private final Counter modeSwitchCounter;
    private final Timer modeProcessTimer;

    public ConsumeModeMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.modeExecuteCounter = Counter.builder("consume.mode.execute.count")
            .description("æ¶ˆè´¹æ¨¡å¼æ‰§è¡Œæ¬¡æ•°")
            .register(meterRegistry);
        this.modeSwitchCounter = Counter.builder("consume.mode.switch.count")
            .description("æ¨¡å¼é™çº§åˆ‡æ¢æ¬¡æ•°")
            .register(meterRegistry);
        this.modeProcessTimer = Timer.builder("consume.mode.process.duration")
            .description("æ¶ˆè´¹æ¨¡å¼å¤„ç†è€—æ—¶")
            .register(meterRegistry);
    }

    public void recordModeExecute(String mode, String result) {
        modeExecuteCounter.increment(Tags.of("mode", mode, "result", result));
    }

    public void recordModeSwitch(String mainMode, String fallbackMode) {
        modeSwitchCounter.increment(Tags.of("mainMode", mainMode, "fallbackMode", fallbackMode));
    }

    public Timer.Sample startModeProcessTimer() {
        return Timer.start(meterRegistry);
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æ¨¡å¼åˆ‡æ¢æµ‹è¯•

```java
@ExtendWith(MockitoExtension.class)
class ConsumeModeEngineServiceTest {

    @Mock
    private DeviceService deviceService;

    @Mock
    private AccountKindService accountKindService;

    @Mock
    private FixedAmountModeHandler fixedAmountHandler;

    @Mock
    private FreeAmountModeHandler freeAmountHandler;

    @InjectMocks
    private ConsumeModeEngineService modeEngineService;

    @Test
    @DisplayName("ä¸»æ¨¡å¼å¯ç”¨æ—¶ä½¿ç”¨ä¸»æ¨¡å¼")
    void testExecuteConsume_MainModeEnabled() {
        // Given
        ConsumeRequest request = ConsumeRequest.builder()
            .deviceCode("DEVICE001")
            .accountKindId("EMPLOYEE")
            .areaId("AREA001")
            .build();

        DeviceEntity device = DeviceEntity.builder()
            .id("DEVICE001")
            .code("DEVICE001")
            .consumeMode(ConsumeMode.FIXED_AMOUNT)
            .fallbackMode(ConsumeMode.FREE_AMOUNT)
            .build();

        AccountKindConfigResponse config = AccountKindConfigResponse.builder()
            .fixedAmountConfig(FixedAmountConfig.builder().enabled(true).build())
            .freeAmountConfig(FreeAmountConfig.builder().enabled(true).build())
            .build();

        when(deviceService.getByCode("DEVICE001")).thenReturn(device);
        when(accountKindService.getAccountKindConfig("EMPLOYEE", "AREA001")).thenReturn(config);

        ConsumeResult expectedResult = ConsumeResult.builder()
            .consumeMode(ConsumeMode.FIXED_AMOUNT)
            .amount(new BigDecimal("15.00"))
            .build();

        when(fixedAmountHandler.handle(any())).thenReturn(expectedResult);

        // When
        ConsumeResult result = modeEngineService.executeConsume(request);

        // Then
        assertThat(result.getConsumeMode()).isEqualTo(ConsumeMode.FIXED_AMOUNT);
        assertThat(result.getAmount()).isEqualTo(new BigDecimal("15.00"));

        verify(fixedAmountHandler).handle(any());
        verify(freeAmountHandler, never()).handle(any());
    }

    @Test
    @DisplayName("ä¸»æ¨¡å¼ç¦ç”¨æ—¶ä½¿ç”¨é™çº§æ¨¡å¼")
    void testExecuteConsume_UseFallbackMode() {
        // Given
        ConsumeRequest request = ConsumeRequest.builder()
            .deviceCode("DEVICE001")
            .accountKindId("EMPLOYEE")
            .areaId("AREA001")
            .build();

        DeviceEntity device = DeviceEntity.builder()
            .id("DEVICE001")
            .code("DEVICE001")
            .consumeMode(ConsumeMode.FIXED_AMOUNT)
            .fallbackMode(ConsumeMode.FREE_AMOUNT)
            .build();

        AccountKindConfigResponse config = AccountKindConfigResponse.builder()
            .fixedAmountConfig(FixedAmountConfig.builder().enabled(false).build())
            .freeAmountConfig(FreeAmountConfig.builder().enabled(true).build())
            .build();

        when(deviceService.getByCode("DEVICE001")).thenReturn(device);
        when(accountKindService.getAccountKindConfig("EMPLOYEE", "AREA001")).thenReturn(config);

        ConsumeResult expectedResult = ConsumeResult.builder()
            .consumeMode(ConsumeMode.FREE_AMOUNT)
            .amount(new BigDecimal("25.50"))
            .build();

        when(freeAmountHandler.handle(any())).thenReturn(expectedResult);

        // When
        ConsumeResult result = modeEngineService.executeConsume(request);

        // Then
        assertThat(result.getConsumeMode()).isEqualTo(ConsumeMode.FREE_AMOUNT);
        assertThat(result.getAmount()).isEqualTo(new BigDecimal("25.50"));

        verify(freeAmountHandler).handle(any());
        verify(fixedAmountHandler, never()).handle(any());
    }
}
```

---

## ğŸ“ éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒé…ç½®

```yaml
# æ¶ˆè´¹æ¨¡å¼ç®¡ç†é…ç½®
consume-mode:
  # æ¨¡å¼å¤„ç†å™¨é…ç½®
  handlers:
    fixed-amount:
      enabled: true
      cache-config: true
    free-amount:
      enabled: true
      cache-config: true
    metered:
      enabled: true
      timing-precision: 60  # è®¡æ—¶ç²¾åº¦ï¼ˆç§’ï¼‰
    product:
      enabled: true
      stock-check: true
    order:
      enabled: true
      advance-days: 7  # æœ€å¤šæå‰è®¢é¤å¤©æ•°
    intelligence:
      enabled: true
      recognition-timeout: 5  # è¯†åˆ«è¶…æ—¶ï¼ˆç§’ï¼‰

  # ç¼“å­˜é…ç½®
  cache:
    local:
      maximum-size: 2000
      expire-after-write: 5m
    redis:
      config-ttl: 1h
      consume-count-ttl: 1d

  # æ€§èƒ½é…ç½®
  performance:
    mode-decision-timeout: 100  # æ¨¡å¼å†³ç­–è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
    max-concurrent-processes: 100  # æœ€å¤§å¹¶å‘å¤„ç†æ•°
```

### æ•°æ®åº“åˆå§‹åŒ–

```sql
-- åˆå§‹åŒ–é»˜è®¤è´¦æˆ·ç±»åˆ«
INSERT INTO account_kind (id, code, name, description, mode_config, create_time) VALUES
('EMPLOYEE', 'EMP', 'å‘˜å·¥å¡', 'ä¼ä¸šå‘˜å·¥è´¦æˆ·ç±»åˆ«',
'{"FIXED_AMOUNT":{"enabled":true,"subType":"SECTION","section":{"enableSection":true,"sections":[{"id":"breakfast","name":"æ—©é¤","timeRange":"06:00-09:00","consumeTimes":[{"times":1,"amount":500,"enabled":true}]}]}},"FREE_AMOUNT":{"enabled":true,"maxAmount":100000}}',
NOW()),
('STUDENT', 'STU', 'å­¦ç”Ÿå¡', 'åœ¨æ ¡å­¦ç”Ÿè´¦æˆ·ç±»åˆ«',
'{"FIXED_AMOUNT":{"enabled":true,"subType":"SECTION","section":{"enableSection":true,"sections":[{"id":"breakfast","name":"æ—©é¤","timeRange":"06:00-09:00","consumeTimes":[{"times":1,"amount":300,"enabled":true}]}]}}}',
NOW()),
('VISITOR', 'VIS', 'è®¿å®¢å¡', 'è®¿å®¢ä¸´æ—¶è´¦æˆ·ç±»åˆ«',
'{"FREE_AMOUNT":{"enabled":true,"maxAmount":50000,"applyDiscount":false}}',
NOW());

-- åˆå§‹åŒ–ç¤ºä¾‹è®¾å¤‡
INSERT INTO device (id, code, name, consume_mode, fallback_mode, device_type, area_id, create_time) VALUES
('DEVICE001', 'CANTEEN_001', 'é£Ÿå ‚1å·åˆ·å¡æœº', 'FIXED_AMOUNT', 'FREE_AMOUNT', 'CANTEEN_TERMINAL', 'AREA001', NOW()),
('DEVICE002', 'MARKET_001', 'è¶…å¸‚1å·æ”¶é“¶æœº', 'PRODUCT', 'FREE_AMOUNT', 'MARKET_TERMINAL', 'AREA002', NOW()),
('DEVICE003', 'PARKING_001', 'åœè½¦åœºå…¥å£', 'METERED', 'FREE_AMOUNT', 'PARKING_GATE', 'AREA003', NOW());
```

---

## ğŸ“‹ æ€»ç»“

### ç³»ç»Ÿä»·å€¼

âœ… **æ¨¡å¼é€šç”¨åŒ–**ï¼š6å¤§æ ¸å¿ƒæ¨¡å¼è¦†ç›–å…¨å›­åŒºæ¶ˆè´¹åœºæ™¯ï¼Œé™ä½40%é…ç½®å¤æ‚åº¦
âœ… **è®¾å¤‡ç»‘å®šåŸåˆ™**ï¼šæ¶ˆè´¹æ¨¡å¼ç”±è®¾å¤‡ç±»å‹å†³å®šï¼Œè´¦æˆ·ç±»åˆ«æä¾›å‚æ•°é…ç½®
âœ… **å‚æ•°åŒ–é…ç½®**ï¼šç»Ÿä¸€çš„JSONé…ç½®æ ¼å¼ï¼Œæ”¯æŒå¤šå±‚çº§å‚æ•°è¦†ç›–
âœ… **é™çº§æœºåˆ¶**ï¼šä¸»æ¨¡å¼ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢é™çº§æ¨¡å¼ï¼Œä¿è¯ä¸šåŠ¡è¿ç»­æ€§
âœ… **é«˜æ€§èƒ½æ¶æ„**ï¼šå¤šçº§ç¼“å­˜ç­–ç•¥ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®

### æŠ€æœ¯äº®ç‚¹

ğŸ—ï¸ **Spring Boot 3.5.4 + Java 17**ï¼šæœ€æ–°æŠ€æœ¯æ ˆï¼Œæ€§èƒ½ä¼˜å¼‚
ğŸ”„ **ç­–ç•¥æ¨¡å¼è®¾è®¡**ï¼šæ¨¡å¼å¤„ç†å™¨å¯æ’æ‹”ï¼Œæ˜“äºæ‰©å±•
âš¡ **ä¸‰çº§ç¼“å­˜ä½“ç³»**ï¼šæœ¬åœ°ç¼“å­˜+Redis+æ•°æ®åº“ï¼Œæ€§èƒ½å“è¶Š
ğŸ“Š **å®Œå–„ç›‘æ§ä½“ç³»**ï¼šå®æ—¶ç›‘æ§æ¨¡å¼æ‰§è¡Œæ€§èƒ½å’Œä¸šåŠ¡æŒ‡æ ‡

### é€‚ç”¨åœºæ™¯

ğŸ½ï¸ **é¤é¥®æ¶ˆè´¹**ï¼šé£Ÿå ‚å®šå€¼æ¶ˆè´¹ã€è¶…å¸‚å•†å“æ¶ˆè´¹
ğŸ…¿ï¸ **åœè½¦ç®¡ç†**ï¼šæœˆå¡å®šå€¼ã€ä¸´æ—¶è®¡æ—¶æ”¶è´¹
ğŸ¢ **åŠå…¬æœåŠ¡**ï¼šä¼šè®®å®¤è®¡æ—¶ã€æ‰“å°å¤å°æ”¶è´¹
ğŸ‹ï¸ **å¥èº«å¨±ä¹**ï¼šå¥èº«æˆ¿è®¡æ¬¡ã€æ¸¸æ³³æ± è®¡æ—¶
ğŸ¤– **æ™ºèƒ½è®¾å¤‡**ï¼šåˆ·è„¸å–é¤ã€æ— äººè¶…å¸‚ç»“ç®—

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-13
**æ›´æ–°æ—¶é—´**ï¼š2025-11-13
**é€‚ç”¨ç‰ˆæœ¬**ï¼šIOE-DREAM v1.0+
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šIOE-DREAMæŠ€æœ¯å›¢é˜Ÿ