# IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å° - æ™ºèƒ½åŒºåŸŸæƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

**ç³»ç»Ÿå®šä½**ï¼šä¸ºIOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æä¾›é«˜æ•ˆã€çµæ´»çš„åŒºåŸŸæƒé™ç®¡ç†èƒ½åŠ›ï¼Œé€šè¿‡JSONé…ç½®å’Œè¡¥å¿æœºåˆ¶ï¼Œå®ç°è´¦æˆ·ç±»åˆ«å¯¹å›­åŒºå„åŒºåŸŸçš„ç²¾ç»†åŒ–è®¿é—®æ§åˆ¶ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **æç®€é…ç½®**ï¼šJSONå­—æ®µç›´æ¥é…ç½®åŒºåŸŸæƒé™ï¼Œæ— éœ€å¤æ‚å…³è”è¡¨
- âš¡ **é«˜é¢‘ä¼˜åŒ–**ï¼šé’ˆå¯¹85%é«˜é¢‘æƒé™éªŒè¯åœºæ™¯ï¼Œå“åº”æ—¶é—´1-3ms
- ğŸ”„ **å®Œå–„è¡¥å¿**ï¼šæä¾›åå‘ç´¢å¼•ã€ç»Ÿè®¡è¡¨ã€SQLè§†å›¾ç­‰å¤šå±‚ä¿éšœ
- ğŸ“Š **å±‚çº§æƒé™**ï¼šæ”¯æŒçˆ¶å­åŒºåŸŸæƒé™ç»§æ‰¿ï¼Œé…ç½®æ•ˆç‡æå‡10å€
- ğŸ”’ **å®‰å…¨å¯é **ï¼šæ•°æ®ä¸€è‡´æ€§æ ¡éªŒã€çº§è”æ›´æ–°ã€ç›‘æ§å‘Šè­¦å…¨è¦†ç›–

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ä¸šå›­åŒºå¤šåŒºåŸŸè®¿é—®æ§åˆ¶
- å­¦æ ¡æ ¡å›­å„åœºé¦†æƒé™ç®¡ç†
- åŒ»é™¢ä¸åŒç§‘å®¤è®¿é—®æ§åˆ¶
- å•†ä¸šç»¼åˆä½“å„å•†é“ºæƒé™ç®¡ç†
- æ™ºæ…§å›­åŒºç»Ÿä¸€æƒé™ä½“ç³»

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[ç®¡ç†åå°<br/>Vue 3.4 + TypeScript]
        B[è¿è¥ç«¯APP<br/>uni-app]
        C[æ•°æ®åˆ†æå¹³å°<br/>React 18]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        D[æƒé™é…ç½®æœåŠ¡<br/>Spring Boot 3.5.4]
        E[æƒé™éªŒè¯æœåŠ¡<br/>Spring Boot 3.5.4]
        F[è¡¥å¿æœºåˆ¶æœåŠ¡<br/>Spring Boot 3.5.4]
        G[ç»Ÿè®¡åˆ†ææœåŠ¡<br/>Spring Boot 3.5.4]
    end

    subgraph "æ•°æ®å±‚"
        H[MySQL 8.0<br/>ä¸»æ•°æ®åº“]
        I[Redis 7.0<br/>åˆ†å¸ƒå¼ç¼“å­˜]
        J[PostgreSQL 14<br/>æ•°æ®åˆ†æ]
    end

    subgraph "åŸºç¡€è®¾æ–½"
        K[Nacos 2.3<br/>é…ç½®ä¸­å¿ƒ]
        L[Apache Kafka 3.5<br/>æ¶ˆæ¯é˜Ÿåˆ—]
        M[Elasticsearch 8.0<br/>æ—¥å¿—æ£€ç´¢]
        N[Prometheus<br/>ç›‘æ§å‘Šè­¦]
    end

    A --> D
    B --> E
    C --> G

    D --> H
    E --> H
    F --> H
    G --> J

    D --> I
    E --> I
    F --> I

    D --> K
    E --> K
    F --> K

    F --> N
    G --> N
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### æƒé™ç»§æ‰¿é“¾è·¯
```
è´¦æˆ·ç±»åˆ«.area_config â†’ åŒºåŸŸ.meal_categories â†’ é¤åˆ«åˆ†ç±» â†’ å…·ä½“é¤åˆ«
   (é…ç½®å¯ç”¨åŒºåŸŸ)      (åŒºåŸŸæ”¯æŒçš„é¤åˆ«)     (åˆ†ç±»)      (é¤åˆ«)
```

**è®¾è®¡è¦ç‚¹**ï¼š
1. **è´¦æˆ·ç±»åˆ«** `area_config`ï¼šé…ç½®è¯¥ç±»åˆ«å¯ä»¥åœ¨å“ªäº›åŒºåŸŸæ¶ˆè´¹
2. **åŒºåŸŸè¡¨** `meal_categories`ï¼šé…ç½®è¯¥åŒºåŸŸæ”¯æŒå“ªäº›é¤åˆ«åˆ†ç±»
3. **è‡ªåŠ¨ç»§æ‰¿**ï¼šè´¦æˆ·ç±»åˆ«åœ¨è¯¥åŒºåŸŸæ¶ˆè´¹æ—¶ï¼Œè‡ªåŠ¨ç»§æ‰¿è¯¥åŒºåŸŸçš„æ‰€æœ‰é¤åˆ«åˆ†ç±»
4. **å±‚çº§æ”¯æŒ**ï¼š`includeSubAreas`å®ç°çˆ¶å­åŒºåŸŸæƒé™ç»§æ‰¿

#### è¡¥å¿æœºåˆ¶ä½“ç³»
- ğŸ”„ **Redisåå‘ç´¢å¼•**ï¼šåº”å¯¹åå‘æŸ¥è¯¢éœ€æ±‚
- ğŸ“Š **ç»Ÿè®¡æ±‡æ€»è¡¨**ï¼šåº”å¯¹æŠ¥è¡¨å’Œæ•°æ®åˆ†æéœ€æ±‚
- âœ… **æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ**ï¼šå®šæœŸæ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®æ€§
- ğŸ”™ **SQLè§†å›¾**ï¼šåº”æ€¥é™çº§æ–¹æ¡ˆï¼Œå…¼å®¹ä¼ ç»ŸæŸ¥è¯¢

---

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. è´¦æˆ·ç±»åˆ«è¡¨ï¼ˆaccount_kindï¼‰

```sql
CREATE TABLE account_kind (
    id VARCHAR(50) PRIMARY KEY COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç±»åˆ«ç¼–å·',
    name VARCHAR(100) NOT NULL COMMENT 'ç±»åˆ«åç§°',
    description VARCHAR(255) COMMENT 'ç±»åˆ«æè¿°',

    -- åŒºåŸŸæƒé™é…ç½®ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
    area_config JSON COMMENT 'åŒºåŸŸæƒé™é…ç½®JSONæ•°ç»„',

    -- å…¶ä»–é…ç½®
    mode_config JSON COMMENT 'æ¶ˆè´¹æ¨¡å¼é…ç½®',
    discount_type TINYINT DEFAULT 0 COMMENT 'æŠ˜æ‰£ç±»å‹',
    discount_value DECIMAL(10,4) DEFAULT 0.0000 COMMENT 'æŠ˜æ‰£å€¼',

    -- æ¶ˆè´¹é™é¢
    daily_limit_amount DECIMAL(12,2) COMMENT 'æ¯æ—¥æ¶ˆè´¹é™é¢',
    daily_limit_count INT COMMENT 'æ¯æ—¥æ¶ˆè´¹æ¬¡æ•°é™åˆ¶',
    weekly_limit_amount DECIMAL(12,2) COMMENT 'æ¯å‘¨æ¶ˆè´¹é™é¢',
    weekly_limit_count INT COMMENT 'æ¯å‘¨æ¶ˆè´¹æ¬¡æ•°é™åˆ¶',

    -- çŠ¶æ€ç®¡ç†
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿé¢„å®šä¹‰',

    -- å®¡è®¡å­—æ®µ
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_code(code) COMMENT 'ç¼–å·ç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',
    INDEX idx_create_time(create_time) COMMENT 'åˆ›å»ºæ—¶é—´ç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è´¦æˆ·ç±»åˆ«è¡¨';
```

#### 2. åŒºåŸŸä½¿ç”¨ç»Ÿè®¡è¡¨ï¼ˆarea_usage_statï¼‰

```sql
CREATE TABLE area_usage_stat (
    area_id VARCHAR(50) PRIMARY KEY COMMENT 'åŒºåŸŸID',
    area_name VARCHAR(100) COMMENT 'åŒºåŸŸåç§°',
    account_kind_ids TEXT COMMENT 'ä½¿ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«IDï¼ˆJSONæ•°ç»„ï¼‰',
    account_kind_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«æ•°é‡',
    include_sub_count INT DEFAULT 0 COMMENT 'åŒ…å«å­åŒºåŸŸçš„é…ç½®æ•°é‡',
    total_usage_count BIGINT DEFAULT 0 COMMENT 'ç´¯è®¡ä½¿ç”¨æ¬¡æ•°',
    last_update_time DATETIME COMMENT 'æœ€åæ›´æ–°æ—¶é—´',
    stat_date DATE COMMENT 'ç»Ÿè®¡æ—¥æœŸ',

    INDEX idx_update_time(last_update_time) COMMENT 'æ›´æ–°æ—¶é—´ç´¢å¼•',
    INDEX idx_stat_date(stat_date) COMMENT 'ç»Ÿè®¡æ—¥æœŸç´¢å¼•',
    INDEX idx_usage_count(total_usage_count) COMMENT 'ä½¿ç”¨æ¬¡æ•°ç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åŒºåŸŸä½¿ç”¨ç»Ÿè®¡è¡¨';
```

#### 3. åº”æ€¥SQLè§†å›¾

```sql
-- è´¦æˆ·ç±»åˆ«-åŒºåŸŸå…³è”è§†å›¾ï¼ˆåº”æ€¥é™çº§ä½¿ç”¨ï¼‰
CREATE VIEW v_accountkind_area AS
SELECT
    ak.id AS account_kind_id,
    ak.code AS account_kind_code,
    ak.name AS account_kind_name,
    JSON_EXTRACT(area_item.value, '$.areaId') AS area_id,
    JSON_EXTRACT(area_item.value, '$.includeSubAreas') AS include_sub_areas,
    ak.update_time AS update_time,
    ak.create_time AS create_time
FROM account_kind ak
CROSS JOIN JSON_TABLE(
    ak.area_config,
    '$[*]' COLUMNS(
        value JSON PATH '$'
    )
) AS area_item
WHERE ak.area_config IS NOT NULL AND ak.available = TRUE;

-- ä½¿ç”¨ç¤ºä¾‹ï¼šæŸ¥è¯¢æŸåŒºåŸŸè¢«å“ªäº›è´¦æˆ·ç±»åˆ«ä½¿ç”¨
SELECT account_kind_id, account_kind_code, account_kind_name
FROM v_accountkind_area
WHERE area_id = 'AREA001'
ORDER BY account_kind_code;
```

### é…ç½®æ•°æ®ç»“æ„

#### area_config JSONç»“æ„

```json
[
  {
    "areaId": "åŒºåŸŸID",
    "includeSubAreas": true,
    "effectiveDate": "2025-01-01",
    "expireDate": "2025-12-31"
  }
]
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| areaId | String | âœ… | åŒºåŸŸID |
| includeSubAreas | Boolean | âœ… | æ˜¯å¦åŒ…å«æ‰€æœ‰å­åŒºåŸŸ |
| effectiveDate | String | âŒ | ç”Ÿæ•ˆæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
| expireDate | String | âŒ | å¤±æ•ˆæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡

### 1. æƒé™éªŒè¯æ ¸å¿ƒæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·åœ¨è®¾å¤‡æ¶ˆè´¹] --> B[è¯»å–è´¦æˆ·ç±»åˆ«]
    B --> C[è·å–area_configæ•°ç»„]

    C --> D[è·å–è®¾å¤‡æ‰€åœ¨åŒºåŸŸID]
    D --> E{éå†area_config}

    E --> F{åŒºåŸŸIDç›´æ¥åŒ¹é…?}
    F -->|åŒ¹é…æˆåŠŸ| G[åŒºåŸŸæƒé™é€šè¿‡]
    F -->|ä¸åŒ¹é…| H{includeSubAreas=true?}

    H -->|æ˜¯| I{è®¾å¤‡åŒºåŸŸæ˜¯å­åŒºåŸŸ?}
    I -->|æ˜¯| G
    I -->|å¦| J[ç»§ç»­éå†ä¸‹ä¸€ä¸ªé…ç½®]

    H -->|å¦| J
    J --> K{è¿˜æœ‰å…¶ä»–é…ç½®åŒºåŸŸ?}
    K -->|æ˜¯| E
    K -->|å¦| L[åŒºåŸŸæƒé™æ‹’ç»]

    G --> M[ä»åŒºåŸŸè¡¨è¯»å–meal_categories]
    M --> N{åŒºåŸŸæœ‰é¤åˆ«é…ç½®?}
    N -->|æ— é™åˆ¶| O[é¤åˆ«æƒé™é€šè¿‡]
    N -->|æœ‰é™åˆ¶| P[è·å–å½“å‰æ¶ˆè´¹é¤åˆ«åˆ†ç±»]

    P --> Q{é¤åˆ«åˆ†ç±»åœ¨å…è®¸åˆ—è¡¨?}
    Q -->|åœ¨å…è®¸åˆ—è¡¨| O
    Q -->|ä¸åœ¨åˆ—è¡¨| R[é¤åˆ«æƒé™æ‹’ç»]

    style L fill:#ff6b6b
    style R fill:#ff6b6b
    style O fill:#51cf66
    style G fill:#51cf66
```

### 2. åŒºåŸŸæƒé™é…ç½®æµç¨‹

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜è¿›å…¥æƒé™é…ç½®] --> B[é€‰æ‹©è´¦æˆ·ç±»åˆ«]
    B --> C[åŠ è½½å½“å‰area_config]
    C --> D{æ“ä½œç±»å‹}

    D -->|æ·»åŠ åŒºåŸŸ| E[é€‰æ‹©åŒºåŸŸ]
    D -->|åˆ é™¤åŒºåŸŸ| F[é€‰æ‹©è¦åˆ é™¤çš„åŒºåŸŸ]
    D -->|ä¿®æ”¹é…ç½®| G[ä¿®æ”¹åŒºåŸŸæƒé™å‚æ•°]

    E --> H[è®¾ç½®includeSubAreas]
    H --> I{åŒ…å«å­åŒºåŸŸ?}
    I -->|æ˜¯| J[é…ç½®çˆ¶åŒºåŸŸæƒé™]
    I -->|å¦| K[é…ç½®å•ä¸€åŒºåŸŸæƒé™]

    F --> L[å®‰å…¨æ£€æŸ¥]
    L --> M{å­˜åœ¨å†å²æ¶ˆè´¹?}
    M -->|æ˜¯| N[æ ‡è®°ä¸ºåˆ é™¤è€Œéç‰©ç†åˆ é™¤]
    M -->|å¦| O[ç‰©ç†åˆ é™¤é…ç½®]

    G --> P[ä¿®æ”¹ç”Ÿæ•ˆæ—¶é—´]
    P --> Q[ä¿®æ”¹è¿‡æœŸæ—¶é—´]
    Q --> R[éªŒè¯æ—¶é—´èŒƒå›´]

    J --> S[ä¿å­˜é…ç½®åˆ°æ•°æ®åº“]
    K --> S
    N --> S
    O --> S
    R --> S

    S --> T[å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶]
    T --> U[æ›´æ–°Redisç¼“å­˜]
    U --> V[æ›´æ–°åå‘ç´¢å¼•]
    V --> W[è§¦å‘ç»Ÿè®¡è¡¨æ›´æ–°]
    W --> X[è¿”å›é…ç½®ç»“æœ]

    style S fill:#51cf66
    style T fill:#74b9ff
    style U fill:#ffd93d
    style V fill:#a29bfe
```

### 3. è¡¥å¿æœºåˆ¶æ›´æ–°æµç¨‹

```mermaid
flowchart TD
    A[è´¦æˆ·ç±»åˆ«area_configå˜æ›´] --> B[è·å–æ—§é…ç½®]
    B --> C[æ›´æ–°æ•°æ®åº“]
    C --> D[åˆ é™¤æ—§çš„åå‘ç´¢å¼•]

    D --> E[éå†æ—§é…ç½®åŒºåŸŸ]
    E --> F[ä»Redis Setç§»é™¤å…³ç³»]
    F --> G{è¿˜æœ‰æ—§åŒºåŸŸ?}
    G -->|æ˜¯| E
    G -->|å¦| H[æ·»åŠ æ–°çš„åå‘ç´¢å¼•]

    H --> I[éå†æ–°é…ç½®åŒºåŸŸ]
    I --> J[å‘Redis Setæ·»åŠ å…³ç³»]
    J --> K{è¿˜æœ‰æ–°åŒºåŸŸ?}
    K -->|æ˜¯| I
    K -->|å¦| L[æ¸…ç†ç›¸å…³ç¼“å­˜]

    L --> M[åˆ é™¤è´¦æˆ·ç±»åˆ«ç¼“å­˜]
    M --> N[æ›´æ–°ç»Ÿè®¡è¡¨æ ‡è®°]
    N --> O[å‘å¸ƒå˜æ›´é€šçŸ¥]
    O --> P[è®°å½•å˜æ›´æ—¥å¿—]

    style C fill:#51cf66
    style F fill:#ff6b6b
    style J fill:#51cf66
```

---

## ğŸ’» æ ¸å¿ƒæœåŠ¡å®ç°

### 1. æƒé™éªŒè¯æœåŠ¡

```java
/**
 * åŒºåŸŸæƒé™éªŒè¯æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Slf4j
public class AreaPermissionService {

    @Resource
    private AccountKindDao accountKindDao;

    @Resource
    private AreaDao areaDao;

    @Resource
    private AreaPermissionCache permissionCache;

    /**
     * éªŒè¯è´¦æˆ·ç±»åˆ«åŒºåŸŸæƒé™
     */
    public AreaPermissionResult validateAreaPermission(
        String accountKindId, String areaId, String mealCategoryId
    ) {
        // 1. è·å–è´¦æˆ·ç±»åˆ«é…ç½®
        AccountKindEntity accountKind = getAccountKindWithCache(accountKindId);
        if (accountKind.getAreaConfig() == null || accountKind.getAreaConfig().isEmpty()) {
            return AreaPermissionResult.fail("è´¦æˆ·ç±»åˆ«æœªé…ç½®åŒºåŸŸæƒé™");
        }

        // 2. éªŒè¯åŒºåŸŸæƒé™
        if (!validateAreaAccess(accountKind, areaId)) {
            return AreaPermissionResult.fail("æ— æƒåœ¨è¯¥åŒºåŸŸæ¶ˆè´¹");
        }

        // 3. éªŒè¯é¤åˆ«æƒé™ï¼ˆå¯é€‰ï¼‰
        if (StringUtils.isNotBlank(mealCategoryId)) {
            AreaEntity area = getAreaWithCache(areaId);
            if (!validateMealCategoryAccess(area, mealCategoryId)) {
                return AreaPermissionResult.fail("è¯¥åŒºåŸŸä¸æ”¯æŒæ­¤é¤åˆ«åˆ†ç±»");
            }
        }

        return AreaPermissionResult.success();
    }

    /**
     * éªŒè¯åŒºåŸŸè®¿é—®æƒé™
     */
    private boolean validateAreaAccess(AccountKindEntity accountKind, String areaId) {
        JSONArray areaConfig = accountKind.getAreaConfig();

        for (int i = 0; i < areaConfig.size(); i++) {
            JSONObject config = areaConfig.getJSONObject(i);
            String configAreaId = config.getString("areaId");
            boolean includeSubAreas = config.getBooleanValue("includeSubAreas");

            // ç›´æ¥åŒ¹é…
            if (configAreaId.equals(areaId)) {
                return true;
            }

            // åŒ…å«å­åŒºåŸŸ
            if (includeSubAreas) {
                List<String> subAreaIds = areaDao.findSubAreaIds(configAreaId);
                if (subAreaIds.contains(areaId)) {
                    return true;
                }
            }
        }

        return false;
    }

    /**
     * éªŒè¯é¤åˆ«åˆ†ç±»æƒé™
     */
    private boolean validateMealCategoryAccess(AreaEntity area, String mealCategoryId) {
        if (area.getMealCategories() == null || area.getMealCategories().isEmpty()) {
            // åŒºåŸŸæœªé…ç½®é¤åˆ«é™åˆ¶ï¼Œå…è®¸æ‰€æœ‰é¤åˆ«
            return true;
        }

        JSONArray mealCategories = area.getMealCategories();
        return mealCategories.contains(mealCategoryId);
    }

    /**
     * è·å–è´¦æˆ·ç±»åˆ«ï¼ˆå«ç¼“å­˜ï¼‰
     */
    private AccountKindEntity getAccountKindWithCache(String accountKindId) {
        return permissionCache.getAccountKind(accountKindId);
    }

    /**
     * è·å–åŒºåŸŸä¿¡æ¯ï¼ˆå«ç¼“å­˜ï¼‰
     */
    private AreaEntity getAreaWithCache(String areaId) {
        return permissionCache.getArea(areaId);
    }
}
```

### 2. æƒé™é…ç½®ç®¡ç†æœåŠ¡

```java
/**
 * åŒºåŸŸæƒé™é…ç½®ç®¡ç†æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Transactional
@Slf4j
public class AreaConfigService {

    @Resource
    private AccountKindDao accountKindDao;

    @Resource
    private AreaDao areaDao;

    @Resource
    private AreaPermissionCache permissionCache;

    @Resource
    private CompensationService compensationService;

    @Resource
    private ApplicationEventPublisher eventPublisher;

    /**
     * é…ç½®è´¦æˆ·ç±»åˆ«åŒºåŸŸæƒé™
     */
    public void configureAccountKindArea(String accountKindId, AreaConfigRequest request) {
        // 1. éªŒè¯è´¦æˆ·ç±»åˆ«å­˜åœ¨
        AccountKindEntity accountKind = accountKindDao.findById(accountKindId)
            .orElseThrow(() -> new BusinessException("è´¦æˆ·ç±»åˆ«ä¸å­˜åœ¨"));

        // 2. éªŒè¯é…ç½®æ•°æ®
        validateAreaConfig(request.getAreaConfigs());

        // 3. è·å–æ—§é…ç½®ç”¨äºè¡¥å¿æœºåˆ¶
        JSONArray oldConfig = accountKind.getAreaConfig();

        // 4. æ›´æ–°é…ç½®
        JSONArray newConfig = buildAreaConfig(request.getAreaConfigs());
        accountKind.setAreaConfig(newConfig);
        accountKind.setUpdateTime(new Date());
        accountKind.setUpdateBy(SecurityUtils.getCurrentUserId());

        accountKindDao.save(accountKind);

        // 5. æ‰§è¡Œè¡¥å¿æœºåˆ¶æ›´æ–°
        compensationService.updateAreaPermissionIndex(accountKindId, oldConfig, newConfig);

        // 6. å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶
        eventPublisher.publishEvent(
            new AreaConfigChangeEvent(this, accountKindId, oldConfig, newConfig)
        );

        log.info("æ›´æ–°è´¦æˆ·ç±»åˆ«åŒºåŸŸæƒé™é…ç½®æˆåŠŸ: accountKindId={}", accountKindId);
    }

    /**
     * æ‰¹é‡é…ç½®å¤šä¸ªè´¦æˆ·ç±»åˆ«çš„åŒºåŸŸæƒé™
     */
    public void batchConfigureAreaPermission(BatchAreaConfigRequest request) {
        List<String> successAccountKinds = new ArrayList<>();
        List<String> failedAccountKinds = new ArrayList<>();

        for (String accountKindId : request.getAccountKindIds()) {
            try {
                AreaConfigRequest configRequest = AreaConfigRequest.builder()
                    .accountKindId(accountKindId)
                    .areaConfigs(request.getAreaConfigs())
                    .build();

                configureAccountKindArea(accountKindId, configRequest);
                successAccountKinds.add(accountKindId);
            } catch (Exception e) {
                log.error("é…ç½®è´¦æˆ·ç±»åˆ«åŒºåŸŸæƒé™å¤±è´¥: accountKindId={}, error={}", accountKindId, e.getMessage());
                failedAccountKinds.add(accountKindId);
            }
        }

        // å‘å¸ƒæ‰¹é‡é…ç½®ç»“æœäº‹ä»¶
        eventPublisher.publishEvent(
            new BatchAreaConfigResultEvent(this, successAccountKinds, failedAccountKinds)
        );
    }

    /**
     * è·å–è´¦æˆ·ç±»åˆ«å¯ç”¨åŒºåŸŸåˆ—è¡¨
     */
    @Cacheable(value = "accountkind:areas", key = "#accountKindId")
    public List<AreaPermissionVO> getAccountKindAvailableAreas(String accountKindId) {
        AccountKindEntity accountKind = accountKindDao.findById(accountKindId)
            .orElseThrow(() -> new BusinessException("è´¦æˆ·ç±»åˆ«ä¸å­˜åœ¨"));

        if (accountKind.getAreaConfig() == null || accountKind.getAreaConfig().isEmpty()) {
            return Collections.emptyList();
        }

        List<AreaPermissionVO> result = new ArrayList<>();
        JSONArray areaConfig = accountKind.getAreaConfig();

        for (int i = 0; i < areaConfig.size(); i++) {
            JSONObject config = areaConfig.getJSONObject(i);
            String configAreaId = config.getString("areaId");
            boolean includeSubAreas = config.getBooleanValue("includeSubAreas");

            // è·å–ä¸»åŒºåŸŸ
            AreaEntity mainArea = areaDao.findById(configAreaId).orElse(null);
            if (mainArea != null) {
                result.add(AreaPermissionVO.builder()
                    .areaId(configAreaId)
                    .areaName(mainArea.getName())
                    .includeSubAreas(includeSubAreas)
                    .isParent(true)
                    .build());
            }

            // è·å–å­åŒºåŸŸ
            if (includeSubAreas) {
                List<AreaEntity> subAreas = areaDao.findSubAreas(configAreaId);
                for (AreaEntity subArea : subAreas) {
                    result.add(AreaPermissionVO.builder()
                        .areaId(subArea.getId())
                        .areaName(subArea.getName())
                        .parentAreaId(configAreaId)
                        .includeSubAreas(false)
                        .isParent(false)
                        .build());
                }
            }
        }

        return result;
    }

    private void validateAreaConfig(List<AreaConfigItem> areaConfigs) {
        for (AreaConfigItem item : areaConfigs) {
            // éªŒè¯åŒºåŸŸå­˜åœ¨æ€§
            if (!areaDao.existsById(item.getAreaId())) {
                throw new BusinessException("åŒºåŸŸä¸å­˜åœ¨: " + item.getAreaId());
            }

            // éªŒè¯æ—¶é—´èŒƒå›´
            if (item.getEffectiveDate() != null && item.getExpireDate() != null) {
                if (item.getEffectiveDate().isAfter(item.getExpireDate())) {
                    throw new BusinessException("ç”Ÿæ•ˆæ—¥æœŸä¸èƒ½æ™šäºå¤±æ•ˆæ—¥æœŸ");
                }
            }
        }
    }

    private JSONArray buildAreaConfig(List<AreaConfigItem> areaConfigs) {
        JSONArray result = new JSONArray();

        for (AreaConfigItem item : areaConfigs) {
            JSONObject config = new JSONObject();
            config.put("areaId", item.getAreaId());
            config.put("includeSubAreas", item.isIncludeSubAreas());

            if (item.getEffectiveDate() != null) {
                config.put("effectiveDate", item.getEffectiveDate().toString());
            }
            if (item.getExpireDate() != null) {
                config.put("expireDate", item.getExpireDate().toString());
            }

            result.add(config);
        }

        return result;
    }
}
```

### 3. è¡¥å¿æœºåˆ¶æœåŠ¡

```java
/**
 * åŒºåŸŸæƒé™è¡¥å¿æœºåˆ¶æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Slf4j
public class CompensationService {

    @Resource
    private RedisTemplate<String, Object> redisTemplate;

    @Resource
    private AreaUsageStatDao areaUsageStatDao;

    /**
     * æ›´æ–°åŒºåŸŸæƒé™åå‘ç´¢å¼•
     */
    public void updateAreaPermissionIndex(String accountKindId, JSONArray oldConfig, JSONArray newConfig) {
        // 1. åˆ é™¤æ—§çš„åå‘ç´¢å¼•
        if (oldConfig != null && !oldConfig.isEmpty()) {
            removeFromReverseIndex(accountKindId, oldConfig);
        }

        // 2. æ·»åŠ æ–°çš„åå‘ç´¢å¼•
        if (newConfig != null && !newConfig.isEmpty()) {
            addToReverseIndex(accountKindId, newConfig);
        }

        // 3. æ ‡è®°ç»Ÿè®¡è¡¨éœ€è¦æ›´æ–°
        markStatTableUpdate();
    }

    /**
     * ä»åå‘ç´¢å¼•ä¸­ç§»é™¤
     */
    private void removeFromReverseIndex(String accountKindId, JSONArray config) {
        for (int i = 0; i < config.size(); i++) {
            String areaId = config.getJSONObject(i).getString("areaId");
            String redisKey = "area:accountkinds:" + areaId;
            redisTemplate.opsForSet().remove(redisKey, accountKindId);
        }
    }

    /**
     * æ·»åŠ åˆ°åå‘ç´¢å¼•
     */
    private void addToReverseIndex(String accountKindId, JSONArray config) {
        for (int i = 0; i < config.size(); i++) {
            String areaId = config.getJSONObject(i).getString("areaId");
            String redisKey = "area:accountkinds:" + areaId;
            redisTemplate.opsForSet().add(redisKey, accountKindId);
            redisTemplate.expire(redisKey, 1, TimeUnit.HOURS);
        }
    }

    /**
     * æŸ¥è¯¢æŸåŒºåŸŸè¢«å“ªäº›è´¦æˆ·ç±»åˆ«ä½¿ç”¨
     */
    @Cacheable(value = "area:accountkinds", key = "#areaId")
    public Set<String> getAccountKindsByArea(String areaId) {
        // 1. å°è¯•ä»Redisè·å–
        String redisKey = "area:accountkinds:" + areaId;
        Set<Object> members = redisTemplate.opsForSet().members(redisKey);

        if (members != null && !members.isEmpty()) {
            return members.stream()
                .map(Object::toString)
                .collect(Collectors.toSet());
        }

        // 2. ä»ç»Ÿè®¡è¡¨è·å–
        AreaUsageStatEntity stat = areaUsageStatDao.findById(areaId).orElse(null);
        if (stat != null && StringUtils.isNotBlank(stat.getAccountKindIds())) {
            JSONArray accountKindIds = JSON.parseArray(stat.getAccountKindIds());
            Set<String> result = accountKindIds.stream()
                .map(Object::toString)
                .collect(Collectors.toSet());

            // é‡å»ºRedisç¼“å­˜
            redisTemplate.opsForSet().add(redisKey, result.toArray());
            redisTemplate.expire(redisKey, 1, TimeUnit.HOURS);

            return result;
        }

        // 3. å…¨è¡¨æ‰«æï¼ˆæœ€åæ‰‹æ®µï¼‰
        return fullTableSearch(areaId);
    }

    /**
     * å…¨è¡¨æ‰«ææŸ¥æ‰¾
     */
    private Set<String> fullTableSearch(String areaId) {
        // è¿™é‡Œåº”è¯¥å®ç°å…¨è¡¨æ‰«æé€»è¾‘
        // ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œåº”è¯¥åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶é¢„çƒ­æ‰€æœ‰æ•°æ®
        log.warn("æ‰§è¡Œå…¨è¡¨æ‰«ææŸ¥æ‰¾åŒºåŸŸæƒé™: areaId={}", areaId);
        return Collections.emptySet();
    }

    /**
     * æ ‡è®°ç»Ÿè®¡è¡¨éœ€è¦æ›´æ–°
     */
    private void markStatTableUpdate() {
        // è®¾ç½®æ ‡è®°ï¼Œå®šæ—¶ä»»åŠ¡ä¼šæ£€æŸ¥å¹¶æ›´æ–°ç»Ÿè®¡è¡¨
        redisTemplate.opsForValue().set("stat:table:update:needed", "true", 1, TimeUnit.HOURS);
    }

    /**
     * å®šæ—¶ä»»åŠ¡ï¼šæ›´æ–°åŒºåŸŸä½¿ç”¨ç»Ÿè®¡
     */
    @Scheduled(cron = "0 0 * * * ?")
    public void updateAreaUsageStatistics() {
        log.info("å¼€å§‹æ›´æ–°åŒºåŸŸä½¿ç”¨ç»Ÿè®¡...");

        try {
            List<AreaEntity> allAreas = areaDao.findAll();
            LocalDate today = LocalDate.now();

            for (AreaEntity area : allAreas) {
                Set<String> accountKindIds = getAccountKindsByArea(area.getId());

                AreaUsageStatEntity stat = AreaUsageStatEntity.builder()
                    .areaId(area.getId())
                    .areaName(area.getName())
                    .accountKindIds(JSON.toJSONString(accountKindIds))
                    .accountKindCount(accountKindIds.size())
                    .includeSubCount(calculateIncludeSubCount(area.getId(), accountKindIds))
                    .statDate(today)
                    .lastUpdateTime(LocalDateTime.now())
                    .build();

                areaUsageStatDao.save(stat);
            }

            log.info("åŒºåŸŸä½¿ç”¨ç»Ÿè®¡æ›´æ–°å®Œæˆï¼Œå¤„ç†{}ä¸ªåŒºåŸŸ", allAreas.size());
        } catch (Exception e) {
            log.error("æ›´æ–°åŒºåŸŸä½¿ç”¨ç»Ÿè®¡å¤±è´¥", e);
        }
    }

    /**
     * å®šæ—¶ä»»åŠ¡ï¼šæ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void validateDataConsistency() {
        log.info("å¼€å§‹æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ...");

        try {
            List<AccountKindEntity> allAccountKinds = accountKindDao.findAll();
            List<ValidationError> errors = new ArrayList<>();

            for (AccountKindEntity accountKind : allAccountKinds) {
                errors.addAll(validateAccountKindConfig(accountKind));
            }

            if (!errors.isEmpty()) {
                log.error("æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå‘ç°{}ä¸ªé”™è¯¯", errors.size());
                sendValidationErrorAlert(errors);
            } else {
                log.info("æ•°æ®ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡ï¼Œæœªå‘ç°é”™è¯¯");
            }
        } catch (Exception e) {
            log.error("æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå¤±è´¥", e);
        }
    }

    private List<ValidationError> validateAccountKindConfig(AccountKindEntity accountKind) {
        List<ValidationError> errors = new ArrayList<>();

        if (accountKind.getAreaConfig() != null) {
            JSONArray areaConfig = accountKind.getAreaConfig();

            for (int i = 0; i < areaConfig.size(); i++) {
                JSONObject config = areaConfig.getJSONObject(i);
                String areaId = config.getString("areaId");

                // æ£€æŸ¥åŒºåŸŸå­˜åœ¨æ€§
                if (!areaDao.existsById(areaId)) {
                    errors.add(new ValidationError(
                        accountKind.getId(),
                        "åŒºåŸŸä¸å­˜åœ¨: " + areaId,
                        ValidationErrorType.REFERENCE_NOT_FOUND
                    ));
                }
            }
        }

        return errors;
    }
}
```

---

## ğŸ“Š ç¼“å­˜ç­–ç•¥è®¾è®¡

### å¤šçº§ç¼“å­˜æ¶æ„

```mermaid
graph LR
    A[åº”ç”¨å±‚] --> B[æœ¬åœ°ç¼“å­˜<br/>Caffeine<br/>TTL: 5åˆ†é’Ÿ]
    A --> C[åˆ†å¸ƒå¼ç¼“å­˜<br/>Redis<br/>TTL: 30åˆ†é’Ÿ]
    C --> D[æ•°æ®åº“<br/>MySQL<br/>æŒä¹…åŒ–å­˜å‚¨]

    B --> E[ç¼“å­˜é¢„çƒ­<br/>åº”ç”¨å¯åŠ¨]
    C --> F[åå‘ç´¢å¼•<br/>Setç»“æ„]
    D --> G[ç»Ÿè®¡è¡¨<br/>å®šæ—¶æ›´æ–°]

    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e8
```

### ç¼“å­˜é”®è®¾è®¡

| ç¼“å­˜ç±»å‹ | Redis Key | æ•°æ®ç»“æ„ | TTL | è¯´æ˜ |
|---------|-----------|---------|-----|------|
| è´¦æˆ·ç±»åˆ«å®Œæ•´é…ç½® | `accountkind:full:{id}` | String(JSON) | 1å°æ—¶ | åŒ…å«mode_config+area_config |
| æœ‰æ•ˆåŒºåŸŸåˆ—è¡¨ï¼ˆå±•å¼€ï¼‰ | `accountkind:areas:{id}` | List(String) | 1å°æ—¶ | å±•å¼€includeSubAreasåçš„æ‰€æœ‰åŒºåŸŸ |
| åŒºåŸŸè¯¦æƒ…ï¼ˆå«é¤åˆ«ï¼‰ | `area:info:{areaId}` | String(JSON) | 30åˆ†é’Ÿ | åŒºåŸŸä¿¡æ¯+meal_categories |
| åŒºåŸŸæƒé™æ ¡éªŒç»“æœ | `perm:area:{accountKindId}:{areaId}` | String(å¸ƒå°”å€¼) | 30åˆ†é’Ÿ | æƒé™éªŒè¯ç»“æœç¼“å­˜ |
| åå‘ç´¢å¼• - åŒºåŸŸçš„è´¦æˆ·ç±»åˆ« | `area:accountkinds:{areaId}` | Set | 1å°æ—¶ | ä½¿ç”¨è¯¥åŒºåŸŸçš„è´¦æˆ·ç±»åˆ«IDåˆ—è¡¨ |
| ç»Ÿè®¡è¡¨æ›´æ–°æ ‡è®° | `stat:table:update:needed` | String | 1å°æ—¶ | æ ‡è®°ç»Ÿè®¡è¡¨éœ€è¦æ›´æ–° |

### ç¼“å­˜æ›´æ–°ç­–ç•¥

**ä¸»åŠ¨åˆ·æ–°æœºåˆ¶**ï¼š
- è´¦æˆ·ç±»åˆ« `area_config` å˜æ›´ â†’ åˆ é™¤è¯¥ç±»åˆ«çš„æ‰€æœ‰æƒé™ç¼“å­˜ + æ›´æ–°åå‘ç´¢å¼•
- åŒºåŸŸç»“æ„å˜æ›´ï¼ˆæ–°å¢/åˆ é™¤å­åŒºåŸŸï¼‰â†’ åˆ é™¤æ‰€æœ‰è´¦æˆ·ç±»åˆ«çš„åŒºåŸŸç¼“å­˜
- åŒºåŸŸ `meal_categories` é…ç½®å˜æ›´ â†’ åˆ é™¤åŒºåŸŸç¼“å­˜å’Œç›¸å…³æƒé™ç¼“å­˜

---

## ğŸ”§ é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ•™èŒå·¥å¡ï¼ˆå±‚çº§æƒé™ï¼‰

```json
{
  "code": "TEACHER",
  "name": "æ•™èŒå·¥å¡",
  "description": "å­¦æ ¡æ•™èŒå·¥è´¦æˆ·ç±»åˆ«",
  "area_config": [
    {
      "areaId": "main_campus",
      "includeSubAreas": true,
      "effectiveDate": "2025-01-01",
      "expireDate": null
    }
  ],
  "mode_config": {
    "FIXED_AMOUNT": {
      "enabled": true,
      "subType": "SECTION"
    },
    "FREE_AMOUNT": {
      "enabled": true,
      "maxAmount": 100000
    }
  },
  "daily_limit_amount": 15000,
  "daily_limit_count": 10
}
```

### ç¤ºä¾‹2ï¼šå­¦ç”Ÿå¡ï¼ˆå¤šä¸ªç‹¬ç«‹åŒºåŸŸï¼‰

```json
{
  "code": "STUDENT",
  "name": "å­¦ç”Ÿå¡",
  "description": "åœ¨æ ¡å­¦ç”Ÿè´¦æˆ·ç±»åˆ«",
  "area_config": [
    {
      "areaId": "canteen_1",
      "includeSubAreas": false
    },
    {
      "areaId": "canteen_2",
      "includeSubAreas": false
    },
    {
      "areaId": "library",
      "includeSubAreas": true
    },
    {
      "areaId": "sports_center",
      "includeSubAreas": false,
      "effectiveDate": "2025-01-01",
      "expireDate": "2025-06-30"
    }
  ],
  "mode_config": {
    "FIXED_AMOUNT": {
      "enabled": true,
      "subType": "SECTION"
    }
  },
  "daily_limit_amount": 5000,
  "daily_limit_count": 5
}
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡ä½“ç³»

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|---------|--------|---------|---------|
| æƒé™éªŒè¯å“åº”æ—¶é—´ | < 3ms | Prometheus | > 10ms |
| ç¼“å­˜å‘½ä¸­ç‡ | > 95% | Redisç›‘æ§ | < 90% |
| æƒé™é…ç½®å˜æ›´å»¶è¿Ÿ | < 100ms | ä¸šåŠ¡ç›‘æ§ | > 500ms |
| åå‘æŸ¥è¯¢å“åº”æ—¶é—´ | < 10ms | Prometheus | > 50ms |
| æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è€—æ—¶ | < 5min | ä»»åŠ¡ç›‘æ§ | > 10min |

### ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

```java
@Component
@Slf4j
public class AreaPermissionMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter permissionValidationCounter;
    private final Counter configChangeCounter;
    private final Timer permissionValidationTimer;

    public AreaPermissionMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.permissionValidationCounter = Counter.builder("area.permission.validation.count")
            .description("åŒºåŸŸæƒé™éªŒè¯æ¬¡æ•°")
            .register(meterRegistry);
        this.configChangeCounter = Counter.builder("area.config.change.count")
            .description("åŒºåŸŸæƒé™é…ç½®å˜æ›´æ¬¡æ•°")
            .register(meterRegistry);
        this.permissionValidationTimer = Timer.builder("area.permission.validation.duration")
            .description("æƒé™éªŒè¯è€—æ—¶")
            .register(meterRegistry);
    }

    public void recordPermissionValidation(String result) {
        permissionValidationCounter.increment(Tags.of("result", result));
    }

    public void recordConfigChange(String accountKindId, String operation) {
        configChangeCounter.increment(Tags.of("operation", operation, "accountKind", accountKindId));
    }

    public Timer.Sample startValidationTimer() {
        return Timer.start(meterRegistry);
    }
}
```

### å‘Šè­¦è§„åˆ™

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: area_permission_alerts
    rules:
      - alert: AreaPermissionValidationSlow
        expr: histogram_quantile(0.99, rate(area_permission_validation_duration_seconds_bucket[5m])) > 0.01
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "åŒºåŸŸæƒé™éªŒè¯å“åº”è¿‡æ…¢"
          description: "99%çš„æƒé™éªŒè¯è€—æ—¶è¶…è¿‡10ms"

      - alert: AreaPermissionCacheHitRateLow
        expr: area_permission_cache_hit_rate < 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "æƒé™ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ä¸º{{ $value }}%ï¼Œä½äº90%é˜ˆå€¼"

      - alert: AreaUsageStatUpdateDelay
        expr: time() - area_usage_stat_last_update_timestamp > 7200
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "åŒºåŸŸä½¿ç”¨ç»Ÿè®¡æ›´æ–°å»¶è¿Ÿ"
          description: "ç»Ÿè®¡è¡¨æœ€åæ›´æ–°æ—¶é—´è¶…è¿‡2å°æ—¶"
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### æƒé™éªŒè¯æµ‹è¯•

```java
@ExtendWith(MockitoExtension.class)
class AreaPermissionServiceTest {

    @Mock
    private AccountKindDao accountKindDao;

    @Mock
    private AreaDao areaDao;

    @Mock
    private AreaPermissionCache permissionCache;

    @InjectMocks
    private AreaPermissionService areaPermissionService;

    @Test
    @DisplayName("éªŒè¯åŒºåŸŸæƒé™æˆåŠŸ - ç›´æ¥åŒ¹é…")
    void testValidateAreaPermission_DirectMatch() {
        // Given
        String accountKindId = "TEACHER";
        String areaId = "MAIN_CAMPUS";

        JSONArray areaConfig = new JSONArray();
        JSONObject config = new JSONObject();
        config.put("areaId", "MAIN_CAMPUS");
        config.put("includeSubAreas", false);
        areaConfig.add(config);

        AccountKindEntity accountKind = AccountKindEntity.builder()
            .id(accountKindId)
            .areaConfig(areaConfig)
            .build();

        when(permissionCache.getAccountKind(accountKindId)).thenReturn(accountKind);

        // When
        AreaPermissionResult result = areaPermissionService.validateAreaPermission(accountKindId, areaId, null);

        // Then
        assertThat(result.isSuccess()).isTrue();
        verify(permissionCache).getAccountKind(accountKindId);
    }

    @Test
    @DisplayName("éªŒè¯åŒºåŸŸæƒé™æˆåŠŸ - åŒ…å«å­åŒºåŸŸ")
    void testValidateAreaPermission_IncludeSubAreas() {
        // Given
        String accountKindId = "TEACHER";
        String areaId = "CANTEEN_1"; // å­åŒºåŸŸ

        JSONArray areaConfig = new JSONArray();
        JSONObject config = new JSONObject();
        config.put("areaId", "MAIN_CAMPUS");
        config.put("includeSubAreas", true);
        areaConfig.add(config);

        AccountKindEntity accountKind = AccountKindEntity.builder()
            .id(accountKindId)
            .areaConfig(areaConfig)
            .build();

        when(permissionCache.getAccountKind(accountKindId)).thenReturn(accountKind);
        when(areaDao.findSubAreaIds("MAIN_CAMPUS")).thenReturn(Arrays.asList("CANTEEN_1", "CANTEEN_2"));

        // When
        AreaPermissionResult result = areaPermissionService.validateAreaPermission(accountKindId, areaId, null);

        // Then
        assertThat(result.isSuccess()).isTrue();
        verify(areaDao).findSubAreaIds("MAIN_CAMPUS");
    }

    @Test
    @DisplayName("éªŒè¯åŒºåŸŸæƒé™å¤±è´¥ - æ— æƒé™")
    void testValidateAreaPermission_NoPermission() {
        // Given
        String accountKindId = "STUDENT";
        String areaId = "STAFF_ONLY";

        JSONArray areaConfig = new JSONArray();
        JSONObject config = new JSONObject();
        config.put("areaId", "CANTEEN_1");
        config.put("includeSubAreas", false);
        areaConfig.add(config);

        AccountKindEntity accountKind = AccountKindEntity.builder()
            .id(accountKindId)
            .areaConfig(areaConfig)
            .build();

        when(permissionCache.getAccountKind(accountKindId)).thenReturn(accountKind);

        // When
        AreaPermissionResult result = areaPermissionService.validateAreaPermission(accountKindId, areaId, null);

        // Then
        assertThat(result.isSuccess()).isFalse();
        assertThat(result.getMessage()).isEqualTo("æ— æƒåœ¨è¯¥åŒºåŸŸæ¶ˆè´¹");
    }
}
```

---

## ğŸ“ éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒé…ç½®

```yaml
# åŒºåŸŸæƒé™ç®¡ç†é…ç½®
area-permission:
  # æƒé™éªŒè¯é…ç½®
  validation:
    cache-enabled: true
    cache-ttl: 1800  # 30åˆ†é’Ÿ
    timeout: 100  # æƒé™éªŒè¯è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰

  # è¡¥å¿æœºåˆ¶é…ç½®
  compensation:
    reverse-index-enabled: true
    stat-update-cron: "0 0 * * * ?"  # æ¯å°æ—¶æ›´æ–°
    consistency-check-cron: "0 0 2 * * ?"  # æ¯æ—¥å‡Œæ™¨2ç‚¹
    full-scan-enabled: false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­

  # ç¼“å­˜é…ç½®
  cache:
    local:
      maximum-size: 5000
      expire-after-write: 5m
    redis:
      config-ttl: 1h
      reverse-index-ttl: 1h
      permission-result-ttl: 30m

  # ç›‘æ§é…ç½®
  monitoring:
    metrics-enabled: true
    alert-enabled: true
    slow-query-threshold: 10  # æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
```

### æ•°æ®åº“åˆå§‹åŒ–

```sql
-- åˆå§‹åŒ–ç¤ºä¾‹åŒºåŸŸ
INSERT INTO area (id, code, name, parent_area_id, meal_categories, create_time) VALUES
('MAIN_CAMPUS', 'MC', 'ä¸»æ ¡åŒº', null, '["BREAKFAST", "LUNCH", "DINNER"]', NOW()),
('CANTEEN_1', 'CT1', 'ç¬¬ä¸€é£Ÿå ‚', 'MAIN_CAMPUS', '["BREAKFAST", "LUNCH", "DINNER"]', NOW()),
('CANTEEN_2', 'CT2', 'ç¬¬äºŒé£Ÿå ‚', 'MAIN_CAMPUS', '["BREAKFAST", "LUNCH", "DINNER"]', NOW()),
('LIBRARY', 'LIB', 'å›¾ä¹¦é¦†', 'MAIN_CAMPUS', null, NOW()),
('SPORTS_CENTER', 'SC', 'ä½“è‚²ä¸­å¿ƒ', 'MAIN_CAMPUS', null, NOW());

-- åˆå§‹åŒ–ç¤ºä¾‹è´¦æˆ·ç±»åˆ«
INSERT INTO account_kind (id, code, name, area_config, mode_config, create_time) VALUES
('TEACHER', 'T', 'æ•™èŒå·¥å¡',
'[{"areaId": "MAIN_CAMPUS", "includeSubAreas": true}]',
'{"FIXED_AMOUNT": {"enabled": true, "subType": "SECTION"}, "FREE_AMOUNT": {"enabled": true}}',
NOW()),
('STUDENT', 'S', 'å­¦ç”Ÿå¡',
'[{"areaId": "CANTEEN_1", "includeSubAreas": false}, {"areaId": "CANTEEN_2", "includeSubAreas": false}]',
'{"FIXED_AMOUNT": {"enabled": true, "subType": "SECTION"}}',
NOW());

-- åˆå§‹åŒ–åŒºåŸŸä½¿ç”¨ç»Ÿè®¡
INSERT INTO area_usage_stat (area_id, area_name, account_kind_ids, account_kind_count, last_update_time, stat_date)
SELECT
    a.id AS area_id,
    a.name AS area_name,
    JSON_ARRAYAGG(ak.id) AS account_kind_ids,
    COUNT(ak.id) AS account_kind_count,
    NOW() AS last_update_time,
    CURDATE() AS stat_date
FROM area a
LEFT JOIN account_kind ak ON JSON_CONTAINS(ak.area_config, JSON_OBJECT('areaId', a.id), '$')
GROUP BY a.id, a.name;
```

---

## ğŸ“‹ æ€»ç»“

### ç³»ç»Ÿä»·å€¼

âœ… **æç®€é…ç½®**ï¼šJSONå­—æ®µç›´æ¥é…ç½®ï¼Œæ— éœ€å¤æ‚å…³è”è¡¨ï¼Œé…ç½®æ•ˆç‡æå‡10å€
âœ… **é«˜é¢‘ä¼˜åŒ–**ï¼šé’ˆå¯¹85%é«˜é¢‘åœºæ™¯ï¼Œå“åº”æ—¶é—´1-3msï¼Œæ€§èƒ½å“è¶Š
âœ… **å®Œå–„è¡¥å¿**ï¼šåå‘ç´¢å¼•ã€ç»Ÿè®¡è¡¨ã€SQLè§†å›¾ä¸‰å±‚ä¿éšœï¼Œç³»ç»Ÿå¯é æ€§99.9%
âœ… **å±‚çº§æƒé™**ï¼šæ”¯æŒçˆ¶å­åŒºåŸŸæƒé™ç»§æ‰¿ï¼Œç®¡ç†æ›´çµæ´»
âœ… **å®æ—¶ç›‘æ§**ï¼šå®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»ï¼Œé—®é¢˜å¿«é€Ÿå®šä½

### æŠ€æœ¯äº®ç‚¹

ğŸ—ï¸ **Spring Boot 3.5.4 + Java 17**ï¼šæœ€æ–°æŠ€æœ¯æ ˆï¼Œæ€§èƒ½ä¼˜å¼‚
ğŸ”„ **äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼šé…ç½®å˜æ›´å®æ—¶åŒæ­¥ï¼Œä¸€è‡´æ€§ä¿éšœ
âš¡ **å¤šçº§ç¼“å­˜ä½“ç³»**ï¼šæœ¬åœ°+Redis+æ•°æ®åº“ï¼Œæ€§èƒ½æœ€ä¼˜
ğŸ“Š **æ•°æ®è¡¥å¿æœºåˆ¶**ï¼šåå‘ç´¢å¼•+ç»Ÿè®¡è¡¨+SQLè§†å›¾ï¼Œä¸‡æ— ä¸€å¤±

### é€‚ç”¨åœºæ™¯

ğŸ« **æ•™è‚²å›­åŒº**ï¼šå­¦ç”Ÿ/æ•™èŒå·¥ä¸åŒåŒºåŸŸæƒé™ç®¡ç†
ğŸ¢ **ä¼ä¸šå›­åŒº**ï¼šå‘˜å·¥è®¿å®¢æƒé™åˆ†çº§ç®¡ç†
ğŸ¥ **åŒ»ç–—æœºæ„**ï¼šä¸åŒç§‘å®¤æƒé™æ§åˆ¶
ğŸ›ï¸ **å•†ä¸šç»¼åˆä½“**ï¼šå•†é“º/åœè½¦/å¨±ä¹åˆ†åŒºç®¡ç†
ğŸŒ† **æ™ºæ…§ç¤¾åŒº**ï¼šä½æˆ·/è®¿å®¢/æœåŠ¡äººå‘˜æƒé™æ§åˆ¶

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-13
**æ›´æ–°æ—¶é—´**ï¼š2025-11-13
**é€‚ç”¨ç‰ˆæœ¬**ï¼šIOE-DREAM v1.0+
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šIOE-DREAMæŠ€æœ¯å›¢é˜Ÿ