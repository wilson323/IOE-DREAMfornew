# IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å° - æ™ºèƒ½é¤åˆ«åˆ†ç±»ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

**ç³»ç»Ÿå®šä½**ï¼šä¸ºIOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æä¾›ç»Ÿä¸€çš„é¤åˆ«åˆ†ç±»ç®¡ç†ä½“ç³»ï¼Œæ”¯æŒ"é¤åˆ«åˆ†ç±»â†’å…·ä½“é¤åˆ«"çš„äºŒçº§å±‚çº§ç»“æ„ï¼Œå®ç°è·¨ä¸šåŠ¡åœºæ™¯çš„ç»Ÿä¸€é¤åˆ«ç®¡ç†ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¢ **å…¨å›­åŒºè¦†ç›–**ï¼šæ”¯æŒé£Ÿå ‚ã€é¤å…ã€å’–å•¡å…ã€ä¾¿åˆ©åº—ç­‰å„ç±»æ¶ˆè´¹åœºæ™¯
- ğŸ¯ **æ™ºèƒ½åˆ†ç±»**ï¼šå¼•å…¥é¤åˆ«åˆ†ç±»æ¦‚å¿µï¼Œç®€åŒ–æƒé™é…ç½®å’Œç®¡ç†å¤æ‚åº¦
- âš¡ **é«˜æ•ˆç¼“å­˜**ï¼šå¤šçº§ç¼“å­˜ç­–ç•¥ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®
- ğŸ”’ **æƒé™ç²¾ç»†**ï¼šæ”¯æŒåˆ†ç±»çº§å’Œé¤åˆ«çº§çš„ç²¾ç»†åŒ–æƒé™æ§åˆ¶
- ğŸ“Š **æ•°æ®åˆ†æ**ï¼šæä¾›é¤åˆ«æ¶ˆè´¹æ•°æ®ç»Ÿè®¡å’Œè¶‹åŠ¿åˆ†æ

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ä¸šå‘˜å·¥é¤å…ç®¡ç†
- å­¦æ ¡é£Ÿå ‚é¤åˆ«ç®¡ç†
- åŒ»é™¢è¥å…»é¤ç®¡ç†
- å•†åœºç¾é£Ÿå¹¿åœºç®¡ç†
- å›­åŒºç»¼åˆé¤é¥®æœåŠ¡

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[ç®¡ç†åå°<br/>Vue 3.4 + TypeScript]
        B[ç§»åŠ¨ç«¯App<br/>uni-app]
        C[æ™ºèƒ½ç»ˆç«¯<br/>åµŒå…¥å¼è®¾å¤‡]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        D[é¤åˆ«åˆ†ç±»æœåŠ¡<br/>Spring Boot 3.5.4]
        E[é¤åˆ«ç®¡ç†æœåŠ¡<br/>Spring Boot 3.5.4]
        F[æƒé™éªŒè¯æœåŠ¡<br/>Spring Boot 3.5.4]
        G[ç»Ÿè®¡åˆ†ææœåŠ¡<br/>Spring Boot 3.5.4]
    end

    subgraph "æ•°æ®å±‚"
        H[MySQL 8.0<br/>ä¸»æ•°æ®åº“]
        I[Redis 7.0<br/>åˆ†å¸ƒå¼ç¼“å­˜]
        J[PostgreSQL 14<br/>æ•°æ®åˆ†æåº“]
    end

    subgraph "åŸºç¡€è®¾æ–½"
        K[Nacos 2.3<br/>æœåŠ¡å‘ç°]
        L[Apache Kafka 3.5<br/>æ¶ˆæ¯é˜Ÿåˆ—]
        M[Elasticsearch 8.0<br/>æ—¥å¿—æ£€ç´¢]
    end

    A --> D
    B --> E
    C --> F

    D --> H
    E --> H
    F --> H
    G --> J

    D --> I
    E --> I
    F --> I

    D --> K
    E --> K
    F --> K

    D --> L
    E --> L
    F --> L
```

### æ ¸å¿ƒç‰¹æ€§

#### ğŸ¯ äºŒçº§åˆ†ç±»ä½“ç³»
- **é¤åˆ«åˆ†ç±»ï¼ˆCategoryï¼‰**ï¼šå¤§ç±»åˆ«ï¼Œå¦‚æ—©é¤ã€åˆé¤ã€æ™šé¤ã€å¤œå®µç­‰
- **å…·ä½“é¤åˆ«ï¼ˆMealï¼‰**ï¼šåˆ†ç±»ä¸‹çš„å…·ä½“é¤åˆ«ï¼Œå¦‚è±ªåæ—©é¤ã€å·¥ä½œåˆé¤ç­‰
- **çµæ´»é…ç½®**ï¼šæ”¯æŒå…¨å±€åˆ†ç±»å’ŒåŒºåŸŸä¸“å±åˆ†ç±»

#### ğŸ”’ å¤šçº§æƒé™æ§åˆ¶
- **è´¦æˆ·ç±»åˆ«æƒé™**ï¼šé™åˆ¶è´¦æˆ·ç±»åˆ«å¯ä½¿ç”¨çš„é¤åˆ«åˆ†ç±»
- **åŒºåŸŸæä¾›æƒé™**ï¼šé™åˆ¶åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»
- **æ—¶é—´çª—å£æ§åˆ¶**ï¼šæ”¯æŒè·¨å¤©æ—¶é—´çª—å£é…ç½®

#### âš¡ é«˜æ€§èƒ½ç¼“å­˜
- **ä¸‰çº§ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜ + Redisç¼“å­˜ + æ•°æ®åº“
- **æ™ºèƒ½å¤±æ•ˆ**ï¼šäº‹ä»¶é©±åŠ¨çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶
- **ç¼“å­˜é¢„çƒ­**ï¼šå®šæ—¶é¢„çƒ­çƒ­ç‚¹æ•°æ®

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡

### 1. é¤åˆ«åˆ†ç±»ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜è¿›å…¥é¤åˆ«ç®¡ç†] --> B[é€‰æ‹©åˆ†ç±»ç®¡ç†]
    B --> C{æ“ä½œç±»å‹}

    C -->|æ–°å¢åˆ†ç±»| D[å¡«å†™åˆ†ç±»ä¿¡æ¯]
    C -->|ç¼–è¾‘åˆ†ç±»| E[åŠ è½½ç°æœ‰åˆ†ç±»]
    C -->|åˆ é™¤åˆ†ç±»| F[å®‰å…¨æ£€æŸ¥]

    D --> D1[åˆ†ç±»ç¼–å·/åç§°]
    D1 --> D2{åˆ†ç±»èŒƒå›´}
    D2 -->|å…¨å±€åˆ†ç±»| D3[é€‚ç”¨æ‰€æœ‰åŒºåŸŸ]
    D2 -->|åŒºåŸŸä¸“å±| D4[é€‰æ‹©ç‰¹å®šåŒºåŸŸ]
    D3 --> D5[è®¾ç½®æ’åºæƒé‡]
    D4 --> D5

    E --> E1[ä¿®æ”¹åˆ†ç±»ä¿¡æ¯]
    E1 --> E2[æ›´æ–°æ’åºæƒé‡]

    F --> F1[æ£€æŸ¥å…³è”é¤åˆ«]
    F1 --> F2{å­˜åœ¨å…³è”?}
    F2 -->|æ˜¯| F3[æ‹’ç»åˆ é™¤ï¼Œæç¤ºç”¨æˆ·]
    F2 -->|å¦| F4[æ£€æŸ¥æƒé™å¼•ç”¨]
    F4 --> F5{å­˜åœ¨å¼•ç”¨?}
    F5 -->|æ˜¯| F3
    F5 -->|å¦| F6[æ‰§è¡Œåˆ é™¤]

    D5 --> G[ä¿å­˜åˆ†ç±»æ•°æ®]
    E2 --> G
    F6 --> G

    G --> H[å‘å¸ƒå˜æ›´äº‹ä»¶]
    H --> I[æ›´æ–°ç›¸å…³ç¼“å­˜]
    I --> J[è¿”å›æ“ä½œç»“æœ]

    F3 --> K[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    J --> L[åˆ·æ–°åˆ†ç±»åˆ—è¡¨]
```

### 2. é¤åˆ«é…ç½®æµç¨‹

```mermaid
flowchart TD
    A[é€‰æ‹©é¤åˆ«åˆ†ç±»] --> B[ç‚¹å‡»æ–°å¢é¤åˆ«]
    B --> C[å¡«å†™åŸºç¡€ä¿¡æ¯]

    C --> D[é¤åˆ«ç¼–å·/åç§°]
    D --> E[é€‰æ‹©æ‰€å±åˆ†ç±»]
    E --> F[è®¾ç½®æ—¶é—´çª—å£]

    F --> G[å¼€å§‹æ—¶é—´é…ç½®]
    G --> H[ç»“æŸæ—¶é—´é…ç½®]
    H --> I{æ—¶é—´æ ¡éªŒ}
    I -->|å†²çª| J[æ˜¾ç¤ºå†²çªæç¤º]
    I -->|é€šè¿‡| K[é…ç½®ä»·æ ¼ç­–ç•¥]

    K --> L{ä»·æ ¼æ¨¡å¼}
    L -->|å›ºå®šä»·æ ¼| M[è®¾ç½®åŸºç¡€ä»·æ ¼]
    L -->|å¤šæ¡£ä»·æ ¼| N[é…ç½®ä»·æ ¼è§„åˆ™JSON]

    M --> O[è®¾ç½®é¤åˆ«å±æ€§]
    N --> O

    O --> P[å›¾ç‰‡ä¸Šä¼ ]
    P --> Q[è¥å…»æ ‡ç­¾é…ç½®]
    Q --> R[æ’åºæƒé‡è®¾ç½®]

    R --> S[ä¿å­˜é¤åˆ«]
    S --> T{æ•°æ®éªŒè¯}
    T -->|å¤±è´¥| U[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    T -->|æˆåŠŸ| V[å†™å…¥æ•°æ®åº“]

    V --> W[å‘å¸ƒé¤åˆ«å˜æ›´äº‹ä»¶]
    W --> X[æ¸…é™¤ç›¸å…³ç¼“å­˜]
    X --> Y[æ›´æ–°åŒºåŸŸé¤åˆ«é…ç½®]
    Y --> Z[è¿”å›æˆåŠŸç»“æœ]

    J --> F
    U --> C
```

### 3. æƒé™éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·è®¾å¤‡
    participant A as APIç½‘å…³
    participant P as æƒé™éªŒè¯æœåŠ¡
    participant C as ç¼“å­˜æœåŠ¡
    participant D as æ•°æ®åº“
    participant E as äº‹ä»¶æ€»çº¿

    U->>A: è¯·æ±‚æ¶ˆè´¹éªŒè¯
    A->>P: validateMealPermission(request)

    P->>C: æŸ¥è¯¢é¤åˆ«ä¿¡æ¯
    alt ç¼“å­˜å‘½ä¸­
        C-->>P: è¿”å›é¤åˆ«è¯¦æƒ…
    else ç¼“å­˜æœªå‘½ä¸­
        P->>D: æŸ¥è¯¢é¤åˆ«æ•°æ®
        D-->>P: é¤åˆ«å®Œæ•´ä¿¡æ¯
        P->>C: ç¼“å­˜é¤åˆ«ä¿¡æ¯
    end

    P->>C: æŸ¥è¯¢è´¦æˆ·ç±»åˆ«æƒé™
    alt ç¼“å­˜å‘½ä¸­
        C-->>P: è¿”å›å…è®¸çš„åˆ†ç±»åˆ—è¡¨
    else ç¼“å­˜æœªå‘½ä¸­
        P->>D: æŸ¥è¯¢è´¦æˆ·ç±»åˆ«å…³è”
        D-->>P: åˆ†ç±»æƒé™æ•°æ®
        P->>C: ç¼“å­˜æƒé™ä¿¡æ¯
    end

    P->>P: éªŒè¯é¤åˆ«åˆ†ç±»æƒé™
    alt åˆ†ç±»ä¸åœ¨å…è®¸åˆ—è¡¨
        P-->>A: è¿”å›æ— æƒä½¿ç”¨
    else åˆ†ç±»æƒé™é€šè¿‡
        P->>C: æŸ¥è¯¢åŒºåŸŸé¤åˆ«é…ç½®
        alt ç¼“å­˜å‘½ä¸­
            C-->>P: è¿”å›åŒºåŸŸæä¾›çš„åˆ†ç±»
        else ç¼“å­˜æœªå‘½ä¸­
            P->>D: æŸ¥è¯¢åŒºåŸŸé…ç½®
            D-->>P: åŒºåŸŸé¤åˆ«åˆ†ç±»
            P->>C: ç¼“å­˜åŒºåŸŸé…ç½®
        end

        P->>P: éªŒè¯åŒºåŸŸæä¾›æƒé™
        alt åŒºåŸŸä¸æä¾›è¯¥åˆ†ç±»
            P-->>A: è¿”å›åŒºåŸŸä¸æä¾›
        else æƒé™é€šè¿‡
            P->>P: éªŒè¯æ—¶é—´çª—å£
            alt å½“å‰æ—¶é—´ä¸åœ¨çª—å£å†…
                P-->>A: è¿”å›éå°±é¤æ—¶é—´
            else éªŒè¯é€šè¿‡
                P->>E: å‘å¸ƒéªŒè¯æˆåŠŸäº‹ä»¶
                P-->>A: è¿”å›éªŒè¯é€šè¿‡
            end
        end
    end

    A-->>U: è¿”å›éªŒè¯ç»“æœ
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. é¤åˆ«åˆ†ç±»è¡¨ï¼ˆmeal_categoryï¼‰

```sql
CREATE TABLE meal_category (
    id VARCHAR(50) PRIMARY KEY COMMENT 'åˆ†ç±»ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'åˆ†ç±»ç¼–å·',
    name VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°',
    area_id VARCHAR(50) COMMENT 'å…³è”åŒºåŸŸIDï¼ˆå¯é€‰ï¼Œnullè¡¨ç¤ºå…¨å±€åˆ†ç±»ï¼‰',
    sort_order INT DEFAULT 0 COMMENT 'æ’åºæƒé‡',
    description VARCHAR(255) COMMENT 'åˆ†ç±»æè¿°',
    icon_url VARCHAR(500) COMMENT 'åˆ†ç±»å›¾æ ‡URL',
    color_code VARCHAR(20) COMMENT 'åˆ†ç±»é¢œè‰²ä»£ç ',
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿé¢„å®šä¹‰',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_code(code) COMMENT 'ç¼–å·ç´¢å¼•',
    INDEX idx_area(area_id) COMMENT 'åŒºåŸŸç´¢å¼•',
    INDEX idx_sort(sort_order, available) COMMENT 'æ’åºç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',

    FOREIGN KEY (area_id) REFERENCES area(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é¤åˆ«åˆ†ç±»è¡¨';
```

#### 2. é¤åˆ«ä¿¡æ¯è¡¨ï¼ˆmealï¼‰

```sql
CREATE TABLE meal (
    id VARCHAR(50) PRIMARY KEY COMMENT 'é¤åˆ«ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'é¤åˆ«ç¼–å·',
    name VARCHAR(100) NOT NULL COMMENT 'é¤åˆ«åç§°',
    category_id VARCHAR(50) NOT NULL COMMENT 'æ‰€å±åˆ†ç±»ID',
    start_time TIME NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
    end_time TIME NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
    base_price DECIMAL(10,2) COMMENT 'åŸºç¡€ä»·æ ¼',
    price_rules JSON COMMENT 'ä»·æ ¼è§„åˆ™é…ç½®',
    image_url VARCHAR(500) COMMENT 'é¤åˆ«å›¾ç‰‡URL',
    description TEXT COMMENT 'é¤åˆ«æè¿°',
    nutrition_tags JSON COMMENT 'è¥å…»æ ‡ç­¾',
    allergy_info JSON COMMENT 'è¿‡æ•åŸä¿¡æ¯',
    calories DECIMAL(8,2) COMMENT 'çƒ­é‡ï¼ˆåƒå¡ï¼‰',
    sort_order INT DEFAULT 0 COMMENT 'æ’åºæƒé‡',
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    is_seasonal BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å­£èŠ‚é™å®š',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_code(code) COMMENT 'ç¼–å·ç´¢å¼•',
    INDEX idx_category(category_id, available) COMMENT 'åˆ†ç±»ç´¢å¼•',
    INDEX idx_time(start_time, end_time, available) COMMENT 'æ—¶é—´ç´¢å¼•',
    INDEX idx_sort(sort_order) COMMENT 'æ’åºç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',

    FOREIGN KEY (category_id) REFERENCES meal_category(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é¤åˆ«ä¿¡æ¯è¡¨';
```

#### 3. è´¦æˆ·ç±»åˆ«-é¤åˆ«åˆ†ç±»å…³è”è¡¨ï¼ˆaccount_kind_meal_categoryï¼‰

```sql
CREATE TABLE account_kind_meal_category (
    id VARCHAR(50) PRIMARY KEY COMMENT 'å…³è”ID',
    account_kind_id VARCHAR(50) NOT NULL COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    meal_category_id VARCHAR(50) NOT NULL COMMENT 'é¤åˆ«åˆ†ç±»ID',
    daily_limit_count INT COMMENT 'æ¯æ—¥æ¶ˆè´¹æ¬¡æ•°é™åˆ¶',
    daily_limit_amount DECIMAL(10,2) COMMENT 'æ¯æ—¥æ¶ˆè´¹é‡‘é¢é™åˆ¶',
    weekly_limit_count INT COMMENT 'æ¯å‘¨æ¶ˆè´¹æ¬¡æ•°é™åˆ¶',
    weekly_limit_amount DECIMAL(10,2) COMMENT 'æ¯å‘¨æ¶ˆè´¹é‡‘é¢é™åˆ¶',
    discount_rate DECIMAL(5,4) DEFAULT 1.0000 COMMENT 'æŠ˜æ‰£ç‡ï¼ˆå¦‚0.9è¡¨ç¤º9æŠ˜ï¼‰',
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    effect_date DATE COMMENT 'ç”Ÿæ•ˆæ—¥æœŸ',
    expire_date DATE COMMENT 'å¤±æ•ˆæ—¥æœŸ',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_kind(account_kind_id) COMMENT 'è´¦æˆ·ç±»åˆ«ç´¢å¼•',
    INDEX idx_category(meal_category_id) COMMENT 'é¤åˆ«åˆ†ç±»ç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',
    UNIQUE KEY uk_kind_category(account_kind_id, meal_category_id) COMMENT 'å”¯ä¸€çº¦æŸ',

    FOREIGN KEY (account_kind_id) REFERENCES account_kind(id) ON DELETE CASCADE,
    FOREIGN KEY (meal_category_id) REFERENCES meal_category(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è´¦æˆ·ç±»åˆ«-é¤åˆ«åˆ†ç±»å…³è”è¡¨';
```

#### 4. åŒºåŸŸ-é¤åˆ«åˆ†ç±»é…ç½®è¡¨ï¼ˆarea_meal_categoryï¼‰

```sql
CREATE TABLE area_meal_category (
    id VARCHAR(50) PRIMARY KEY COMMENT 'é…ç½®ID',
    area_id VARCHAR(50) NOT NULL COMMENT 'åŒºåŸŸID',
    meal_category_id VARCHAR(50) NOT NULL COMMENT 'é¤åˆ«åˆ†ç±»ID',
    priority INT DEFAULT 0 COMMENT 'ä¼˜å…ˆçº§',
    max_daily_count INT COMMENT 'è¯¥åŒºåŸŸæ¯æ—¥æœ€å¤§ä¾›åº”æ¬¡æ•°',
    available_time_slots JSON COMMENT 'å¯ç”¨æ—¶é—´æ®µé…ç½®',
    special_price_rules JSON COMMENT 'ç‰¹æ®Šä»·æ ¼è§„åˆ™',
    available BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    effect_date DATE COMMENT 'ç”Ÿæ•ˆæ—¥æœŸ',
    expire_date DATE COMMENT 'å¤±æ•ˆæ—¥æœŸ',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    remark TEXT COMMENT 'å¤‡æ³¨ä¿¡æ¯',

    INDEX idx_area(area_id) COMMENT 'åŒºåŸŸç´¢å¼•',
    INDEX idx_category(meal_category_id) COMMENT 'é¤åˆ«åˆ†ç±»ç´¢å¼•',
    INDEX idx_available(available) COMMENT 'çŠ¶æ€ç´¢å¼•',
    UNIQUE KEY uk_area_category(area_id, meal_category_id) COMMENT 'å”¯ä¸€çº¦æŸ',

    FOREIGN KEY (area_id) REFERENCES area(id) ON DELETE CASCADE,
    FOREIGN KEY (meal_category_id) REFERENCES meal_category(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åŒºåŸŸ-é¤åˆ«åˆ†ç±»é…ç½®è¡¨';
```

### è§†å›¾è®¾è®¡

#### 1. é¤åˆ«å®Œæ•´ä¿¡æ¯è§†å›¾

```sql
CREATE VIEW v_meal_full_info AS
SELECT
    m.id,
    m.code,
    m.name,
    m.category_id,
    mc.name AS category_name,
    mc.code AS category_code,
    m.start_time,
    m.end_time,
    m.base_price,
    m.price_rules,
    m.image_url,
    m.description,
    m.nutrition_tags,
    m.allergy_info,
    m.calories,
    m.sort_order,
    m.available,
    m.is_seasonal,
    mc.icon_url AS category_icon,
    mc.color_code AS category_color,
    m.create_time,
    m.update_time
FROM meal m
LEFT JOIN meal_category mc ON m.category_id = mc.id
WHERE m.available = TRUE AND mc.available = TRUE;
```

---

## ğŸ’» æ ¸å¿ƒæœåŠ¡å®ç°

### 1. é¤åˆ«åˆ†ç±»ç®¡ç†æœåŠ¡

```java
/**
 * é¤åˆ«åˆ†ç±»ç®¡ç†æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Transactional
@Slf4j
public class MealCategoryService {

    @Resource
    private MealCategoryDao mealCategoryDao;

    @Resource
    private AreaMealCategoryDao areaMealCategoryDao;

    @Resource
    private AccountKindMealCategoryDao accountKindMealCategoryDao;

    @Resource
    private ApplicationEventPublisher eventPublisher;

    /**
     * åˆ›å»ºé¤åˆ«åˆ†ç±»
     */
    public MealCategoryResponse createCategory(MealCategoryCreateRequest request) {
        // 1. æ•°æ®éªŒè¯
        validateCreateRequest(request);

        // 2. æ„å»ºå®ä½“
        MealCategoryEntity category = buildCategoryEntity(request);

        // 3. ä¿å­˜æ•°æ®
        mealCategoryDao.save(category);

        // 4. å…³è”åŒºåŸŸé…ç½®
        if (request.getAreaIds() != null && !request.getAreaIds().isEmpty()) {
            saveAreaCategoryRelations(category.getId(), request.getAreaIds());
        }

        // 5. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealCategoryChangeEvent(this, category.getId(), MealCategoryChangeType.CREATE)
        );

        log.info("åˆ›å»ºé¤åˆ«åˆ†ç±»æˆåŠŸ: {}", category.getCode());
        return MealCategoryResponse.from(category);
    }

    /**
     * æ›´æ–°é¤åˆ«åˆ†ç±»
     */
    public MealCategoryResponse updateCategory(String categoryId, MealCategoryUpdateRequest request) {
        MealCategoryEntity category = mealCategoryDao.findById(categoryId)
            .orElseThrow(() -> new BusinessException("é¤åˆ«åˆ†ç±»ä¸å­˜åœ¨"));

        // æ›´æ–°å­—æ®µ
        updateCategoryFields(category, request);

        // ä¿å­˜æ›´æ–°
        mealCategoryDao.save(category);

        // æ›´æ–°åŒºåŸŸå…³è”å…³ç³»
        if (request.getAreaIds() != null) {
            updateAreaCategoryRelations(categoryId, request.getAreaIds());
        }

        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealCategoryChangeEvent(this, categoryId, MealCategoryChangeType.UPDATE)
        );

        log.info("æ›´æ–°é¤åˆ«åˆ†ç±»æˆåŠŸ: {}", category.getCode());
        return MealCategoryResponse.from(category);
    }

    /**
     * åˆ é™¤é¤åˆ«åˆ†ç±»ï¼ˆå®‰å…¨åˆ é™¤ï¼‰
     */
    public void deleteCategory(String categoryId) {
        // 1. æ£€æŸ¥é¤åˆ«å…³è”
        if (mealDao.existsByCategoryIdAndAvailableTrue(categoryId)) {
            throw new BusinessException("è¯¥åˆ†ç±»ä¸‹å­˜åœ¨å¯ç”¨çš„é¤åˆ«ï¼Œæ— æ³•åˆ é™¤");
        }

        // 2. æ£€æŸ¥è´¦æˆ·ç±»åˆ«å¼•ç”¨
        if (accountKindMealCategoryDao.existsByMealCategoryId(categoryId)) {
            throw new BusinessException("è¯¥åˆ†ç±»å·²è¢«è´¦æˆ·ç±»åˆ«ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤");
        }

        // 3. æ£€æŸ¥åŒºåŸŸå¼•ç”¨
        if (areaMealCategoryDao.existsByMealCategoryId(categoryId)) {
            throw new BusinessException("è¯¥åˆ†ç±»å·²è¢«åŒºåŸŸé…ç½®ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤");
        }

        // 4. æ‰§è¡Œåˆ é™¤
        mealCategoryDao.deleteById(categoryId);

        // 5. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealCategoryChangeEvent(this, categoryId, MealCategoryChangeType.DELETE)
        );

        log.info("åˆ é™¤é¤åˆ«åˆ†ç±»æˆåŠŸ: {}", categoryId);
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢é¤åˆ«åˆ†ç±»
     */
    public PageResult<MealCategoryResponse> queryCategories(MealCategoryQueryRequest request) {
        Page<MealCategoryEntity> page = mealCategoryDao.findByCondition(
            request.buildQueryWrapper(),
            PageRequest.of(request.getPageNum(), request.getPageSize())
        );

        List<MealCategoryResponse> responses = page.getContent().stream()
            .map(MealCategoryResponse::from)
            .collect(Collectors.toList());

        return PageResult.<MealCategoryResponse>builder()
            .pageNum(request.getPageNum())
            .pageSize(request.getPageSize())
            .totalCount(page.getTotalElements())
            .data(responses)
            .build();
    }

    /**
     * è·å–æ‰€æœ‰å¯ç”¨çš„é¤åˆ«åˆ†ç±»
     */
    @Cacheable(value = "meal:categories:all", key = "'available'")
    public List<MealCategoryResponse> getAllAvailableCategories() {
        List<MealCategoryEntity> categories = mealCategoryDao.findByAvailableTrueOrderBySortOrder();

        return categories.stream()
            .map(MealCategoryResponse::from)
            .collect(Collectors.toList());
    }

    private void validateCreateRequest(MealCategoryCreateRequest request) {
        // æ£€æŸ¥ç¼–å·å”¯ä¸€æ€§
        if (mealCategoryDao.existsByCode(request.getCode())) {
            throw new BusinessException("åˆ†ç±»ç¼–å·å·²å­˜åœ¨: " + request.getCode());
        }

        // æ£€æŸ¥åç§°å”¯ä¸€æ€§ï¼ˆåŒä¸€åŒºåŸŸå†…ï¼‰
        if (request.getAreaId() != null) {
            if (mealCategoryDao.existsByNameAndAreaId(request.getName(), request.getAreaId())) {
                throw new BusinessException("è¯¥åŒºåŸŸå†…åˆ†ç±»åç§°å·²å­˜åœ¨: " + request.getName());
            }
        } else {
            if (mealCategoryDao.existsByNameAndAreaIdIsNull(request.getName())) {
                throw new BusinessException("å…¨å±€åˆ†ç±»åç§°å·²å­˜åœ¨: " + request.getName());
            }
        }
    }

    private MealCategoryEntity buildCategoryEntity(MealCategoryCreateRequest request) {
        MealCategoryEntity entity = new MealCategoryEntity();
        entity.setId(IdUtil.fastSimpleUUID());
        entity.setCode(request.getCode());
        entity.setName(request.getName());
        entity.setAreaId(request.getAreaId());
        entity.setSortOrder(request.getSortOrder() != null ? request.getSortOrder() : 0);
        entity.setDescription(request.getDescription());
        entity.setIconUrl(request.getIconUrl());
        entity.setColorCode(request.getColorCode());
        entity.setAvailable(true);
        entity.setIsSystem(false);
        entity.setCreateBy(SecurityUtils.getCurrentUserId());
        entity.setRemark(request.getRemark());
        return entity;
    }
}
```

### 2. é¤åˆ«ç®¡ç†æœåŠ¡

```java
/**
 * é¤åˆ«ç®¡ç†æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Transactional
@Slf4j
public class MealService {

    @Resource
    private MealDao mealDao;

    @Resource
    private MealCategoryDao mealCategoryDao;

    @Resource
    private ApplicationEventPublisher eventPublisher;

    /**
     * åˆ›å»ºé¤åˆ«
     */
    public MealResponse createMeal(MealCreateRequest request) {
        // 1. æ•°æ®éªŒè¯
        validateCreateRequest(request);

        // 2. æ„å»ºå®ä½“
        MealEntity meal = buildMealEntity(request);

        // 3. ä¿å­˜æ•°æ®
        mealDao.save(meal);

        // 4. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealChangeEvent(this, meal.getId(), MealChangeType.CREATE)
        );

        log.info("åˆ›å»ºé¤åˆ«æˆåŠŸ: {}", meal.getCode());
        return MealResponse.from(meal);
    }

    /**
     * æ›´æ–°é¤åˆ«
     */
    public MealResponse updateMeal(String mealId, MealUpdateRequest request) {
        MealEntity meal = mealDao.findById(mealId)
            .orElseThrow(() -> new BusinessException("é¤åˆ«ä¸å­˜åœ¨"));

        // æ›´æ–°å­—æ®µ
        updateMealFields(meal, request);

        // ä¿å­˜æ›´æ–°
        mealDao.save(meal);

        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealChangeEvent(this, mealId, MealChangeType.UPDATE)
        );

        log.info("æ›´æ–°é¤åˆ«æˆåŠŸ: {}", meal.getCode());
        return MealResponse.from(meal);
    }

    /**
     * åˆ é™¤é¤åˆ«ï¼ˆè½¯åˆ é™¤ï¼‰
     */
    public void deleteMeal(String mealId) {
        MealEntity meal = mealDao.findById(mealId)
            .orElseThrow(() -> new BusinessException("é¤åˆ«ä¸å­˜åœ¨"));

        // æ£€æŸ¥æ˜¯å¦æœ‰äº¤æ˜“è®°å½•
        if (transactionDao.existsByMealId(mealId)) {
            // å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œæ‰§è¡Œè½¯åˆ é™¤
            meal.setAvailable(false);
            meal.setUpdateBy(SecurityUtils.getCurrentUserId());
            mealDao.save(meal);

            log.info("é¤åˆ«å·²ç¦ç”¨ï¼ˆè½¯åˆ é™¤ï¼‰: {}", meal.getCode());
        } else {
            // æ— äº¤æ˜“è®°å½•ï¼Œæ‰§è¡Œç‰©ç†åˆ é™¤
            mealDao.deleteById(mealId);

            log.info("é¤åˆ«å·²åˆ é™¤: {}", meal.getCode());
        }

        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new MealChangeEvent(this, mealId, MealChangeType.DELETE)
        );
    }

    /**
     * è·å–å½“å‰å¯ç”¨çš„é¤åˆ«åˆ—è¡¨
     */
    @Cacheable(value = "meal:current:available", key = "#areaId")
    public List<MealResponse> getCurrentAvailableMeals(String areaId) {
        // 1. è·å–åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»
        List<String> categoryIds = areaMealCategoryDao.findCategoryIdsByAreaId(areaId);

        if (categoryIds.isEmpty()) {
            return Collections.emptyList();
        }

        // 2. æŸ¥è¯¢è¿™äº›åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ«
        List<MealEntity> meals = mealDao.findByCategoryIdInAndAvailableTrueOrderBySortOrder(categoryIds);

        // 3. è¿‡æ»¤å½“å‰æ—¶é—´æ®µå¯ç”¨çš„é¤åˆ«
        LocalTime now = LocalTime.now();
        List<MealEntity> availableMeals = meals.stream()
            .filter(meal -> isInTimeWindow(meal, now))
            .collect(Collectors.toList());

        return availableMeals.stream()
            .map(MealResponse::from)
            .collect(Collectors.toList());
    }

    /**
     * è·å–ç”¨æˆ·åœ¨æŒ‡å®šåŒºåŸŸçš„å¯ç”¨é¤åˆ«ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼‰
     */
    public MealCategoryWithMealsResponse getAvailableMealsForUser(
        String accountKindId, String areaId
    ) {
        // 1. è·å–è´¦æˆ·ç±»åˆ«å…è®¸çš„é¤åˆ«åˆ†ç±»
        List<String> accountCategoryIds = accountKindMealCategoryDao
            .findCategoryIdsByAccountKindId(accountKindId);

        // 2. è·å–åŒºåŸŸæä¾›çš„é¤åˆ«åˆ†ç±»
        List<String> areaCategoryIds = areaMealCategoryDao
            .findCategoryIdsByAreaId(areaId);

        // 3. è®¡ç®—äº¤é›†
        List<String> availableCategoryIds = accountCategoryIds.stream()
            .filter(areaCategoryIds::contains)
            .collect(Collectors.toList());

        if (availableCategoryIds.isEmpty()) {
            return MealCategoryWithMealsResponse.empty();
        }

        // 4. æ„å»ºç»“æœ
        List<MealCategoryWithMeals> categoriesWithMeals = new ArrayList<>();
        LocalTime now = LocalTime.now();

        for (String categoryId : availableCategoryIds) {
            MealCategoryEntity category = mealCategoryDao.findById(categoryId).orElse(null);
            if (category == null || !category.getAvailable()) {
                continue;
            }

            // è·å–è¯¥åˆ†ç±»ä¸‹çš„é¤åˆ«
            List<MealEntity> meals = mealDao
                .findByCategoryIdAndAvailableTrueOrderBySortOrder(categoryId);

            // è¿‡æ»¤å½“å‰æ—¶é—´å¯ç”¨çš„é¤åˆ«
            List<MealResponse> availableMeals = meals.stream()
                .filter(meal -> isInTimeWindow(meal, now))
                .map(MealResponse::from)
                .collect(Collectors.toList());

            if (!availableMeals.isEmpty()) {
                categoriesWithMeals.add(
                    MealCategoryWithMeals.builder()
                        .category(MealCategoryResponse.from(category))
                        .meals(availableMeals)
                        .build()
                );
            }
        }

        return MealCategoryWithMealsResponse.builder()
            .areaId(areaId)
            .accountKindId(accountKindId)
            .categories(categoriesWithMeals)
            .queryTime(LocalDateTime.now())
            .build();
    }

    private boolean isInTimeWindow(MealEntity meal, LocalTime now) {
        LocalTime start = meal.getStartTime();
        LocalTime end = meal.getEndTime();

        // æ”¯æŒè·¨å¤©æ—¶é—´çª—å£ï¼ˆå¦‚23:00-01:00ï¼‰
        if (start.isBefore(end)) {
            // æ­£å¸¸æƒ…å†µï¼šstart < end
            return !now.isBefore(start) && !now.isAfter(end);
        } else {
            // è·¨å¤©æƒ…å†µï¼šstart > end
            return !now.isBefore(start) || !now.isAfter(end);
        }
    }
}
```

### 3. æƒé™éªŒè¯æœåŠ¡

```java
/**
 * é¤åˆ«æƒé™éªŒè¯æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Slf4j
public class MealPermissionService {

    @Resource
    private MealCacheManager cacheManager;

    @Resource
    private MealPermissionCache permissionCache;

    /**
     * éªŒè¯é¤åˆ«æ¶ˆè´¹æƒé™
     */
    public MealPermissionResult validateMealPermission(MealPermissionRequest request) {
        // 1. è·å–é¤åˆ«ä¿¡æ¯
        MealEntity meal = cacheManager.getMeal(request.getMealId());
        if (meal == null || !meal.getAvailable()) {
            return MealPermissionResult.fail("é¤åˆ«ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }

        // 2. éªŒè¯è´¦æˆ·ç±»åˆ«æƒé™
        if (!validateAccountKindPermission(request.getAccountKindId(), meal.getCategoryId())) {
            return MealPermissionResult.fail("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
        }

        // 3. éªŒè¯åŒºåŸŸæä¾›æƒé™
        if (!validateAreaPermission(request.getAreaId(), meal.getCategoryId())) {
            return MealPermissionResult.fail("è¯¥åŒºåŸŸä¸æä¾›æ­¤é¤åˆ«");
        }

        // 4. éªŒè¯æ—¶é—´çª—å£
        if (!validateTimeWindow(meal, request.getConsumeTime())) {
            return MealPermissionResult.fail("å½“å‰ä¸åœ¨å°±é¤æ—¶é—´æ®µ");
        }

        // 5. éªŒè¯é€šè¿‡ï¼Œè¿”å›é¤åˆ«ä¿¡æ¯
        return MealPermissionResult.success(meal);
    }

    /**
     * æ‰¹é‡éªŒè¯é¤åˆ«æƒé™
     */
    public Map<String, MealPermissionResult> batchValidateMealPermission(
        List<MealPermissionRequest> requests
    ) {
        return requests.parallelStream()
            .collect(Collectors.toMap(
                MealPermissionRequest::getMealId,
                this::validateMealPermission
            ));
    }

    /**
     * è·å–ç”¨æˆ·æƒé™ç»Ÿè®¡ä¿¡æ¯
     */
    public UserMealPermissionStats getUserPermissionStats(
        String accountKindId, String areaId
    ) {
        // 1. è·å–è´¦æˆ·ç±»åˆ«å…è®¸çš„åˆ†ç±»
        Set<String> accountCategories = cacheManager.getAccountKindMealCategories(accountKindId);

        // 2. è·å–åŒºåŸŸæä¾›çš„åˆ†ç±»
        Set<String> areaCategories = cacheManager.getAreaMealCategories(areaId);

        // 3. è®¡ç®—äº¤é›†
        Set<String> availableCategories = new HashSet<>(accountCategories);
        availableCategories.retainAll(areaCategories);

        // 4. ç»Ÿè®¡ä¿¡æ¯
        int totalCategories = availableCategories.size();
        int totalMeals = 0;

        LocalTime now = LocalTime.now();
        for (String categoryId : availableCategories) {
            List<MealEntity> meals = cacheManager.getMealsByCategory(categoryId);
            long availableMealCount = meals.stream()
                .filter(meal -> isInTimeWindow(meal, now))
                .count();
            totalMeals += availableMealCount;
        }

        return UserMealPermissionStats.builder()
            .accountKindId(accountKindId)
            .areaId(areaId)
            .totalCategories(totalCategories)
            .totalAvailableMeals(totalMeals)
            .queryTime(LocalDateTime.now())
            .build();
    }

    private boolean validateAccountKindPermission(String accountKindId, String categoryId) {
        // ä»ç¼“å­˜è·å–æƒé™ä¿¡æ¯
        return permissionCache.hasAccountKindCategoryPermission(accountKindId, categoryId);
    }

    private boolean validateAreaPermission(String areaId, String categoryId) {
        // ä»ç¼“å­˜è·å–åŒºåŸŸæä¾›ä¿¡æ¯
        return permissionCache.hasAreaCategoryPermission(areaId, categoryId);
    }

    private boolean validateTimeWindow(MealEntity meal, LocalDateTime consumeTime) {
        LocalTime mealTime = consumeTime.toLocalTime();
        return isInTimeWindow(meal, mealTime);
    }

    private boolean isInTimeWindow(MealEntity meal, LocalTime now) {
        LocalTime start = meal.getStartTime();
        LocalTime end = meal.getEndTime();

        if (start.isBefore(end)) {
            return !now.isBefore(start) && !now.isAfter(end);
        } else {
            return !now.isBefore(start) || !now.isAfter(end);
        }
    }
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç¼“å­˜æ¶æ„

```mermaid
graph LR
    A[åº”ç”¨å±‚] --> B[æœ¬åœ°ç¼“å­˜<br/>Caffeine<br/>TTL: 5åˆ†é’Ÿ]
    A --> C[åˆ†å¸ƒå¼ç¼“å­˜<br/>Redis<br/>TTL: 30åˆ†é’Ÿ]
    C --> D[æ•°æ®åº“<br/>MySQL<br/>æŒä¹…åŒ–å­˜å‚¨]

    B --> E[ç¼“å­˜é¢„çƒ­<br/>å®šæ—¶ä»»åŠ¡]
    C --> F[ç¼“å­˜æ›´æ–°<br/>äº‹ä»¶é©±åŠ¨]
    D --> G[æ•°æ®åŒæ­¥<br/>Binlogç›‘å¬]

    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e8
```

### ç¼“å­˜é”®è®¾è®¡

| ç¼“å­˜ç±»å‹ | Redis Key | æ•°æ®ç»“æ„ | TTL | è¯´æ˜ |
|---------|-----------|---------|-----|------|
| é¤åˆ«åˆ†ç±»åˆ—è¡¨ | `meal:categories:all` | String(JSON) | 30åˆ†é’Ÿ | æ‰€æœ‰é¤åˆ«åˆ†ç±» |
| å•ä¸ªåˆ†ç±»è¯¦æƒ… | `meal:category:{id}` | String(JSON) | 30åˆ†é’Ÿ | åˆ†ç±»è¯¦ç»†ä¿¡æ¯ |
| åˆ†ç±»ä¸‹é¤åˆ«åˆ—è¡¨ | `meal:category:{id}:meals` | String(JSON) | 30åˆ†é’Ÿ | åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¤åˆ« |
| é¤åˆ«è¯¦æƒ… | `meal:info:{id}` | String(JSON) | 30åˆ†é’Ÿ | é¤åˆ«è¯¦ç»†ä¿¡æ¯ |
| å½“å‰å¯ç”¨é¤åˆ« | `meal:current:{areaId}` | String(JSON) | 10åˆ†é’Ÿ | åŒºåŸŸå½“å‰å¯ç”¨é¤åˆ« |
| ç”¨æˆ·æƒé™ç¼“å­˜ | `perm:user:{userId}:categories` | Set | 1å°æ—¶ | ç”¨æˆ·å…è®¸çš„åˆ†ç±» |
| è´¦æˆ·ç±»åˆ«æƒé™ | `perm:account:{kindId}:categories` | Set | 1å°æ—¶ | è´¦æˆ·ç±»åˆ«æƒé™ |
| åŒºåŸŸæä¾›åˆ†ç±» | `perm:area:{areaId}:categories` | Set | 1å°æ—¶ | åŒºåŸŸæä¾›çš„åˆ†ç±» |

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|---------|--------|---------|---------|
| é¤åˆ«æŸ¥è¯¢å“åº”æ—¶é—´ | < 10ms | Prometheus | > 50ms |
| æƒé™éªŒè¯å“åº”æ—¶é—´ | < 15ms | Prometheus | > 100ms |
| ç¼“å­˜å‘½ä¸­ç‡ | > 95% | Redisç›‘æ§ | < 90% |
| æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ | < 80% | Druidç›‘æ§ | > 90% |
| å¹¶å‘è¯·æ±‚QPS | 5000+ | Nginxç›‘æ§ | < 3000 |

### ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

```java
@Component
@Slf4j
public class MealMetricsCollector {

    private final MeterRegistry meterRegistry;
    private final Counter mealQueryCounter;
    private final Counter permissionCheckCounter;
    private final Timer mealQueryTimer;

    public MealMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.mealQueryCounter = Counter.builder("meal.query.count")
            .description("é¤åˆ«æŸ¥è¯¢æ¬¡æ•°")
            .register(meterRegistry);
        this.permissionCheckCounter = Counter.builder("meal.permission.check.count")
            .description("æƒé™éªŒè¯æ¬¡æ•°")
            .register(meterRegistry);
        this.mealQueryTimer = Timer.builder("meal.query.duration")
            .description("é¤åˆ«æŸ¥è¯¢è€—æ—¶")
            .register(meterRegistry);
    }

    public void recordMealQuery(String operation) {
        mealQueryCounter.increment(Tags.of("operation", operation));
    }

    public void recordPermissionCheck(String result) {
        permissionCheckCounter.increment(Tags.of("result", result));
    }

    public Timer.Sample startMealQueryTimer() {
        return Timer.start(meterRegistry);
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```java
@ExtendWith(MockitoExtension.class)
class MealPermissionServiceTest {

    @Mock
    private MealCacheManager cacheManager;

    @Mock
    private MealPermissionCache permissionCache;

    @InjectMocks
    private MealPermissionService mealPermissionService;

    @Test
    @DisplayName("éªŒè¯é¤åˆ«æƒé™ - æˆåŠŸåœºæ™¯")
    void testValidateMealPermission_Success() {
        // Given
        String accountKindId = "EMPLOYEE";
        String areaId = "AREA001";
        String mealId = "MEAL001";

        MealEntity meal = MealEntity.builder()
            .id(mealId)
            .categoryId("BREAKFAST")
            .startTime(LocalTime.of(6, 0))
            .endTime(LocalTime.of(10, 0))
            .available(true)
            .build();

        MealPermissionRequest request = MealPermissionRequest.builder()
            .accountKindId(accountKindId)
            .areaId(areaId)
            .mealId(mealId)
            .consumeTime(LocalDateTime.of(2024, 1, 1, 8, 0))
            .build();

        when(cacheManager.getMeal(mealId)).thenReturn(meal);
        when(permissionCache.hasAccountKindCategoryPermission(accountKindId, "BREAKFAST"))
            .thenReturn(true);
        when(permissionCache.hasAreaCategoryPermission(areaId, "BREAKFAST"))
            .thenReturn(true);

        // When
        MealPermissionResult result = mealPermissionService.validateMealPermission(request);

        // Then
        assertThat(result.isSuccess()).isTrue();
        assertThat(result.getMeal()).isEqualTo(meal);

        verify(cacheManager).getMeal(mealId);
        verify(permissionCache).hasAccountKindCategoryPermission(accountKindId, "BREAKFAST");
        verify(permissionCache).hasAreaCategoryPermission(areaId, "BREAKFAST");
    }

    @Test
    @DisplayName("éªŒè¯é¤åˆ«æƒé™ - é¤åˆ«ä¸å­˜åœ¨")
    void testValidateMealPermission_MealNotFound() {
        // Given
        String mealId = "NONEXISTENT";

        MealPermissionRequest request = MealPermissionRequest.builder()
            .accountKindId("EMPLOYEE")
            .areaId("AREA001")
            .mealId(mealId)
            .consumeTime(LocalDateTime.now())
            .build();

        when(cacheManager.getMeal(mealId)).thenReturn(null);

        // When
        MealPermissionResult result = mealPermissionService.validateMealPermission(request);

        // Then
        assertThat(result.isSuccess()).isFalse();
        assertThat(result.getMessage()).isEqualTo("é¤åˆ«ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
    }
}
```

---

## ğŸ“ éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒè¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | èµ„æºè¦æ±‚ |
|------|---------|---------|
| Java | 17+ | 2GB+ |
| Spring Boot | 3.5.4+ | - |
| MySQL | 8.0+ | 4GB+ |
| Redis | 7.0+ | 2GB+ |
| Nacos | 2.3+ | 1GB+ |

### é…ç½®å‚æ•°

```yaml
# é¤åˆ«ç®¡ç†ç›¸å…³é…ç½®
meal:
  # ç¼“å­˜é…ç½®
  cache:
    local:
      maximum-size: 1000
      expire-after-write: 5m
    redis:
      ttl: 30m
  # æƒé™éªŒè¯é…ç½®
  permission:
    cache-ttl: 1h
    batch-size: 100
  # æ—¶é—´çª—å£é…ç½®
  time-window:
    cross-day-enabled: true
    tolerance-minutes: 5
```

### æ•°æ®åº“åˆå§‹åŒ–

```sql
-- åˆå§‹åŒ–é»˜è®¤é¤åˆ«åˆ†ç±»
INSERT INTO meal_category (id, code, name, sort_order, description, icon_url, color_code, is_system, create_time) VALUES
('CAT001', 'BREAKFAST', 'æ—©é¤', 1, 'æ—©é¤æ—¶æ®µ', '/icons/breakfast.png', '#FF9800', TRUE, NOW()),
('CAT002', 'LUNCH', 'åˆé¤', 2, 'åˆé¤æ—¶æ®µ', '/icons/lunch.png', '#4CAF50', TRUE, NOW()),
('CAT003', 'DINNER', 'æ™šé¤', 3, 'æ™šé¤æ—¶æ®µ', '/icons/dinner.png', '#2196F3', TRUE, NOW()),
('CAT004', 'SUPPER', 'å¤œå®µ', 4, 'å¤œå®µæ—¶æ®µ', '/icons/supper.png', '#9C27B0', TRUE, NOW()),
('CAT005', 'SNACK', 'ç‚¹å¿ƒ', 5, 'ç‚¹å¿ƒæ—¶æ®µ', '/icons/snack.png', '#FF5722', TRUE, NOW());

-- åˆå§‹åŒ–ç¤ºä¾‹é¤åˆ«
INSERT INTO meal (id, code, name, category_id, start_time, end_time, base_price, sort_order, create_time) VALUES
('MEAL001', 'BREAKFAST_STANDARD', 'æ ‡å‡†æ—©é¤', 'CAT001', '06:00:00', '10:00:00', 5.00, 1, NOW()),
('MEAL002', 'BREAKFAST_DELUXE', 'è±ªåæ—©é¤', 'CAT001', '06:00:00', '10:00:00', 8.00, 2, NOW()),
('MEAL003', 'LUNCH_STANDARD', 'å·¥ä½œåˆé¤', 'CAT002', '11:00:00', '14:00:00', 12.00, 1, NOW()),
('MEAL004', 'LUNCH_BUSINESS', 'å•†åŠ¡åˆé¤', 'CAT002', '11:00:00', '14:00:00', 25.00, 2, NOW());
```

---

## ğŸ“‹ æ€»ç»“

### ç³»ç»Ÿä»·å€¼

âœ… **æå‡ç®¡ç†æ•ˆç‡**ï¼šäºŒçº§åˆ†ç±»ä½“ç³»å°†é…ç½®å¤æ‚åº¦é™ä½70%
âœ… **å¢å¼ºç”¨æˆ·ä½“éªŒ**ï¼šæ™ºèƒ½æƒé™éªŒè¯ï¼Œå“åº”æ—¶é—´<15ms
âœ… **æ”¯æŒçµæ´»æ‰©å±•**ï¼šå¯é€‚é…å„ç±»å›­åŒºé¤é¥®åœºæ™¯
âœ… **ä¿éšœç³»ç»Ÿç¨³å®š**ï¼šå¤šçº§ç¼“å­˜ç­–ç•¥ï¼Œæ”¯æŒé«˜å¹¶å‘è®¿é—®

### æŠ€æœ¯äº®ç‚¹

ğŸ—ï¸ **Spring Boot 3.5.4 + Java 17**ï¼šæœ€æ–°æŠ€æœ¯æ ˆï¼Œæ€§èƒ½ä¼˜å¼‚
ğŸ”„ **äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼šæ¾è€¦åˆè®¾è®¡ï¼Œæ˜“äºæ‰©å±•
âš¡ **ä¸‰çº§ç¼“å­˜ä½“ç³»**ï¼šæœ¬åœ°ç¼“å­˜+Redis+æ•°æ®åº“ï¼Œæ€§èƒ½å“è¶Š
ğŸ“Š **å®Œå–„ç›‘æ§ä½“ç³»**ï¼šå®æ—¶ç›‘æ§ï¼Œå¿«é€Ÿå®šä½é—®é¢˜

### é€‚ç”¨åœºæ™¯

ğŸ¢ **ä¼ä¸šå›­åŒº**ï¼šå‘˜å·¥é¤å…ã€å•†åŠ¡é¤å…ç®¡ç†
ğŸ“ **æ•™è‚²æœºæ„**ï¼šå­¦æ ¡é£Ÿå ‚ã€è¥å…»é¤ç®¡ç†
ğŸ¥ **åŒ»ç–—æœºæ„**ï¼šç—…äººé¤ã€åŒ»æŠ¤é¤ç®¡ç†
ğŸ›ï¸ **å•†ä¸šç»¼åˆä½“**ï¼šç¾é£Ÿå¹¿åœºç»Ÿä¸€ç®¡ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-13
**æ›´æ–°æ—¶é—´**ï¼š2025-11-13
**é€‚ç”¨ç‰ˆæœ¬**ï¼šIOE-DREAM v1.0+
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šIOE-DREAMæŠ€æœ¯å›¢é˜Ÿ