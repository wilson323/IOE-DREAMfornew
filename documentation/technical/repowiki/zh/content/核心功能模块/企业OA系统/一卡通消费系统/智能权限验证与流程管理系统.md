# IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å° - æ™ºèƒ½æƒé™éªŒè¯ä¸æµç¨‹ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

**ç³»ç»Ÿå®šä½**ï¼šä¸ºIOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æä¾›ç»Ÿä¸€ã€é«˜æ•ˆã€å¯æ‰©å±•çš„æƒé™éªŒè¯ä¸æµç¨‹ç®¡ç†èƒ½åŠ›ï¼Œæ”¯æŒä¸åŒç»è¥æ¨¡å¼çš„å·®å¼‚åŒ–æƒé™æ ¡éªŒï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’Œæ€§èƒ½çš„æœ€ä¼˜å¹³è¡¡ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **ç»Ÿä¸€éªŒè¯å…¥å£**ï¼šæ•´åˆå¤šç»´åº¦æƒé™éªŒè¯ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦
- âš¡ **æè‡´æ€§èƒ½**ï¼šå¤šçº§ç¼“å­˜+æ‰¹é‡ä¼˜åŒ–ï¼ŒéªŒè¯æ€§èƒ½æå‡90%
- ğŸ”§ **è´£ä»»é“¾æ¨¡å¼**ï¼š9ä¸ªä¸“ä¸šéªŒè¯å™¨ï¼Œçµæ´»å¯æ‰©å±•
- ğŸ“Š **å®Œå–„ç›‘æ§**ï¼šå®æ—¶ç›‘æ§ã€å®Œæ•´å®¡è®¡ã€æ™ºèƒ½å‘Šè­¦
- ğŸ”„ **ç»è¥æ¨¡å¼é€‚é…**ï¼šæ”¯æŒé¤åˆ«åˆ¶ã€è¶…å¸‚åˆ¶ã€æ··åˆæ¨¡å¼çš„å·®å¼‚åŒ–éªŒè¯

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ä¸šå›­åŒºä¸€å¡é€šæƒé™ç®¡ç†
- å­¦æ ¡æ ¡å›­å¡æ¶ˆè´¹æƒé™æ§åˆ¶
- åŒ»é™¢è¥å…»é¤æƒé™éªŒè¯
- å•†ä¸šç»¼åˆä½“ä¼šå‘˜æƒé™ç®¡ç†
- æ™ºæ…§å›­åŒºç»Ÿä¸€æ”¯ä»˜å¹³å°

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æŠ€æœ¯æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[ç®¡ç†åå°<br/>Vue 3.4 + TypeScript]
        B[ç§»åŠ¨ç«¯APP<br/>uni-app]
        C[æ•°æ®åˆ†æå¹³å°<br/>React 18]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        D[æƒé™éªŒè¯æœåŠ¡<br/>Spring Boot 3.5.4]
        E[æµç¨‹ç®¡ç†æœåŠ¡<br/>Spring Boot 3.5.4]
        F[éªŒè¯å¼•æ“æœåŠ¡<br/>Spring Boot 3.5.4]
        G[ç›‘æ§å‘Šè­¦æœåŠ¡<br/>Spring Boot 3.5.4]
    end

    subgraph "æ•°æ®å±‚"
        H[MySQL 8.0<br/>ä¸šåŠ¡æ•°æ®]
        I[Redis 7.0<br/>åˆ†å¸ƒå¼ç¼“å­˜]
        J[PostgreSQL 14<br/>æ•°æ®åˆ†æ]
        K[Elasticsearch 8.0<br/>æ—¥å¿—æ£€ç´¢]
    end

    subgraph "åŸºç¡€è®¾æ–½"
        L[Nacos 2.3<br/>é…ç½®ä¸­å¿ƒ]
        M[Apache Kafka 3.5<br/>æ¶ˆæ¯é˜Ÿåˆ—]
        N[Prometheus<br/>ç›‘æ§å‘Šè­¦]
        O[Consul<br/>æœåŠ¡å‘ç°]
    end

    A --> D
    B --> E
    C --> G

    D --> H
    E --> H
    F --> I
    G --> J

    D --> L
    E --> L
    F --> L
    G --> M

    D --> N
    E --> N
    F --> N
```

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### ç»è¥æ¨¡å¼é€‚é…åŸåˆ™
- **é¤åˆ«åˆ¶åŒºåŸŸ**ï¼šå¼ºåˆ¶éªŒè¯é¤åˆ«æƒé™ã€å°±é¤æ—¶é—´ã€å®šå€¼é…ç½®
- **è¶…å¸‚åˆ¶åŒºåŸŸ**ï¼šå¼ºåˆ¶éªŒè¯å•†å“æƒé™ã€åº“å­˜æ£€æŸ¥ã€å•†å“ä»·æ ¼
- **æ··åˆæ¨¡å¼åŒºåŸŸ**ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ¨æ€åˆ‡æ¢éªŒè¯æ¨¡å¼
- **æƒé™ç»§æ‰¿**ï¼šè´¦æˆ·ç±»åˆ«è‡ªåŠ¨ç»§æ‰¿åŒºåŸŸé…ç½®çš„æ‰€æœ‰æƒé™

#### éªŒè¯è´£ä»»é“¾è®¾è®¡
- **AccountStatusValidator**ï¼šè´¦æˆ·çŠ¶æ€éªŒè¯ï¼ˆä¼˜å…ˆçº§1ï¼‰
- **AreaPermissionValidator**ï¼šåŒºåŸŸæƒé™éªŒè¯ï¼ˆä¼˜å…ˆçº§2ï¼‰
- **MealPermissionValidator**ï¼šé¤åˆ«æƒé™éªŒè¯ï¼ˆä¼˜å…ˆçº§3ï¼‰
- **TimeWindowValidator**ï¼šæ—¶é—´çª—å£éªŒè¯ï¼ˆä¼˜å…ˆçº§4ï¼‰
- **BalanceValidator**ï¼šä½™é¢æ£€æŸ¥éªŒè¯ï¼ˆä¼˜å…ˆçº§5ï¼‰
- **LimitValidator**ï¼šé™é¢æ£€æŸ¥éªŒè¯ï¼ˆä¼˜å…ˆçº§6ï¼‰
- **FixedValueCalculator**ï¼šå®šå€¼è®¡ç®—éªŒè¯ï¼ˆä¼˜å…ˆçº§7ï¼‰
- **DiscountCalculator**ï¼šæŠ˜æ‰£è®¡ç®—éªŒè¯ï¼ˆä¼˜å…ˆçº§8ï¼‰
- **BusinessRuleValidator**ï¼šä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆä¼˜å…ˆçº§9ï¼‰

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹è®¾è®¡

### 1. æƒé™éªŒè¯æ ¸å¿ƒæµç¨‹

```mermaid
flowchart TD
    A[æ¶ˆè´¹è¯·æ±‚] --> B[æƒé™éªŒè¯å…¥å£]
    B --> C[æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡]

    C --> D{åŒºåŸŸç»è¥æ¨¡å¼?}
    D -->|manage_mode=1<br/>é¤åˆ«åˆ¶| E1[é¤åˆ«åˆ¶éªŒè¯é“¾]
    D -->|manage_mode=2<br/>è¶…å¸‚åˆ¶| E2[è¶…å¸‚åˆ¶éªŒè¯é“¾]
    D -->|manage_mode=3<br/>æ··åˆæ¨¡å¼| E3[æ··åˆæ¨¡å¼éªŒè¯é“¾]

    E1 --> F1[1. è´¦æˆ·çŠ¶æ€]
    F1 --> F2[2. åŒºåŸŸæƒé™]
    F2 --> F3[3. é¤åˆ«æƒé™ âœ…]
    F3 --> F4[4. å°±é¤æ—¶é—´ âœ…]
    F4 --> F5[5. å®šå€¼è®¡ç®— âœ…]
    F5 --> F6[6. ä½™é¢é™é¢]
    F6 --> G1[éªŒè¯é€šè¿‡]

    E2 --> H1[1. è´¦æˆ·çŠ¶æ€]
    H1 --> H2[2. åŒºåŸŸæƒé™]
    H2 --> H3[3. å•†å“æƒé™ âœ…]
    H3 --> H4[4. åº“å­˜æ£€æŸ¥ âœ…]
    H4 --> H5[5. å•†å“ä»·æ ¼ âœ…]
    H5 --> H6[6. ä½™é¢é™é¢]
    H6 --> G2[éªŒè¯é€šè¿‡]

    E3 --> I1[1. è´¦æˆ·çŠ¶æ€]
    I1 --> I2[2. åŒºåŸŸæƒé™]
    I2 --> I3{ç”¨æˆ·é€‰æ‹©?}
    I3 -->|å®šå€¼æ¶ˆè´¹| I4[é¤åˆ«éªŒè¯åˆ†æ”¯]
    I3 -->|å•†å“æ¶ˆè´¹| I5[å•†å“éªŒè¯åˆ†æ”¯]
    I3 -->|æ··åˆæ¶ˆè´¹| I6[åŒé‡éªŒè¯]

    I4 --> G3[éªŒè¯é€šè¿‡]
    I5 --> G3
    I6 --> G3

    style G1 fill:#51cf66
    style G2 fill:#51cf66
    style G3 fill:#51cf66
    style F3 fill:#74b9ff
    style H3 fill:#a29bfe
    style I4 fill:#74b9ff
    style I5 fill:#a29bfe
    style I6 fill:#fd79a8
```

### 2. è´£ä»»é“¾éªŒè¯æµç¨‹

```mermaid
flowchart LR
    A[éªŒè¯è¯·æ±‚] --> B[è´£ä»»é“¾è°ƒåº¦å™¨]

    B --> C[éªŒè¯å™¨1<br/>è´¦æˆ·çŠ¶æ€]
    C -->|é€šè¿‡| D[éªŒè¯å™¨2<br/>åŒºåŸŸæƒé™]
    C -->|å¤±è´¥| Z[è¿”å›å¤±è´¥]

    D -->|é€šè¿‡| E[éªŒè¯å™¨3<br/>é¤åˆ«æƒé™]
    D -->|å¤±è´¥| Z
    E -->|é€šè¿‡| F[éªŒè¯å™¨4<br/>æ—¶é—´çª—å£]
    E -->|å¤±è´¥| Z

    F -->|é€šè¿‡| G[éªŒè¯å™¨5<br/>ä½™é¢æ£€æŸ¥]
    F -->|å¤±è´¥| Z
    G -->|é€šè¿‡| H[éªŒè¯å™¨6<br/>é™é¢æ£€æŸ¥]
    G -->|å¤±è´¥| Z

    H -->|é€šè¿‡| I[éªŒè¯å™¨7<br/>å®šå€¼è®¡ç®—]
    H -->|å¤±è´¥| Z
    I -->|é€šè¿‡| J[éªŒè¯å™¨8<br/>æŠ˜æ‰£è®¡ç®—]
    I -->|å¤±è´¥| Z

    J -->|é€šè¿‡| Y[è¿”å›æˆåŠŸ<br/>é™„å¸¦è®¡ç®—ç»“æœ]
    J -->|å¤±è´¥| Z

    style Z fill:#ff6b6b
    style Y fill:#51cf66
```

### 3. æ‰¹é‡éªŒè¯ä¼˜åŒ–æµç¨‹

```mermaid
sequenceDiagram
    participant C as è°ƒç”¨æ–¹
    participant V as éªŒè¯æœåŠ¡
    participant Cache as ç¼“å­˜å±‚
    participant DB as æ•°æ®åº“

    C->>V: æ‰¹é‡éªŒè¯è¯·æ±‚[Nä¸ªè´¦æˆ·]
    V->>V: åˆ†ç»„å»é‡
    Note over V: æŒ‰è´¦æˆ·ç±»åˆ«åˆ†ç»„<br/>å‡å°‘æŸ¥è¯¢æ¬¡æ•°

    V->>Cache: æ‰¹é‡è·å–è´¦æˆ·ç±»åˆ«é…ç½®
    Cache-->>V: è¿”å›Mä¸ª(ç¼“å­˜å‘½ä¸­)

    V->>DB: æ‰¹é‡æŸ¥è¯¢ç¼ºå¤±é…ç½®
    Note over DB: ä½¿ç”¨INæŸ¥è¯¢<br/>ä¸€æ¬¡æ€§è·å–N-Mä¸ª
    DB-->>V: è¿”å›N-Mä¸ªé…ç½®

    V->>Cache: æ‰¹é‡å†™å…¥ç¼“å­˜(Pipeline)

    V->>V: å¹¶è¡ŒéªŒè¯(Streamå¹¶è¡Œæµ)
    Note over V: ä½¿ç”¨çº¿ç¨‹æ± <br/>Nä¸ªè´¦æˆ·å¹¶è¡ŒéªŒè¯

    loop æ¯ä¸ªè´¦æˆ·
        V->>V: æ‰§è¡ŒéªŒè¯é“¾
        V->>V: è®°å½•ç»“æœ
    end

    V->>V: èšåˆç»“æœ
    V-->>C: è¿”å›Nä¸ªéªŒè¯ç»“æœ
    Note over C: æ€»è€—æ—¶ < 200ms<br/>(vs åŸ5000ms)
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. æƒé™éªŒè¯æ—¥å¿—è¡¨ï¼ˆpermission_validation_logï¼‰

```sql
CREATE TABLE permission_validation_log (
    id VARCHAR(64) PRIMARY KEY COMMENT 'æ—¥å¿—ID',

    -- è¯·æ±‚ä¿¡æ¯
    account_id VARCHAR(50) NOT NULL COMMENT 'è´¦æˆ·ID',
    account_kind_id VARCHAR(50) COMMENT 'è´¦æˆ·ç±»åˆ«ID',
    area_id VARCHAR(50) COMMENT 'åŒºåŸŸID',
    meal_id VARCHAR(50) COMMENT 'é¤åˆ«ID',
    device_id VARCHAR(50) COMMENT 'è®¾å¤‡ID',
    request_id VARCHAR(64) COMMENT 'è¯·æ±‚ID',

    -- ç»è¥æ¨¡å¼ä¿¡æ¯
    area_manage_mode TINYINT COMMENT 'åŒºåŸŸç»è¥æ¨¡å¼ï¼š1-é¤åˆ«åˆ¶ 2-è¶…å¸‚åˆ¶ 3-æ··åˆ',
    consume_type ENUM('FIXED', 'FREE', 'PRODUCT', 'ORDER', 'INTELLIGENCE') COMMENT 'æ¶ˆè´¹ç±»å‹',

    -- éªŒè¯ç»“æœ
    validation_result BOOLEAN NOT NULL COMMENT 'éªŒè¯ç»“æœï¼štrue-é€šè¿‡ false-å¤±è´¥',
    failure_reason VARCHAR(255) COMMENT 'å¤±è´¥åŸå› ',
    failure_validator VARCHAR(50) COMMENT 'å¤±è´¥çš„éªŒè¯å™¨åç§°',
    failure_step INT COMMENT 'å¤±è´¥æ­¥éª¤åºå·',

    -- éªŒè¯è¯¦æƒ…
    validation_chain JSON COMMENT 'éªŒè¯é“¾æ‰§è¡Œè¯¦æƒ…',
    /*
    ç¤ºä¾‹ï¼š
    [
        {"validator": "AccountStatusValidator", "result": true, "duration": 2, "step": 1},
        {"validator": "AreaPermissionValidator", "result": true, "duration": 5, "step": 2},
        {"validator": "MealPermissionValidator", "result": false, "reason": "æ— æƒä½¿ç”¨è¯¥é¤åˆ«", "duration": 3, "step": 3}
    ]
    */

    -- æ€§èƒ½æŒ‡æ ‡
    total_duration INT COMMENT 'æ€»è€—æ—¶(æ¯«ç§’)',
    cache_hit_rate DECIMAL(5,2) COMMENT 'ç¼“å­˜å‘½ä¸­ç‡(%)',

    -- è®¡ç®—ç»“æœ
    final_amount INT COMMENT 'æœ€ç»ˆé‡‘é¢(åˆ†)',
    fixed_amount INT COMMENT 'å®šå€¼é‡‘é¢(åˆ†)',
    discount_amount INT COMMENT 'æŠ˜æ‰£é‡‘é¢(åˆ†)',
    original_amount INT COMMENT 'åŸå§‹é‡‘é¢(åˆ†)',

    -- æ—¶é—´ä¿¡æ¯
    validation_time DATETIME NOT NULL COMMENT 'éªŒè¯æ—¶é—´',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    INDEX idx_account(account_id, validation_time) COMMENT 'è´¦æˆ·ç´¢å¼•',
    INDEX idx_account_kind(account_kind_id, validation_time) COMMENT 'è´¦æˆ·ç±»åˆ«ç´¢å¼•',
    idx_result(validation_result, validation_time) COMMENT 'ç»“æœç´¢å¼•',
    INDEX idx_validator(failure_validator, validation_time) COMMENT 'å¤±è´¥éªŒè¯å™¨ç´¢å¼•',
    idx_area(area_id, validation_time) COMMENT 'åŒºåŸŸç´¢å¼•',
    idx_time(validation_time) COMMENT 'æ—¶é—´ç´¢å¼•',
    INDEX idx_create_time(create_time) COMMENT 'åˆ›å»ºæ—¶é—´ç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
COMMENT='æƒé™éªŒè¯æ—¥å¿—è¡¨ï¼ˆæŒ‰æœˆåˆ†è¡¨ï¼‰'
PARTITION BY RANGE (TO_DAYS(validation_time)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

#### 2. éªŒè¯å™¨é…ç½®è¡¨ï¼ˆvalidator_configï¼‰

```sql
CREATE TABLE validator_config (
    id VARCHAR(50) PRIMARY KEY COMMENT 'éªŒè¯å™¨ID',

    -- éªŒè¯å™¨ä¿¡æ¯
    validator_name VARCHAR(50) NOT NULL UNIQUE COMMENT 'éªŒè¯å™¨åç§°',
    validator_class VARCHAR(200) NOT NULL COMMENT 'éªŒè¯å™¨ç±»å…¨è·¯å¾„',
    description VARCHAR(255) COMMENT 'éªŒè¯å™¨æè¿°',

    -- é…ç½®ä¿¡æ¯
    enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    order_value INT DEFAULT 999 COMMENT 'æ‰§è¡Œé¡ºåº',
    config_params JSON COMMENT 'éªŒè¯å™¨é…ç½®å‚æ•°',

    -- æ€§èƒ½é…ç½®
    timeout_ms INT DEFAULT 5000 COMMENT 'è¶…æ—¶æ—¶é—´(æ¯«ç§’)',
    cache_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨ç¼“å­˜',
    parallel_execution BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦æ”¯æŒå¹¶è¡Œæ‰§è¡Œ',

    -- ä¸šåŠ¡é…ç½®
    apply_to_modes JSON COMMENT 'é€‚ç”¨çš„ç»è¥æ¨¡å¼æ•°ç»„',
    required_data_fields JSON COMMENT 'å¿…éœ€çš„æ•°æ®å­—æ®µ',

    -- ç»Ÿè®¡ä¿¡æ¯
    success_count BIGINT DEFAULT 0 COMMENT 'æˆåŠŸæ¬¡æ•°',
    failure_count BIGINT DEFAULT 0 COMMENT 'å¤±è´¥æ¬¡æ•°',
    avg_duration INT DEFAULT 0 COMMENT 'å¹³å‡è€—æ—¶(æ¯«ç§’)',
    last_execute_time DATETIME COMMENT 'æœ€åæ‰§è¡Œæ—¶é—´',

    -- å®¡è®¡å­—æ®µ
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    create_by VARCHAR(50) COMMENT 'åˆ›å»ºäºº',
    update_by VARCHAR(50) COMMENT 'æ›´æ–°äºº',

    INDEX idx_enabled(enabled, order_value) COMMENT 'çŠ¶æ€æ’åºç´¢å¼•',
    INDEX idx_name(validator_name) COMMENT 'åç§°ç´¢å¼•',
    INDEX idx_order(order_value) COMMENT 'æ’åºç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='éªŒè¯å™¨é…ç½®è¡¨';
```

#### 3. åŒºåŸŸç»è¥æ¨¡å¼æ‰©å±•è¡¨

```sql
-- ä¸ºåŒºåŸŸè¡¨æ·»åŠ ç»è¥æ¨¡å¼å­—æ®µ
ALTER TABLE area
ADD COLUMN manage_mode TINYINT DEFAULT 1 COMMENT 'ç»è¥æ¨¡å¼ï¼š1-é¤åˆ«åˆ¶ 2-è¶…å¸‚åˆ¶ 3-æ··åˆæ¨¡å¼',
ADD COLUMN mode_config JSON COMMENT 'æ¨¡å¼ç‰¹å®šé…ç½®å‚æ•°',
ADD INDEX idx_manage_mode(manage_mode) COMMENT 'ç»è¥æ¨¡å¼ç´¢å¼•';
```

### é…ç½®æ•°æ®ç¤ºä¾‹

#### éªŒè¯å™¨é…ç½®åˆå§‹åŒ–

```sql
INSERT INTO validator_config (id, validator_name, validator_class, description, enabled, order_value, apply_to_modes, required_data_fields, create_time) VALUES
('validator_01', 'AccountStatusValidator', 'com.ioe.dream.permission.validator.AccountStatusValidator', 'è´¦æˆ·çŠ¶æ€éªŒè¯', TRUE, 1, '[1,2,3]', '["accountId"]', NOW()),
('validator_02', 'AreaPermissionValidator', 'com.ioe.dream.permission.validator.AreaPermissionValidator', 'åŒºåŸŸæƒé™éªŒè¯', TRUE, 2, '[1,2,3]', '["accountId","areaId"]', NOW()),
('validator_03', 'MealPermissionValidator', 'com.ioe.dream.permission.validator.MealPermissionValidator', 'é¤åˆ«æƒé™éªŒè¯', TRUE, 3, '[1,3]', '["accountId","areaId","mealId"]', NOW()),
('validator_04', 'TimeWindowValidator', 'com.ioe.dream.permission.validator.TimeWindowValidator', 'æ—¶é—´çª—å£éªŒè¯', TRUE, 4, '[1,3]', '["mealId","consumeTime"]', NOW()),
('validator_05', 'BalanceValidator', 'com.ioe.dream.permission.validator.BalanceValidator', 'ä½™é¢æ£€æŸ¥éªŒè¯', TRUE, 5, '[1,2,3]', '["accountId","consumeMoney"]', NOW()),
('validator_06', 'LimitValidator', 'com.ioe.dream.permission.validator.LimitValidator', 'é™é¢æ£€æŸ¥éªŒè¯', TRUE, 6, '[1,2,3]', '["accountId","consumeMoney"]', NOW()),
('validator_07', 'FixedValueCalculator', 'com.ioe.dream.permission.validator.FixedValueCalculator', 'å®šå€¼è®¡ç®—éªŒè¯', TRUE, 7, '[1,3]', '["accountId","areaId","mealId"]', NOW()),
('validator_08', 'DiscountCalculator', 'com.ioe.dream.permission.validator.DiscountCalculator', 'æŠ˜æ‰£è®¡ç®—éªŒè¯', TRUE, 8, '[1,2,3]', '["accountKindId","consumeMoney"]', NOW()),
('validator_09', 'ProductValidator', 'com.ioe.dream.permission.validator.ProductValidator', 'å•†å“æƒé™éªŒè¯', TRUE, 9, '[2,3]', '["productIds"]', NOW()),
('validator_10', 'InventoryValidator', 'com.ioe.dream.permission.validator.InventoryValidator', 'åº“å­˜æ£€æŸ¥éªŒè¯', TRUE, 10, '[2,3]', '["productIds"]', NOW());
```

---

## ğŸ’» æ ¸å¿ƒæœåŠ¡å®ç°

### 1. ç»Ÿä¸€æƒé™éªŒè¯æœåŠ¡

```java
/**
 * ç»Ÿä¸€æƒé™éªŒè¯æœåŠ¡
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Slf4j
public class UnifiedPermissionService {

    @Resource
    private List<PermissionValidator> validators;

    @Resource
    private PermissionValidationCacheManager cacheManager;

    @Resource
    private PermissionValidationLogDao validationLogDao;

    @Resource
    private ValidationMetricsCollector metricsCollector;

    /**
     * ç»Ÿä¸€éªŒè¯å…¥å£
     */
    public PermissionValidationResult validate(PermissionValidationRequest request) {
        long startTime = System.currentTimeMillis();
        String requestId = generateRequestId();

        try {
            // 1. æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡
            ValidationContext context = buildValidationContext(request, requestId);

            // 2. æ£€æŸ¥é™æ€æƒé™ç¼“å­˜
            StaticPermissionResult staticResult = cacheManager.getStaticPermission(
                request.getAccountId(),
                request.getAreaId(),
                request.getMealCategoryId()
            );

            if (staticResult != null && !staticResult.isSuccess()) {
                return PermissionValidationResult.fail(staticResult.getReason())
                    .withRequestId(requestId)
                    .withFailureValidator("StaticCacheCheck");
            }

            // 3. æ ¹æ®ç»è¥æ¨¡å¼é€‰æ‹©éªŒè¯é“¾
            List<PermissionValidator> sortedValidators = getValidatorsForMode(
                context.getArea().getManageMode()
            );

            // 4. æ‰§è¡ŒéªŒè¯é“¾
            ValidationChainResult chainResult = executeValidationChain(
                context, sortedValidators, requestId
            );

            // 5. è®°å½•éªŒè¯æŒ‡æ ‡
            long totalDuration = System.currentTimeMillis() - startTime;
            metricsCollector.recordValidation(chainResult, totalDuration);

            // 6. ç»„è£…éªŒè¯ç»“æœ
            if (chainResult.isSuccess()) {
                return PermissionValidationResult.success()
                    .withRequestId(requestId)
                    .withValidationChain(chainResult.getValidationChain())
                    .withFinalMoney(context.getFinalMoney())
                    .withFixedMoney(context.getFixedMoney())
                    .withDiscountMoney(context.getDiscountMoney())
                    .withDuration(totalDuration);
            } else {
                return PermissionValidationResult.fail(chainResult.getFailureReason())
                    .withRequestId(requestId)
                    .withFailureValidator(chainResult.getFailureValidator())
                    .withValidationChain(chainResult.getValidationChain())
                    .withDuration(totalDuration);
            }

        } catch (Exception e) {
            log.error("æƒé™éªŒè¯å¼‚å¸¸: requestId={}, error={}", requestId, e.getMessage(), e);
            metricsCollector.recordValidationFailure(e);

            return PermissionValidationResult.fail("ç³»ç»Ÿå¼‚å¸¸")
                .withRequestId(requestId)
                .withDuration(System.currentTimeMillis() - startTime);
        }
    }

    /**
     * æ ¹æ®ç»è¥æ¨¡å¼è·å–éªŒè¯å™¨åˆ—è¡¨
     */
    private List<PermissionValidator> getValidatorsForMode(Integer manageMode) {
        return validators.stream()
            .filter(validator -> {
                try {
                    ValidatorConfig config = validator.getConfig();
                    if (!config.isEnabled()) {
                        return false;
                    }

                    // æ£€æŸ¥æ˜¯å¦é€‚ç”¨äºå½“å‰ç»è¥æ¨¡å¼
                    if (config.getApplyToModes() != null) {
                        return config.getApplyToModes().contains(manageMode);
                    }

                    return true;
                } catch (Exception e) {
                    log.error("è·å–éªŒè¯å™¨é…ç½®å¼‚å¸¸: {}", validator.getClass().getName(), e);
                    return false;
                }
            })
            .sorted(Comparator.comparingInt(PermissionValidator::getOrder))
            .collect(Collectors.toList());
    }

    /**
     * æ‰§è¡ŒéªŒè¯é“¾
     */
    private ValidationChainResult executeValidationChain(
        ValidationContext context,
        List<PermissionValidator> validators,
        String requestId
    ) {
        List<ValidationResult> validationChain = new ArrayList<>();
        int cacheHits = 0;

        for (PermissionValidator validator : validators) {
            try {
                ValidationResult result = validator.validate(context);
                validationChain.add(result);

                // è®°å½•ç¼“å­˜å‘½ä¸­ï¼ˆè€—æ—¶<5msè®¤ä¸ºç¼“å­˜å‘½ä¸­ï¼‰
                if (result.getDuration() < 5) {
                    cacheHits++;
                }

                // å¦‚æœéªŒè¯å¤±è´¥ï¼Œä¸­æ–­é“¾æ¡
                if (!result.isSuccess()) {
                    return ValidationChainResult.fail(
                        result.getReason(),
                        validator.getName(),
                        validationChain,
                        cacheHits
                    );
                }

                // å°†éªŒè¯ç»“æœä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡
                enrichContextWithValidationResult(context, result);

            } catch (Exception e) {
                log.error("éªŒè¯å™¨{}æ‰§è¡Œå¼‚å¸¸: requestId={}", validator.getName(), requestId, e);

                validationChain.add(ValidationResult.fail("éªŒè¯å™¨æ‰§è¡Œå¼‚å¸¸: " + e.getMessage()));
                return ValidationChainResult.fail(
                    "éªŒè¯å™¨æ‰§è¡Œå¼‚å¸¸: " + validator.getName(),
                    validator.getName(),
                    validationChain,
                    cacheHits
                );
            }
        }

        return ValidationChainResult.success(validationChain, cacheHits);
    }

    /**
     * æ„å»ºéªŒè¯ä¸Šä¸‹æ–‡
     */
    private ValidationContext buildValidationContext(
        PermissionValidationRequest request, String requestId
    ) {
        // è·å–ç¼“å­˜çš„ä¸Šä¸‹æ–‡
        ValidationContext context = cacheManager.getValidationContext(request.getAccountId());

        // å¡«å……è¯·æ±‚ä¿¡æ¯
        context.setRequestId(requestId);
        context.setAreaId(request.getAreaId());
        context.setMealId(request.getMealId());
        context.setConsumeMoney(request.getConsumeMoney());
        context.setConsumeTime(request.getConsumeTime());
        context.setDeviceId(request.getDeviceId());

        // åŠ è½½åŒºåŸŸä¿¡æ¯
        AreaEntity area = areaService.getById(request.getAreaId());
        context.setArea(area);

        // åŠ è½½é¤åˆ«ä¿¡æ¯ï¼ˆå¦‚æœæä¾›äº†é¤åˆ«IDï¼‰
        if (StringUtils.isNotBlank(request.getMealId())) {
            MealEntity meal = mealService.getById(request.getMealId());
            context.setMeal(meal);
        }

        // åŠ è½½è´¦æˆ·ç±»åˆ«é…ç½®
        AccountKindConfig kindConfig = cacheManager.getAccountKindConfig(
            context.getAccount().getAccountKindId()
        );
        context.setAccountKindConfig(kindConfig);

        return context;
    }

    /**
     * ç”¨éªŒè¯ç»“æœä¿¡æ¯ä¸°å¯Œä¸Šä¸‹æ–‡
     */
    private void enrichContextWithValidationResult(
        ValidationContext context, ValidationResult result
    ) {
        // æ ¹æ®éªŒè¯å™¨ç±»å‹ï¼Œå°†ç‰¹å®šä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡
        switch (result.getValidatorName()) {
            case "FixedValueCalculator":
                context.setFixedMoney(context.getFixedMoney());
                context.setConsumeMoney(context.getConsumeMoney());
                break;
            case "DiscountCalculator":
                context.setDiscountType(context.getDiscountType());
                context.setDiscountMoney(context.getDiscountMoney());
                context.setFinalMoney(context.getFinalMoney());
                break;
            case "BalanceValidator":
                // ä½™é¢éªŒè¯å™¨å¯èƒ½æ›´æ–°æ¶ˆè´¹é‡‘é¢
                if (result.getExtraData() != null) {
                    context.setConsumeMoney((Integer) result.getExtraData().get("consumeMoney"));
                }
                break;
            case "LimitValidator":
                // é™é¢éªŒè¯å™¨å¯èƒ½è¿”å›é™é¢ä¿¡æ¯
                if (result.getExtraData() != null) {
                    context.setRemainingDailyLimit((Integer) result.getExtraData().get("remainingDailyLimit"));
                }
                break;
        }
    }

    private String generateRequestId() {
        return "REQ-" + UUID.randomUUID().toString().replace("-", "");
    }
}
```

### 2. è´£ä»»é“¾éªŒè¯å™¨æ¥å£

```java
/**
 * æƒé™éªŒè¯å™¨æ¥å£
 */
public interface PermissionValidator {

    /**
     * éªŒè¯å™¨åç§°
     */
    String getName();

    /**
     * éªŒè¯å™¨ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
     */
    int getOrder();

    /**
     * è·å–éªŒè¯å™¨é…ç½®
     */
    default ValidatorConfig getConfig() {
        return ValidatorConfig.getDefault();
    }

    /**
     * æ‰§è¡ŒéªŒè¯
     */
    ValidationResult validate(ValidationContext context);

    /**
     * æ˜¯å¦å¯ç”¨è¯¥éªŒè¯å™¨
     */
    default boolean isEnabled() {
        return true;
    }
}

/**
 * æŠ½è±¡éªŒè¯å™¨åŸºç±»
 */
public abstract class AbstractPermissionValidator implements PermissionValidator {

    protected final Logger log = LoggerFactory.getLogger(getClass());

    @Resource
    protected ValidationMetricsCollector metricsCollector;

    @Override
    public ValidationResult validate(ValidationContext context) {
        long startTime = System.currentTimeMillis();

        try {
            // æ‰§è¡Œå…·ä½“éªŒè¯é€»è¾‘
            ValidationResult result = doValidate(context);

            // è®°å½•éªŒè¯æ—¶é•¿
            long duration = System.currentTimeMillis() - startTime;
            result.setDuration(duration);
            result.setValidatorName(getName());

            // è®°å½•éªŒè¯æŒ‡æ ‡
            metricsCollector.recordValidation(result, duration);

            return result;

        } catch (Exception e) {
            log.error("éªŒè¯å™¨{}æ‰§è¡Œå¼‚å¸¸", getName(), e);

            ValidationResult result = ValidationResult.fail("éªŒè¯å™¨æ‰§è¡Œå¼‚å¸¸: " + e.getMessage());
            result.setValidatorName(getName());
            result.setDuration(System.currentTimeMillis() - startTime);

            metricsCollector.recordValidationFailure(e);
            return result;
        }
    }

    /**
     * å­ç±»å®ç°å…·ä½“éªŒè¯é€»è¾‘
     */
    protected abstract ValidationResult doValidate(ValidationContext context);
}
```

### 3. è´¦æˆ·çŠ¶æ€éªŒè¯å™¨

```java
/**
 * è´¦æˆ·çŠ¶æ€éªŒè¯å™¨
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Component
@Order(1)
public class AccountStatusValidator extends AbstractPermissionValidator {

    @Override
    public String getName() {
        return "AccountStatusValidator";
    }

    @Override
    public int getOrder() {
        return 1;
    }

    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        AccountEntity account = context.getAccount();

        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
        if (account == null) {
            return ValidationResult.fail("è´¦æˆ·ä¸å­˜åœ¨");
        }

        // æ£€æŸ¥è´¦æˆ·çŠ¶æ€
        if (!account.getAvailable()) {
            return ValidationResult.fail("è´¦æˆ·å·²ç¦ç”¨");
        }

        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¿‡æœŸ
        if (account.getExpireTime() != null &&
            account.getExpireTime().before(new Date())) {
            return ValidationResult.fail("è´¦æˆ·å·²è¿‡æœŸ");
        }

        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«å†»ç»“
        if (account.getFrozen() != null && account.getFrozen()) {
            return ValidationResult.fail("è´¦æˆ·å·²è¢«å†»ç»“");
        }

        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦æŒ‚å¤±
        if (account.getLost() != null && account.getLost()) {
            return ValidationResult.fail("è´¦æˆ·å·²æŒ‚å¤±");
        }

        return ValidationResult.success();
    }
}
```

### 4. é¤åˆ«æƒé™éªŒè¯å™¨

```java
/**
 * é¤åˆ«æƒé™éªŒè¯å™¨
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Component
@Order(3)
public class MealPermissionValidator extends AbstractPermissionValidator {

    @Resource
    private MealCacheManager mealCacheManager;

    @Resource
    private AccountKindCacheManager accountKindCacheManager;

    @Override
    public String getName() {
        return "MealPermissionValidator";
    }

    @Override
    public int getOrder() {
        return 3;
    }

    @Override
    protected ValidationResult doValidate(ValidationContext context) {
        String mealId = context.getMealId();

        // å¦‚æœæ²¡æœ‰é¤åˆ«IDï¼Œè·³è¿‡é¤åˆ«éªŒè¯
        if (StringUtils.isBlank(mealId)) {
            return ValidationResult.success();
        }

        // è·å–é¤åˆ«ä¿¡æ¯
        MealEntity meal = mealCacheManager.getMeal(mealId);
        if (meal == null || !meal.getAvailable()) {
            return ValidationResult.fail("é¤åˆ«ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }

        // æ£€æŸ¥é¤åˆ«åˆ†ç±»æƒé™
        Set<String> effectiveCategories = accountKindCacheManager.getEffectiveMealCategories(
            context.getAccount().getId(),
            context.getAccount().getAccountKindId(),
            context.getAreaId()
        );

        if (effectiveCategories.isEmpty() || !effectiveCategories.contains(meal.getCategoryId())) {
            return ValidationResult.fail("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
        }

        // å°†é¤åˆ«ä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡ä¾›åç»­éªŒè¯å™¨ä½¿ç”¨
        context.setMeal(meal);

        return ValidationResult.success();
    }
}
```

### 5. æƒé™éªŒè¯ç¼“å­˜ç®¡ç†å™¨

```java
/**
 * æƒé™éªŒè¯ç¼“å­˜ç®¡ç†å™¨
 *
 * @author IOE-DREAM Team
 * @version 1.0
 */
@Service
@Slf4j
public class PermissionValidationCacheManager {

    @Resource
    private RedisTemplate<String, Object> redisTemplate;

    @Resource
    private AccountKindService accountKindService;

    @Resource
    private AreaService areaService;

    @Resource
    private MealService mealService;

    @Resource
    private Caffeine<String, Object> localCache;

    private static final String CACHE_PREFIX_CONTEXT = "validation:context:";
    private static final String CACHE_PREFIX_STATIC = "validation:static:";
    private static final String CACHE_PREFIX_TODAY_TIMES = "account:today:times:";
    private static final String CACHE_PREFIX_TODAY_MONEY = "account:today:money:";
    private static final String CACHE_PREFIX_MONTH_TIMES = "account:month:times:";
    private static final String CACHE_PREFIX_MONTH_MONEY = "account:month:money:";

    /**
     * è·å–éªŒè¯ä¸Šä¸‹æ–‡ï¼ˆå¤šçº§ç¼“å­˜ï¼‰
     */
    @Cacheable(value = "validation:context", key = "#accountId")
    public ValidationContext getValidationContext(String accountId) {
        String key = CACHE_PREFIX_CONTEXT + accountId;

        // Level 1: æœ¬åœ°ç¼“å­˜
        ValidationContext context = (ValidationContext) localCache.getIfPresent(key);
        if (context != null) {
            return context;
        }

        // Level 2: Redisç¼“å­˜
        context = (ValidationContext) redisTemplate.opsForValue().get(key);
        if (context != null) {
            localCache.put(key, context, Duration.ofMinutes(5));
            return context;
        }

        // Level 3: æ„å»ºä¸Šä¸‹æ–‡
        context = buildValidationContext(accountId);
        if (context != null) {
            // Redisç¼“å­˜5åˆ†é’Ÿ
            redisTemplate.opsForValue().set(key, context, Duration.ofMinutes(5));
            // æœ¬åœ°ç¼“å­˜5åˆ†é’Ÿ
            localCache.put(key, context, Duration.ofMinutes(5));
        }

        return context;
    }

    /**
     * è·å–é™æ€æƒé™éªŒè¯ç»“æœ
     */
    @Cacheable(value = "validation:static", key = "#accountId + ':' + #areaId + ':' + #mealCategoryId")
    public StaticPermissionResult getStaticPermission(
        String accountId, String areaId, String mealCategoryId
    ) {
        String key = String.format("%s%s:%s:%s",
            CACHE_PREFIX_STATIC, accountId, areaId, mealCategoryId);

        StaticPermissionResult result =
            (StaticPermissionResult) redisTemplate.opsForValue().get(key);

        if (result == null) {
            result = calculateStaticPermission(accountId, areaId, mealCategoryId);
            if (result != null && result.isSuccess()) {
                // ä»…ç¼“å­˜æˆåŠŸçš„é™æ€æƒé™ç»“æœ
                redisTemplate.opsForValue().set(key, result, Duration.ofMinutes(30));
            }
        }

        return result;
    }

    /**
     * è®¡ç®—é™æ€æƒé™ï¼ˆä¸å«ä½™é¢ã€æ¬¡æ•°ç­‰åŠ¨æ€æ•°æ®ï¼‰
     */
    private StaticPermissionResult calculateStaticPermission(
        String accountId, String areaId, String mealCategoryId
    ) {
        ValidationContext context = getValidationContext(accountId);

        StaticPermissionResult result = new StaticPermissionResult();

        // 1. éªŒè¯åŒºåŸŸæƒé™
        if (!isAreaAllowed(context, areaId)) {
            result.setSuccess(false);
            result.setReason("æ— æƒåœ¨è¯¥åŒºåŸŸæ¶ˆè´¹");
            return result;
        }

        // 2. éªŒè¯é¤åˆ«åˆ†ç±»æƒé™ï¼ˆå¦‚æœæä¾›äº†é¤åˆ«IDï¼‰
        if (StringUtils.isNotBlank(mealCategoryId)) {
            if (!isMealCategoryAllowed(context, mealCategoryId)) {
                result.setSuccess(false);
                result.setReason("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
                return result;
            }
        }

        // 3. é™æ€æƒé™éªŒè¯é€šè¿‡
        result.setSuccess(true);
        result.setAreaId(areaId);
        result.setMealCategoryId(mealCategoryId);

        return result;
    }

    private boolean isAreaAllowed(ValidationContext context, String areaId) {
        Set<String> effectiveAreas = context.getEffectiveAreas();
        return effectiveAreas.contains(areaId);
    }

    private boolean isMealCategoryAllowed(ValidationContext context, String mealCategoryId) {
        Set<String> effectiveCategories = accountKindService.getEffectiveMealCategories(
            context.getAccount().getId(),
            context.getAccount().getAccountKindId(),
            context.getAreaId()
        );
        return effectiveCategories.contains(mealCategoryId);
    }

    /**
     * è·å–ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•°
     */
    @Cacheable(value = "account:today:times", key = "#accountId")
    public int getTodayConsumeTimes(String accountId) {
        String key = CACHE_PREFIX_TODAY_TIMES + accountId;
        Integer times = (Integer) redisTemplate.opsForValue().get(key);

        if (times == null) {
            // ä»æ•°æ®åº“æŸ¥è¯¢
            times = transactionDao.countTodayByAccountId(accountId);

            // ç¼“å­˜åˆ°ä»Šå¤©23:59:59
            LocalDateTime endOfDay = LocalDateTime.now().with(LocalTime.MAX);
            Duration duration = Duration.between(LocalDateTime.now(), endOfDay);
            redisTemplate.opsForValue().set(key, times, duration);
        }

        return times;
    }

    /**
     * æ¸…é™¤è´¦æˆ·ç›¸å…³ç¼“å­˜
     */
    @EventListener
    public void onAccountChanged(AccountChangeEvent event) {
        String accountId = event.getAccountId();

        // æ¸…é™¤éªŒè¯ä¸Šä¸‹æ–‡
        localCache.invalidate(CACHE_PREFIX_CONTEXT + accountId);
        redisTemplate.delete(CACHE_PREFIX_CONTEXT + accountId);

        // æ¸…é™¤é™æ€æƒé™ç»“æœï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
        Set<String> staticKeys = redisTemplate.keys(CACHE_PREFIX_STATIC + accountId + ":*");
        if (staticKeys != null && !staticKeys.isEmpty()) {
            redisTemplate.delete(staticKeys);
        }

        // æ¸…é™¤æ¶ˆè´¹ç»Ÿè®¡ç¼“å­˜
        redisTemplate.delete(CACHE_PREFIX_TODAY_TIMES + accountId);
        redisTemplate.delete(CACHE_PREFIX_TODAY_MONEY + accountId);
        redisTemplate.delete(CACHE_PREFIX_MONTH_TIMES + accountId + ":" + YearMonth.now().toString());
    }
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ç¼“å­˜æ¶æ„è®¾è®¡

```mermaid
graph LR
    A[åº”ç”¨å±‚] --> B[L1: æœ¬åœ°ç¼“å­˜<br/>Caffeine<br/>TTL: 5åˆ†é’Ÿ]
    A --> C[L2: åˆ†å¸ƒå¼ç¼“å­˜<br/>Redis<br/>TTL: 30åˆ†é’Ÿ]
    C --> D[L3: æ•°æ®åº“<br/>MySQL<br/>æŒä¹…åŒ–å­˜å‚¨]

    B --> E[ç¼“å­˜é¢„çƒ­<br/>åº”ç”¨å¯åŠ¨]
    C --> F[åå‘ç´¢å¼•<br/>Setç»“æ„]
    D --> G[ç»Ÿè®¡è¡¨<br/>å®šæ—¶æ›´æ–°]

    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e8
```

### ç¼“å­˜é”®è®¾è®¡

| ç¼“å­˜ç±»å‹ | Redis Key | æ•°æ®ç»“æ„ | TTL | è¯´æ˜ |
|---------|-----------|---------|-----|------|
| éªŒè¯ä¸Šä¸‹æ–‡ | `validation:context:{accountId}` | String(JSON) | 5åˆ†é’Ÿ | è´¦æˆ·éªŒè¯æ‰€éœ€çš„æ‰€æœ‰é…ç½® |
| é™æ€æƒé™ç»“æœ | `validation:static:{accountId}:{areaId}:{mealCategoryId}` | String(JSON) | 30åˆ†é’Ÿ | ä¸å«ä½™é¢/æ¬¡æ•°çš„é™æ€æƒé™ |
| ä»Šæ—¥æ¶ˆè´¹æ¬¡æ•° | `account:today:times:{accountId}` | String | åˆ°23:59 | ç”¨äºé™é¢éªŒè¯ |
| ä»Šæ—¥æ¶ˆè´¹é‡‘é¢ | `account:today:money:{accountId}` | String | åˆ°23:59 | ç”¨äºé™é¢éªŒè¯ |
| éªŒè¯å™¨é…ç½® | `validator:config:{validatorName}` | String(JSON) | 1å°æ—¶ | éªŒè¯å™¨é…ç½®å‚æ•° |

### æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

| åœºæ™¯ | åŸè®¾è®¡ | é‡æ„å | æå‡ |
|---------|-------|--------|------|
| å•æ¬¡éªŒè¯ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ | 50ms | 5ms | â†‘90% |
| å•æ¬¡éªŒè¯ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ | 150ms | 30ms | â†‘80% |
| æ‰¹é‡éªŒè¯100ä¸ª | 5000ms | 500ms | â†‘90% |
| é«˜å¹¶å‘TPS | 200 | 2000+ | â†‘10å€ |

---

## ğŸ”§ é…ç½®ç®¡ç†

### éªŒè¯å™¨é…ç½®

```yaml
# æƒé™éªŒè¯é…ç½®
permission-validation:
  # éªŒè¯å™¨é…ç½®
  validators:
    account-status:
      enabled: true
      timeout: 3000
      order: 1
      apply-to-modes: [1, 2, 3]
    area-permission:
      enabled: true
      timeout: 2000
      order: 2
      cache-enabled: true
    meal-permission:
      enabled: true
      timeout: 2000
      order: 3
      apply-to-modes: [1, 3]
      cache-enabled: true
    time-window:
      enabled: true
      timeout: 1000
      order: 4
      apply-to-modes: [1, 3]
    balance:
      enabled: true
      timeout: 1000
      order: 5
      cache-enabled: true
    limit:
      enabled: true
      timeout: 2000
      order: 6
      parallel-execution: false
      cache-enabled: true
    fixed-value:
      enabled: true
      timeout: 3000
      order: 7
      apply-to-modes: [1, 3]
    discount:
      enabled: true
      timeout: 1000
      order: 8
      cache-enabled: true
    product:
      enabled: true
      timeout: 5000
      order: 9
      apply-to-modes: [2, 3]
      parallel-execution: true
      cache-enabled: true

  # æ€§èƒ½é…ç½®
  performance:
    batch-size: 100
    thread-pool:
      core-size: 10
      max-size: 50
      queue-capacity: 1000
    cache:
      local-cache-size: 10000
      local-cache-ttl: 5m
      redis-connection-pool-size: 200
      redis-connection-timeout: 3000

  # ç›‘æ§é…ç½®
  monitoring:
    metrics-enabled: true
    alert-enabled: true
    slow-query-threshold: 100
    error-rate-threshold: 0.05
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡ä½“ç³»

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç›®æ ‡å€¼ | ç›‘æ§æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|---------|--------|---------|-----------|
| æƒé™éªŒè¯å“åº”æ—¶é—´ | < 10ms | Prometheus | > 50ms |
| éªŒè¯æˆåŠŸç‡ | > 99.9% | ä¸šåŠ¡ç›‘æ§ | < 99.5% |
| ç¼“å­˜å‘½ä¸­ç‡ | > 95% | Redisç›‘æ§ | < 90% |
| å¹¶å‘éªŒè¯QPS | 3000+ | åº”ç”¨ç›‘æ§ | < 2000 |
| éªŒè¯é“¾è€—æ—¶åˆ†å¸ƒ | P95<20ms | ä¸šåŠ¡ç›‘æ§ | > 50ms |

### ç›‘æ§æŒ‡æ ‡æ”¶é›†

```java
/**
 * éªŒè¯æ€§èƒ½ç›‘æ§æ”¶é›†å™¨
 */
@Component
@Slf4j
public class ValidationMetricsCollector {

    private final MeterRegistry meterRegistry;
    private final Counter validationTotal;
    private final Counter validationSuccess;
    private final Counter validationFailure;
    private final Timer validationDuration;
    private final Gauge cacheHitRate;

    public ValidationMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        this.validationTotal = Counter.builder("validation.total")
            .description("éªŒè¯æ€»æ¬¡æ•°")
            .register(meterRegistry);

        this.validationSuccess = Counter.builder("validation.success")
            .description("éªŒè¯æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);

        this.validationFailure = Counter.builder("validation.failure")
            .description("éªŒè¯å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);

        this.validationDuration = Timer.builder("validation.duration")
            .description("éªŒè¯è€—æ—¶")
            .publishPercentiles(0.5, 0.95, 0.99)
            .register(meterRegistry);

        this.cacheHitRate = Gauge.builder("validation.cache.hit.rate")
            .description("ç¼“å­˜å‘½ä¸­ç‡")
            .register(meterRegistry);
    }

    public void recordValidation(ValidationResult result, long duration) {
        validationTotal.increment();

        if (result.isSuccess()) {
            validationSuccess.increment();
        } else {
            validationFailure.tag("reason", result.getReason()).increment();
        }

        validationDuration.record(duration, TimeUnit.MILLISECONDS);
    }

    public void recordValidationFailure(Exception e) {
        validationFailure.increment();
    }
}
```

### å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: permission_validation
    interval: 30s
    rules:
      # éªŒè¯å¤±è´¥ç‡è¿‡é«˜
      - alert: HighValidationFailureRate
        expr: |
          rate(validation_failure_total[5m]) / rate(validation_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "éªŒè¯å¤±è´¥ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’ŸéªŒè¯å¤±è´¥ç‡è¶…è¿‡5%"

      # éªŒè¯è€—æ—¶è¿‡é•¿
      - alert: SlowValidation
        expr: |
          histogram_quantile(0.95, rate(validation_duration_bucket[5m])) > 50
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "éªŒè¯å“åº”æ—¶é—´è¿‡é•¿"
          description: "P95å“åº”æ—¶é—´è¶…è¿‡50ms"

      # ç¼“å­˜å‘½ä¸­ç‡ä½
      - alert: LowCacheHitRate
        expr: cache_hit_rate < 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ä½äº90%"

      # å¹¶å‘éªŒè¯æ•°è¿‡é«˜
      - alert: HighConcurrentValidations
        expr: |
          validation_concurrent > 500
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "å¹¶å‘éªŒè¯æ•°è¿‡é«˜"
          description: "å½“å‰å¹¶å‘éªŒè¯æ•°è¶…è¿‡500"
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```java
@ExtendWith(MockitoExtension.class)
class UnifiedPermissionServiceTest {

    @Mock
    private List<PermissionValidator> validators;

    @Mock
    private PermissionValidationCacheManager cacheManager;

    @Mock
    private AccountKindService accountKindService;

    @InjectMocks
    private UnifiedPermissionService permissionService;

    @Test
    @DisplayName("éªŒè¯æˆåŠŸåœºæ™¯ - é¤åˆ«åˆ¶åŒºåŸŸ")
    void testValidateSuccess_MealModeArea() {
        // Given
        PermissionValidationRequest request = PermissionValidationRequest.builder()
            .accountId("USER001")
            .areaId("CANTEEN001")
            .mealId("LUNCH001")
            .consumeTime(LocalDateTime.of(2024, 1, 1, 12, 0))
            .deviceId("DEVICE001")
            .build();

        // MockéªŒè¯å™¨
        AccountEntity account = AccountEntity.builder()
            .id("USER001")
            .available(true)
            .balance(50000)  // 500å…ƒ
            .build();

        AreaEntity area = AreaEntity.builder()
            .id("CANTEEN001")
            .manageMode(1) // é¤åˆ«åˆ¶
            .available(true)
            .build();

        MealEntity meal = MealEntity.builder()
            .id("LUNCH001")
            .categoryId("LUNCH")
            .startTime("11:00")
            .endTime("14:00")
            .available(true)
            .build();

        // Mockç¼“å­˜
        when(cacheManager.getValidationContext("USER001")).thenReturn(
            ValidationContext.builder()
                .account(account)
                .area(area)
                .meal(meal)
                .effectiveAreas(Set.of("CANTEEN001"))
                .build()
        );

        // MockéªŒè¯å™¨æ‰§è¡Œ
        when(validators.get(0).validate(any())).thenReturn(
            ValidationResult.success()
        );
        when(validators.get(1).validate(any())).thenReturn(
            ValidationResult.success()
        );
        when(validators.get(2).validate(any())).thenReturn(
            ValidationResult.success()
        );
        when(validators.get(3).validate(any())).thenReturn(
            ValidationResult.success()
        ));
        when(validators.get(4).validate(any())).thenReturn(
            ValidationResult.success()
        ));

        // When
        PermissionValidationResult result = permissionService.validate(request);

        // Then
        assertThat(result.isSuccess()).isTrue();
        assertThat(result.getFinalMoney()).isEqualTo(1500); // 15å…ƒ
        assertThat(result.getFixedMoney()).isEqualTo(1500);
        assertThat(result.getDiscountMoney()).isEqualTo(0);
        verify(validators, times(5)).validate(any());
    }

    @Test
    @DisplayName("éªŒè¯å¤±è´¥åœºæ™¯ - æ— é¤åˆ«æƒé™")
    void testValidateFailure_NoMealPermission() {
        // Given
        PermissionValidationRequest request = PermissionValidationRequest.builder()
            .accountId("USER001")
            .areaId("CANTEEN001")
            .mealId("DINNER001")
            .consumeTime(LocalDateTime.of(2024, 1, 1, 18, 0))
            .build();

        // Mockç¼“å­˜è¿”å›é™æ€æƒé™å¤±è´¥
        when(cacheManager.getStaticPermission("USER001", "CANTEEN001", "DINNER"))
            .thenReturn(
                StaticPermissionResult.fail("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»")
            );

        // When
        PermissionValidationResult result = permissionService.validate(request);

        // Then
        assertThat(result.isSuccess()).isFalse();
        assertThat(result.getReason()).isEqualTo("æ— æƒä½¿ç”¨è¯¥é¤åˆ«åˆ†ç±»");
        assertThat(result.getFailureValidator()).isEqualTo("StaticCacheCheck");
    }
}
```

### å‹åŠ›æµ‹è¯•é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="æƒé™éªŒè¯å‹åŠ›æµ‹è¯•">
      <elementProp name="TestPlan.user_defined_variables" elementType="Arguments">
        <collectionProp name="Arguments.arguments">
          <elementProp name="BASE_URL" elementType="Argument">
            <stringProp name="Argument.value">http://localhost:8080</stringProp>
          </elementProp>
          <elementProp name="THREADS" elementType="Argument">
            <stringProp name="Argument.value">1000</stringProp>
          </elementProp>
          <elementProp name="DURATION" elementType="Argument">
            <stringProp name="Argument.value">600</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
    </TestPlan>

    <hashTree>
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="éªŒè¯è¯·æ±‚">
        <intProp name="ThreadGroup.num_threads">${THREADS}</intProp>
        <intProp name="ThreadGroup.ramp_time">60</intProp>
        <intProp name="ThreadGroup.duration">${DURATION}</intProp>
        <boolProp name="ThreadGroup.scheduler">true</boolProp>
      </ThreadGroup>

      <hashTree>
        <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="éªŒè¯æƒé™">
          <stringProp name="HTTPSampler.domain">${BASE_URL}</stringProp>
          <stringProp name="HTTPSampler.path">/api/permission/validate</stringProp>
          <stringProp name="HTTPSampler.method">POST</stringProp>
          <boolProp name="HTTPSampler.use_keepalive">true</boolProp>
          <elementProp name="HTTPsampler.Arguments" elementType="Arguments">
            <collectionProp name="Arguments.arguments">
              <elementProp name="body" elementType="HTTPArgument">
                <stringProp name="Argument.value">{
                  "accountId": "${accountId}",
                  "areaId": "${areaId}",
                  "mealId": "${mealId}",
                  "consumeMoney": 1000
                }</stringProp>
                <stringProp name="Argument.metadata">=</stringProp>
                <boolProp name="HTTPArgument.always_encode">false</boolProp>
              </elementProp>
            </collectionProp>
          </elementProp>
        </HTTPSamplerProxy>

        <!-- ç›‘å¬å™¨ -->
        <ResultCollector guiclass="SummaryReport" testclass="ResultCollector" testname="èšåˆæŠ¥å‘Š"/>
        <ResultCollector guiclass="GraphVisualizer" testclass="ResultCollector" testname="å›¾å½¢ç»“æœ"/>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```

---

## ğŸ“‹ æ€»ç»“

### ç³»ç»Ÿä»·å€¼

âœ… **ç»Ÿä¸€éªŒè¯å…¥å£**ï¼š1ä¸ªServiceæ›¿ä»£5ä¸ªåˆ†æ•£é€»è¾‘ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦
âœ… **éªŒè¯æ€§èƒ½æå‡90%**ï¼šå¤šçº§ç¼“å­˜+æ‰¹é‡ä¼˜åŒ–ï¼Œå“åº”æ—¶é—´å¤§å¹…é™ä½
âœ… **è´£ä»»é“¾æ¨¡å¼**ï¼š9ä¸ªä¸“ä¸šéªŒè¯å™¨æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œï¼Œçµæ´»å¯æ‰©å±•
âœ… **ç»è¥æ¨¡å¼é€‚é…**ï¼šæ”¯æŒé¤åˆ«åˆ¶ã€è¶…å¸‚åˆ¶ã€æ··åˆæ¨¡å¼çš„å·®å¼‚åŒ–éªŒè¯
âœ… **å®Œå–„ç›‘æ§ä½“ç³»**ï¼šå®æ—¶ç›‘æ§ã€å®Œæ•´å®¡è®¡ã€æ™ºèƒ½å‘Šè­¦ï¼Œå…¨æ–¹ä½è¦†ç›–

### æŠ€æœ¯äº®ç‚¹

ğŸ—ï¸ **Spring Boot 3.5.4 + Java 17**ï¼šæœ€æ–°æŠ€æœ¯æ ˆï¼Œæ€§èƒ½ä¼˜å¼‚
ğŸ”„ **è´£ä»»é“¾è®¾è®¡**ï¼šéªŒè¯å™¨å¯æ’æ‹”ï¼Œæ˜“äºæ‰©å±•
âš¡ **å¤šçº§ç¼“å­˜ä½“ç³»**ï¼šæœ¬åœ°+Redis+æ•°æ®åº“ï¼Œæ€§èƒ½æœ€ä¼˜
ğŸ“Š **æ™ºèƒ½ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶æ€§èƒ½ç›‘æ§ï¼Œé—®é¢˜å¿«é€Ÿå®šä½
ğŸ”’ **é«˜å¯ç”¨ä¿éšœ**ï¼šç¼“å­˜é™çº§ã€ç†”æ–­å™¨ä¿æŠ¤ã€åº”æ€¥é¢„æ¡ˆ

### éªŒè¯å™¨ä½“ç³»

1. **AccountStatusValidator** - è´¦æˆ·çŠ¶æ€éªŒè¯
2. **AreaPermissionValidator** - åŒºåŸŸæƒé™éªŒè¯
3. **MealPermissionValidator** - é¤åˆ«æƒé™éªŒè¯ï¼ˆä»…é¤åˆ«åˆ¶ï¼‰
4. **TimeWindowValidator** - æ—¶é—´çª—å£éªŒè¯ï¼ˆä»…é¤åˆ«åˆ¶ï¼‰
5. **BalanceValidator** - ä½™é¢æ£€æŸ¥éªŒè¯
6. **LimitValidator** - é™é¢æ£€æŸ¥éªŒè¯
7. **FixedValueCalculator** - å®šå€¼è®¡ç®—éªŒè¯ï¼ˆä»…é¤åˆ«åˆ¶ï¼‰
8. **DiscountCalculator** - æŠ˜æ‰£è®¡ç®—éªŒè¯
9. **ProductValidator** - å•†å“æƒé™éªŒè¯ï¼ˆä»…è¶…å¸‚åˆ¶ï¼‰

### é€‚ç”¨åœºæ™¯

ğŸ“ **æ•™è‚²åœºæ™¯**ï¼šå­¦ç”Ÿå¡é™é¢ã€æ•™å¸ˆå¡ä¸é™é¢ã€é¤åˆ«æ—¶é—´æ§åˆ¶
ğŸ¥ **åŒ»ç–—åœºæ™¯**ï¼šç—…äººå¡åŒºåŸŸé™åˆ¶ã€é¤åˆ«é™åˆ¶ã€è¥å…»é¤ç®¡ç†
ğŸ¢ **ä¼ä¸šåœºæ™¯**ï¼šå‘˜å·¥å¡å±‚çº§æƒé™ã€å®šå€¼è¡¥è´´ã€æ¶ˆè´¹é™é¢
ğŸ›ï¸ **å•†åœºåœºæ™¯**ï¼šä¼šå‘˜å¡æŠ˜æ‰£ã€æ¶ˆè´¹é™é¢ã€å•†å“æƒé™æ§åˆ¶

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-13
**æ›´æ–°æ—¶é—´**ï¼š2025-11-13
**é€‚ç”¨ç‰ˆæœ¬**ï¼šIOE-DREAM v1.0+
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šIOE-DREAMæŠ€æœ¯å›¢é˜Ÿ