# æ¶ˆè´¹å¤„ç†æµç¨‹è®¾è®¡

> **ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¶é—´**: 2025-11-13
> **åˆ†ç±»**: æ ¸å¿ƒåŠŸèƒ½æ¨¡å— > ä¼ä¸šOAç³»ç»Ÿ > ä¸€å¡é€šç®¡ç†
> **æ ‡ç­¾**: ["æ¶ˆè´¹æµç¨‹", "SAGAäº‹åŠ¡", "åˆ†å¸ƒå¼äº‹åŠ¡", "æ€§èƒ½ä¼˜åŒ–", "ç¼“å­˜è®¾è®¡"]
> **ä½œè€…**: SmartAdminè§„èŒƒæ²»ç†å§”å‘˜ä¼š
> **æè¿°**: IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°æ¶ˆè´¹ç³»ç»Ÿå¤„ç†æµç¨‹çš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ é‡æ„æ¦‚è¿°

### ğŸ¯ é‡æ„ç›®æ ‡

- **æ•´åˆå‰5ä¸ªæ¨¡å—**ï¼Œæ„å»ºç»Ÿä¸€ã€é«˜æ•ˆã€å¯é çš„æ¶ˆè´¹å¤„ç†æµç¨‹
- è§£å†³ç°æœ‰æµç¨‹æ­¥éª¤åˆ†æ•£ã€äº‹åŠ¡ç®¡ç†å¤æ‚ã€ç¼ºä¹å¼‚å¸¸å¤„ç†æœºåˆ¶ç­‰é—®é¢˜
- å®ç°æ€§èƒ½æå‡80%ï¼Œæ”¯æŒSAGAåˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†

### æ ¸å¿ƒæ”¹è¿›

- âœ… **ç»Ÿä¸€ä¸šåŠ¡æµç¨‹**ï¼š7æ­¥æ ‡å‡†åŒ–æ¶ˆè´¹æµç¨‹
- âœ… **åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†**ï¼šSAGAæ¨¡å¼ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜ï¼ŒTPSæå‡10å€
- âœ… **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„è¡¥å¿æœºåˆ¶å’Œé”™è¯¯æ¢å¤
- âœ… **ç›‘æ§å®Œå–„**ï¼šå…¨æ–¹ä½çš„æŠ€æœ¯å’Œä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹è®¾è®¡

### 1. å®Œæ•´æ¶ˆè´¹æµç¨‹ï¼ˆ7æ­¥æ ‡å‡†åŒ–ï¼‰

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant D as è®¾å¤‡ç»ˆç«¯
    participant C as æ¶ˆè´¹æœåŠ¡
    participant V as æƒé™æœåŠ¡
    participant A as è´¦æˆ·æœåŠ¡
    participant T as äº¤æ˜“æœåŠ¡
    participant P as æ‰“å°æœåŠ¡

    U->>D: åˆ·å¡/åˆ·è„¸/æ‰«ç 
    D->>C: 1. èº«ä»½è¯†åˆ«è¯·æ±‚
    C->>V: 2. æƒé™éªŒè¯
    V-->>C: æƒé™éªŒè¯ç»“æœ
    C->>A: 3. åœºæ™¯è¯†åˆ«å’Œé‡‘é¢è®¡ç®—
    A-->>C: æ¶ˆè´¹é‡‘é¢å’Œæ–¹å¼
    C->>A: 4. ä½™é¢æ‰£é™¤
    A-->>C: æ‰£æ¬¾ç»“æœ
    C->>T: 5. è®°å½•äº¤æ˜“
    T-->>C: äº¤æ˜“è®°å½•ç»“æœ
    C->>P: 6. æ‰“å°å°ç¥¨
    P-->>C: æ‰“å°ç»“æœ
    C-->>D: 7. æ¶ˆè´¹å®Œæˆå“åº”
    D-->>U: æ¶ˆè´¹æˆåŠŸæç¤º
```

### 2. åŸºäºåŒºåŸŸç»è¥æ¨¡å¼çš„æ¶ˆè´¹æ¨¡å¼åˆ¤æ–­

```mermaid
stateDiagram-v2
    [*] --> è¯†åˆ«åŒºåŸŸç»è¥æ¨¡å¼
    è¯†åˆ«åŒºåŸŸç»è¥æ¨¡å¼ --> é¤åˆ«åˆ¶æ¨¡å¼: manage_mode = 1
    è¯†åˆ«åŒºåŸŸç»è¥æ¨¡å¼ --> è¶…å¸‚åˆ¶æ¨¡å¼: manage_mode = 2
    è¯†åˆ«åŒºåŸŸç»è¥æ¨¡å¼ --> æ··åˆæ¨¡å¼: manage_mode = 3

    é¤åˆ«åˆ¶æ¨¡å¼ --> åˆ¤æ–­é¤åˆ«æ—¶é—´
    åˆ¤æ–­é¤åˆ«æ—¶é—´ --> åœ¨å°±é¤æ—¶é—´: å®šå€¼æ¶ˆè´¹
    åˆ¤æ–­é¤åˆ«æ—¶é—´ --> ä¸åœ¨å°±é¤æ—¶é—´: æ‹’ç»æ¶ˆè´¹

    è¶…å¸‚åˆ¶æ¨¡å¼ --> å•†å“æ‰«ç æ¶ˆè´¹
    å•†å“æ‰«ç æ¶ˆè´¹ --> ç´¯è®¡å•†å“é‡‘é¢

    æ··åˆæ¨¡å¼ --> ç”¨æˆ·é€‰æ‹©æ–¹å¼
    ç”¨æˆ·é€‰æ‹©æ–¹å¼ --> å®šå€¼æ¨¡å¼
    ç”¨æˆ·é€‰æ‹©æ–¹å¼ --> å•†å“æ¨¡å¼

    å®šå€¼æ¶ˆè´¹ --> æƒé™éªŒè¯
    å•†å“æ‰«ç æ¶ˆè´¹ --> æƒé™éªŒè¯
    ç´¯è®¡å•†å“é‡‘é¢ --> æƒé™éªŒè¯
    å®šå€¼æ¨¡å¼ --> æƒé™éªŒè¯
    å•†å“æ¨¡å¼ --> æƒé™éªŒè¯

    æƒé™éªŒè¯ --> ä½™é¢éªŒè¯
    ä½™é¢éªŒè¯ --> æ‰£æ¬¾å¤„ç†
    æ‰£æ¬¾å¤„ç† --> äº¤æ˜“è®°å½•
    äº¤æ˜“è®°å½• --> [*]
    æ‹’ç»æ¶ˆè´¹ --> [*]
```

### 3. SAGAåˆ†å¸ƒå¼äº‹åŠ¡æµç¨‹

```mermaid
graph TD
    subgraph "SAGAä¸»æµç¨‹"
        A[1. æƒé™éªŒè¯] --> B[2. é”å®šä½™é¢]
        B --> C[3. æ‰£é™¤ä½™é¢]
        C --> D[4. è®°å½•äº¤æ˜“]
        D --> E[5. æ›´æ–°ç»Ÿè®¡]
    end

    subgraph "è¡¥å¿æµç¨‹"
        F[åˆ é™¤äº¤æ˜“è®°å½•] --> G[é€€è¿˜ä½™é¢]
        G --> H[é‡Šæ”¾é”å®š]
    end

    A -->|å¤±è´¥| [*]
    B -->|å¤±è´¥| H
    C -->|å¤±è´¥| G
    D -->|å¤±è´¥| F
    E -->|æˆåŠŸ| [*]
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. äº¤æ˜“è¡¨è®¾è®¡ï¼ˆPOSID_TRANSACTIONï¼‰

```sql
CREATE TABLE `posid_transaction` (
  `transaction_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'äº¤æ˜“ID',
  `transaction_no` varchar(32) NOT NULL COMMENT 'äº¤æ˜“æµæ°´å·',
  `employee_id` bigint(20) NOT NULL COMMENT 'å‘˜å·¥ID',
  `account_id` bigint(20) NOT NULL COMMENT 'è´¦æˆ·ID',
  `area_id` bigint(20) NOT NULL COMMENT 'åŒºåŸŸID',
  `area_manage_mode` tinyint(4) NOT NULL COMMENT 'åŒºåŸŸç»è¥æ¨¡å¼',
  `area_sub_type` varchar(32) DEFAULT NULL COMMENT 'åŒºåŸŸç»†åˆ†ç±»å‹',
  `meal_category` varchar(32) DEFAULT NULL COMMENT 'é¤åˆ«åˆ†ç±»',
  `consume_type` tinyint(4) NOT NULL COMMENT 'æ¶ˆè´¹ç±»å‹ 1-å®šå€¼ 2-é‡‘é¢ 3-å•†å“',
  `original_amount` decimal(10,2) NOT NULL COMMENT 'åŸå§‹é‡‘é¢',
  `discount_amount` decimal(10,2) DEFAULT '0.00' COMMENT 'æŠ˜æ‰£é‡‘é¢',
  `final_amount` decimal(10,2) NOT NULL COMMENT 'æœ€ç»ˆé‡‘é¢',
  `subsidy_amount` decimal(10,2) DEFAULT '0.00' COMMENT 'è¡¥è´´é‡‘é¢',
  `main_amount` decimal(10,2) DEFAULT '0.00' COMMENT 'ä¸»è´¦æˆ·é‡‘é¢',
  `before_balance` decimal(10,2) NOT NULL COMMENT 'äº¤æ˜“å‰ä½™é¢',
  `after_balance` decimal(10,2) NOT NULL COMMENT 'äº¤æ˜“åä½™é¢',
  `device_id` bigint(20) DEFAULT NULL COMMENT 'è®¾å¤‡ID',
  `operator_id` bigint(20) DEFAULT NULL COMMENT 'æ“ä½œå‘˜ID',
  `transaction_status` tinyint(4) NOT NULL COMMENT 'äº¤æ˜“çŠ¶æ€ 0-å¤±è´¥ 1-æˆåŠŸ 2-å¤„ç†ä¸­',
  `is_attendance_consume` tinyint(1) DEFAULT '0' COMMENT 'æ˜¯å¦è€ƒå‹¤æ¶ˆè´¹',
  `saga_id` varchar(32) DEFAULT NULL COMMENT 'SAGAäº‹åŠ¡ID',
  `remark` varchar(500) DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`transaction_id`),
  UNIQUE KEY `uk_transaction_no` (`transaction_no`),
  KEY `idx_employee_id` (`employee_id`),
  KEY `idx_account_id` (`account_id`),
  KEY `idx_area_id` (`area_id`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_saga_id` (`saga_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='äº¤æ˜“è®°å½•è¡¨'
PARTITION BY RANGE (YEAR(create_time)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. SAGAäº‹åŠ¡æ—¥å¿—è¡¨

```sql
CREATE TABLE `posid_saga_log` (
  `saga_id` varchar(32) NOT NULL COMMENT 'SAGAäº‹åŠ¡ID',
  `step_name` varchar(50) NOT NULL COMMENT 'æ­¥éª¤åç§°',
  `step_status` tinyint(4) NOT NULL COMMENT 'æ­¥éª¤çŠ¶æ€ 0-å¾…æ‰§è¡Œ 1-æ‰§è¡Œä¸­ 2-æˆåŠŸ 3-å¤±è´¥ 4-å·²è¡¥å¿',
  `step_data` text COMMENT 'æ­¥éª¤æ•°æ®JSON',
  `compensation_data` text COMMENT 'è¡¥å¿æ•°æ®JSON',
  `retry_count` int(11) DEFAULT '0' COMMENT 'é‡è¯•æ¬¡æ•°',
  `max_retry` int(11) DEFAULT '3' COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`saga_id`, `step_name`),
  KEY `idx_saga_id` (`saga_id`),
  KEY `idx_step_status` (`step_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='SAGAäº‹åŠ¡æ—¥å¿—è¡¨';
```

## ğŸ’¾ ç¼“å­˜ç­–ç•¥è®¾è®¡

### 1. å¤šçº§ç¼“å­˜æ¶æ„

```java
@Component
@Slf4j
public class ConsumeCacheManager {

    // è´¦æˆ·ä½™é¢ç¼“å­˜ï¼ˆå®æ—¶æ›´æ–°ï¼‰
    private final Cache<String, BigDecimal> balanceCache = Caffeine.newBuilder()
        .maximumSize(5000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .recordStats()
        .build();

    // ä»Šæ—¥æ¶ˆè´¹ç»Ÿè®¡ç¼“å­˜
    private final Cache<String, ConsumeStatistics> statisticsCache = Caffeine.newBuilder()
        .maximumSize(2000)
        .expireAfterWrite(10, TimeUnit.MINUTES)
        .recordStats()
        .build();

    @Resource
    private RedisTemplate<String, Object> redisTemplate;

    /**
     * è·å–è´¦æˆ·ä½™é¢ï¼ˆå®æ—¶åŒæ­¥ï¼‰
     */
    public BigDecimal getBalance(Long accountId) {
        String cacheKey = "balance:account:" + accountId;

        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        BigDecimal balance = (BigDecimal) balanceCache.getIfPresent(cacheKey);
        if (balance != null) {
            return balance;
        }

        // 2. æŸ¥Redisç¼“å­˜
        try {
            balance = (BigDecimal) redisTemplate.opsForValue().get(cacheKey);
            if (balance != null) {
                balanceCache.put(cacheKey, balance);
                return balance;
            }
        } catch (Exception e) {
            log.warn("Redisè®¿é—®å¼‚å¸¸ï¼Œç›´æ¥æŸ¥æ•°æ®åº“", e);
        }

        // 3. æŸ¥æ•°æ®åº“
        balance = accountService.getBalance(accountId);

        // 4. æ›´æ–°ç¼“å­˜
        this.updateBalanceCache(accountId, balance);

        return balance;
    }

    /**
     * æ›´æ–°è´¦æˆ·ä½™é¢ï¼ˆå¤šçº§ç¼“å­˜æ›´æ–°ï¼‰
     */
    public void updateBalanceCache(Long accountId, BigDecimal balance) {
        String cacheKey = "balance:account:" + accountId;

        // 1. æ›´æ–°æœ¬åœ°ç¼“å­˜
        balanceCache.put(cacheKey, balance);

        // 2. æ›´æ–°Redisç¼“å­˜
        try {
            redisTemplate.opsForValue().set(cacheKey, balance, 30, TimeUnit.MINUTES);
        } catch (Exception e) {
            log.warn("Redisæ›´æ–°å¤±è´¥", e);
        }

        // 3. å‘å¸ƒä½™é¢å˜æ›´äº‹ä»¶
        eventPublisher.publishEvent(new BalanceChangedEvent(accountId, balance));
    }

    /**
     * è·å–ä»Šæ—¥æ¶ˆè´¹ç»Ÿè®¡
     */
    public ConsumeStatistics getTodayStatistics(Long accountId, LocalDate date) {
        String cacheKey = String.format("statistics:account:%d:%s", accountId, date);

        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        ConsumeStatistics statistics = (ConsumeStatistics) statisticsCache.getIfPresent(cacheKey);
        if (statistics != null) {
            return statistics;
        }

        // 2. æŸ¥Redisç¼“å­˜
        try {
            statistics = (ConsumeStatistics) redisTemplate.opsForValue().get(cacheKey);
            if (statistics != null) {
                statisticsCache.put(cacheKey, statistics);
                return statistics;
            }
        } catch (Exception e) {
            log.warn("Redisè®¿é—®å¼‚å¸¸", e);
        }

        // 3. æŸ¥æ•°æ®åº“è®¡ç®—
        statistics = this.calculateTodayStatistics(accountId, date);

        // 4. æ›´æ–°ç¼“å­˜
        this.updateStatisticsCache(cacheKey, statistics);

        return statistics;
    }
}
```

### 2. ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥

```java
@Component
@Slf4j
public class CacheConsistencyManager {

    @EventListener
    @Async("cacheExecutor")
    public void handleBalanceChangedEvent(BalanceChangedEvent event) {
        try {
            // å»¶è¿ŸåŒåˆ ç­–ç•¥
            Thread.sleep(500);

            String cacheKey = "balance:account:" + event.getAccountId();

            // åˆ é™¤æœ¬åœ°ç¼“å­˜
            balanceCache.invalidate(cacheKey);

            // åˆ é™¤Redisç¼“å­˜
            redisTemplate.delete(cacheKey);

            log.info("ä½™é¢ç¼“å­˜æ¸…é™¤å®Œæˆ, accountId: {}", event.getAccountId());
        } catch (Exception e) {
            log.error("æ¸…é™¤ä½™é¢ç¼“å­˜å¤±è´¥", e);
        }
    }

    @EventListener
    @Async("cacheExecutor")
    public void handleTransactionEvent(TransactionEvent event) {
        try {
            // æ¸…é™¤ç›¸å…³ç»Ÿè®¡ç¼“å­˜
            String pattern = String.format("statistics:account:%d:*", event.getAccountId());
            Set<String> keys = redisTemplate.keys(pattern);

            if (!keys.isEmpty()) {
                redisTemplate.delete(keys);
            }

            // æ¸…é™¤æœ¬åœ°ç»Ÿè®¡ç¼“å­˜
            statisticsCache.invalidateAll();

            log.info("äº¤æ˜“ç»Ÿè®¡ç¼“å­˜æ¸…é™¤å®Œæˆ, accountId: {}", event.getAccountId());
        } catch (Exception e) {
            log.error("æ¸…é™¤ç»Ÿè®¡ç¼“å­˜å¤±è´¥", e);
        }
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¹¶å‘ä¼˜åŒ–

```java
@Service
@Slf4j
public class ConsumeServiceImpl implements ConsumeService {

    @Resource
    private RedissonClient redissonClient;

    @Resource
    private ConsumeDao consumeDao;

    /**
     * å¹¶å‘å®‰å…¨çš„æ¶ˆè´¹å¤„ç†
     */
    @Transactional(rollbackFor = Exception.class)
    public ConsumeResult processConsume(ConsumeRequest request) {
        String lockKey = "consume:lock:account:" + request.getAccountId();

        // ä½¿ç”¨Redisåˆ†å¸ƒå¼é”
        RLock lock = redissonClient.getLock(lockKey);

        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…3ç§’
            boolean locked = lock.tryLock(3, 10, TimeUnit.SECONDS);
            if (!locked) {
                throw new BusinessException("CONCURRENT_CONSUME", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
            }

            // æ‰§è¡Œæ¶ˆè´¹é€»è¾‘
            return this.doConsume(request);

        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }

    private ConsumeResult doConsume(ConsumeRequest request) {
        // 1. æƒé™éªŒè¯
        AreaPermission permission = this.validatePermission(request);

        // 2. ä½™é¢é”å®š
        BalanceLockResult lockResult = this.lockBalance(request);

        try {
            // 3. æ‰£é™¤ä½™é¢
            DeductionResult deductionResult = this.deductBalance(request, lockResult);

            // 4. è®°å½•äº¤æ˜“
            TransactionResult transactionResult = this.recordTransaction(request, deductionResult);

            // 5. æ›´æ–°ç»Ÿè®¡
            this.updateStatistics(request, transactionResult);

            return this.buildConsumeResult(transactionResult);

        } catch (Exception e) {
            // å¤±è´¥æ—¶é‡Šæ”¾ä½™é¢é”å®š
            this.releaseBalanceLock(lockResult);
            throw e;
        }
    }
}
```

### 2. æ‰¹é‡æ¶ˆè´¹ä¼˜åŒ–

```java
@Service
@Slf4j
public class BatchConsumeService {

    @Resource
    private RabbitTemplate rabbitTemplate;

    /**
     * å¼‚æ­¥æ‰¹é‡æ¶ˆè´¹å¤„ç†
     */
    public void processBatchConsume(List<ConsumeRequest> requests) {
        // 1. é¢„å¤„ç†éªŒè¯
        List<ConsumeRequest> validRequests = this.preValidate(requests);

        // 2. æ‰¹é‡å…¥é˜Ÿ
        BatchConsumeMessage message = new BatchConsumeMessage(validRequests);

        rabbitTemplate.convertAndSend("batch.consume.queue", message);

        log.info("æ‰¹é‡æ¶ˆè´¹è¯·æ±‚å…¥é˜Ÿå®Œæˆï¼Œæ•°é‡: {}", validRequests.size());
    }

    @RabbitListener(queues = "batch.consume.queue")
    public void handleBatchConsume(BatchConsumeMessage message) {
        long startTime = System.currentTimeMillis();

        try {
            // æŒ‰è´¦æˆ·åˆ†ç»„ï¼Œé¿å…é”å†²çª
            Map<Long, List<ConsumeRequest>> groupByAccount = message.getRequests()
                .stream()
                .collect(Collectors.groupingBy(ConsumeRequest::getAccountId));

            // å¹¶è¡Œå¤„ç†ä¸åŒè´¦æˆ·çš„è¯·æ±‚
            List<CompletableFuture<List<ConsumeResult>>> futures = groupByAccount.entrySet()
                .stream()
                .map(entry -> CompletableFuture.supplyAsync(() ->
                    this.processAccountRequests(entry.getKey(), entry.getValue())))
                .collect(Collectors.toList());

            // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
            List<ConsumeResult> allResults = futures.stream()
                .map(CompletableFuture::join)
                .flatMap(List::stream)
                .collect(Collectors.toList());

            // æ‰¹é‡å‘é€ç»“æœé€šçŸ¥
            this.sendBatchResultNotification(allResults);

            long duration = System.currentTimeMillis() - startTime;
            log.info("æ‰¹é‡æ¶ˆè´¹å¤„ç†å®Œæˆï¼Œæ•°é‡: {}, è€—æ—¶: {}ms", allResults.size(), duration);

        } catch (Exception e) {
            log.error("æ‰¹é‡æ¶ˆè´¹å¤„ç†å¤±è´¥", e);
            // å‘é€å¤±è´¥é€šçŸ¥
            this.sendBatchErrorNotification(message, e);
        }
    }
}
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡ä½“ç³»

### 1. æŠ€æœ¯ç›‘æ§æŒ‡æ ‡

```java
@Component
@Slf4j
public class ConsumeMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter consumeCounter;
    private final Timer consumeTimer;
    private final Gauge balanceGauge;

    public ConsumeMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.consumeCounter = Counter.builder("consume.requests")
            .description("æ¶ˆè´¹è¯·æ±‚æ€»æ•°")
            .register(meterRegistry);
        this.consumeTimer = Timer.builder("consume.duration")
            .description("æ¶ˆè´¹å¤„ç†è€—æ—¶")
            .register(meterRegistry);
        this.balanceGauge = Gauge.builder("consume.balance.cache")
            .description("ä½™é¢ç¼“å­˜å¤§å°")
            .register(meterRegistry, this, ConsumeMetrics::getBalanceCacheSize);
    }

    public void recordConsume(ConsumeResult result) {
        consumeCounter.increment(
            Tags.of(
                "status", result.isSuccess() ? "success" : "failed",
                "type", result.getConsumeType().toString()
            )
        );

        consumeTimer.record(result.getDuration(), TimeUnit.MILLISECONDS);
    }

    private double getBalanceCacheSize() {
        return balanceCache.estimatedSize();
    }
}
```

### 2. ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

```java
@Component
@Slf4j
public class ConsumeBusinessMetrics {

    /**
     * è®°å½•åŒºåŸŸæ¶ˆè´¹ç»Ÿè®¡
     */
    public void recordAreaConsume(Long areaId, String areaName, BigDecimal amount) {
        // åŒºåŸŸæ¶ˆè´¹é‡‘é¢TOP10ç»Ÿè®¡
        String key = String.format("metrics:area:consume:%d", areaId);

        redisTemplate.opsForZSet().incrementScore(
            "area:consume:top10",
            areaName,
            amount.doubleValue()
        );

        // é™åˆ¶TOP10
        redisTemplate.opsForZSet().removeRange("area:consume:top10", 0, -11);
    }

    /**
     * è®°å½•æ—¶æ®µæ¶ˆè´¹ç»Ÿè®¡
     */
    public void recordTimeSlotConsume(String timeSlot, BigDecimal amount) {
        String key = String.format("metrics:timeslot:%s", timeSlot);

        redisTemplate.opsForHash().increment(key, "amount", amount.doubleValue());
        redisTemplate.opsForHash().increment(key, "count", 1);

        // è®¾ç½®24å°æ—¶è¿‡æœŸ
        redisTemplate.expire(key, 24, TimeUnit.HOURS);
    }

    /**
     * è·å–æ¶ˆè´¹é«˜å³°åˆ†æ
     */
    public Map<String, Object> getConsumePeakAnalysis() {
        Map<String, Object> result = new HashMap<>();

        // 1. æ—¶æ®µæ¶ˆè´¹åˆ†æ
        Map<Object, Object> timeSlotData = redisTemplate.opsForHash().entries("metrics:timeslot:*");
        result.put("timeSlotAnalysis", this.analyzeTimeSlotData(timeSlotData));

        // 2. åŒºåŸŸæ¶ˆè´¹TOP10
        Set<ZSetOperations.TypedTuple<Object>> topAreas =
            redisTemplate.opsForZSet().reverseRangeWithScores("area:consume:top10", 0, 9);
        result.put("topConsumeAreas", this.formatTopAreas(topAreas));

        return result;
    }
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯æ¶æ„æ–‡æ¡£
- [åŒºåŸŸç®¡ç†æ¨¡å—é‡å»ºè®¾è®¡](./åŒºåŸŸç®¡ç†æ¨¡å—é‡å»ºè®¾è®¡.md) - åŒºåŸŸç®¡ç†é‡æ„æ–¹æ¡ˆ
- [è´¦æˆ·ç®¡ç†æ¨¡å—è®¾è®¡](./è´¦æˆ·ç®¡ç†æ¨¡å—è®¾è®¡.md) - è´¦æˆ·ç®¡ç†è¯¦ç»†è®¾è®¡
- [æƒé™éªŒè¯ç³»ç»Ÿè®¾è®¡](./æƒé™éªŒè¯ç³»ç»Ÿè®¾è®¡.md) - æƒé™éªŒè¯ç³»ç»Ÿè®¾è®¡

### ä¸šåŠ¡æµç¨‹æ–‡æ¡£
- [è®¢é¤ç®¡ç†æµç¨‹è®¾è®¡](./è®¢é¤ç®¡ç†æµç¨‹è®¾è®¡.md) - è®¢é¤ç®¡ç†ä¸šåŠ¡æµç¨‹
- [å……å€¼é€€æ¬¾æµç¨‹è®¾è®¡](./å……å€¼é€€æ¬¾æµç¨‹è®¾è®¡.md) - å……å€¼é€€æ¬¾ä¸šåŠ¡æµç¨‹
- [å•†å“ç®¡ç†æ¨¡å—è®¾è®¡](./å•†å“ç®¡ç†æ¨¡å—è®¾è®¡.md) - å•†å“ç®¡ç†æ¨¡å—è®¾è®¡

### æ•°æ®åº“è®¾è®¡æ–‡æ¡£
- [æ¶ˆè´¹ç³»ç»Ÿæ•°æ®åº“è®¾è®¡](./æ•°æ®åº“è®¾è®¡.md) - å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
- [æ¶ˆè´¹ç³»ç»ŸERå›¾](./ç³»ç»ŸERå›¾.md) - å®ä½“å…³ç³»å›¾è®¾è®¡

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™æ€»ç»“

1. **æ•°æ®ä¸€è‡´æ€§** - SAGAåˆ†å¸ƒå¼äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **é«˜å¹¶å‘** - åˆ†å¸ƒå¼é”å’Œæ‰¹é‡å¤„ç†æ”¯æŒé«˜å¹¶å‘åœºæ™¯
3. **é«˜æ€§èƒ½** - å¤šçº§ç¼“å­˜å’Œæ•°æ®åº“ä¼˜åŒ–å®ç°æ€§èƒ½æå‡10å€
4. **å¯ç›‘æ§** - å®Œå–„çš„æŠ€æœ¯å’Œä¸šåŠ¡ç›‘æ§æŒ‡æ ‡ä½“ç³»
5. **æ˜“æ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒåŠŸèƒ½æ‰©å±•å’Œæ€§èƒ½æ‰©å±•

## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯

- æœ¬æ–‡æ¡£åŸºäºæ¶ˆè´¹ç³»ç»Ÿå¤„ç†æµç¨‹é‡æ„è®¾è®¡
- æµç¨‹è®¾è®¡è´Ÿè´£äººï¼šSmartAdminè§„èŒƒæ²»ç†å§”å‘˜ä¼š
- åˆ›å»ºæ—¥æœŸï¼š2025-11-13
- ä¸‹æ¬¡è¯„å®¡ï¼š2026-02-13

---

**ğŸ¯ IOE-DREAMæ¶ˆè´¹å¤„ç†æµç¨‹è®¾è®¡ - åˆ†å¸ƒå¼äº‹åŠ¡ã€é«˜æ€§èƒ½ã€å¯ç›‘æ§çš„ä¼ä¸šçº§æ¶ˆè´¹å¤„ç†è§£å†³æ–¹æ¡ˆ**