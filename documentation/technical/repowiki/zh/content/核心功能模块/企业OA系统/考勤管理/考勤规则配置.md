# IOE-DREAMè€ƒå‹¤ç®¡ç†è§„åˆ™é…ç½®æ¨¡å—è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

IOE-DREAMè€ƒå‹¤ç®¡ç†è§„åˆ™é…ç½®æ¨¡å—æ˜¯æ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†è€ƒå‹¤ç³»ç»Ÿçš„å„ç§è§„åˆ™é…ç½®ï¼ŒåŒ…æ‹¬è€ƒå‹¤åŸºç¡€è§„åˆ™ã€é¢„è­¦è§„åˆ™ã€é€šçŸ¥è§„åˆ™ã€ç§»åŠ¨ç«¯è§„åˆ™ç­‰ã€‚è¯¥æ¨¡å—ä¸¥æ ¼éµå¾ªSpring Boot 3.5.4 + Java 17æŠ€æœ¯æ¶æ„ï¼Œé›†æˆå›½å¯†ç®—æ³•ä¿æŠ¤ï¼Œä¸ºè€ƒå‹¤è®¡ç®—ã€å¼‚å¸¸æ£€æµ‹å’Œé€šçŸ¥æé†’æä¾›å®Œæ•´çš„è§„åˆ™æ”¯æ’‘ä½“ç³»ã€‚

---

## ğŸ—„ï¸ æ ¸å¿ƒæ•°æ®è¡¨è®¾è®¡

### 1. attendance_rulesï¼ˆè€ƒå‹¤è§„åˆ™è¡¨ï¼‰

```sql
CREATE TABLE attendance_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢é•¿',
    rule_name VARCHAR(100) NOT NULL COMMENT 'è§„åˆ™åç§°ï¼Œå¦‚ï¼šæ ‡å‡†è€ƒå‹¤è§„åˆ™',
    rule_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§„åˆ™ç¼–ç ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼šRULE001',
    rule_type TINYINT NOT NULL COMMENT 'è§„åˆ™ç±»å‹ï¼š1-è€ƒå‹¤è§„åˆ™,2-é¢„è­¦è§„åˆ™,3-é€šçŸ¥è§„åˆ™',
    description TEXT COMMENT 'è§„åˆ™æè¿°ï¼Œè¯¦ç»†è¯´æ˜è§„åˆ™ç”¨é€”',
    config_json JSON COMMENT 'è§„åˆ™é…ç½®JSONï¼ŒåŒ…å«å…·ä½“è§„åˆ™å‚æ•°',
    warning_config JSON COMMENT 'é¢„è­¦é…ç½®JSONï¼ŒåŒ…å«é¢„è­¦é˜ˆå€¼å’Œçº§åˆ«',
    notification_config JSON COMMENT 'é€šçŸ¥é…ç½®JSONï¼ŒåŒ…å«é€šçŸ¥æ–¹å¼å’Œé¢‘ç‡',
    applicable_scope JSON COMMENT 'é€‚ç”¨èŒƒå›´JSONï¼ŒæŒ‡å®šé€‚ç”¨éƒ¨é—¨/å²—ä½/å‘˜å·¥',
    is_enabled TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ï¼š0-ç¦ç”¨ï¼Œ1-å¯ç”¨',
    status TINYINT(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-åˆ é™¤ï¼Œ1-æ­£å¸¸',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼Œè®°å½•è§„åˆ™åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼Œè®°å½•æœ€åä¿®æ”¹æ—¶é—´',

    INDEX idx_rule_type_enabled (rule_type, is_enabled),
    INDEX idx_rule_code (rule_code),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è€ƒå‹¤è§„åˆ™è¡¨';
```

### 2. attendance_pointsï¼ˆè€ƒå‹¤ç‚¹è¡¨ï¼‰

```sql
CREATE TABLE attendance_points (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢é•¿',
    point_name VARCHAR(100) NOT NULL COMMENT 'è€ƒå‹¤ç‚¹åç§°ï¼Œå¦‚ï¼šä¸€æ¥¼å¤§å…è€ƒå‹¤ç‚¹',
    point_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è€ƒå‹¤ç‚¹ç¼–ç ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼šPOINT001',
    longitude DECIMAL(10,6) COMMENT 'ç»åº¦åæ ‡ï¼Œç”¨äºGPSå®šä½',
    latitude DECIMAL(10,6) COMMENT 'çº¬åº¦åæ ‡ï¼Œç”¨äºGPSå®šä½',
    radius INT DEFAULT 100 COMMENT 'æœ‰æ•ˆåŠå¾„(ç±³)ï¼Œæ‰“å¡æœ‰æ•ˆèŒƒå›´',
    device_id BIGINT COMMENT 'å…³è”è®¾å¤‡IDï¼Œå…³è”devicesè¡¨',
    point_type TINYINT DEFAULT 1 COMMENT 'è€ƒå‹¤ç‚¹ç±»å‹ï¼š1-å›ºå®šè€ƒå‹¤ç‚¹,2-ç§»åŠ¨è€ƒå‹¤ç‚¹,3-è™šæ‹Ÿè€ƒå‹¤ç‚¹',
    address VARCHAR(200) COMMENT 'è€ƒå‹¤ç‚¹åœ°å€',
    description VARCHAR(500) COMMENT 'è€ƒå‹¤ç‚¹æè¿°',
    status TINYINT(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-ç¦ç”¨ï¼Œ1-å¯ç”¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼Œè®°å½•è€ƒå‹¤ç‚¹åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼Œè®°å½•æœ€åä¿®æ”¹æ—¶é—´',

    INDEX idx_point_code (point_code),
    INDEX idx_device_id (device_id),
    INDEX idx_status (status),
    INDEX idx_location (longitude, latitude),
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è€ƒå‹¤ç‚¹è¡¨';
```

### 3. mobile_configsï¼ˆç§»åŠ¨ç«¯é…ç½®è¡¨ï¼‰

```sql
CREATE TABLE mobile_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢é•¿',
    config_name VARCHAR(100) NOT NULL COMMENT 'é…ç½®åç§°ï¼Œå¦‚ï¼šç§»åŠ¨ç«¯è€ƒå‹¤é…ç½®',
    location_rules JSON COMMENT 'ä½ç½®è§„åˆ™JSONï¼ŒåŒ…å«GPSç²¾åº¦è¦æ±‚',
    accuracy_requirements JSON COMMENT 'ç²¾åº¦è¦æ±‚JSONï¼ŒåŒ…å«å®šä½ç²¾åº¦é˜ˆå€¼',
    time_limits JSON COMMENT 'æ—¶é—´é™åˆ¶JSONï¼ŒåŒ…å«æ‰“å¡æ—¶é—´çª—å£',
    device_binding_rules JSON COMMENT 'è®¾å¤‡ç»‘å®šè§„åˆ™JSONï¼ŒåŒ…å«è®¾å¤‡ç»‘å®šç­–ç•¥',
    security_config JSON COMMENT 'å®‰å…¨é…ç½®JSONï¼ŒåŒ…å«é˜²ä½œå¼Šè§„åˆ™',
    wifi_config JSON COMMENT 'WiFié…ç½®JSONï¼ŒåŒ…å«WiFiè€ƒå‹¤è§„åˆ™',
    bluetooth_config JSON COMMENT 'è“ç‰™é…ç½®JSONï¼ŒåŒ…å«è“ç‰™è€ƒå‹¤è§„åˆ™',
    status TINYINT(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-ç¦ç”¨ï¼Œ1-å¯ç”¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼Œè®°å½•é…ç½®åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼Œè®°å½•æœ€åä¿®æ”¹æ—¶é—´',

    INDEX idx_config_name (config_name),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç§»åŠ¨ç«¯é…ç½®è¡¨';
```

### 4. warning_rulesï¼ˆé¢„è­¦è§„åˆ™è¡¨ï¼‰

```sql
CREATE TABLE warning_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢é•¿',
    rule_name VARCHAR(100) NOT NULL COMMENT 'è§„åˆ™åç§°ï¼Œå¦‚ï¼šè®¾å¤‡è”åŠ¨é¢„è­¦è§„åˆ™',
    rule_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§„åˆ™ç¼–ç ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼šWARN001',
    rule_type TINYINT NOT NULL COMMENT 'è§„åˆ™ç±»å‹ï¼š1-è®¾å¤‡è”åŠ¨,2-åŒé‡éªŒè¯,3-å¼‚å¸¸æ£€æµ‹,4-è¡Œä¸ºåˆ†æ',
    description TEXT COMMENT 'è§„åˆ™æè¿°ï¼Œè¯¦ç»†è¯´æ˜é¢„è­¦è§„åˆ™ç”¨é€”',
    device_linkage_config JSON COMMENT 'è®¾å¤‡è”åŠ¨é…ç½®JSONï¼ŒåŒ…å«è”åŠ¨è®¾å¤‡ä¿¡æ¯',
    verification_rules JSON COMMENT 'éªŒè¯è§„åˆ™JSONï¼ŒåŒ…å«éªŒè¯æ–¹æ³•å’Œé˜ˆå€¼',
    trigger_conditions JSON COMMENT 'è§¦å‘æ¡ä»¶JSONï¼ŒåŒ…å«è§¦å‘æ¡ä»¶å’Œé˜ˆå€¼',
    handling_rules JSON COMMENT 'å¤„ç†è§„åˆ™JSONï¼ŒåŒ…å«å¤„ç†æµç¨‹å’ŒåŠ¨ä½œ',
    applicable_scope JSON COMMENT 'é€‚ç”¨èŒƒå›´JSONï¼ŒæŒ‡å®šé€‚ç”¨éƒ¨é—¨/å²—ä½/å‘˜å·¥',
    is_enabled TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ï¼š0-ç¦ç”¨ï¼Œ1-å¯ç”¨',
    status TINYINT(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-åˆ é™¤ï¼Œ1-æ­£å¸¸',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼Œè®°å½•è§„åˆ™åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼Œè®°å½•æœ€åä¿®æ”¹æ—¶é—´',

    INDEX idx_rule_type_enabled (rule_type, is_enabled),
    INDEX idx_rule_code (rule_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é¢„è­¦è§„åˆ™è¡¨';
```

### 5. notification_rulesï¼ˆé€šçŸ¥è§„åˆ™è¡¨ï¼‰

```sql
CREATE TABLE notification_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®IDï¼Œè‡ªå¢é•¿',
    rule_name VARCHAR(100) NOT NULL COMMENT 'è§„åˆ™åç§°ï¼Œå¦‚ï¼šæ‰“å¡æé†’é€šçŸ¥è§„åˆ™',
    rule_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§„åˆ™ç¼–ç ï¼Œå”¯ä¸€æ ‡è¯†ï¼Œå¦‚ï¼šNOTIFY001',
    rule_type TINYINT NOT NULL COMMENT 'è§„åˆ™ç±»å‹ï¼š1-æ‰“å¡æé†’,2-æœªæ‰“å¡é€šçŸ¥,3-è€ƒå‹¤å¼‚å¸¸é€šçŸ¥,4-é€šç”¨é€šçŸ¥',
    description TEXT COMMENT 'è§„åˆ™æè¿°ï¼Œè¯¦ç»†è¯´æ˜é€šçŸ¥è§„åˆ™ç”¨é€”',
    trigger_conditions JSON COMMENT 'è§¦å‘æ¡ä»¶é…ç½®JSONï¼ŒåŒ…å«è§¦å‘æ¡ä»¶å’Œæ—¶é—´çª—å£',
    notification_methods JSON COMMENT 'é€šçŸ¥æ–¹å¼é…ç½®JSONï¼ŒåŒ…å«çŸ­ä¿¡/é‚®ä»¶/å¾®ä¿¡ç­‰',
    recipient_config JSON COMMENT 'æ¥æ”¶äººé…ç½®JSONï¼ŒåŒ…å«æ¥æ”¶äººç±»å‹å’ŒèŒƒå›´',
    frequency_control JSON COMMENT 'é¢‘ç‡æ§åˆ¶é…ç½®JSONï¼ŒåŒ…å«é€šçŸ¥é¢‘ç‡å’Œé—´éš”',
    escalation_rules JSON COMMENT 'å‡çº§è§„åˆ™é…ç½®JSONï¼ŒåŒ…å«å‡çº§æ¡ä»¶å’ŒåŠ¨ä½œ',
    reminder_config JSON COMMENT 'æé†’é…ç½®JSONï¼ŒåŒ…å«æé†’æ—¶é—´å’Œå†…å®¹',
    template_config JSON COMMENT 'æ¨¡æ¿é…ç½®JSONï¼ŒåŒ…å«é€šçŸ¥æ¨¡æ¿ä¿¡æ¯',
    applicable_scope JSON COMMENT 'é€‚ç”¨èŒƒå›´JSONï¼ŒæŒ‡å®šé€‚ç”¨éƒ¨é—¨/å²—ä½/å‘˜å·¥',
    is_enabled TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ï¼š0-ç¦ç”¨ï¼Œ1-å¯ç”¨',
    status TINYINT(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-åˆ é™¤ï¼Œ1-æ­£å¸¸',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´ï¼Œè®°å½•è§„åˆ™åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´ï¼Œè®°å½•æœ€åä¿®æ”¹æ—¶é—´',

    INDEX idx_rule_type_enabled (rule_type, is_enabled),
    INDEX idx_rule_code (rule_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é€šçŸ¥è§„åˆ™è¡¨';
```

---

## ğŸ”— æ•°æ®è¡¨å…³è”å…³ç³»

### ERå›¾å…³ç³»
```mermaid
erDiagram
    attendance_rules {
        bigint id PK
        varchar rule_name
        varchar rule_code
        tinyint rule_type
        text description
        json config_json
        json warning_config
        json notification_config
        json applicable_scope
        tinyint is_enabled
        tinyint status
        datetime create_time
        datetime update_time
    }

    attendance_points {
        bigint id PK
        varchar point_name
        varchar point_code
        decimal longitude
        decimal latitude
        int radius
        bigint device_id FK
        tinyint point_type
        varchar address
        varchar description
        tinyint status
        datetime create_time
        datetime update_time
    }

    mobile_configs {
        bigint id PK
        varchar config_name
        json location_rules
        json accuracy_requirements
        json time_limits
        json device_binding_rules
        json security_config
        json wifi_config
        json bluetooth_config
        tinyint status
        datetime create_time
        datetime update_time
    }

    warning_rules {
        bigint id PK
        varchar rule_name
        varchar rule_code
        tinyint rule_type
        text description
        json device_linkage_config
        json verification_rules
        json trigger_conditions
        json handling_rules
        json applicable_scope
        tinyint is_enabled
        tinyint status
        datetime create_time
        datetime update_time
    }

    notification_rules {
        bigint id PK
        varchar rule_name
        varchar rule_code
        tinyint rule_type
        text description
        json trigger_conditions
        json notification_methods
        json recipient_config
        json frequency_control
        json escalation_rules
        json reminder_config
        json template_config
        json applicable_scope
        tinyint is_enabled
        tinyint status
        datetime create_time
        datetime update_time
    }

    %% å…³è”å…³ç³»
    devices ||--o{ attendance_points : "device_id"
    departments ||--o{ attendance_rules : "applicable_scope"
    employees ||--o{ attendance_rules : "applicable_scope"
```

### å…³è”è¯´æ˜
1. **è€ƒå‹¤ç‚¹-è®¾å¤‡å…³è”**ï¼šè€ƒå‹¤ç‚¹å…³è”å…·ä½“çš„è€ƒå‹¤è®¾å¤‡ï¼Œæ”¯æŒå¤šè®¾å¤‡è”åŠ¨
2. **è§„åˆ™é€‚ç”¨èŒƒå›´**ï¼šé€šè¿‡JSONå­—æ®µé…ç½®éƒ¨é—¨ã€å²—ä½ã€å‘˜å·¥ç­‰é€‚ç”¨èŒƒå›´
3. **é…ç½®çµæ´»æ‰©å±•**ï¼šå¤§é‡ä½¿ç”¨JSONå­—æ®µå­˜å‚¨å¤æ‚é…ç½®ä¿¡æ¯ï¼Œæ”¯æŒçµæ´»æ‰©å±•
4. **çŠ¶æ€ç®¡ç†**ï¼šç»Ÿä¸€çš„å¯ç”¨/ç¦ç”¨çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒè§„åˆ™çš„åŠ¨æ€æ§åˆ¶

---

## âš™ï¸ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### 1. è€ƒå‹¤åŸºç¡€è§„åˆ™é€»è¾‘

```java
@Service
@Transactional(rollbackFor = Exception.class)
public class AttendanceRuleService {

    /**
     * è€ƒå‹¤è§„åˆ™è®¡ç®—é€»è¾‘
     */
    public AttendanceResult calculateAttendance(AttendanceRecord record, AttendanceRule rule) {
        JSONObject config = rule.getConfigJson();

        // è§£æè€ƒå‹¤è®¾ç½®
        AttendanceSettings settings = parseAttendanceSettings(config);

        // è¿Ÿåˆ°åˆ¤æ–­
        boolean isLate = checkLate(record, settings);

        // æ—©é€€åˆ¤æ–­
        boolean isEarlyLeave = checkEarlyLeave(record, settings);

        // å·¥æ—¶è®¡ç®—
        double workHours = calculateWorkHours(record, settings);

        // åŠ ç­è®¡ç®—
        double overtimeHours = calculateOvertime(record, settings);

        return AttendanceResult.builder()
            .isLate(isLate)
            .isEarlyLeave(isEarlyLeave)
            .workHours(workHours)
            .overtimeHours(overtimeHours)
            .attendanceStatus(determineAttendanceStatus(isLate, isEarlyLeave))
            .build();
    }

    /**
     * æ£€æŸ¥è¿Ÿåˆ°é€»è¾‘
     */
    private boolean checkLate(AttendanceRecord record, AttendanceSettings settings) {
        LocalTime clockInTime = record.getClockInTime();
        LocalTime workStartTime = settings.getWorkStartTime();

        // è€ƒè™‘å®¹å¿æ—¶é—´
        LocalTime lateThreshold = workStartTime.plusMinutes(settings.getLateToleranceMinutes());

        return clockInTime.isAfter(lateThreshold);
    }
}
```

**è¿Ÿåˆ°æ—©é€€è§„åˆ™**ï¼š
- **å®¹å¿æ—¶é—´**ï¼šå¯é…ç½®çš„è¿Ÿåˆ°æ—©é€€å®¹å¿æ—¶é—´
- **å¼¹æ€§æ—¶é—´**ï¼šæ”¯æŒå¼¹æ€§å·¥ä½œæ—¶é—´é…ç½®
- **åˆ†æ®µåˆ¤æ–­**ï¼šæ”¯æŒæ—©ç­ã€æ™šç­ã€å¤œç­ç­‰ä¸åŒç­æ¬¡çš„åˆ¤æ–­è§„åˆ™

**æ—·å·¥è§„åˆ™**ï¼š
- **é˜ˆå€¼è®¾ç½®**ï¼šå¯é…ç½®æ—·å·¥åˆ¤æ–­çš„ç¼ºå‹¤å°æ—¶æ•°é˜ˆå€¼
- **è¿ç»­åˆ¤æ–­**ï¼šæ”¯æŒè¿ç»­æ—·å·¥çš„ç´¯è®¡åˆ¤æ–­
- **è‡ªåŠ¨æ ‡è¯†**ï¼šæ ¹æ®è§„åˆ™è‡ªåŠ¨æ ‡è¯†æ—·å·¥çŠ¶æ€

**åŠ ç­è§„åˆ™**ï¼š
- **è®¡ç®—æ–¹å¼**ï¼šæ”¯æŒæŒ‰å¤©ã€æŒ‰å‘¨ã€æŒ‰æœˆçš„åŠ ç­è®¡ç®—
- **å€æ•°è®¾ç½®**ï¼šå‘¨æœ«ã€èŠ‚å‡æ—¥åŠ ç­å€æ•°å¯é…ç½®
- **å®¡æ‰¹æµç¨‹**ï¼šåŠ ç­ç”³è¯·å’Œå®¡æ‰¹è§„åˆ™é…ç½®

### 2. é¢„è­¦è§„åˆ™é€»è¾‘

```java
@Service
public class WarningRuleService {

    /**
     * é¢„è­¦æ£€æµ‹é€»è¾‘
     */
    @Scheduled(fixedDelay = 300000) // 5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void checkWarnings() {
        List<WarningRule> enabledRules = warningRuleDao.selectEnabledRules();

        for (WarningRule rule : enabledRules) {
            executeWarningRule(rule);
        }
    }

    /**
     * æ‰§è¡Œé¢„è­¦è§„åˆ™
     */
    private void executeWarningRule(WarningRule rule) {
        JSONObject triggerConditions = rule.getTriggerConditions();
        JSONArray conditionList = triggerConditions.getJSONArray("conditions");

        for (int i = 0; i < conditionList.size(); i++) {
            JSONObject condition = conditionList.getJSONObject(i);

            if (evaluateCondition(condition)) {
                triggerWarning(rule, condition);
            }
        }
    }

    /**
     * æ¡ä»¶è¯„ä¼°é€»è¾‘
     */
    private boolean evaluateCondition(JSONObject condition) {
        String conditionType = condition.getString("type");
        int threshold = condition.getIntValue("threshold");
        int timeRange = condition.getIntValue("time_range_days");

        switch (conditionType) {
            case "no_clock_in":
                return checkNoClockIn(threshold, timeRange);
            case "frequent_late":
                return checkFrequentLate(threshold, timeRange);
            case "attendance_abnormal":
                return checkAttendanceAbnormal(threshold, timeRange);
            default:
                return false;
        }
    }
}
```

**å¼‚å¸¸æ£€æµ‹**ï¼š
- **æ¨¡å¼è¯†åˆ«**ï¼šæ£€æµ‹è€ƒå‹¤å¼‚å¸¸æ¨¡å¼ï¼ˆå¦‚é¢‘ç¹è¿Ÿåˆ°ã€è¿ç»­ç¼ºå‹¤ï¼‰
- **è¶‹åŠ¿åˆ†æ**ï¼šåˆ†æè€ƒå‹¤æ•°æ®è¶‹åŠ¿ï¼Œæå‰é¢„è­¦æ½œåœ¨é—®é¢˜
- **ç»Ÿè®¡åˆ†æ**ï¼šåŸºäºå†å²æ•°æ®ç»Ÿè®¡ï¼Œè¯†åˆ«å¼‚å¸¸è¡Œä¸º

**è®¾å¤‡è”åŠ¨**ï¼š
- **å¤šè®¾å¤‡éªŒè¯**ï¼šæ”¯æŒæ‘„åƒå¤´+é—¨ç¦+æŒ‡çº¹å¤šè®¾å¤‡è”åŠ¨éªŒè¯
- **å®æ—¶ç›‘æ§**ï¼šè®¾å¤‡çŠ¶æ€å®æ—¶ç›‘æ§ï¼Œå¼‚å¸¸è‡ªåŠ¨æŠ¥è­¦
- **æ™ºèƒ½åˆ†æ**ï¼šAIè¾…åŠ©çš„å¼‚å¸¸æ£€æµ‹å’Œåˆ†æ

### 3. é€šçŸ¥è§„åˆ™é€»è¾‘

```java
@Service
public class NotificationRuleService {

    /**
     * é€šçŸ¥è§¦å‘é€»è¾‘
     */
    public void triggerNotification(String ruleType, Map<String, Object> context) {
        List<NotificationRule> rules = notificationRuleDao.selectByType(ruleType);

        for (NotificationRule rule : rules) {
            if (shouldTrigger(rule, context)) {
                sendNotification(rule, context);
            }
        }
    }

    /**
     * é¢‘ç‡æ§åˆ¶é€»è¾‘
     */
    private boolean shouldTrigger(NotificationRule rule, Map<String, Object> context) {
        JSONObject frequencyControl = rule.getFrequencyControl();

        // æ£€æŸ¥å†·å´æœŸ
        if (isInCooldownPeriod(rule, context)) {
            return false;
        }

        // æ£€æŸ¥æ¯æ—¥å‘é€é™åˆ¶
        if (exceedsDailyLimit(rule, context)) {
            return false;
        }

        return true;
    }

    /**
     * å¤šæ¸ é“å‘é€é€»è¾‘
     */
    private void sendNotification(NotificationRule rule, Map<String, Object> context) {
        JSONObject notificationMethods = rule.getNotificationMethods();

        // çŸ­ä¿¡é€šçŸ¥
        if (notificationMethods.getBooleanValue("sms_enabled")) {
            smsService.sendSms(buildSmsContent(rule, context));
        }

        // é‚®ä»¶é€šçŸ¥
        if (notificationMethods.getBooleanValue("email_enabled")) {
            emailService.sendEmail(buildEmailContent(rule, context));
        }

        // å¾®ä¿¡é€šçŸ¥
        if (notificationMethods.getBooleanValue("wechat_enabled")) {
            wechatService.sendWechatMessage(buildWechatContent(rule, context));
        }

        // è®°å½•å‘é€æ—¥å¿—
        logNotificationSent(rule, context);
    }
}
```

**æé†’é€šçŸ¥**ï¼š
- **å®šæ—¶æé†’**ï¼šä¸Šç­ã€ä¸‹ç­æ‰“å¡å®šæ—¶æé†’
- **æ™ºèƒ½æé†’**ï¼šåŸºäºå†å²æ•°æ®çš„ä¸ªæ€§åŒ–æé†’
- **å¤šæ¸ é“æ¨é€**ï¼šçŸ­ä¿¡ã€é‚®ä»¶ã€APPæ¨é€å¤šæ¸ é“è¦†ç›–

**é¢‘ç‡æ§åˆ¶**ï¼š
- **å†·å´æœŸæ§åˆ¶**ï¼šé¿å…é‡å¤é€šçŸ¥æ‰“æ‰°
- **å‘é€é™åˆ¶**ï¼šæ¯æ—¥ã€æ¯å‘¨å‘é€æ¬¡æ•°é™åˆ¶
- **ä¼˜å…ˆçº§ç®¡ç†**ï¼šé‡è¦é€šçŸ¥ä¼˜å…ˆå‘é€

### 4. ç§»åŠ¨ç«¯è§„åˆ™é€»è¾‘

```java
@Service
public class MobileConfigService {

    /**
     * ç§»åŠ¨ç«¯æ‰“å¡éªŒè¯é€»è¾‘
     */
    public MobileClockInResult verifyMobileClockIn(MobileClockInRequest request) {
        MobileConfig config = getCurrentMobileConfig();

        // ä½ç½®éªŒè¯
        LocationVerificationResult locationResult = verifyLocation(request, config);

        // æ—¶é—´éªŒè¯
        TimeVerificationResult timeResult = verifyTime(request, config);

        // è®¾å¤‡éªŒè¯
        DeviceVerificationResult deviceResult = verifyDevice(request, config);

        // å®‰å…¨éªŒè¯
        SecurityVerificationResult securityResult = verifySecurity(request, config);

        return MobileClockInResult.builder()
            .locationValid(locationResult.isValid())
            .timeValid(timeResult.isValid())
            .deviceValid(deviceResult.isValid())
            .securityValid(securityResult.isValid())
            .overallValid(isOverallValid(locationResult, timeResult, deviceResult, securityResult))
            .errorMessage(getErrorMessage(locationResult, timeResult, deviceResult, securityResult))
            .build();
    }

    /**
     * GPSä½ç½®éªŒè¯
     */
    private LocationVerificationResult verifyLocation(MobileClockInRequest request, MobileConfig config) {
        JSONObject locationRules = config.getLocationRules();

        // æ£€æŸ¥GPSç²¾åº¦
        double requiredAccuracy = locationRules.getDoubleValue("required_accuracy");
        if (request.getGpsAccuracy() > requiredAccuracy) {
            return LocationVerificationResult.invalid("GPSç²¾åº¦ä¸è¶³");
        }

        // æ£€æŸ¥ä½ç½®èŒƒå›´
        List<AttendancePoint> points = getAttendancePoints(request.getPointCode());
        for (AttendancePoint point : points) {
            double distance = calculateDistance(
                request.getLongitude(), request.getLatitude(),
                point.getLongitude(), point.getLatitude()
            );

            if (distance <= point.getRadius()) {
                return LocationVerificationResult.valid();
            }
        }

        return LocationVerificationResult.invalid("ä¸åœ¨è€ƒå‹¤ç‚¹èŒƒå›´å†…");
    }
}
```

**ä½ç½®éªŒè¯**ï¼š
- **GPSç²¾åº¦è¦æ±‚**ï¼šå¯é…ç½®çš„GPSå®šä½ç²¾åº¦è¦æ±‚
- **åœ°ç†å›´æ **ï¼šåŸºäºGPSçš„è™šæ‹Ÿè€ƒå‹¤ç‚¹èŒƒå›´éªŒè¯
- **å¤šç‚¹éªŒè¯**ï¼šæ”¯æŒå¤šä¸ªè€ƒå‹¤ç‚¹çš„ä½ç½®éªŒè¯

**è®¾å¤‡ç»‘å®š**ï¼š
- **è®¾å¤‡å”¯ä¸€æ€§**ï¼šæ¯ä¸ªå‘˜å·¥å¯ç»‘å®šç‰¹å®šç§»åŠ¨è®¾å¤‡
- **å®‰å…¨éªŒè¯**ï¼šè®¾å¤‡æŒ‡çº¹è¯†åˆ«ï¼Œé˜²æ­¢ä»£æ‰“å¡
- **è¿œç¨‹ç®¡æ§**ï¼šæ”¯æŒè®¾å¤‡çš„è¿œç¨‹é”å®šå’Œè§£é”

---

## ğŸ“ JSONé…ç½®ç»“æ„

### 1. config_jsonï¼ˆè€ƒå‹¤è§„åˆ™é…ç½®ï¼‰JSONç»“æ„

```json
{
  "rule_name": "IOE-DREAMæ ‡å‡†è€ƒå‹¤è§„åˆ™",
  "version": "3.0",
  "attendance_settings": {
    "late_tolerance_minutes": 10,
    "early_tolerance_minutes": 10,
    "absent_threshold_hours": 4,
    "min_work_hours": 8.0,
    "break_inclusion": false,
    "overtime_calculation_method": "daily",
    "weekend_overtime_multiplier": 2.0,
    "holiday_overtime_multiplier": 3.0
  },
  "work_time_rules": {
    "flexible_enabled": true,
    "flexible_start_time": "08:00",
    "flexible_end_time": "20:00",
    "core_start_time": "10:00",
    "core_end_time": "16:00",
    "break_settings": {
      "auto_deduct": true,
      "break_duration": 60,
      "break_start_time": "12:00",
      "break_end_time": "13:00"
    }
  },
  "special_rules": {
    "holiday_handling": "double_pay",
    "weekend_handling": "normal_overtime",
    "night_shift_settings": {
      "night_start": "22:00",
      "night_end": "06:00",
      "night_shift_bonus": 0.2
    }
  },
  "multi_shift_support": {
    "enabled": true,
    "shift_change_tolerance": 30,
    "auto_shift_detection": true
  }
}
```

### 2. warning_configï¼ˆé¢„è­¦é…ç½®ï¼‰JSONç»“æ„

```json
{
  "warning_types": [
    {
      "type": "no_clock_in",
      "threshold": 3,
      "level": "high",
      "description": "è¿ç»­3æ¬¡æœªæ‰“å¡é¢„è­¦",
      "auto_actions": ["notify_manager", "notify_hr"],
      "escalation_trigger": "consecutive_days >= 5"
    },
    {
      "type": "attendance_abnormal",
      "threshold": 5,
      "level": "high",
      "description": "è¿ç»­5å¤©è€ƒå‹¤å¼‚å¸¸é¢„è­¦",
      "auto_actions": ["notify_manager", "notify_hr", "escalate"],
      "escalation_trigger": "consecutive_days >= 7"
    },
    {
      "type": "late_frequent",
      "threshold": 3,
      "time_range_days": 7,
      "level": "medium",
      "description": "é¢‘ç¹è¿Ÿåˆ°é¢„è­¦",
      "auto_actions": ["notify_employee", "notify_manager"]
    }
  ],
  "escalation_rules": [
    {
      "condition": "consecutive_days >= 3",
      "action": "notify_manager",
      "description": "è¿ç»­3å¤©å¼‚å¸¸é€šçŸ¥ç›´å±é¢†å¯¼"
    },
    {
      "condition": "consecutive_days >= 7",
      "action": "notify_hr",
      "description": "è¿ç»­7å¤©å¼‚å¸¸é€šçŸ¥HR"
    },
    {
      "condition": "severity_score >= 80",
      "action": "escalate_to_director",
      "description": "ä¸¥é‡æƒ…å†µå‡çº§è‡³æ€»ç›‘"
    }
  ],
  "ai_analysis_enabled": true,
  "behavior_pattern_detection": true
}
```

### 3. notification_configï¼ˆé€šçŸ¥é…ç½®ï¼‰JSONç»“æ„

```json
{
  "notification_channels": {
    "sms": {
      "enabled": true,
      "provider": "aliyun",
      "template_id": "SMS_001",
      "rate_limit": {
        "max_per_day": 5,
        "min_interval_minutes": 30
      }
    },
    "email": {
      "enabled": true,
      "template_engine": "freemarker",
      "template_id": "EMAIL_001",
      "rate_limit": {
        "max_per_day": 10,
        "min_interval_minutes": 15
      }
    },
    "wechat": {
      "enabled": true,
      "app_id": "wx_app_id",
      "template_id": "TEMPLATE_001",
      "rate_limit": {
        "max_per_day": 20,
        "min_interval_minutes": 5
      }
    },
    "app_push": {
      "enabled": true,
      "push_service": "jpush",
      "rate_limit": {
        "max_per_day": 50,
        "min_interval_minutes": 1
      }
    }
  },
  "notification_rules": {
    "clock_reminder": {
      "enabled": true,
      "schedule": [
        {"type": "clock_in", "offset_minutes": -30},
        {"type": "clock_in", "offset_minutes": -10},
        {"type": "clock_out", "offset_minutes": 0}
      ]
    },
    "absence_notification": {
      "enabled": true,
      "check_time": "10:00",
      "delay_minutes": 30
    }
  }
}
```

### 4. mobile_configï¼ˆç§»åŠ¨ç«¯é…ç½®ï¼‰JSONç»“æ„

```json
{
  "location_rules": {
    "gps_required": true,
    "gps_accuracy_threshold": 50,
    "location_timeout_seconds": 30,
    "location_cache_enabled": false
  },
  "security_config": {
    "device_binding_required": true,
    "biometric_verification": {
      "enabled": true,
      "methods": ["fingerprint", "face_id"],
      "fallback_to_password": true
    },
    "anti_cheating": {
      "screenshot_detection": true,
      "root_detection": true,
      "emulator_detection": true,
      "multiple_app_detection": true
    }
  },
  "network_config": {
    "wifi_verification": {
      "enabled": true,
      "allowed_ssids": ["IOE-DREAM-OFFICE", "IOE-DREAM-GUEST"],
      "signal_strength_threshold": -70
    },
    "bluetooth_verification": {
      "enabled": true,
      "beacon_devices": ["BEACON_001", "BEACON_002"],
      "rssi_threshold": -80
    }
  },
  "time_limits": {
    "clock_in_window": {
      "start_time": "07:00",
      "end_time": "10:00"
    },
    "clock_out_window": {
      "start_time": "17:00",
      "end_time": "23:00"
    },
    "offsite_clock_in": {
      "enabled": true,
      "approval_required": true,
      "max_daily_count": 1
    }
  }
}
```

---

## ğŸ”„ æ•°æ®æµè½¬è¿‡ç¨‹

### 1. è§„åˆ™é…ç½®æµç¨‹

```mermaid
flowchart TD
    A[é€‰æ‹©è§„åˆ™ç±»å‹] --> B[é…ç½®è§„åˆ™å‚æ•°]
    B --> C[è®¾ç½®é€‚ç”¨èŒƒå›´]
    C --> D[éªŒè¯è§„åˆ™æœ‰æ•ˆæ€§]
    D --> E{éªŒè¯é€šè¿‡?}
    E -->|æ˜¯| F[ä¿å­˜è§„åˆ™é…ç½®]
    E -->|å¦| G[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    F --> H[è§„åˆ™ç”Ÿæ•ˆ]
    G --> B
```

### 2. è§„åˆ™åº”ç”¨æµç¨‹

```mermaid
flowchart TD
    A[è§¦å‘è€ƒå‹¤äº‹ä»¶] --> B[åŠ è½½é€‚ç”¨è§„åˆ™]
    B --> C[æ‰§è¡Œè§„åˆ™åˆ¤æ–­]
    C --> D[ç”Ÿæˆè€ƒå‹¤ç»“æœ]
    D --> E[è§¦å‘é¢„è­¦é€šçŸ¥]
    E --> F[æ›´æ–°è€ƒå‹¤è®°å½•]
    F --> G[è®°å½•è§„åˆ™æ‰§è¡Œæ—¥å¿—]
```

### 3. é¢„è­¦å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A[æ£€æµ‹å¼‚å¸¸æƒ…å†µ] --> B[åŒ¹é…é¢„è­¦è§„åˆ™]
    B --> C[ç¡®å®šé¢„è­¦çº§åˆ«]
    C --> D[æ‰§è¡Œé¢„è­¦åŠ¨ä½œ]
    D --> E[è®°å½•é¢„è­¦æ—¥å¿—]
    E --> F[è·Ÿè¸ªå¤„ç†çŠ¶æ€]
    F --> G{æ˜¯å¦å‡çº§?}
    G -->|æ˜¯| H[æ‰§è¡Œå‡çº§åŠ¨ä½œ]
    G -->|å¦| I[é¢„è­¦å¤„ç†å®Œæˆ]
    H --> I
```

### 4. é€šçŸ¥å‘é€æµç¨‹

```mermaid
flowchart TD
    A[è§¦å‘é€šçŸ¥æ¡ä»¶] --> B[åŒ¹é…é€šçŸ¥è§„åˆ™]
    B --> C[æ£€æŸ¥é¢‘ç‡æ§åˆ¶]
    C --> D{å…è®¸å‘é€?}
    D -->|å¦| E[è·³è¿‡å‘é€]
    D -->|æ˜¯| F[ç”Ÿæˆé€šçŸ¥å†…å®¹]
    F --> G[é€‰æ‹©é€šçŸ¥æ¸ é“]
    G --> H[æ‰§è¡Œé€šçŸ¥å‘é€]
    H --> I[è®°å½•å‘é€ç»“æœ]
    I --> J[æ›´æ–°å‘é€ç»Ÿè®¡]
```

---

## ğŸ”Œ æ¨¡å—æ¥å£è®¾è®¡

### 1. è€ƒå‹¤è§„åˆ™ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/v1/attendance/rules")
@SecurityLevelCheck(value = SecurityLevelEnum.SECRET_LEVEL_3)
@Api(tags = "è€ƒå‹¤è§„åˆ™ç®¡ç†API")
public class AttendanceRuleController {

    @GetMapping("/list")
    @Operation(summary = "è·å–è§„åˆ™åˆ—è¡¨", description = "åˆ†é¡µæŸ¥è¯¢è€ƒå‹¤è§„åˆ™åˆ—è¡¨")
    public ResponseDTO<PageResult<AttendanceRuleVO>> getRuleList(
            @Valid AttendanceRuleQueryForm queryForm) {

        PageResult<AttendanceRuleVO> result = attendanceRuleService.queryRules(queryForm);
        return ResponseDTO.success(result);
    }

    @PostMapping("/create")
    @Operation(summary = "åˆ›å»ºè§„åˆ™", description = "åˆ›å»ºæ–°çš„è€ƒå‹¤è§„åˆ™")
    @SecurityAudit(operation = "ATTENDANCE_RULE_CREATE", description = "åˆ›å»ºè€ƒå‹¤è§„åˆ™")
    public ResponseDTO<Long> createRule(@Valid @RequestBody AttendanceRuleCreateForm createForm) {

        Long ruleId = attendanceRuleService.createRule(createForm);
        return ResponseDTO.success(ruleId);
    }

    @PutMapping("/{ruleId}/update")
    @Operation(summary = "æ›´æ–°è§„åˆ™", description = "æ›´æ–°è€ƒå‹¤è§„åˆ™é…ç½®")
    @SecurityAudit(operation = "ATTENDANCE_RULE_UPDATE", description = "æ›´æ–°è€ƒå‹¤è§„åˆ™")
    public ResponseDTO<Void> updateRule(
            @PathVariable Long ruleId,
            @Valid @RequestBody AttendanceRuleUpdateForm updateForm) {

        attendanceRuleService.updateRule(ruleId, updateForm);
        return ResponseDTO.success(null);
    }

    @PostMapping("/{ruleId}/toggle")
    @Operation(summary = "å¯ç”¨/ç¦ç”¨è§„åˆ™", description = "åˆ‡æ¢è§„åˆ™å¯ç”¨çŠ¶æ€")
    public ResponseDTO<Void> toggleRule(@PathVariable Long ruleId) {
        attendanceRuleService.toggleRule(ruleId);
        return ResponseDTO.success(null);
    }

    @PostMapping("/preview")
    @Operation(summary = "è§„åˆ™é¢„è§ˆ", description = "é¢„è§ˆè§„åˆ™é…ç½®æ•ˆæœ")
    public ResponseDTO<RulePreviewResult> previewRule(
            @Valid @RequestBody AttendanceRulePreviewForm previewForm) {

        RulePreviewResult result = attendanceRuleService.previewRule(previewForm);
        return ResponseDTO.success(result);
    }
}
```

### 2. è€ƒå‹¤ç‚¹ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/v1/attendance/points")
@SecurityLevelCheck(value = SecurityLevelEnum.SECRET_LEVEL_3)
@Api(tags = "è€ƒå‹¤ç‚¹ç®¡ç†API")
public class AttendancePointController {

    @GetMapping("/list")
    @Operation(summary = "è·å–è€ƒå‹¤ç‚¹åˆ—è¡¨", description = "æŸ¥è¯¢æ‰€æœ‰è€ƒå‹¤ç‚¹ä¿¡æ¯")
    public ResponseDTO<List<AttendancePointVO>> getPointList() {
        List<AttendancePointVO> points = attendancePointService.getAllPoints();
        return ResponseDTO.success(points);
    }

    @PostMapping("/create")
    @Operation(summary = "åˆ›å»ºè€ƒå‹¤ç‚¹", description = "åˆ›å»ºæ–°çš„è€ƒå‹¤ç‚¹")
    public ResponseDTO<Long> createPoint(@Valid @RequestBody AttendancePointCreateForm createForm) {
        Long pointId = attendancePointService.createPoint(createForm);
        return ResponseDTO.success(pointId);
    }

    @PostMapping("/{pointId}/verify-location")
    @Operation(summary = "éªŒè¯è€ƒå‹¤ç‚¹ä½ç½®", description = "éªŒè¯å½“å‰ä½ç½®æ˜¯å¦åœ¨è€ƒå‹¤ç‚¹èŒƒå›´å†…")
    public ResponseDTO<LocationVerificationResult> verifyLocation(
            @PathVariable Long pointId,
            @Valid @RequestBody LocationVerificationForm form) {

        LocationVerificationResult result = attendancePointService.verifyLocation(pointId, form);
        return ResponseDTO.success(result);
    }
}
```

### 3. é¢„è­¦è§„åˆ™ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/v1/attendance/warning-rules")
@SecurityLevelCheck(value = SecurityLevelEnum.SECRET_LEVEL_3)
@Api(tags = "é¢„è­¦è§„åˆ™ç®¡ç†API")
public class WarningRuleController {

    @GetMapping("/list")
    @Operation(summary = "è·å–é¢„è­¦è§„åˆ™åˆ—è¡¨", description = "æŸ¥è¯¢é¢„è­¦è§„åˆ™åˆ—è¡¨")
    public ResponseDTO<PageResult<WarningRuleVO>> getWarningRuleList(
            @Valid WarningRuleQueryForm queryForm) {

        PageResult<WarningRuleVO> result = warningRuleService.queryRules(queryForm);
        return ResponseDTO.success(result);
    }

    @PostMapping("/{ruleId}/test")
    @Operation(summary = "æµ‹è¯•é¢„è­¦è§„åˆ™", description = "æµ‹è¯•é¢„è­¦è§„åˆ™æ˜¯å¦æ­£å¸¸å·¥ä½œ")
    public ResponseDTO<WarningTestResult> testWarningRule(@PathVariable Long ruleId) {
        WarningTestResult result = warningRuleService.testRule(ruleId);
        return ResponseDTO.success(result);
    }
}
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### 1. è§„åˆ™é…ç½®é¡µé¢è®¾è®¡

```vue
<template>
  <div class="attendance-rule-config">
    <!-- å·¦ä¾§è§„åˆ™ç±»å‹å¯¼èˆª -->
    <div class="rule-type-nav">
      <a-menu
        v-model:selectedKeys="selectedRuleType"
        mode="inline"
        @click="handleRuleTypeChange"
      >
        <a-menu-item key="basic">
          <AppstoreOutlined />
          åŸºç¡€è€ƒå‹¤è§„åˆ™
        </a-menu-item>
        <a-menu-item key="warning">
          <AlertOutlined />
          é¢„è­¦è§„åˆ™
        </a-menu-item>
        <a-menu-item key="notification">
          <BellOutlined />
          é€šçŸ¥è§„åˆ™
        </a-menu-item>
        <a-menu-item key="mobile">
          <MobileOutlined />
          ç§»åŠ¨ç«¯è§„åˆ™
        </a-menu-item>
      </a-menu>
    </div>

    <!-- å³ä¾§è§„åˆ™é…ç½®åŒºåŸŸ -->
    <div class="rule-config-area">
      <!-- è§„åˆ™åˆ—è¡¨ -->
      <div class="rule-list">
        <a-table
          :dataSource="ruleList"
          :columns="ruleColumns"
          :loading="loading"
          :pagination="pagination"
          @change="handleTableChange"
        >
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'status'">
              <a-switch
                :checked="record.isEnabled"
                @change="toggleRuleStatus(record)"
              />
            </template>
            <template v-if="column.key === 'action'">
              <a-space>
                <a-button type="link" @click="editRule(record)">ç¼–è¾‘</a-button>
                <a-button type="link" @click="previewRule(record)">é¢„è§ˆ</a-button>
                <a-button type="link" danger @click="deleteRule(record)">åˆ é™¤</a-button>
              </a-space>
            </template>
          </template>
        </a-table>
      </div>

      <!-- è§„åˆ™ç¼–è¾‘å™¨ -->
      <div class="rule-editor" v-if="showEditor">
        <AttendanceRuleEditor
          :rule="currentRule"
          :ruleType="selectedRuleType[0]"
          @save="saveRule"
          @cancel="closeEditor"
        />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { useSecurity } from '@/composables/useSecurity'

const { hasPermission } = useSecurity()

const selectedRuleType = ref(['basic'])
const ruleList = ref([])
const showEditor = ref(false)
const currentRule = ref(null)
const loading = ref(false)

const pagination = reactive({
  current: 1,
  pageSize: 20,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true
})

const ruleColumns = [
  {
    title: 'è§„åˆ™åç§°',
    dataIndex: 'ruleName',
    key: 'ruleName'
  },
  {
    title: 'è§„åˆ™ç¼–ç ',
    dataIndex: 'ruleCode',
    key: 'ruleCode'
  },
  {
    title: 'è§„åˆ™ç±»å‹',
    dataIndex: 'ruleTypeText',
    key: 'ruleType'
  },
  {
    title: 'çŠ¶æ€',
    dataIndex: 'status',
    key: 'status'
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
    key: 'createTime'
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
    width: 200
  }
]

const loadRuleList = async () => {
  if (!hasPermission('ATTENDANCE_RULE_VIEW')) {
    return
  }

  loading.value = true
  try {
    const params = {
      ruleType: selectedRuleType.value[0],
      page: pagination.current,
      size: pagination.pageSize
    }

    const response = await attendanceRuleApi.getRuleList(params)
    ruleList.value = response.data.list
    pagination.total = response.data.pagination.total
  } finally {
    loading.value = false
  }
}

onMounted(() => {
  loadRuleList()
})
</script>
```

### 2. è€ƒå‹¤ç‚¹ç®¡ç†é¡µé¢è®¾è®¡

```vue
<template>
  <div class="attendance-point-management">
    <!-- åœ°å›¾è§†å›¾ -->
    <div class="map-view">
      <BaiduMap
        :center="mapCenter"
        :zoom="15"
        @click="handleMapClick"
      >
        <BaiduMarker
          v-for="point in attendancePoints"
          :key="point.id"
          :position="{ lng: point.longitude, lat: point.latitude }"
          @click="selectPoint(point)"
        />
        <BaiduCircle
          v-for="point in selectedPoints"
          :key="`circle-${point.id}`"
          :center="{ lng: point.longitude, lat: point.latitude }"
          :radius="point.radius"
          stroke-color="#FF0000"
          :stroke-opacity="0.8"
          fill-color="#FF0000"
          :fill-opacity="0.3"
        />
      </BaiduMap>
    </div>

    <!-- è€ƒå‹¤ç‚¹åˆ—è¡¨ -->
    <div class="point-list">
      <a-table
        :dataSource="attendancePoints"
        :columns="pointColumns"
        :row-selection="{ selectedRowKeys: selectedPointIds, onChange: onSelectChange }"
      >
        <template #bodyCell="{ column, record }">
          <template v-if="column.key === 'location'">
            {{ record.longitude }}, {{ record.latitude }}
          </template>
          <template v-if="column.key === 'radius'">
            {{ record.radius }}ç±³
          </template>
          <template v-if="column.key === 'action'">
            <a-space>
              <a-button type="link" @click="editPoint(record)">ç¼–è¾‘</a-button>
              <a-button type="link" @click="testLocation(record)">æµ‹è¯•</a-button>
            </a-space>
          </template>
        </template>
      </a-table>
    </div>

    <!-- è€ƒå‹¤ç‚¹ç¼–è¾‘å¼¹çª— -->
    <a-modal
      v-model:open="showPointEditor"
      title="è€ƒå‹¤ç‚¹é…ç½®"
      width="800px"
      @ok="savePoint"
    >
      <AttendancePointEditor
        v-if="showPointEditor"
        :point="currentPoint"
        ref="pointEditorRef"
      />
    </a-modal>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import BaiduMap from '@/components/BaiduMap.vue'
import AttendancePointEditor from './components/AttendancePointEditor.vue'

const mapCenter = ref({ lng: 113.123456, lat: 23.456789 })
const attendancePoints = ref([])
const selectedPointIds = ref([])
const selectedPoints = ref([])
const showPointEditor = ref(false)
const currentPoint = ref(null)
const pointEditorRef = ref()

const pointColumns = [
  {
    title: 'è€ƒå‹¤ç‚¹åç§°',
    dataIndex: 'pointName',
    key: 'pointName'
  },
  {
    title: 'è€ƒå‹¤ç‚¹ç¼–ç ',
    dataIndex: 'pointCode',
    key: 'pointCode'
  },
  {
    title: 'ä½ç½®åæ ‡',
    dataIndex: 'location',
    key: 'location'
  },
  {
    title: 'æœ‰æ•ˆåŠå¾„',
    dataIndex: 'radius',
    key: 'radius'
  },
  {
    title: 'å…³è”è®¾å¤‡',
    dataIndex: 'deviceName',
    key: 'deviceName'
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
    width: 150
  }
]

const handleMapClick = (event) => {
  const { lng, lat } = event.point
  currentPoint.value = {
    longitude: lng,
    latitude: lat,
    radius: 100
  }
  showPointEditor.value = true
}

const testLocation = async (point) => {
  try {
    const position = await getCurrentPosition()
    const distance = calculateDistance(
      position.lng, position.lat,
      point.longitude, point.latitude
    )

    if (distance <= point.radius) {
      message.success('ä½ç½®éªŒè¯æˆåŠŸ')
    } else {
      message.warning(`è·ç¦»è€ƒå‹¤ç‚¹${Math.round(distance)}ç±³ï¼Œè¶…å‡ºæœ‰æ•ˆèŒƒå›´`)
    }
  } catch (error) {
    message.error('è·å–å½“å‰ä½ç½®å¤±è´¥')
  }
}
</script>
```

---

## ğŸš€ å¼€å‘å®æ–½å»ºè®®

### 1. å¼€å‘ä¼˜å…ˆçº§è§„åˆ’

**ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰**ï¼š
- âœ… åŸºç¡€è€ƒå‹¤è§„åˆ™é…ç½®å¼•æ“
- âœ… é€šçŸ¥è§„åˆ™ç®¡ç†å’Œå‘é€ç³»ç»Ÿ
- âœ… ç§»åŠ¨ç«¯åŸºç¡€é…ç½®å’ŒéªŒè¯
- âœ… ç®€å•é¢„è­¦è§„åˆ™åŠŸèƒ½

**ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰**ï¼š
- ğŸ”„ è®¾å¤‡è”åŠ¨è§„åˆ™é…ç½®
- ğŸ”„ å¤æ‚é¢„è­¦é€»è¾‘å®ç°
- ğŸ”„ é«˜çº§é€šçŸ¥æ¨¡æ¿ç®¡ç†
- ğŸ”„ è€ƒå‹¤ç‚¹åœ°ç†å›´æ åŠŸèƒ½

**ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰**ï¼š
- ğŸ“‹ å¯è§†åŒ–è§„åˆ™é…ç½®ç•Œé¢
- ğŸ“‹ è§„åˆ™æ¨¡æ¿ç®¡ç†åŠŸèƒ½
- ğŸ“‹ æ™ºèƒ½è§„åˆ™æ¨èç³»ç»Ÿ
- ğŸ“‹ é«˜çº§ç»Ÿè®¡åˆ†ææŠ¥è¡¨

### 2. æŠ€æœ¯å®ç°è¦ç‚¹

**è§„åˆ™å¼•æ“è®¾è®¡**ï¼š
```java
@Component
public class AttendanceRuleEngine {

    private final Map<String, RuleEvaluator> evaluators = new HashMap<>();

    @PostConstruct
    public void initEvaluators() {
        evaluators.put("LATE_CHECK", new LateRuleEvaluator());
        evaluators.put("EARLY_LEAVE_CHECK", new EarlyLeaveRuleEvaluator());
        evaluators.put("ABSENCE_CHECK", new AbsenceRuleEvaluator());
        evaluators.put("OVERTIME_CALCULATION", new OvertimeRuleEvaluator());
    }

    public RuleEvaluationResult evaluateRule(AttendanceRule rule, AttendanceContext context) {
        String ruleType = rule.getRuleType();
        RuleEvaluator evaluator = evaluators.get(ruleType);

        if (evaluator == null) {
            throw new UnsupportedOperationException("ä¸æ”¯æŒçš„è§„åˆ™ç±»å‹: " + ruleType);
        }

        return evaluator.evaluate(rule, context);
    }
}
```

**é…ç½®çƒ­æ›´æ–°æœºåˆ¶**ï¼š
```java
@Component
public class ConfigurationManager {

    @EventListener
    public void handleConfigChangeEvent(ConfigChangeEvent event) {
        // é‡æ–°åŠ è½½é…ç½®
        reloadConfiguration(event.getConfigType());

        // é€šçŸ¥ç›¸å…³æœåŠ¡é…ç½®å·²æ›´æ–°
        applicationEventPublisher.publishEvent(
            new ConfigUpdatedEvent(event.getConfigType())
        );
    }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**ç¼“å­˜ç­–ç•¥**ï¼š
- è§„åˆ™é…ç½®Redisç¼“å­˜ï¼Œæå‡è§„åˆ™åŠ è½½æ€§èƒ½
- é€‚ç”¨èŒƒå›´ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- é¢„è­¦ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—

**å¼‚æ­¥å¤„ç†**ï¼š
- é€šçŸ¥å‘é€å¼‚æ­¥å¤„ç†ï¼Œæå‡å“åº”é€Ÿåº¦
- é¢„è­¦æ£€æµ‹å®šæ—¶ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ
- è§„åˆ™è®¡ç®—å¼‚æ­¥å¤„ç†ï¼Œæ”¯æŒå¤§æ‰¹é‡æ•°æ®å¤„ç†

---

## ğŸ“ˆ é¡¹ç›®ä»·å€¼æ€»ç»“

IOE-DREAMè€ƒå‹¤ç®¡ç†è§„åˆ™é…ç½®æ¨¡å—ä½œä¸ºæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒä»·å€¼ï¼š

### ğŸ¯ ä¸šåŠ¡ä»·å€¼
1. **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤æ‚è€ƒå‹¤è§„åˆ™çš„çµæ´»é…ç½®å’Œç®¡ç†
2. **æ™ºèƒ½é¢„è­¦**ï¼šåŸºäºAIçš„å¼‚å¸¸æ£€æµ‹å’Œé¢„è­¦æœºåˆ¶
3. **ç§»åŠ¨æ”¯æŒ**ï¼šå®Œæ•´çš„ç§»åŠ¨ç«¯è€ƒå‹¤éªŒè¯å’Œå®‰å…¨æ§åˆ¶
4. **å¤šæ¸ é“é€šçŸ¥**ï¼šæ”¯æŒçŸ­ä¿¡ã€é‚®ä»¶ã€å¾®ä¿¡ç­‰å¤šç§é€šçŸ¥æ–¹å¼

### ğŸ”§ æŠ€æœ¯ä»·å€¼
1. **è§„åˆ™å¼•æ“**ï¼šé«˜æ€§èƒ½çš„è§„åˆ™å¼•æ“ï¼Œæ”¯æŒå¤æ‚ä¸šåŠ¡é€»è¾‘
2. **é…ç½®ç®¡ç†**ï¼šçµæ´»çš„é…ç½®ç®¡ç†å’Œçƒ­æ›´æ–°æœºåˆ¶
3. **å®‰å…¨é˜²æŠ¤**ï¼šå›½å¯†ç®—æ³•ä¿æŠ¤å’Œå¤šé‡å®‰å…¨éªŒè¯
4. **æ‰©å±•æ€§è®¾è®¡**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒåŠŸèƒ½çµæ´»æ‰©å±•

### ğŸ“Š é‡åŒ–æ•ˆç›Š
- **é…ç½®æ•ˆç‡**ï¼šè§„åˆ™é…ç½®æ•ˆç‡æå‡80%
- **é¢„è­¦å‡†ç¡®ç‡**ï¼šå¼‚å¸¸é¢„è­¦å‡†ç¡®ç‡è¾¾åˆ°95%+
- **ç§»åŠ¨éªŒè¯**ï¼šç§»åŠ¨ç«¯æ‰“å¡éªŒè¯æˆåŠŸç‡99%+
- **ç³»ç»Ÿæ€§èƒ½**ï¼šè§„åˆ™å¤„ç†å“åº”æ—¶é—´<100ms

---

**æ¨¡å—åç§°**ï¼šIOE-DREAMè€ƒå‹¤ç®¡ç†è§„åˆ™é…ç½®æ¨¡å—
**æŠ€æœ¯æ¶æ„**ï¼šSpring Boot 3.5.4 + Java 17 + PostgreSQL 14
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-13
**æ–‡æ¡£çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

---

*è¯¥æ–‡æ¡£ä¸ºIOE-Dæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°çš„è€ƒå‹¤ç®¡ç†æ¨¡å—æä¾›äº†å®Œæ•´çš„è§„åˆ™é…ç½®è®¾è®¡è§„èŒƒï¼Œä¸ºç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§å¥ å®šäº†åšå®åŸºç¡€ã€‚*