# é—¨ç¦è®¾å¤‡ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡

> **ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¶é—´**: 2025-11-13
> **åˆ†ç±»**: æ ¸å¿ƒåŠŸèƒ½æ¨¡å— > ä¼ä¸šOAç³»ç»Ÿ > é—¨ç¦ç®¡ç†ç³»ç»Ÿ
> **æ ‡ç­¾**: ["é—¨ç¦ç³»ç»Ÿ", "è®¾å¤‡ç®¡ç†", "ZKBioSecurity", "æ¨¡å—è®¾è®¡", "ç¡¬ä»¶é›†æˆ"]
> **ä½œè€…**: SmartAdminè§„èŒƒæ²»ç†å§”å‘˜ä¼š
> **æè¿°**: IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°é—¨ç¦ç®¡ç†ç³»ç»Ÿçš„è®¾å¤‡ç®¡ç†æ¨¡å—è¯¦ç»†æŠ€æœ¯è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### æ ¸å¿ƒå®šä½

**é—¨ç¦è®¾å¤‡ç®¡ç†æ¨¡å—**æ˜¯IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°çš„åŸºç¡€æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£æ‰€æœ‰é—¨ç¦ç¡¬ä»¶è®¾å¤‡çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚åŸºäºZKBioSecurity-ACC 3.14.xæŠ€æœ¯æ¶æ„ï¼Œæä¾›Pull/PushåŒæ¨¡å¼è®¾å¤‡æ¥å…¥ã€è‡ªåŠ¨é…ç½®ã€çŠ¶æ€ç›‘æ§å’Œè¿œç¨‹æ§åˆ¶ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šæ¨¡å¼è®¾å¤‡æ¥å…¥**ï¼šæ”¯æŒPullå’ŒPushä¸¤ç§è®¾å¤‡è¿æ¥æ¨¡å¼
- âœ… **è‡ªåŠ¨è®¾å¤‡å‘ç°**ï¼šæ™ºèƒ½ç½‘ç»œæœç´¢å’Œè‡ªåŠ¨è®¾å¤‡æ³¨å†Œ
- âœ… **è®¾å¤‡è‡ªåŠ¨æ¨é€**ï¼šè®¾å¤‡ä¿¡æ¯ã€é—¨ä¿¡æ¯ã€è¯»å¤´ä¿¡æ¯è‡ªåŠ¨åŒæ­¥
- âœ… **è¿œç¨‹è®¾å¤‡æ§åˆ¶**ï¼šé‡å¯ã€å¯ç”¨/ç¦ç”¨ã€å›ºä»¶å‡çº§ç­‰è¿œç¨‹æ“ä½œ
- âœ… **é«˜çº§å‚æ•°é…ç½®**ï¼šéªŒè¯å‚æ•°ã€æ—¶åŒºã€NTPã€æ‰©å±•å‚æ•°é…ç½®
- âœ… **è®¾å¤‡çŠ¶æ€ç›‘æ§**ï¼š7Ã—24å°æ—¶è®¾å¤‡åœ¨çº¿çŠ¶æ€å’Œå¥åº·åº¦ç›‘æ§
- âœ… **åŒºåŸŸå…³è”ç®¡ç†**ï¼šè®¾å¤‡ä¸åŒºåŸŸçš„ç»‘å®šå’Œæƒé™ä¼ é€’

## ğŸ—ï¸ è®¾å¤‡ç®¡ç†æ¨¡å—æ¶æ„è®¾è®¡

### æ¨¡å—åŠŸèƒ½æ¶æ„å›¾

```mermaid
graph TB
    subgraph "é—¨ç¦è®¾å¤‡ç®¡ç†æ¨¡å—æ¶æ„"
        subgraph "ç”¨æˆ·äº¤äº’å±‚"
            UI[è®¾å¤‡ç®¡ç†ç•Œé¢]
            WEB[Webæ§åˆ¶å°]
            API[RESTful API]
        end

        subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
            subgraph "æ ¸å¿ƒä¸šåŠ¡æœåŠ¡"
                DS[è®¾å¤‡ç®¡ç†æœåŠ¡]
                AS[è‡ªåŠ¨å‘ç°æœåŠ¡]
                CS[æ§åˆ¶æœåŠ¡]
                SS[è®¾ç½®æœåŠ¡]
                IS[ä¿¡æ¯æœåŠ¡]
            end

            subgraph "è®¾å¤‡é€šä¿¡å±‚"
                PC[Pullè®¾å¤‡é€šä¿¡]
                PS[Pushè®¾å¤‡é€šä¿¡]
                DC[è®¾å¤‡è¿æ¥æ± ]
                HM[ç¡¬ä»¶åè®®é€‚é…]
            end
        end

        subgraph "æ•°æ®è®¿é—®å±‚"
            DD[è®¾å¤‡æ•°æ®è®¿é—®]
            AD[åŒºåŸŸæ•°æ®è®¿é—®]
            CD[é…ç½®æ•°æ®è®¿é—®]
            MC[æ¶ˆæ¯ç¼“å­˜]
        end

        subgraph "ç¡¬ä»¶è®¾å¤‡å±‚"
            PD[Pullè®¾å¤‡]
            PUD[Pushè®¾å¤‡]
            DO[é—¨ç¦è®¾å¤‡]
            RD[è¯»å¤´è®¾å¤‡]
            IOB[I/Oæ‰©å±•æ¿]
        end
    end

    UI --> DS
    WEB --> AS
    API --> CS

    DS --> PC
    AS --> PS
    CS --> DC
    SS --> HM

    PC --> PD
    PS --> PUD
    DC --> DO
    HM --> RD

    DD --> MC
    AD --> CD
```

### è®¾å¤‡ç®¡ç†æ ¸å¿ƒæµç¨‹è®¾è®¡

```mermaid
graph TB
    Start(è®¾å¤‡ç®¡ç†å¼€å§‹) --> Choose{é€‰æ‹©æ“ä½œç±»å‹}

    Choose -->|æ–°å¢è®¾å¤‡| AddDeviceFlow
    Choose -->|æœç´¢è®¾å¤‡| SearchDeviceFlow
    Choose -->|åŒæ­¥è®¾å¤‡ä¿¡æ¯| SyncDeviceFlow
    Choose -->|è®¾å¤‡æ§åˆ¶| DeviceControlFlow
    Choose -->|é«˜çº§è®¾ç½®| AdvancedSettingsFlow
    Choose -->|æŸ¥çœ‹ä¿¡æ¯| ViewInfoFlow

    subgraph æ–°å¢è®¾å¤‡æµç¨‹
        AddDeviceFlow --> AddType{è®¾å¤‡ç±»å‹}
        AddType -->|Pullè®¾å¤‡| PullDevice[æ‰‹åŠ¨é…ç½®Pullè®¾å¤‡]
        AddType -->|Pushè®¾å¤‡| PushDevice[ç­‰å¾…Pushè®¾å¤‡è¿æ¥]
        PullDevice --> DeviceConfig[è®¾å¤‡åŸºæœ¬é…ç½®]
        PushDevice --> AuthDevice[è®¾å¤‡æˆæƒéªŒè¯]
        DeviceConfig --> AreaSelect{é€‰æ‹©å…³è”åŒºåŸŸ}
        AuthDevice --> AreaSelect
        AreaSelect --> DeviceSave[ä¿å­˜è®¾å¤‡ä¿¡æ¯]
        DeviceSave --> AutoSync{è‡ªåŠ¨åŒæ­¥}
        AutoSync -->|æ˜¯| DoorInfo[é—¨ä¿¡æ¯è‡ªåŠ¨æ¨é€]
        AutoSync -->|æ˜¯| ReaderInfo[è¯»å¤´ä¿¡æ¯è‡ªåŠ¨æ¨é€]
        DoorInfo --> SaveDoor[ä¿å­˜é—¨ä¿¡æ¯åˆ°ç³»ç»Ÿ]
        ReaderInfo --> SaveReader[ä¿å­˜è¯»å¤´ä¿¡æ¯åˆ°ç³»ç»Ÿ]
        SaveDoor --> AddEnd[æ–°å¢è®¾å¤‡å®Œæˆ]
        SaveReader --> AddEnd
        DeviceSave --> AddEnd
    end

    subgraph æœç´¢è®¾å¤‡æµç¨‹
        SearchDeviceFlow --> NetworkSearch[ç½‘ç»œæœç´¢è®¾å¤‡]
        NetworkSearch --> DeviceList[æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨]
        DeviceList --> SelectDevice[é€‰æ‹©è¦æ·»åŠ çš„è®¾å¤‡]
        SelectDevice --> AddSelect[æ·»åŠ é€‰ä¸­è®¾å¤‡]
        AddSelect --> DeviceConfig
    end

    subgraph åŒæ­¥è®¾å¤‡ä¿¡æ¯æµç¨‹
        SyncDeviceFlow --> SelectSyncDevice[é€‰æ‹©è¦åŒæ­¥çš„è®¾å¤‡]
        SelectSyncDevice --> SyncType{åŒæ­¥ç±»å‹}
        SyncType -->|åŒæ­¥æ—¶é—´| SyncTime[åŒæ­¥è®¾å¤‡æ—¶é—´]
        SyncType -->|åŒæ­¥æ•°æ®| SyncData[åŒæ­¥æƒé™æ•°æ®]
        SyncType -->|åŒæ­¥æ‰€æœ‰æ•°æ®| SyncAll[åŒæ­¥æ‰€æœ‰é…ç½®æ•°æ®]
        SyncTime --> SyncToDevice[ä¸‹å‘åŒæ­¥å‘½ä»¤åˆ°è®¾å¤‡]
        SyncData --> SyncToDevice
        SyncAll --> SyncToDevice
        SyncToDevice --> SyncResult[åŒæ­¥ç»“æœ]
        SyncResult --> SyncEnd[åŒæ­¥å®Œæˆ]
    end

    subgraph è®¾å¤‡æ§åˆ¶æµç¨‹
        DeviceControlFlow --> ControlType{æ§åˆ¶ç±»å‹}
        ControlType -->|é‡å¯è®¾å¤‡| Reboot[ä¸‹å‘é‡å¯å‘½ä»¤]
        ControlType -->|å¯ç”¨/ç¦ç”¨| EnableDisable[è®¾ç½®è®¾å¤‡çŠ¶æ€]
        ControlType -->|æ¸…é™¤å‘½ä»¤| ClearCmd[æ¸…é™¤è®¾å¤‡å‘½ä»¤ç¼“å­˜]
        ControlType -->|å›ºä»¶å‡çº§| Upgrade[å›ºä»¶å‡çº§æµç¨‹]
        ControlType -->|æ¸…é™¤ç®¡ç†å‘˜| ClearAdmin[æ¸…é™¤è®¾å¤‡ç®¡ç†å‘˜]
        Reboot --> ExecControl[æ‰§è¡Œæ§åˆ¶å‘½ä»¤]
        EnableDisable --> ExecControl
        ClearCmd --> ExecControl
        Upgrade --> ExecControl
        ClearAdmin --> ExecControl
        ExecControl --> ControlResult[æ§åˆ¶ç»“æœåé¦ˆ]
        ControlResult --> ControlEnd[æ§åˆ¶å®Œæˆ]
    end

    subgraph é«˜çº§è®¾ç½®æµç¨‹
        AdvancedSettingsFlow --> SettingType{è®¾ç½®ç±»å‹}
        SettingType -->|éªŒè¯å‚æ•°| VerifyParam[ä¸‹å‘åå°éªŒè¯å‚æ•°]
        SettingType -->|æ—¶åŒºè®¾ç½®| TimeZone[è®¾ç½®è®¾å¤‡æ—¶åŒº]
        SettingType -->|é€šè®¯å‚æ•°| CommParam[ä¿®æ”¹IP/å¯†ç ç­‰]
        SettingType -->|æ‰©å±•å‚æ•°| ExtParam[è®¾ç½®è®¾å¤‡æ‰©å±•å‚æ•°]
        SettingType -->|NTPæœåŠ¡| NTP[é…ç½®NTPæœåŠ¡å™¨]
        VerifyParam --> SaveSetting[ä¿å­˜è®¾ç½®åˆ°è®¾å¤‡]
        TimeZone --> SaveSetting
        CommParam --> SaveSetting
        ExtParam --> SaveSetting
        NTP --> SaveSetting
        SaveSetting --> SettingResult[è®¾ç½®ç»“æœ]
        SettingResult --> SettingEnd[è®¾ç½®å®Œæˆ]
    end

    subgraph æŸ¥çœ‹ä¿¡æ¯æµç¨‹
        ViewInfoFlow --> InfoType{ä¿¡æ¯ç±»å‹}
        InfoType -->|è®¾å¤‡å‚æ•°| DevParam[è·å–è®¾å¤‡å‚æ•°]
        InfoType -->|äººå‘˜ä¿¡æ¯| PersonInfo[è·å–è®¾å¤‡äººå‘˜ä¿¡æ¯]
        InfoType -->|è®°å½•ä¿¡æ¯| TransInfo[è·å–è®¾å¤‡è®°å½•]
        InfoType -->|é—¨ç¦è§„åˆ™| AccessRules[æŸ¥çœ‹é—¨ç¦è§„åˆ™]
        InfoType -->|è®¾å¤‡å®¹é‡| DeviceUsage[æŸ¥çœ‹è®¾å¤‡ä½¿ç”¨æƒ…å†µ]
        DevParam --> ShowInfo[æ˜¾ç¤ºä¿¡æ¯]
        PersonInfo --> ShowInfo
        TransInfo --> ShowInfo
        AccessRules --> ShowInfo
        DeviceUsage --> ShowInfo
        ShowInfo --> ViewEnd[æŸ¥çœ‹å®Œæˆ]
    end
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½è¯¦ç»†è®¾è®¡

### 1. è®¾å¤‡æ¥å…¥ç®¡ç†

#### 1.1 Pullè®¾å¤‡æ¥å…¥

**åŠŸèƒ½æè¿°**ï¼šç³»ç»Ÿä¸»åŠ¨è¿æ¥è®¾å¤‡ï¼Œè·å–è®¾å¤‡ä¿¡æ¯å’ŒçŠ¶æ€

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class PullDeviceServiceImpl implements DeviceConnectionService {

    @Resource
    private DeviceConnectionPool connectionPool;

    @Resource
    private DeviceProtocolAdapter protocolAdapter;

    /**
     * Pullè®¾å¤‡è¿æ¥
     */
    public DeviceConnectionResult connectPullDevice(DeviceConnectForm connectForm) {
        try {
            // 1. åˆ›å»ºè®¾å¤‡è¿æ¥
            DeviceConnection connection = DeviceConnection.builder()
                    .deviceId(connectForm.getDeviceId())
                    .ipAddress(connectForm.getIpAddress())
                    .port(connectForm.getPort())
                    .connectionType(ConnectionType.PULL)
                    .build();

            // 2. å»ºç«‹ç½‘ç»œè¿æ¥
            SocketChannel channel = connectionPool.createConnection(connection);

            // 3. åè®®æ¡æ‰‹è®¤è¯
            AuthResult authResult = protocolAdapter.handshake(channel, connectForm);
            if (!authResult.isSuccess()) {
                return DeviceConnectionResult.failed("è®¾å¤‡è®¤è¯å¤±è´¥: " + authResult.getMessage());
            }

            // 4. è·å–è®¾å¤‡åŸºæœ¬ä¿¡æ¯
            DeviceInfo deviceInfo = protocolAdapter.getDeviceInfo(channel);

            // 5. ä¿å­˜è®¾å¤‡ä¿¡æ¯
            deviceService.saveDeviceInfo(deviceInfo);

            log.info("Pullè®¾å¤‡è¿æ¥æˆåŠŸ: {}", connectForm.getDeviceId());
            return DeviceConnectionResult.success(connection);

        } catch (Exception e) {
            log.error("Pullè®¾å¤‡è¿æ¥å¤±è´¥", e);
            return DeviceConnectionResult.failed("è¿æ¥å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * è·å–è®¾å¤‡çŠ¶æ€
     */
    public DeviceStatus getDeviceStatus(Long deviceId) {
        try {
            DeviceConnection connection = connectionPool.getConnection(deviceId);
            return protocolAdapter.getDeviceStatus(connection);
        } catch (Exception e) {
            log.error("è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥, deviceId: {}", deviceId, e);
            return DeviceStatus.offline(deviceId);
        }
    }
}
```

#### 1.2 Pushè®¾å¤‡æ¥å…¥

**åŠŸèƒ½æè¿°**ï¼šè®¾å¤‡ä¸»åŠ¨è¿æ¥ç³»ç»Ÿï¼Œæ¨é€è®¾å¤‡ä¿¡æ¯

**æŠ€æœ¯å®ç°**ï¼š
```java
@Component
@Slf4j
public class PushDeviceConnectionHandler {

    @Resource
    private DeviceConnectionPool connectionPool;

    @Resource
    private DeviceAuthService deviceAuthService;

    /**
     * å¤„ç†Pushè®¾å¤‡è¿æ¥
     */
    @EventListener
    @Async
    public void handlePushDeviceConnectEvent(PushDeviceConnectEvent event) {
        try {
            String deviceSn = event.getDeviceSn();
            String ipAddress = event.getIpAddress();

            // 1. æŸ¥æ‰¾è®¾å¤‡è®°å½•
            DeviceEntity device = deviceService.getByDeviceSn(deviceSn);
            if (device == null) {
                log.warn("æœªæ‰¾åˆ°è®¾å¤‡è®°å½•, deviceSn: {}", deviceSn);
                return;
            }

            // 2. éªŒè¯è®¾å¤‡æˆæƒ
            AuthResult authResult = deviceAuthService.authenticatePushDevice(
                device.getDeviceId(), event.getAuthCode());

            if (!authResult.isSuccess()) {
                log.warn("Pushè®¾å¤‡è®¤è¯å¤±è´¥, deviceSn: {}", deviceSn);
                return;
            }

            // 3. å»ºç«‹è¿æ¥
            DeviceConnection connection = DeviceConnection.builder()
                    .deviceId(device.getDeviceId())
                    .deviceSn(deviceSn)
                    .ipAddress(ipAddress)
                    .connectionType(ConnectionType.PUSH)
                    .connectTime(LocalDateTime.now())
                    .build();

            connectionPool.addConnection(connection);

            // 4. è‡ªåŠ¨åŒæ­¥è®¾å¤‡ä¿¡æ¯
            autoSyncDeviceInfo(device.getDeviceId());

            log.info("Pushè®¾å¤‡è¿æ¥æˆåŠŸ: {}", deviceSn);

        } catch (Exception e) {
            log.error("Pushè®¾å¤‡è¿æ¥å¤„ç†å¤±è´¥", e);
        }
    }

    /**
     * è‡ªåŠ¨åŒæ­¥è®¾å¤‡ä¿¡æ¯
     */
    private void autoSyncDeviceInfo(Long deviceId) {
        try {
            // 1. åŒæ­¥è®¾å¤‡åŸºæœ¬å‚æ•°
            deviceSyncService.syncDeviceParameters(deviceId);

            // 2. åŒæ­¥é—¨ä¿¡æ¯
            deviceSyncService.syncDoorInfo(deviceId);

            // 3. åŒæ­¥è¯»å¤´ä¿¡æ¯
            deviceSyncService.syncReaderInfo(deviceId);

            // 4. åŒæ­¥äººå‘˜æƒé™æ•°æ®
            deviceSyncService.syncPersonPermissions(deviceId);

        } catch (Exception e) {
            log.error("è‡ªåŠ¨åŒæ­¥è®¾å¤‡ä¿¡æ¯å¤±è´¥, deviceId: {}", deviceId, e);
        }
    }
}
```

### 2. è®¾å¤‡è‡ªåŠ¨å‘ç°

#### 2.1 ç½‘ç»œæœç´¢å®ç°

**åŠŸèƒ½æè¿°**ï¼šè‡ªåŠ¨æœç´¢ç½‘ç»œå†…çš„é—¨ç¦è®¾å¤‡

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class DeviceDiscoveryService {

    @Value("${access.device.discovery.timeout:5000}")
    private int discoveryTimeout;

    @Resource
    private UdpDiscoveryClient udpDiscoveryClient;

    /**
     * æœç´¢ç½‘ç»œè®¾å¤‡
     */
    public List<DiscoveredDevice> discoverNetworkDevices(String subnet) {
        try {
            List<DiscoveredDevice> discoveredDevices = new ArrayList<>();

            // 1. å¹¿æ’­æœç´¢åŒ…
            DiscoveryPacket searchPacket = DiscoveryPacket.builder()
                    .packetType(PacketType.SEARCH_REQUEST)
                    .timestamp(System.currentTimeMillis())
                    .sourceMac(getLocalMacAddress())
                    .build();

            // 2. å‘é€å¹¿æ’­åˆ°æŒ‡å®šç½‘æ®µ
            List<String> broadcastAddresses = getBroadcastAddresses(subnet);
            for (String broadcastAddr : broadcastAddresses) {
                udpDiscoveryClient.sendBroadcast(searchPacket, broadcastAddr, 48899);
            }

            // 3. ç­‰å¾…è®¾å¤‡å“åº”
            Thread.sleep(discoveryTimeout);

            // 4. æ”¶é›†å“åº”è®¾å¤‡
            List<DiscoveryResponsePacket> responses = udpDiscoveryClient.getResponses();
            for (DiscoveryResponsePacket response : responses) {
                DiscoveredDevice device = DiscoveredDevice.builder()
                        .deviceSn(response.getDeviceSn())
                        .ipAddress(response.getIpAddress())
                        .macAddress(response.getMacAddress())
                        .deviceModel(response.getDeviceModel())
                        .firmwareVersion(response.getFirmwareVersion())
                        .deviceType(response.getDeviceType())
                        .build();

                // 5. æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æ·»åŠ 
                if (!isDeviceAdded(response.getDeviceSn())) {
                    discoveredDevices.add(device);
                }
            }

            log.info("ç½‘ç»œè®¾å¤‡æœç´¢å®Œæˆ, å‘ç°{}ä¸ªæ–°è®¾å¤‡", discoveredDevices.size());
            return discoveredDevices;

        } catch (Exception e) {
            log.error("ç½‘ç»œè®¾å¤‡æœç´¢å¤±è´¥", e);
            return Collections.emptyList();
        }
    }

    /**
     * æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æ·»åŠ 
     */
    private boolean isDeviceAdded(String deviceSn) {
        return deviceService.existsByDeviceSn(deviceSn);
    }
}
```

### 3. è®¾å¤‡åŒºåŸŸå…³è”ç®¡ç†

#### 3.1 åŒºåŸŸå…³è”æµç¨‹

**åŠŸèƒ½æè¿°**ï¼šè®¾å¤‡ä¸åŒºåŸŸçš„ç»‘å®šå’Œæƒé™ä¼ é€’

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Transactional(rollbackFor = Exception.class)
@Slf4j
public class DeviceAreaAssociationService {

    @Resource
    private DeviceDao deviceDao;

    @Resource
    private AreaDao areaDao;

    @Resource
    private DeviceAreaDao deviceAreaDao;

    /**
     * è®¾å¤‡å…³è”åŒºåŸŸ
     */
    public ResponseDTO<Void> associateDeviceWithArea(DeviceAreaAssociationForm form) {
        try {
            // 1. éªŒè¯è®¾å¤‡å­˜åœ¨
            DeviceEntity device = deviceDao.selectById(form.getDeviceId());
            if (device == null) {
                return ResponseDTO.error("è®¾å¤‡ä¸å­˜åœ¨");
            }

            // 2. éªŒè¯åŒºåŸŸå­˜åœ¨
            AreaEntity area = areaDao.selectById(form.getAreaId());
            if (area == null) {
                return ResponseDTO.error("åŒºåŸŸä¸å­˜åœ¨");
            }

            // 3. æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²å…³è”å…¶ä»–åŒºåŸŸ
            DeviceAreaEntity existingAssociation = deviceAreaDao.getByDeviceId(form.getDeviceId());
            if (existingAssociation != null && !existingAssociation.getAreaId().equals(form.getAreaId())) {
                return ResponseDTO.error("è®¾å¤‡å·²å…³è”å…¶ä»–åŒºåŸŸï¼Œè¯·å…ˆè§£é™¤åŸå…³è”");
            }

            // 4. åˆ›å»ºæˆ–æ›´æ–°åŒºåŸŸå…³è”
            DeviceAreaEntity association;
            if (existingAssociation != null) {
                association = existingAssociation;
                association.setAreaId(form.getAreaId());
                association.setUpdateTime(LocalDateTime.now());
                deviceAreaDao.updateById(association);
            } else {
                association = DeviceAreaEntity.builder()
                        .deviceId(form.getDeviceId())
                        .areaId(form.getAreaId())
                        .createTime(LocalDateTime.now())
                        .build();
                deviceAreaDao.insert(association);
            }

            // 5. åŒæ­¥æƒé™åˆ°è®¾å¤‡
            syncAreaPermissionsToDevice(form.getDeviceId(), form.getAreaId());

            log.info("è®¾å¤‡å…³è”åŒºåŸŸæˆåŠŸ, deviceId: {}, areaId: {}", form.getDeviceId(), form.getAreaId());
            return ResponseDTO.ok();

        } catch (Exception e) {
            log.error("è®¾å¤‡å…³è”åŒºåŸŸå¤±è´¥", e);
            return ResponseDTO.error("å…³è”å¤±è´¥");
        }
    }

    /**
     * åŒæ­¥åŒºåŸŸæƒé™åˆ°è®¾å¤‡
     */
    private void syncAreaPermissionsToDevice(Long deviceId, Long areaId) {
        try {
            // 1. è·å–åŒºåŸŸæƒé™é…ç½®
            List<AreaPermissionConfig> permissionConfigs = areaPermissionService
                    .getPermissionConfigs(areaId);

            // 2. è½¬æ¢ä¸ºè®¾å¤‡æƒé™æ ¼å¼
            List<DevicePermission> devicePermissions = convertToDevicePermissions(
                    deviceId, permissionConfigs);

            // 3. ä¸‹å‘æƒé™åˆ°è®¾å¤‡
            devicePermissionService.syncPermissionsToDevice(deviceId, devicePermissions);

            log.info("åŒºåŸŸæƒé™åŒæ­¥åˆ°è®¾å¤‡æˆåŠŸ, deviceId: {}, areaId: {}", deviceId, areaId);

        } catch (Exception e) {
            log.error("åŒæ­¥åŒºåŸŸæƒé™åˆ°è®¾å¤‡å¤±è´¥", e);
            throw new RuntimeException("æƒé™åŒæ­¥å¤±è´¥");
        }
    }
}
```

### 4. è®¾å¤‡è¿œç¨‹æ§åˆ¶

#### 4.1 è®¾å¤‡æ§åˆ¶æœåŠ¡

**åŠŸèƒ½æè¿°**ï¼šè¿œç¨‹è®¾å¤‡æ§åˆ¶æ“ä½œå®ç°

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class DeviceControlService {

    @Resource
    private DeviceConnectionPool connectionPool;

    @Resource
    private DeviceCommandExecutor commandExecutor;

    @Resource
    private FirmwareUpgradeService firmwareUpgradeService;

    /**
     * é‡å¯è®¾å¤‡
     */
    public DeviceControlResult rebootDevice(Long deviceId) {
        try {
            // 1. è·å–è®¾å¤‡è¿æ¥
            DeviceConnection connection = connectionPool.getConnection(deviceId);
            if (connection == null) {
                return DeviceControlResult.failed("è®¾å¤‡ç¦»çº¿");
            }

            // 2. å‘é€é‡å¯å‘½ä»¤
            CommandResult result = commandExecutor.executeCommand(
                connection, DeviceCommand.REBOOT);

            if (result.isSuccess()) {
                // 3. æ ‡è®°è®¾å¤‡ä¸ºé‡å¯çŠ¶æ€
                deviceService.updateDeviceStatus(deviceId, DeviceStatus.REBOOTING);

                // 4. æ–­å¼€è¿æ¥ï¼Œç­‰å¾…è®¾å¤‡é‡æ–°è¿æ¥
                connectionPool.removeConnection(deviceId);

                log.info("è®¾å¤‡é‡å¯å‘½ä»¤å‘é€æˆåŠŸ, deviceId: {}", deviceId);
                return DeviceControlResult.success("è®¾å¤‡é‡å¯å‘½ä»¤å·²å‘é€");
            } else {
                return DeviceControlResult.failed("é‡å¯å‘½ä»¤æ‰§è¡Œå¤±è´¥: " + result.getMessage());
            }

        } catch (Exception e) {
            log.error("é‡å¯è®¾å¤‡å¤±è´¥, deviceId: {}", deviceId, e);
            return DeviceControlResult.failed("é‡å¯å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * è®¾å¤‡å¯ç”¨/ç¦ç”¨
     */
    public DeviceControlResult enableDevice(Long deviceId, boolean enable) {
        try {
            // 1. æ›´æ–°è®¾å¤‡çŠ¶æ€
            deviceService.updateDeviceEnabled(deviceId, enable);

            // 2. å¦‚æœæ˜¯å¯ç”¨æ“ä½œï¼Œå°è¯•è¿æ¥è®¾å¤‡
            if (enable) {
                DeviceEntity device = deviceService.getById(deviceId);
                if (device != null && device.getConnectionType() == ConnectionType.PULL) {
                    deviceConnectionService.connectPullDevice(device.getDeviceId());
                }
            }

            log.info("è®¾å¤‡çŠ¶æ€æ›´æ–°æˆåŠŸ, deviceId: {}, enabled: {}", deviceId, enable);
            return DeviceControlResult.success(enable ? "è®¾å¤‡å·²å¯ç”¨" : "è®¾å¤‡å·²ç¦ç”¨");

        } catch (Exception e) {
            log.error("è®¾å¤‡çŠ¶æ€æ›´æ–°å¤±è´¥, deviceId: {}", deviceId, e);
            return DeviceControlResult.failed("çŠ¶æ€æ›´æ–°å¤±è´¥");
        }
    }

    /**
     * å›ºä»¶å‡çº§
     */
    @Async
    public CompletableFuture<DeviceControlResult> upgradeFirmware(Long deviceId,
                                                                  String firmwareFilePath) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                // 1. éªŒè¯å›ºä»¶æ–‡ä»¶
                FirmwareFile firmwareFile = firmwareUpgradeService
                        .validateFirmwareFile(firmwareFilePath);
                if (firmwareFile == null) {
                    return DeviceControlResult.failed("å›ºä»¶æ–‡ä»¶éªŒè¯å¤±è´¥");
                }

                // 2. è·å–è®¾å¤‡è¿æ¥
                DeviceConnection connection = connectionPool.getConnection(deviceId);
                if (connection == null) {
                    return DeviceControlResult.failed("è®¾å¤‡ç¦»çº¿");
                }

                // 3. æ‰§è¡Œå›ºä»¶å‡çº§
                FirmwareUpgradeResult upgradeResult = firmwareUpgradeService
                        .upgradeFirmware(connection, firmwareFile);

                if (upgradeResult.isSuccess()) {
                    // 4. æ›´æ–°è®¾å¤‡å›ºä»¶ç‰ˆæœ¬ä¿¡æ¯
                    deviceService.updateFirmwareVersion(deviceId,
                            firmwareFile.getVersion());

                    log.info("è®¾å¤‡å›ºä»¶å‡çº§æˆåŠŸ, deviceId: {}", deviceId);
                    return DeviceControlResult.success("å›ºä»¶å‡çº§æˆåŠŸ");
                } else {
                    return DeviceControlResult.failed("å›ºä»¶å‡çº§å¤±è´¥: " +
                            upgradeResult.getMessage());
                }

            } catch (Exception e) {
                log.error("è®¾å¤‡å›ºä»¶å‡çº§å¤±è´¥, deviceId: {}", deviceId, e);
                return DeviceControlResult.failed("å›ºä»¶å‡çº§å¼‚å¸¸: " + e.getMessage());
            }
        });
    }
}
```

### 5. é«˜çº§å‚æ•°é…ç½®

#### 5.1 è®¾å¤‡å‚æ•°é…ç½®æœåŠ¡

**åŠŸèƒ½æè¿°**ï¼šè®¾å¤‡é«˜çº§å‚æ•°é…ç½®å’Œç®¡ç†

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class DeviceConfigurationService {

    @Resource
    private DeviceConnectionPool connectionPool;

    @Resource
    private DeviceParameterAdapter parameterAdapter;

    /**
     * é…ç½®éªŒè¯å‚æ•°
     */
    public DeviceConfigResult configureVerifyParameters(Long deviceId,
                                                       VerifyParameterConfig config) {
        try {
            // 1. è·å–è®¾å¤‡è¿æ¥
            DeviceConnection connection = connectionPool.getConnection(deviceId);
            if (connection == null) {
                return DeviceConfigResult.failed("è®¾å¤‡ç¦»çº¿");
            }

            // 2. æ„å»ºéªŒè¯å‚æ•°é…ç½®
            DeviceParameter verifyParam = DeviceParameter.builder()
                    .parameterType(ParameterType.VERIFY_PARAMETERS)
                    .cardVerifyMode(config.getCardVerifyMode())
                    .cardValidPeriod(config.getCardValidPeriod())
                    .pinLength(config.getPinLength())
                    .duplicateCheckInterval(config.getDuplicateCheckInterval())
                    .build();

            // 3. ä¸‹å‘é…ç½®åˆ°è®¾å¤‡
            ConfigResult result = parameterAdapter.configureParameter(connection, verifyParam);

            if (result.isSuccess()) {
                // 4. ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
                deviceParameterService.saveDeviceParameter(deviceId, verifyParam);

                log.info("è®¾å¤‡éªŒè¯å‚æ•°é…ç½®æˆåŠŸ, deviceId: {}", deviceId);
                return DeviceConfigResult.success("é…ç½®æˆåŠŸ");
            } else {
                return DeviceConfigResult.failed("é…ç½®å¤±è´¥: " + result.getMessage());
            }

        } catch (Exception e) {
            log.error("é…ç½®è®¾å¤‡éªŒè¯å‚æ•°å¤±è´¥, deviceId: {}", deviceId, e);
            return DeviceConfigResult.failed("é…ç½®å¼‚å¸¸: " + e.getMessage());
        }
    }

    /**
     * é…ç½®NTPæœåŠ¡å™¨
     */
    public DeviceConfigResult configureNtpServer(Long deviceId, NtpServerConfig config) {
        try {
            DeviceConnection connection = connectionPool.getConnection(deviceId);
            if (connection == null) {
                return DeviceConfigResult.failed("è®¾å¤‡ç¦»çº¿");
            }

            // 1. æ„å»ºNTPé…ç½®
            DeviceParameter ntpParam = DeviceParameter.builder()
                    .parameterType(ParameterType.NTP_SERVER)
                    .ntpServer1(config.getNtpServer1())
                    .ntpServer2(config.getNtpServer2())
                    .ntpPort(config.getNtpPort())
                    .syncInterval(config.getSyncInterval())
                    .timeZone(config.getTimeZone())
                    .build();

            // 2. ä¸‹å‘é…ç½®
            ConfigResult result = parameterAdapter.configureParameter(connection, ntpParam);

            if (result.isSuccess()) {
                // 3. æµ‹è¯•NTPè¿æ¥
                boolean ntpAvailable = parameterAdapter.testNtpConnection(
                    connection, config.getNtpServer1());

                if (ntpAvailable) {
                    deviceParameterService.saveDeviceParameter(deviceId, ntpParam);
                    log.info("è®¾å¤‡NTPæœåŠ¡å™¨é…ç½®æˆåŠŸ, deviceId: {}", deviceId);
                    return DeviceConfigResult.success("NTPé…ç½®æˆåŠŸ");
                } else {
                    return DeviceConfigResult.failed("NTPæœåŠ¡å™¨è¿æ¥å¤±è´¥");
                }
            } else {
                return DeviceConfigResult.failed("NTPé…ç½®å¤±è´¥: " + result.getMessage());
            }

        } catch (Exception e) {
            log.error("é…ç½®è®¾å¤‡NTPæœåŠ¡å™¨å¤±è´¥, deviceId: {}", deviceId, e);
            return DeviceConfigResult.failed("é…ç½®å¼‚å¸¸: " + e.getMessage());
        }
    }
}
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è®¾å¤‡ç®¡ç†ç›¸å…³è¡¨ç»“æ„

```sql
-- è®¾å¤‡ä¿¡æ¯è¡¨
CREATE TABLE `t_access_device` (
    `device_id` BIGINT AUTO_INCREMENT COMMENT 'è®¾å¤‡ID',
    `device_sn` VARCHAR(64) NOT NULL COMMENT 'è®¾å¤‡åºåˆ—å·',
    `device_name` VARCHAR(100) NOT NULL COMMENT 'è®¾å¤‡åç§°',
    `device_model` VARCHAR(50) COMMENT 'è®¾å¤‡å‹å·',
    `firmware_version` VARCHAR(50) COMMENT 'å›ºä»¶ç‰ˆæœ¬',
    `ip_address` VARCHAR(45) COMMENT 'IPåœ°å€',
    `port` INT DEFAULT 48899 COMMENT 'ç«¯å£å·',
    `mac_address` VARCHAR(17) COMMENT 'MACåœ°å€',
    `connection_type` TINYINT DEFAULT 1 COMMENT 'è¿æ¥ç±»å‹(1:Pull 2:Push)',
    `device_status` TINYINT DEFAULT 1 COMMENT 'è®¾å¤‡çŠ¶æ€(1:åœ¨çº¿ 2:ç¦»çº¿ 3:æ•…éšœ)',
    `enabled_flag` TINYINT DEFAULT 1 COMMENT 'å¯ç”¨æ ‡å¿—(0:ç¦ç”¨ 1:å¯ç”¨)',
    `area_id` BIGINT COMMENT 'å…³è”åŒºåŸŸID',
    `manufacturer` VARCHAR(50) COMMENT 'å‚å•†',
    `install_location` VARCHAR(200) COMMENT 'å®‰è£…ä½ç½®',
    `last_online_time` DATETIME COMMENT 'æœ€ååœ¨çº¿æ—¶é—´',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `create_user_id` BIGINT COMMENT 'åˆ›å»ºç”¨æˆ·ID',
    `deleted_flag` TINYINT DEFAULT 0 COMMENT 'åˆ é™¤æ ‡å¿—(0:æ­£å¸¸ 1:åˆ é™¤)',
    PRIMARY KEY (`device_id`),
    UNIQUE KEY `uk_device_sn` (`device_sn`),
    KEY `idx_ip_address` (`ip_address`),
    KEY `idx_area_id` (`area_id`),
    KEY `idx_device_status` (`device_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é—¨ç¦è®¾å¤‡ä¿¡æ¯è¡¨';

-- è®¾å¤‡åŒºåŸŸå…³è”è¡¨
CREATE TABLE `t_access_device_area` (
    `id` BIGINT AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    `device_id` BIGINT NOT NULL COMMENT 'è®¾å¤‡ID',
    `area_id` BIGINT NOT NULL COMMENT 'åŒºåŸŸID',
    `association_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å…³è”æ—¶é—´',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_device_id` (`device_id`),
    KEY `idx_area_id` (`area_id`),
    CONSTRAINT `fk_device_area_device` FOREIGN KEY (`device_id`) REFERENCES `t_access_device` (`device_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡åŒºåŸŸå…³è”è¡¨';

-- è®¾å¤‡å‚æ•°é…ç½®è¡¨
CREATE TABLE `t_access_device_parameter` (
    `parameter_id` BIGINT AUTO_INCREMENT COMMENT 'å‚æ•°ID',
    `device_id` BIGINT NOT NULL COMMENT 'è®¾å¤‡ID',
    `parameter_type` VARCHAR(50) NOT NULL COMMENT 'å‚æ•°ç±»å‹',
    `parameter_name` VARCHAR(100) COMMENT 'å‚æ•°åç§°',
    `parameter_value` TEXT COMMENT 'å‚æ•°å€¼(JSONæ ¼å¼)',
    `effective_time` DATETIME COMMENT 'ç”Ÿæ•ˆæ—¶é—´',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`parameter_id`),
    KEY `idx_device_id` (`device_id`),
    KEY `idx_parameter_type` (`parameter_type`),
    CONSTRAINT `fk_parameter_device` FOREIGN KEY (`device_id`) REFERENCES `t_access_device` (`device_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡å‚æ•°é…ç½®è¡¨';

-- è®¾å¤‡è¿æ¥è®°å½•è¡¨
CREATE TABLE `t_access_device_connection` (
    `connection_id` BIGINT AUTO_INCREMENT COMMENT 'è¿æ¥ID',
    `device_id` BIGINT NOT NULL COMMENT 'è®¾å¤‡ID',
    `connection_type` TINYINT NOT NULL COMMENT 'è¿æ¥ç±»å‹(1:Pull 2:Push)',
    `client_ip` VARCHAR(45) COMMENT 'å®¢æˆ·ç«¯IP',
    `connect_time` DATETIME NOT NULL COMMENT 'è¿æ¥æ—¶é—´',
    `disconnect_time` DATETIME COMMENT 'æ–­å¼€æ—¶é—´',
    `connection_status` TINYINT NOT NULL COMMENT 'è¿æ¥çŠ¶æ€(1:è¿æ¥ä¸­ 2:å·²æ–­å¼€)',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    PRIMARY KEY (`connection_id`),
    KEY `idx_device_id` (`device_id`),
    KEY `idx_connect_time` (`connect_time`),
    CONSTRAINT `fk_connection_device` FOREIGN KEY (`device_id`) REFERENCES `t_access_device` (`device_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡è¿æ¥è®°å½•è¡¨';

-- è®¾å¤‡æ“ä½œæ—¥å¿—è¡¨
CREATE TABLE `t_access_device_operation_log` (
    `log_id` BIGINT AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
    `device_id` BIGINT COMMENT 'è®¾å¤‡ID',
    `operation_type` VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    `operation_content` TEXT COMMENT 'æ“ä½œå†…å®¹',
    `operation_result` TINYINT COMMENT 'æ“ä½œç»“æœ(1:æˆåŠŸ 2:å¤±è´¥)',
    `error_message` TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    `execute_user_id` BIGINT COMMENT 'æ‰§è¡Œç”¨æˆ·ID',
    `execute_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æ‰§è¡Œæ—¶é—´',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    PRIMARY KEY (`log_id`),
    KEY `idx_device_id` (`device_id`),
    KEY `idx_operation_type` (`operation_type`),
    KEY `idx_execute_time` (`execute_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡æ“ä½œæ—¥å¿—è¡¨';
```

## ğŸ”” äº‹ä»¶å¤„ç†æœºåˆ¶

### è®¾å¤‡äº‹ä»¶ç›‘å¬

```java
@Component
@Slf4j
public class DeviceEventHandler {

    @Resource
    private DeviceStatusService deviceStatusService;

    @Resource
    private RealTimeMonitoringService monitoringService;

    @Resource
    private NotificationService notificationService;

    /**
     * å¤„ç†è®¾å¤‡è¿æ¥äº‹ä»¶
     */
    @EventListener
    @Async
    public void handleDeviceConnectedEvent(DeviceConnectedEvent event) {
        try {
            // 1. æ›´æ–°è®¾å¤‡çŠ¶æ€ä¸ºåœ¨çº¿
            deviceStatusService.updateDeviceStatus(event.getDeviceId(),
                    DeviceStatus.ONLINE);

            // 2. æ¨é€åˆ°å®æ—¶ç›‘æ§
            monitoringService.pushDeviceStatusChange(event);

            // 3. å‘é€è¿æ¥æˆåŠŸé€šçŸ¥
            notificationService.sendDeviceConnectedNotification(event);

            log.info("è®¾å¤‡è¿æ¥äº‹ä»¶å¤„ç†å®Œæˆ, deviceId: {}", event.getDeviceId());

        } catch (Exception e) {
            log.error("è®¾å¤‡è¿æ¥äº‹ä»¶å¤„ç†å¤±è´¥", e);
        }
    }

    /**
     * å¤„ç†è®¾å¤‡æ–­å¼€äº‹ä»¶
     */
    @EventListener
    @Async
    public void handleDeviceDisconnectedEvent(DeviceDisconnectedEvent event) {
        try {
            // 1. æ›´æ–°è®¾å¤‡çŠ¶æ€ä¸ºç¦»çº¿
            deviceStatusService.updateDeviceStatus(event.getDeviceId(),
                    DeviceStatus.OFFLINE);

            // 2. æ¨é€åˆ°å®æ—¶ç›‘æ§
            monitoringService.pushDeviceStatusChange(event);

            // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€å‘Šè­¦
            if (shouldSendDisconnectAlert(event)) {
                notificationService.sendDeviceDisconnectAlert(event);
            }

            log.info("è®¾å¤‡æ–­å¼€äº‹ä»¶å¤„ç†å®Œæˆ, deviceId: {}", event.getDeviceId());

        } catch (Exception e) {
            log.error("è®¾å¤‡æ–­å¼€äº‹ä»¶å¤„ç†å¤±è´¥", e);
        }
    }

    /**
     * å¤„ç†è®¾å¤‡æ•…éšœäº‹ä»¶
     */
    @EventListener
    @Async
    public void handleDeviceFaultEvent(DeviceFaultEvent event) {
        try {
            // 1. æ›´æ–°è®¾å¤‡çŠ¶æ€ä¸ºæ•…éšœ
            deviceStatusService.updateDeviceStatus(event.getDeviceId(),
                    DeviceStatus.FAULT);

            // 2. æ¨é€åˆ°å®æ—¶ç›‘æ§
            monitoringService.pushDeviceFaultEvent(event);

            // 3. å‘é€æ•…éšœå‘Šè­¦
            notificationService.sendDeviceFaultAlert(event);

            // 4. åˆ›å»ºæ•…éšœå¤„ç†å·¥å•
            maintenanceTicketService.createFaultTicket(event);

            log.info("è®¾å¤‡æ•…éšœäº‹ä»¶å¤„ç†å®Œæˆ, deviceId: {}", event.getDeviceId());

        } catch (Exception e) {
            log.error("è®¾å¤‡æ•…éšœäº‹ä»¶å¤„ç†å¤±è´¥", e);
        }
    }
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯å®ç°æ–‡æ¡£
- [é—¨ç¦ç®¡ç†ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡](./ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡.md) - å®Œæ•´çš„ç³»ç»Ÿæ¶æ„è®¾è®¡
- [é—¨ç¦ç³»ç»Ÿæ¶æ„æµç¨‹å›¾](./ç³»ç»Ÿæ¶æ„æµç¨‹å›¾.md) - ç³»ç»Ÿæµç¨‹å’Œæ¨¡å—äº¤äº’è®¾è®¡
- [è®¾å¤‡é€šä¿¡åè®®è®¾è®¡](./è®¾å¤‡é€šä¿¡åè®®è®¾è®¡.md) - è®¾å¤‡é€šä¿¡åè®®å’Œæ¥å£è§„èŒƒ

### ä¸šåŠ¡åŠŸèƒ½æ–‡æ¡£
- [å®æ—¶ç›‘æ§æ¨¡å—è¯¦ç»†è®¾è®¡](./å®æ—¶ç›‘æ§æ¨¡å—è¯¦ç»†è®¾è®¡.md) - å®æ—¶ç›‘æ§åŠŸèƒ½è®¾è®¡
- [æƒé™ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡](./æƒé™ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡.md) - æƒé™ç®¡ç†åŠŸèƒ½å®ç°
- [ç³»ç»Ÿé…ç½®æ¨¡å—è¯¦ç»†è®¾è®¡](./ç³»ç»Ÿé…ç½®æ¨¡å—è¯¦ç»†è®¾è®¡.md) - ç³»ç»Ÿé…ç½®åŠŸèƒ½è®¾è®¡

### é›†æˆéƒ¨ç½²æ–‡æ¡£
- [é—¨ç¦ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ](./é›†æˆæ–¹æ¡ˆ.md) - ç³»ç»Ÿé›†æˆå’Œéƒ¨ç½²æ–¹æ¡ˆ
- [è®¾å¤‡éƒ¨ç½²æŒ‡å—](./è®¾å¤‡éƒ¨ç½²æŒ‡å—.md) - è®¾å¤‡éƒ¨ç½²å’Œé…ç½®æŒ‡å—
- [è¿ç»´ç›‘æ§æ–¹æ¡ˆ](./è¿ç»´ç›‘æ§æ–¹æ¡ˆ.md) - ç³»ç»Ÿè¿ç»´å’Œç›‘æ§æ–¹æ¡ˆ

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™æ€»ç»“

1. **è®¾å¤‡å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†** - ä»è®¾å¤‡æ¥å…¥åˆ°ç»´æŠ¤æŠ¥åºŸçš„å®Œæ•´ç®¡ç†
2. **å¤šæ¨¡å¼æ¥å…¥æ”¯æŒ** - Pull/PushåŒæ¨¡å¼æ»¡è¶³ä¸åŒç½‘ç»œç¯å¢ƒéœ€æ±‚
3. **è‡ªåŠ¨å‘ç°å’Œé…ç½®** - æ™ºèƒ½è®¾å¤‡å‘ç°å’Œè‡ªåŠ¨åŒæ­¥æœºåˆ¶
4. **è¿œç¨‹æ§åˆ¶å’Œç»´æŠ¤** - å®Œå–„çš„è¿œç¨‹è®¾å¤‡æ§åˆ¶å’Œè¿ç»´èƒ½åŠ›
5. **é«˜å¯ç”¨æ€§è®¾è®¡** - è¿æ¥æ± ç®¡ç†å’Œæ•…éšœæ¢å¤æœºåˆ¶

## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯

- æœ¬æ–‡æ¡£åŸºäºZKBioSecurity-ACC 3.14.xæ¶æ„è®¾è®¡
- è®¾å¤‡ç®¡ç†æ¨¡å—è®¾è®¡è´Ÿè´£äººï¼šSmartAdminè§„èŒƒæ²»ç†å§”å‘˜ä¼š
- åˆ›å»ºæ—¥æœŸï¼š2025-11-13
- ä¸‹æ¬¡è¯„å®¡ï¼š2026-02-13

---

**ğŸ¯ IOE-DREAMé—¨ç¦è®¾å¤‡ç®¡ç†æ¨¡å— - æ™ºèƒ½æ¥å…¥ã€è‡ªåŠ¨å‘ç°ã€è¿œç¨‹æ§åˆ¶çš„ä¼ä¸šçº§è®¾å¤‡ç®¡ç†è§£å†³æ–¹æ¡ˆ**