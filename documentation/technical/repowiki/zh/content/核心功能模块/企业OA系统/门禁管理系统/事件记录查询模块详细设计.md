# é—¨ç¦äº‹ä»¶è®°å½•æŸ¥è¯¢æ¨¡å—è¯¦ç»†è®¾è®¡

> **ç‰ˆæœ¬**: v1.0
> **æ›´æ–°æ—¶é—´**: 2025-11-13
> **åˆ†ç±»**: æ ¸å¿ƒåŠŸèƒ½æ¨¡å— > ä¼ä¸šOAç³»ç»Ÿ > é—¨ç¦ç®¡ç†ç³»ç»Ÿ
> **æ ‡ç­¾**: ["é—¨ç¦ç³»ç»Ÿ", "äº‹ä»¶æŸ¥è¯¢", "æ•°æ®ç»Ÿè®¡åˆ†æ", "æŠ¥è¡¨ç”Ÿæˆ", "åª’ä½“é¢„è§ˆ"]
> **ä½œè€…**: SmartAdminè§„èŒƒæ²»ç†å§”å‘˜ä¼š
> **æè¿°**: IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°é—¨ç¦ç®¡ç†ç³»ç»Ÿçš„äº‹ä»¶è®°å½•æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æã€åª’ä½“é¢„è§ˆå’Œæ•°æ®å¯¼å‡ºæ¨¡å—è¯¦ç»†æŠ€æœ¯è®¾è®¡

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### æ ¸å¿ƒå®šä½

**é—¨ç¦äº‹ä»¶è®°å½•æŸ¥è¯¢æ¨¡å—**æ˜¯IOE-DREAMæ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°çš„æ•°æ®ä¸­å¿ƒï¼Œä¸“æ³¨äºé—¨ç¦æ ¸å¿ƒä¸šåŠ¡äº‹ä»¶çš„è®°å½•ã€æŸ¥è¯¢ã€ç»Ÿè®¡å’Œåˆ†æã€‚æ¨¡å—æä¾›é—¨ç¦æ‰“å¡äº‹ä»¶æŸ¥è¯¢ã€æŠ¥è­¦å¼‚å¸¸äº‹ä»¶å¤„ç†ã€ç»¼åˆç»Ÿè®¡åˆ†ææŠ¥è¡¨ã€åª’ä½“æ–‡ä»¶é¢„è§ˆå’Œå®Œæ•´çš„æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼Œç¡®ä¿é—¨ç¦äº‹ä»¶æ•°æ®çš„å‡†ç¡®æ€§ã€å®æ—¶æ€§å’Œå¯è¿½æº¯æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **é—¨ç¦äº‹ä»¶ä¸“å±ä¸­å¿ƒ**ï¼šä¸“æ³¨å¤„ç†é—¨ç¦ç›¸å…³çš„é€šè¡Œå’ŒæŠ¥è­¦äº‹ä»¶
- âœ… **å¤šç»´åº¦æŸ¥è¯¢ç­›é€‰**ï¼šéªŒè¯æ–¹å¼ã€é€šè¡Œç»“æœã€äººå‘˜ä¿¡æ¯ã€è®¾å¤‡ä½ç½®ç­‰å¤šç»´åº¦ç­›é€‰
- âœ… **åª’ä½“æ–‡ä»¶é¢„è§ˆ**ï¼šé€šè¡Œç…§ç‰‡ã€ç›‘æ§è§†é¢‘åœ¨çº¿é¢„è§ˆå’Œç®¡ç†
- âœ… **æ™ºèƒ½ç»Ÿè®¡åˆ†æ**ï¼šæ—¶é—´ã€åŒºåŸŸã€äººå‘˜ã€è®¾å¤‡ç­‰å¤šç»´åº¦ç»Ÿè®¡åˆ†æ
- âœ… **å¤šæ ¼å¼æ•°æ®å¯¼å‡º**ï¼šExcelã€PDFã€CSVæ ¼å¼å¯¼å‡ºå’Œè‡ªå®šä¹‰æŠ¥è¡¨
- âœ… **æƒé™åˆ†çº§æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„æ•°æ®è®¿é—®å’Œæ“ä½œæƒé™æ§åˆ¶
- âœ… **é«˜æ€§èƒ½æŸ¥è¯¢**ï¼šæ”¯æŒæµ·é‡äº‹ä»¶æ•°æ®çš„é«˜æ•ˆæŸ¥è¯¢å’Œåˆ†é¡µæ˜¾ç¤º

## ğŸ—ï¸ äº‹ä»¶è®°å½•æŸ¥è¯¢æ¨¡å—æ¶æ„è®¾è®¡

### æ¨¡å—åŠŸèƒ½æ¶æ„å›¾

```mermaid
graph TB
    subgraph "é—¨ç¦äº‹ä»¶è®°å½•æŸ¥è¯¢æ¨¡å—æ¶æ„"
        subgraph "ç”¨æˆ·äº¤äº’å±‚"
            AQ[äº‹ä»¶æŸ¥è¯¢ç•Œé¢]
            RQ[æŠ¥è¡¨ç•Œé¢]
            MP[åª’ä½“é¢„è§ˆç•Œé¢]
            DE[æ•°æ®å¯¼å‡ºç•Œé¢]
        end

        subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
            subgraph "æ ¸å¿ƒæŸ¥è¯¢æœåŠ¡"
                AQS[é—¨ç¦äº‹ä»¶æŸ¥è¯¢æœåŠ¡]
                AQS_ALM[æŠ¥è­¦äº‹ä»¶æŸ¥è¯¢æœåŠ¡]
                SS[ç»Ÿè®¡åˆ†ææœåŠ¡]
            end

            subgraph "æ•°æ®å¤„ç†å¼•æ“"
                FQE[å…¨æ–‡æŸ¥è¯¢å¼•æ“]
                ASE[èšåˆç»Ÿè®¡å¼•æ“]
                DRE[æ•°æ®å¯¼å‡ºå¼•æ“]
                MPE[åª’ä½“å¤„ç†å¼•æ“]
            end
        end

        subgraph "æ•°æ®è®¿é—®å±‚"
            AED[é—¨ç¦äº‹ä»¶æ•°æ®è®¿é—®]
            ALD[æŠ¥è­¦äº‹ä»¶æ•°æ®è®¿é—®]
            MD[åª’ä½“æ–‡ä»¶æ•°æ®è®¿é—®]
            SD[ç»Ÿè®¡æ•°æ®è®¿é—®]
        end

        subgraph "æ•°æ®å­˜å‚¨å±‚"
            EVENT_DB[é—¨ç¦äº‹ä»¶æ•°æ®åº“]
            MEDIA_STORE[åª’ä½“æ–‡ä»¶å­˜å‚¨]
            CACHE_LAYER[Redisç¼“å­˜å±‚]
            INDEX_STORE[æœç´¢å¼•æ“ç´¢å¼•]
        end

        subgraph "å¤–éƒ¨é›†æˆå±‚"
            DEVICE_SYS[é—¨ç¦è®¾å¤‡ç³»ç»Ÿ]
            VIDEO_SYS[è§†é¢‘ç›‘æ§ç³»ç»Ÿ]
            ALARM_SYS[æŠ¥è­¦ç³»ç»Ÿ]
            PERSON_SYS[äººå‘˜ç®¡ç†ç³»ç»Ÿ]
        end
    end

    AQ --> AQS
    RQ --> SS
    MP --> MPE
    DE --> DRE

    AQS --> FQE
    AQS_ALM --> ASE
    SS --> ASE
    MPE --> MPE

    FQE --> EVENT_DB
    ASE --> INDEX_STORE
    DRE --> CACHE_LAYER
    MPE --> MEDIA_STORE

    AQS --> DEVICE_SYS
    AQS_ALM --> ALARM_SYS
    MPE --> VIDEO_SYS
    SS --> PERSON_SYS
```

### äº‹ä»¶è®°å½•æŸ¥è¯¢æ ¸å¿ƒæµç¨‹è®¾è®¡

```mermaid
graph TB
    EventStart(é—¨ç¦äº‹ä»¶æŸ¥è¯¢å¼€å§‹) --> EventType{é€‰æ‹©äº‹ä»¶ç±»å‹}

    EventType -->|é—¨ç¦æ‰“å¡äº‹ä»¶| AccessEvent
    EventType -->|æŠ¥è­¦å¼‚å¸¸äº‹ä»¶| AlarmEvent
    EventType -->|ç»¼åˆç»Ÿè®¡åˆ†ææŠ¥è¡¨| StatReport

    subgraph é—¨ç¦æ‰“å¡äº‹ä»¶æŸ¥è¯¢æµç¨‹
        AccessEvent --> AccessFilter[é—¨ç¦äº‹ä»¶ç­›é€‰]
        AccessFilter --> AccessQuery{æŸ¥è¯¢æ¡ä»¶}
        AccessQuery -->|éªŒè¯æ–¹å¼| VerifyTypeFilter[éªŒè¯æ–¹å¼ç­›é€‰]
        AccessQuery -->|é€šè¡Œç»“æœ| AccessResultFilter[é€šè¡Œç»“æœç­›é€‰]
        AccessQuery -->|äººå‘˜ä¿¡æ¯| PersonFilter[äººå‘˜ä¿¡æ¯ç­›é€‰]
        AccessQuery -->|è®¾å¤‡ä½ç½®| DeviceLocationFilter[è®¾å¤‡ä½ç½®ç­›é€‰]
        AccessQuery -->|æ—¶é—´èŒƒå›´| AccessTimeFilter[æ—¶é—´èŒƒå›´ç­›é€‰]
        VerifyTypeFilter --> AccessEventResult[é—¨ç¦äº‹ä»¶ç»“æœ]
        AccessResultFilter --> AccessEventResult
        PersonFilter --> AccessEventResult
        DeviceLocationFilter --> AccessEventResult
        AccessTimeFilter --> AccessEventResult
        AccessEventResult --> AccessOperation{æ“ä½œç±»å‹}
        AccessOperation -->|è¯¦æƒ…æŸ¥çœ‹| AccessDetail[é—¨ç¦äº‹ä»¶è¯¦æƒ…]
        AccessOperation -->|ç…§ç‰‡é¢„è§ˆ| AccessPhotoPreview[é€šè¡Œç…§ç‰‡é¢„è§ˆ]
        AccessOperation -->|è§†é¢‘é¢„è§ˆ| AccessVideoPreview[ç›‘æ§è§†é¢‘é¢„è§ˆ]
        AccessOperation -->|å¯¼å‡º| AccessExport[å¯¼å‡ºé—¨ç¦äº‹ä»¶]
        AccessOperation -->|æ‰“å°| AccessPrint[æ‰“å°é—¨ç¦æŠ¥è¡¨]
        AccessDetail --> EventEnd[äº‹ä»¶æ“ä½œå®Œæˆ]
        AccessPhotoPreview --> EventEnd
        AccessVideoPreview --> EventEnd
        AccessExport --> EventEnd
        AccessPrint --> EventEnd
    end

    subgraph æŠ¥è­¦å¼‚å¸¸äº‹ä»¶æŸ¥è¯¢æµç¨‹
        AlarmEvent --> AlarmFilter[æŠ¥è­¦äº‹ä»¶ç­›é€‰]
        AlarmFilter --> AlarmQuery{æŸ¥è¯¢æ¡ä»¶}
        AlarmQuery -->|æŠ¥è­¦ç±»å‹| AlarmTypeFilter[æŠ¥è­¦ç±»å‹ç­›é€‰]
        AlarmQuery -->|ä¸¥é‡ç¨‹åº¦| SeverityFilter[ä¸¥é‡ç¨‹åº¦ç­›é€‰]
        AlarmQuery -->|å¤„ç†çŠ¶æ€| StatusFilter[å¤„ç†çŠ¶æ€ç­›é€‰]
        AlarmQuery -->|è®¾å¤‡åŒºåŸŸ| AlarmDeviceFilter[è®¾å¤‡åŒºåŸŸç­›é€‰]
        AlarmQuery -->|æ—¶é—´èŒƒå›´| AlarmTimeFilter[æ—¶é—´èŒƒå›´ç­›é€‰]
        AlarmTypeFilter --> AlarmEventResult[æŠ¥è­¦äº‹ä»¶ç»“æœ]
        SeverityFilter --> AlarmEventResult
        StatusFilter --> AlarmEventResult
        AlarmDeviceFilter --> AlarmEventResult
        AlarmTimeFilter --> AlarmEventResult
        AlarmEventResult --> AlarmOperation{æ“ä½œç±»å‹}
        AlarmOperation -->|è¯¦æƒ…æŸ¥çœ‹| AlarmDetail[æŠ¥è­¦äº‹ä»¶è¯¦æƒ…]
        AlarmOperation -->|ç°åœºç…§ç‰‡| AlarmPhotoPreview[ç°åœºç…§ç‰‡é¢„è§ˆ]
        AlarmOperation -->|å¤„ç†è®°å½•| AlarmHandleRecord[å¤„ç†è®°å½•æŸ¥çœ‹]
        AlarmOperation -->|å¯¼å‡º| AlarmExport[å¯¼å‡ºæŠ¥è­¦äº‹ä»¶]
        AlarmOperation -->|æ‰“å°| AlarmPrint[æ‰“å°æŠ¥è­¦æŠ¥è¡¨]
        AlarmDetail --> EventEnd
        AlarmPhotoPreview --> EventEnd
        AlarmHandleRecord --> EventEnd
        AlarmExport --> EventEnd
        AlarmPrint --> EventEnd
    end

    subgraph ç»¼åˆç»Ÿè®¡åˆ†ææŠ¥è¡¨æµç¨‹
        StatReport --> StatConfig[ç»Ÿè®¡é…ç½®]
        StatConfig --> StatDimension{ç»Ÿè®¡ç»´åº¦}
        StatDimension -->|æ—¶é—´ç»´åº¦| TimeDim[æ—¶é—´ç»´åº¦ç»Ÿè®¡]
        StatDimension -->|åŒºåŸŸç»´åº¦| AreaDim[åŒºåŸŸç»´åº¦ç»Ÿè®¡]
        StatDimension -->|äººå‘˜ç»´åº¦| PersonDim[äººå‘˜ç»´åº¦ç»Ÿè®¡]
        StatDimension -->|è®¾å¤‡ç»´åº¦| DeviceDim[è®¾å¤‡ç»´åº¦ç»Ÿè®¡]
        StatDimension -->|äº‹ä»¶ç±»å‹| EventTypeDim[äº‹ä»¶ç±»å‹ç»Ÿè®¡]
        TimeDim --> StatCalculate[æ•°æ®ç»Ÿè®¡è®¡ç®—]
        AreaDim --> StatCalculate
        PersonDim --> StatCalculate
        DeviceDim --> StatCalculate
        EventTypeDim --> StatCalculate
        StatCalculate --> ChartGenerate[å›¾è¡¨ç”Ÿæˆ]
        ChartGenerate --> StatOperation{ç»Ÿè®¡æ“ä½œ}
        StatOperation -->|å›¾è¡¨é¢„è§ˆ| ChartPreview[ç»Ÿè®¡å›¾è¡¨é¢„è§ˆ]
        StatOperation -->|æ•°æ®å¯¼å‡º| StatExport[ç»Ÿè®¡æ•°æ®å¯¼å‡º]
        StatOperation -->|æŠ¥è¡¨æ‰“å°| StatPrint[ç»Ÿè®¡æŠ¥è¡¨æ‰“å°]
        ChartPreview --> ReportEnd
        StatExport --> ReportEnd
        StatPrint --> ReportEnd
    end
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½è¯¦ç»†è®¾è®¡

### 1. é—¨ç¦äº‹ä»¶æŸ¥è¯¢æœåŠ¡

#### 1.1 é—¨ç¦æ‰“å¡äº‹ä»¶æŸ¥è¯¢

**åŠŸèƒ½æè¿°**ï¼šé—¨ç¦æ‰“å¡äº‹ä»¶çš„å¤šç»´åº¦æŸ¥è¯¢å’Œç­›é€‰

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class AccessEventQueryService {

    @Resource
    private AccessEventDao accessEventDao;

    @Resource
    private FullTextSearchService searchService;

    @Resource
    private CacheManager cacheManager;

    /**
     * æŸ¥è¯¢é—¨ç¦æ‰“å¡äº‹ä»¶
     */
    public ResponseDTO<PageResult<AccessEventVO>> queryAccessEvents(AccessEventQueryForm queryForm) {
        try {
            // 1. æƒé™éªŒè¯
            validateQueryPermission(queryForm);

            // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶
            LambdaQueryWrapper<AccessEventEntity> queryWrapper = buildAccessEventQuery(queryForm);

            // 3. åˆ†é¡µæŸ¥è¯¢
            IPage<AccessEventEntity> page = new Page<>(queryForm.getPageNum(), queryForm.getPageSize());
            IPage<AccessEventEntity> eventPage = accessEventDao.selectPage(page, queryWrapper);

            // 4. è½¬æ¢ä¸ºVOå¹¶è¡¥å……å…³è”æ•°æ®
            List<AccessEventVO> eventVOList = eventPage.getRecords().stream()
                    .map(this::convertToAccessEventVO)
                    .collect(Collectors.toList());

            // 5. æ„å»ºåˆ†é¡µç»“æœ
            PageResult<AccessEventVO> pageResult = new PageResult<>();
            pageResult.setRows(eventVOList);
            pageResult.setTotal(eventPage.getTotal());
            pageResult.setPageNum(queryForm.getPageNum());
            pageResult.setPageSize(queryForm.getPageSize());

            // 6. è®°å½•æŸ¥è¯¢æ—¥å¿—
            logQueryOperation("ACCESS_EVENT_QUERY", queryForm, pageResult.getTotal());

            return ResponseDTO.ok(pageResult);

        } catch (Exception e) {
            log.error("æŸ¥è¯¢é—¨ç¦æ‰“å¡äº‹ä»¶å¤±è´¥", e);
            return ResponseDTO.error("æŸ¥è¯¢å¤±è´¥");
        }
    }

    /**
     * æ„å»ºé—¨ç¦äº‹ä»¶æŸ¥è¯¢æ¡ä»¶
     */
    private LambdaQueryWrapper<AccessEventEntity> buildAccessEventQuery(AccessEventQueryForm queryForm) {
        LambdaQueryWrapper<AccessEventEntity> queryWrapper = new LambdaQueryWrapper<>();

        // 1. åŸºç¡€æ¡ä»¶
        queryWrapper.eq(AccessEventEntity::getDeletedFlag, false)
                .orderByDesc(AccessEventEntity::getEventTime);

        // 2. éªŒè¯æ–¹å¼ç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getVerificationMethods())) {
            queryWrapper.in(AccessEventEntity::getVerificationMethod, queryForm.getVerificationMethods());
        }

        // 3. é€šè¡Œç»“æœç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getAccessResults())) {
            queryWrapper.in(AccessEventEntity::getAccessResult, queryForm.getAccessResults());
        }

        // 4. äººå‘˜ä¿¡æ¯ç­›é€‰
        if (StringUtils.isNotBlank(queryForm.getPersonKeyword())) {
            queryWrapper.and(wrapper -> wrapper
                    .like(AccessEventEntity::getPersonName, queryForm.getPersonKeyword())
                    .or()
                    .like(AccessEventEntity::getPersonCode, queryForm.getPersonKeyword())
                    .or()
                    .like(AccessEventEntity::getDepartmentName, queryForm.getPersonKeyword()));
        }

        // 5. è®¾å¤‡ä½ç½®ç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getAreaIds())) {
            queryWrapper.in(AccessEventEntity::getAreaId, queryForm.getAreaIds());
        }
        if (CollectionUtils.isNotEmpty(queryForm.getDeviceIds())) {
            queryWrapper.in(AccessEventEntity::getDeviceId, queryForm.getDeviceIds());
        }

        // 6. æ—¶é—´èŒƒå›´ç­›é€‰
        if (queryForm.getStartTime() != null) {
            queryWrapper.ge(AccessEventEntity::getEventTime, queryForm.getStartTime());
        }
        if (queryForm.getEndTime() != null) {
            queryWrapper.le(AccessEventEntity::getEventTime, queryForm.getEndTime());
        }

        // 7. æ•°æ®æƒé™è¿‡æ»¤
        applyDataPermissionFilter(queryWrapper);

        return queryWrapper;
    }

    /**
     * è½¬æ¢ä¸ºé—¨ç¦äº‹ä»¶VO
     */
    private AccessEventVO convertToAccessEventVO(AccessEventEntity entity) {
        AccessEventVO vo = BeanUtil.copyProperties(entity, AccessEventVO.class);

        // 1. è¡¥å……äººå‘˜ä¿¡æ¯
        if (entity.getPersonId() != null) {
            PersonInfoVO personInfo = personService.getPersonInfo(entity.getPersonId());
            vo.setPersonInfo(personInfo);
        }

        // 2. è¡¥å……è®¾å¤‡ä¿¡æ¯
        if (entity.getDeviceId() != null) {
            DeviceInfoVO deviceInfo = deviceService.getDeviceInfo(entity.getDeviceId());
            vo.setDeviceInfo(deviceInfo);
        }

        // 3. è¡¥å……åŒºåŸŸä¿¡æ¯
        if (entity.getAreaId() != null) {
            AreaInfoVO areaInfo = areaService.getAreaInfo(entity.getAreaId());
            vo.setAreaInfo(areaInfo);
        }

        // 4. è¡¥å……åª’ä½“æ–‡ä»¶ä¿¡æ¯
        vo.setMediaFiles(getMediaFiles(entity.getEventId()));

        return vo;
    }

    /**
     * å…¨æ–‡æœç´¢é—¨ç¦äº‹ä»¶
     */
    public ResponseDTO<PageResult<AccessEventVO>> fullTextSearchAccessEvents(AccessEventSearchForm searchForm) {
        try {
            // 1. æ„å»ºæœç´¢æŸ¥è¯¢
            SearchQuery searchQuery = SearchQuery.builder()
                    .keyword(searchForm.getKeyword())
                    .filters(buildSearchFilters(searchForm))
                    .sort(buildSearchSort(searchForm))
                    .page(searchForm.getPageNum())
                    .size(searchForm.getPageSize())
                    .build();

            // 2. æ‰§è¡Œæœç´¢
            SearchResult<AccessEventEntity> searchResult = searchService.search(searchQuery, AccessEventEntity.class);

            // 3. è½¬æ¢ç»“æœ
            List<AccessEventVO> voList = searchResult.getDocuments().stream()
                    .map(this::convertToAccessEventVO)
                    .collect(Collectors.toList());

            PageResult<AccessEventVO> pageResult = new PageResult<>();
            pageResult.setRows(voList);
            pageResult.setTotal(searchResult.getTotal());
            pageResult.setPageNum(searchForm.getPageNum());
            pageResult.setPageSize(searchForm.getPageSize());

            return ResponseDTO.ok(pageResult);

        } catch (Exception e) {
            log.error("å…¨æ–‡æœç´¢é—¨ç¦äº‹ä»¶å¤±è´¥", e);
            return ResponseDTO.error("æœç´¢å¤±è´¥");
        }
    }
}
```

### 2. æŠ¥è­¦äº‹ä»¶æŸ¥è¯¢æœåŠ¡

#### 2.1 æŠ¥è­¦å¼‚å¸¸äº‹ä»¶æŸ¥è¯¢

**åŠŸèƒ½æè¿°**ï¼šæŠ¥è­¦å¼‚å¸¸äº‹ä»¶çš„æŸ¥è¯¢å’Œå¤„ç†çŠ¶æ€è·Ÿè¸ª

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class AlarmEventQueryService {

    @Resource
    private AlarmEventDao alarmEventDao;

    @Resource
    private AlarmProcessService alarmProcessService;

    @Resource
    private AlarmNotificationService notificationService;

    /**
     * æŸ¥è¯¢æŠ¥è­¦å¼‚å¸¸äº‹ä»¶
     */
    public ResponseDTO<PageResult<AlarmEventVO>> queryAlarmEvents(AlarmEventQueryForm queryForm) {
        try {
            // 1. æƒé™éªŒè¯
            validateAlarmQueryPermission(queryForm);

            // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶
            LambdaQueryWrapper<AlarmEventEntity> queryWrapper = buildAlarmEventQuery(queryForm);

            // 3. åˆ†é¡µæŸ¥è¯¢
            IPage<AlarmEventEntity> page = new Page<>(queryForm.getPageNum(), queryForm.getPageSize());
            IPage<AlarmEventEntity> eventPage = alarmEventDao.selectPage(page, queryWrapper);

            // 4. è½¬æ¢ä¸ºVOå¹¶è¡¥å……å…³è”æ•°æ®
            List<AlarmEventVO> eventVOList = eventPage.getRecords().stream()
                    .map(this::convertToAlarmEventVO)
                    .collect(Collectors.toList());

            // 5. æ„å»ºåˆ†é¡µç»“æœ
            PageResult<AlarmEventVO> pageResult = new PageResult<>();
            pageResult.setRows(eventVOList);
            pageResult.setTotal(eventPage.getTotal());
            pageResult.setPageNum(queryForm.getPageNum());
            pageResult.setPageSize(queryForm.getPageSize());

            // 6. è®°å½•æŸ¥è¯¢æ—¥å¿—
            logQueryOperation("ALARM_EVENT_QUERY", queryForm, pageResult.getTotal());

            return ResponseDTO.ok(pageResult);

        } catch (Exception e) {
            log.error("æŸ¥è¯¢æŠ¥è­¦å¼‚å¸¸äº‹ä»¶å¤±è´¥", e);
            return ResponseDTO.error("æŸ¥è¯¢å¤±è´¥");
        }
    }

    /**
     * æ„å»ºæŠ¥è­¦äº‹ä»¶æŸ¥è¯¢æ¡ä»¶
     */
    private LambdaQueryWrapper<AlarmEventEntity> buildAlarmEventQuery(AlarmEventQueryForm queryForm) {
        LambdaQueryWrapper<AlarmEventEntity> queryWrapper = new LambdaQueryWrapper<>();

        // 1. åŸºç¡€æ¡ä»¶
        queryWrapper.eq(AlarmEventEntity::getDeletedFlag, false)
                .orderByDesc(AlarmEventEntity::getAlarmTime);

        // 2. æŠ¥è­¦ç±»å‹ç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getAlarmTypes())) {
            queryWrapper.in(AlarmEventEntity::getAlarmType, queryForm.getAlarmTypes());
        }

        // 3. ä¸¥é‡ç¨‹åº¦ç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getSeverityLevels())) {
            queryWrapper.in(AlarmEventEntity::getSeverityLevel, queryForm.getSeverityLevels());
        }

        // 4. å¤„ç†çŠ¶æ€ç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getProcessStatuses())) {
            queryWrapper.in(AlarmEventEntity::getProcessStatus, queryForm.getProcessStatuses());
        }

        // 5. è®¾å¤‡åŒºåŸŸç­›é€‰
        if (CollectionUtils.isNotEmpty(queryForm.getAreaIds())) {
            queryWrapper.in(AlarmEventEntity::getAreaId, queryForm.getAreaIds());
        }
        if (CollectionUtils.isNotEmpty(queryForm.getDeviceIds())) {
            queryWrapper.in(AlarmEventEntity::getDeviceId, queryForm.getDeviceIds());
        }

        // 6. æ—¶é—´èŒƒå›´ç­›é€‰
        if (queryForm.getStartTime() != null) {
            queryWrapper.ge(AlarmEventEntity::getAlarmTime, queryForm.getStartTime());
        }
        if (queryForm.getEndTime() != null) {
            queryWrapper.le(AlarmEventEntity::getAlarmTime, queryForm.getEndTime());
        }

        // 7. æ•°æ®æƒé™è¿‡æ»¤
        applyAlarmDataPermissionFilter(queryWrapper);

        return queryWrapper;
    }

    /**
     * å¤„ç†æŠ¥è­¦äº‹ä»¶
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<Void> processAlarmEvent(AlarmProcessForm processForm) {
        try {
            Long alarmId = processForm.getAlarmId();

            // 1. éªŒè¯æŠ¥è­¦äº‹ä»¶å­˜åœ¨
            AlarmEventEntity alarm = alarmEventDao.selectById(alarmId);
            if (alarm == null || alarm.getDeletedFlag()) {
                return ResponseDTO.error("æŠ¥è­¦äº‹ä»¶ä¸å­˜åœ¨");
            }

            // 2. éªŒè¯å¤„ç†æƒé™
            validateProcessPermission(alarm);

            // 3. æ›´æ–°å¤„ç†çŠ¶æ€
            AlarmProcessRecord processRecord = AlarmProcessRecord.builder()
                    .alarmId(alarmId)
                    .processUserId(SmartRequestUtil.getRequestUserId())
                    .processType(processForm.getProcessType())
                    .processResult(processForm.getProcessResult())
                    .processDescription(processForm.getProcessDescription())
                    .processTime(LocalDateTime.now())
                    .build();

            alarmProcessService.saveProcessRecord(processRecord);

            // 4. æ›´æ–°æŠ¥è­¦äº‹ä»¶çŠ¶æ€
            alarm.setProcessStatus(processForm.getProcessStatus());
            alarm.setProcessUserId(processForm.getProcessUserId());
            alarm.setProcessTime(LocalDateTime.now());
            alarmEventDao.updateById(alarm);

            // 5. å‘é€å¤„ç†å®Œæˆé€šçŸ¥
            if (processForm.getProcessStatus() == ProcessStatus.COMPLETED) {
                notificationService.sendProcessCompleteNotification(alarm, processRecord);
            }

            log.info("æŠ¥è­¦äº‹ä»¶å¤„ç†å®Œæˆ, alarmId: {}, processType: {}",
                    alarmId, processForm.getProcessType());

            return ResponseDTO.ok();

        } catch (Exception e) {
            log.error("å¤„ç†æŠ¥è­¦äº‹ä»¶å¤±è´¥", e);
            return ResponseDTO.error("å¤„ç†å¤±è´¥");
        }
    }

    /**
     * è½¬æ¢ä¸ºæŠ¥è­¦äº‹ä»¶VO
     */
    private AlarmEventVO convertToAlarmEventVO(AlarmEventEntity entity) {
        AlarmEventVO vo = BeanUtil.copyProperties(entity, AlarmEventVO.class);

        // 1. è¡¥å……è®¾å¤‡ä¿¡æ¯
        if (entity.getDeviceId() != null) {
            DeviceInfoVO deviceInfo = deviceService.getDeviceInfo(entity.getDeviceId());
            vo.setDeviceInfo(deviceInfo);
        }

        // 2. è¡¥å……åŒºåŸŸä¿¡æ¯
        if (entity.getAreaId() != null) {
            AreaInfoVO areaInfo = areaService.getAreaInfo(entity.getAreaId());
            vo.setAreaInfo(areaInfo);
        }

        // 3. è¡¥å……å¤„ç†è®°å½•
        vo.setProcessRecords(alarmProcessService.getProcessRecords(entity.getAlarmId()));

        // 4. è¡¥å……åª’ä½“æ–‡ä»¶ä¿¡æ¯
        vo.setMediaFiles(getMediaFiles(entity.getAlarmId()));

        return vo;
    }
}
```

### 3. ç»Ÿè®¡åˆ†ææœåŠ¡

#### 3.1 ç»¼åˆç»Ÿè®¡åˆ†æ

**åŠŸèƒ½æè¿°**ï¼šå¤šç»´åº¦é—¨ç¦äº‹ä»¶ç»Ÿè®¡åˆ†æå’ŒæŠ¥è¡¨ç”Ÿæˆ

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class AccessEventStatisticsService {

    @Resource
    private AccessEventDao accessEventDao;

    @Resource
    private AlarmEventDao alarmEventDao;

    @Resource
    private ChartGenerateService chartGenerateService;

    /**
     * ç”Ÿæˆç»¼åˆç»Ÿè®¡æŠ¥è¡¨
     */
    public ResponseDTO<ComprehensiveStatisticsVO> generateComprehensiveStatistics(
            StatisticsQueryForm queryForm) {
        try {
            // 1. éªŒè¯ç»Ÿè®¡æƒé™
            validateStatisticsPermission(queryForm);

            ComprehensiveStatisticsVO statistics = ComprehensiveStatisticsVO.builder()
                    .queryPeriod(buildQueryPeriod(queryForm))
                    .generationTime(LocalDateTime.now())
                    .build();

            // 2. æ—¶é—´ç»´åº¦ç»Ÿè®¡
            statistics.setTimeStatistics(generateTimeStatistics(queryForm));

            // 3. åŒºåŸŸç»´åº¦ç»Ÿè®¡
            statistics.setAreaStatistics(generateAreaStatistics(queryForm));

            // 4. äººå‘˜ç»´åº¦ç»Ÿè®¡
            statistics.setPersonStatistics(generatePersonStatistics(queryForm));

            // 5. è®¾å¤‡ç»´åº¦ç»Ÿè®¡
            statistics.setDeviceStatistics(generateDeviceStatistics(queryForm));

            // 6. äº‹ä»¶ç±»å‹ç»´åº¦ç»Ÿè®¡
            statistics.setEventTypeStatistics(generateEventTypeStatistics(queryForm));

            return ResponseDTO.ok(statistics);

        } catch (Exception e) {
            log.error("ç”Ÿæˆç»¼åˆç»Ÿè®¡æŠ¥è¡¨å¤±è´¥", e);
            return ResponseDTO.error("ç”ŸæˆæŠ¥è¡¨å¤±è´¥");
        }
    }

    /**
     * ç”Ÿæˆæ—¶é—´ç»´åº¦ç»Ÿè®¡
     */
    private TimeStatisticsVO generateTimeStatistics(StatisticsQueryForm queryForm) {
        try {
            TimeStatisticsVO timeStatistics = new TimeStatisticsVO();

            // 1. æ—¥ç»Ÿè®¡è¶‹åŠ¿
            List<DailyAccessCount> dailyCounts = accessEventDao.getDailyAccessCounts(
                    queryForm.getStartTime(), queryForm.getEndTime());
            timeStatistics.setDailyAccessTrend(dailyCounts);

            // 2. å°æ—¶åˆ†å¸ƒç»Ÿè®¡
            List<HourlyAccessDistribution> hourlyDistribution = accessEventDao
                    .getHourlyAccessDistribution(queryForm.getStartTime(), queryForm.getEndTime());
            timeStatistics.setHourlyDistribution(hourlyDistribution);

            // 3. å·¥ä½œæ—¥vså‘¨æœ«å¯¹æ¯”
            WeekdayWeekendComparison weekdayWeekendComparison = accessEventDao
                    .getWeekdayWeekendComparison(queryForm.getStartTime(), queryForm.getEndTime());
            timeStatistics.setWeekdayWeekendComparison(weekdayWeekendComparison);

            // 4. æœˆä»½ç¯æ¯”ç»Ÿè®¡
            List<MonthlyComparison> monthlyComparisons = accessEventDao
                    .getMonthlyComparisons(queryForm.getStartTime(), queryForm.getEndTime());
            timeStatistics.setMonthlyComparisons(monthlyComparisons);

            return timeStatistics;

        } catch (Exception e) {
            log.error("ç”Ÿæˆæ—¶é—´ç»´åº¦ç»Ÿè®¡å¤±è´¥", e);
            return new TimeStatisticsVO();
        }
    }

    /**
     * ç”ŸæˆåŒºåŸŸç»´åº¦ç»Ÿè®¡
     */
    private AreaStatisticsVO generateAreaStatistics(StatisticsQueryForm queryForm) {
        try {
            AreaStatisticsVO areaStatistics = new AreaStatisticsVO();

            // 1. åŒºåŸŸé€šè¡Œé‡æ’å
            List<AreaAccessRanking> areaRanking = accessEventDao
                    .getAreaAccessRanking(queryForm.getStartTime(), queryForm.getEndTime());
            areaStatistics.setAccessRanking(areaRanking);

            // 2. åŒºåŸŸé€šè¡Œå¯†åº¦çƒ­åŠ›å›¾æ•°æ®
            List<AreaAccessDensity> areaDensity = accessEventDao
                    .getAreaAccessDensity(queryForm.getStartTime(), queryForm.getEndTime());
            areaStatistics.setAccessDensity(areaDensity);

            // 3. åŒºåŸŸå¼‚å¸¸é€šè¡Œç»Ÿè®¡
            List<AreaAbnormalAccess> abnormalAccess = accessEventDao
                    .getAreaAbnormalAccess(queryForm.getStartTime(), queryForm.getEndTime());
            areaStatistics.setAbnormalAccess(abnormalAccess);

            // 4. åŒºåŸŸæŠ¥è­¦åˆ†å¸ƒç»Ÿè®¡
            List<AreaAlarmDistribution> alarmDistribution = alarmEventDao
                    .getAreaAlarmDistribution(queryForm.getStartTime(), queryForm.getEndTime());
            areaStatistics.setAlarmDistribution(alarmDistribution);

            return areaStatistics;

        } catch (Exception e) {
            log.error("ç”ŸæˆåŒºåŸŸç»´åº¦ç»Ÿè®¡å¤±è´¥", e);
            return new AreaStatisticsVO();
        }
    }

    /**
     * ç”Ÿæˆäººå‘˜ç»´åº¦ç»Ÿè®¡
     */
    private PersonStatisticsVO generatePersonStatistics(StatisticsQueryForm queryForm) {
        try {
            PersonStatisticsVO personStatistics = new PersonStatisticsVO();

            // 1. äººå‘˜é€šè¡Œé¢‘æ¬¡æ’å
            List<PersonAccessFrequency> accessFrequency = accessEventDao
                    .getPersonAccessFrequency(queryForm.getStartTime(), queryForm.getEndTime());
            personStatistics.setAccessFrequency(accessFrequency);

            // 2. äººå‘˜å¼‚å¸¸è¡Œä¸ºç»Ÿè®¡
            List<PersonAbnormalBehavior> abnormalBehavior = accessEventDao
                    .getPersonAbnormalBehavior(queryForm.getStartTime(), queryForm.getEndTime());
            personStatistics.setAbnormalBehavior(abnormalBehavior);

            // 3. é¦–æ¬¡é€šè¡Œäººå‘˜ç»Ÿè®¡
            List<NewPersonAccess> newPersonAccess = accessEventDao
                    .getNewPersonAccess(queryForm.getStartTime(), queryForm.getEndTime());
            personStatistics.setNewPersonAccess(newPersonAccess);

            // 4. é•¿æ—¶é—´æœªé€šè¡Œäººå‘˜ç»Ÿè®¡
            List<LongInactivePerson> longInactivePerson = accessEventDao
                    .getLongInactivePerson(queryForm.getEndTime());
            personStatistics.setLongInactivePerson(longInactivePerson);

            return personStatistics;

        } catch (Exception e) {
            log.error("ç”Ÿæˆäººå‘˜ç»´åº¦ç»Ÿè®¡å¤±è´¥", e);
            return new PersonStatisticsVO();
        }
    }

    /**
     * ç”Ÿæˆå›¾è¡¨æ•°æ®
     */
    public ResponseDTO<List<ChartVO>> generateCharts(ChartGenerateForm chartForm) {
        try {
            List<ChartVO> charts = new ArrayList<>();

            for (ChartConfig config : chartForm.getChartConfigs()) {
                ChartVO chart = switch (config.getChartType()) {
                    case LINE_CHART -> chartGenerateService.generateLineChart(config);
                    case BAR_CHART -> chartGenerateService.generateBarChart(config);
                    case PIE_CHART -> chartGenerateService.generatePieChart(config);
                    case HEAT_MAP -> chartGenerateService.generateHeatMap(config);
                    case AREA_CHART -> chartGenerateService.generateAreaChart(config);
                    default -> throw new BusinessException("ä¸æ”¯æŒçš„å›¾è¡¨ç±»å‹");
                };
                charts.add(chart);
            }

            return ResponseDTO.ok(charts);

        } catch (Exception e) {
            log.error("ç”Ÿæˆå›¾è¡¨æ•°æ®å¤±è´¥", e);
            return ResponseDTO.error("ç”Ÿæˆå›¾è¡¨å¤±è´¥");
        }
    }
}
```

### 4. åª’ä½“æ–‡ä»¶é¢„è§ˆæœåŠ¡

#### 4.1 ç…§ç‰‡è§†é¢‘é¢„è§ˆ

**åŠŸèƒ½æè¿°**ï¼šé—¨ç¦äº‹ä»¶ç›¸å…³åª’ä½“æ–‡ä»¶çš„é¢„è§ˆå’Œç®¡ç†

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class MediaPreviewService {

    @Resource
    private MediaFileDao mediaFileDao;

    @Resource
    private FileStorageService fileStorageService;

    @Resource
    private VideoStreamService videoStreamService;

    /**
     * è·å–äº‹ä»¶åª’ä½“æ–‡ä»¶åˆ—è¡¨
     */
    public ResponseDTO<List<MediaFileVO>> getEventMediaFiles(String eventId) {
        try {
            // 1. éªŒè¯äº‹ä»¶è®¿é—®æƒé™
            validateEventAccessPermission(eventId);

            // 2. æŸ¥è¯¢åª’ä½“æ–‡ä»¶
            List<MediaFileEntity> mediaFiles = mediaFileDao.selectList(
                    new LambdaQueryWrapper<MediaFileEntity>()
                            .eq(MediaFileEntity::getEventId, eventId)
                            .eq(MediaFileEntity::getDeletedFlag, false)
                            .orderByAsc(MediaFileEntity::getCreateTime()));

            // 3. è½¬æ¢ä¸ºVO
            List<MediaFileVO> voList = mediaFiles.stream()
                    .map(this::convertToMediaFileVO)
                    .collect(Collectors.toList());

            return ResponseDTO.ok(voList);

        } catch (Exception e) {
            log.error("è·å–äº‹ä»¶åª’ä½“æ–‡ä»¶å¤±è´¥, eventId: {}", eventId, e);
            return ResponseDTO.error("è·å–å¤±è´¥");
        }
    }

    /**
     * é¢„è§ˆç…§ç‰‡
     */
    public ResponseDTO<String> previewPhoto(String mediaFileId, String size) {
        try {
            // 1. è·å–åª’ä½“æ–‡ä»¶ä¿¡æ¯
            MediaFileEntity mediaFile = mediaFileDao.selectById(mediaFileId);
            if (mediaFile == null || mediaFile.getDeletedFlag()) {
                return ResponseDTO.error("åª’ä½“æ–‡ä»¶ä¸å­˜åœ¨");
            }

            // 2. éªŒè¯æ–‡ä»¶ç±»å‹
            if (!mediaFile.getFileType().startsWith("image/")) {
                return ResponseDTO.error("ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶");
            }

            // 3. éªŒè¯è®¿é—®æƒé™
            validateMediaAccessPermission(mediaFile);

            // 4. ç”Ÿæˆé¢„è§ˆURL
            String previewUrl;
            if ("thumbnail".equals(size)) {
                previewUrl = fileStorageService.generateThumbnailUrl(mediaFile.getFileId(), 200, 200);
            } else {
                previewUrl = fileStorageService.generatePreviewUrl(mediaFile.getFileId());
            }

            return ResponseDTO.ok(previewUrl);

        } catch (Exception e) {
            log.error("é¢„è§ˆç…§ç‰‡å¤±è´¥, mediaFileId: {}", mediaFileId, e);
            return ResponseDTO.error("é¢„è§ˆå¤±è´¥");
        }
    }

    /**
     * é¢„è§ˆè§†é¢‘
     */
    public ResponseDTO<VideoPreviewVO> previewVideo(String mediaFileId) {
        try {
            // 1. è·å–åª’ä½“æ–‡ä»¶ä¿¡æ¯
            MediaFileEntity mediaFile = mediaFileDao.selectById(mediaFileId);
            if (mediaFile == null || mediaFile.getDeletedFlag()) {
                return ResponseDTO.error("åª’ä½“æ–‡ä»¶ä¸å­˜åœ¨");
            }

            // 2. éªŒè¯æ–‡ä»¶ç±»å‹
            if (!mediaFile.getFileType().startsWith("video/")) {
                return ResponseDTO.error("ä¸æ˜¯è§†é¢‘æ–‡ä»¶");
            }

            // 3. éªŒè¯è®¿é—®æƒé™
            validateMediaAccessPermission(mediaFile);

            // 4. ç”Ÿæˆè§†é¢‘æµä¿¡æ¯
            VideoStreamInfo streamInfo = videoStreamService.getStreamInfo(mediaFile.getFileId());

            VideoPreviewVO previewVO = VideoPreviewVO.builder()
                    .mediaFileId(mediaFileId)
                    .fileName(mediaFile.getFileName())
                    .duration(streamInfo.getDuration())
                    .resolution(streamInfo.getResolution())
                    .fileSize(mediaFile.getFileSize())
                    .streamUrl(streamInfo.getStreamUrl())
                    .thumbnailUrl(streamInfo.getThumbnailUrl())
                    .build();

            return ResponseDTO.ok(previewVO);

        } catch (Exception e) {
            log.error("é¢„è§ˆè§†é¢‘å¤±è´¥, mediaFileId: {}", mediaFileId, e);
            return ResponseDTO.error("é¢„è§ˆå¤±è´¥");
        }
    }

    /**
     * ä¸‹è½½åª’ä½“æ–‡ä»¶
     */
    public ResponseEntity<Resource> downloadMediaFile(String mediaFileId) {
        try {
            // 1. è·å–åª’ä½“æ–‡ä»¶ä¿¡æ¯
            MediaFileEntity mediaFile = mediaFileDao.selectById(mediaFileId);
            if (mediaFile == null || mediaFile.getDeletedFlag()) {
                throw new BusinessException("åª’ä½“æ–‡ä»¶ä¸å­˜åœ¨");
            }

            // 2. éªŒè¯ä¸‹è½½æƒé™
            validateDownloadPermission(mediaFile);

            // 3. è·å–æ–‡ä»¶æµ
            Resource resource = fileStorageService.getFileResource(mediaFile.getFileId());

            // 4. è®¾ç½®å“åº”å¤´
            String contentType = mediaFile.getFileType();
            String headerValue = "attachment; filename=\"" +
                    URLEncoder.encode(mediaFile.getOriginalFileName(), "UTF-8") + "\"";

            return ResponseEntity.ok()
                    .contentType(MediaType.parseMediaType(contentType))
                    .header(HttpHeaders.CONTENT_DISPOSITION, headerValue)
                    .body(resource);

        } catch (Exception e) {
            log.error("ä¸‹è½½åª’ä½“æ–‡ä»¶å¤±è´¥, mediaFileId: {}", mediaFileId, e);
            throw new BusinessException("ä¸‹è½½å¤±è´¥");
        }
    }

    /**
     * è½¬æ¢ä¸ºåª’ä½“æ–‡ä»¶VO
     */
    private MediaFileVO convertToMediaFileVO(MediaFileEntity entity) {
        MediaFileVO vo = BeanUtil.copyProperties(entity, MediaFileVO.class);

        // 1. ç”Ÿæˆé¢„è§ˆURL
        if (entity.getFileType().startsWith("image/")) {
            vo.setThumbnailUrl(fileStorageService.generateThumbnailUrl(entity.getFileId(), 150, 150));
            vo.setPreviewUrl(fileStorageService.generatePreviewUrl(entity.getFileId()));
        }

        // 2. ç”Ÿæˆè§†é¢‘æµURL
        if (entity.getFileType().startsWith("video/")) {
            VideoStreamInfo streamInfo = videoStreamService.getStreamInfo(entity.getFileId());
            vo.setStreamUrl(streamInfo.getStreamUrl());
            vo.setThumbnailUrl(streamInfo.getThumbnailUrl());
            vo.setDuration(streamInfo.getDuration());
        }

        return vo;
    }
}
```

### 5. æ•°æ®å¯¼å‡ºæœåŠ¡

#### 5.1 å¤šæ ¼å¼æ•°æ®å¯¼å‡º

**åŠŸèƒ½æè¿°**ï¼šé—¨ç¦äº‹ä»¶æ•°æ®çš„Excelã€PDFã€CSVæ ¼å¼å¯¼å‡º

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
@Slf4j
public class DataExportService {

    @Resource
    private AccessEventDao accessEventDao;

    @Resource
    private AlarmEventDao alarmEventDao;

    @Resource
    private ExcelExportService excelExportService;

    @Resource
    private PdfExportService pdfExportService;

    /**
     * å¯¼å‡ºé—¨ç¦äº‹ä»¶æ•°æ®
     */
    public ResponseDTO<String> exportAccessEvents(AccessEventExportForm exportForm) {
        try {
            // 1. éªŒè¯å¯¼å‡ºæƒé™
            validateExportPermission(exportForm);

            // 2. æŸ¥è¯¢å¯¼å‡ºæ•°æ®
            List<AccessEventEntity> events = queryAccessEventsForExport(exportForm);

            // 3. æ ¹æ®æ ¼å¼å¯¼å‡º
            String downloadUrl = switch (exportForm.getExportFormat()) {
                case EXCEL -> exportAccessEventsToExcel(events, exportForm);
                case PDF -> exportAccessEventsToPdf(events, exportForm);
                case CSV -> exportAccessEventsToCsv(events, exportForm);
                default -> throw new BusinessException("ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼");
            };

            // 4. è®°å½•å¯¼å‡ºæ—¥å¿—
            logExportOperation("ACCESS_EVENT_EXPORT", exportForm, events.size(), downloadUrl);

            return ResponseDTO.ok(downloadUrl);

        } catch (Exception e) {
            log.error("å¯¼å‡ºé—¨ç¦äº‹ä»¶æ•°æ®å¤±è´¥", e);
            return ResponseDTO.error("å¯¼å‡ºå¤±è´¥");
        }
    }

    /**
     * å¯¼å‡ºä¸ºExcelæ ¼å¼
     */
    private String exportAccessEventsToExcel(List<AccessEventEntity> events, AccessEventExportForm exportForm) {
        try {
            // 1. æ„å»ºExcelå¯¼å‡ºé…ç½®
            ExcelExportConfig config = ExcelExportConfig.builder()
                    .fileName(generateExportFileName("é—¨ç¦äº‹ä»¶", exportForm.getExportFormat()))
                    .sheetName("é—¨ç¦äº‹ä»¶è®°å½•")
                    .headers(buildExcelHeaders(exportForm.getSelectedFields()))
                    .build();

            // 2. è½¬æ¢æ•°æ®
            List<Map<String, Object>> data = events.stream()
                    .map(event -> convertEventToExportData(event, exportForm.getSelectedFields()))
                    .collect(Collectors.toList());

            // 3. æ‰§è¡Œå¯¼å‡º
            String fileId = excelExportService.export(config, data);

            // 4. ç”Ÿæˆä¸‹è½½URL
            return fileStorageService.generateDownloadUrl(fileId);

        } catch (Exception e) {
            log.error("Excelå¯¼å‡ºå¤±è´¥", e);
            throw new BusinessException("Excelå¯¼å‡ºå¤±è´¥");
        }
    }

    /**
     * å¯¼å‡ºä¸ºPDFæ ¼å¼
     */
    private String exportAccessEventsToPdf(List<AccessEventEntity> events, AccessEventExportForm exportForm) {
        try {
            // 1. æ„å»ºPDFå¯¼å‡ºé…ç½®
            PdfExportConfig config = PdfExportConfig.builder()
                    .fileName(generateExportFileName("é—¨ç¦äº‹ä»¶", exportForm.getExportFormat()))
                    .title("é—¨ç¦äº‹ä»¶è®°å½•æŠ¥è¡¨")
                    .build();

            // 2. è½¬æ¢æ•°æ®
            List<Map<String, Object>> data = events.stream()
                    .map(event -> convertEventToExportData(event, exportForm.getSelectedFields()))
                    .collect(Collectors.toList());

            // 3. ç”ŸæˆPDFè¡¨æ ¼æ•°æ®
            PdfTableData tableData = PdfTableData.builder()
                    .headers(buildPdfHeaders(exportForm.getSelectedFields()))
                    .data(data)
                    .build();

            // 4. æ‰§è¡Œå¯¼å‡º
            String fileId = pdfExportService.export(config, tableData);

            // 5. ç”Ÿæˆä¸‹è½½URL
            return fileStorageService.generateDownloadUrl(fileId);

        } catch (Exception e) {
            log.error("PDFå¯¼å‡ºå¤±è´¥", e);
            throw new BusinessException("PDFå¯¼å‡ºå¤±è´¥");
        }
    }

    /**
     * å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨
     */
    public ResponseDTO<String> exportStatisticsReport(StatisticsExportForm exportForm) {
        try {
            // 1. ç”Ÿæˆç»Ÿè®¡æ•°æ®
            ComprehensiveStatisticsVO statistics = generateComprehensiveStatistics(
                    exportForm.getStatisticsQuery());

            // 2. æ ¹æ®æ ¼å¼å¯¼å‡ºæŠ¥è¡¨
            String downloadUrl = switch (exportForm.getExportFormat()) {
                case EXCEL -> exportStatisticsToExcel(statistics, exportForm);
                case PDF -> exportStatisticsToPdf(statistics, exportForm);
                default -> throw new BusinessException("ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼");
            };

            // 3. è®°å½•å¯¼å‡ºæ—¥å¿—
            logExportOperation("STATISTICS_REPORT_EXPORT", exportForm, 1, downloadUrl);

            return ResponseDTO.ok(downloadUrl);

        } catch (Exception e) {
            log.error("å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨å¤±è´¥", e);
            return ResponseDTO.error("å¯¼å‡ºå¤±è´¥");
        }
    }

    /**
     * è½¬æ¢äº‹ä»¶ä¸ºå¯¼å‡ºæ•°æ®
     */
    private Map<String, Object> convertEventToExportData(AccessEventEntity event, List<String> selectedFields) {
        Map<String, Object> data = new HashMap<>();

        for (String field : selectedFields) {
            switch (field) {
                case "eventTime" -> data.put("äº‹ä»¶æ—¶é—´", event.getEventTime());
                case "personName" -> data.put("äººå‘˜å§“å", event.getPersonName());
                case "personCode" -> data.put("äººå‘˜å·¥å·", event.getPersonCode());
                case "departmentName" -> data.put("éƒ¨é—¨", event.getDepartmentName());
                case "deviceName" -> data.put("è®¾å¤‡åç§°", event.getDeviceName());
                case "areaName" -> data.put("åŒºåŸŸ", event.getAreaName());
                case "verificationMethod" -> data.put("éªŒè¯æ–¹å¼",
                        VerificationMethodEnum.getDescByCode(event.getVerificationMethod()));
                case "accessResult" -> data.put("é€šè¡Œç»“æœ",
                        AccessResultEnum.getDescByCode(event.getAccessResult()));
                case "processTime" -> data.put("å¤„ç†æ—¶é—´", event.getProcessTime());
                default -> data.put(field, "");
            }
        }

        return data;
    }
}
```

## ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡

### äº‹ä»¶æŸ¥è¯¢æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ç±»å‹ | æ€§èƒ½è¦æ±‚ | ç›‘æ§æ–¹æ³• |
|---------|---------|---------|
| å•æ¬¡æŸ¥è¯¢å“åº”æ—¶é—´ | â‰¤ 2ç§’ | æŸ¥è¯¢è€—æ—¶ç›‘æ§ |
| å¤§æ•°æ®é‡æŸ¥è¯¢ | â‰¤ 5ç§’ | ä¸‡çº§æ•°æ®æŸ¥è¯¢æµ‹è¯• |
| å…¨æ–‡æœç´¢å“åº”æ—¶é—´ | â‰¤ 1ç§’ | æœç´¢å¼•æ“æ€§èƒ½ç›‘æ§ |
| ç…§ç‰‡é¢„è§ˆåŠ è½½æ—¶é—´ | â‰¤ 3ç§’ | å›¾ç‰‡åŠ è½½é€Ÿåº¦æµ‹è¯• |
| è§†é¢‘æµå¯åŠ¨æ—¶é—´ | â‰¤ 2ç§’ | è§†é¢‘æµå“åº”æ—¶é—´ |
| æ•°æ®å¯¼å‡ºå¤„ç†æ—¶é—´ | â‰¤ 30ç§’/ä¸‡æ¡ | å¯¼å‡ºæ€§èƒ½ç›‘æ§ |

### ç³»ç»Ÿå®¹é‡æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | è®¾è®¡å®¹é‡ | è¯´æ˜ |
|---------|---------|------|
| æ—¥å‡äº‹ä»¶å¤„ç†é‡ | 100ä¸‡æ¡/å¤© | é—¨ç¦äº‹ä»¶æ—¥å¸¸å¤„ç†èƒ½åŠ› |
| å¹¶å‘æŸ¥è¯¢ç”¨æˆ·æ•° | 500ç”¨æˆ· | åŒæ—¶æŸ¥è¯¢äº‹ä»¶ç”¨æˆ·æ•° |
| åª’ä½“æ–‡ä»¶å­˜å‚¨ | 10TB/å¹´ | ç…§ç‰‡è§†é¢‘å¹´åº¦å­˜å‚¨é‡ |
| æ•°æ®å¯¼å‡ºå¹¶å‘æ•° | 100ä¸ª/åˆ†é’Ÿ | åŒæ—¶è¿›è¡Œæ•°æ®å¯¼å‡ºæ•° |
| æŠ¥è¡¨ç”Ÿæˆèƒ½åŠ› | 1000å¼ /å°æ—¶ | ç»Ÿè®¡æŠ¥è¡¨ç”Ÿæˆé€Ÿåº¦ |
| å†å²æ•°æ®ä¿ç•™æœŸ | 3å¹´ | äº‹ä»¶æ•°æ®åœ¨çº¿ä¿ç•™æœŸ |

## ğŸ”— ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯å®ç°æ–‡æ¡£
- [é—¨ç¦ç®¡ç†ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡](./ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡.md) - å®Œæ•´çš„ç³»ç»Ÿæ¶æ„è®¾è®¡
- [å®æ—¶ç›‘æ§æ¨¡å—è¯¦ç»†è®¾è®¡](./å®æ—¶ç›‘æ§æ¨¡å—è¯¦ç»†è®¾è®¡.md) - å®æ—¶ç›‘æ§åŠŸèƒ½å®ç°
- [è®¾å¤‡ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡](./è®¾å¤‡ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡.md) - è®¾å¤‡ç®¡ç†åŠŸèƒ½è®¾è®¡

### æ•°æ®å¤„ç†æ–‡æ¡£
- [é—¨ç¦äº‹ä»¶æ•°æ®æ¨¡å‹è®¾è®¡](./äº‹ä»¶æ•°æ®æ¨¡å‹è®¾è®¡.md) - äº‹ä»¶æ•°æ®ç»“æ„å’Œå…³ç³»
- [ç»Ÿè®¡åˆ†æç®—æ³•è®¾è®¡](./ç»Ÿè®¡åˆ†æç®—æ³•è®¾è®¡.md) - ç»Ÿè®¡åˆ†æç®—æ³•å®ç°
- [åª’ä½“æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ](./åª’ä½“æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ.md) - åª’ä½“æ–‡ä»¶å­˜å‚¨æ¶æ„

### éƒ¨ç½²è¿ç»´æ–‡æ¡£
- [æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](./æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ.md) - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
- [å¤§æ•°æ®é‡å¤„ç†æ–¹æ¡ˆ](./å¤§æ•°æ®é‡å¤„ç†æ–¹æ¡ˆ.md) - æµ·é‡æ•°æ®å¤„ç†æ¶æ„
- [æ•°æ®å¤‡ä»½æ¢å¤æ–¹æ¡ˆ](./æ•°æ®å¤‡ä»½æ¢å¤æ–¹æ¡ˆ.md) - æ•°æ®å¤‡ä»½å’Œæ¢å¤ç­–ç•¥

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™æ€»ç»“

1. **æ•°æ®å‡†ç¡®æ€§** - ç¡®ä¿é—¨ç¦äº‹ä»¶è®°å½•çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
2. **æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–** - æ”¯æŒæµ·é‡æ•°æ®çš„é«˜æ•ˆæŸ¥è¯¢å’Œæ£€ç´¢
3. **å¤šç»´åº¦åˆ†æ** - æä¾›å…¨æ–¹ä½çš„ç»Ÿè®¡åˆ†æåŠŸèƒ½
4. **åª’ä½“æ–‡ä»¶é›†æˆ** - å®Œå–„çš„ç…§ç‰‡è§†é¢‘é¢„è§ˆå’Œç®¡ç†
5. **æƒé™å®‰å…¨æ§åˆ¶** - ä¸¥æ ¼çš„æ•°æ®è®¿é—®å’Œæ“ä½œæƒé™æ§åˆ¶

## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯

- æœ¬æ–‡æ¡£åŸºäºé—¨ç¦äº‹ä»¶ç®¡ç†æœ€ä½³å®è·µè®¾è®¡
- äº‹ä»¶è®°å½•æŸ¥è¯¢æ¨¡å—è®¾è®¡è´Ÿè´£äººï¼šSmartAdminè§„èŒƒæ²»ç†å§”å‘˜ä¼š
- åˆ›å»ºæ—¥æœŸï¼š2025-11-13
- ä¸‹æ¬¡è¯„å®¡ï¼š2026-02-13

---

**ğŸ¯ IOE-DREAMé—¨ç¦äº‹ä»¶è®°å½•æŸ¥è¯¢æ¨¡å— - ä¸“ä¸šæŸ¥è¯¢ã€æ™ºèƒ½ç»Ÿè®¡ã€åª’ä½“é›†æˆã€å®‰å…¨å¯¼å‡ºçš„ä¼ä¸šçº§äº‹ä»¶ç®¡ç†è§£å†³æ–¹æ¡ˆ**