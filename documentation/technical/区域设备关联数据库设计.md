# 区域-设备关联数据库设计

> **设计时间**: 2025-12-08
> **设计目标**: 支持统一区域空间概念和设备关联管理
> **设计原则**: 遵循数据库设计三大范式，支持高效查询和扩展
> **数据库**: MySQL 8.0+

---

## 📋 数据库表设计

### 1. 区域设备关联表 (t_area_device_relation)

#### 表结构定义

```sql
CREATE TABLE `t_area_device_relation` (
  `relation_id` VARCHAR(32) NOT NULL COMMENT '关联ID（主键）',
  `area_id` BIGINT NOT NULL COMMENT '区域ID',
  `device_id` VARCHAR(64) NOT NULL COMMENT '设备ID',
  `device_code` VARCHAR(50) NOT NULL COMMENT '设备编码',
  `device_name` VARCHAR(100) NOT NULL COMMENT '设备名称',
  `device_type` INT NOT NULL COMMENT '设备类型(1-门禁 2-考勤 3-消费 4-视频 5-访客 6-报警 7-显示 8-网络)',
  `device_sub_type` INT DEFAULT NULL COMMENT '设备子类型',
  `business_module` VARCHAR(20) NOT NULL COMMENT '业务模块(access/attendance/consume/visitor/video/oa/device_comm)',
  `location_desc` VARCHAR(200) DEFAULT NULL COMMENT '位置描述',
  `install_location` TEXT DEFAULT NULL COMMENT '安装位置(JSON格式)',
  `business_attributes` TEXT DEFAULT NULL COMMENT '业务属性(JSON格式)',
  `relation_status` INT NOT NULL DEFAULT 1 COMMENT '关联状态(1-正常 2-维护 3-故障 4-离线 5-停用)',
  `priority` INT DEFAULT 2 COMMENT '优先级(1-主设备 2-辅助设备 3-备用设备 9-测试设备)',
  `enabled` TINYINT(1) NOT NULL DEFAULT 1 COMMENT '是否启用',
  `effective_time` DATETIME DEFAULT NULL COMMENT '生效时间',
  `expire_time` DATETIME DEFAULT NULL COMMENT '失效时间',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT '备注',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_user_id` BIGINT DEFAULT NULL COMMENT '创建人ID',
  `update_user_id` BIGINT DEFAULT NULL COMMENT '更新人ID',
  `deleted_flag` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '删除标记(0-未删除 1-已删除)',
  `version` INT NOT NULL DEFAULT 0 COMMENT '乐观锁版本号',
  PRIMARY KEY (`relation_id`),
  KEY `idx_area_id` (`area_id`),
  KEY `idx_device_id` (`device_id`),
  KEY `idx_device_code` (`device_code`),
  KEY `idx_device_type` (`device_type`),
  KEY `idx_business_module` (`business_module`),
  KEY `idx_relation_status` (`relation_status`),
  KEY `idx_priority` (`priority`),
  KEY `idx_enabled` (`enabled`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_area_device` (`area_id`, `device_id`),
  KEY `idx_area_type_status` (`area_id`, `device_type`, `relation_status`),
  KEY `idx_area_module_status` (`area_id`, `business_module`, `relation_status`),
  KEY `idx_device_area_status` (`device_id`, `area_id`, `relation_status`),
  KEY `idx_enabled_status_time` (`enabled`, `relation_status`, `expire_time`),
  UNIQUE KEY `uk_area_device` (`area_id`, `device_id`, `deleted_flag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='区域设备关联表';

-- 添加表注释
ALTER TABLE `t_area_device_relation` COMMENT = '区域设备关联表 - 管理设备在区域中的部署和业务属性';
```

#### 字段详细说明

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| **relation_id** | VARCHAR(32) | 关联ID，主键，使用雪花算法生成 | "1001202512080001" |
| **area_id** | BIGINT | 区域ID，关联区域表 | 1001 |
| **device_id** | VARCHAR(64) | 设备ID，关联设备表 | "DEV001" |
| **device_code** | VARCHAR(50) | 设备编码，业务唯一标识 | "ACCESS_CTRL_001" |
| **device_name** | VARCHAR(100) | 设备名称，便于识别 | "主入口门禁控制器" |
| **device_type** | INT | 设备类型，标准枚举值 | 1(门禁设备) |
| **device_sub_type** | INT | 设备子类型，详细分类 | 11(门禁控制器) |
| **business_module** | VARCHAR(20) | 业务模块标识 | "access" |
| **business_attributes** | TEXT | 业务属性，JSON格式存储 | `{"accessMode":"card","antiPassback":true}` |
| **relation_status** | INT | 关联状态，标准枚举值 | 1(正常) |
| **priority** | INT | 优先级，设备重要性标识 | 1(主设备) |

### 2. 设备类型枚举定义

#### 主设备类型
```sql
-- 设备类型枚举
-- 1: 门禁设备 (Access Control)
-- 2: 考勤设备 (Attendance)
-- 3: 消费设备 (Consume)
-- 4: 视频设备 (Video)
-- 5: 访客设备 (Visitor)
-- 6: 报警设备 (Alarm)
-- 7: 显示设备 (Display)
-- 8: 网络设备 (Network)
```

#### 设备子类型详细定义
```sql
-- 门禁设备子类型
-- 11: 门禁控制器 (Access Controller)
-- 12: 读卡器 (Card Reader)
-- 13: 生物识别设备 (Biometric Device)
-- 14: 电锁 (Electric Lock)

-- 考勤设备子类型
-- 21: 考勤机 (Attendance Machine)
-- 22: 指纹机 (Fingerprint Device)
-- 23: 人脸识别设备 (Face Recognition)

-- 消费设备子类型
-- 31: POS机 (POS Machine)
-- 32: 消费机 (Vending Machine)
-- 33: 充值机 (Recharge Machine)

-- 视频设备子类型
-- 41: 网络摄像头 (IP Camera)
-- 42: 模拟摄像头 (Analog Camera)
-- 43: 录像机 (Video Recorder)
-- 44: 视频服务器 (Video Server)
```

### 3. 业务模块标识

```sql
-- 业务模块标准标识
-- access: 门禁管理模块
-- attendance: 考勤管理模块
-- consume: 消费管理模块
-- visitor: 访客管理模块
-- video: 视频监控模块
-- oa: 办公协同模块
-- device_comm: 设备通讯模块
```

### 4. 业务属性模板

#### 门禁设备业务属性模板
```json
{
  "accessMode": "card",           // 访问模式: card/password/biometric
  "accessLevel": "normal",        // 访问级别: normal/low/high
  "antiPassback": true,           // 反潜回功能
  "duressCode": "123456",         // 胁迫码
  "openTime": 3000,               // 开门时间(毫秒)
  "closeTime": 5000,              // 关门时间(毫秒)
  "autoLock": true,               // 自动上锁
  "multiCardOpen": false,         // 多卡开门
  "interlock": false              // 互锁功能
}
```

#### 考勤设备业务属性模板
```json
{
  "workMode": "attendance",       // 工作模式: attendance/check-in/out
  "locationRequired": true,       // 需要位置验证
  "photoCapture": true,           // 拍照采集
  "faceRecognition": false,       // 人脸识别
  "fingerprintVerify": true,      // 指纹验证
  "allowRemote": false,           // 允许远程打卡
  "geofenceRadius": 100,          // 地理围栏半径(米)
  "lateTolerance": 5              // 迟到容忍时间(分钟)
}
```

#### 消费设备业务属性模板
```json
{
  "paymentMode": "card",          // 支付模式: card/mobile/cash
  "receiptRequired": true,        // 需要小票
  "offlineMode": true,            // 离线模式
  "maxAmount": 100.00,            // 最大消费金额
  "dailyLimit": 500.00,           // 每日消费限额
  "supportSubsidy": true,         // 支持补贴
  "passwordRequired": false,      // 需要密码验证
  "refundAllowed": true           // 允许退款
}
```

#### 视频设备业务属性模板
```json
{
  "resolution": "1080p",          // 分辨率: 720p/1080p/4K
  "recordingEnabled": true,       // 启用录像
  "aiAnalysis": false,            // AI智能分析
  "storageType": "local",         // 存储类型: local/cloud/hybrid
  "recordingMode": "continuous",  // 录像模式: continuous/motion
  "nightVision": true,            // 夜视功能
  "ptzSupport": false,            // 云台支持
  "audioEnabled": true,           // 音频录制
  "privacyMask": []               // 隐私遮蔽区域
}
```

## 🔍 索引设计说明

### 1. 主要索引用途

```sql
-- 主要查询索引
KEY `idx_area_device` (`area_id`, `device_id`)                    -- 区域设备关联查询
KEY `idx_area_type_status` (`area_id`, `device_type`, `relation_status`) -- 区域设备类型状态查询
KEY `idx_area_module_status` (`area_id`, `business_module`, `relation_status`) -- 区域业务模块查询
KEY `idx_device_area_status` (`device_id`, `area_id`, `relation_status`) -- 设备区域状态查询

-- 状态和时间查询索引
KEY `idx_enabled_status_time` (`enabled`, `relation_status`, `expire_time`) -- 生效状态查询

-- 唯一性约束
UNIQUE KEY `uk_area_device` (`area_id`, `device_id`, `deleted_flag`) -- 防止重复关联
```

### 2. 查询场景优化

#### 常用查询模式
```sql
-- 1. 获取区域所有设备
SELECT * FROM t_area_device_relation
WHERE area_id = ? AND enabled = 1 AND relation_status = 1
  AND (expire_time IS NULL OR expire_time > NOW());

-- 2. 获取区域指定类型设备
SELECT * FROM t_area_device_relation
WHERE area_id = ? AND device_type = ? AND enabled = 1 AND relation_status = 1;

-- 3. 获取区域业务模块设备
SELECT * FROM t_area_device_relation
WHERE area_id = ? AND business_module = ? AND enabled = 1 AND relation_status = 1;

-- 4. 获取设备所属区域
SELECT * FROM t_area_device_relation
WHERE device_id = ? AND enabled = 1 AND relation_status = 1;

-- 5. 获取用户可访问设备
SELECT DISTINCT adr.* FROM t_area_device_relation adr
INNER JOIN t_user_area_permission uap ON adr.area_id = uap.area_id
WHERE uap.user_id = ? AND uap.enabled = 1 AND adr.enabled = 1 AND adr.relation_status = 1;
```

## 📊 统计查询设计

### 1. 设备统计查询

```sql
-- 区域设备类型统计
SELECT
    device_type,
    device_sub_type,
    COUNT(*) as device_count,
    SUM(CASE WHEN relation_status = 1 THEN 1 ELSE 0 END) as online_count,
    SUM(CASE WHEN priority = 1 THEN 1 ELSE 0 END) as primary_count
FROM t_area_device_relation
WHERE area_id = ? AND enabled = 1
  AND (expire_time IS NULL OR expire_time > NOW())
GROUP BY device_type, device_sub_type
ORDER BY device_type, device_sub_type;

-- 业务模块设备分布统计
SELECT
    business_module,
    device_type,
    COUNT(*) as device_count,
    COUNT(DISTINCT area_id) as area_count
FROM t_area_device_relation
WHERE business_module = ? AND enabled = 1
  AND (expire_time IS NULL OR expire_time > NOW())
GROUP BY business_module, device_type
ORDER BY business_module, device_type;
```

### 2. 性能监控查询

```sql
-- 设备在线率统计
SELECT
    device_type,
    COUNT(*) as total_count,
    SUM(CASE WHEN relation_status = 1 THEN 1 ELSE 0 END) as online_count,
    ROUND(SUM(CASE WHEN relation_status = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as online_rate
FROM t_area_device_relation
WHERE enabled = 1 AND (expire_time IS NULL OR expire_time > NOW())
GROUP BY device_type;

-- 设备状态变更趋势
SELECT
    DATE(update_time) as stat_date,
    device_type,
    relation_status,
    COUNT(*) as count
FROM t_area_device_relation
WHERE update_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
  AND enabled = 1
GROUP BY DATE(update_time), device_type, relation_status
ORDER BY stat_date, device_type, relation_status;
```

## 🔧 数据库优化建议

### 1. 分区策略

```sql
-- 按月分区（适用于大数据量场景）
ALTER TABLE t_area_device_relation
PARTITION BY RANGE (YEAR(create_time) * 100 + MONTH(create_time)) (
    PARTITION p202512 VALUES LESS THAN (202601),
    PARTITION p202601 VALUES LESS THAN (202602),
    PARTITION p202602 VALUES LESS THAN (202603),
    -- ... 继续添加分区
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. 性能优化配置

```sql
-- MySQL配置优化建议
-- innodb_buffer_pool_size: 设置为物理内存的70-80%
-- innodb_log_file_size: 设置为256M-1G
-- innodb_flush_log_at_trx_commit: 设置为2（性能优先）或1（安全优先）
-- query_cache_size: 根据实际情况配置
-- max_connections: 根据并发需求配置
```

### 3. 维护策略

```sql
-- 定期清理过期数据
DELETE FROM t_area_device_relation
WHERE expire_time IS NOT NULL
  AND expire_time < DATE_SUB(NOW(), INTERVAL 1 MONTH)
  AND deleted_flag = 1;

-- 定期优化表结构
OPTIMIZE TABLE t_area_device_relation;

-- 定期更新表统计信息
ANALYZE TABLE t_area_device_relation;
```

---

**设计完成时间**: 2025-12-08
**设计版本**: v1.0
**兼容性**: MySQL 8.0+
**字符集**: utf8mb4
**存储引擎**: InnoDB