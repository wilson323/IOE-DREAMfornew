# 人群态势分析页面功能与布局文档

## 页面概述
人群态势分析页面是智能视频监控系统的核心AI分析模块,用于实时监测和分析监控区域的人群流动、密度分布和拥挤状态。该页面基于SmartAdmin前端框架构建,采用Vue3 + Ant Design Vue + ECharts技术栈,支持过线统计、排队长度监控、人群密度检测三大核心功能,提供区域划分、告警配置、时间计划、热力图展示、声光警戒等完整功能,为安全管理和人员疏导提供数据支持。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **可视化库**: Apache ECharts 5.5.0
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **Canvas绘图**: 原生Canvas API

### 人群分析技术方案

#### 方案一: ECharts折线图/柱状图 (推荐用于统计趋势)
**优势**:
- 内置多种图表类型
- 支持实时数据更新
- 交互功能完善(tooltip、zoom、legend等)
- 性能优异,支持大数据量

**适用场景**:
- 24小时人流量趋势图
- 过线统计时间序列图
- 多区域对比柱状图

#### 方案二: Canvas热力图 (推荐用于密度可视化)
**优势**:
- 叠加到视频画面上
- 实时渲染人群密度
- 支持自定义颜色渐变

**适用场景**:
- 人群密度热力图
- 区域拥挤度可视化
- 视频叠加热点分布

#### 方案三: Canvas区域绘制 (推荐用于区域配置)
**优势**:
- 灵活的多边形/线条绘制
- 支持拖拽调整
- 可保存配置数据

**适用场景**:
- 过线检测线绘制
- 排队区域划分
- 密度监控区域设置

### 项目文件组织结构
```
src/views/business/smart-video/
├── crowd-situational.vue                # 人群态势分析主页面
├── components/
│   ├── LineCrossingPanel.vue           # 过线统计配置面板
│   ├── QueueMonitorPanel.vue           # 排队长度监控面板
│   ├── DensityMonitorPanel.vue         # 人群密度监控面板
│   ├── VideoDrawingCanvas.vue          # 视频区域绘制组件
│   ├── CrowdStatisticsCard.vue         # 统计卡片组件
│   ├── TrendChart.vue                  # 趋势图表组件
│   ├── HeatmapOverlay.vue              # 热力图叠加组件
│   ├── AlarmConfigPanel.vue            # 告警配置组件
│   └── TimePlanTable.vue               # 时间计划表格组件
├── hooks/
│   ├── useCrowdData.js                 # 人群数据处理Hook
│   ├── useCanvasDrawing.js             # Canvas绘图Hook
│   ├── useAlarmNotification.js         # 告警通知Hook
│   └── useVideoStream.js               # 视频流处理Hook
├── utils/
│   ├── crowd-calculator.js             # 人群数据计算工具
│   ├── canvas-drawer.js                # Canvas绘制工具
│   └── density-gradient.js             # 密度梯度配色工具
├── mock/
│   └── crowd-mock-data.js              # 模拟数据
└── api/
    └── crowd-api.js                    # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/crowd-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const crowdApi = {
  // ========== 过线统计 ==========
  // 获取过线统计配置
  getLineCrossingConfig: (channelId) => getRequest(`/crowd/line-crossing/config/${channelId}`),

  // 保存过线统计配置
  saveLineCrossingConfig: (config) => postRequest('/crowd/line-crossing/config/save', config),

  // 获取过线记录
  getLineCrossingRecords: (params) => postRequest('/crowd/line-crossing/records', params),

  // 清除过线统计
  clearLineCrossingCount: (channelId) => postRequest('/crowd/line-crossing/clear', { channelId }),

  // 获取过线实时数据
  getLineCrossingRealtime: (channelId) => getRequest(`/crowd/line-crossing/realtime/${channelId}`),

  // ========== 排队长度监控 ==========
  // 获取排队长度配置
  getQueueConfig: (channelId) => getRequest(`/crowd/queue/config/${channelId}`),

  // 保存排队长度配置
  saveQueueConfig: (config) => postRequest('/crowd/queue/config/save', config),

  // 获取排队区域列表
  getQueueAreas: (channelId) => getRequest(`/crowd/queue/areas/${channelId}`),

  // 获取排队实时数据
  getQueueRealtime: (channelId) => getRequest(`/crowd/queue/realtime/${channelId}`),

  // ========== 人群密度监控 ==========
  // 获取密度监控配置
  getDensityConfig: (channelId) => getRequest(`/crowd/density/config/${channelId}`),

  // 保存密度监控配置
  saveDensityConfig: (config) => postRequest('/crowd/density/config/save', config),

  // 获取密度热力图数据
  getDensityHeatmapData: (channelId) => getRequest(`/crowd/density/heatmap/${channelId}`),

  // 获取密度等级统计
  getDensityLevelStats: (params) => postRequest('/crowd/density/stats', params),

  // ========== 告警相关 ==========
  // 获取告警列表
  getCrowdAlarms: (params) => postRequest('/crowd/alarms/list', params),

  // 处理告警
  handleAlarm: (alarmId, action) => postRequest('/crowd/alarms/handle', { alarmId, action }),

  // ========== 声光警戒 ==========
  // 触发声音告警
  triggerAudioAlarm: (config) => postRequest('/crowd/alarm/audio/trigger', config),

  // 触发白光灯警戒
  triggerLightAlarm: (config) => postRequest('/crowd/alarm/light/trigger', config),

  // ========== 时间计划 ==========
  // 获取时间计划
  getTimePlans: (channelId, type) => getRequest(`/crowd/time-plan/${channelId}/${type}`),

  // 保存时间计划
  saveTimePlans: (plans) => postRequest('/crowd/time-plan/save', plans),

  // ========== 统计报表 ==========
  // 获取统计概览
  getCrowdStatistics: (params) => postRequest('/crowd/statistics/overview', params),

  // 导出报表
  exportCrowdReport: (params) => postRequest('/crowd/report/export', params, {
    responseType: 'blob'
  }),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Canvas区域绘制注意事项

#### ❌ 错误用法：未正确处理坐标系转换
```vue
<!-- 错误：直接使用鼠标坐标绘制，未考虑Canvas缩放和偏移 -->
<template>
  <canvas ref="canvasRef" @click="handleCanvasClick"></canvas>
</template>

<script setup>
const handleCanvasClick = (e) => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');

  // ❌ 错误：直接使用e.clientX/Y，未转换坐标
  ctx.fillRect(e.clientX, e.clientY, 10, 10);
};
</script>
```

#### ✅ 正确用法：正确转换Canvas坐标
```vue
<template>
  <div ref="containerRef" class="canvas-container">
    <canvas
      ref="canvasRef"
      @click="handleCanvasClick"
      @mousedown="handleMouseDown"
      @mousemove="handleMouseMove"
      @mouseup="handleMouseUp"
    ></canvas>
  </div>
</template>

<script setup>
import { ref, reactive } from 'vue';

const canvasRef = ref(null);
const containerRef = ref(null);

// 绘图状态
const drawingState = reactive({
  isDrawing: false,
  drawMode: 'line', // line, polygon, rect
  points: [],
  currentLine: null,
  currentArea: null
});

// ✅ 正确：转换Canvas坐标
const getCanvasCoordinates = (event) => {
  const canvas = canvasRef.value;
  const rect = canvas.getBoundingClientRect();

  // 计算相对于Canvas的坐标
  const x = (event.clientX - rect.left) * (canvas.width / rect.width);
  const y = (event.clientY - rect.top) * (canvas.height / rect.height);

  return { x, y };
};

// 绘制过线检测线
const handleDrawLine = (startPoint, endPoint) => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');

  ctx.beginPath();
  ctx.strokeStyle = '#ef4444';
  ctx.lineWidth = 3;
  ctx.setLineDash([5, 5]);
  ctx.moveTo(startPoint.x, startPoint.y);
  ctx.lineTo(endPoint.x, endPoint.y);
  ctx.stroke();
  ctx.setLineDash([]);

  // 绘制方向箭头
  drawArrow(ctx, startPoint, endPoint);
};

// 绘制箭头
const drawArrow = (ctx, from, to) => {
  const headLength = 15;
  const angle = Math.atan2(to.y - from.y, to.x - from.x);

  ctx.beginPath();
  ctx.moveTo(to.x, to.y);
  ctx.lineTo(
    to.x - headLength * Math.cos(angle - Math.PI / 6),
    to.y - headLength * Math.sin(angle - Math.PI / 6)
  );
  ctx.moveTo(to.x, to.y);
  ctx.lineTo(
    to.x - headLength * Math.cos(angle + Math.PI / 6),
    to.y - headLength * Math.sin(angle + Math.PI / 6)
  );
  ctx.strokeStyle = '#ef4444';
  ctx.lineWidth = 3;
  ctx.stroke();
};

// 绘制多边形区域
const handleDrawPolygon = (points) => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');

  if (points.length < 3) return;

  ctx.beginPath();
  ctx.fillStyle = 'rgba(34, 197, 94, 0.3)';
  ctx.strokeStyle = '#22c55e';
  ctx.lineWidth = 2;

  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) {
    ctx.lineTo(points[i].x, points[i].y);
  }
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  // 绘制顶点
  points.forEach(point => {
    ctx.beginPath();
    ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
    ctx.fillStyle = '#22c55e';
    ctx.fill();
  });
};

// 鼠标事件处理
const handleMouseDown = (e) => {
  const coords = getCanvasCoordinates(e);
  drawingState.isDrawing = true;

  if (drawingState.drawMode === 'line') {
    drawingState.points = [coords];
  } else if (drawingState.drawMode === 'polygon') {
    drawingState.points.push(coords);
  }
};

const handleMouseMove = (e) => {
  if (!drawingState.isDrawing) return;

  const coords = getCanvasCoordinates(e);
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');

  // 清除并重绘
  redrawCanvas();

  if (drawingState.drawMode === 'line' && drawingState.points.length === 1) {
    // 绘制临时线条
    ctx.beginPath();
    ctx.strokeStyle = '#ef4444';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.moveTo(drawingState.points[0].x, drawingState.points[0].y);
    ctx.lineTo(coords.x, coords.y);
    ctx.stroke();
    ctx.setLineDash([]);
  }
};

const handleMouseUp = (e) => {
  const coords = getCanvasCoordinates(e);

  if (drawingState.drawMode === 'line' && drawingState.points.length === 1) {
    drawingState.points.push(coords);
    handleDrawLine(drawingState.points[0], drawingState.points[1]);

    // 保存线条数据
    saveLineData(drawingState.points);
    drawingState.points = [];
  }

  drawingState.isDrawing = false;
};

const handleCanvasClick = (e) => {
  const coords = getCanvasCoordinates(e);

  if (drawingState.drawMode === 'polygon') {
    drawingState.points.push(coords);
    redrawCanvas();
    handleDrawPolygon(drawingState.points);
  }
};

// 保存线条/区域数据
const saveLineData = (points) => {
  const lineData = {
    id: Date.now(),
    type: 'crossing_line',
    startX: points[0].x,
    startY: points[0].y,
    endX: points[1].x,
    endY: points[1].y,
    direction: 'bidirectional', // bidirectional, in, out
    color: '#ef4444'
  };

  // 发送到后端保存
  crowdApi.saveLineCrossingConfig({
    channelId: selectedChannel.value.id,
    lines: [lineData]
  });
};

const redrawCanvas = () => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // 重绘已有的线条和区域
  // ...
};
</script>

<style scoped lang="less">
.canvas-container {
  position: relative;
  width: 100%;
  height: 600px;
  background: #1a1a1a;
  border-radius: 8px;
  overflow: hidden;

  canvas {
    cursor: crosshair;
    width: 100%;
    height: 100%;
  }
}
</style>
```

### 2. 人群密度等级配置注意事项

#### ❌ 错误用法：硬编码密度等级
```javascript
// 错误：密度等级硬编码，不灵活
const getDensityLevel = (count) => {
  if (count > 80) return '超高密度';
  if (count > 50) return '高密度';
  if (count > 20) return '中密度';
  return '低密度';
};
```

#### ✅ 正确用法：配置化密度等级系统
```javascript
// src/utils/crowd-calculator.js
export const DensityLevels = {
  LOW: {
    level: 1,
    name: '低密度',
    label: 'low',
    color: '#4caf50',
    bgColor: 'rgba(76, 175, 80, 0.1)',
    range: [0, 20],
    description: '0-20人/100m²',
    status: '正常',
    statusColor: 'success',
    alertEnabled: false
  },
  MEDIUM: {
    level: 2,
    name: '中密度',
    label: 'medium',
    color: '#ff9800',
    bgColor: 'rgba(255, 152, 0, 0.1)',
    range: [21, 50],
    description: '21-50人/100m²',
    status: '关注',
    statusColor: 'warning',
    alertEnabled: false
  },
  HIGH: {
    level: 3,
    name: '高密度',
    label: 'high',
    color: '#ff5722',
    bgColor: 'rgba(255, 87, 34, 0.1)',
    range: [51, 80],
    description: '51-80人/100m²',
    status: '预警',
    statusColor: 'warning',
    alertEnabled: true
  },
  CRITICAL: {
    level: 4,
    name: '超高密度',
    label: 'critical',
    color: '#f44336',
    bgColor: 'rgba(244, 67, 54, 0.1)',
    range: [81, Infinity],
    description: '>80人/100m²',
    status: '告警',
    statusColor: 'error',
    alertEnabled: true
  }
};

// 根据人数计算密度等级
export const calculateDensityLevel = (count, area = 100) => {
  const density = (count / area) * 100; // 归一化到100m²

  for (const [key, level] of Object.entries(DensityLevels)) {
    const [min, max] = level.range;
    if (density >= min && density <= max) {
      return {
        ...level,
        actualCount: count,
        actualDensity: density.toFixed(2)
      };
    }
  }

  return DensityLevels.LOW;
};

// 生成密度热力图颜色
export const getDensityColor = (count, maxCount = 100) => {
  const ratio = count / maxCount;

  if (ratio > 0.8) return DensityLevels.CRITICAL.color;
  if (ratio > 0.5) return DensityLevels.HIGH.color;
  if (ratio > 0.2) return DensityLevels.MEDIUM.color;
  return DensityLevels.LOW.color;
};

// 密度梯度配色方案
export const DensityGradient = [
  { offset: 0, color: 'rgba(76, 175, 80, 0.5)' },   // 绿色 - 低密度
  { offset: 0.2, color: 'rgba(139, 195, 74, 0.5)' }, // 浅绿
  { offset: 0.4, color: 'rgba(255, 235, 59, 0.6)' }, // 黄色 - 中密度
  { offset: 0.6, color: 'rgba(255, 152, 0, 0.7)' },  // 橙色 - 高密度
  { offset: 0.8, color: 'rgba(255, 87, 34, 0.8)' },  // 深橙
  { offset: 1, color: 'rgba(244, 67, 54, 0.9)' }     // 红色 - 超高密度
];
```

### 3. 图标使用注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import {
  CrowdOutlined,        // ❌ 不存在
  DensityOutlined,      // ❌ 不存在
  QueueOutlined         // ❌ 不存在
} from '@ant-design/icons-vue';
</script>
```

#### ✅ 正确：使用实际存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  TeamOutlined,             // ✅ 人群/团队图标
  UsergroupAddOutlined,     // ✅ 人群添加
  UserOutlined,             // ✅ 单人图标
  WalkingOutlined,          // ✅ 行走图标（可能不存在，用UserOutlined代替）
  EnvironmentOutlined,      // ✅ 位置/区域
  DashboardOutlined,        // ✅ 仪表盘/密度
  LineChartOutlined,        // ✅ 折线图/趋势
  AreaChartOutlined,        // ✅ 区域图/热力图
  BarChartOutlined,         // ✅ 柱状图/统计
  FireOutlined,             // ✅ 热力/告警
  BellOutlined,             // ✅ 告警/通知
  WarningOutlined,          // ✅ 警告
  ExclamationCircleOutlined, // ✅ 感叹号/告警
  ClockCircleOutlined,      // ✅ 时间/计划
  CalendarOutlined,         // ✅ 日历/计划
  SettingOutlined,          // ✅ 设置
  EyeOutlined,              // ✅ 查看
  CameraOutlined,           // ✅ 摄像机
  VideoCameraOutlined,      // ✅ 视频
  PlayCircleOutlined,       // ✅ 播放
  PauseCircleOutlined,      // ✅ 暂停
  ReloadOutlined,           // ✅ 刷新
  DownloadOutlined,         // ✅ 导出
  FilterOutlined,           // ✅ 筛选
  DeleteOutlined,           // ✅ 删除
  EditOutlined,             // ✅ 编辑
  PlusOutlined,             // ✅ 添加
  BorderOutlined,           // ✅ 区域边框
  DragOutlined,             // ✅ 拖拽
  FullscreenOutlined,       // ✅ 全屏
} from '@ant-design/icons-vue';
</script>

<template>
  <!-- 统计卡片图标示例 -->
  <a-card>
    <template #extra>
      <TeamOutlined :style="{ fontSize: '24px', color: '#1890ff' }" />
    </template>
    <a-statistic title="今日过线人数" :value="1234">
      <template #prefix>
        <UserOutlined />
      </template>
    </a-statistic>
  </a-card>

  <!-- 功能按钮图标示例 -->
  <a-space>
    <a-button type="primary">
      <template #icon><BorderOutlined /></template>
      视频划线
    </a-button>
    <a-button>
      <template #icon><ReloadOutlined /></template>
      刷新数据
    </a-button>
    <a-button>
      <template #icon><DownloadOutlined /></template>
      导出报表
    </a-button>
  </a-space>

  <!-- 告警级别图标 -->
  <a-space>
    <ExclamationCircleOutlined :style="{ color: '#f5222d', fontSize: '18px' }" />
    <WarningOutlined :style="{ color: '#fa8c16', fontSize: '18px' }" />
    <FireOutlined :style="{ color: '#ff4d4f', fontSize: '18px' }" />
  </a-space>
</template>
```

### 4. ECharts人流趋势图配置

#### ✅ 正确：24小时人流趋势图
```javascript
// src/utils/echarts-crowd-config.js
export const createCrowdTrendOption = (data, config = {}) => {
  const {
    title = '24小时人流量趋势',
    xAxisData = [],
    seriesData = [],
    threshold = 100 // 告警阈值
  } = config;

  return {
    title: {
      text: title,
      left: 'center',
      textStyle: {
        fontSize: 16,
        color: '#333',
        fontWeight: 500
      }
    },
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross',
        label: {
          backgroundColor: '#6a7985'
        }
      },
      formatter: (params) => {
        const data = params[0];
        return `${data.name}<br/>人流量: ${data.value}人`;
      }
    },
    legend: {
      data: ['人流量', '告警阈值'],
      top: 30
    },
    grid: {
      left: 60,
      right: 40,
      top: 80,
      bottom: 60,
      containLabel: true
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: xAxisData,
      axisLabel: {
        color: '#666',
        fontSize: 12
      }
    },
    yAxis: {
      type: 'value',
      name: '人数',
      axisLabel: {
        color: '#666',
        fontSize: 12,
        formatter: '{value}人'
      },
      splitLine: {
        lineStyle: {
          type: 'dashed',
          color: '#e0e0e0'
        }
      }
    },
    series: [
      {
        name: '人流量',
        type: 'line',
        smooth: true,
        data: seriesData,
        areaStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [
              { offset: 0, color: 'rgba(24, 144, 255, 0.3)' },
              { offset: 1, color: 'rgba(24, 144, 255, 0.05)' }
            ]
          }
        },
        lineStyle: {
          color: '#1890ff',
          width: 2
        },
        itemStyle: {
          color: '#1890ff'
        },
        emphasis: {
          focus: 'series'
        },
        markPoint: {
          data: [
            { type: 'max', name: '最大值' },
            { type: 'min', name: '最小值' }
          ]
        },
        markLine: {
          silent: true,
          lineStyle: {
            color: '#ff4d4f',
            type: 'dashed',
            width: 2
          },
          data: [
            {
              yAxis: threshold,
              label: {
                show: true,
                position: 'end',
                formatter: '告警阈值: {c}人',
                color: '#ff4d4f'
              }
            }
          ]
        }
      }
    ]
  };
};

// 多区域对比柱状图
export const createMultiAreaCompareOption = (data, config = {}) => {
  const {
    title = '各区域人流对比',
    xAxisData = [],
    seriesData = []
  } = config;

  return {
    title: {
      text: title,
      left: 'center'
    },
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      }
    },
    legend: {
      data: ['当前人数', '平均人数', '峰值人数'],
      top: 30
    },
    grid: {
      left: 60,
      right: 40,
      top: 80,
      bottom: 40
    },
    xAxis: {
      type: 'category',
      data: xAxisData,
      axisLabel: {
        interval: 0,
        rotate: 30
      }
    },
    yAxis: {
      type: 'value',
      name: '人数',
      axisLabel: {
        formatter: '{value}人'
      }
    },
    series: [
      {
        name: '当前人数',
        type: 'bar',
        data: seriesData.current,
        itemStyle: {
          color: '#1890ff'
        }
      },
      {
        name: '平均人数',
        type: 'bar',
        data: seriesData.average,
        itemStyle: {
          color: '#52c41a'
        }
      },
      {
        name: '峰值人数',
        type: 'bar',
        data: seriesData.peak,
        itemStyle: {
          color: '#ff4d4f'
        }
      }
    ]
  };
};
```

### 5. 实时数据更新机制

#### ✅ 正确：使用轮询或WebSocket更新数据
```javascript
// src/hooks/useCrowdData.js
import { ref, onMounted, onUnmounted } from 'vue';
import { crowdApi } from '/@/api/business/smart-video/crowd-api';

export const useCrowdRealTimeData = (channelId, options = {}) => {
  const {
    interval = 3000, // 3秒更新一次
    autoStart = true
  } = options;

  const realtimeData = ref({
    todayCrossCount: 0,
    avgQueueLength: 0,
    currentDensity: 'low',
    alarmCount: 0
  });

  const loading = ref(false);
  const error = ref(null);
  let timer = null;

  // 获取实时数据
  const fetchRealtimeData = async () => {
    if (!channelId.value) return;

    try {
      loading.value = true;
      error.value = null;

      const [lineData, queueData, densityData, alarmData] = await Promise.all([
        crowdApi.getLineCrossingRealtime(channelId.value),
        crowdApi.getQueueRealtime(channelId.value),
        crowdApi.getDensityHeatmapData(channelId.value),
        crowdApi.getCrowdAlarms({ channelId: channelId.value, status: 'active' })
      ]);

      realtimeData.value = {
        todayCrossCount: lineData.data?.todayCount || 0,
        avgQueueLength: queueData.data?.avgLength || 0,
        currentDensity: densityData.data?.level || 'low',
        alarmCount: alarmData.data?.total || 0,
        trendData: lineData.data?.trendData || [],
        queueAreas: queueData.data?.areas || [],
        densityLevel: densityData.data?.densityLevel || {}
      };
    } catch (err) {
      error.value = err.message;
      console.error('获取实时数据失败:', err);
    } finally {
      loading.value = false;
    }
  };

  // 启动轮询
  const startPolling = () => {
    if (timer) return;

    fetchRealtimeData(); // 立即获取一次
    timer = setInterval(fetchRealtimeData, interval);
  };

  // 停止轮询
  const stopPolling = () => {
    if (timer) {
      clearInterval(timer);
      timer = null;
    }
  };

  // 刷新数据
  const refresh = () => {
    fetchRealtimeData();
  };

  onMounted(() => {
    if (autoStart) {
      startPolling();
    }
  });

  onUnmounted(() => {
    stopPolling();
  });

  return {
    realtimeData,
    loading,
    error,
    startPolling,
    stopPolling,
    refresh
  };
};
```

## 核心功能实现

### 1. 过线统计功能

#### 主页面组件结构
```vue
<!-- src/views/business/smart-video/crowd-situational.vue -->
<template>
  <div class="crowd-situational-page">
    <!-- 头部工具栏 -->
    <div class="page-header">
      <a-page-header
        title="人群态势分析"
        :sub-title="selectedDevice?.name || '请选择摄像头'"
      >
        <template #extra>
          <a-space>
            <a-button @click="handleRefresh">
              <template #icon><ReloadOutlined /></template>
              刷新数据
            </a-button>
            <a-button @click="handleExport">
              <template #icon><DownloadOutlined /></template>
              导出报表
            </a-button>
          </a-space>
        </template>
      </a-page-header>
    </div>

    <div class="page-content">
      <!-- 左侧设备树 -->
      <div class="device-sidebar">
        <a-input-search
          v-model:value="deviceSearch"
          placeholder="搜索设备..."
          class="search-input"
        />
        <a-tree
          v-model:selected-keys="selectedKeys"
          :tree-data="deviceTreeData"
          :field-names="{ title: 'name', key: 'id', children: 'children' }"
          @select="handleDeviceSelect"
        >
          <template #title="{ name, online }">
            <span>
              <CameraOutlined v-if="online" style="color: #52c41a" />
              <CameraOutlined v-else style="color: #ccc" />
              {{ name }}
            </span>
          </template>
        </a-tree>
      </div>

      <!-- 主内容区 -->
      <div class="main-content">
        <!-- Tab栏 -->
        <a-tabs v-model:active-key="activeTab" class="crowd-tabs">
          <a-tab-pane key="lineCrossing" tab="过线统计">
            <template #tab>
              <span><UserOutlined /> 过线统计</span>
            </template>
            <LineCrossingPanel
              :channel-id="selectedDevice?.id"
              @config-change="handleConfigChange"
            />
          </a-tab-pane>

          <a-tab-pane key="queueLength" tab="排队长度">
            <template #tab>
              <span><TeamOutlined /> 排队长度</span>
            </template>
            <QueueMonitorPanel
              :channel-id="selectedDevice?.id"
              @config-change="handleConfigChange"
            />
          </a-tab-pane>

          <a-tab-pane key="populationDensity" tab="人群密度">
            <template #tab>
              <span><DashboardOutlined /> 人群密度</span>
            </template>
            <DensityMonitorPanel
              :channel-id="selectedDevice?.id"
              @config-change="handleConfigChange"
            />
          </a-tab-pane>
        </a-tabs>

        <!-- 统计概览 -->
        <div class="statistics-overview">
          <a-row :gutter="16">
            <a-col :span="6">
              <a-card>
                <a-statistic
                  title="今日过线人数"
                  :value="realtimeData.todayCrossCount"
                  :value-style="{ color: '#1890ff' }"
                >
                  <template #prefix>
                    <UserOutlined />
                  </template>
                </a-statistic>
              </a-card>
            </a-col>
            <a-col :span="6">
              <a-card>
                <a-statistic
                  title="平均排队长度"
                  :value="realtimeData.avgQueueLength"
                  :precision="1"
                  :value-style="{ color: '#52c41a' }"
                >
                  <template #prefix>
                    <TeamOutlined />
                  </template>
                </a-statistic>
              </a-card>
            </a-col>
            <a-col :span="6">
              <a-card>
                <a-statistic
                  title="当前人群密度"
                  :value="getDensityLabel(realtimeData.currentDensity)"
                  :value-style="{ color: getDensityColor(realtimeData.currentDensity) }"
                >
                  <template #prefix>
                    <DashboardOutlined />
                  </template>
                </a-statistic>
              </a-card>
            </a-col>
            <a-col :span="6">
              <a-card>
                <a-statistic
                  title="告警次数"
                  :value="realtimeData.alarmCount"
                  :value-style="{ color: '#ff4d4f' }"
                >
                  <template #prefix>
                    <BellOutlined />
                  </template>
                </a-statistic>
              </a-card>
            </a-col>
          </a-row>
        </div>
      </div>

      <!-- 右侧视频预览和统计 -->
      <div class="right-sidebar">
        <!-- 视频预览 -->
        <a-card title="视频预览" :bordered="false" class="video-card">
          <div class="video-preview">
            <video-player
              v-if="selectedDevice"
              :channel-id="selectedDevice.id"
              :show-controls="true"
            />
            <a-empty v-else description="请选择摄像头" />
          </div>
        </a-card>

        <!-- 实时统计 -->
        <a-card title="实时统计" :bordered="false" class="stats-card">
          <div class="real-time-stats">
            <div class="stat-item">
              <span class="stat-label">当前时段人流量</span>
              <span class="stat-value">156人</span>
              <a-progress :percent="65" :show-info="false" />
            </div>
            <div class="stat-item">
              <span class="stat-label">平均等待时间</span>
              <span class="stat-value">3.5分钟</span>
              <a-progress :percent="35" :show-info="false" status="active" />
            </div>
            <div class="stat-item">
              <span class="stat-label">设备利用率</span>
              <span class="stat-value">78%</span>
              <a-progress :percent="78" :show-info="false" stroke-color="#52c41a" />
            </div>
          </div>
        </a-card>

        <!-- 24小时趋势 -->
        <a-card title="24小时趋势" :bordered="false" class="trend-card">
          <trend-chart
            :data="realtimeData.trendData"
            :height="200"
          />
        </a-card>

        <!-- 最新告警 -->
        <a-card title="最新告警" :bordered="false" class="alarm-card">
          <a-list
            :data-source="recentAlarms"
            size="small"
          >
            <template #renderItem="{ item }">
              <a-list-item>
                <a-list-item-meta>
                  <template #avatar>
                    <ExclamationCircleOutlined
                      :style="{
                        color: getAlarmColor(item.level),
                        fontSize: '18px'
                      }"
                    />
                  </template>
                  <template #title>{{ item.title }}</template>
                  <template #description>{{ item.description }}</template>
                </a-list-item-meta>
              </a-list-item>
            </template>
          </a-list>
        </a-card>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, watch } from 'vue';
import {
  UserOutlined,
  TeamOutlined,
  DashboardOutlined,
  BellOutlined,
  CameraOutlined,
  ReloadOutlined,
  DownloadOutlined,
  ExclamationCircleOutlined
} from '@ant-design/icons-vue';
import LineCrossingPanel from './components/LineCrossingPanel.vue';
import QueueMonitorPanel from './components/QueueMonitorPanel.vue';
import DensityMonitorPanel from './components/DensityMonitorPanel.vue';
import TrendChart from './components/TrendChart.vue';
import { useCrowdRealTimeData } from './hooks/useCrowdData';
import { DensityLevels } from './utils/crowd-calculator';
import { crowdApi } from '/@/api/business/smart-video/crowd-api';

// 状态管理
const activeTab = ref('lineCrossing');
const selectedDevice = ref(null);
const selectedKeys = ref([]);
const deviceSearch = ref('');

// 设备树数据
const deviceTreeData = ref([]);

// 实时数据
const { realtimeData, refresh } = useCrowdRealTimeData(
  computed(() => selectedDevice.value?.id),
  { interval: 3000, autoStart: true }
);

// 最新告警
const recentAlarms = ref([]);

// 方法
const handleDeviceSelect = (keys, { node }) => {
  selectedDevice.value = node;
  loadDeviceConfig(node.id);
};

const handleRefresh = () => {
  refresh();
  message.success('数据已刷新');
};

const handleExport = async () => {
  try {
    const params = {
      channelId: selectedDevice.value?.id,
      startTime: dayjs().startOf('day').format('YYYY-MM-DD HH:mm:ss'),
      endTime: dayjs().endOf('day').format('YYYY-MM-DD HH:mm:ss')
    };

    const blob = await crowdApi.exportCrowdReport(params);
    // 下载文件
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `人群态势报表_${dayjs().format('YYYYMMDD')}.xlsx`;
    link.click();
    window.URL.revokeObjectURL(url);

    message.success('报表导出成功');
  } catch (err) {
    message.error('报表导出失败');
  }
};

const getDensityLabel = (level) => {
  return DensityLevels[level?.toUpperCase()]?.name || '未知';
};

const getDensityColor = (level) => {
  return DensityLevels[level?.toUpperCase()]?.color || '#999';
};

const getAlarmColor = (level) => {
  const colors = {
    critical: '#f5222d',
    warning: '#fa8c16',
    info: '#1890ff'
  };
  return colors[level] || '#999';
};
</script>

<style scoped lang="less">
.crowd-situational-page {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #f0f2f5;

  .page-header {
    background: #fff;
    border-bottom: 1px solid #e8e8e8;
    padding: 16px 24px;
  }

  .page-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    gap: 16px;
    padding: 16px;

    .device-sidebar {
      width: 260px;
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      overflow-y: auto;

      .search-input {
        margin-bottom: 16px;
      }
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;

      .crowd-tabs {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
      }

      .statistics-overview {
        .ant-card {
          border-radius: 8px;
          transition: all 0.3s;

          &:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
          }
        }
      }
    }

    .right-sidebar {
      width: 380px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;

      .ant-card {
        border-radius: 8px;
      }

      .video-card {
        .video-preview {
          aspect-ratio: 16/9;
          background: #000;
          border-radius: 4px;
          overflow: hidden;
        }
      }

      .stats-card {
        .real-time-stats {
          .stat-item {
            margin-bottom: 16px;

            &:last-child {
              margin-bottom: 0;
            }

            .stat-label {
              display: block;
              font-size: 13px;
              color: #666;
              margin-bottom: 4px;
            }

            .stat-value {
              display: block;
              font-size: 16px;
              font-weight: 500;
              color: #333;
              margin-bottom: 8px;
            }
          }
        }
      }

      .alarm-card {
        .ant-list-item {
          padding: 8px 0;
        }
      }
    }
  }
}
</style>
```

### 2. 过线统计配置面板组件
```vue
<!-- src/views/business/smart-video/components/LineCrossingPanel.vue -->
<template>
  <div class="line-crossing-panel">
    <a-card title="过线统计配置" :bordered="false">
      <!-- 基本参数 -->
      <a-card type="inner" title="基本参数" class="config-section">
        <a-row :gutter="16">
          <a-col :span="8">
            <div class="switch-item">
              <span>过线统计启用</span>
              <a-switch v-model:checked="config.enabled" />
            </div>
          </a-col>
          <a-col :span="8">
            <div class="switch-item">
              <span>零清除</span>
              <a-switch v-model:checked="config.autoClear" />
            </div>
          </a-col>
          <a-col :span="8">
            <a-button type="primary" danger @click="handleClearCount">
              <template #icon><DeleteOutlined /></template>
              统计重置
            </a-button>
          </a-col>
        </a-row>

        <a-row :gutter="16" style="margin-top: 16px">
          <a-col :span="12">
            <a-form-item label="告警检测间隔(秒)">
              <a-input-number
                v-model:value="config.alarmInterval"
                :min="1"
                :max="256"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="告警人数阈值">
              <a-input-number
                v-model:value="config.alarmThreshold"
                :min="1"
                :max="65535"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-card>

      <!-- 声光警戒 -->
      <a-card type="inner" title="声光警戒" class="config-section">
        <a-row :gutter="16">
          <a-col :span="12">
            <div class="alarm-config">
              <div class="alarm-header">
                <span>声音告警</span>
                <a-switch v-model:checked="config.audio.enabled" />
              </div>
              <a-select
                v-model:value="config.audio.file"
                placeholder="选择音频文件"
                style="width: 100%; margin-top: 8px"
                :disabled="!config.audio.enabled"
              >
                <a-select-option value="alarm1.mp3">警报音1</a-select-option>
                <a-select-option value="alarm2.mp3">警报音2</a-select-option>
                <a-select-option value="alarm3.mp3">警报音3</a-select-option>
              </a-select>
              <a-input-number
                v-model:value="config.audio.count"
                placeholder="播放次数"
                :min="1"
                :max="50"
                style="width: 100%; margin-top: 8px"
                :disabled="!config.audio.enabled"
              />
            </div>
          </a-col>
          <a-col :span="12">
            <div class="alarm-config">
              <div class="alarm-header">
                <span>白光灯警戒</span>
                <a-switch v-model:checked="config.light.enabled" />
              </div>
              <a-select
                v-model:value="config.light.frequency"
                placeholder="频闪频率"
                style="width: 100%; margin-top: 8px"
                :disabled="!config.light.enabled"
              >
                <a-select-option value="Low">低频</a-select-option>
                <a-select-option value="Medium">中频</a-select-option>
                <a-select-option value="High">高频</a-select-option>
                <a-select-option value="Steady on">常亮</a-select-option>
              </a-select>
              <a-input-number
                v-model:value="config.light.duration"
                placeholder="闪烁时间(秒)"
                :min="1"
                :max="50"
                style="width: 100%; margin-top: 8px"
                :disabled="!config.light.enabled"
              />
            </div>
          </a-col>
        </a-row>
      </a-card>

      <!-- 检测区域设置 -->
      <a-card type="inner" title="检测区域设置" class="config-section">
        <div class="area-controls">
          <a-space>
            <a-button type="primary" @click="handleDrawLine">
              <template #icon><BorderOutlined /></template>
              视频划线
            </a-button>
            <a-button danger @click="handleClearLines">
              <template #icon><DeleteOutlined /></template>
              清除线条
            </a-button>
          </a-space>
          <a-radio-group v-model:value="lineDrawn" disabled>
            <a-radio :value="1">已划线</a-radio>
            <a-radio :value="0">未划线</a-radio>
          </a-radio-group>
        </div>

        <!-- 过线记录列表 -->
        <a-table
          :columns="recordColumns"
          :data-source="crossRecords"
          :pagination="false"
          size="small"
          style="margin-top: 16px"
        >
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'action'">
              <a-button type="link" size="small" @click="viewDetail(record)">
                <EyeOutlined /> 查看
              </a-button>
            </template>
          </template>
        </a-table>
      </a-card>

      <!-- 时间计划设置 -->
      <a-card type="inner" title="时间计划设置" class="config-section">
        <div class="time-plan-controls">
          <a-space>
            <a-button @click="handleAddTimePlan">
              <template #icon><PlusOutlined /></template>
              新增
            </a-button>
            <a-button danger @click="handleClearTimePlans">
              <template #icon><DeleteOutlined /></template>
              删除全部
            </a-button>
          </a-space>
        </div>

        <time-plan-table
          v-model:data="config.timePlans"
          style="margin-top: 16px"
        />
      </a-card>

      <!-- 操作按钮 -->
      <div class="action-buttons">
        <a-space>
          <a-button @click="handleReset">重置</a-button>
          <a-button type="primary" @click="handleSave" :loading="saving">
            保存配置
          </a-button>
        </a-space>
      </div>
    </a-card>

    <!-- 视频划线弹窗 -->
    <VideoDrawingModal
      v-model:visible="drawingVisible"
      :channel-id="channelId"
      mode="line"
      @save="handleSaveDrawing"
    />
  </div>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message, Modal } from 'ant-design-vue';
import {
  DeleteOutlined,
  BorderOutlined,
  PlusOutlined,
  EyeOutlined
} from '@ant-design/icons-vue';
import VideoDrawingModal from './VideoDrawingModal.vue';
import TimePlanTable from './TimePlanTable.vue';
import { crowdApi } from '/@/api/business/smart-video/crowd-api';

const props = defineProps({
  channelId: String
});

const emit = defineEmits(['config-change']);

// 配置数据
const config = reactive({
  enabled: true,
  autoClear: false,
  alarmInterval: 1,
  alarmThreshold: 10,
  audio: {
    enabled: false,
    file: '',
    count: 1
  },
  light: {
    enabled: false,
    frequency: 'Medium',
    duration: 5
  },
  timePlans: []
});

const lineDrawn = ref(0);
const crossRecords = ref([]);
const drawingVisible = ref(false);
const saving = ref(false);

// 表格列定义
const recordColumns = [
  { title: '时间', dataIndex: 'time', key: 'time' },
  { title: '方向', dataIndex: 'direction', key: 'direction' },
  { title: '人数', dataIndex: 'count', key: 'count' },
  { title: '操作', key: 'action', width: 100 }
];

// 加载配置
const loadConfig = async () => {
  if (!props.channelId) return;

  try {
    const res = await crowdApi.getLineCrossingConfig(props.channelId);
    Object.assign(config, res.data);
  } catch (err) {
    message.error('加载配置失败');
  }
};

// 保存配置
const handleSave = async () => {
  saving.value = true;
  try {
    await crowdApi.saveLineCrossingConfig({
      channelId: props.channelId,
      ...config
    });
    message.success('配置保存成功');
    emit('config-change', config);
  } catch (err) {
    message.error('配置保存失败');
  } finally {
    saving.value = false;
  }
};

// 清除统计
const handleClearCount = () => {
  Modal.confirm({
    title: '确认清除',
    content: '确定要清除过线统计数据吗？',
    onOk: async () => {
      try {
        await crowdApi.clearLineCrossingCount(props.channelId);
        message.success('统计数据已清除');
      } catch (err) {
        message.error('清除失败');
      }
    }
  });
};

// 绘制线条
const handleDrawLine = () => {
  drawingVisible.value = true;
};

// 清除线条
const handleClearLines = () => {
  Modal.confirm({
    title: '确认清除',
    content: '确定要清除所有检测线条吗？',
    onOk: () => {
      lineDrawn.value = 0;
      message.success('线条已清除');
    }
  });
};

// 监听channelId变化
watch(() => props.channelId, () => {
  loadConfig();
}, { immediate: true });
</script>

<style scoped lang="less">
.line-crossing-panel {
  .config-section {
    margin-bottom: 16px;

    &:last-child {
      margin-bottom: 0;
    }
  }

  .switch-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f5f5f5;
    border-radius: 6px;
  }

  .alarm-config {
    padding: 12px;
    background: #f5f5f5;
    border-radius: 6px;

    .alarm-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
  }

  .area-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .time-plan-controls {
    margin-bottom: 16px;
  }

  .action-buttons {
    margin-top: 24px;
    text-align: right;
  }
}
</style>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/crowd-mock-data.js

// 过线统计Mock数据
export const lineCrossingMockData = {
  config: {
    enabled: true,
    autoClear: false,
    alarmInterval: 1,
    alarmThreshold: 10,
    audio: { enabled: false, file: '', count: 1 },
    light: { enabled: false, frequency: 'Medium', duration: 5 },
    lines: [
      { id: 1, startX: 100, startY: 200, endX: 500, endY: 200, direction: 'bidirectional' }
    ],
    timePlans: []
  },
  records: [
    { id: 1, time: '09:15:23', direction: '进入', count: 3 },
    { id: 2, time: '09:12:45', direction: '离开', count: 2 }
  ],
  realtime: {
    todayCount: 1234,
    currentHour: 156,
    trendData: Array.from({ length: 24 }, (_, i) => ({
      time: `${i}:00`,
      count: Math.floor(Math.random() * 200)
    }))
  }
};

// 人群密度Mock数据
export const densityMockData = {
  config: {
    enabled: true,
    alarmInterval: 10,
    alarmThreshold: 50,
    sensitivity: 3,
    areas: [
      {
        id: 1,
        name: '区域A - 主入口',
        points: [{ x: 50, y: 50 }, { x: 250, y: 50 }, { x: 250, y: 200 }, { x: 50, y: 200 }],
        area: 100,
        maxCapacity: 100
      }
    ]
  },
  realtime: {
    level: 'medium',
    count: 35,
    heatmapData: Array.from({ length: 50 }, () => ({
      x: Math.random() * 800,
      y: Math.random() * 600,
      value: Math.random() * 100,
      radius: 30 + Math.random() * 20
    }))
  },
  statistics: {
    low: 45,
    medium: 35,
    high: 15,
    critical: 5
  }
};

// 告警Mock数据
export const alarmMockData = [
  {
    id: 1,
    level: 'critical',
    title: '人群密度过高',
    description: '区域A - 5分钟前',
    time: '2024-01-15 14:35:00',
    handled: false
  },
  {
    id: 2,
    level: 'warning',
    title: '排队长度超限',
    description: '区域2 - 8分钟前',
    time: '2024-01-15 14:32:00',
    handled: false
  }
];
```

## 路由配置

```javascript
// src/router/modules/business/smart-video.js
export default {
  path: '/smart-video',
  name: 'SmartVideo',
  component: () => import('/@/layout/default-layout.vue'),
  meta: {
    title: '智能视频',
    icon: 'VideoCameraOutlined'
  },
  children: [
    {
      path: 'crowd-situational',
      name: 'CrowdSituational',
      component: () => import('/@/views/business/smart-video/crowd-situational.vue'),
      meta: {
        title: '人群态势分析',
        icon: 'TeamOutlined',
        keepAlive: true
      }
    }
  ]
};
```

## 菜单配置

```javascript
// 在SmartAdmin的菜单管理中添加
{
  menuName: '人群态势分析',
  menuType: 1, // 菜单类型
  parentId: 智能视频模块ID,
  path: '/smart-video/crowd-situational',
  component: 'business/smart-video/crowd-situational',
  icon: 'TeamOutlined',
  sort: 3,
  visible: true,
  perms: 'smart-video:crowd:view'
}
```

## 开发检查清单

### 功能实现
- [ ] 过线统计功能（划线、统计、告警）
- [ ] 排队长度监控（区域绘制、实时监控）
- [ ] 人群密度检测（热力图、密度分级）
- [ ] 声光警戒配置
- [ ] 时间计划管理
- [ ] 实时数据更新（轮询或WebSocket）
- [ ] 告警通知与处理
- [ ] 数据导出功能

### 性能优化
- [ ] Canvas绘图性能优化（离屏Canvas、requestAnimationFrame）
- [ ] ECharts图表按需加载
- [ ] 大数据量分页或虚拟滚动
- [ ] 图片/视频懒加载
- [ ] 防抖/节流处理

### 用户体验
- [ ] 加载状态提示
- [ ] 错误提示友好
- [ ] 操作确认（删除、重置等）
- [ ] 响应式布局适配
- [ ] 快捷键支持

### 代码质量
- [ ] TypeScript类型定义
- [ ] 组件props验证
- [ ] 错误边界处理
- [ ] 单元测试覆盖
- [ ] 代码注释完整

---

**文档版本**: v1.0
**最后更新**: 2024-01-15
**维护人员**: 开发团队
