# IOE-DREAM å¾®æœåŠ¡æ¶æ„è¿ç»´äº¤æ¥æ‰‹å†Œ

## ğŸ“‹ äº¤æ¥åŸºæœ¬ä¿¡æ¯

**æ‰‹å†Œç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´11æœˆ29æ—¥
**äº¤æ¥çŠ¶æ€**: å¾…éªŒæ”¶
**é€‚ç”¨ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€å¼€å‘ç¯å¢ƒ

---

## ğŸ¯ äº¤æ¥ç›®æ ‡

### 1. è¿ç»´èƒ½åŠ›ä¼ é€’
- æŒæ¡å¾®æœåŠ¡æ¶æ„çš„è¿ç»´ç†å¿µå’Œæ–¹æ³•
- å…·å¤‡ç‹¬ç«‹éƒ¨ç½²å’Œç»´æŠ¤å¾®æœåŠ¡ç³»ç»Ÿçš„èƒ½åŠ›
- èƒ½å¤Ÿè¿›è¡Œç³»ç»Ÿç›‘æ§å’Œæ•…éšœè¯Šæ–­
- æŒæ¡æ€§èƒ½è°ƒä¼˜å’Œå®¹é‡è§„åˆ’æŠ€èƒ½

### 2. è¿ç»´æµç¨‹å»ºç«‹
- å»ºç«‹æ ‡å‡†åŒ–çš„è¿ç»´æ“ä½œæµç¨‹
- åˆ¶å®šåº”æ€¥é¢„æ¡ˆå’Œæ•…éšœå¤„ç†æœºåˆ¶
- å»ºç«‹å˜æ›´ç®¡ç†å’Œå‘å¸ƒæµç¨‹
- å®Œå–„ç›‘æ§å‘Šè­¦å’Œæ—¥å¿—åˆ†æä½“ç³»

### 3. è¿ç»´å·¥å…·æŒæ¡
- ç†Ÿç»ƒä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²å·¥å…·
- æŒæ¡ç›‘æ§å‘Šè­¦ç³»ç»Ÿé…ç½®
- ç†Ÿæ‚‰æ—¥å¿—ç®¡ç†å’Œåˆ†æå·¥å…·
- äº†è§£è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬ä½¿ç”¨

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1. éƒ¨ç½²æ¶æ„

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        LB[Nginx/HAProxy<br/>80/443]
    end

    subgraph "APIç½‘å…³å±‚"
        Gateway[smart-gateway<br/>8080]
    end

    subgraph "ä¸šåŠ¡æœåŠ¡å±‚"
        Auth[ioedream-auth-service<br/>8081]
        Identity[ioedream-identity-service<br/>8082]
        Device[ioedream-device-service<br/>8101]
        Access[ioedream-access-service<br/>8102]
        Consume[ioedream-consume-service<br/>8103]
        Visitor[ioedream-visitor-service<br/>8104]
        Attendance[ioedream-attendance-service<br/>8105]
        Video[ioedream-video-service<br/>8106]
        Notification[ioedream-notification-service<br/>8107]
        File[ioedream-file-service<br/>8108]
        Report[ioedream-report-service<br/>8109]
    end

    subgraph "æ”¯æ’‘æœåŠ¡å±‚"
        Audit[ioedream-audit-service<br/>8110]
        Logging[ioedream-logging-service<br/>8111]
        Config[ioedream-config-service<br/>8112]
        Monitor[monitor-service<br/>8300]
        HR[hr-service<br/>8200]
        Analytics[analytics-service<br/>8201]
    end

    subgraph "åŸºç¡€è®¾æ–½å±‚"
        K8s[Kubernetesé›†ç¾¤]
        MySQL[(MySQLé›†ç¾¤)]
        Redis[(Redisé›†ç¾¤)]
        MinIO[(MinIOé›†ç¾¤)]
        RabbitMQ[RabbitMQé›†ç¾¤]
        Consul[Consulé›†ç¾¤]
    end

    subgraph "ç›‘æ§è¿ç»´å±‚"
        Prometheus[Prometheus]
        Grafana[Grafana]
        Jaeger[Jaeger]
        ELK[ELK Stack]
    end

    LB --> Gateway
    Gateway --> Auth
    Gateway --> Identity
    Gateway --> Device
    Gateway --> Access
    Gateway --> Consume
    Gateway --> Visitor
    Gateway --> Attendance
    Gateway --> Video
    Gateway --> Notification
    Gateway --> File
    Gateway --> Report

    Auth --> K8s
    Identity --> K8s
    Device --> K8s
    Access --> K8s
    Consume --> K8s
    Visitor --> K8s
    Attendance --> K8s
    Video --> K8s
    Notification --> K8s
    File --> K8s
    Report --> K8s
    Audit --> K8s
    Logging --> K8s
    Config --> K8s
    Monitor --> K8s
    HR --> K8s
    Analytics --> K8s

    K8s --> MySQL
    K8s --> Redis
    K8s --> MinIO
    K8s --> RabbitMQ
    K8s --> Consul

    Prometheus --> K8s
    Grafana --> Prometheus
    Jaeger --> K8s
    ELK --> K8s
```

### 2. ç¯å¢ƒé…ç½®

#### 2.1 ç¯å¢ƒåˆ†ç±»

| ç¯å¢ƒç±»å‹ | ç”¨é€” | é›†ç¾¤é…ç½® | æ•°æ®éš”ç¦» |
|---------|------|----------|----------|
| å¼€å‘ç¯å¢ƒ(DEV) | å¼€å‘è°ƒè¯• | å•èŠ‚ç‚¹K8s | ç‹¬ç«‹æ•°æ®åº“ |
| æµ‹è¯•ç¯å¢ƒ(TEST) | åŠŸèƒ½æµ‹è¯• | 3èŠ‚ç‚¹K8s | ç‹¬ç«‹æ•°æ®åº“ |
| é¢„ç”Ÿäº§ç¯å¢ƒ(STAGING) | ä¸Šçº¿å‰éªŒè¯ | 5èŠ‚ç‚¹K8s | ç”Ÿäº§æ•°æ®å¤‡ä»½ |
| ç”Ÿäº§ç¯å¢ƒ(PROD) | æ­£å¼è¿è¡Œ | é«˜å¯ç”¨K8s | ç”Ÿäº§æ•°æ®åº“ |

#### 2.2 ç½‘ç»œé…ç½®

```yaml
# ç½‘ç»œè§„åˆ’
network_config:
  # è´Ÿè½½å‡è¡¡å™¨VIP
  vip_frontend: 192.168.1.100/24
  vip_backend: 10.0.0.100/16

  # Kubernetesç½‘ç»œ
  pod_cidr: 10.244.0.0/16
  service_cidr: 10.96.0.0/12
  node_cidr: 10.0.0.0/16

  # æ•°æ®åº“ç½‘ç»œ
  mysql_vip: 10.10.10.100
  redis_vip: 10.10.10.101
  minio_vip: 10.10.10.102
  rabbitmq_vip: 10.10.10.103

  # æœåŠ¡ç«¯å£åˆ†é…
  service_ports:
    gateway: 8080
    auth: 8081
    identity: 8082
    device: 8101
    access: 8102
    consume: 8103
    visitor: 8104
    attendance: 8105
    video: 8106
    notification: 8107
    file: 8108
    report: 8109
    audit: 8110
    logging: 8111
    config: 8112
    monitor: 8300
    hr: 8200
    analytics: 8201
```

---

## ğŸ”§ éƒ¨ç½²æŒ‡å—

### 1. åŸºç¡€è®¾æ–½éƒ¨ç½²

#### 1.1 Kubernetesé›†ç¾¤éƒ¨ç½²

**MasterèŠ‚ç‚¹éƒ¨ç½²**:
```bash
# 1. å®‰è£…Docker
curl -fsSL https://get.docker.com | sh
systemctl enable docker
systemctl start docker

# 2. å®‰è£…kubeadmã€kubeletã€kubectl
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF

yum install -y kubelet kubeadm kubectl
systemctl enable kubelet

# 3. åˆå§‹åŒ–MasterèŠ‚ç‚¹
kubeadm init --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12

# 4. é…ç½®kubectl
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# 5. å®‰è£…ç½‘ç»œæ’ä»¶ï¼ˆFlannelï¼‰
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

# 6. å…è®¸MasterèŠ‚ç‚¹è°ƒåº¦Podï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
kubectl taint nodes --all node-role.kubernetes.io/master-
```

**WorkerèŠ‚ç‚¹åŠ å…¥**:
```bash
# åœ¨WorkerèŠ‚ç‚¹æ‰§è¡Œ
kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash <hash>
```

#### 1.2 å­˜å‚¨éƒ¨ç½²

**æŒä¹…åŒ–å­˜å‚¨é…ç½®**:
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
  namespace: ioedream
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: nfs
  nfs:
    server: nfs-server
    path: /data/mysql
```

**StorageClassé…ç½®**:
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
provisioner: nfs.csi.k8s.io
parameters:
  server: nfs-server
  share: /data
reclaimPolicy: Retain
allowVolumeExpansion: true
```

### 2. ä¸­é—´ä»¶éƒ¨ç½²

#### 2.1 MySQLé›†ç¾¤éƒ¨ç½²

**MySQL Masteré…ç½®**:
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-master
  namespace: ioedream
spec:
  serviceName: mysql-master
  replicas: 1
  selector:
    matchLabels:
      app: mysql-master
  template:
    metadata:
      labels:
        app: mysql-master
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "ioedream@2025"
        - name: MYSQL_DATABASE
          value: "ioedream"
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-config
  volumeClaimTemplates:
  - metadata:
      name: mysql-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 50Gi
      storageClassName: nfs-storage
```

**MySQLé…ç½®**:
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: ioedream
data:
  my.cnf: |
    [mysqld]
    # åŸºæœ¬é…ç½®
    server-id = 1
    bind-address = 0.0.0.0
    port = 3306

    # å­—ç¬¦é›†é…ç½®
    character-set-server = utf8mb4
    collation-server = utf8mb4_unicode_ci

    # æ€§èƒ½é…ç½®
    innodb_buffer_pool_size = 2G
    innodb_log_file_size = 256M
    innodb_log_buffer_size = 16M
    max_connections = 1000

    # ä¸»ä»å¤åˆ¶é…ç½®
    log-bin = mysql-bin
    binlog-format = ROW
    gtid-mode = ON
    enforce-gtid-consistency = true

    # æ…¢æŸ¥è¯¢æ—¥å¿—
    slow_query_log = 1
    slow_query_log_file = /var/log/mysql/slow.log
    long_query_time = 2
```

#### 2.2 Redisé›†ç¾¤éƒ¨ç½²

**Redisé…ç½®**:
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
  namespace: ioedream
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:7.0
        command:
        - redis-server
        - /etc/redis/redis.conf
        - --cluster-enabled
        - "yes"
        - --cluster-config-file
        - nodes.conf
        - --cluster-node-timeout
        - "5000"
        - --appendonly
        - "yes"
        ports:
        - containerPort: 6379
          name: client
        - containerPort: 16379
          name: gossip
        volumeMounts:
        - name: redis-storage
          mountPath: /data
        - name: redis-config
          mountPath: /etc/redis
  volumeClaimTemplates:
  - metadata:
      name: redis-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
      storageClassName: nfs-storage
```

### 3. åº”ç”¨æœåŠ¡éƒ¨ç½²

#### 3.1 æœåŠ¡éƒ¨ç½²æ¨¡æ¿

**é€šç”¨éƒ¨ç½²æ¨¡æ¿**:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ioedream-{service-name}
  namespace: ioedream
  labels:
    app: ioedream-{service-name}
    version: v1.0.0
    tier: backend
spec:
  replicas: {replicas}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: ioedream-{service-name}
  template:
    metadata:
      labels:
        app: ioedream-{service-name}
        version: v1.0.0
        tier: backend
    spec:
      containers:
      - name: ioedream-{service-name}
        image: ioedream/{service-name}:v1.0.0
        ports:
        - containerPort: {port}
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "{profile}"
        - name: CONSUL_HOST
          value: "consul-service"
        - name: DB_HOST
          value: "mysql-master"
        - name: REDIS_HOST
          value: "redis-cluster"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: {port}
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: {port}
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
          readOnly: true
        - name: logs-volume
          mountPath: /app/logs
      volumes:
      - name: config-volume
        configMap:
          name: ioedream-{service-name}-config
      - name: logs-volume
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: ioedream-{service-name}
  namespace: ioedream
  labels:
    app: ioedream-{service-name}
spec:
  type: ClusterIP
  ports:
  - port: {port}
    targetPort: {port}
    protocol: TCP
    name: http
  selector:
    app: ioedream-{service-name}

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ioedream-{service-name}-hpa
  namespace: ioedream
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ioedream-{service-name}
  minReplicas: {min-replicas}
  maxReplicas: {max-replicas}
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

#### 3.2 æœåŠ¡éƒ¨ç½²æ¸…å•

| æœåŠ¡åç§° | å‰¯æœ¬æ•° | æœ€å°å‰¯æœ¬ | æœ€å¤§å‰¯æœ¬ | ç«¯å£ | éƒ¨ç½²ä¼˜å…ˆçº§ |
|---------|-------|---------|---------|------|----------|
| smart-gateway | 2 | 2 | 5 | 8080 | P0 |
| ioedream-auth-service | 2 | 2 | 5 | 8081 | P0 |
| ioedream-identity-service | 2 | 2 | 5 | 8082 | P0 |
| ioedream-device-service | 2 | 2 | 5 | 8101 | P1 |
| ioedream-access-service | 2 | 2 | 5 | 8102 | P1 |
| ioedream-consume-service | 2 | 2 | 5 | 8103 | P1 |
| ioedream-visitor-service | 2 | 2 | 5 | 8104 | P1 |
| ioedream-attendance-service | 2 | 2 | 5 | 8105 | P1 |
| ioedream-video-service | 2 | 2 | 5 | 8106 | P1 |
| ioedream-notification-service | 1 | 1 | 3 | 8107 | P2 |
| ioedream-file-service | 1 | 1 | 3 | 8108 | P2 |
| ioedream-report-service | 1 | 1 | 3 | 8109 | P2 |

---

## ğŸ“Š ç›‘æ§å‘Šè­¦

### 1. ç›‘æ§ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph "æ•°æ®é‡‡é›†å±‚"
        Prometheus[Prometheus<br/>æŒ‡æ ‡é‡‡é›†]
        NodeExporter[Node Exporter<br/>ä¸»æœºæŒ‡æ ‡]
        AppExporter[App Exporter<br/>åº”ç”¨æŒ‡æ ‡]
        LogCollector[Log Collector<br/>æ—¥å¿—é‡‡é›†]
    end

    subgraph "æ•°æ®å­˜å‚¨å±‚"
        PrometheusDB[(Prometheus TSDB)]
        Elasticsearch[(Elasticsearch)]
    end

    subgraph "æ•°æ®å±•ç¤ºå±‚"
        Grafana[Grafana<br/>æŒ‡æ ‡å¯è§†åŒ–]
        Kibana[Kibana<br/>æ—¥å¿—å¯è§†åŒ–]
        Jaeger[Jaeger<br/>é“¾è·¯è¿½è¸ª]
    end

    subgraph "å‘Šè­¦å±‚"
        AlertManager[AlertManager<br/>å‘Šè­¦ç®¡ç†]
        Webhook[Webhook<br/>å‘Šè­¦é€šçŸ¥]
        Email[Email<br/>é‚®ä»¶é€šçŸ¥]
        SMS[SMS<br/>çŸ­ä¿¡é€šçŸ¥]
    end

    Prometheus --> NodeExporter
    Prometheus --> AppExporter
    LogCollector --> Elasticsearch

    Prometheus --> PrometheusDB
    Elasticsearch --> Kibana
    PrometheusDB --> Grafana
    PrometheusDB --> AlertManager

    AlertManager --> Webhook
    AlertManager --> Email
    AlertManager --> SMS
```

### 2. æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

#### 2.1 ç³»ç»ŸæŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡åç§° | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|------|----------|
| CPU | cpu_usage_percent | CPUä½¿ç”¨ç‡ | > 80% |
| å†…å­˜ | memory_usage_percent | å†…å­˜ä½¿ç”¨ç‡ | > 85% |
| ç£ç›˜ | disk_usage_percent | ç£ç›˜ä½¿ç”¨ç‡ | > 90% |
| ç½‘ç»œ | network_bytes_total | ç½‘ç»œæµé‡ | - |
| è´Ÿè½½ | system_load | ç³»ç»Ÿè´Ÿè½½ | > CPUæ ¸å¿ƒæ•°*2 |

#### 2.2 åº”ç”¨æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡åç§° | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|------|----------|
| QPS | http_requests_total | HTTPè¯·æ±‚æ•° | > 1000/s |
| å“åº”æ—¶é—´ | http_request_duration_seconds | å“åº”æ—¶é—´ | P95 > 500ms |
| é”™è¯¯ç‡ | http_requests_errors_total | é”™è¯¯è¯·æ±‚æ•° | > 5% |
| å¹¶å‘æ•° | active_connections | æ´»è·ƒè¿æ¥æ•° | > 1000 |
| GC | jvm_gc_collection_seconds_total | GCè€—æ—¶ | > 1s |

#### 2.3 ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡åç§° | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|------|----------|
| ç”¨æˆ· | active_users | æ´»è·ƒç”¨æˆ·æ•° | < 100 |
| è®¾å¤‡ | online_devices | åœ¨çº¿è®¾å¤‡æ•° | < 100 |
| è®¿é—® | access_requests | é—¨ç¦è¯·æ±‚æ•° | å¼‚å¸¸æ³¢åŠ¨ |
| æ¶ˆè´¹ | consume_amount | æ¶ˆè´¹é‡‘é¢ | å¼‚å¸¸æ³¢åŠ¨ |

### 3. å‘Šè­¦è§„åˆ™é…ç½®

#### 3.1 ç³»ç»Ÿå‘Šè­¦è§„åˆ™

```yaml
groups:
- name: system.rules
  rules:
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 5m
    labels:
      severity: warning
      team: ops
    annotations:
      summary: "High CPU usage detected"
      description: "Instance {{ $labels.instance }} has CPU usage above 80% for more than 5 minutes"

  - alert: HighMemoryUsage
    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
    for: 5m
    labels:
      severity: warning
      team: ops
    annotations:
      summary: "High memory usage detected"
      description: "Instance {{ $labels.instance }} has memory usage above 85% for more than 5 minutes"

  - alert: DiskSpaceLow
    expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
    for: 5m
    labels:
      severity: critical
      team: ops
    annotations:
      summary: "Disk space low"
      description: "Instance {{ $labels.instance }} has disk usage above 90%"
```

#### 3.2 åº”ç”¨å‘Šè­¦è§„åˆ™

```yaml
groups:
- name: application.rules
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
    for: 3m
    labels:
      severity: critical
      team: devops
    annotations:
      summary: "High error rate detected"
      description: "Service {{ $labels.service }} has error rate above 5% for more than 3 minutes"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
    for: 5m
    labels:
      severity: warning
      team: devops
    annotations:
      summary: "High response time detected"
      description: "Service {{ $labels.service }} has P95 response time above 500ms"

  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
      team: devops
    annotations:
      summary: "Service is down"
      description: "Service {{ $labels.service }} on {{ $labels.instance }} is down"
```

### 4. Grafanaä»ªè¡¨æ¿

#### 4.1 ç³»ç»Ÿç›‘æ§ä»ªè¡¨æ¿

```json
{
  "dashboard": {
    "title": "IOE-DREAM ç³»ç»Ÿç›‘æ§",
    "panels": [
      {
        "title": "CPUä½¿ç”¨ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
            "legendFormat": "{{instance}}"
          }
        ]
      },
      {
        "title": "å†…å­˜ä½¿ç”¨ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
            "legendFormat": "{{instance}}"
          }
        ]
      },
      {
        "title": "ç£ç›˜ä½¿ç”¨ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "(1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100",
            "legendFormat": "{{instance}}:{{mountpoint}}"
          }
        ]
      },
      {
        "title": "ç½‘ç»œæµé‡",
        "type": "graph",
        "targets": [
          {
            "expr": "irate(node_network_receive_bytes_total[5m])",
            "legendFormat": "{{instance}}:RX"
          },
          {
            "expr": "irate(node_network_transmit_bytes_total[5m])",
            "legendFormat": "{{instance}}:TX"
          }
        ]
      }
    ]
  }
}
```

#### 4.2 åº”ç”¨ç›‘æ§ä»ªè¡¨æ¿

```json
{
  "dashboard": {
    "title": "IOE-DREAM åº”ç”¨ç›‘æ§",
    "panels": [
      {
        "title": "è¯·æ±‚QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "sum by(service) (rate(http_requests_total[5m]))",
            "legendFormat": "{{service}}"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´åˆ†å¸ƒ",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "sum by(service) (rate(http_requests_total{status=~\"5..\"}[5m])) / sum by(service) (rate(http_requests_total[5m])) * 100",
            "legendFormat": "{{service}}"
          }
        ]
      },
      {
        "title": "åœ¨çº¿æœåŠ¡æ•°",
        "type": "singlestat",
        "targets": [
          {
            "expr": "sum(up)",
            "legendFormat": "åœ¨çº¿æœåŠ¡"
          }
        ]
      }
    ]
  }
}
```

---

## ğŸ” æ—¥å¿—ç®¡ç†

### 1. æ—¥å¿—æ¶æ„

```mermaid
graph TB
    subgraph "æ—¥å¿—æº"
        App[åº”ç”¨æœåŠ¡]
        System[ç³»ç»Ÿç»„ä»¶]
        Nginx[è´Ÿè½½å‡è¡¡å™¨]
        MySQL[æ•°æ®åº“]
        Redis[ç¼“å­˜]
    end

    subgraph "æ—¥å¿—é‡‡é›†"
        Filebeat[Filebeat<br/>æ–‡ä»¶é‡‡é›†]
        Logstash[Logstash<br/>æ—¥å¿—å¤„ç†]
        Fluentd[Fluentd<br/>å®¹å™¨æ—¥å¿—]
    end

    subgraph "æ—¥å¿—å­˜å‚¨"
        Elasticsearch[Elasticsearch<br/>æ—¥å¿—å­˜å‚¨]
    end

    subgraph "æ—¥å¿—åˆ†æ"
        Kibana[Kibana<br/>æ—¥å¿—å¯è§†åŒ–]
        Grafana[Grafana<br/>æ—¥å¿—ç›‘æ§]
        Alert[å‘Šè­¦ç³»ç»Ÿ<br/>æ—¥å¿—å‘Šè­¦]
    end

    App --> Filebeat
    System --> Filebeat
    Nginx --> Filebeat
    MySQL --> Logstash
    Redis --> Logstash

    Fluentd --> Elasticsearch
    Filebeat --> Elasticsearch
    Logstash --> Elasticsearch

    Elasticsearch --> Kibana
    Elasticsearch --> Grafana
    Elasticsearch --> Alert
```

### 2. æ—¥å¿—é…ç½®

#### 2.1 åº”ç”¨æ—¥å¿—é…ç½®

**Logbacké…ç½®**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- æ§åˆ¶å°è¾“å‡º -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp/>
                <logLevel/>
                <loggerName/>
                <mdc/>
                <arguments/>
                <stackTrace/>
                <message/>
            </providers>
        </encoder>
    </appender>

    <!-- æ–‡ä»¶è¾“å‡º -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/ioedream-access-service.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/ioedream-access-service.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp/>
                <logLevel/>
                <loggerName/>
                <mdc/>
                <arguments/>
                <stackTrace/>
                <message/>
            </providers>
        </encoder>
    </appender>

    <!-- é”™è¯¯æ—¥å¿—å•ç‹¬è¾“å‡º -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/error.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp/>
                <logLevel/>
                <loggerName/>
                <mdc/>
                <arguments/>
                <stackTrace/>
                <message/>
            </providers>
        </encoder>
    </appender>

    <!-- æ—¥å¿—çº§åˆ«é…ç½® -->
    <springProfile name="dev">
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>

    <springProfile name="test,prod">
        <root level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="ERROR_FILE"/>
        </root>
    </springProfile>

    <!-- ç‰¹å®šåŒ…çš„æ—¥å¿—çº§åˆ« -->
    <logger name="net.lab1024.sa.access" level="DEBUG"/>
    <logger name="org.springframework.cloud" level="WARN"/>
    <logger name="com.netflix" level="WARN"/>
</configuration>
```

#### 2.2 MDCä¸Šä¸‹æ–‡é…ç½®

**MDCè¿‡æ»¤å™¨**:
```java
@Component
@Order(1)
public class MdcFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;

        try {
            // ç”Ÿæˆè¯·æ±‚ID
            String requestId = UUID.randomUUID().toString().replace("-", "");

            // æ·»åŠ MDCä¿¡æ¯
            MDC.put("requestId", requestId);
            MDC.put("service", SpringContextUtil.getApplicationName());
            MDC.put("version", SpringContextUtil.getApplicationVersion());
            MDC.put("environment", SpringContextUtil.getActiveProfile());

            // ç”¨æˆ·ä¿¡æ¯
            Authentication auth = SecurityContextHolder.getContext().getAuthentication();
            if (auth != null && auth.isAuthenticated()) {
                MDC.put("userId", auth.getName());
            }

            // è¯·æ±‚ä¿¡æ¯
            MDC.put("uri", httpRequest.getRequestURI());
            MDC.put("method", httpRequest.getMethod());
            MDC.put("clientIp", getClientIp(httpRequest));
            MDC.put("userAgent", httpRequest.getHeader("User-Agent"));

            chain.doFilter(request, response);

        } finally {
            MDC.clear();
        }
    }

    private String getClientIp(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (StringUtils.hasText(xForwardedFor)) {
            return xForwardedFor.split(",")[0].trim();
        }
        return request.getRemoteAddr();
    }
}
```

### 3. æ—¥å¿—æ”¶é›†é…ç½®

#### 3.1 Filebeaté…ç½®

**filebeat.yml**:
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /app/logs/*.log
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after
  fields:
    service: ioedream-access-service
    environment: ${ENVIRONMENT:prod}
  fields_under_root: true

- type: container
  enabled: true
  paths:
    - /var/log/containers/*.log
  processors:
    - add_kubernetes_metadata:
        host: ${NODE_NAME}
        matchers:
        - logs_path:
            logs_path: "/var/log/containers/"

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "ioedream-logs-%{+yyyy.MM.dd}"
  template.name: "ioedream"
  template.pattern: "ioedream-*"
  template.settings:
    index.number_of_shards: 1
    index.number_of_replicas: 1

processors:
  - timestamp:
      field: json.timestamp
      layouts:
        - '2006-01-02T15:04:05.000Z'
  - drop_fields:
      fields: ["agent", "ecs", "host", "input", "log"]

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
```

#### 3.2 Logstashé…ç½®

**logstash.conf**:
```ruby
input {
  beats {
    port => 5044
  }
}

filter {
  # è§£æJSONæ ¼å¼çš„æ—¥å¿—
  if [message] {
    json {
      source => "message"
    }
  }

  # æ—¶é—´æˆ³å¤„ç†
  if [timestamp] {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
    }
  }

  # æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯ï¼ˆåŸºäºIPï¼‰
  if [clientIp] and [clientIp] != "127.0.0.1" {
    geoip {
      source => "clientIp"
      target => "geoip"
    }
  }

  # è§£æUser-Agent
  if [userAgent] {
    useragent {
      source => "userAgent"
      target => "userAgent"
    }
  }

  # æ·»åŠ ç´¢å¼•åç§°
  mutate {
    add_field => { "[@metadata][index]" => "ioedream-logs-%{+YYYY.MM.dd}" }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    template_name => "ioedream"
    template_pattern => "ioedream-*"
    template => {
      "index_patterns" => ["ioedream-*"],
      "settings" => {
        "number_of_shards" => 1,
        "number_of_replicas" => 1,
        "index.refresh_interval" => "5s"
      },
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" },
          "level" => { "type" => "keyword" },
          "service" => { "type" => "keyword" },
          "requestId" => { "type" => "keyword" },
          "userId" => { "type" => "keyword" },
          "uri" => { "type" => "keyword" },
          "method" => { "type" => "keyword" },
          "clientIp" => { "type" => "ip" },
          "responseTime" => { "type" => "long" },
          "statusCode" => { "type" => "integer" }
        }
      }
    }
  }

  # è°ƒè¯•è¾“å‡ºï¼ˆå¯é€‰ï¼‰
  stdout {
    codec => rubydebug
  }
}
```

### 4. æ—¥å¿—æŸ¥è¯¢åˆ†æ

#### 4.1 å¸¸ç”¨æŸ¥è¯¢è¯­å¥

**é”™è¯¯æ—¥å¿—æŸ¥è¯¢**:
```
level:ERROR AND service:ioedream-access-service
```

**æ…¢è¯·æ±‚æŸ¥è¯¢**:
```
responseTime:>1000 AND service:ioedream-access-service
```

**ç”¨æˆ·æ“ä½œæŸ¥è¯¢**:
```
userId:12345 AND service:ioedream-access-service
```

**APIé”™è¯¯ç»Ÿè®¡**:
```
level:ERROR AND uri:/api/access/* | stats count by uri
```

**å“åº”æ—¶é—´åˆ†æ**:
```
service:ioedream-access-service | stats avg(responseTime) by uri
```

#### 4.2 å‘Šè­¦è§„åˆ™é…ç½®

**é”™è¯¯ç‡å‘Šè­¦**:
```json
{
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ["ioedream-logs-*"],
        "body": {
          "query": {
            "bool": {
              "must": [
                { "range": { "@timestamp": { "gte": "now-1m" } } },
                { "term": { "level": "ERROR" } }
              ]
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gte": 10
      }
    }
  },
  "actions": {
    "send_email": {
      "email": {
        "to": ["ops@ioedream.com"],
        "subject": "IOE-DREAM é”™è¯¯æ—¥å¿—å‘Šè­¦",
        "body": "åœ¨è¿‡å»1åˆ†é’Ÿå†…å‘ç° {{ctx.payload.hits.total}} æ¡é”™è¯¯æ—¥å¿—"
      }
    }
  }
}
```

---

## ğŸ’¾ å¤‡ä»½æ¢å¤

### 1. å¤‡ä»½ç­–ç•¥

#### 1.1 æ•°æ®å¤‡ä»½ç­–ç•¥

| å¤‡ä»½ç±»å‹ | å¤‡ä»½é¢‘ç‡ | ä¿ç•™æœŸé™ | å¤‡ä»½æ–¹å¼ | å­˜å‚¨ä½ç½® |
|---------|---------|----------|----------|----------|
| å…¨é‡å¤‡ä»½ | æ¯æ—¥ | 30å¤© | mysqldump | å¤‡ä»½æœåŠ¡å™¨ |
| å¢é‡å¤‡ä»½ | æ¯å°æ—¶ | 7å¤© | binlog | å¤‡ä»½æœåŠ¡å™¨ |
| æ—¥å¿—å¤‡ä»½ | æ¯æ—¥ | 90å¤© | æ–‡ä»¶å‹ç¼© | å¯¹è±¡å­˜å‚¨ |
| é…ç½®å¤‡ä»½ | å˜æ›´æ—¶ | æ°¸ä¹… | Git | ä»£ç ä»“åº“ |

#### 1.2 å¤‡ä»½æ‰§è¡Œè„šæœ¬

**MySQLå…¨é‡å¤‡ä»½è„šæœ¬**:
```bash
#!/bin/bash

# é…ç½®å˜é‡
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="ioedream_access"
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_full_${DATE}.sql"
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}

# æ‰§è¡Œå…¨é‡å¤‡ä»½
mysqldump \
  --host=mysql-master \
  --port=3306 \
  --username=root \
  --password=${MYSQL_ROOT_PASSWORD} \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  --hex-blob \
  --default-character-set=utf8mb4 \
  ${DB_NAME} > ${BACKUP_FILE}

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip ${BACKUP_FILE}

# åˆ é™¤è¿‡æœŸå¤‡ä»½
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# è®°å½•å¤‡ä»½æ—¥å¿—
logger "MySQL full backup completed: ${BACKUP_FILE}.gz"
```

**å¢é‡å¤‡ä»½è„šæœ¬**:
```bash
#!/bin/bash

# é…ç½®å˜é‡
BACKUP_DIR="/backup/mysql/binlog"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_HOST="mysql-master"
MYSQL_USER="root"
MYSQL_PASSWORD="${MYSQL_ROOT_PASSWORD}"
RETENTION_DAYS=7

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}

# è·å–å½“å‰binlogæ–‡ä»¶å’Œä½ç½®
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "SHOW MASTER STATUS;" > /tmp/master_status.txt

# åˆ·æ–°binlog
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "FLUSH LOGS;"

# å¤åˆ¶binlogæ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
cp /var/lib/mysql/mysql-bin.* ${BACKUP_DIR}/

# å‹ç¼©binlogæ–‡ä»¶
cd ${BACKUP_DIR}
for file in mysql-bin.*; do
    if [[ ! "$file" =~ \.gz$ ]]; then
        gzip "$file"
    fi
done

# åˆ é™¤è¿‡æœŸå¤‡ä»½
find ${BACKUP_DIR} -name "mysql-bin.*.gz" -mtime +${RETENTION_DAYS} -delete

# è®°å½•å¤‡ä»½æ—¥å¿—
logger "MySQL binlog backup completed: ${DATE}"
```

### 2. æ¢å¤ç­–ç•¥

#### 2.1 æ•°æ®åº“æ¢å¤

**å…¨é‡æ¢å¤è„šæœ¬**:
```bash
#!/bin/bash

# é…ç½®å˜é‡
BACKUP_FILE=$1
RESTORE_DB="ioedream_access_restore"
MYSQL_HOST="mysql-master"
MYSQL_USER="root"
MYSQL_PASSWORD="${MYSQL_ROOT_PASSWORD}"

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
if [ ! -f "${BACKUP_FILE}" ]; then
    echo "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: ${BACKUP_FILE}"
    exit 1
fi

# åˆ›å»ºæ¢å¤æ•°æ®åº“
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS ${RESTORE_DB};"

# æ‰§è¡Œæ¢å¤
if [[ ${BACKUP_FILE} =~ \.gz$ ]]; then
    gunzip -c ${BACKUP_FILE} | mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${RESTORE_DB}
else
    mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${RESTORE_DB} < ${BACKUP_FILE}
fi

# éªŒè¯æ¢å¤ç»“æœ
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "SELECT COUNT(*) FROM ${RESTORE_DB}.t_access_record;"

echo "æ•°æ®åº“æ¢å¤å®Œæˆ: ${RESTORE_DB}"
```

**åŸºäºæ—¶é—´ç‚¹æ¢å¤**:
```bash
#!/bin/bash

# é…ç½®å˜é‡
RESTORE_TIME=$1  # æ ¼å¼: 2025-11-29 15:30:00
BACKUP_DIR="/backup/mysql"
RESTORE_DB="ioedream_access_restore"
MYSQL_HOST="mysql-master"
MYSQL_USER="root"
MYSQL_PASSWORD="${MYSQL_ROOT_PASSWORD}"

# æŸ¥æ‰¾æœ€æ¥è¿‘æ¢å¤æ—¶é—´çš„å…¨é‡å¤‡ä»½
FULL_BACKUP=$(find ${BACKUP_DIR} -name "*full*.sql.gz" | sort | tail -n1)

# æ¢å¤å…¨é‡å¤‡ä»½
echo "æ¢å¤å…¨é‡å¤‡ä»½: ${FULL_BACKUP}"
gunzip -c ${FULL_BACKUP} | mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${RESTORE_DB}

# åº”ç”¨binlogåˆ°æŒ‡å®šæ—¶é—´ç‚¹
echo "åº”ç”¨binlogåˆ°æ—¶é—´ç‚¹: ${RESTORE_TIME}"
mysqlbinlog \
  --host=${MYSQL_HOST} \
  --user=${MYSQL_USER} \
  --password=${MYSQL_PASSWORD} \
  --database=${RESTORE_DB} \
  --stop-datetime="${RESTORE_TIME}" \
  /var/lib/mysql/mysql-bin.* | mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${RESTORE_DB}

echo "æ—¶é—´ç‚¹æ¢å¤å®Œæˆ: ${RESTORE_DB}"
```

#### 2.2 åº”ç”¨é…ç½®æ¢å¤

**Kubernetesé…ç½®æ¢å¤**:
```bash
#!/bin/bash

# æ¢å¤ConfigMap
kubectl apply -f backup/configmaps/

# æ¢å¤Secret
kubectl apply -f backup/secrets/

# æ¢å¤Service
kubectl apply -f backup/services/

# é‡å¯Deployment
kubectl rollout restart deployment -l app=ioedream-access-service -n ioedream
```

### 3. å¤‡ä»½éªŒè¯

#### 3.1 å¤‡ä»½å®Œæ•´æ€§éªŒè¯

**å¤‡ä»½éªŒè¯è„šæœ¬**:
```bash
#!/bin/bash

# é…ç½®å˜é‡
BACKUP_FILE=$1
TEMP_DB="backup_verify_${RANDOM}"
MYSQL_HOST="mysql-master"
MYSQL_USER="root"
MYSQL_PASSWORD="${MYSQL_ROOT_PASSWORD}"

# åˆ›å»ºä¸´æ—¶æ•°æ®åº“
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "CREATE DATABASE ${TEMP_DB};"

# æ¢å¤å¤‡ä»½åˆ°ä¸´æ—¶æ•°æ®åº“
if [[ ${BACKUP_FILE} =~ \.gz$ ]]; then
    gunzip -c ${BACKUP_FILE} | mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${TEMP_DB}
else
    mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} ${TEMP_DB} < ${BACKUP_FILE}
fi

# éªŒè¯è¡¨ç»“æ„
echo "éªŒè¯è¡¨ç»“æ„..."
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "
  SELECT COUNT(*) as table_count
  FROM information_schema.tables
  WHERE table_schema='${TEMP_DB}';"

# éªŒè¯æ•°æ®å®Œæ•´æ€§
echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "
  SELECT
    't_access_record' as table_name,
    COUNT(*) as record_count
  FROM ${TEMP_DB}.t_access_record
  UNION ALL
  SELECT
    't_device_info' as table_name,
    COUNT(*) as record_count
  FROM ${TEMP_DB}.t_device_info;"

# æ¸…ç†ä¸´æ—¶æ•°æ®åº“
mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASSWORD} -e "DROP DATABASE ${TEMP_DB};"

echo "å¤‡ä»½éªŒè¯å®Œæˆ"
```

---

## âš¡ æ€§èƒ½è°ƒä¼˜

### 1. JVMè°ƒä¼˜

#### 1.1 JVMå‚æ•°é…ç½®

**ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°**:
```bash
JAVA_OPTS="-Xms2g -Xmx4g \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:G1HeapRegionSize=16m \
-XX:G1NewSizePercent=30 \
-XX:G1MaxNewSizePercent=40 \
-XX:+UseStringDeduplication \
-XX:+OptimizeStringConcat \
-XX:+UseCompressedOops \
-XX:+UseCompressedClassPointers \
-XX:MetaspaceSize=256m \
-XX:MaxMetaspaceSize=512m \
-XX:+PrintGCDetails \
-XX:+PrintGCTimeStamps \
-XX:+PrintGCDateStamps \
-Xloggc:/app/logs/gc.log \
-XX:+UseGCLogFileRotation \
-XX:NumberOfGCLogFiles=5 \
-XX:GCLogFileSize=10M"
```

#### 1.2 GCç›‘æ§é…ç½®

**JMXç›‘æ§é…ç½®**:
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,configprops,threaddump,heapdump
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.95,0.99
    tags:
      application: ${spring.application.name}
```

### 2. æ•°æ®åº“è°ƒä¼˜

#### 2.1 MySQLè°ƒä¼˜

**MySQLé…ç½®ä¼˜åŒ–**:
```ini
[mysqld]
# åŸºç¡€é…ç½®
server-id = 1
bind-address = 0.0.0.0
port = 3306
max_connections = 2000
max_connect_errors = 1000

# InnoDBé…ç½®
innodb_buffer_pool_size = 8G
innodb_buffer_pool_instances = 8
innodb_log_file_size = 1G
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# æŸ¥è¯¢ç¼“å­˜
query_cache_type = 1
query_cache_size = 256M
query_cache_limit = 2M

# æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 1

# äºŒè¿›åˆ¶æ—¥å¿—
log-bin = mysql-bin
binlog-format = ROW
expire_logs_days = 7
max_binlog_size = 1G

# å…¶ä»–ä¼˜åŒ–
skip-name-resolve
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
```

#### 2.2 ç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–æ£€æŸ¥è„šæœ¬**:
```sql
-- æ£€æŸ¥æœªä½¿ç”¨çš„ç´¢å¼•
SELECT
    object_schema,
    object_name,
    index_name
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE index_name IS NOT NULL
AND count_star = 0
AND object_schema != 'mysql';

-- æ£€æŸ¥é‡å¤ç´¢å¼•
SELECT
    table_schema,
    table_name,
    index_name,
    GROUP_CONCAT(column_name ORDER BY seq_in_index) as columns
FROM information_schema.statistics
WHERE table_schema = 'ioedream_access'
GROUP BY table_schema, table_name, index_name
HAVING COUNT(*) > 1;

-- åˆ†æè¡¨ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    table_name,
    index_name,
    cardinality,
    sub_part,
    packed,
    nullable,
    index_type
FROM information_schema.statistics
WHERE table_schema = 'ioedream_access'
ORDER BY table_name, seq_in_index;
```

### 3. Redisè°ƒä¼˜

#### 3.1 Redisé…ç½®ä¼˜åŒ–

**redis.conf**:
```conf
# å†…å­˜é…ç½®
maxmemory 4gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec

# ç½‘ç»œé…ç½®
tcp-keepalive 300
timeout 0
tcp-backlog 511

# å®‰å…¨é…ç½®
requirepass your-redis-password
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG "CONFIG-b835c3f8a2d5e7f4"

# å®¢æˆ·ç«¯é…ç½®
maxclients 10000

# æ…¢æŸ¥è¯¢æ—¥å¿—
slowlog-log-slower-than 10000
slowlog-max-len 128

# å†…å­˜ä¼˜åŒ–
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
```

### 4. åº”ç”¨å±‚ä¼˜åŒ–

#### 4.1 è¿æ¥æ± ä¼˜åŒ–

**HikariCPé…ç½®**:
```yaml
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      auto-commit: true
      idle-timeout: 30000
      pool-name: IOEDreamHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
      connection-test-query: SELECT 1
      leak-detection-threshold: 60000
```

**Redisè¿æ¥æ± é…ç½®**:
```yaml
spring:
  redis:
    lettuce:
      pool:
        max-active: 50
        max-idle: 20
        min-idle: 10
        max-wait: 3000ms
      shutdown-timeout: 100ms
    timeout: 3000ms
```

#### 4.2 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

**å¤šçº§ç¼“å­˜é…ç½®**:
```java
@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        // æœ¬åœ°ç¼“å­˜é…ç½®
        CaffeineCacheManager localCacheManager = new CaffeineCacheManager();
        localCacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .recordStats());

        // Redisç¼“å­˜é…ç½®
        RedisCacheConfiguration redisConfig = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));

        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(redisConfig)
            .build();
    }
}
```

---

## ğŸš¨ åº”æ€¥å“åº”

### 1. æ•…éšœç­‰çº§å®šä¹‰

| æ•…éšœç­‰çº§ | å½±å“èŒƒå›´ | å“åº”æ—¶é—´ | è§£å†³æ—¶é—´ | å‡çº§æ¡ä»¶ |
|---------|---------|----------|----------|----------|
| P0 - ä¸¥é‡ | ç³»ç»Ÿä¸å¯ç”¨ï¼Œä¸šåŠ¡ä¸­æ–­ | 15åˆ†é’Ÿ | 2å°æ—¶ | 30åˆ†é’Ÿæœªè§£å†³ |
| P1 - é‡è¦ | æ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸ï¼Œä¸¥é‡å½±å“ä¸šåŠ¡ | 30åˆ†é’Ÿ | 4å°æ—¶ | 2å°æ—¶æœªè§£å†³ |
| P2 - ä¸€èˆ¬ | åŠŸèƒ½å¼‚å¸¸ï¼Œè½»å¾®å½±å“ä¸šåŠ¡ | 2å°æ—¶ | 1ä¸ªå·¥ä½œæ—¥ | 8å°æ—¶æœªè§£å†³ |
| P3 - è½»å¾® | ä½¿ç”¨å’¨è¯¢ï¼Œæ— ä¸šåŠ¡å½±å“ | 1ä¸ªå·¥ä½œæ—¥ | 3ä¸ªå·¥ä½œæ—¥ | - |

### 2. åº”æ€¥å“åº”æµç¨‹

#### 2.1 æ•…éšœå‘ç°å’ŒæŠ¥å‘Š

**æ•…éšœå‘ç°æ¸ é“**:
- ç›‘æ§å‘Šè­¦ç³»ç»Ÿè‡ªåŠ¨å‘ç°
- ç”¨æˆ·åé¦ˆå’ŒæŠ•è¯‰
- è¿ç»´å·¡æ£€å‘ç°
- å¼€å‘äººå‘˜æŠ¥å‘Š

**æ•…éšœæŠ¥å‘Šæ¨¡æ¿**:
```
æ•…éšœæ ‡é¢˜: [ä¸¥é‡] IOE-DREAMé—¨ç¦æœåŠ¡ä¸å¯ç”¨
æ•…éšœç­‰çº§: P0
å½±å“èŒƒå›´: æ‰€æœ‰é—¨ç¦åŠŸèƒ½
å‘ç”Ÿæ—¶é—´: 2025-11-29 15:30:00
æ•…éšœç°è±¡: ç”¨æˆ·æ— æ³•é€šè¿‡é—¨ç¦ï¼Œç³»ç»Ÿæç¤ºæœåŠ¡ä¸å¯ç”¨
åˆæ­¥åŸå› : æ•°æ®åº“è¿æ¥æ± è€—å°½
å½“å‰çŠ¶æ€: æ­£åœ¨å¤„ç†
è´Ÿè´£äºº: å¼ ä¸‰
è”ç³»æ–¹å¼: 13800138000
```

#### 2.2 æ•…éšœå¤„ç†æµç¨‹

```mermaid
graph TD
    A[æ•…éšœå‘ç°] --> B[æ•…éšœè¯„ä¼°]
    B --> C{æ˜¯å¦P0/P1æ•…éšœ?}
    C -->|æ˜¯| D[å¯åŠ¨åº”æ€¥å“åº”]
    C -->|å¦| E[å¸¸è§„å¤„ç†æµç¨‹]
    D --> F[ç»„å»ºåº”æ€¥å°ç»„]
    F --> G[å¿«é€Ÿå®šä½é—®é¢˜]
    G --> H[å®æ–½ä¸´æ—¶æ–¹æ¡ˆ]
    H --> I[æ¢å¤æœåŠ¡]
    I --> J[æ ¹å› åˆ†æ]
    J --> K[å®æ–½æ°¸ä¹…ä¿®å¤]
    K --> L[æ•…éšœå¤ç›˜]

    E --> M[åˆ†æ´¾å¤„ç†äºº]
    M --> N[é—®é¢˜å®šä½å’Œä¿®å¤]
    N --> O[éªŒè¯ä¿®å¤æ•ˆæœ]
    O --> P[å…³é—­æ•…éšœå•]
```

#### 2.3 å¸¸è§æ•…éšœå¤„ç†

**æ•°æ®åº“è¿æ¥æ± è€—å°½**:
```bash
# 1. æ£€æŸ¥è¿æ¥æ± çŠ¶æ€
kubectl exec -it ioedream-access-service-xxx -- curl http://localhost:8102/actuator/health/db

# 2. å¢åŠ è¿æ¥æ± å¤§å°
kubectl edit deployment ioedream-access-service
# ä¿®æ”¹ SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=100

# 3. é‡å¯æœåŠ¡
kubectl rollout restart deployment ioedream-access-service -n ioedream

# 4. ç›‘æ§æ¢å¤æƒ…å†µ
kubectl logs -f deployment/ioedream-access-service -n ioedream
```

**å†…å­˜æº¢å‡º**:
```bash
# 1. æ£€æŸ¥Podå†…å­˜ä½¿ç”¨
kubectl top pods -n ioedream | grep ioedream-access-service

# 2. åˆ†æOOMåŸå› 
kubectl describe pod ioedream-access-service-xxx -n ioedream
kubectl logs ioedream-access-service-xxx -n ioedream --previous

# 3. å¢åŠ å†…å­˜é™åˆ¶
kubectl patch deployment ioedream-access-service -p '{"spec":{"template":{"spec":{"containers":[{"name":"ioedream-access-service","resources":{"limits":{"memory":"4Gi"}}}]}}}}'

# 4. é‡å¯æœåŠ¡
kubectl delete pod ioedream-access-service-xxx -n ioedream
```

**ç½‘ç»œä¸é€š**:
```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get svc -n ioedream
kubectl get endpoints -n ioedream

# 2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
kubectl exec -it ioedream-access-service-xxx -- ping mysql-master
kubectl exec -it ioedream-access-service-xxx -- telnet redis-cluster 6379

# 3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
kubectl get networkpolicy -n ioedream

# 4. é‡å»ºæœåŠ¡
kubectl delete svc ioedream-access-service -n ioedream
kubectl apply -f k8s/services/ioedream-access-service.yaml
```

### 3. æ•…éšœæ¢å¤éªŒè¯

#### 3.1 æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥

**è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬**:
```bash
#!/bin/bash

SERVICE_NAME="ioedream-access-service"
NAMESPACE="ioedream"
HEALTH_URL="http://ioedream-access-service:8102/actuator/health"

# æ£€æŸ¥PodçŠ¶æ€
echo "æ£€æŸ¥PodçŠ¶æ€..."
kubectl get pods -n ${NAMESPACE} -l app=${SERVICE_NAME}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
kubectl get svc -n ${NAMESPACE} ${SERVICE_NAME}

# æ£€æŸ¥å¥åº·çŠ¶æ€
echo "æ£€æŸ¥å¥åº·çŠ¶æ€..."
kubectl exec -it deployment/${SERVICE_NAME} -n ${NAMESPACE} -- curl -f ${HEALTH_URL}

# æ£€æŸ¥æ—¥å¿—é”™è¯¯
echo "æ£€æŸ¥æœ€è¿‘é”™è¯¯æ—¥å¿—..."
kubectl logs deployment/${SERVICE_NAME} -n ${NAMESPACE} --tail=100 | grep ERROR

echo "æœåŠ¡çŠ¶æ€æ£€æŸ¥å®Œæˆ"
```

#### 3.2 åŠŸèƒ½éªŒè¯æµ‹è¯•

**APIåŠŸèƒ½æµ‹è¯•**:
```bash
#!/bin/bash

BASE_URL="http://localhost:8102"

# æµ‹è¯•è®¤è¯æ¥å£
echo "æµ‹è¯•è®¤è¯æ¥å£..."
curl -X POST "${BASE_URL}/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin"}'

# æµ‹è¯•ä¸šåŠ¡æ¥å£
echo "æµ‹è¯•ä¸šåŠ¡æ¥å£..."
TOKEN=$(curl -s -X POST "${BASE_URL}/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin"}' | jq -r '.data.token')

curl -X GET "${BASE_URL}/api/access/doors" \
  -H "Authorization: Bearer ${TOKEN}"

echo "åŠŸèƒ½éªŒè¯å®Œæˆ"
```

---

## ğŸ“š è¿ç»´å·¥å…·å’Œè„šæœ¬

### 1. å¸¸ç”¨è¿ç»´è„šæœ¬

#### 1.1 æœåŠ¡éƒ¨ç½²è„šæœ¬

**æ‰¹é‡éƒ¨ç½²è„šæœ¬**:
```bash
#!/bin/bash

NAMESPACE="ioedream"
SERVICES=("ioedream-auth-service" "ioedream-identity-service" "ioedream-device-service" "ioedream-access-service")

for service in "${SERVICES[@]}"; do
    echo "éƒ¨ç½²æœåŠ¡: ${service}"

    # åˆ›å»ºå‘½åç©ºé—´
    kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

    # åº”ç”¨é…ç½®
    kubectl apply -f k8s/configmaps/${service}-configmap.yaml -n ${NAMESPACE}
    kubectl apply -f k8s/secrets/${service}-secret.yaml -n ${NAMESPACE}

    # éƒ¨ç½²æœåŠ¡
    kubectl apply -f k8s/deployments/${service}-deployment.yaml -n ${NAMESPACE}
    kubectl apply -f k8s/services/${service}-service.yaml -n ${NAMESPACE}

    # ç­‰å¾…éƒ¨ç½²å®Œæˆ
    kubectl rollout status deployment/${service} -n ${NAMESPACE} --timeout=300s

    echo "æœåŠ¡ ${service} éƒ¨ç½²å®Œæˆ"
done
```

#### 1.2 å¥åº·æ£€æŸ¥è„šæœ¬

**æœåŠ¡å¥åº·æ£€æŸ¥**:
```bash
#!/bin/bash

NAMESPACE="ioedream"
SERVICES=("smart-gateway" "ioedream-auth-service" "ioedream-identity-service" "ioedream-device-service" "ioedream-access-service")

echo "å¼€å§‹å¥åº·æ£€æŸ¥..."

for service in "${SERVICES[@]}"; do
    echo "æ£€æŸ¥æœåŠ¡: ${service}"

    # æ£€æŸ¥PodçŠ¶æ€
    pod_status=$(kubectl get pods -n ${NAMESPACE} -l app=${service} -o jsonpath='{.items[0].status.phase}')
    if [ "${pod_status}" != "Running" ]; then
        echo "âŒ ${service} PodçŠ¶æ€å¼‚å¸¸: ${pod_status}"
        continue
    fi

    # æ£€æŸ¥å¥åº·çŠ¶æ€
    health_url="http://${service}:8080/actuator/health"
    if [ "${service}" = "smart-gateway" ]; then
        health_url="http://${service}:8080/actuator/health"
    elif [[ "${service}" =~ ioedream-.*-service ]]; then
        port=$(kubectl get svc ${service} -n ${NAMESPACE} -o jsonpath='{.spec.ports[0].port}')
        health_url="http://${service}:${port}/actuator/health"
    fi

    health_status=$(kubectl exec -it deployment/${service} -n ${NAMESPACE} -- curl -s -o /dev/null -w "%{http_code}" ${health_url})
    if [ "${health_status}" = "200" ]; then
        echo "âœ… ${service} å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        echo "âŒ ${service} å¥åº·æ£€æŸ¥å¤±è´¥: HTTP ${health_status}"
    fi
done

echo "å¥åº·æ£€æŸ¥å®Œæˆ"
```

#### 1.3 æ—¥å¿—æ”¶é›†è„šæœ¬

**æ‰¹é‡æ—¥å¿—æ”¶é›†**:
```bash
#!/bin/bash

NAMESPACE="ioedream"
SERVICES=("ioedream-auth-service" "ioedream-identity-service" "ioedream-device-service" "ioedream-access-service")
LOG_DIR="/tmp/ioedream-logs"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p ${LOG_DIR}

echo "å¼€å§‹æ”¶é›†æ—¥å¿—..."

for service in "${SERVICES[@]}"; do
    echo "æ”¶é›†æœåŠ¡æ—¥å¿—: ${service}"

    # æ”¶é›†åº”ç”¨æ—¥å¿—
    kubectl logs deployment/${service} -n ${NAMESPACE} --tail=1000 > ${LOG_DIR}/${service}_${DATE}.log

    # æ”¶é›†äº‹ä»¶æ—¥å¿—
    kubectl get events -n ${NAMESPACE} --field-selector involvedObject.name=${service} > ${LOG_DIR}/${service}_events_${DATE}.log

    # æ”¶é›†æè¿°ä¿¡æ¯
    kubectl describe deployment/${service} -n ${NAMESPACE} > ${LOG_DIR}/${service}_describe_${DATE}.log

    echo "âœ… ${service} æ—¥å¿—æ”¶é›†å®Œæˆ"
done

# æ‰“åŒ…æ—¥å¿—
cd ${LOG_DIR}
tar -czf ioedream_logs_${DATE}.tar.gz *.log
rm *.log

echo "æ—¥å¿—æ”¶é›†å®Œæˆ: ${LOG_DIR}/ioedream_logs_${DATE}.tar.gz"
```

### 2. ç›‘æ§å·¥å…·

#### 2.1 æ€§èƒ½ç›‘æ§è„šæœ¬

**å®æ—¶æ€§èƒ½ç›‘æ§**:
```bash
#!/bin/bash

NAMESPACE="ioedream"
SERVICES=("ioedream-auth-service" "ioedream-identity-service" "ioedream-device-service" "ioedream-access-service")

while true; do
    clear
    echo "=== IOE-DREAM å®æ—¶æ€§èƒ½ç›‘æ§ - $(date) ==="
    echo ""

    for service in "${SERVICES[@]}"; do
        echo "ğŸ“Š ${service}"

        # CPUå’Œå†…å­˜ä½¿ç”¨
        kubectl top pods -n ${NAMESPACE} -l app=${service} --no-headers | while read pod cpu memory; do
            echo "  Pod: ${pod}  CPU: ${cpu}  Memory: ${memory}"
        done

        # è¯·æ±‚QPSå’Œé”™è¯¯ç‡
        qps=$(curl -s "http://prometheus:9090/api/v1/query?query=sum(rate(http_requests_total{service=\"${service}\"}[5m]))" | jq -r '.data.result[0].value[1] // 0')
        error_rate=$(curl -s "http://prometheus:9090/api/v1/query?query=sum(rate(http_requests_total{service=\"${service}\",status=~\"5..\"}[5m]))/sum(rate(http_requests_total{service=\"${service}\"}[5m]))*100" | jq -r '.data.result[0].value[1] // 0')

        echo "  QPS: ${qps}  é”™è¯¯ç‡: ${error_rate}%"
        echo ""
    done

    sleep 30
done
```

---

## ğŸ“‹ è¿ç»´äº¤æ¥æ¸…å•

### 1. ç³»ç»Ÿç¯å¢ƒäº¤æ¥

- [ ] Kubernetesé›†ç¾¤é…ç½®å’Œæƒé™
- [ ] æ‰€æœ‰æœåŠ¡éƒ¨ç½²æ–‡ä»¶å’Œé…ç½®
- [ ] æ•°æ®åº“è¿æ¥é…ç½®å’Œå¤‡ä»½ç­–ç•¥
- [ ] ç›‘æ§ç³»ç»Ÿå’Œå‘Šè­¦é…ç½®
- [ ] æ—¥å¿—æ”¶é›†å’Œåˆ†æç³»ç»Ÿé…ç½®
- [ ] ç½‘ç»œé…ç½®å’Œå®‰å…¨ç­–ç•¥

### 2. è´¦å·æƒé™äº¤æ¥

- [ ] Kubernetesé›†ç¾¤è®¿é—®æƒé™
- [ ] ç›‘æ§ç³»ç»Ÿè®¿é—®æƒé™
- [ ] æ•°æ®åº“è®¿é—®æƒé™
- [ ] ä»£ç ä»“åº“è®¿é—®æƒé™
- [ ] ç¬¬ä¸‰æ–¹æœåŠ¡è´¦å·æƒé™
- [ ] æœåŠ¡å™¨SSHè®¿é—®æƒé™

### 3. æ–‡æ¡£èµ„æ–™äº¤æ¥

- [ ] ç³»ç»Ÿæ¶æ„æ–‡æ¡£
- [ ] éƒ¨ç½²æ“ä½œæ‰‹å†Œ
- [ ] ç›‘æ§å‘Šè­¦é…ç½®æ–‡æ¡£
- [ ] æ•…éšœå¤„ç†æ‰‹å†Œ
- [ ] å¤‡ä»½æ¢å¤æµç¨‹
- [ ] æ€§èƒ½è°ƒä¼˜æŒ‡å—

### 4. å·¥å…·è„šæœ¬äº¤æ¥

- [ ] è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- [ ] ç›‘æ§æ£€æŸ¥è„šæœ¬
- [ ] æ—¥å¿—æ”¶é›†è„šæœ¬
- [ ] å¤‡ä»½æ¢å¤è„šæœ¬
- [ ] æ€§èƒ½åˆ†æå·¥å…·
- [ ] æ•…éšœè¯Šæ–­å·¥å…·

### 5. åº”æ€¥é¢„æ¡ˆäº¤æ¥

- [ ] åº”æ€¥å“åº”æµç¨‹
- [ ] æ•…éšœå‡çº§æœºåˆ¶
- [ ] è”ç³»äººæ¸…å•
- [ ] å›æ»šæ–¹æ¡ˆ
- [ ] æ•°æ®æ¢å¤æ–¹æ¡ˆ
- [ ] ä¸šåŠ¡è¿ç»­æ€§è®¡åˆ’

---

## ğŸ“ è”ç³»æ–¹å¼

### ç´§æ€¥è”ç³»äºº

| è§’è‰² | å§“å | ç”µè¯ | é‚®ç®± | èŒè´£ |
|------|------|------|------|------|
| è¿ç»´è´Ÿè´£äºº | å¼ ä¸‰ | 13800138000 | zhangsan@ioedream.com | è¿ç»´å†³ç­–å’Œåè°ƒ |
| ç³»ç»Ÿæ¶æ„å¸ˆ | æå›› | 13800138001 | lisi@ioedream.com | æ¶æ„é—®é¢˜æ”¯æŒ |
| æ•°æ®åº“ä¸“å®¶ | ç‹äº” | 13800138002 | wangwu@ioedream.com | æ•°æ®åº“é—®é¢˜æ”¯æŒ |
| ç½‘ç»œå·¥ç¨‹å¸ˆ | èµµå…­ | 13800138003 | zhaoliu@ioedream.com | ç½‘ç»œé—®é¢˜æ”¯æŒ |
| å®‰å…¨ä¸“å®¶ | é’±ä¸ƒ | 13800138004 | qianqi@ioedream.com | å®‰å…¨é—®é¢˜æ”¯æŒ |

### å¤–éƒ¨æ”¯æŒ

| æœåŠ¡å•† | è”ç³»æ–¹å¼ | æœåŠ¡å†…å®¹ |
|--------|----------|----------|
| äº‘æœåŠ¡å•† | 400-XXX-XXXX | äº‘èµ„æºé—®é¢˜ |
| æ•°æ®åº“æœåŠ¡å•† | 400-XXX-XXXX | æ•°æ®åº“æŠ€æœ¯æ”¯æŒ |
| ç›‘æ§æœåŠ¡å•† | 400-XXX-XXXX | ç›‘æ§ç³»ç»Ÿæ”¯æŒ |
| å®‰å…¨æœåŠ¡å•† | 400-XXX-XXXX | å®‰å…¨äº‹ä»¶å“åº” |

---

**æ‰‹å†Œç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´11æœˆ29æ—¥
**æœ€åæ›´æ–°**: 2025å¹´11æœˆ29æ—¥
**æ–‡æ¡£çŠ¶æ€**: å¾…éªŒæ”¶

**é‡è¦æé†’**:
1. æœ¬æ‰‹å†Œæ˜¯IOE-DREAMå¾®æœåŠ¡æ¶æ„è¿ç»´çš„æ ¸å¿ƒæ–‡æ¡£
2. è¿ç»´å›¢é˜Ÿåº”ä¸¥æ ¼æŒ‰ç…§æœ¬æ‰‹å†Œæ‰§è¡Œè¿ç»´æ“ä½œ
3. å‘ç°é—®é¢˜æˆ–æ”¹è¿›å»ºè®®è¯·åŠæ—¶åé¦ˆ
4. å®šæœŸæ›´æ–°å’Œç»´æŠ¤æ‰‹å†Œå†…å®¹