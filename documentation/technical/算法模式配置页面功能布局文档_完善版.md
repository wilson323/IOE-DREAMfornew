# 算法模式配置页面功能与布局文档

## 页面概述
算法模式配置页面是智能视频监控系统中的核心算法管理界面，用于配置和管理各类智能算法的运行参数、检测区域、输出选项等。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供完整的算法配置、测试、调优功能，包括行为分析算法（入侵检测、徘徊检测、斗殴检测）、目标检测算法（人员检测、人脸检测）、智能分析算法（人数统计、密度分析）等多种算法类型的参数配置。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue

### 项目文件组织结构
```
src/views/business/smart-video/
├── algorithm-mode.vue                  # 算法模式配置主页面
├── components/
│   ├── AlgorithmSelector.vue          # 算法选择组件
│   ├── AlgorithmConfigForm.vue        # 算法配置表单组件
│   ├── DetectionAreaEditor.vue        # 检测区域编辑组件
│   ├── AlgorithmTestModal.vue         # 算法测试弹窗组件
│   ├── AlgorithmTemplateModal.vue     # 算法模板管理组件
│   └── AlgorithmStatusPanel.vue       # 算法状态面板组件
├── mock/
│   └── algorithm-mock-data.js         # 模拟数据
└── api/
    └── algorithm-api.js                # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/algorithm-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const algorithmApi = {
  // 查询算法列表
  queryAlgorithmList: (params) => getRequest('/algorithm/list', params),

  // 获取算法配置
  getAlgorithmConfig: (algorithmId) => getRequest(`/algorithm/config/${algorithmId}`),

  // 保存算法配置
  saveAlgorithmConfig: (params) => postRequest('/algorithm/config/save', params),

  // 更新算法配置
  updateAlgorithmConfig: (params) => postRequest('/algorithm/config/update', params),

  // 删除算法配置
  deleteAlgorithmConfig: (id) => getRequest(`/algorithm/config/delete/${id}`),

  // 测试算法
  testAlgorithm: (params) => postRequest('/algorithm/test', params),

  // 启用/禁用算法
  toggleAlgorithm: (params) => postRequest('/algorithm/toggle', params),

  // 获取算法运行状态
  getAlgorithmStatus: (algorithmId) => getRequest(`/algorithm/status/${algorithmId}`),

  // 获取算法统计信息
  getAlgorithmStats: (algorithmId) => getRequest(`/algorithm/stats/${algorithmId}`),

  // 添加检测区域
  addDetectionArea: (params) => postRequest('/algorithm/area/add', params),

  // 更新检测区域
  updateDetectionArea: (params) => postRequest('/algorithm/area/update', params),

  // 删除检测区域
  deleteDetectionArea: (id) => getRequest(`/algorithm/area/delete/${id}`),

  // 获取检测区域列表
  getDetectionAreaList: (algorithmId) => getRequest(`/algorithm/area/list/${algorithmId}`),

  // 导出算法配置
  exportConfig: (algorithmId) => postRequest('/algorithm/config/export', { algorithmId }),

  // 导入算法配置
  importConfig: (file) => postRequest('/algorithm/config/import', file),

  // 保存配置模板
  saveTemplate: (params) => postRequest('/algorithm/template/save', params),

  // 获取配置模板列表
  getTemplateList: () => getRequest('/algorithm/template/list'),

  // 应用配置模板
  applyTemplate: (params) => postRequest('/algorithm/template/apply', params),

  // 获取算法性能指标
  getPerformanceMetrics: (algorithmId) => getRequest(`/algorithm/performance/${algorithmId}`),

  // 获取最近检测记录
  getRecentDetections: (algorithmId, params) => getRequest(`/algorithm/detections/${algorithmId}`, params),

  // 批量保存算法配置
  batchSaveConfig: (params) => postRequest('/algorithm/config/batch/save', params),

  // 同步算法到设备
  syncToDevice: (params) => postRequest('/algorithm/sync/device', params),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="算法配置">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="算法配置"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { AlgorithmOutlined } from '@ant-design/icons-vue';  // ❌ 不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  SettingOutlined,       // ✅ 设置/配置
  ExperimentOutlined,    // ✅ 实验/算法
  PlayCircleOutlined,    // ✅ 测试/运行
  SaveOutlined,          // ✅ 保存
  DownloadOutlined,      // ✅ 导出
  UploadOutlined,        // ✅ 导入
  SyncOutlined,          // ✅ 刷新/同步
  UserOutlined,          // ✅ 人员
  TeamOutlined,          // ✅ 人群
  EyeOutlined,           // ✅ 检测/查看
  SafetyOutlined,        // ✅ 安全/防护
  DashboardOutlined,     // ✅ 仪表盘/性能
  BarChartOutlined,      // ✅ 统计/图表
  EnvironmentOutlined,   // ✅ 位置/区域
  BulbOutlined,          // ✅ 智能
  ThunderboltOutlined,   // ✅ 快速/性能
  ControlOutlined,       // ✅ 控制
  SlidersFilled,         // ✅ 参数调节
  AimOutlined,           // ✅ 目标/精准
  AlertOutlined,         // ✅ 告警
} from '@ant-design/icons-vue';
</script>
```

### 3. API导入路径注意事项

#### ✅ 正确：使用项目标准导入路径
```javascript
// 正确：使用项目中实际的axios文件
import { postRequest, getRequest } from '/@/lib/axios';
```

### 4. 算法类型枚举定义

#### ✅ 标准算法类型枚举
```javascript
// src/constants/business/algorithm-const.js
export const ALGORITHM_CATEGORY_ENUM = {
  BEHAVIOR: {
    value: 'behavior',
    label: '行为分析',
    icon: 'SafetyOutlined',
  },
  TARGET: {
    value: 'target',
    label: '目标检测',
    icon: 'AimOutlined',
  },
  SMART: {
    value: 'smart',
    label: '智能分析',
    icon: 'BulbOutlined',
  },
};

export const ALGORITHM_TYPE_ENUM = {
  // 行为分析算法
  BEHAVIOR_INTRUSION: {
    value: 'behavior-intrusion',
    label: '入侵检测',
    category: 'behavior',
    icon: 'SafetyOutlined',
    description: '人员入侵检测',
  },
  BEHAVIOR_LOITERING: {
    value: 'behavior-loitering',
    label: '徘徊检测',
    category: 'behavior',
    icon: 'UserOutlined',
    description: '异常徘徊行为',
  },
  BEHAVIOR_FIGHTING: {
    value: 'behavior-fighting',
    label: '斗殴检测',
    category: 'behavior',
    icon: 'AlertOutlined',
    description: '暴力行为识别',
  },

  // 目标检测算法
  TARGET_PERSON: {
    value: 'target-person',
    label: '人员检测',
    category: 'target',
    icon: 'UserOutlined',
    description: '人体识别检测',
  },
  TARGET_FACE: {
    value: 'target-face',
    label: '人脸检测',
    category: 'target',
    icon: 'EyeOutlined',
    description: '人脸识别检测',
  },

  // 智能分析算法
  SMART_COUNTING: {
    value: 'smart-counting',
    label: '人数统计',
    category: 'smart',
    icon: 'BarChartOutlined',
    description: '区域人数统计',
  },
  SMART_DENSITY: {
    value: 'smart-density',
    label: '密度分析',
    category: 'smart',
    icon: 'DashboardOutlined',
    description: '人群密度分析',
  },
};

export const ALGORITHM_STATUS_ENUM = {
  ENABLED: {
    value: 'enabled',
    label: '启用',
    color: 'success',
  },
  DISABLED: {
    value: 'disabled',
    label: '禁用',
    color: 'default',
  },
  TESTING: {
    value: 'testing',
    label: '测试中',
    color: 'warning',
  },
};

export const TRACKING_MODE_ENUM = {
  NONE: {
    value: 'none',
    label: '不追踪',
    description: '不进行目标追踪',
  },
  SHORT: {
    value: 'short',
    label: '短时追踪',
    description: '短时间内追踪目标（5-10秒）',
  },
  LONG: {
    value: 'long',
    label: '长时追踪',
    description: '长时间追踪目标（30秒-1分钟）',
  },
  GLOBAL: {
    value: 'global',
    label: '全局追踪',
    description: '跨区域全局追踪目标',
  },
};

export const OUTPUT_FORMAT_ENUM = {
  JSON: {
    value: 'json',
    label: 'JSON格式',
  },
  XML: {
    value: 'xml',
    label: 'XML格式',
  },
  CSV: {
    value: 'csv',
    label: 'CSV格式',
  },
  CUSTOM: {
    value: 'custom',
    label: '自定义格式',
  },
};
```

## 核心功能模块

### 1. 页面布局结构

#### 整体布局
页面采用三栏布局：
- **左侧栏（320px）**：算法列表和分类导航
- **中间主区域（flex-1）**：算法配置表单区域
- **右侧栏（320px）**：算法状态监控和统计信息

#### 技术实现
```vue
<template>
  <div class="algorithm-mode-page">
    <!-- 头部工具栏 -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">算法模式配置</h1>
        <a-tag color="blue">
          <ControlOutlined />
          当前模式: {{ currentModeName }}
        </a-tag>
      </div>
      <div class="header-actions">
        <a-space>
          <a-button @click="refreshAlgorithms">
            <template #icon><SyncOutlined /></template>
            刷新算法
          </a-button>
          <a-button @click="saveConfiguration">
            <template #icon><SaveOutlined /></template>
            保存配置
          </a-button>
          <a-button @click="exportConfig">
            <template #icon><DownloadOutlined /></template>
            导出配置
          </a-button>
        </a-space>
      </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="page-content">
      <!-- 左侧算法列表 -->
      <div class="algorithm-sidebar">
        <AlgorithmSelector
          :selected-algorithm="selectedAlgorithm"
          @select="handleAlgorithmSelect"
        />
      </div>

      <!-- 中间配置区域 -->
      <div class="algorithm-config-area">
        <AlgorithmConfigForm
          :algorithm-id="selectedAlgorithm"
          :config-data="algorithmConfig"
          @save="handleSaveConfig"
        />
      </div>

      <!-- 右侧状态面板 -->
      <div class="algorithm-status-sidebar">
        <AlgorithmStatusPanel
          :algorithm-id="selectedAlgorithm"
        />
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  SyncOutlined,
  SaveOutlined,
  DownloadOutlined,
  ControlOutlined,
} from '@ant-design/icons-vue';
import AlgorithmSelector from './components/AlgorithmSelector.vue';
import AlgorithmConfigForm from './components/AlgorithmConfigForm.vue';
import AlgorithmStatusPanel from './components/AlgorithmStatusPanel.vue';
import { algorithmApi } from '/@/api/business/smart-video/algorithm-api';

const selectedAlgorithm = ref('behavior-intrusion');
const algorithmConfig = ref({});
const currentModeName = ref('智能分析模式');

const handleAlgorithmSelect = (algorithmId) => {
  selectedAlgorithm.value = algorithmId;
  loadAlgorithmConfig(algorithmId);
};

const loadAlgorithmConfig = async (algorithmId) => {
  try {
    const response = await algorithmApi.getAlgorithmConfig(algorithmId);
    if (response.code === 1) {
      algorithmConfig.value = response.data;
    }
  } catch (error) {
    console.error('加载算法配置失败:', error);
    message.error('加载配置失败');
  }
};

const handleSaveConfig = async (configData) => {
  try {
    const response = await algorithmApi.saveAlgorithmConfig(configData);
    if (response.code === 1) {
      message.success('配置保存成功');
    } else {
      message.error(response.msg || '保存失败');
    }
  } catch (error) {
    console.error('保存配置失败:', error);
    message.error('保存失败');
  }
};

const refreshAlgorithms = () => {
  message.loading('正在刷新算法列表...', 1);
  loadAlgorithmConfig(selectedAlgorithm.value);
};

const saveConfiguration = () => {
  // 触发配置保存
  handleSaveConfig(algorithmConfig.value);
};

const exportConfig = async () => {
  try {
    const response = await algorithmApi.exportConfig(selectedAlgorithm.value);
    if (response.code === 1) {
      // 下载配置文件
      const blob = new Blob([JSON.stringify(response.data, null, 2)], {
        type: 'application/json',
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `algorithm-config-${selectedAlgorithm.value}-${Date.now()}.json`;
      a.click();
      window.URL.revokeObjectURL(url);
      message.success('配置导出成功');
    }
  } catch (error) {
    console.error('导出配置失败:', error);
    message.error('导出失败');
  }
};

onMounted(() => {
  loadAlgorithmConfig(selectedAlgorithm.value);
});
</script>

<style lang="less" scoped>
.algorithm-mode-page {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #f0f2f5;

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: #fff;
    border-bottom: 1px solid #e8e8e8;

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;

      .page-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.85);
      }
    }
  }

  .page-content {
    flex: 1;
    display: flex;
    overflow: hidden;

    .algorithm-sidebar {
      width: 320px;
      background: #fff;
      border-right: 1px solid #e8e8e8;
      overflow-y: auto;
    }

    .algorithm-config-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .algorithm-status-sidebar {
      width: 320px;
      background: #fff;
      border-left: 1px solid #e8e8e8;
      overflow-y: auto;
    }
  }
}
</style>
```

### 2. 算法选择组件（左侧边栏）

**组件路径**: `src/views/business/smart-video/components/AlgorithmSelector.vue`

**技术实现**:
```vue
<template>
  <div class="algorithm-selector">
    <div class="selector-header">
      <h3 class="selector-title">算法列表</h3>
    </div>

    <!-- 搜索框 -->
    <div class="search-box">
      <a-input
        v-model:value="searchKeyword"
        placeholder="搜索算法..."
        allow-clear
      >
        <template #prefix>
          <SearchOutlined />
        </template>
      </a-input>
    </div>

    <!-- 算法分类列表 -->
    <div class="algorithm-categories">
      <!-- 行为分析算法 -->
      <div class="category-section">
        <h4 class="category-title">
          <SafetyOutlined />
          行为分析
        </h4>
        <div class="algorithm-list">
          <div
            v-for="algo in behaviorAlgorithms"
            :key="algo.id"
            :class="['algorithm-item', { active: selectedAlgorithm === algo.id }]"
            @click="selectAlgorithm(algo.id)"
          >
            <div class="algorithm-icon">
              <component :is="algo.icon" />
            </div>
            <div class="algorithm-info">
              <div class="algorithm-name">{{ algo.name }}</div>
              <div class="algorithm-desc">{{ algo.description }}</div>
            </div>
            <div class="algorithm-status">
              <a-badge :status="algo.status === 'online' ? 'success' : 'default'" />
            </div>
          </div>
        </div>
      </div>

      <!-- 目标检测算法 -->
      <div class="category-section">
        <h4 class="category-title">
          <AimOutlined />
          目标检测
        </h4>
        <div class="algorithm-list">
          <div
            v-for="algo in targetAlgorithms"
            :key="algo.id"
            :class="['algorithm-item', { active: selectedAlgorithm === algo.id }]"
            @click="selectAlgorithm(algo.id)"
          >
            <div class="algorithm-icon">
              <component :is="algo.icon" />
            </div>
            <div class="algorithm-info">
              <div class="algorithm-name">{{ algo.name }}</div>
              <div class="algorithm-desc">{{ algo.description }}</div>
            </div>
            <div class="algorithm-status">
              <a-badge :status="algo.status === 'online' ? 'success' : 'default'" />
            </div>
          </div>
        </div>
      </div>

      <!-- 智能分析算法 -->
      <div class="category-section">
        <h4 class="category-title">
          <BulbOutlined />
          智能分析
        </h4>
        <div class="algorithm-list">
          <div
            v-for="algo in smartAlgorithms"
            :key="algo.id"
            :class="['algorithm-item', { active: selectedAlgorithm === algo.id }]"
            @click="selectAlgorithm(algo.id)"
          >
            <div class="algorithm-icon">
              <component :is="algo.icon" />
            </div>
            <div class="algorithm-info">
              <div class="algorithm-name">{{ algo.name }}</div>
              <div class="algorithm-desc">{{ algo.description }}</div>
            </div>
            <div class="algorithm-status">
              <a-badge :status="algo.status === 'online' ? 'success' : 'default'" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import {
  SearchOutlined,
  SafetyOutlined,
  AimOutlined,
  BulbOutlined,
  UserOutlined,
  EyeOutlined,
  AlertOutlined,
  BarChartOutlined,
  DashboardOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  selectedAlgorithm: {
    type: String,
    default: '',
  },
});

const emit = defineEmits(['select']);

const searchKeyword = ref('');

const behaviorAlgorithms = ref([
  {
    id: 'behavior-intrusion',
    name: '入侵检测',
    description: '人员入侵检测',
    icon: SafetyOutlined,
    status: 'online',
  },
  {
    id: 'behavior-loitering',
    name: '徘徊检测',
    description: '异常徘徊行为',
    icon: UserOutlined,
    status: 'online',
  },
  {
    id: 'behavior-fighting',
    name: '斗殴检测',
    description: '暴力行为识别',
    icon: AlertOutlined,
    status: 'offline',
  },
]);

const targetAlgorithms = ref([
  {
    id: 'target-person',
    name: '人员检测',
    description: '人体识别检测',
    icon: UserOutlined,
    status: 'online',
  },
  {
    id: 'target-face',
    name: '人脸检测',
    description: '人脸识别检测',
    icon: EyeOutlined,
    status: 'online',
  },
]);

const smartAlgorithms = ref([
  {
    id: 'smart-counting',
    name: '人数统计',
    description: '区域人数统计',
    icon: BarChartOutlined,
    status: 'online',
  },
  {
    id: 'smart-density',
    name: '密度分析',
    description: '人群密度分析',
    icon: DashboardOutlined,
    status: 'online',
  },
]);

const selectAlgorithm = (algorithmId) => {
  emit('select', algorithmId);
};
</script>

<style lang="less" scoped>
.algorithm-selector {
  padding: 16px;

  .selector-header {
    margin-bottom: 16px;

    .selector-title {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.85);
    }
  }

  .search-box {
    margin-bottom: 16px;
  }

  .algorithm-categories {
    .category-section {
      margin-bottom: 24px;

      .category-title {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 0 12px;
        font-size: 14px;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.65);
      }

      .algorithm-list {
        display: flex;
        flex-direction: column;
        gap: 8px;

        .algorithm-item {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          background: #fafafa;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s;

          &:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          &.active {
            background: #e6f7ff;
            border: 2px solid #1890ff;
          }

          .algorithm-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 6px;
            font-size: 16px;
            color: rgba(0, 0, 0, 0.65);
          }

          .algorithm-info {
            flex: 1;

            .algorithm-name {
              font-size: 14px;
              font-weight: 500;
              color: rgba(0, 0, 0, 0.85);
              margin-bottom: 4px;
            }

            .algorithm-desc {
              font-size: 12px;
              color: rgba(0, 0, 0, 0.45);
            }
          }

          .algorithm-status {
            display: flex;
            align-items: center;
          }
        }
      }
    }
  }
}
</style>
```

### 3. 算法配置表单组件（中间主区域）

**组件路径**: `src/views/business/smart-video/components/AlgorithmConfigForm.vue`

**技术实现**:
```vue
<template>
  <div class="algorithm-config-form">
    <a-form
      ref="formRef"
      :model="formData"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
    >
      <!-- 算法基本信息 -->
      <a-card title="算法基本信息" class="config-card" :bordered="false">
        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="算法名称" name="algorithmName">
              <a-input v-model:value="formData.algorithmName" placeholder="请输入算法名称" />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="算法版本">
              <a-input v-model:value="formData.version" disabled />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="算法状态" name="status">
              <a-select v-model:value="formData.status" placeholder="请选择状态">
                <a-select-option value="enabled">启用</a-select-option>
                <a-select-option value="disabled">禁用</a-select-option>
                <a-select-option value="testing">测试中</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="绑定设备" name="deviceId">
              <a-select
                v-model:value="formData.deviceId"
                placeholder="请选择设备"
                show-search
                allow-clear
              >
                <a-select-option
                  v-for="device in deviceList"
                  :key="device.id"
                  :value="device.id"
                >
                  {{ device.name }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
        </a-row>

        <a-form-item label="算法描述" name="description">
          <a-textarea
            v-model:value="formData.description"
            placeholder="请输入算法描述"
            :rows="3"
            allow-clear
          />
        </a-form-item>
      </a-card>

      <!-- 检测参数配置 -->
      <a-card title="检测参数配置" class="config-card" :bordered="false">
        <!-- 检测灵敏度 -->
        <a-form-item label="检测灵敏度" name="sensitivity">
          <div class="slider-container">
            <a-slider
              v-model:value="formData.sensitivity"
              :min="1"
              :max="100"
              :marks="{ 1: '低', 50: '中', 100: '高' }"
            />
            <span class="slider-value">{{ formData.sensitivity }}</span>
          </div>
        </a-form-item>

        <!-- 检测间隔 -->
        <a-form-item label="检测间隔" name="detectionInterval">
          <a-input-number
            v-model:value="formData.detectionInterval"
            :min="0.1"
            :max="10"
            :step="0.1"
            addon-after="秒"
            style="width: 200px"
          />
          <span class="form-hint">建议值: 1-3秒</span>
        </a-form-item>

        <!-- 最小目标尺寸 -->
        <a-form-item label="最小目标尺寸">
          <a-row :gutter="16">
            <a-col :span="12">
              <a-form-item label="宽度" name="minWidth">
                <a-input-number
                  v-model:value="formData.minWidth"
                  :min="10"
                  :max="200"
                  addon-after="像素"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="高度" name="minHeight">
                <a-input-number
                  v-model:value="formData.minHeight"
                  :min="10"
                  :max="200"
                  addon-after="像素"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
          </a-row>
        </a-form-item>

        <!-- 置信度阈值 -->
        <a-form-item label="置信度阈值" name="confidence">
          <div class="slider-container">
            <a-slider
              v-model:value="formData.confidence"
              :min="50"
              :max="95"
              :marks="{ 50: '50%', 70: '70%', 95: '95%' }"
            />
            <span class="slider-value">{{ formData.confidence }}%</span>
          </div>
        </a-form-item>

        <!-- 追踪模式 -->
        <a-form-item label="目标追踪模式" name="trackingMode">
          <a-select v-model:value="formData.trackingMode" placeholder="请选择追踪模式">
            <a-select-option value="none">不追踪</a-select-option>
            <a-select-option value="short">短时追踪</a-select-option>
            <a-select-option value="long">长时追踪</a-select-option>
            <a-select-option value="global">全局追踪</a-select-option>
          </a-select>
        </a-form-item>
      </a-card>

      <!-- 检测区域配置 -->
      <a-card title="检测区域配置" class="config-card" :bordered="false">
        <template #extra>
          <a-button type="link" @click="addDetectionArea">
            <template #icon><PlusOutlined /></template>
            添加区域
          </a-button>
        </template>

        <a-table
          :columns="areaColumns"
          :data-source="detectionAreas"
          :pagination="false"
          size="small"
          bordered
        >
          <template #bodyCell="{ column, record }">
            <template v-if="column.dataIndex === 'status'">
              <a-tag :color="record.status === 'enabled' ? 'success' : 'default'">
                {{ record.status === 'enabled' ? '启用' : '禁用' }}
              </a-tag>
            </template>
            <template v-else-if="column.dataIndex === 'action'">
              <a-space>
                <a-button type="link" size="small" @click="editArea(record)">
                  <EditOutlined />
                </a-button>
                <a-popconfirm
                  title="确定删除此区域吗？"
                  @confirm="deleteArea(record)"
                >
                  <a-button type="link" size="small" danger>
                    <DeleteOutlined />
                  </a-button>
                </a-popconfirm>
              </a-space>
            </template>
          </template>
        </a-table>
      </a-card>

      <!-- 输出配置 -->
      <a-card title="输出配置" class="config-card" :bordered="false">
        <!-- 告警输出 -->
        <a-form-item label="告警输出">
          <a-checkbox-group v-model:value="formData.outputOptions">
            <a-checkbox value="generateAlert">生成告警事件</a-checkbox>
            <a-checkbox value="saveSnapshot">保存检测截图</a-checkbox>
            <a-checkbox value="saveVideo">输出检测视频</a-checkbox>
          </a-checkbox-group>
        </a-form-item>

        <!-- 数据格式 -->
        <a-form-item label="数据格式" name="dataFormat">
          <a-select v-model:value="formData.dataFormat" placeholder="请选择数据格式">
            <a-select-option value="json">JSON格式</a-select-option>
            <a-select-option value="xml">XML格式</a-select-option>
            <a-select-option value="csv">CSV格式</a-select-option>
            <a-select-option value="custom">自定义格式</a-select-option>
          </a-select>
        </a-form-item>

        <!-- 输出路径 -->
        <a-form-item label="输出路径" name="outputPath">
          <a-input
            v-model:value="formData.outputPath"
            placeholder="请输入输出路径"
            addon-before="/data/algorithm/"
          >
            <template #suffix>
              <FolderOpenOutlined />
            </template>
          </a-input>
        </a-form-item>
      </a-card>

      <!-- 操作按钮 -->
      <a-card :bordered="false" class="action-card">
        <a-space size="large">
          <a-button type="primary" danger @click="testAlgorithm" :loading="testing">
            <template #icon><PlayCircleOutlined /></template>
            测试算法
          </a-button>
          <a-button @click="resetForm">
            <template #icon><ReloadOutlined /></template>
            重置配置
          </a-button>
          <a-button type="primary" @click="handleSave" :loading="saving">
            <template #icon><SaveOutlined /></template>
            保存配置
          </a-button>
        </a-space>
      </a-card>
    </a-form>
  </div>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  FolderOpenOutlined,
  PlayCircleOutlined,
  ReloadOutlined,
  SaveOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  algorithmId: {
    type: String,
    default: '',
  },
  configData: {
    type: Object,
    default: () => ({}),
  },
});

const emit = defineEmits(['save']);

const formRef = ref();
const testing = ref(false);
const saving = ref(false);

const formData = reactive({
  algorithmName: '入侵检测算法',
  version: 'v2.1.0',
  status: 'enabled',
  deviceId: undefined,
  description: '基于深度学习的人员入侵检测算法，能够准确识别未经授权进入特定区域的人员行为。',
  sensitivity: 75,
  detectionInterval: 1,
  minWidth: 32,
  minHeight: 64,
  confidence: 80,
  trackingMode: 'long',
  outputOptions: ['generateAlert', 'saveSnapshot'],
  dataFormat: 'json',
  outputPath: 'output/',
});

const deviceList = ref([
  { id: 1, name: '前门摄像头-001' },
  { id: 2, name: '大厅摄像头-002' },
  { id: 3, name: '走廊摄像头-003' },
]);

const areaColumns = [
  { title: '区域名称', dataIndex: 'name', key: 'name' },
  { title: '状态', dataIndex: 'status', key: 'status', width: 100 },
  { title: '操作', dataIndex: 'action', key: 'action', width: 120 },
];

const detectionAreas = ref([
  { id: 1, name: '主要入口', status: 'enabled' },
  { id: 2, name: '敏感区域A', status: 'enabled' },
]);

// 监听配置数据变化
watch(
  () => props.configData,
  (newVal) => {
    if (newVal && Object.keys(newVal).length > 0) {
      Object.assign(formData, newVal);
    }
  },
  { deep: true }
);

const addDetectionArea = () => {
  message.info('打开区域编辑器');
};

const editArea = (record) => {
  message.info(`编辑区域: ${record.name}`);
};

const deleteArea = (record) => {
  const index = detectionAreas.value.findIndex(item => item.id === record.id);
  if (index > -1) {
    detectionAreas.value.splice(index, 1);
    message.success('区域已删除');
  }
};

const testAlgorithm = async () => {
  testing.value = true;
  message.loading('正在测试算法性能...', 0);

  // 模拟测试
  setTimeout(() => {
    testing.value = false;
    message.destroy();
    message.success('算法测试完成！准确率: 97.5%');
  }, 2000);
};

const resetForm = () => {
  formRef.value?.resetFields();
  message.info('配置已重置');
};

const handleSave = async () => {
  try {
    await formRef.value?.validate();
    saving.value = true;

    emit('save', {
      algorithmId: props.algorithmId,
      ...formData,
    });

    saving.value = false;
  } catch (error) {
    console.error('表单验证失败:', error);
  }
};
</script>

<style lang="less" scoped>
.algorithm-config-form {
  .config-card {
    margin-bottom: 16px;
    border-radius: 8px;

    :deep(.ant-card-head) {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
  }

  .action-card {
    text-align: center;
    border-radius: 8px;
  }

  .slider-container {
    display: flex;
    align-items: center;
    gap: 16px;

    .ant-slider {
      flex: 1;
    }

    .slider-value {
      min-width: 40px;
      text-align: right;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.85);
    }
  }

  .form-hint {
    margin-left: 12px;
    font-size: 12px;
    color: rgba(0, 0, 0, 0.45);
  }
}
</style>
```

### 4. 算法状态面板组件（右侧边栏）

**组件路径**: `src/views/business/smart-video/components/AlgorithmStatusPanel.vue`

**技术实现**:
```vue
<template>
  <div class="algorithm-status-panel">
    <!-- 算法状态 -->
    <div class="panel-section">
      <h3 class="section-title">算法状态</h3>
      <div class="status-list">
        <div class="status-item">
          <span class="status-label">运行状态</span>
          <a-tag :color="statusInfo.running ? 'success' : 'default'">
            {{ statusInfo.running ? '运行中' : '已停止' }}
          </a-tag>
        </div>
        <div class="status-item">
          <span class="status-label">启动时间</span>
          <span class="status-value">{{ statusInfo.startTime }}</span>
        </div>
        <div class="status-item">
          <span class="status-label">运行时长</span>
          <span class="status-value">{{ statusInfo.runningTime }}</span>
        </div>
        <div class="status-item">
          <span class="status-label">处理帧数</span>
          <span class="status-value">{{ statusInfo.processedFrames }}</span>
        </div>
      </div>
    </div>

    <!-- 性能指标 -->
    <div class="panel-section">
      <h3 class="section-title">性能指标</h3>
      <div class="performance-list">
        <div class="performance-item">
          <div class="performance-label">
            <DashboardOutlined />
            CPU使用率
          </div>
          <a-progress
            :percent="performanceMetrics.cpu"
            :stroke-color="getProgressColor(performanceMetrics.cpu)"
            size="small"
          />
        </div>
        <div class="performance-item">
          <div class="performance-label">
            <ThunderboltOutlined />
            GPU使用率
          </div>
          <a-progress
            :percent="performanceMetrics.gpu"
            :stroke-color="getProgressColor(performanceMetrics.gpu)"
            size="small"
          />
        </div>
        <div class="performance-item">
          <div class="performance-label">
            <DatabaseOutlined />
            内存使用
          </div>
          <a-progress
            :percent="performanceMetrics.memory"
            :stroke-color="getProgressColor(performanceMetrics.memory)"
            size="small"
          />
        </div>
        <div class="performance-item">
          <div class="performance-label">
            <RocketOutlined />
            处理帧率
          </div>
          <div class="performance-value">{{ performanceMetrics.fps }} FPS</div>
        </div>
      </div>
    </div>

    <!-- 最近检测 -->
    <div class="panel-section">
      <h3 class="section-title">最近检测</h3>
      <div class="detection-list">
        <div
          v-for="detection in recentDetections"
          :key="detection.id"
          :class="['detection-item', `detection-${detection.level}`]"
        >
          <div class="detection-icon">
            <component :is="getDetectionIcon(detection.level)" />
          </div>
          <div class="detection-info">
            <div class="detection-title">{{ detection.title }}</div>
            <div class="detection-location">{{ detection.location }}</div>
            <div class="detection-meta">
              <span class="detection-time">{{ detection.time }}</span>
              <span class="detection-confidence">置信度: {{ detection.confidence }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 统计信息 -->
    <div class="panel-section">
      <h3 class="section-title">统计信息</h3>
      <div class="statistics-list">
        <div class="statistic-item">
          <span class="statistic-label">今日检测次数</span>
          <span class="statistic-value">{{ statistics.todayCount }}</span>
        </div>
        <div class="statistic-item">
          <span class="statistic-label">误报率</span>
          <span class="statistic-value">{{ statistics.falsePositiveRate }}%</span>
        </div>
        <div class="statistic-item">
          <span class="statistic-label">平均处理时间</span>
          <span class="statistic-value">{{ statistics.avgProcessTime }}ms</span>
        </div>
        <div class="statistic-item">
          <span class="statistic-label">准确率</span>
          <span class="statistic-value">{{ statistics.accuracy }}%</span>
        </div>
      </div>

      <a-button type="primary" block @click="viewDetailedStats" style="margin-top: 16px">
        <template #icon><BarChartOutlined /></template>
        查看详细统计
      </a-button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';
import {
  DashboardOutlined,
  ThunderboltOutlined,
  DatabaseOutlined,
  RocketOutlined,
  BarChartOutlined,
  ExclamationCircleOutlined,
  WarningOutlined,
  InfoCircleOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  algorithmId: {
    type: String,
    default: '',
  },
});

const statusInfo = ref({
  running: true,
  startTime: '2024-01-30 14:25:30',
  runningTime: '2小时15分钟',
  processedFrames: '823,456',
});

const performanceMetrics = ref({
  cpu: 45,
  gpu: 72,
  memory: 56,
  fps: 28.5,
});

const recentDetections = ref([
  {
    id: 1,
    level: 'error',
    title: '人员入侵检测',
    location: '主入口',
    time: '2分钟前',
    confidence: 92,
  },
  {
    id: 2,
    level: 'warning',
    title: '异常徘徊检测',
    location: '停车场',
    time: '5分钟前',
    confidence: 87,
  },
  {
    id: 3,
    level: 'info',
    title: '人员计数更新',
    location: '大厅',
    time: '8分钟前',
    confidence: 95,
  },
]);

const statistics = ref({
  todayCount: 1234,
  falsePositiveRate: 2.3,
  avgProcessTime: 125,
  accuracy: 97.7,
});

let updateTimer = null;

onMounted(() => {
  startAutoUpdate();
});

onUnmounted(() => {
  stopAutoUpdate();
});

const startAutoUpdate = () => {
  updateTimer = setInterval(() => {
    // 模拟数据更新
    performanceMetrics.value.cpu = Math.floor(Math.random() * 30) + 40;
    performanceMetrics.value.gpu = Math.floor(Math.random() * 20) + 60;
    performanceMetrics.value.memory = Math.floor(Math.random() * 20) + 50;
  }, 5000);
};

const stopAutoUpdate = () => {
  if (updateTimer) {
    clearInterval(updateTimer);
  }
};

const getProgressColor = (percent) => {
  if (percent < 60) return '#52c41a';
  if (percent < 80) return '#faad14';
  return '#ff4d4f';
};

const getDetectionIcon = (level) => {
  const iconMap = {
    error: ExclamationCircleOutlined,
    warning: WarningOutlined,
    info: InfoCircleOutlined,
  };
  return iconMap[level] || InfoCircleOutlined;
};

const viewDetailedStats = () => {
  console.log('查看详细统计');
};
</script>

<style lang="less" scoped>
.algorithm-status-panel {
  .panel-section {
    padding: 16px;
    border-bottom: 1px solid #f0f0f0;

    &:last-child {
      border-bottom: none;
    }

    .section-title {
      margin: 0 0 16px;
      font-size: 16px;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.85);
    }
  }

  .status-list {
    display: flex;
    flex-direction: column;
    gap: 12px;

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .status-label {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.65);
      }

      .status-value {
        font-size: 14px;
        font-weight: 500;
        color: rgba(0, 0, 0, 0.85);
      }
    }
  }

  .performance-list {
    display: flex;
    flex-direction: column;
    gap: 16px;

    .performance-item {
      .performance-label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 13px;
        color: rgba(0, 0, 0, 0.65);
      }

      .performance-value {
        font-size: 14px;
        font-weight: 600;
        color: #1890ff;
      }
    }
  }

  .detection-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 300px;
    overflow-y: auto;

    .detection-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;

      &.detection-error {
        background: #fff2f0;
        border: 1px solid #ffccc7;

        .detection-icon {
          color: #ff4d4f;
        }
      }

      &.detection-warning {
        background: #fffbe6;
        border: 1px solid #ffe58f;

        .detection-icon {
          color: #faad14;
        }
      }

      &.detection-info {
        background: #f0f0f0;
        border: 1px solid #d9d9d9;

        .detection-icon {
          color: rgba(0, 0, 0, 0.65);
        }
      }

      .detection-icon {
        flex-shrink: 0;
        font-size: 16px;
      }

      .detection-info {
        flex: 1;

        .detection-title {
          font-size: 14px;
          font-weight: 500;
          color: rgba(0, 0, 0, 0.85);
          margin-bottom: 4px;
        }

        .detection-location {
          font-size: 12px;
          color: rgba(0, 0, 0, 0.65);
          margin-bottom: 4px;
        }

        .detection-meta {
          display: flex;
          justify-content: space-between;
          font-size: 12px;
          color: rgba(0, 0, 0, 0.45);
        }
      }
    }
  }

  .statistics-list {
    display: flex;
    flex-direction: column;
    gap: 12px;

    .statistic-item {
      display: flex;
      justify-content: space-between;
      align-items: center;

      .statistic-label {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.65);
      }

      .statistic-value {
        font-size: 16px;
        font-weight: 600;
        color: #1890ff;
      }
    }
  }
}
</style>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/algorithm-mock-data.js
export const mockAlgorithmList = [
  {
    id: 'behavior-intrusion',
    name: '入侵检测算法',
    type: 'behavior',
    category: 'behavior',
    version: 'v2.1.0',
    status: 'enabled',
    description: '基于深度学习的人员入侵检测算法，能够准确识别未经授权进入特定区域的人员行为。',
    icon: 'SafetyOutlined',
  },
  {
    id: 'behavior-loitering',
    name: '徘徊检测算法',
    type: 'behavior',
    category: 'behavior',
    version: 'v1.8.5',
    status: 'enabled',
    description: '检测人员在特定区域的异常徘徊行为，适用于安全监控场景。',
    icon: 'UserOutlined',
  },
  {
    id: 'behavior-fighting',
    name: '斗殴检测算法',
    type: 'behavior',
    category: 'behavior',
    version: 'v1.5.2',
    status: 'testing',
    description: '识别暴力行为和斗殴事件，及时预警。',
    icon: 'AlertOutlined',
  },
  {
    id: 'target-person',
    name: '人员检测算法',
    type: 'target',
    category: 'target',
    version: 'v3.2.0',
    status: 'enabled',
    description: '高精度人体检测算法，支持多种场景下的人员识别。',
    icon: 'UserOutlined',
  },
  {
    id: 'target-face',
    name: '人脸检测算法',
    type: 'target',
    category: 'target',
    version: 'v2.9.1',
    status: 'enabled',
    description: '人脸识别和检测算法，支持口罩检测和人脸属性分析。',
    icon: 'EyeOutlined',
  },
  {
    id: 'smart-counting',
    name: '人数统计算法',
    type: 'smart',
    category: 'smart',
    version: 'v2.3.0',
    status: 'enabled',
    description: '实时统计区域内人数，支持进出人数统计。',
    icon: 'BarChartOutlined',
  },
  {
    id: 'smart-density',
    name: '密度分析算法',
    type: 'smart',
    category: 'smart',
    version: 'v1.7.3',
    status: 'enabled',
    description: '分析人群密度，预警人群聚集风险。',
    icon: 'DashboardOutlined',
  },
];

export const mockAlgorithmConfig = {
  'behavior-intrusion': {
    algorithmId: 'behavior-intrusion',
    algorithmName: '入侵检测算法',
    version: 'v2.1.0',
    status: 'enabled',
    deviceId: 1,
    description: '基于深度学习的人员入侵检测算法，能够准确识别未经授权进入特定区域的人员行为。',
    sensitivity: 75,
    detectionInterval: 1,
    minWidth: 32,
    minHeight: 64,
    confidence: 80,
    trackingMode: 'long',
    outputOptions: ['generateAlert', 'saveSnapshot'],
    dataFormat: 'json',
    outputPath: 'output/intrusion/',
    detectionAreas: [
      { id: 1, name: '主要入口', status: 'enabled', points: [] },
      { id: 2, name: '敏感区域A', status: 'enabled', points: [] },
    ],
  },
  'behavior-loitering': {
    algorithmId: 'behavior-loitering',
    algorithmName: '徘徊检测算法',
    version: 'v1.8.5',
    status: 'enabled',
    deviceId: 2,
    description: '检测人员在特定区域的异常徘徊行为，适用于安全监控场景。',
    sensitivity: 70,
    detectionInterval: 2,
    minWidth: 40,
    minHeight: 80,
    confidence: 75,
    trackingMode: 'long',
    outputOptions: ['generateAlert', 'saveSnapshot'],
    dataFormat: 'json',
    outputPath: 'output/loitering/',
    detectionAreas: [
      { id: 1, name: '停车场区域', status: 'enabled', points: [] },
    ],
  },
  'target-person': {
    algorithmId: 'target-person',
    algorithmName: '人员检测算法',
    version: 'v3.2.0',
    status: 'enabled',
    deviceId: 1,
    description: '高精度人体检测算法，支持多种场景下的人员识别。',
    sensitivity: 85,
    detectionInterval: 0.5,
    minWidth: 24,
    minHeight: 48,
    confidence: 85,
    trackingMode: 'short',
    outputOptions: ['generateAlert', 'saveSnapshot'],
    dataFormat: 'json',
    outputPath: 'output/person/',
    detectionAreas: [],
  },
};

export const mockAlgorithmStatus = {
  running: true,
  startTime: '2024-01-30 14:25:30',
  runningTime: '2小时15分钟',
  processedFrames: 823456,
  performanceMetrics: {
    cpu: 45,
    gpu: 72,
    memory: 56,
    fps: 28.5,
  },
  recentDetections: [
    {
      id: 1,
      level: 'error',
      title: '人员入侵检测',
      location: '主入口',
      time: '2分钟前',
      confidence: 92,
    },
    {
      id: 2,
      level: 'warning',
      title: '异常徘徊检测',
      location: '停车场',
      time: '5分钟前',
      confidence: 87,
    },
    {
      id: 3,
      level: 'info',
      title: '人员计数更新',
      location: '大厅',
      time: '8分钟前',
      confidence: 95,
    },
  ],
  statistics: {
    todayCount: 1234,
    falsePositiveRate: 2.3,
    avgProcessTime: 125,
    accuracy: 97.7,
  },
};

export const mockTestResult = {
  success: true,
  accuracy: 97.5,
  precision: 96.2,
  recall: 98.1,
  fps: 28.5,
  avgProcessTime: 125,
  testDuration: 120,
  testFrames: 3420,
};

// Mock API实现
export default {
  // 获取算法列表
  mockGetAlgorithmList: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockAlgorithmList,
    };
  },

  // 获取算法配置
  mockGetAlgorithmConfig: (algorithmId) => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockAlgorithmConfig[algorithmId] || mockAlgorithmConfig['behavior-intrusion'],
    };
  },

  // 保存算法配置
  mockSaveAlgorithmConfig: (params) => {
    console.log('保存算法配置:', params);
    return {
      code: 1,
      msg: '保存成功',
      data: { id: Date.now() },
    };
  },

  // 测试算法
  mockTestAlgorithm: (params) => {
    console.log('测试算法:', params);
    return {
      code: 1,
      msg: '测试成功',
      data: mockTestResult,
    };
  },

  // 获取算法状态
  mockGetAlgorithmStatus: (algorithmId) => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockAlgorithmStatus,
    };
  },

  // 导出配置
  mockExportConfig: (algorithmId) => {
    return {
      code: 1,
      msg: '导出成功',
      data: mockAlgorithmConfig[algorithmId] || mockAlgorithmConfig['behavior-intrusion'],
    };
  },
};
```

## 路由配置

### ✅ 正确的路由配置
```javascript
// src/router/business/smart-video.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/algorithm-mode',
        name: 'SmartVideoAlgorithmMode',
        component: () => import('/@/views/business/smart-video/algorithm-mode.vue'),
        meta: {
          title: '智能视频 - 算法模式配置',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'ExperimentOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

### ✅ 主路由文件集成
```javascript
// src/router/routers.js
import { smartVideoRouters } from './business/smart-video';

export const routerArray = [
  // ...其他路由
  ...smartVideoRouters,
  // ...更多路由
];
```

## 菜单配置

### ✅ 动态菜单注入
```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  // 智能视频父菜单
  const smartVideoMenu = {
    menuId: maxMenuId + 1000,
    menuName: '智能视频',
    menuTitle: '智能视频',
    menuType: MENU_TYPE_ENUM.CATALOG.value,
    parentId: 0,
    path: '/business/smart-video',
    icon: 'VideoCameraOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: false,
    frameFlag: false,
    frameUrl: '',
    sort: 10,
    updateTime: new Date().toISOString(),
  };

  // 算法模式配置子菜单
  const algorithmModeMenu = {
    menuId: maxMenuId + 1002,
    menuName: '算法模式配置',
    menuTitle: '算法模式配置',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/algorithm-mode',
    component: '/business/smart-video/algorithm-mode.vue',
    icon: 'ExperimentOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 2,
    updateTime: new Date().toISOString(),
  };

  menuList.push(smartVideoMenu, algorithmModeMenu);
  return smartVideoMenu.menuId;
}
```

## Pinia Store状态管理

```javascript
// src/store/modules/business/algorithm.js
import { defineStore } from 'pinia';
import { message } from 'ant-design-vue';
import { algorithmApi } from '/@/api/business/smart-video/algorithm-api';

export const useAlgorithmStore = defineStore('algorithm', {
  state: () => ({
    algorithmList: [],
    currentAlgorithm: null,
    algorithmConfig: {},
    algorithmStatus: {},
    loading: false,
  }),

  getters: {
    enabledAlgorithms(state) {
      return state.algorithmList.filter(algo => algo.status === 'enabled');
    },

    algorithmsByCategory: (state) => (category) => {
      return state.algorithmList.filter(algo => algo.category === category);
    },

    isAlgorithmRunning(state) {
      return state.algorithmStatus.running || false;
    },
  },

  actions: {
    async fetchAlgorithmList(useMock = true) {
      this.loading = true;
      try {
        let response;
        if (useMock) {
          const algorithmMockData = await import('/@/views/business/smart-video/mock/algorithm-mock-data');
          response = algorithmMockData.default.mockGetAlgorithmList();
        } else {
          response = await algorithmApi.queryAlgorithmList();
        }

        if (response.code === 1) {
          this.algorithmList = response.data;
          return response.data;
        } else {
          message.error(response.msg || '获取数据失败');
          return null;
        }
      } catch (error) {
        console.error('获取算法列表失败:', error);
        message.error('获取数据失败');
        return null;
      } finally {
        this.loading = false;
      }
    },

    async fetchAlgorithmConfig(algorithmId, useMock = true) {
      try {
        let response;
        if (useMock) {
          const algorithmMockData = await import('/@/views/business/smart-video/mock/algorithm-mock-data');
          response = algorithmMockData.default.mockGetAlgorithmConfig(algorithmId);
        } else {
          response = await algorithmApi.getAlgorithmConfig(algorithmId);
        }

        if (response.code === 1) {
          this.algorithmConfig = response.data;
          return response.data;
        }
      } catch (error) {
        console.error('获取算法配置失败:', error);
        return null;
      }
    },

    async saveAlgorithmConfig(configData, useMock = true) {
      try {
        let response;
        if (useMock) {
          const algorithmMockData = await import('/@/views/business/smart-video/mock/algorithm-mock-data');
          response = algorithmMockData.default.mockSaveAlgorithmConfig(configData);
        } else {
          response = await algorithmApi.saveAlgorithmConfig(configData);
        }

        if (response.code === 1) {
          message.success('配置保存成功');
          return true;
        } else {
          message.error(response.msg || '保存失败');
          return false;
        }
      } catch (error) {
        console.error('保存配置失败:', error);
        message.error('保存失败');
        return false;
      }
    },

    async testAlgorithm(params, useMock = true) {
      try {
        let response;
        if (useMock) {
          const algorithmMockData = await import('/@/views/business/smart-video/mock/algorithm-mock-data');
          response = algorithmMockData.default.mockTestAlgorithm(params);
        } else {
          response = await algorithmApi.testAlgorithm(params);
        }

        if (response.code === 1) {
          return response.data;
        } else {
          message.error(response.msg || '测试失败');
          return null;
        }
      } catch (error) {
        console.error('测试算法失败:', error);
        message.error('测试失败');
        return null;
      }
    },

    async fetchAlgorithmStatus(algorithmId, useMock = true) {
      try {
        let response;
        if (useMock) {
          const algorithmMockData = await import('/@/views/business/smart-video/mock/algorithm-mock-data');
          response = algorithmMockData.default.mockGetAlgorithmStatus(algorithmId);
        } else {
          response = await algorithmApi.getAlgorithmStatus(algorithmId);
        }

        if (response.code === 1) {
          this.algorithmStatus = response.data;
          return response.data;
        }
      } catch (error) {
        console.error('获取算法状态失败:', error);
        return null;
      }
    },

    setCurrentAlgorithm(algorithm) {
      this.currentAlgorithm = algorithm;
    },
  },
});
```

## 常见错误排查清单

### 1. 控制台报错排查
- [ ] 图标导入错误：检查 `@ant-design/icons-vue` 中是否存在该图标
- [ ] API导入错误：确认导入路径是否为 `/@/lib/axios`
- [ ] v-model错误：检查是否在props上使用了v-model
- [ ] 滑块组件错误：确保使用 `v-model:value` 而不是 `v-model`

### 2. 页面无法访问排查
- [ ] 路由配置：检查路由是否正确添加到 `routerArray`
- [ ] 菜单配置：检查菜单是否正确注入到菜单列表
- [ ] 组件路径：确认组件路径是否正确
- [ ] 文件存在：确认所有引用的组件文件都存在

### 3. 功能异常排查
- [ ] Store状态：检查Pinia store是否正确定义和使用
- [ ] API调用：确认API接口路径和参数是否正确
- [ ] 数据格式：检查mock数据格式是否符合预期
- [ ] 事件绑定：确认事件监听器是否正确绑定
- [ ] 表单验证：确保表单规则配置正确

### 4. 算法配置相关排查
- [ ] 参数范围：确保所有参数值在合理范围内
- [ ] 检测区域：检查区域坐标是否有效
- [ ] 设备绑定：确认设备是否在线且可用
- [ ] 输出路径：验证输出路径是否存在且有写入权限

## 最佳实践总结

### ✅ 推荐的开发流程
1. **先创建基础组件** - 确保每个组件可以独立运行
2. **逐步集成功能** - 从简单到复杂，逐步添加功能
3. **Mock数据优先** - 先用mock数据开发，后期对接真实API
4. **及时测试验证** - 每添加一个功能就进行测试
5. **遵循项目规范** - 使用项目既定的命名和结构规范

### ✅ 代码质量保证
1. **使用TypeScript类型检查**（如果项目支持）
2. **遵循ESLint和Prettier规范**
3. **编写单元测试**（重要功能）
4. **添加适当的注释**，特别是复杂逻辑
5. **保持组件单一职责**，避免过度复杂

### ✅ 性能优化建议
1. **使用懒加载**：路由和组件按需加载
2. **合理使用computed和watch**
3. **避免不必要的重新渲染**
4. **使用防抖和节流**优化用户交互（如滑块调整）
5. **定时器管理**：组件卸载时清除定时器

### ✅ 安全性建议
1. **参数验证**：对所有用户输入进行验证
2. **敏感信息保护**：算法参数不暴露在日志中
3. **权限控制**：确保只有授权用户可以修改配置
4. **配置备份**：保存配置前先备份
5. **测试隔离**：测试模式不影响生产环境

## 特殊功能实现说明

### 1. 算法测试功能
```javascript
const testAlgorithm = async () => {
  try {
    testing.value = true;
    message.loading('正在测试算法性能...', 0);

    const testParams = {
      algorithmId: selectedAlgorithm.value,
      testDuration: 120, // 测试时长（秒）
      testVideoUrl: 'test-video.mp4',
      config: algorithmConfig.value,
    };

    const result = await algorithmApi.testAlgorithm(testParams);

    message.destroy();

    if (result.code === 1) {
      const data = result.data;
      message.success(
        `算法测试完成！准确率: ${data.accuracy}%, FPS: ${data.fps}`
      );

      // 显示详细测试结果
      showTestResultModal(data);
    } else {
      message.error(result.msg || '测试失败');
    }
  } catch (error) {
    console.error('测试失败:', error);
    message.destroy();
    message.error('测试失败');
  } finally {
    testing.value = false;
  }
};
```

### 2. 配置模板保存和应用
```javascript
// 保存为模板
const saveAsTemplate = async () => {
  const templateName = await showTemplateNameInput();
  if (!templateName) return;

  try {
    const response = await algorithmApi.saveTemplate({
      name: templateName,
      algorithmId: selectedAlgorithm.value,
      config: algorithmConfig.value,
    });

    if (response.code === 1) {
      message.success('模板保存成功');
    }
  } catch (error) {
    console.error('保存模板失败:', error);
    message.error('保存模板失败');
  }
};

// 应用模板
const applyTemplate = async (templateId) => {
  try {
    const response = await algorithmApi.applyTemplate({
      templateId,
      algorithmId: selectedAlgorithm.value,
    });

    if (response.code === 1) {
      Object.assign(algorithmConfig.value, response.data);
      message.success('模板应用成功');
    }
  } catch (error) {
    console.error('应用模板失败:', error);
    message.error('应用模板失败');
  }
};
```

### 3. 批量配置功能
```javascript
const batchConfigAlgorithms = async (algorithmIds, configData) => {
  try {
    const response = await algorithmApi.batchSaveConfig({
      algorithmIds,
      config: configData,
    });

    if (response.code === 1) {
      message.success(`成功配置 ${algorithmIds.length} 个算法`);
      return true;
    } else {
      message.error(response.msg || '批量配置失败');
      return false;
    }
  } catch (error) {
    console.error('批量配置失败:', error);
    message.error('批量配置失败');
    return false;
  }
};
```

### 4. 实时性能监控
```javascript
// 使用WebSocket或轮询方式实时更新性能指标
let performanceTimer = null;

onMounted(() => {
  startPerformanceMonitor();
});

onUnmounted(() => {
  stopPerformanceMonitor();
});

const startPerformanceMonitor = () => {
  performanceTimer = setInterval(async () => {
    try {
      const response = await algorithmApi.getPerformanceMetrics(
        selectedAlgorithm.value
      );

      if (response.code === 1) {
        performanceMetrics.value = response.data;
      }
    } catch (error) {
      console.error('获取性能指标失败:', error);
    }
  }, 5000); // 每5秒更新一次
};

const stopPerformanceMonitor = () => {
  if (performanceTimer) {
    clearInterval(performanceTimer);
    performanceTimer = null;
  }
};
```

### 5. 检测区域可视化编辑
```vue
<template>
  <div class="area-editor">
    <canvas
      ref="canvasRef"
      :width="canvasWidth"
      :height="canvasHeight"
      @mousedown="handleMouseDown"
      @mousemove="handleMouseMove"
      @mouseup="handleMouseUp"
    ></canvas>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';

const canvasRef = ref();
const canvasWidth = 640;
const canvasHeight = 480;
const points = ref([]);
const isDrawing = ref(false);

onMounted(() => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');

  // 绘制背景图片（视频帧）
  const img = new Image();
  img.src = 'preview-frame.jpg';
  img.onload = () => {
    ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
  };
});

const handleMouseDown = (e) => {
  isDrawing.value = true;
  const rect = canvasRef.value.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  points.value.push({ x, y });
  drawPoints();
};

const handleMouseMove = (e) => {
  if (!isDrawing.value) return;
  // 绘制临时线条
};

const handleMouseUp = () => {
  isDrawing.value = false;
};

const drawPoints = () => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');

  ctx.strokeStyle = '#1890ff';
  ctx.lineWidth = 2;
  ctx.beginPath();

  points.value.forEach((point, index) => {
    if (index === 0) {
      ctx.moveTo(point.x, point.y);
    } else {
      ctx.lineTo(point.x, point.y);
    }
  });

  ctx.stroke();
};
</script>
```

## 总结

通过遵循本文档的技术规范和注意事项，可以有效避免开发过程中的常见错误，确保算法模式配置页面能够顺利开发和部署。

关键要点：
- ✅ **避免在props上使用v-model**，改用属性绑定和事件监听
- ✅ **验证图标存在性**，使用实际存在于`@ant-design/icons-vue`中的图标
- ✅ **使用正确的API导入路径**：`/@/lib/axios`
- ✅ **标准化算法类型和状态**，使用枚举常量定义
- ✅ **完善的参数验证**，确保算法配置合理有效
- ✅ **实现测试功能**，确保算法配置正确后再应用
- ✅ **支持模板管理**，提高配置效率
- ✅ **可视化区域编辑**，提供直观的配置体验
- ✅ **实时性能监控**，及时发现算法运行问题
- ✅ **批量配置功能**，提高管理效率

通过这些规范和最佳实践，可以确保开发过程顺利进行，减少调试时间，提高开发效率。
