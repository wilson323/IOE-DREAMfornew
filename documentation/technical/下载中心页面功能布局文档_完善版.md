# 下载中心页面功能与布局文档

## 页面概述
下载中心页面是智能视频监控系统中的文件管理核心界面，用于管理系统中所有下载任务，包括录像文件、报表文件、日志文件、备份文件、导出数据等多种文件类型的下载管理。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供完整的下载任务管理、进度跟踪、断点续传、批量操作等功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **图表库**: ECharts 5.4.3 (用于下载统计图表)
- **文件下载**: FileSaver.js 2.0.5

### 项目文件组织结构
```
src/views/business/smart-video/
├── download-center.vue              # 下载中心主页面
├── components/
│   ├── DownloadFilter.vue           # 下载任务筛选组件
│   ├── DownloadTaskItem.vue         # 单个下载任务项组件
│   ├── DownloadProgressBar.vue      # 下载进度条组件
│   ├── DownloadDetailModal.vue      # 下载详情弹窗组件
│   ├── DownloadSettingsModal.vue    # 下载设置弹窗组件
│   └── DownloadStatisticsCard.vue   # 下载统计卡片组件
├── mock/
│   └── download-mock-data.js        # 模拟数据
└── api/
    └── download-api.js              # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/download-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const downloadApi = {
  // 查询下载任务列表
  queryDownloadList: (params) => postRequest('/download/query', params),

  // 获取下载任务详情
  getDownloadDetail: (taskId) => getRequest(`/download/detail/${taskId}`),

  // 创建下载任务
  createDownloadTask: (params) => postRequest('/download/create', params),

  // 暂停下载任务
  pauseDownload: (taskId) => postRequest(`/download/pause/${taskId}`),

  // 恢复下载任务
  resumeDownload: (taskId) => postRequest(`/download/resume/${taskId}`),

  // 取消下载任务
  cancelDownload: (taskId) => postRequest(`/download/cancel/${taskId}`),

  // 删除下载任务
  deleteDownload: (taskId) => postRequest(`/download/delete/${taskId}`),

  // 批量暂停下载任务
  batchPauseDownload: (taskIds) => postRequest('/download/batch/pause', { taskIds }),

  // 批量取消下载任务
  batchCancelDownload: (taskIds) => postRequest('/download/batch/cancel', { taskIds }),

  // 批量删除下载任务
  batchDeleteDownload: (taskIds) => postRequest('/download/batch/delete', { taskIds }),

  // 暂停所有下载任务
  pauseAllDownloads: () => postRequest('/download/pause-all'),

  // 清理已完成的下载任务
  clearCompletedDownloads: () => postRequest('/download/clear-completed'),

  // 重试失败的下载任务
  retryDownload: (taskId) => postRequest(`/download/retry/${taskId}`),

  // 打开文件所在目录
  openFileLocation: (taskId) => postRequest(`/download/open-location/${taskId}`),

  // 获取下载统计数据
  getDownloadStatistics: () => getRequest('/download/statistics'),

  // 获取下载文件
  downloadFile: (taskId) => getRequest(`/download/file/${taskId}`, { responseType: 'blob' }),

  // 获取下载进度（WebSocket或轮询）
  getDownloadProgress: (taskId) => getRequest(`/download/progress/${taskId}`),

  // 更新下载设置
  updateDownloadSettings: (params) => postRequest('/download/settings/update', params),

  // 获取下载设置
  getDownloadSettings: () => getRequest('/download/settings'),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="下载详情">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="下载详情"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { DownloadCenterOutlined } from '@ant-design/icons-vue';  // ❌ 不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  DownloadOutlined,         // ✅ 下载
  SearchOutlined,           // ✅ 搜索
  ReloadOutlined,           // ✅ 重置/刷新
  SyncOutlined,             // ✅ 刷新
  FilterOutlined,           // ✅ 筛选
  DeleteOutlined,           // ✅ 删除
  PauseCircleOutlined,      // ✅ 暂停
  PlayCircleOutlined,       // ✅ 播放/恢复
  StopOutlined,             // ✅ 停止
  RedoOutlined,             // ✅ 重试
  CheckCircleOutlined,      // ✅ 完成
  CloseCircleOutlined,      // ✅ 取消/失败
  ClockCircleOutlined,      // ✅ 等待/时间
  LoadingOutlined,          // ✅ 加载中
  FolderOpenOutlined,       // ✅ 打开文件夹
  FileOutlined,             // ✅ 文件
  FileTextOutlined,         // ✅ 文本文件
  FileExcelOutlined,        // ✅ Excel文件
  FilePdfOutlined,          // ✅ PDF文件
  FileZipOutlined,          // ✅ 压缩文件
  VideoCameraOutlined,      // ✅ 视频文件
  PictureOutlined,          // ✅ 图片文件
  DatabaseOutlined,         // ✅ 数据库文件
  HddOutlined,              // ✅ 硬盘/存储
  CloudDownloadOutlined,    // ✅ 云下载
  ExportOutlined,           // ✅ 导出
  SettingOutlined,          // ✅ 设置
  ClearOutlined,            // ✅ 清理
} from '@ant-design/icons-vue';
</script>
```

### 3. 下载状态和类型枚举定义

#### ✅ 标准下载枚举常量
```javascript
// src/constants/business/download-const.js

// 下载状态枚举
export const DOWNLOAD_STATUS_ENUM = {
  PENDING: {
    value: 'pending',
    label: '等待中',
    color: 'default',
    bgColor: '#f3f4f6',
    textColor: '#6b7280',
    icon: 'ClockCircleOutlined',
  },
  DOWNLOADING: {
    value: 'downloading',
    label: '下载中',
    color: 'processing',
    bgColor: '#dbeafe',
    textColor: '#1e40af',
    icon: 'LoadingOutlined',
  },
  PAUSED: {
    value: 'paused',
    label: '已暂停',
    color: 'warning',
    bgColor: '#fef3c7',
    textColor: '#92400e',
    icon: 'PauseCircleOutlined',
  },
  COMPLETED: {
    value: 'completed',
    label: '已完成',
    color: 'success',
    bgColor: '#dcfce7',
    textColor: '#166534',
    icon: 'CheckCircleOutlined',
  },
  FAILED: {
    value: 'failed',
    label: '失败',
    color: 'error',
    bgColor: '#fee2e2',
    textColor: '#991b1b',
    icon: 'CloseCircleOutlined',
  },
  CANCELLED: {
    value: 'cancelled',
    label: '已取消',
    color: 'default',
    bgColor: '#f3f4f6',
    textColor: '#6b7280',
    icon: 'StopOutlined',
  },
};

// 文件类型枚举
export const FILE_TYPE_ENUM = {
  VIDEO: {
    value: 'video',
    label: '录像文件',
    color: 'blue',
    bgColor: '#dbeafe',
    textColor: '#1e40af',
    icon: 'VideoCameraOutlined',
    extensions: ['.mp4', '.avi', '.mov', '.mkv', '.flv'],
  },
  REPORT: {
    value: 'report',
    label: '报表文件',
    color: 'green',
    bgColor: '#dcfce7',
    textColor: '#166534',
    icon: 'FileExcelOutlined',
    extensions: ['.xlsx', '.xls', '.csv'],
  },
  LOG: {
    value: 'log',
    label: '日志文件',
    color: 'purple',
    bgColor: '#f3e8ff',
    textColor: '#6b21a8',
    icon: 'FileTextOutlined',
    extensions: ['.log', '.txt'],
  },
  BACKUP: {
    value: 'backup',
    label: '备份文件',
    color: 'orange',
    bgColor: '#ffedd5',
    textColor: '#9a3412',
    icon: 'DatabaseOutlined',
    extensions: ['.sql', '.bak', '.backup'],
  },
  EXPORT: {
    value: 'export',
    label: '导出数据',
    color: 'cyan',
    bgColor: '#cffafe',
    textColor: '#155e75',
    icon: 'ExportOutlined',
    extensions: ['.zip', '.rar', '.tar', '.gz'],
  },
  ARCHIVE: {
    value: 'archive',
    label: '压缩文件',
    color: 'purple',
    bgColor: '#f3e8ff',
    textColor: '#6b21a8',
    icon: 'FileZipOutlined',
    extensions: ['.zip', '.rar', '.7z', '.tar'],
  },
  DOCUMENT: {
    value: 'document',
    label: '文档文件',
    color: 'blue',
    bgColor: '#dbeafe',
    textColor: '#1e40af',
    icon: 'FileTextOutlined',
    extensions: ['.pdf', '.doc', '.docx'],
  },
  IMAGE: {
    value: 'image',
    label: '图片文件',
    color: 'pink',
    bgColor: '#fce7f3',
    textColor: '#9f1239',
    icon: 'PictureOutlined',
    extensions: ['.jpg', '.jpeg', '.png', '.gif', '.bmp'],
  },
};

// 下载速度单位转换
export const formatDownloadSpeed = (bytesPerSecond) => {
  if (!bytesPerSecond || bytesPerSecond === 0) return '0 B/s';

  const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
  let size = bytesPerSecond;
  let unitIndex = 0;

  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024;
    unitIndex++;
  }

  return `${size.toFixed(2)} ${units[unitIndex]}`;
};

// 文件大小格式化
export const formatFileSize = (bytes) => {
  if (!bytes || bytes === 0) return '0 B';

  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  let size = bytes;
  let unitIndex = 0;

  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024;
    unitIndex++;
  }

  return `${size.toFixed(2)} ${units[unitIndex]}`;
};

// 剩余时间格式化
export const formatRemainingTime = (seconds) => {
  if (!seconds || seconds === 0) return '计算中...';
  if (seconds < 0) return '未知';

  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);

  if (hours > 0) {
    return `${hours}小时${minutes}分${secs}秒`;
  } else if (minutes > 0) {
    return `${minutes}分${secs}秒`;
  } else {
    return `${secs}秒`;
  }
};
```

### 4. API导入路径注意事项

#### ✅ 正确：使用项目标准导入路径
```javascript
// 正确：使用项目中实际的axios文件
import { postRequest, getRequest } from '/@/lib/axios';
```

### 5. 大文件下载注意事项

#### ❌ 错误：直接使用Axios下载大文件
```javascript
// 错误：会占用大量内存
const response = await axios.get('/api/download', { responseType: 'blob' });
```

#### ✅ 正确：使用流式下载和分片下载
```javascript
// 正确：使用分片下载
const downloadLargeFile = async (url, fileName, onProgress) => {
  const chunkSize = 1024 * 1024 * 10; // 10MB per chunk
  let start = 0;
  let end = chunkSize - 1;

  const response = await axios.head(url);
  const fileSize = parseInt(response.headers['content-length']);

  const chunks = [];

  while (start < fileSize) {
    const chunk = await axios.get(url, {
      headers: {
        Range: `bytes=${start}-${end}`
      },
      responseType: 'blob'
    });

    chunks.push(chunk.data);
    start = end + 1;
    end = Math.min(start + chunkSize - 1, fileSize - 1);

    if (onProgress) {
      onProgress(Math.round((start / fileSize) * 100));
    }
  }

  const blob = new Blob(chunks);
  saveAs(blob, fileName);
};
```

### 6. 实时进度更新注意事项

#### ✅ 正确：使用WebSocket或定时轮询
```javascript
// 方式1：WebSocket实时推送（推荐）
import { io } from 'socket.io-client';

const socket = io('ws://your-server.com');

socket.on('download-progress', (data) => {
  updateDownloadProgress(data.taskId, data.progress);
});

// 方式2：定时轮询
const pollDownloadProgress = (taskId) => {
  const timer = setInterval(async () => {
    try {
      const progress = await downloadApi.getDownloadProgress(taskId);
      updateDownloadProgress(taskId, progress);

      if (progress.status === 'completed' || progress.status === 'failed') {
        clearInterval(timer);
      }
    } catch (error) {
      console.error('获取进度失败:', error);
      clearInterval(timer);
    }
  }, 1000); // 每秒更新一次

  return timer;
};
```

## 核心功能模块

### 1. 顶部工具栏与筛选功能
**位置**: 页面顶部

**功能说明**:
- **类型筛选**: 全部类型、录像文件、报表文件、日志文件、备份文件、导出数据
- **状态筛选**: 全部状态、下载中、已完成、失败、等待中、已暂停
- **时间筛选**: 开始时间、结束时间（日期选择器）
- **搜索功能**: 按文件名搜索
- **批量操作**: 全部暂停、清理完成、刷新列表

**技术实现**:
```vue
<template>
  <div class="download-center-toolbar">
    <!-- 筛选区域 -->
    <a-card :bordered="false" class="filter-card">
      <div class="filter-row">
        <!-- 类型筛选 -->
        <div class="filter-item">
          <span class="filter-label">类型:</span>
          <a-select
            v-model:value="filterForm.fileType"
            placeholder="全部类型"
            style="width: 160px"
            allowClear
            @change="handleFilterChange"
          >
            <a-select-option value="">全部类型</a-select-option>
            <a-select-option value="video">录像文件</a-select-option>
            <a-select-option value="report">报表文件</a-select-option>
            <a-select-option value="log">日志文件</a-select-option>
            <a-select-option value="backup">备份文件</a-select-option>
            <a-select-option value="export">导出数据</a-select-option>
          </a-select>
        </div>

        <!-- 状态筛选 -->
        <div class="filter-item">
          <span class="filter-label">状态:</span>
          <a-select
            v-model:value="filterForm.status"
            placeholder="全部状态"
            style="width: 140px"
            allowClear
            @change="handleFilterChange"
          >
            <a-select-option value="">全部状态</a-select-option>
            <a-select-option value="downloading">下载中</a-select-option>
            <a-select-option value="completed">已完成</a-select-option>
            <a-select-option value="failed">失败</a-select-option>
            <a-select-option value="pending">等待中</a-select-option>
            <a-select-option value="paused">已暂停</a-select-option>
          </a-select>
        </div>

        <!-- 时间筛选 -->
        <div class="filter-item">
          <span class="filter-label">时间:</span>
          <a-date-picker
            v-model:value="filterForm.startDate"
            placeholder="开始时间"
            style="width: 140px"
            @change="handleFilterChange"
          />
          <span class="filter-separator">至</span>
          <a-date-picker
            v-model:value="filterForm.endDate"
            placeholder="结束时间"
            style="width: 140px"
            @change="handleFilterChange"
          />
        </div>

        <!-- 操作按钮组 -->
        <div class="filter-actions">
          <!-- 搜索框 -->
          <a-input
            v-model:value="filterForm.searchKeyword"
            placeholder="搜索下载任务..."
            style="width: 250px"
            allowClear
            @pressEnter="handleSearch"
          >
            <template #prefix>
              <SearchOutlined />
            </template>
          </a-input>

          <!-- 操作按钮 -->
          <a-button
            type="default"
            @click="handlePauseAll"
          >
            <template #icon><PauseCircleOutlined /></template>
            全部暂停
          </a-button>

          <a-button
            type="default"
            @click="handleClearCompleted"
          >
            <template #icon><ClearOutlined /></template>
            清理完成
          </a-button>

          <a-button
            type="primary"
            @click="handleRefresh"
          >
            <template #icon><SyncOutlined /></template>
            刷新
          </a-button>
        </div>
      </div>
    </a-card>
  </div>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { message } from 'ant-design-vue';
import {
  SearchOutlined,
  PauseCircleOutlined,
  ClearOutlined,
  SyncOutlined,
} from '@ant-design/icons-vue';
import { downloadApi } from '/@/api/business/smart-video/download-api';

const filterForm = reactive({
  fileType: '',
  status: '',
  startDate: null,
  endDate: null,
  searchKeyword: '',
});

const emit = defineEmits(['filter-change', 'refresh']);

// 筛选条件变化
const handleFilterChange = () => {
  emit('filter-change', filterForm);
};

// 搜索
const handleSearch = () => {
  emit('filter-change', filterForm);
};

// 全部暂停
const handlePauseAll = async () => {
  try {
    await downloadApi.pauseAllDownloads();
    message.success('所有下载任务已暂停');
    emit('refresh');
  } catch (error) {
    message.error('暂停失败: ' + error.message);
  }
};

// 清理已完成
const handleClearCompleted = async () => {
  try {
    await downloadApi.clearCompletedDownloads();
    message.success('已清理完成的下载记录');
    emit('refresh');
  } catch (error) {
    message.error('清理失败: ' + error.message);
  }
};

// 刷新
const handleRefresh = () => {
  emit('refresh');
  message.success('下载列表已刷新');
};
</script>

<style scoped lang="less">
.download-center-toolbar {
  margin-bottom: 16px;

  .filter-card {
    .filter-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;

      .filter-item {
        display: flex;
        align-items: center;
        gap: 8px;

        .filter-label {
          font-size: 14px;
          color: #6b7280;
          white-space: nowrap;
        }

        .filter-separator {
          margin: 0 4px;
          color: #9ca3af;
        }
      }

      .filter-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        justify-content: flex-end;
      }
    }
  }
}
</style>
```

### 2. 统计信息卡片
**位置**: 工具栏下方

**功能说明**:
- **下载中**: 显示正在下载的任务数量
- **已完成**: 显示已完成的任务数量
- **失败**: 显示失败的任务数量
- **总大小**: 显示所有文件的总大小

**技术实现**:
```vue
<template>
  <div class="download-statistics">
    <a-row :gutter="16">
      <!-- 下载中统计 -->
      <a-col :xs="24" :sm="12" :md="6">
        <a-card :bordered="false" class="stat-card downloading">
          <div class="stat-content">
            <div class="stat-info">
              <div class="stat-label">下载中</div>
              <div class="stat-value">{{ statistics.downloading }}</div>
            </div>
            <div class="stat-icon">
              <LoadingOutlined :spin="true" />
            </div>
          </div>
        </a-card>
      </a-col>

      <!-- 已完成统计 -->
      <a-col :xs="24" :sm="12" :md="6">
        <a-card :bordered="false" class="stat-card completed">
          <div class="stat-content">
            <div class="stat-info">
              <div class="stat-label">已完成</div>
              <div class="stat-value">{{ statistics.completed }}</div>
            </div>
            <div class="stat-icon">
              <CheckCircleOutlined />
            </div>
          </div>
        </a-card>
      </a-col>

      <!-- 失败统计 -->
      <a-col :xs="24" :sm="12" :md="6">
        <a-card :bordered="false" class="stat-card failed">
          <div class="stat-content">
            <div class="stat-info">
              <div class="stat-label">失败</div>
              <div class="stat-value">{{ statistics.failed }}</div>
            </div>
            <div class="stat-icon">
              <CloseCircleOutlined />
            </div>
          </div>
        </a-card>
      </a-col>

      <!-- 总大小统计 -->
      <a-col :xs="24" :sm="12" :md="6">
        <a-card :bordered="false" class="stat-card total-size">
          <div class="stat-content">
            <div class="stat-info">
              <div class="stat-label">总大小</div>
              <div class="stat-value">{{ statistics.totalSize }}</div>
            </div>
            <div class="stat-icon">
              <HddOutlined />
            </div>
          </div>
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import {
  LoadingOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  HddOutlined,
} from '@ant-design/icons-vue';
import { downloadApi } from '/@/api/business/smart-video/download-api';
import { formatFileSize } from '/@/constants/business/download-const';

const statistics = ref({
  downloading: 0,
  completed: 0,
  failed: 0,
  totalSize: '0 GB',
});

const loadStatistics = async () => {
  try {
    const data = await downloadApi.getDownloadStatistics();
    statistics.value = {
      ...data,
      totalSize: formatFileSize(data.totalBytes),
    };
  } catch (error) {
    console.error('加载统计数据失败:', error);
  }
};

onMounted(() => {
  loadStatistics();
});

defineExpose({
  refresh: loadStatistics,
});
</script>

<style scoped lang="less">
.download-statistics {
  margin-bottom: 16px;

  .stat-card {
    .stat-content {
      display: flex;
      align-items: center;
      justify-content: space-between;

      .stat-info {
        .stat-label {
          font-size: 14px;
          color: #6b7280;
          margin-bottom: 8px;
        }

        .stat-value {
          font-size: 28px;
          font-weight: 600;
        }
      }

      .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
    }

    &.downloading {
      .stat-value {
        color: #3b82f6;
      }
      .stat-icon {
        background-color: #dbeafe;
        color: #3b82f6;
      }
    }

    &.completed {
      .stat-value {
        color: #10b981;
      }
      .stat-icon {
        background-color: #dcfce7;
        color: #10b981;
      }
    }

    &.failed {
      .stat-value {
        color: #ef4444;
      }
      .stat-icon {
        background-color: #fee2e2;
        color: #ef4444;
      }
    }

    &.total-size {
      .stat-value {
        color: #8b5cf6;
      }
      .stat-icon {
        background-color: #f3e8ff;
        color: #8b5cf6;
      }
    }
  }
}
</style>
```

### 3. 下载任务列表
**位置**: 统计卡片下方

**功能说明**:
- **表格列**: 复选框、文件名、类型、大小、进度、速度、剩余时间、状态、开始时间、操作
- **实时进度**: 进度条实时更新，显示下载百分比
- **状态展示**: 不同状态用不同颜色和图标标识
- **操作按钮**: 暂停/恢复、取消、重试、打开文件夹、删除

**技术实现**:
```vue
<template>
  <div class="download-task-list">
    <a-card :bordered="false" :bodyStyle="{ padding: 0 }">
      <!-- 列表头部 -->
      <div class="list-header">
        <div class="header-left">
          <h3 class="list-title">下载任务列表</h3>
          <span class="list-count">共 {{ pagination.total }} 个任务</span>
        </div>
        <div class="header-right">
          <a-space>
            <a-button
              v-if="selectedRowKeys.length > 0"
              type="default"
              danger
              @click="handleBatchDelete"
            >
              <template #icon><DeleteOutlined /></template>
              批量删除 ({{ selectedRowKeys.length }})
            </a-button>
          </a-space>
        </div>
      </div>

      <!-- 任务表格 -->
      <a-table
        :columns="columns"
        :data-source="taskList"
        :loading="loading"
        :pagination="pagination"
        :row-selection="{
          selectedRowKeys: selectedRowKeys,
          onChange: onSelectChange,
        }"
        :scroll="{ x: 1400 }"
        @change="handleTableChange"
      >
        <!-- 文件名列 -->
        <template #fileName="{ record }">
          <div class="file-info">
            <component
              :is="getFileIcon(record.fileType)"
              :style="{ color: getFileTypeColor(record.fileType), fontSize: '20px' }"
            />
            <div class="file-details">
              <div class="file-name" :title="record.fileName">{{ record.fileName }}</div>
              <div class="file-description">{{ record.description }}</div>
            </div>
          </div>
        </template>

        <!-- 类型列 -->
        <template #fileType="{ record }">
          <a-tag :color="getFileTypeColor(record.fileType)">
            {{ getFileTypeLabel(record.fileType) }}
          </a-tag>
        </template>

        <!-- 大小列 -->
        <template #fileSize="{ record }">
          <span>{{ formatFileSize(record.fileSize) }}</span>
        </template>

        <!-- 进度列 -->
        <template #progress="{ record }">
          <div class="progress-wrapper">
            <a-progress
              :percent="record.progress"
              :status="getProgressStatus(record.status)"
              :stroke-color="getProgressColor(record.status)"
              size="small"
              style="width: 200px"
            />
            <span class="progress-text">{{ record.progress }}%</span>
          </div>
        </template>

        <!-- 速度列 -->
        <template #speed="{ record }">
          <span>{{ record.status === 'downloading' ? formatDownloadSpeed(record.speed) : '-' }}</span>
        </template>

        <!-- 剩余时间列 -->
        <template #remainingTime="{ record }">
          <span>{{ record.status === 'downloading' ? formatRemainingTime(record.remainingTime) : '-' }}</span>
        </template>

        <!-- 状态列 -->
        <template #status="{ record }">
          <a-tag
            :color="getStatusColor(record.status)"
            :style="{
              backgroundColor: getStatusBgColor(record.status),
              color: getStatusTextColor(record.status),
              border: 'none',
            }"
          >
            <component
              :is="getStatusIcon(record.status)"
              :spin="record.status === 'downloading'"
            />
            {{ getStatusLabel(record.status) }}
          </a-tag>
        </template>

        <!-- 开始时间列 -->
        <template #startTime="{ record }">
          <span>{{ record.startTime }}</span>
        </template>

        <!-- 操作列 -->
        <template #action="{ record }">
          <a-space>
            <!-- 下载中：暂停、取消 -->
            <template v-if="record.status === 'downloading'">
              <a-tooltip title="暂停">
                <a-button
                  type="link"
                  size="small"
                  @click="handlePause(record)"
                >
                  <template #icon><PauseCircleOutlined /></template>
                </a-button>
              </a-tooltip>
              <a-tooltip title="取消">
                <a-button
                  type="link"
                  size="small"
                  danger
                  @click="handleCancel(record)"
                >
                  <template #icon><StopOutlined /></template>
                </a-button>
              </a-tooltip>
            </template>

            <!-- 已暂停：恢复、取消 -->
            <template v-else-if="record.status === 'paused'">
              <a-tooltip title="恢复">
                <a-button
                  type="link"
                  size="small"
                  @click="handleResume(record)"
                >
                  <template #icon><PlayCircleOutlined /></template>
                </a-button>
              </a-tooltip>
              <a-tooltip title="取消">
                <a-button
                  type="link"
                  size="small"
                  danger
                  @click="handleCancel(record)"
                >
                  <template #icon><StopOutlined /></template>
                </a-button>
              </a-tooltip>
            </template>

            <!-- 已完成：打开文件夹、删除 -->
            <template v-else-if="record.status === 'completed'">
              <a-tooltip title="打开文件夹">
                <a-button
                  type="link"
                  size="small"
                  @click="handleOpenFolder(record)"
                >
                  <template #icon><FolderOpenOutlined /></template>
                </a-button>
              </a-tooltip>
              <a-tooltip title="删除">
                <a-button
                  type="link"
                  size="small"
                  danger
                  @click="handleDelete(record)"
                >
                  <template #icon><DeleteOutlined /></template>
                </a-button>
              </a-tooltip>
            </template>

            <!-- 失败：重试、删除 -->
            <template v-else-if="record.status === 'failed'">
              <a-tooltip title="重试">
                <a-button
                  type="link"
                  size="small"
                  @click="handleRetry(record)"
                >
                  <template #icon><RedoOutlined /></template>
                </a-button>
              </a-tooltip>
              <a-tooltip title="删除">
                <a-button
                  type="link"
                  size="small"
                  danger
                  @click="handleDelete(record)"
                >
                  <template #icon><DeleteOutlined /></template>
                </a-button>
              </a-tooltip>
            </template>

            <!-- 等待中/已取消：删除 -->
            <template v-else>
              <a-tooltip title="删除">
                <a-button
                  type="link"
                  size="small"
                  danger
                  @click="handleDelete(record)"
                >
                  <template #icon><DeleteOutlined /></template>
                </a-button>
              </a-tooltip>
            </template>
          </a-space>
        </template>
      </a-table>
    </a-card>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted } from 'vue';
import { message, Modal } from 'ant-design-vue';
import {
  DeleteOutlined,
  PauseCircleOutlined,
  PlayCircleOutlined,
  StopOutlined,
  RedoOutlined,
  FolderOpenOutlined,
  LoadingOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ClockCircleOutlined,
  VideoCameraOutlined,
  FileExcelOutlined,
  FileTextOutlined,
  DatabaseOutlined,
  ExportOutlined,
  FileZipOutlined,
} from '@ant-design/icons-vue';
import { downloadApi } from '/@/api/business/smart-video/download-api';
import {
  DOWNLOAD_STATUS_ENUM,
  FILE_TYPE_ENUM,
  formatFileSize,
  formatDownloadSpeed,
  formatRemainingTime,
} from '/@/constants/business/download-const';

// 表格列定义
const columns = [
  {
    title: '文件名',
    dataIndex: 'fileName',
    key: 'fileName',
    width: 300,
    ellipsis: true,
    slots: { customRender: 'fileName' },
  },
  {
    title: '类型',
    dataIndex: 'fileType',
    key: 'fileType',
    width: 120,
    slots: { customRender: 'fileType' },
  },
  {
    title: '大小',
    dataIndex: 'fileSize',
    key: 'fileSize',
    width: 100,
    slots: { customRender: 'fileSize' },
  },
  {
    title: '进度',
    dataIndex: 'progress',
    key: 'progress',
    width: 250,
    slots: { customRender: 'progress' },
  },
  {
    title: '速度',
    dataIndex: 'speed',
    key: 'speed',
    width: 100,
    slots: { customRender: 'speed' },
  },
  {
    title: '剩余时间',
    dataIndex: 'remainingTime',
    key: 'remainingTime',
    width: 120,
    slots: { customRender: 'remainingTime' },
  },
  {
    title: '状态',
    dataIndex: 'status',
    key: 'status',
    width: 120,
    slots: { customRender: 'status' },
  },
  {
    title: '开始时间',
    dataIndex: 'startTime',
    key: 'startTime',
    width: 160,
    slots: { customRender: 'startTime' },
  },
  {
    title: '操作',
    key: 'action',
    width: 120,
    fixed: 'right',
    slots: { customRender: 'action' },
  },
];

const loading = ref(false);
const taskList = ref([]);
const selectedRowKeys = ref([]);
const pagination = reactive({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  showTotal: (total) => `共 ${total} 条记录`,
});

let progressTimer = null;

// 加载任务列表
const loadTaskList = async () => {
  loading.value = true;
  try {
    const params = {
      pageNum: pagination.current,
      pageSize: pagination.pageSize,
    };
    const result = await downloadApi.queryDownloadList(params);
    taskList.value = result.rows || [];
    pagination.total = result.total || 0;
  } catch (error) {
    message.error('加载失败: ' + error.message);
  } finally {
    loading.value = false;
  }
};

// 表格变化处理
const handleTableChange = (pag) => {
  pagination.current = pag.current;
  pagination.pageSize = pag.pageSize;
  loadTaskList();
};

// 选择变化
const onSelectChange = (keys) => {
  selectedRowKeys.value = keys;
};

// 获取文件图标
const getFileIcon = (fileType) => {
  const iconMap = {
    video: VideoCameraOutlined,
    report: FileExcelOutlined,
    log: FileTextOutlined,
    backup: DatabaseOutlined,
    export: ExportOutlined,
    archive: FileZipOutlined,
  };
  return iconMap[fileType] || FileTextOutlined;
};

// 获取文件类型颜色
const getFileTypeColor = (fileType) => {
  return FILE_TYPE_ENUM[fileType.toUpperCase()]?.color || 'default';
};

// 获取文件类型标签
const getFileTypeLabel = (fileType) => {
  return FILE_TYPE_ENUM[fileType.toUpperCase()]?.label || fileType;
};

// 获取进度条状态
const getProgressStatus = (status) => {
  if (status === 'completed') return 'success';
  if (status === 'failed') return 'exception';
  if (status === 'downloading') return 'active';
  return 'normal';
};

// 获取进度条颜色
const getProgressColor = (status) => {
  const colorMap = {
    downloading: '#3b82f6',
    paused: '#f59e0b',
    completed: '#10b981',
    failed: '#ef4444',
  };
  return colorMap[status] || '#3b82f6';
};

// 获取状态颜色
const getStatusColor = (status) => {
  return DOWNLOAD_STATUS_ENUM[status.toUpperCase()]?.color || 'default';
};

// 获取状态背景色
const getStatusBgColor = (status) => {
  return DOWNLOAD_STATUS_ENUM[status.toUpperCase()]?.bgColor || '#f3f4f6';
};

// 获取状态文字颜色
const getStatusTextColor = (status) => {
  return DOWNLOAD_STATUS_ENUM[status.toUpperCase()]?.textColor || '#6b7280';
};

// 获取状态标签
const getStatusLabel = (status) => {
  return DOWNLOAD_STATUS_ENUM[status.toUpperCase()]?.label || status;
};

// 获取状态图标
const getStatusIcon = (status) => {
  const iconMap = {
    pending: ClockCircleOutlined,
    downloading: LoadingOutlined,
    paused: PauseCircleOutlined,
    completed: CheckCircleOutlined,
    failed: CloseCircleOutlined,
    cancelled: StopOutlined,
  };
  return iconMap[status] || ClockCircleOutlined;
};

// 暂停下载
const handlePause = async (record) => {
  try {
    await downloadApi.pauseDownload(record.id);
    message.success('下载已暂停');
    loadTaskList();
  } catch (error) {
    message.error('暂停失败: ' + error.message);
  }
};

// 恢复下载
const handleResume = async (record) => {
  try {
    await downloadApi.resumeDownload(record.id);
    message.success('下载已恢复');
    loadTaskList();
  } catch (error) {
    message.error('恢复失败: ' + error.message);
  }
};

// 取消下载
const handleCancel = (record) => {
  Modal.confirm({
    title: '确认取消',
    content: '确定要取消这个下载任务吗？',
    okText: '确定',
    cancelText: '取消',
    onOk: async () => {
      try {
        await downloadApi.cancelDownload(record.id);
        message.success('下载任务已取消');
        loadTaskList();
      } catch (error) {
        message.error('取消失败: ' + error.message);
      }
    },
  });
};

// 重试下载
const handleRetry = async (record) => {
  try {
    await downloadApi.retryDownload(record.id);
    message.success('重新开始下载');
    loadTaskList();
  } catch (error) {
    message.error('重试失败: ' + error.message);
  }
};

// 打开文件夹
const handleOpenFolder = async (record) => {
  try {
    await downloadApi.openFileLocation(record.id);
    message.success('正在打开文件夹...');
  } catch (error) {
    message.error('打开失败: ' + error.message);
  }
};

// 删除任务
const handleDelete = (record) => {
  Modal.confirm({
    title: '确认删除',
    content: '确定要删除这个下载记录吗？',
    okText: '确定',
    cancelText: '取消',
    okType: 'danger',
    onOk: async () => {
      try {
        await downloadApi.deleteDownload(record.id);
        message.success('下载记录已删除');
        loadTaskList();
      } catch (error) {
        message.error('删除失败: ' + error.message);
      }
    },
  });
};

// 批量删除
const handleBatchDelete = () => {
  Modal.confirm({
    title: '确认批量删除',
    content: `确定要删除选中的 ${selectedRowKeys.value.length} 个下载任务吗？`,
    okText: '确定',
    cancelText: '取消',
    okType: 'danger',
    onOk: async () => {
      try {
        await downloadApi.batchDeleteDownload(selectedRowKeys.value);
        message.success('批量删除成功');
        selectedRowKeys.value = [];
        loadTaskList();
      } catch (error) {
        message.error('批量删除失败: ' + error.message);
      }
    },
  });
};

// 启动进度更新定时器
const startProgressTimer = () => {
  progressTimer = setInterval(() => {
    // 只更新下载中的任务
    const downloadingTasks = taskList.value.filter(
      (task) => task.status === 'downloading'
    );

    if (downloadingTasks.length > 0) {
      loadTaskList();
    }
  }, 2000); // 每2秒更新一次
};

// 停止进度更新定时器
const stopProgressTimer = () => {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
};

onMounted(() => {
  loadTaskList();
  startProgressTimer();
});

onUnmounted(() => {
  stopProgressTimer();
});

defineExpose({
  refresh: loadTaskList,
});
</script>

<style scoped lang="less">
.download-task-list {
  .list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid #f0f0f0;

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;

      .list-title {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .list-count {
        color: #6b7280;
        font-size: 14px;
      }
    }
  }

  .file-info {
    display: flex;
    align-items: center;
    gap: 12px;

    .file-details {
      flex: 1;
      min-width: 0;

      .file-name {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-description {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
      }
    }
  }

  .progress-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;

    .progress-text {
      font-size: 14px;
      color: #6b7280;
      white-space: nowrap;
    }
  }
}
</style>
```

### 4. 下载详情弹窗
**位置**: 点击任务详情时弹出

**功能说明**:
- **基本信息**: 文件名、类型、大小、状态
- **下载信息**: 已下载大小、下载速度、剩余时间、开始时间、完成时间
- **文件信息**: 文件路径、MD5值、创建时间
- **错误信息**: 失败原因（如果失败）

**技术实现**:
```vue
<template>
  <a-modal
    :open="visible"
    title="下载任务详情"
    width="800px"
    :footer="null"
    @cancel="handleClose"
  >
    <a-spin :spinning="loading">
      <div class="download-detail-content" v-if="detailData">
        <!-- 基本信息 -->
        <div class="detail-section">
          <h4 class="section-title">基本信息</h4>
          <a-descriptions :column="2" bordered size="small">
            <a-descriptions-item label="文件名">
              {{ detailData.fileName }}
            </a-descriptions-item>
            <a-descriptions-item label="文件类型">
              <a-tag :color="getFileTypeColor(detailData.fileType)">
                {{ getFileTypeLabel(detailData.fileType) }}
              </a-tag>
            </a-descriptions-item>
            <a-descriptions-item label="文件大小">
              {{ formatFileSize(detailData.fileSize) }}
            </a-descriptions-item>
            <a-descriptions-item label="当前状态">
              <a-tag :color="getStatusColor(detailData.status)">
                {{ getStatusLabel(detailData.status) }}
              </a-tag>
            </a-descriptions-item>
          </a-descriptions>
        </div>

        <!-- 下载信息 -->
        <div class="detail-section">
          <h4 class="section-title">下载信息</h4>
          <a-descriptions :column="2" bordered size="small">
            <a-descriptions-item label="下载进度">
              <a-progress
                :percent="detailData.progress"
                :status="getProgressStatus(detailData.status)"
              />
            </a-descriptions-item>
            <a-descriptions-item label="已下载">
              {{ formatFileSize(detailData.downloadedSize) }}
            </a-descriptions-item>
            <a-descriptions-item label="下载速度">
              {{ detailData.status === 'downloading' ? formatDownloadSpeed(detailData.speed) : '-' }}
            </a-descriptions-item>
            <a-descriptions-item label="剩余时间">
              {{ detailData.status === 'downloading' ? formatRemainingTime(detailData.remainingTime) : '-' }}
            </a-descriptions-item>
            <a-descriptions-item label="开始时间">
              {{ detailData.startTime }}
            </a-descriptions-item>
            <a-descriptions-item label="完成时间">
              {{ detailData.completeTime || '-' }}
            </a-descriptions-item>
          </a-descriptions>
        </div>

        <!-- 文件信息 -->
        <div class="detail-section">
          <h4 class="section-title">文件信息</h4>
          <a-descriptions :column="1" bordered size="small">
            <a-descriptions-item label="保存路径">
              {{ detailData.savePath }}
            </a-descriptions-item>
            <a-descriptions-item label="下载URL">
              {{ detailData.downloadUrl }}
            </a-descriptions-item>
            <a-descriptions-item label="MD5值">
              {{ detailData.md5 || '计算中...' }}
            </a-descriptions-item>
            <a-descriptions-item label="创建时间">
              {{ detailData.createTime }}
            </a-descriptions-item>
          </a-descriptions>
        </div>

        <!-- 错误信息（失败时显示） -->
        <div class="detail-section" v-if="detailData.status === 'failed'">
          <h4 class="section-title">错误信息</h4>
          <a-alert
            type="error"
            :message="detailData.errorMessage"
            :description="detailData.errorDetail"
            show-icon
          />
        </div>

        <!-- 操作按钮 -->
        <div class="detail-actions">
          <a-space>
            <a-button
              v-if="detailData.status === 'downloading'"
              @click="handlePause"
            >
              <template #icon><PauseCircleOutlined /></template>
              暂停下载
            </a-button>
            <a-button
              v-if="detailData.status === 'paused'"
              type="primary"
              @click="handleResume"
            >
              <template #icon><PlayCircleOutlined /></template>
              恢复下载
            </a-button>
            <a-button
              v-if="detailData.status === 'failed'"
              type="primary"
              @click="handleRetry"
            >
              <template #icon><RedoOutlined /></template>
              重试下载
            </a-button>
            <a-button
              v-if="detailData.status === 'completed'"
              @click="handleOpenFolder"
            >
              <template #icon><FolderOpenOutlined /></template>
              打开文件夹
            </a-button>
            <a-button @click="handleClose">
              关闭
            </a-button>
          </a-space>
        </div>
      </div>
    </a-spin>
  </a-modal>
</template>

<script setup>
import { ref, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  PauseCircleOutlined,
  PlayCircleOutlined,
  RedoOutlined,
  FolderOpenOutlined,
} from '@ant-design/icons-vue';
import { downloadApi } from '/@/api/business/smart-video/download-api';
import {
  FILE_TYPE_ENUM,
  DOWNLOAD_STATUS_ENUM,
  formatFileSize,
  formatDownloadSpeed,
  formatRemainingTime,
} from '/@/constants/business/download-const';

const props = defineProps({
  visible: Boolean,
  taskId: String,
});

const emit = defineEmits(['update:visible', 'refresh']);

const loading = ref(false);
const detailData = ref(null);

// 加载详情数据
const loadDetail = async () => {
  if (!props.taskId) return;

  loading.value = true;
  try {
    detailData.value = await downloadApi.getDownloadDetail(props.taskId);
  } catch (error) {
    message.error('加载详情失败: ' + error.message);
  } finally {
    loading.value = false;
  }
};

// 监听visible变化
watch(() => props.visible, (newVal) => {
  if (newVal) {
    loadDetail();
  }
});

// 获取文件类型颜色
const getFileTypeColor = (fileType) => {
  return FILE_TYPE_ENUM[fileType?.toUpperCase()]?.color || 'default';
};

// 获取文件类型标签
const getFileTypeLabel = (fileType) => {
  return FILE_TYPE_ENUM[fileType?.toUpperCase()]?.label || fileType;
};

// 获取状态颜色
const getStatusColor = (status) => {
  return DOWNLOAD_STATUS_ENUM[status?.toUpperCase()]?.color || 'default';
};

// 获取状态标签
const getStatusLabel = (status) => {
  return DOWNLOAD_STATUS_ENUM[status?.toUpperCase()]?.label || status;
};

// 获取进度条状态
const getProgressStatus = (status) => {
  if (status === 'completed') return 'success';
  if (status === 'failed') return 'exception';
  if (status === 'downloading') return 'active';
  return 'normal';
};

// 暂停
const handlePause = async () => {
  try {
    await downloadApi.pauseDownload(props.taskId);
    message.success('下载已暂停');
    emit('refresh');
    loadDetail();
  } catch (error) {
    message.error('暂停失败: ' + error.message);
  }
};

// 恢复
const handleResume = async () => {
  try {
    await downloadApi.resumeDownload(props.taskId);
    message.success('下载已恢复');
    emit('refresh');
    loadDetail();
  } catch (error) {
    message.error('恢复失败: ' + error.message);
  }
};

// 重试
const handleRetry = async () => {
  try {
    await downloadApi.retryDownload(props.taskId);
    message.success('重新开始下载');
    emit('refresh');
    loadDetail();
  } catch (error) {
    message.error('重试失败: ' + error.message);
  }
};

// 打开文件夹
const handleOpenFolder = async () => {
  try {
    await downloadApi.openFileLocation(props.taskId);
    message.success('正在打开文件夹...');
  } catch (error) {
    message.error('打开失败: ' + error.message);
  }
};

// 关闭
const handleClose = () => {
  emit('update:visible', false);
};
</script>

<style scoped lang="less">
.download-detail-content {
  .detail-section {
    margin-bottom: 24px;

    &:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      padding-left: 8px;
      border-left: 3px solid #3b82f6;
    }
  }

  .detail-actions {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid #f0f0f0;
    text-align: right;
  }
}
</style>
```

## SmartAdmin项目规范

### 1. 路由配置
```javascript
// src/router/modules/business/smart-video.js
const downloadCenterRouter = {
  path: '/smart-video/download-center',
  name: 'DownloadCenter',
  component: () => import('/@/views/business/smart-video/download-center.vue'),
  meta: {
    title: '下载中心',
    icon: 'DownloadOutlined',
    requireAuth: true,
    keepAlive: true,
  },
};

export default [
  // ... 其他路由
  downloadCenterRouter,
];
```

### 2. 菜单配置
```javascript
// 后端返回的菜单数据格式
{
  menuId: 'download-center',
  menuName: '下载中心',
  menuType: 'MENU',
  parentId: 'smart-video',
  path: '/smart-video/download-center',
  component: 'business/smart-video/download-center',
  icon: 'DownloadOutlined',
  sort: 8,
  visible: true,
  perms: 'smart-video:download:view',
}
```

### 3. Store状态管理
```javascript
// src/stores/modules/download-store.js
import { defineStore } from 'pinia';
import { downloadApi } from '/@/api/business/smart-video/download-api';

export const useDownloadStore = defineStore('download', {
  state: () => ({
    // 下载任务列表
    taskList: [],
    // 下载统计
    statistics: {
      downloading: 0,
      completed: 0,
      failed: 0,
      totalSize: 0,
    },
    // 下载设置
    settings: {
      maxConcurrent: 3,           // 最大并发下载数
      downloadPath: '',            // 下载路径
      autoRetry: true,             // 自动重试
      retryCount: 3,               // 重试次数
      enableChunked: true,         // 启用分片下载
      chunkSize: 10485760,         // 分片大小（10MB）
      enableSpeedLimit: false,     // 启用限速
      speedLimit: 0,               // 速度限制（B/s）
    },
    // 正在下载的任务ID列表
    downloadingTaskIds: [],
  }),

  getters: {
    // 获取下载中的任务
    downloadingTasks: (state) => {
      return state.taskList.filter(task => task.status === 'downloading');
    },

    // 获取已完成的任务
    completedTasks: (state) => {
      return state.taskList.filter(task => task.status === 'completed');
    },

    // 获取失败的任务
    failedTasks: (state) => {
      return state.taskList.filter(task => task.status === 'failed');
    },

    // 是否达到最大并发数
    isMaxConcurrent: (state) => {
      return state.downloadingTaskIds.length >= state.settings.maxConcurrent;
    },
  },

  actions: {
    // 加载任务列表
    async loadTaskList(params) {
      try {
        const result = await downloadApi.queryDownloadList(params);
        this.taskList = result.rows || [];
        return result;
      } catch (error) {
        console.error('加载任务列表失败:', error);
        throw error;
      }
    },

    // 加载统计数据
    async loadStatistics() {
      try {
        const data = await downloadApi.getDownloadStatistics();
        this.statistics = data;
        return data;
      } catch (error) {
        console.error('加载统计数据失败:', error);
        throw error;
      }
    },

    // 加载下载设置
    async loadSettings() {
      try {
        const data = await downloadApi.getDownloadSettings();
        this.settings = data;
        return data;
      } catch (error) {
        console.error('加载下载设置失败:', error);
        throw error;
      }
    },

    // 更新下载设置
    async updateSettings(settings) {
      try {
        await downloadApi.updateDownloadSettings(settings);
        this.settings = { ...this.settings, ...settings };
      } catch (error) {
        console.error('更新下载设置失败:', error);
        throw error;
      }
    },

    // 创建下载任务
    async createTask(params) {
      try {
        const task = await downloadApi.createDownloadTask(params);
        this.taskList.unshift(task);
        this.downloadingTaskIds.push(task.id);
        this.statistics.downloading++;
        return task;
      } catch (error) {
        console.error('创建下载任务失败:', error);
        throw error;
      }
    },

    // 暂停下载
    async pauseTask(taskId) {
      try {
        await downloadApi.pauseDownload(taskId);
        const index = this.downloadingTaskIds.indexOf(taskId);
        if (index > -1) {
          this.downloadingTaskIds.splice(index, 1);
        }
        this.updateTaskStatus(taskId, 'paused');
      } catch (error) {
        console.error('暂停下载失败:', error);
        throw error;
      }
    },

    // 恢复下载
    async resumeTask(taskId) {
      try {
        await downloadApi.resumeDownload(taskId);
        this.downloadingTaskIds.push(taskId);
        this.updateTaskStatus(taskId, 'downloading');
      } catch (error) {
        console.error('恢复下载失败:', error);
        throw error;
      }
    },

    // 取消下载
    async cancelTask(taskId) {
      try {
        await downloadApi.cancelDownload(taskId);
        const index = this.downloadingTaskIds.indexOf(taskId);
        if (index > -1) {
          this.downloadingTaskIds.splice(index, 1);
        }
        this.updateTaskStatus(taskId, 'cancelled');
      } catch (error) {
        console.error('取消下载失败:', error);
        throw error;
      }
    },

    // 删除任务
    async deleteTask(taskId) {
      try {
        await downloadApi.deleteDownload(taskId);
        const index = this.taskList.findIndex(task => task.id === taskId);
        if (index > -1) {
          this.taskList.splice(index, 1);
        }
        const downloadingIndex = this.downloadingTaskIds.indexOf(taskId);
        if (downloadingIndex > -1) {
          this.downloadingTaskIds.splice(downloadingIndex, 1);
        }
      } catch (error) {
        console.error('删除任务失败:', error);
        throw error;
      }
    },

    // 更新任务状态
    updateTaskStatus(taskId, status) {
      const task = this.taskList.find(t => t.id === taskId);
      if (task) {
        task.status = status;
      }
    },

    // 更新任务进度
    updateTaskProgress(taskId, progress) {
      const task = this.taskList.find(t => t.id === taskId);
      if (task) {
        task.progress = progress.progress;
        task.speed = progress.speed;
        task.remainingTime = progress.remainingTime;
        task.downloadedSize = progress.downloadedSize;
      }
    },

    // 清空已完成的任务
    async clearCompleted() {
      try {
        await downloadApi.clearCompletedDownloads();
        this.taskList = this.taskList.filter(task => task.status !== 'completed');
        this.statistics.completed = 0;
      } catch (error) {
        console.error('清空已完成任务失败:', error);
        throw error;
      }
    },
  },
});
```

### 4. 权限配置
```javascript
// 权限常量定义
export const DOWNLOAD_PERMISSIONS = {
  VIEW: 'smart-video:download:view',           // 查看下载中心
  CREATE: 'smart-video:download:create',       // 创建下载任务
  PAUSE: 'smart-video:download:pause',         // 暂停下载
  RESUME: 'smart-video:download:resume',       // 恢复下载
  CANCEL: 'smart-video:download:cancel',       // 取消下载
  DELETE: 'smart-video:download:delete',       // 删除任务
  RETRY: 'smart-video:download:retry',         // 重试下载
  SETTINGS: 'smart-video:download:settings',   // 下载设置
};

// 在组件中使用权限判断
import { usePermission } from '/@/hooks/usePermission';

const { hasPermission } = usePermission();

const canPause = hasPermission(DOWNLOAD_PERMISSIONS.PAUSE);
const canDelete = hasPermission(DOWNLOAD_PERMISSIONS.DELETE);
```

## Mock数据示例

### 1. 下载任务列表Mock
```javascript
// src/mock/business/download-mock.js
import { defineFakeRoute } from 'vite-plugin-fake-server/client';
import { resultSuccess } from '/@/utils/request/mockUtil';

// 模拟下载任务数据
const mockDownloadTasks = [
  {
    id: 'task_001',
    fileName: 'CAM001_20240130_120000_130000.mp4',
    description: '办公区域 - 1小时录像',
    fileType: 'video',
    fileSize: 1288490188,  // 1.2GB
    downloadedSize: 837918883,  // 0.78GB
    progress: 65,
    speed: 2621440,  // 2.5MB/s
    remainingTime: 270,  // 270秒
    status: 'downloading',
    startTime: '2024-01-30 12:00:00',
    completeTime: null,
    savePath: '/downloads/videos/CAM001_20240130_120000_130000.mp4',
    downloadUrl: 'http://example.com/api/video/download/001',
    md5: null,
    createTime: '2024-01-30 12:00:00',
    errorMessage: null,
    errorDetail: null,
  },
  {
    id: 'task_002',
    fileName: '人脸识别报表_20240130.xlsx',
    description: 'AI智能分析模块',
    fileType: 'report',
    fileSize: 16567746,  // 15.8MB
    downloadedSize: 5301678,  // 5.05MB
    progress: 32,
    speed: 1887436,  // 1.8MB/s
    remainingTime: 375,  // 6分15秒
    status: 'downloading',
    startTime: '2024-01-30 11:45:00',
    completeTime: null,
    savePath: '/downloads/reports/人脸识别报表_20240130.xlsx',
    downloadUrl: 'http://example.com/api/report/download/002',
    md5: null,
    createTime: '2024-01-30 11:45:00',
    errorMessage: null,
    errorDetail: null,
  },
  {
    id: 'task_003',
    fileName: '系统日志_20240129.zip',
    description: '系统维护模块',
    fileType: 'log',
    fileSize: 343932928,  // 328MB
    downloadedSize: 302660176,  // 288.6MB
    progress: 88,
    speed: 3355443,  // 3.2MB/s
    remainingTime: 32,
    status: 'downloading',
    startTime: '2024-01-30 11:30:00',
    completeTime: null,
    savePath: '/downloads/logs/系统日志_20240129.zip',
    downloadUrl: 'http://example.com/api/log/download/003',
    md5: null,
    createTime: '2024-01-30 11:30:00',
    errorMessage: null,
    errorDetail: null,
  },
  {
    id: 'task_004',
    fileName: 'CAM015_20240129_080000_090000.mp4',
    description: '大厅区域 - 1小时录像',
    fileType: 'video',
    fileSize: 1027604480,  // 980MB
    downloadedSize: 1027604480,
    progress: 100,
    speed: 0,
    remainingTime: 0,
    status: 'completed',
    startTime: '2024-01-30 10:15:00',
    completeTime: '2024-01-30 10:35:22',
    savePath: '/downloads/videos/CAM015_20240129_080000_090000.mp4',
    downloadUrl: 'http://example.com/api/video/download/004',
    md5: 'a3f5d8c9b2e4a1f6d7c8b9e0a1f2d3c4',
    createTime: '2024-01-30 10:15:00',
    errorMessage: null,
    errorDetail: null,
  },
  {
    id: 'task_005',
    fileName: '数据库_backup_20240128.sql',
    description: '系统备份模块',
    fileType: 'backup',
    fileSize: 2684354560,  // 2.5GB
    downloadedSize: 1207959552,  // 1.125GB
    progress: 45,
    speed: 0,
    remainingTime: 0,
    status: 'failed',
    startTime: '2024-01-30 09:30:00',
    completeTime: null,
    savePath: '/downloads/backups/数据库_backup_20240128.sql',
    downloadUrl: 'http://example.com/api/backup/download/005',
    md5: null,
    createTime: '2024-01-30 09:30:00',
    errorMessage: '连接超时',
    errorDetail: '连接服务器超过30秒未响应，下载已中断。请检查网络连接后重试。',
  },
  {
    id: 'task_006',
    fileName: '告警数据导出_20240125-20240130.zip',
    description: '历史告警模块',
    fileType: 'export',
    fileSize: 524288000,  // 500MB
    downloadedSize: 0,
    progress: 0,
    speed: 0,
    remainingTime: 0,
    status: 'pending',
    startTime: null,
    completeTime: null,
    savePath: '/downloads/exports/告警数据导出_20240125-20240130.zip',
    downloadUrl: 'http://example.com/api/export/download/006',
    md5: null,
    createTime: '2024-01-30 12:30:00',
    errorMessage: null,
    errorDetail: null,
  },
];

// 下载统计数据
const mockStatistics = {
  downloading: 3,
  completed: 156,
  failed: 2,
  pending: 1,
  paused: 0,
  cancelled: 4,
  totalBytes: 25232932249,  // 23.5GB
  totalSize: '23.5GB',
};

export default defineFakeRoute([
  // 查询下载任务列表
  {
    url: '/api/download/query',
    method: 'post',
    response: ({ body }) => {
      const { pageNum = 1, pageSize = 10, fileType, status } = body;

      let filteredTasks = [...mockDownloadTasks];

      // 按类型筛选
      if (fileType) {
        filteredTasks = filteredTasks.filter(task => task.fileType === fileType);
      }

      // 按状态筛选
      if (status) {
        filteredTasks = filteredTasks.filter(task => task.status === status);
      }

      const total = filteredTasks.length;
      const start = (pageNum - 1) * pageSize;
      const end = start + pageSize;
      const rows = filteredTasks.slice(start, end);

      return resultSuccess({
        rows,
        total,
        pageNum,
        pageSize,
      });
    },
  },

  // 获取下载任务详情
  {
    url: '/api/download/detail/:taskId',
    method: 'get',
    response: ({ params }) => {
      const task = mockDownloadTasks.find(t => t.id === params.taskId);
      return resultSuccess(task);
    },
  },

  // 获取下载统计
  {
    url: '/api/download/statistics',
    method: 'get',
    response: () => {
      return resultSuccess(mockStatistics);
    },
  },

  // 暂停下载
  {
    url: '/api/download/pause/:taskId',
    method: 'post',
    response: ({ params }) => {
      const task = mockDownloadTasks.find(t => t.id === params.taskId);
      if (task) {
        task.status = 'paused';
      }
      return resultSuccess(true);
    },
  },

  // 恢复下载
  {
    url: '/api/download/resume/:taskId',
    method: 'post',
    response: ({ params }) => {
      const task = mockDownloadTasks.find(t => t.id === params.taskId);
      if (task) {
        task.status = 'downloading';
      }
      return resultSuccess(true);
    },
  },

  // 取消下载
  {
    url: '/api/download/cancel/:taskId',
    method: 'post',
    response: ({ params }) => {
      const task = mockDownloadTasks.find(t => t.id === params.taskId);
      if (task) {
        task.status = 'cancelled';
      }
      return resultSuccess(true);
    },
  },

  // 删除下载任务
  {
    url: '/api/download/delete/:taskId',
    method: 'post',
    response: ({ params }) => {
      const index = mockDownloadTasks.findIndex(t => t.id === params.taskId);
      if (index > -1) {
        mockDownloadTasks.splice(index, 1);
      }
      return resultSuccess(true);
    },
  },

  // 批量删除
  {
    url: '/api/download/batch/delete',
    method: 'post',
    response: ({ body }) => {
      const { taskIds } = body;
      taskIds.forEach(taskId => {
        const index = mockDownloadTasks.findIndex(t => t.id === taskId);
        if (index > -1) {
          mockDownloadTasks.splice(index, 1);
        }
      });
      return resultSuccess(true);
    },
  },

  // 重试下载
  {
    url: '/api/download/retry/:taskId',
    method: 'post',
    response: ({ params }) => {
      const task = mockDownloadTasks.find(t => t.id === params.taskId);
      if (task) {
        task.status = 'downloading';
        task.progress = 0;
        task.downloadedSize = 0;
        task.errorMessage = null;
        task.errorDetail = null;
      }
      return resultSuccess(true);
    },
  },

  // 暂停所有下载
  {
    url: '/api/download/pause-all',
    method: 'post',
    response: () => {
      mockDownloadTasks.forEach(task => {
        if (task.status === 'downloading') {
          task.status = 'paused';
        }
      });
      return resultSuccess(true);
    },
  },

  // 清理已完成的下载
  {
    url: '/api/download/clear-completed',
    method: 'post',
    response: () => {
      const completedTasks = mockDownloadTasks.filter(t => t.status === 'completed');
      completedTasks.forEach(task => {
        const index = mockDownloadTasks.findIndex(t => t.id === task.id);
        if (index > -1) {
          mockDownloadTasks.splice(index, 1);
        }
      });
      mockStatistics.completed = 0;
      return resultSuccess(true);
    },
  },

  // 打开文件所在目录
  {
    url: '/api/download/open-location/:taskId',
    method: 'post',
    response: () => {
      return resultSuccess(true);
    },
  },

  // 获取下载进度
  {
    url: '/api/download/progress/:taskId',
    method: 'get',
    response: ({ params }) => {
      const task = mockDownloadTasks.find(t => t.id === params.taskId);
      if (task && task.status === 'downloading') {
        // 模拟进度增加
        task.progress = Math.min(task.progress + Math.random() * 5, 100);
        task.downloadedSize = Math.floor(task.fileSize * (task.progress / 100));

        if (task.progress >= 100) {
          task.status = 'completed';
          task.completeTime = new Date().toISOString();
        }
      }
      return resultSuccess({
        progress: task?.progress || 0,
        speed: task?.speed || 0,
        remainingTime: task?.remainingTime || 0,
        downloadedSize: task?.downloadedSize || 0,
        status: task?.status || 'pending',
      });
    },
  },
]);
```

## 最佳实践建议

### 1. 性能优化

#### 使用虚拟滚动优化大列表
```vue
<template>
  <a-table
    :columns="columns"
    :data-source="taskList"
    :virtual="true"
    :scroll="{ y: 600, x: 1400 }"
  />
</template>
```

#### 使用防抖优化搜索
```javascript
import { debounce } from 'lodash-es';

const handleSearch = debounce((keyword) => {
  // 执行搜索
}, 300);
```

#### 使用WebSocket代替轮询
```javascript
// WebSocket连接
const connectWebSocket = () => {
  const ws = new WebSocket('ws://your-server.com/download-progress');

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    updateDownloadProgress(data.taskId, data.progress);
  };

  return ws;
};
```

### 2. 错误处理

#### 统一错误处理
```javascript
const handleError = (error, action) => {
  console.error(`${action}失败:`, error);

  if (error.code === 'NETWORK_ERROR') {
    message.error('网络连接失败，请检查网络设置');
  } else if (error.code === 'TIMEOUT') {
    message.error('请求超时，请稍后重试');
  } else if (error.code === 'PERMISSION_DENIED') {
    message.error('权限不足，无法执行此操作');
  } else {
    message.error(error.message || '操作失败');
  }
};
```

### 3. 断点续传实现

```javascript
// 分片下载实现
const downloadWithChunks = async (url, fileName, options = {}) => {
  const {
    chunkSize = 10 * 1024 * 1024,  // 10MB
    onProgress,
    onError,
  } = options;

  try {
    // 获取文件总大小
    const headResponse = await axios.head(url);
    const totalSize = parseInt(headResponse.headers['content-length']);

    let downloaded = 0;
    const chunks = [];

    // 分片下载
    while (downloaded < totalSize) {
      const start = downloaded;
      const end = Math.min(downloaded + chunkSize - 1, totalSize - 1);

      try {
        const response = await axios.get(url, {
          headers: {
            Range: `bytes=${start}-${end}`,
          },
          responseType: 'blob',
        });

        chunks.push(response.data);
        downloaded = end + 1;

        if (onProgress) {
          onProgress({
            downloaded,
            total: totalSize,
            progress: Math.round((downloaded / totalSize) * 100),
          });
        }
      } catch (error) {
        if (onError) {
          onError(error, { start, end, downloaded, totalSize });
        }
        throw error;
      }
    }

    // 合并分片
    const blob = new Blob(chunks);
    saveAs(blob, fileName);

    return true;
  } catch (error) {
    console.error('下载失败:', error);
    throw error;
  }
};
```

### 4. 文件下载优化

```javascript
// 使用Blob URL优化下载
const downloadFile = async (taskId) => {
  try {
    const response = await downloadApi.downloadFile(taskId);
    const blob = new Blob([response.data]);
    const url = window.URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = getFileName(response.headers);
    link.click();

    // 释放Blob URL
    setTimeout(() => {
      window.URL.revokeObjectURL(url);
    }, 100);
  } catch (error) {
    message.error('下载失败: ' + error.message);
  }
};

// 从响应头获取文件名
const getFileName = (headers) => {
  const disposition = headers['content-disposition'];
  if (disposition) {
    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(disposition);
    if (matches && matches[1]) {
      return decodeURIComponent(matches[1].replace(/['"]/g, ''));
    }
  }
  return 'download';
};
```

### 5. 下载队列管理

```javascript
// 下载队列管理器
class DownloadQueue {
  constructor(maxConcurrent = 3) {
    this.maxConcurrent = maxConcurrent;
    this.queue = [];
    this.running = [];
  }

  add(task) {
    this.queue.push(task);
    this.process();
  }

  async process() {
    if (this.running.length >= this.maxConcurrent || this.queue.length === 0) {
      return;
    }

    const task = this.queue.shift();
    this.running.push(task);

    try {
      await task.execute();
    } catch (error) {
      console.error('任务执行失败:', error);
    } finally {
      const index = this.running.indexOf(task);
      if (index > -1) {
        this.running.splice(index, 1);
      }
      this.process();
    }
  }

  pause(taskId) {
    const task = this.running.find(t => t.id === taskId);
    if (task) {
      task.pause();
    }
  }

  resume(taskId) {
    const task = this.queue.find(t => t.id === taskId);
    if (task) {
      this.process();
    }
  }

  clear() {
    this.queue = [];
    this.running.forEach(task => task.cancel());
    this.running = [];
  }
}

// 使用下载队列
const downloadQueue = new DownloadQueue(3);

const createDownloadTask = (taskData) => {
  return {
    id: taskData.id,
    execute: async () => {
      // 执行下载逻辑
      await downloadWithChunks(taskData.url, taskData.fileName, {
        onProgress: (progress) => {
          // 更新进度
        },
      });
    },
    pause: () => {
      // 暂停逻辑
    },
    cancel: () => {
      // 取消逻辑
    },
  };
};
```

### 6. 内存管理

```javascript
// 及时清理不需要的数据
const cleanupCompletedTasks = () => {
  // 只保留最近100个已完成的任务
  const completedTasks = taskList.value.filter(t => t.status === 'completed');
  if (completedTasks.length > 100) {
    const toRemove = completedTasks.slice(0, completedTasks.length - 100);
    toRemove.forEach(task => {
      const index = taskList.value.findIndex(t => t.id === task.id);
      if (index > -1) {
        taskList.value.splice(index, 1);
      }
    });
  }
};

// 定期清理
setInterval(cleanupCompletedTasks, 60000); // 每分钟清理一次
```

## 常见问题排查

### 1. 下载进度不更新
**原因**: WebSocket连接断开或轮询未启动
**解决方案**:
```javascript
// 检查WebSocket连接状态
if (ws.readyState !== WebSocket.OPEN) {
  ws = connectWebSocket();
}

// 确保轮询定时器正常运行
if (!progressTimer) {
  startProgressTimer();
}
```

### 2. 大文件下载失败
**原因**: 内存溢出或网络超时
**解决方案**:
- 使用分片下载
- 增加超时时间
- 实现断点续传

### 3. 下载速度计算不准确
**原因**: 采样间隔太短或太长
**解决方案**:
```javascript
// 使用移动平均计算速度
class SpeedCalculator {
  constructor(windowSize = 5) {
    this.windowSize = windowSize;
    this.samples = [];
  }

  addSample(bytes, timestamp) {
    this.samples.push({ bytes, timestamp });
    if (this.samples.length > this.windowSize) {
      this.samples.shift();
    }
  }

  getSpeed() {
    if (this.samples.length < 2) return 0;

    const first = this.samples[0];
    const last = this.samples[this.samples.length - 1];

    const bytesDiff = last.bytes - first.bytes;
    const timeDiff = (last.timestamp - first.timestamp) / 1000; // 转换为秒

    return timeDiff > 0 ? bytesDiff / timeDiff : 0;
  }
}
```

## 总结

下载中心页面是智能视频监控系统的重要功能模块，本文档提供了完整的技术实现方案和最佳实践建议。开发时需要特别注意：

1. **性能优化**: 使用虚拟滚动、分片下载、WebSocket等技术优化性能
2. **错误处理**: 完善的错误处理和重试机制
3. **用户体验**: 实时进度更新、友好的状态提示
4. **资源管理**: 及时清理完成的任务，避免内存泄漏
5. **安全性**: 权限控制、文件验证、路径安全

通过遵循本文档的规范和建议，可以开发出稳定、高效、用户友好的下载中心功能。
