# ===================================================================
# IOE-DREAM 微服务Docker镜像模板
# 适用于所有Java Spring Boot微服务的标准化Dockerfile
# ===================================================================

# 使用官方OpenJDK 17运行时作为基础镜像
FROM openjdk:17-jre-slim

# 维护者信息
LABEL maintainer="IOE-DREAM Team <team@ioedream.com>"
LABEL version="1.0.0"
LABEL description="IOE-DREAM微服务 - ${SERVICE_NAME}"
LABEL vcs-url="https://github.com/ioedream/microservices"
LABEL build-date="${BUILD_DATE}"

# 设置工作目录
WORKDIR /app

# 安装必要的系统工具
RUN apt-get update && apt-get install -y \
    curl \
    netcat-openbsd \
    dnsutils \
    tzdata \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# 设置时区
ENV TZ=Asia/Shanghai

# 创建非root用户
RUN groupadd -r ioedream && useradd -r -g ioedream ioedream \
    && mkdir -p /app/logs \
    && chown -R ioedream:ioedream /app

# 复制应用程序JAR文件
COPY target/*.jar app.jar

# 创建健康检查脚本
RUN echo '#!/bin/bash\n\
set -e\n\
# 检查应用健康状态\n\
if curl -f -s --connect-timeout 10 --max-time 30 http://localhost:8080/actuator/health > /dev/null 2>&1; then\n\
    echo "Health check passed"\n\
    exit 0\n\
else\n\
    echo "Health check failed"\n\
    exit 1\n\
fi' > /app/healthcheck.sh \
    && chmod +x /app/healthcheck.sh

# 创建启动脚本
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting ${SERVICE_NAME}..."\n\
echo "Java Version: $(java -version 2>&1 | head -1)"\n\
echo "Application Version: ${APP_VERSION:-unknown}"\n\
echo "Profile: ${SPRING_PROFILES_ACTIVE:-default}"\n\
echo "Build Time: ${BUILD_DATE:-unknown}"\n\
\n\
# JVM参数调优\n\
JVM_OPTS="-Xms${HEAP_SIZE_MIN:-256m} -Xmx${HEAP_SIZE_MAX:-512m}"\n\
JVM_OPTS="$JVM_OPTS -XX:+UseG1GC"\n\
JVM_OPTS="$JVM_OPTS -XX:+UseContainerSupport"\n\
JVM_OPTS="$JVM_OPTS -XX:MaxRAMPercentage=75.0"\n\
JVM_OPTS="$JVM_OPTS -XX:+PrintGCDetails"\n\
JVM_OPTS="$JVM_OPTS -XX:+PrintGCTimeStamps"\n\
JVM_OPTS="$JVM_OPTS -Xloggc:/app/logs/gc.log"\n\
JVM_OPTS="$JVM_OPTS -XX:+UseGCLogFileRotation"\n\
JVM_OPTS="$JVM_OPTS -XX:NumberOfGCLogFiles=5"\n\
JVM_OPTS="$JVM_OPTS -XX:GCLogFileSize=10M"\n\
\n\
# 安全参数\n\
JVM_OPTS="$JVM_OPTS -Djava.security.egd=file:/dev/./urandom"\n\
JVM_OPTS="$JVM_OPTS -Dspring.profiles.active=${SPRING_PROFILES_ACTIVE:-docker}"\n\
\n\
# 监控参数\n\
JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote"\n\
JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.port=9010"\n\
JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.authenticate=false"\n\
JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.ssl=false"\n\
\n\
# 应用参数\n\
APP_OPTS="--server.port=8080"\n\
APP_OPTS="$APP_OPTS --management.endpoints.web.exposure.include=health,info,metrics,prometheus"\n\
APP_OPTS="$APP_OPTS --management.endpoint.health.show-details=always"\n\
APP_OPTS="$APP_OPTS --spring.application.name=${SERVICE_NAME}"\n\
\n\
echo "JVM Options: $JVM_OPTS"\n\
echo "Application Options: $APP_OPTS"\n\
\n\
# 等待依赖服务启动（如果需要）\n\
if [ -n "$WAIT_FOR_SERVICES" ]; then\n\
    echo "Waiting for services: $WAIT_FOR_SERVICES"\n\
    for service in $WAIT_FOR_SERVICES; do\n\
        host=$(echo $service | cut -d: -f1)\n\
        port=$(echo $service | cut -d: -f2)\n\
        echo "Waiting for $host:$port..."\n\
        while ! nc -z $host $port; do\n\
            echo "  $host:$port not ready, waiting..."\n\
            sleep 2\n\
        done\n\
        echo "  $host:$port is ready!"\n\
    done\n\
fi\n\
\n\
# 启动应用程序\n\
echo "Starting application..."\n\
exec java $JVM_OPTS $JAVA_OPTS -jar app.jar $APP_OPTS "$@"' > /app/start.sh \
    && chmod +x /app/start.sh

# 切换到非root用户
USER ioedream

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /app/healthcheck.sh

# 设置环境变量
ENV JAVA_OPTS="-Dspring.profiles.active=docker"
ENV APP_VERSION="1.0.0"
ENV SERVICE_NAME="ioedream-microservice"
ENV HEAP_SIZE_MIN="256m"
ENV HEAP_SIZE_MAX="512m"

# 数据卷
VOLUME ["/app/logs"]

# 启动应用程序
ENTRYPOINT ["/app/start.sh"]

# 默认命令（如果需要覆盖）
CMD [""]