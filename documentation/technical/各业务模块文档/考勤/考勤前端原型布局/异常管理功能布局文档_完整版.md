# 异常管理功能布局文档 - 完整版

## 功能概述

异常管理模块是考勤系统的异常处理中心，包含请假管理、加班管理、补签管理、调班管理、销假管理、异常处理等功能。该模块提供完整的异常申请、审批、处理流程，支持多种异常类型管理，实现考勤异常的规范化处理和自动化审批。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **文件上传**: Ant Design Vue Upload
- **工作流引擎**: Bpmn.js (可选)
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue

### 项目文件组织结构
```
src/views/business/attendance/exception/
├── index.vue                        # 异常管理主页面
├── leave/
│   ├── index.vue                   # 请假管理页面
│   ├── components/
│   │   ├── LeaveApplication.vue    # 请假申请组件
│   │   ├── LeaveApproval.vue       # 请假审批组件
│   │   ├── LeaveTypeConfig.vue     # 请假类型配置
│   │   └── LeaveStatistics.vue     # 请假统计分析
│   └── api/
│       └── leave-api.js            # 请假API
├── overtime/
│   ├── index.vue                   # 加班管理页面
│   ├── components/
│   │   ├── OvertimeApplication.vue # 加班申请组件
│   │   ├── OvertimeApproval.vue    # 加班审批组件
│   │   ├── OvertimeRuleConfig.vue  # 加班规则配置
│   │   └── OvertimeStatistics.vue  # 加班统计分析
│   └── api/
│       └── overtime-api.js         # 加班API
├── supplement/
│   ├── index.vue                   # 补签管理页面
│   ├── components/
│   │   ├── SupplementApplication.vue # 补签申请组件
│   │   ├── SupplementApproval.vue    # 补签审批组件
│   │   ├── SupplementRuleConfig.vue  # 补签规则配置
│   │   └── SupplementStatistics.vue  # 补签统计分析
│   └── api/
│       └── supplement-api.js       # 补签API
├── shift-change/
│   ├── index.vue                   # 调班管理页面
│   ├── components/
│   │   ├── ShiftChangeApplication.vue # 调班申请组件
│   │   ├── ShiftChangeApproval.vue    # 调班审批组件
│   │   ├── ShiftChangeRuleConfig.vue  # 调班规则配置
│   │   └── ShiftChangeStatistics.vue  # 调班统计分析
│   └── api/
│       └── shift-change-api.js      # 调班API
├── processing/
│   ├── index.vue                   # 异常处理页面
│   ├── components/
│   │   ├── ExceptionList.vue       # 异常列表组件
│   │   ├── ExceptionDetail.vue     # 异常详情组件
│   │   ├── ExceptionAnalyzer.vue   # 异常分析组件
│   │   └── ExceptionStatistics.vue # 异常统计分析
│   └── api/
│       └── processing-api.js       # 异常处理API
├── mock/
│   └── exception-mock.js           # 模拟数据
├── api/
│   └── exception-api.js            # 统一API接口
└── utils/
    ├── workflow-utils.js           # 工作流工具函数
    ├── approval-utils.js           # 审批工具函数
    └── notification-utils.js       # 通知工具函数
```

### API接口设计
```javascript
// src/api/business/attendance/exception/leave-api.js
import { postRequest, getRequest, putRequest, deleteRequest } from '/@/lib/axios';

export const leaveApi = {
  // 请假申请
  getLeaveApplications: (params) => getRequest('/attendance/exception/leave/applications', params),
  createLeaveApplication: (params) => postRequest('/attendance/exception/leave/apply', params),
  updateLeaveApplication: (id, params) => putRequest(`/attendance/exception/leave/application/${id}`, params),
  deleteLeaveApplication: (id) => deleteRequest(`/attendance/exception/leave/application/${id}`),

  // 请假审批
  getLeaveApprovals: (params) => getRequest('/attendance/exception/leave/approvals', params),
  approveLeaveApplication: (id, params) => postRequest(`/attendance/exception/leave/approve/${id}`, params),
  rejectLeaveApplication: (id, params) => postRequest(`/attendance/exception/leave/reject/${id}`, params),

  // 请假类型
  getLeaveTypes: () => getRequest('/attendance/exception/leave/types'),
  createLeaveType: (params) => postRequest('/attendance/exception/leave/types/create', params),
  updateLeaveType: (id, params) => putRequest(`/attendance/exception/leave/types/${id}`, params),

  // 请假统计
  getLeaveStatistics: (params) => getRequest('/attendance/exception/leave/statistics', params),
  getLeaveBalance: (employeeId) => getRequest(`/attendance/exception/leave/balance/${employeeId}`),
};

// src/api/business/attendance/exception/overtime-api.js
export const overtimeApi = {
  // 加班申请
  getOvertimeApplications: (params) => getRequest('/attendance/exception/overtime/applications', params),
  createOvertimeApplication: (params) => postRequest('/attendance/exception/overtime/apply', params),
  updateOvertimeApplication: (id, params) => putRequest(`/attendance/exception/overtime/application/${id}`, params),

  // 加班审批
  getOvertimeApprovals: (params) => getRequest('/attendance/exception/overtime/approvals', params),
  approveOvertimeApplication: (id, params) => postRequest(`/attendance/exception/overtime/approve/${id}`, params),

  // 加班规则
  getOvertimeRules: () => getRequest('/attendance/exception/overtime/rules'),
  updateOvertimeRule: (id, params) => putRequest(`/attendance/exception/overtime/rule/${id}`, params),

  // 加班统计
  getOvertimeStatistics: (params) => getRequest('/attendance/exception/overtime/statistics', params),
};
```

## 核心功能模块

### 1. 请假申请组件

```vue
<!-- src/views/business/attendance/exception/leave/components/LeaveApplication.vue -->
<template>
  <div class="leave-application">
    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      layout="vertical"
    >
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="请假类型" name="leaveType">
            <a-select
              v-model:value="formData.leaveType"
              placeholder="请选择请假类型"
              @change="handleLeaveTypeChange"
            >
              <a-select-option
                v-for="type in leaveTypes"
                :key="type.id"
                :value="type.id"
                :disabled="!checkLeaveBalance(type.id)"
              >
                <div class="leave-type-option">
                  <span>{{ type.name }}</span>
                  <span class="balance-info">余额: {{ getLeaveBalance(type.id) }}{{ type.unit }}</span>
                </div>
              </a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
        <a-col :span="12">
          <a-form-item label="请假事由" name="reason">
            <a-select
              v-model:value="formData.reasonCategory"
              placeholder="请选择请假事由"
              @change="handleReasonChange"
            >
              <a-select-option
                v-for="reason in reasonOptions"
                :key="reason.value"
                :value="reason.value"
              >
                {{ reason.label }}
              </a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="8">
          <a-form-item label="开始时间" name="startTime">
            <a-date-picker
              v-model:value="formData.startTime"
              show-time
              format="YYYY-MM-DD HH:mm"
              placeholder="选择开始时间"
              style="width: 100%"
              :disabled-date="disabledStartDate"
              @change="handleDateChange"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <a-form-item label="结束时间" name="endTime">
            <a-date-picker
              v-model:value="formData.endTime"
              show-time
              format="YYYY-MM-DD HH:mm"
              placeholder="选择结束时间"
              style="width: 100%"
              :disabled-date="disabledEndDate"
              @change="handleDateChange"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <a-form-item label="请假时长">
            <a-input-group compact>
              <a-input-number
                v-model:value="formData.duration"
                :min="0.5"
                :step="0.5"
                style="width: 70%"
                placeholder="时长"
                :disabled="true"
              />
              <a-input
                style="width: 30%; text-align: center; border-left: 0; pointer-events: none"
                placeholder="天"
                disabled
              />
            </a-input-group>
          </a-form-item>
        </a-col>
      </a-row>

      <a-form-item label="请假原因" name="description">
        <a-textarea
          v-model:value="formData.description"
          placeholder="请详细描述请假原因"
          :rows="4"
          show-count
          :maxlength="500"
        />
      </a-form-item>

      <a-form-item label="证明文件" name="attachments">
        <a-upload
          v-model:file-list="formData.attachments"
          :before-upload="beforeUpload"
          :custom-request="handleUpload"
          :remove="handleRemove"
          multiple
          :max-count="5"
        >
          <a-button>
            <template #icon><UploadOutlined /></template>
            上传文件
          </a-button>
          <div class="upload-tip">
            支持jpg、png、pdf格式，单个文件不超过10MB
          </div>
        </a-upload>
      </a-form-item>

      <a-form-item label="紧急联系人" name="emergencyContact">
        <a-input
          v-model:value="formData.emergencyContact"
          placeholder="紧急联系人姓名及电话"
        />
      </a-form-item>

      <a-form-item label="工作交接">
        <a-switch
          v-model:checked="formData.needsHandover"
          checked-children="需要"
          un-checked-children="不需要"
        />
      </a-form-item>

      <a-form-item name="handoverInfo" v-if="formData.needsHandover">
        <a-textarea
          v-model:value="formData.handoverInfo"
          placeholder="请描述工作交接安排"
          :rows="3"
        />
      </a-form-item>

      <a-form-item>
        <a-space>
          <a-button type="primary" @click="handleSubmit" :loading="submitting">
            提交申请
          </a-button>
          <a-button @click="handleSaveDraft" :loading="saving">
            保存草稿
          </a-button>
          <a-button @click="handleReset">
            重置
          </a-button>
        </a-space>
      </a-form-item>
    </a-form>

    <!-- 请假余额提示 -->
    <a-modal
      v-model:open="balanceWarningVisible"
      title="余额不足提醒"
      @ok="balanceWarningVisible = false"
    >
      <div class="balance-warning">
        <a-alert
          message="假期余额不足"
          :description="balanceWarningMessage"
          type="warning"
          show-icon
        />
        <div class="balance-details" v-if="currentLeaveType">
          <a-descriptions title="假期详情" :column="2" size="small">
            <a-descriptions-item label="假期类型">
              {{ currentLeaveType.name }}
            </a-descriptions-item>
            <a-descriptions-item label="当前余额">
              {{ currentLeaveBalance }}{{ currentLeaveType.unit }}
            </a-descriptions-item>
            <a-descriptions-item label="申请时长">
              {{ formData.duration }}{{ currentLeaveType.unit }}
            </a-descriptions-item>
            <a-descriptions-item label="差额">
              <span :class="{ 'negative': balanceDiff < 0 }">
                {{ Math.abs(balanceDiff) }}{{ currentLeaveType.unit }}
                {{ balanceDiff < 0 ? '(不足)' : '(剩余)' }}
              </span>
            </a-descriptions-item>
          </a-descriptions>
        </div>
      </div>
    </a-modal>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import { UploadOutlined } from '@ant-design/icons-vue';
import { leaveApi } from '/@/api/business/attendance/exception/leave-api';
import dayjs from 'dayjs';

const props = defineProps({
  employeeId: {
    type: String,
    required: true
  },
  initialData: {
    type: Object,
    default: () => ({})
  }
});

const emit = defineEmits(['submit-success', 'save-draft']);

const formRef = ref();
const submitting = ref(false);
const saving = ref(false);
const balanceWarningVisible = ref(false);
const balanceWarningMessage = ref('');

const leaveTypes = ref([]);
const leaveBalances = ref({});
const reasonOptions = ref([]);
const currentLeaveType = ref(null);
const currentLeaveBalance = ref(0);
const balanceDiff = ref(0);

const formData = reactive({
  leaveType: '',
  reasonCategory: '',
  startTime: null,
  endTime: null,
  duration: 0,
  description: '',
  attachments: [],
  emergencyContact: '',
  needsHandover: false,
  handoverInfo: ''
});

const formRules = {
  leaveType: [
    { required: true, message: '请选择请假类型', trigger: 'change' }
  ],
  reasonCategory: [
    { required: true, message: '请选择请假事由', trigger: 'change' }
  ],
  startTime: [
    { required: true, message: '请选择开始时间', trigger: 'change' }
  ],
  endTime: [
    { required: true, message: '请选择结束时间', trigger: 'change' }
  ],
  description: [
    { required: true, message: '请输入请假原因', trigger: 'blur' },
    { min: 10, message: '请假原因至少10个字符', trigger: 'blur' }
  ]
};

// 加载请假类型
const loadLeaveTypes = async () => {
  try {
    const response = await leaveApi.getLeaveTypes();
    leaveTypes.value = response.data;
  } catch (error) {
    console.error('加载请假类型失败:', error);
  }
};

// 加载假期余额
const loadLeaveBalances = async () => {
  try {
    const response = await leaveApi.getLeaveBalance(props.employeeId);
    leaveBalances.value = response.data;
  } catch (error) {
    console.error('加载假期余额失败:', error);
  }
};

// 检查假期余额
const checkLeaveBalance = (leaveTypeId) => {
  const balance = leaveBalances.value[leaveTypeId] || 0;
  return balance > 0;
};

// 获取假期余额
const getLeaveBalance = (leaveTypeId) => {
  return leaveBalances.value[leaveTypeId] || 0;
};

// 请假类型变化
const handleLeaveTypeChange = (value) => {
  const leaveType = leaveTypes.value.find(type => type.id === value);
  currentLeaveType.value = leaveType;
  currentLeaveBalance.value = getLeaveBalance(value);

  // 根据请假类型设置事由选项
  updateReasonOptions(value);
};

// 更新事由选项
const updateReasonOptions = (leaveTypeId) => {
  const leaveType = leaveTypes.value.find(type => type.id === leaveTypeId);
  if (leaveType && leaveType.reasonOptions) {
    reasonOptions.value = leaveType.reasonOptions;
  } else {
    reasonOptions.value = [
      { label: '个人事务', value: 'personal' },
      { label: '身体不适', value: 'health' },
      { label: '家庭事务', value: 'family' },
      { label: '其他原因', value: 'other' }
    ];
  }
};

// 事由变化
const handleReasonChange = (value) => {
  // 根据事由设置默认描述
  const reason = reasonOptions.value.find(r => r.value === value);
  if (reason && reason.template) {
    formData.description = reason.template;
  }
};

// 日期变化
const handleDateChange = () => {
  if (formData.startTime && formData.endTime) {
    calculateDuration();
    checkBalance();
  }
};

// 计算请假时长
const calculateDuration = () => {
  const start = formData.startTime;
  const end = formData.endTime;

  if (start && end) {
    // 计算工作日时长（考虑工作时间和休息时间）
    const duration = calculateWorkDays(start, end);
    formData.duration = duration;
  }
};

// 计算工作日时长
const calculateWorkDays = (startDate, endDate) => {
  // 简化计算，实际应考虑工作时间和节假日
  const days = endDate.diff(startDate, 'day', true);
  return Math.ceil(days * 10) / 10; // 保留一位小数
};

// 检查余额
const checkBalance = () => {
  if (!currentLeaveType.value || !formData.duration) return;

  const balance = currentLeaveBalance.value;
  const requested = formData.duration;
  balanceDiff.value = balance - requested;

  if (balanceDiff.value < 0) {
    balanceWarningMessage.value = `您的${currentLeaveType.value.name}余额不足，当前余额${balance}天，申请时长${requested}天，还需${Math.abs(balanceDiff)}天。`;
    balanceWarningVisible.value = true;
  }
};

// 禁用开始日期
const disabledStartDate = (current) => {
  return current && current < dayjs().startOf('day');
};

// 禁用结束日期
const disabledEndDate = (current) => {
  if (!formData.startTime) return false;
  return current && current < formData.startTime.startOf('day');
};

// 文件上传前检查
const beforeUpload = (file) => {
  const isValidType = ['image/jpeg', 'image/png', 'application/pdf'].includes(file.type);
  if (!isValidType) {
    message.error('只能上传jpg、png、pdf格式的文件');
    return false;
  }

  const isLt10M = file.size / 1024 / 1024 < 10;
  if (!isLt10M) {
    message.error('文件大小不能超过10MB');
    return false;
  }

  return false; // 阻止自动上传
};

// 自定义上传
const handleUpload = ({ file, onSuccess, onError }) => {
  // 这里应该调用上传API
  setTimeout(() => {
    onSuccess({ url: `mock-url-${file.name}` });
  }, 1000);
};

// 移除文件
const handleRemove = (file) => {
  // 这里应该调用删除API
  return true;
};

// 提交申请
const handleSubmit = async () => {
  try {
    await formRef.value.validate();

    if (balanceDiff.value < 0) {
      message.warning('假期余额不足，请确认是否继续提交');
    }

    submitting.value = true;

    const submitData = {
      ...formData,
      startTime: formData.startTime.format('YYYY-MM-DD HH:mm:ss'),
      endTime: formData.endTime.format('YYYY-MM-DD HH:mm:ss'),
      attachments: formData.attachments.map(file => ({
        name: file.name,
        url: file.url || file.response?.url
      }))
    };

    await leaveApi.createLeaveApplication(submitData);
    message.success('请假申请提交成功');
    emit('submit-success', submitData);
    handleReset();
  } catch (error) {
    if (error.errorFields) {
      message.error('请检查表单填写是否正确');
    } else {
      message.error('提交失败');
    }
  } finally {
    submitting.value = false;
  }
};

// 保存草稿
const handleSaveDraft = async () => {
  try {
    saving.value = true;

    const draftData = {
      ...formData,
      startTime: formData.startTime?.format('YYYY-MM-DD HH:mm:ss'),
      endTime: formData.endTime?.format('YYYY-MM-DD HH:mm:ss')
    };

    // 这里应该调用保存草稿API
    console.log('保存草稿:', draftData);

    message.success('草稿保存成功');
    emit('save-draft', draftData);
  } catch (error) {
    message.error('保存草稿失败');
  } finally {
    saving.value = false;
  }
};

// 重置表单
const handleReset = () => {
  formRef.value?.resetFields();
  Object.assign(formData, {
    leaveType: '',
    reasonCategory: '',
    startTime: null,
    endTime: null,
    duration: 0,
    description: '',
    attachments: [],
    emergencyContact: '',
    needsHandover: false,
    handoverInfo: ''
  });
};

onMounted(() => {
  loadLeaveTypes();
  loadLeaveBalances();

  // 如果有初始数据，填充表单
  if (props.initialData && Object.keys(props.initialData).length > 0) {
    Object.assign(formData, props.initialData);
  }
});
</script>

<style scoped lang="less">
.leave-application {
  .leave-type-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;

    .balance-info {
      color: #999;
      font-size: 12px;
    }
  }

  .upload-tip {
    color: #999;
    font-size: 12px;
    margin-top: 4px;
  }

  .balance-warning {
    .balance-details {
      margin-top: 16px;

      .negative {
        color: #ff4d4f;
        font-weight: 600;
      }
    }
  }
}
</style>
```

### 2. 异常处理组件

```vue
<!-- src/views/business/attendance/exception/processing/components/ExceptionAnalyzer.vue -->
<template>
  <div class="exception-analyzer">
    <div class="analyzer-header">
      <h3>异常分析器</h3>
      <div class="analyzer-actions">
        <a-button @click="refreshAnalysis">
          <template #icon><ReloadOutlined /></template>
          刷新分析
        </a-button>
        <a-button type="primary" @click="startAnalysis" :loading="analyzing">
          <template #icon><ThunderboltOutlined /></template>
          开始分析
        </a-button>
      </div>
    </div>

    <!-- 分析配置 -->
    <div class="analysis-config">
      <a-card title="分析配置" :bordered="false">
        <a-form layout="inline">
          <a-form-item label="分析周期">
            <a-range-picker
              v-model:value="analysisConfig.dateRange"
              :shortcuts="dateShortcuts"
            />
          </a-form-item>
          <a-form-item label="异常类型">
            <a-select
              v-model:value="analysisConfig.exceptionTypes"
              mode="multiple"
              placeholder="选择异常类型"
              style="width: 200px"
            >
              <a-select-option value="late">迟到</a-select-option>
              <a-select-option value="early">早退</a-select-option>
              <a-select-option value="absent">缺勤</a-select-option>
              <a-select-option value="forgot">忘打卡</a-select-option>
            </a-select>
          </a-form-item>
          <a-form-item label="部门范围">
            <a-tree-select
              v-model:value="analysisConfig.departments"
              :tree-data="departmentTree"
              placeholder="选择部门"
              multiple
              tree-checkable
              style="width: 200px"
            />
          </a-form-item>
        </a-form>
      </a-card>
    </div>

    <!-- 分析结果 -->
    <div class="analysis-results" v-if="analysisResults">
      <a-row :gutter="16">
        <a-col :span="6">
          <a-card title="异常总览" :bordered="false">
            <div class="overview-stats">
              <div class="stat-item">
                <div class="stat-number">{{ analysisResults.totalExceptions }}</div>
                <div class="stat-label">总异常数</div>
              </div>
              <div class="stat-item">
                <div class="stat-number">{{ analysisResults.affectedEmployees }}</div>
                <div class="stat-label">涉及员工</div>
              </div>
              <div class="stat-item">
                <div class="stat-number">{{ analysisResults.avgExceptionsPerEmployee }}</div>
                <div class="stat-label">人均异常</div>
              </div>
            </div>
          </a-card>
        </a-col>
        <a-col :span="12">
          <a-card title="异常趋势" :bordered="false">
            <ExceptionTrendChart :data="analysisResults.trendData" />
          </a-card>
        </a-col>
        <a-col :span="6">
          <a-card title="异常分布" :bordered="false">
            <ExceptionDistributionChart :data="analysisResults.distributionData" />
          </a-card>
        </a-col>
      </a-row>

      <!-- 详细分析 -->
      <a-card title="详细分析" :bordered="false" style="margin-top: 16px;">
        <a-tabs>
          <a-tab-pane key="patterns" tab="异常模式分析">
            <PatternAnalysis :patterns="analysisResults.patterns" />
          </a-tab-pane>
          <a-tab-pane key="causes" tab="原因分析">
            <CauseAnalysis :causes="analysisResults.causes" />
          </a-tab-pane>
          <a-tab-pane key="suggestions" tab="改进建议">
            <ImprovementSuggestions :suggestions="analysisResults.suggestions" />
          </a-tab-pane>
          <a-tab-pane key="predictions" tab="预测分析">
            <PredictionAnalysis :predictions="analysisResults.predictions" />
          </a-tab-pane>
        </a-tabs>
      </a-card>
    </div>

    <!-- 处理建议 -->
    <div class="processing-suggestions" v-if="analysisResults">
      <a-card title="处理建议" :bordered="false">
        <a-table
          :columns="suggestionColumns"
          :data-source="analysisResults.processingSuggestions"
          :pagination="false"
          size="small"
        >
          <template #bodyCell="{ column, record }">
            <template v-if="column.key === 'priority'">
              <a-tag :color="getPriorityColor(record.priority)">
                {{ getPriorityText(record.priority) }}
              </a-tag>
            </template>
            <template v-else-if="column.key === 'action'">
              <a-space>
                <a-button type="link" size="small" @click="handleApplySuggestion(record)">
                  应用建议
                </a-button>
                <a-button type="link" size="small" @click="handleViewDetail(record)">
                  查看详情
                </a-button>
              </a-space>
            </template>
          </template>
        </a-table>
      </a-card>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  ReloadOutlined,
  ThunderboltOutlined
} from '@ant-design/icons-vue';
import { processingApi } from '/@/api/business/attendance/exception/processing-api';
import dayjs from 'dayjs';
import ExceptionTrendChart from './ExceptionTrendChart.vue';
import ExceptionDistributionChart from './ExceptionDistributionChart.vue';
import PatternAnalysis from './PatternAnalysis.vue';
import CauseAnalysis from './CauseAnalysis.vue';
import ImprovementSuggestions from './ImprovementSuggestions.vue';
import PredictionAnalysis from './PredictionAnalysis.vue';

const emit = defineEmits(['analysis-complete', 'suggestion-applied']);

const analyzing = ref(false);
const analysisResults = ref(null);
const departmentTree = ref([]);

const analysisConfig = reactive({
  dateRange: [
    dayjs().subtract(30, 'day'),
    dayjs()
  ],
  exceptionTypes: ['late', 'early', 'absent', 'forgot'],
  departments: []
});

const dateShortcuts = [
  {
    text: '最近7天',
    value: () => [dayjs().subtract(7, 'day'), dayjs()],
  },
  {
    text: '最近30天',
    value: () => [dayjs().subtract(30, 'day'), dayjs()],
  },
  {
    text: '最近90天',
    value: () => [dayjs().subtract(90, 'day'), dayjs()],
  },
];

const suggestionColumns = [
  {
    title: '建议类型',
    dataIndex: 'type',
    key: 'type',
    width: 120,
  },
  {
    title: '优先级',
    dataIndex: 'priority',
    key: 'priority',
    width: 80,
  },
  {
    title: '建议内容',
    dataIndex: 'content',
    key: 'content',
  },
  {
    title: '预期效果',
    dataIndex: 'expectedEffect',
    key: 'expectedEffect',
    width: 150,
  },
  {
    title: '操作',
    key: 'action',
    width: 150,
  },
];

// 加载部门树
const loadDepartmentTree = async () => {
  try {
    const response = await processingApi.getDepartmentTree();
    departmentTree.value = response.data;
  } catch (error) {
    console.error('加载部门树失败:', error);
  }
};

// 开始分析
const startAnalysis = async () => {
  analyzing.value = true;
  try {
    const params = {
      ...analysisConfig,
      startDate: analysisConfig.dateRange[0].format('YYYY-MM-DD'),
      endDate: analysisConfig.dateRange[1].format('YYYY-MM-DD')
    };

    const response = await processingApi.analyzeExceptions(params);
    analysisResults.value = response.data;

    message.success('异常分析完成');
    emit('analysis-complete', response.data);
  } catch (error) {
    console.error('异常分析失败:', error);
    message.error('异常分析失败');
  } finally {
    analyzing.value = false;
  }
};

// 刷新分析
const refreshAnalysis = () => {
  if (analysisResults.value) {
    startAnalysis();
  } else {
    message.info('请先进行分析');
  }
};

// 获取优先级颜色
const getPriorityColor = (priority) => {
  const colorMap = {
    high: 'red',
    medium: 'orange',
    low: 'green'
  };
  return colorMap[priority] || 'default';
};

// 获取优先级文本
const getPriorityText = (priority) => {
  const textMap = {
    high: '高',
    medium: '中',
    low: '低'
  };
  return textMap[priority] || '未知';
};

// 应用建议
const handleApplySuggestion = (suggestion) => {
  // 应用处理建议
  emit('suggestion-applied', suggestion);
};

// 查看详情
const handleViewDetail = (suggestion) => {
  // 查看建议详情
  console.log('查看建议详情:', suggestion);
};

onMounted(() => {
  loadDepartmentTree();
});
</script>

<style scoped lang="less">
.exception-analyzer {
  .analyzer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;

    h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
  }

  .analysis-config {
    margin-bottom: 16px;
  }

  .analysis-results {
    .overview-stats {
      display: flex;
      justify-content: space-around;
      text-align: center;

      .stat-item {
        .stat-number {
          font-size: 24px;
          font-weight: 600;
          color: #1890ff;
          line-height: 1;
        }

        .stat-label {
          font-size: 12px;
          color: #666;
          margin-top: 4px;
        }
      }
    }
  }

  .processing-suggestions {
    margin-top: 16px;
  }
}
</style>
```

## Mock数据示例

```javascript
// src/mock/exception-mock.js
export const mockLeaveApplications = [
  {
    id: 'leave001',
    employeeId: 'emp001',
    employeeName: '张三',
    leaveType: 'annual',
    leaveTypeName: '年假',
    reasonCategory: 'personal',
    startTime: '2024-01-15 09:00:00',
    endTime: '2024-01-17 18:00:00',
    duration: 3,
    description: '个人事务处理，需要请假3天',
    status: 'pending',
    attachments: [],
    emergencyContact: '李四 13800138001',
    needsHandover: true,
    handoverInfo: '工作已交接给王五'
  }
];

export const mockOvertimeApplications = [
  {
    id: 'overtime001',
    employeeId: 'emp002',
    employeeName: '李四',
    startTime: '2024-01-15 18:00:00',
    endTime: '2024-01-15 22:00:00',
    duration: 4,
    reason: '项目紧急，需要加班完成',
    status: 'approved',
    approverId: 'manager001',
    approverName: '王经理',
    approveTime: '2024-01-15 10:00:00'
  }
];

export const mockExceptionAnalysis = {
  totalExceptions: 125,
  affectedEmployees: 45,
  avgExceptionsPerEmployee: 2.8,
  trendData: [
    { date: '2024-01-01', count: 12 },
    { date: '2024-01-02', count: 15 },
    { date: '2024-01-03', count: 8 }
  ],
  distributionData: [
    { type: '迟到', count: 45, percentage: 36 },
    { type: '早退', count: 30, percentage: 24 },
    { type: '缺勤', count: 25, percentage: 20 },
    { type: '忘打卡', count: 25, percentage: 20 }
  ],
  patterns: [
    {
      pattern: '周一迟到现象严重',
      frequency: '高频',
      description: '周一早上迟到率比其他工作日高30%'
    }
  ],
  causes: [
    {
      cause: '交通拥堵',
      impact: '高',
      percentage: 40,
      description: '早高峰交通拥堵是主要原因'
    }
  ],
  suggestions: [
    {
      type: '制度调整',
      priority: 'high',
      content: '建议调整弹性工作时间，避免高峰期',
      expectedEffect: '预计减少迟到率20%'
    }
  ]
};

export default {
  mockLeaveApplications,
  mockOvertimeApplications,
  mockExceptionAnalysis
};
```

## 开发注意事项总结

### 核心功能要点
1. **申请流程** - 完整的异常申请和审批流程
2. **类型管理** - 灵活的异常类型配置
3. **余额管理** - 准确的假期余额计算和控制
4. **智能分析** - 异常数据的深度分析和预测
5. **流程自动化** - 自动化的审批和处理流程
6. **通知机制** - 及时的事务通知和提醒

### 性能优化建议
1. 异常数据分页加载
2. 分析结果缓存机制
3. 文件上传异步处理
4. 审批流程状态实时更新

### 用户体验优化
1. 简化的申请表单
2. 智能的表单验证
3. 实时的余额提示
4. 移动端友好的界面

## 总结

异常管理模块作为考勤系统的异常处理核心，需要重点关注：

- 申请流程的便捷性和规范性
- 审批流程的效率和透明度
- 数据分析的准确性和深度
- 余额管理的精确性和实时性
- 用户体验的友好性和一致性

通过遵循本文档的技术规范，可以构建出功能完善、流程清晰的异常管理模块。