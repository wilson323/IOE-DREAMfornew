# 行为分析页面功能与布局文档

## 页面概述
行为分析页面是智能视频监控系统的核心智能检测配置界面,用于配置和管理各类智能行为分析功能。该页面基于SmartAdmin前端框架构建,采用Vue3 + Ant Design Vue技术栈,支持多种行为检测类型(入侵检测、越线检测、徘徊检测、物品遗留/移走、快速移动、电瓶车检测等),提供可视化区域绘制、检测参数配置、声光告警设置、时间计划管理等完整的智能分析配置功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **Canvas绘图**: HTML5 Canvas API

### 智能分析算法集成方案

#### 方案一: WebSocket实时推送
**优势**:
- 实时性强,延迟低(10-100ms)
- 双向通信,支持远程控制
- 自动断线重连
- 适合实时监控场景

**技术实现**:
```javascript
// 建立WebSocket连接
const ws = new WebSocket('ws://localhost:8080/behavioral-analysis');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'intrusion_detected') {
    handleIntrusionAlarm(data.payload);
  }
};
```

#### 方案二: HTTP轮询
**优势**:
- 实现简单,兼容性好
- 无需特殊服务器配置
- 适合告警查询场景

**技术实现**:
```javascript
// 定时轮询检测结果
setInterval(async () => {
  const result = await axios.get('/api/behavior/detection/latest');
  updateDetectionResults(result.data);
}, 5000);
```

### 项目文件组织结构
```
src/views/business/smart-video/
├── behavioral-analysis.vue           # 行为分析主页面
├── components/
│   ├── DeviceTreeSelector.vue       # 设备树选择组件
│   ├── VideoDrawingCanvas.vue       # 视频画线组件
│   ├── DetectionRuleConfig.vue      # 检测规则配置组件
│   ├── AreaManagement.vue           # 检测区域管理组件
│   ├── TimePlanConfig.vue           # 时间计划配置组件
│   ├── AudioLightAlarm.vue          # 声光告警配置组件
│   └── DetectionResultView.vue      # 检测结果展示组件
├── mock/
│   └── behavior-mock-data.js        # 模拟数据
├── api/
│   └── behavior-api.js              # API接口定义
└── utils/
    ├── canvas-drawing-tool.js       # Canvas绘图工具
    └── polygon-helper.js            # 多边形处理工具
```

### API接口设计
```javascript
// src/api/business/smart-video/behavior-api.js
import { postRequest, getRequest, putRequest } from '/@/lib/axios';

export const behaviorApi = {
  // 获取全局配置
  getGlobalConfig: (deviceId) =>
    getRequest(`/behavior/config/global/${deviceId}`),

  // 保存全局配置
  saveGlobalConfig: (params) =>
    postRequest('/behavior/config/global/save', params),

  // 获取检测规则配置
  getDetectionRule: (deviceId, ruleType) =>
    getRequest(`/behavior/rule/${deviceId}/${ruleType}`),

  // 保存检测规则配置
  saveDetectionRule: (params) =>
    postRequest('/behavior/rule/save', params),

  // 获取检测区域列表
  getDetectionAreas: (deviceId, ruleType) =>
    getRequest(`/behavior/area/list/${deviceId}/${ruleType}`),

  // 保存检测区域
  saveDetectionArea: (params) =>
    postRequest('/behavior/area/save', params),

  // 删除检测区域
  deleteDetectionArea: (areaId) =>
    postRequest(`/behavior/area/delete/${areaId}`),

  // 获取视频流地址(用于画线)
  getVideoStreamForDrawing: (deviceId) =>
    getRequest(`/behavior/video/stream/${deviceId}`),

  // 保存区域坐标
  saveAreaCoordinates: (params) =>
    postRequest('/behavior/area/coordinates/save', params),

  // 获取时间计划列表
  getTimePlans: (deviceId, ruleType) =>
    getRequest(`/behavior/timeplan/list/${deviceId}/${ruleType}`),

  // 保存时间计划
  saveTimePlan: (params) =>
    postRequest('/behavior/timeplan/save', params),

  // 删除时间计划
  deleteTimePlan: (planId) =>
    postRequest(`/behavior/timeplan/delete/${planId}`),

  // 获取声光告警配置
  getAlarmConfig: (deviceId, ruleType) =>
    getRequest(`/behavior/alarm/config/${deviceId}/${ruleType}`),

  // 保存声光告警配置
  saveAlarmConfig: (params) =>
    postRequest('/behavior/alarm/config/save', params),

  // 获取检测结果(最近N条)
  getDetectionResults: (params) =>
    getRequest('/behavior/detection/results', params),

  // 获取检测统计
  getDetectionStatistics: (params) =>
    getRequest('/behavior/detection/statistics', params),

  // 获取音频文件列表
  getAudioFileList: () =>
    getRequest('/behavior/audio/list'),

  // 上传音频文件
  uploadAudioFile: (file) =>
    postRequest('/behavior/audio/upload', file, {
      headers: { 'Content-Type': 'multipart/form-data' }
    }),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="视频画线">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="视频画线"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { DrawPolygonOutlined } from '@ant-design/icons-vue';  // ❌ 不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  VideoCameraOutlined,     // ✅ 摄像机
  DesktopOutlined,         // ✅ 设备/桌面
  AimOutlined,             // ✅ 瞄准/区域
  BorderOutlined,          // ✅ 边框/区域
  LineOutlined,            // ✅ 线条
  RadiusSettingOutlined,   // ✅ 区域设置
  SoundOutlined,           // ✅ 声音
  BulbOutlined,            // ✅ 灯光
  ClockCircleOutlined,     // ✅ 时钟/时间计划
  SettingOutlined,         // ✅ 设置
  PlusOutlined,            // ✅ 新增
  DeleteOutlined,          // ✅ 删除
  EditOutlined,            // ✅ 编辑
  SaveOutlined,            // ✅ 保存
  ReloadOutlined,          // ✅ 刷新
  WarningOutlined,         // ✅ 告警
  BellOutlined,            // ✅ 铃铛/告警
  EyeOutlined,             // ✅ 查看
  CheckCircleOutlined,     // ✅ 在线/启用
  CloseCircleOutlined,     // ✅ 离线/禁用
  FolderOpenOutlined,      // ✅ 文件夹
  FileOutlined,            // ✅ 文件
  CarOutlined,             // ✅ 车辆
  UserOutlined,            // ✅ 行人
  ThunderboltOutlined,     // ✅ 快速移动
  ApiOutlined,             // ✅ 徘徊
  InboxOutlined,           // ✅ 物品
  ShoppingOutlined,        // ✅ 购物/拿取
  DashboardOutlined,       // ✅ 仪表盘/统计
} from '@ant-design/icons-vue';
</script>
```

### 3. Canvas绘图注意事项

#### ❌ 错误：未正确处理Canvas尺寸
```javascript
// 错误：未考虑设备像素比，导致画布模糊
const canvas = document.getElementById('canvas');
canvas.width = 800;
canvas.height = 600;
```

#### ✅ 正确：处理设备像素比
```javascript
// 正确：考虑设备像素比，保证清晰度
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const dpr = window.devicePixelRatio || 1;

// 设置显示大小
canvas.style.width = '800px';
canvas.style.height = '600px';

// 设置实际像素大小
canvas.width = 800 * dpr;
canvas.height = 600 * dpr;

// 缩放绘图上下文
ctx.scale(dpr, dpr);
```

### 4. 多边形区域绘制注意事项

#### ✅ 正确的多边形绘制流程
```javascript
let drawingPoints = [];
let isDrawing = false;

// 开始绘制
const startDrawing = () => {
  isDrawing = true;
  drawingPoints = [];
};

// 添加点击点
const addPoint = (x, y) => {
  if (!isDrawing) return;

  drawingPoints.push({ x, y });
  redrawCanvas();
};

// 完成绘制(双击或右键)
const finishDrawing = () => {
  if (drawingPoints.length < 3) {
    message.warning('多边形至少需要3个点');
    return;
  }

  // 保存区域
  savePolygonArea(drawingPoints);

  // 重置状态
  isDrawing = false;
  drawingPoints = [];
};

// 重绘画布
const redrawCanvas = () => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 绘制已有区域
  existingAreas.forEach(area => {
    drawPolygon(ctx, area.points, '#1890ff', 0.3);
  });

  // 绘制当前正在画的区域
  if (drawingPoints.length > 0) {
    drawPolygon(ctx, drawingPoints, '#52c41a', 0.5, true);
  }
};

// 绘制多边形
const drawPolygon = (ctx, points, color, alpha, isDrawing = false) => {
  if (points.length < 2) return;

  ctx.save();

  // 绘制多边形
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) {
    ctx.lineTo(points[i].x, points[i].y);
  }
  if (!isDrawing) {
    ctx.closePath();
  }

  // 填充
  ctx.fillStyle = color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
  ctx.fill();

  // 描边
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.stroke();

  // 绘制顶点
  points.forEach((point, index) => {
    ctx.beginPath();
    ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();

    // 绘制顶点编号
    ctx.fillStyle = color;
    ctx.font = '12px Arial';
    ctx.fillText(index + 1, point.x + 8, point.y - 8);
  });

  ctx.restore();
};
```

### 5. 检测区域坐标归一化

#### ✅ 坐标归一化处理
```javascript
// 将像素坐标转换为归一化坐标(0-1)
const normalizeCoordinates = (points, canvasWidth, canvasHeight) => {
  return points.map(point => ({
    x: point.x / canvasWidth,
    y: point.y / canvasHeight,
  }));
};

// 将归一化坐标转换为像素坐标
const denormalizeCoordinates = (normalizedPoints, canvasWidth, canvasHeight) => {
  return normalizedPoints.map(point => ({
    x: point.x * canvasWidth,
    y: point.y * canvasHeight,
  }));
};

// 保存区域时使用归一化坐标
const savePolygonArea = (pixelPoints) => {
  const canvas = document.getElementById('canvas');
  const normalizedPoints = normalizeCoordinates(
    pixelPoints,
    canvas.width,
    canvas.height
  );

  // 保存到后端
  behaviorApi.saveAreaCoordinates({
    points: normalizedPoints,
    // ...其他参数
  });
};
```

## 核心功能模块

### 1. 设备树选择面板
**位置**: 页面左侧固定面板
**宽度**: 280px

**功能说明**:
- 树形结构展示设备列表
- 支持按区域/类型分组
- 显示设备在线状态
- 支持设备搜索
- 单选设备进行配置

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/DeviceTreeSelector.vue -->
<template>
  <div class="device-tree-selector">
    <div class="panel-header">
      <DesktopOutlined />
      <span>设备列表</span>
    </div>

    <!-- 搜索框 -->
    <div class="search-box">
      <a-input
        v-model:value="searchKeyword"
        placeholder="搜索设备..."
        allow-clear
      >
        <template #prefix>
          <SearchOutlined />
        </template>
      </a-input>
    </div>

    <!-- 设备树 -->
    <div class="tree-container">
      <a-tree
        v-model:expanded-keys="expandedKeys"
        v-model:selected-keys="selectedKeys"
        :tree-data="filteredTreeData"
        :field-names="{ children: 'children', title: 'name', key: 'id' }"
        @select="handleSelect"
      >
        <template #title="{ name, status, deviceType }">
          <div class="tree-node-title">
            <component
              :is="getDeviceIcon(deviceType)"
              :style="{ color: getStatusColor(status) }"
            />
            <span>{{ name }}</span>
            <a-tag
              v-if="status"
              :color="status === 'online' ? 'success' : 'error'"
              size="small"
            >
              {{ status === 'online' ? '在线' : '离线' }}
            </a-tag>
          </div>
        </template>
      </a-tree>
    </div>

    <!-- 设备信息 -->
    <div v-if="selectedDevice" class="device-info">
      <a-divider style="margin: 12px 0;" />
      <div class="info-title">当前选中设备</div>
      <div class="info-content">
        <div class="info-item">
          <span class="label">设备名称:</span>
          <span class="value">{{ selectedDevice.name }}</span>
        </div>
        <div class="info-item">
          <span class="label">设备编码:</span>
          <span class="value">{{ selectedDevice.code }}</span>
        </div>
        <div class="info-item">
          <span class="label">设备状态:</span>
          <a-tag
            :color="selectedDevice.status === 'online' ? 'success' : 'error'"
          >
            {{ selectedDevice.status === 'online' ? '在线' : '离线' }}
          </a-tag>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue';
import {
  DesktopOutlined,
  SearchOutlined,
  VideoCameraOutlined,
  FolderOpenOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  deviceList: {
    type: Array,
    default: () => [],
  },
});

const emit = defineEmits(['device-select']);

const searchKeyword = ref('');
const expandedKeys = ref([]);
const selectedKeys = ref([]);
const selectedDevice = ref(null);

// 过滤树数据
const filteredTreeData = computed(() => {
  if (!searchKeyword.value) {
    return props.deviceList;
  }

  const filterTree = (nodes) => {
    return nodes.filter(node => {
      if (node.children) {
        const filteredChildren = filterTree(node.children);
        if (filteredChildren.length > 0) {
          return {
            ...node,
            children: filteredChildren,
          };
        }
      }
      return node.name.toLowerCase().includes(searchKeyword.value.toLowerCase());
    }).map(node => {
      if (node.children) {
        return {
          ...node,
          children: filterTree(node.children),
        };
      }
      return node;
    });
  };

  return filterTree(props.deviceList);
});

// 获取设备图标
const getDeviceIcon = (deviceType) => {
  const iconMap = {
    camera: VideoCameraOutlined,
    nvr: DesktopOutlined,
    folder: FolderOpenOutlined,
  };
  return iconMap[deviceType] || VideoCameraOutlined;
};

// 获取状态颜色
const getStatusColor = (status) => {
  return status === 'online' ? '#52c41a' : '#ff4d4f';
};

// 处理选择
const handleSelect = (selectedKeysValue, e) => {
  if (e.selected && e.node) {
    selectedDevice.value = {
      id: e.node.id,
      name: e.node.name,
      code: e.node.code,
      status: e.node.status,
      deviceType: e.node.deviceType,
    };
    emit('device-select', selectedDevice.value);
  }
};

// 监听搜索关键词变化，自动展开匹配节点
watch(searchKeyword, (newVal) => {
  if (newVal) {
    expandedKeys.value = getAllKeys(filteredTreeData.value);
  }
});

// 获取所有key
const getAllKeys = (nodes) => {
  const keys = [];
  const traverse = (items) => {
    items.forEach(item => {
      keys.push(item.id);
      if (item.children) {
        traverse(item.children);
      }
    });
  };
  traverse(nodes);
  return keys;
};
</script>

<style scoped lang="less">
.device-tree-selector {
  width: 280px;
  height: 100%;
  background: #fff;
  border-right: 1px solid #f0f0f0;
  display: flex;
  flex-direction: column;

  .panel-header {
    padding: 16px;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid #f0f0f0;
  }

  .search-box {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
  }

  .tree-container {
    flex: 1;
    overflow-y: auto;
    padding: 12px;

    .tree-node-title {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;

      span {
        flex: 1;
      }
    }
  }

  .device-info {
    padding: 12px 16px;
    background: #fafafa;

    .info-title {
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
    }

    .info-content {
      .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 13px;

        .label {
          color: #666;
          min-width: 70px;
        }

        .value {
          flex: 1;
          color: #333;
        }
      }
    }
  }
}
</style>
```

### 2. 检测类型Tab页签
**位置**: 主内容区域顶部

**支持的检测类型**:
- 全局配置: 基础参数、灵敏度、目标尺寸等
- 入侵检测: 区域入侵检测
- 越线检测: 虚拟警戒线检测(支持方向)
- 区域进入: 进入指定区域检测
- 区域离开: 离开指定区域检测
- 遗留检测: 物品遗留检测
- 移走检测: 物品移走检测
- 徘徊检测: 人员徘徊检测
- 快速移动: 快速移动检测
- 电瓶车检测: 电瓶车违规检测

**技术实现**:
```vue
<!-- Tab切换部分 -->
<template>
  <div class="detection-tabs">
    <a-tabs v-model:active-key="activeTab" @change="handleTabChange">
      <a-tab-pane key="global" tab="全局配置">
        <template #tab>
          <SettingOutlined />
          <span>全局配置</span>
        </template>
        <GlobalConfig :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="intrusion" tab="入侵检测">
        <template #tab>
          <BorderOutlined />
          <span>入侵检测</span>
        </template>
        <IntrusionDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="lineCrossing" tab="越线检测">
        <template #tab>
          <LineOutlined />
          <span>越线检测</span>
        </template>
        <LineCrossingDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="areaEnter" tab="区域进入">
        <template #tab>
          <LoginOutlined />
          <span>区域进入</span>
        </template>
        <AreaEnterDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="areaExit" tab="区域离开">
        <template #tab>
          <LogoutOutlined />
          <span>区域离开</span>
        </template>
        <AreaExitDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="itemLeave" tab="遗留检测">
        <template #tab>
          <InboxOutlined />
          <span>遗留检测</span>
        </template>
        <ItemLeaveDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="itemMove" tab="移走检测">
        <template #tab>
          <ShoppingOutlined />
          <span>移走检测</span>
        </template>
        <ItemMoveDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="loitering" tab="徘徊检测">
        <template #tab>
          <ApiOutlined />
          <span>徘徊检测</span>
        </template>
        <LoiteringDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="fastMove" tab="快速移动">
        <template #tab>
          <ThunderboltOutlined />
          <span>快速移动</span>
        </template>
        <FastMoveDetection :device-id="currentDeviceId" />
      </a-tab-pane>

      <a-tab-pane key="electroMobile" tab="电瓶车检测">
        <template #tab>
          <CarOutlined />
          <span>电瓶车检测</span>
        </template>
        <ElectroMobileDetection :device-id="currentDeviceId" />
      </a-tab-pane>
    </a-tabs>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import {
  SettingOutlined,
  BorderOutlined,
  LineOutlined,
  LoginOutlined,
  LogoutOutlined,
  InboxOutlined,
  ShoppingOutlined,
  ApiOutlined,
  ThunderboltOutlined,
  CarOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  deviceId: {
    type: String,
    required: true,
  },
});

const activeTab = ref('global');
const currentDeviceId = ref(props.deviceId);

const handleTabChange = (key) => {
  console.log('切换到Tab:', key);
};
</script>
```

### 3. 全局配置组件
**功能说明**:
- 启用/禁用行为分析
- 发送元数据开关
- 周界增强开关
- 告警抑制开关
- 阴影移除模式
- 检测灵敏度
- 背景更新速率
- 最小/最大目标尺寸

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/GlobalConfig.vue -->
<template>
  <div class="global-config">
    <a-spin :spinning="loading">
      <a-form
        ref="formRef"
        :model="formState"
        :label-col="{ span: 6 }"
        :wrapper-col="{ span: 18 }"
      >
        <!-- 启用行为分析 -->
        <a-form-item label="启用行为分析" name="enable">
          <a-switch
            v-model:checked="formState.enable"
            checked-children="启用"
            un-checked-children="禁用"
          />
        </a-form-item>

        <!-- 发送元数据 -->
        <a-form-item label="发送元数据" name="sendMetadataSwitch">
          <a-switch
            v-model:checked="formState.sendMetadataSwitch"
            checked-children="启用"
            un-checked-children="禁用"
          />
        </a-form-item>

        <!-- 周界增强 -->
        <a-form-item label="周界增强" name="perimeterEnhanceSwitch">
          <a-switch
            v-model:checked="formState.perimeterEnhanceSwitch"
            checked-children="启用"
            un-checked-children="禁用"
          />
          <div class="form-tip">
            启用后可提高周界检测的准确度
          </div>
        </a-form-item>

        <!-- 告警抑制 -->
        <a-form-item label="告警抑制" name="alertInhibitionSwitch">
          <a-switch
            v-model:checked="formState.alertInhibitionSwitch"
            checked-children="启用"
            un-checked-children="禁用"
          />
          <div class="form-tip">
            启用后可减少误报告警
          </div>
        </a-form-item>

        <!-- 阴影移除模式 -->
        <a-form-item label="阴影移除模式" name="shadowRemovalMode">
          <a-select v-model:value="formState.shadowRemovalMode">
            <a-select-option value="WeakShadow">弱阴影</a-select-option>
            <a-select-option value="NormalShadow">普通阴影</a-select-option>
            <a-select-option value="StrongShadow">强阴影</a-select-option>
          </a-select>
        </a-form-item>

        <!-- 检测灵敏度 -->
        <a-form-item label="检测灵敏度" name="detectionSensitivity">
          <a-select v-model:value="formState.detectionSensitivity">
            <a-select-option value="LowestSensitivity">最低灵敏度</a-select-option>
            <a-select-option value="LowerSensitivity">较低灵敏度</a-select-option>
            <a-select-option value="LowSensitivity">低灵敏度</a-select-option>
            <a-select-option value="MiddleSensitivity">中灵敏度</a-select-option>
            <a-select-option value="HighSensitivity">高灵敏度</a-select-option>
          </a-select>
        </a-form-item>

        <!-- 背景更新速率 -->
        <a-form-item label="背景更新速率" name="backgroundUpdateRate">
          <a-select v-model:value="formState.backgroundUpdateRate">
            <a-select-option value="Low">慢</a-select-option>
            <a-select-option value="Middle">中</a-select-option>
            <a-select-option value="High">快</a-select-option>
          </a-select>
        </a-form-item>

        <!-- 最小目标尺寸 -->
        <a-form-item label="最小目标尺寸">
          <a-space>
            <a-input-number
              v-model:value="formState.minTargetSizeWidth"
              :min="5"
              :max="200"
              addon-before="宽"
              addon-after="像素"
            />
            <a-input-number
              v-model:value="formState.minTargetSizeHeight"
              :min="5"
              :max="200"
              addon-before="高"
              addon-after="像素"
            />
          </a-space>
        </a-form-item>

        <!-- 最大目标尺寸 -->
        <a-form-item label="最大目标尺寸">
          <a-space>
            <a-input-number
              v-model:value="formState.maxTargetSizeWidth"
              :min="5"
              :max="1000"
              addon-before="宽"
              addon-after="像素"
            />
            <a-input-number
              v-model:value="formState.maxTargetSizeHeight"
              :min="5"
              :max="1000"
              addon-before="高"
              addon-after="像素"
            />
          </a-space>
        </a-form-item>

        <!-- 操作按钮 -->
        <a-form-item :wrapper-col="{ offset: 6, span: 18 }">
          <a-space>
            <a-button type="primary" @click="handleSave">
              <template #icon><SaveOutlined /></template>
              保存配置
            </a-button>
            <a-button @click="handleReset">
              <template #icon><ReloadOutlined /></template>
              重置
            </a-button>
          </a-space>
        </a-form-item>
      </a-form>
    </a-spin>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import { SaveOutlined, ReloadOutlined } from '@ant-design/icons-vue';
import { behaviorApi } from '/@/api/business/smart-video/behavior-api';

const props = defineProps({
  deviceId: {
    type: String,
    required: true,
  },
});

const formRef = ref(null);
const loading = ref(false);

const formState = reactive({
  enable: true,
  sendMetadataSwitch: false,
  perimeterEnhanceSwitch: false,
  alertInhibitionSwitch: false,
  shadowRemovalMode: 'NormalShadow',
  detectionSensitivity: 'MiddleSensitivity',
  backgroundUpdateRate: 'Middle',
  minTargetSizeWidth: 5,
  minTargetSizeHeight: 5,
  maxTargetSizeWidth: 200,
  maxTargetSizeHeight: 200,
});

onMounted(() => {
  loadConfig();
});

// 加载配置
const loadConfig = async () => {
  try {
    loading.value = true;
    const res = await behaviorApi.getGlobalConfig(props.deviceId);
    if (res.data) {
      Object.assign(formState, res.data);
    }
  } catch (error) {
    console.error('加载配置失败:', error);
    message.error('加载配置失败');
  } finally {
    loading.value = false;
  }
};

// 保存配置
const handleSave = async () => {
  try {
    loading.value = true;
    await behaviorApi.saveGlobalConfig({
      deviceId: props.deviceId,
      ...formState,
    });
    message.success('保存成功');
  } catch (error) {
    console.error('保存失败:', error);
    message.error('保存失败');
  } finally {
    loading.value = false;
  }
};

// 重置
const handleReset = () => {
  loadConfig();
  message.info('已重置为初始配置');
};
</script>

<style scoped lang="less">
.global-config {
  padding: 24px;
  background: #fff;

  .form-tip {
    font-size: 12px;
    color: #999;
    margin-top: 4px;
  }
}
</style>
```

### 4. 检测规则配置组件(以入侵检测为例)
**功能说明**:
- 检测目标类型选择(行人/车辆/非机动车)
- 告警检测间隔
- 识别模式(中心点/底部/顶部)
- 灵敏度设置
- 容忍时间(部分检测类型)

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/IntrusionDetection.vue -->
<template>
  <div class="intrusion-detection">
    <a-row :gutter="24">
      <!-- 左侧配置区 -->
      <a-col :span="14">
        <a-card title="检测参数配置" :bordered="false">
          <a-form
            ref="formRef"
            :model="formState"
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
          >
            <!-- 检测目标类型 -->
            <a-form-item label="检测目标类型" name="detectType">
              <a-checkbox-group v-model:value="formState.detectType">
                <a-checkbox value="Pedestrian">
                  <UserOutlined />
                  行人
                </a-checkbox>
                <a-checkbox value="Vehicle">
                  <CarOutlined />
                  车辆
                </a-checkbox>
                <a-checkbox value="NonVehicle">
                  <CarOutlined />
                  非机动车
                </a-checkbox>
              </a-checkbox-group>
            </a-form-item>

            <!-- 告警检测间隔 -->
            <a-form-item label="告警检测间隔" name="alarmInterval">
              <a-input-number
                v-model:value="formState.alarmInterval"
                :min="1"
                :max="256"
                addon-after="秒"
                style="width: 200px;"
              />
            </a-form-item>

            <!-- 识别模式 -->
            <a-form-item label="识别模式" name="recognizeMode">
              <a-select v-model:value="formState.recognizeMode" style="width: 200px;">
                <a-select-option value="Center">中心点</a-select-option>
                <a-select-option value="Bottom">底部点</a-select-option>
                <a-select-option value="Top">顶部点</a-select-option>
              </a-select>
            </a-form-item>

            <!-- 灵敏度 -->
            <a-form-item label="灵敏度" name="sensitivity">
              <a-slider
                v-model:value="formState.sensitivity"
                :min="1"
                :max="100"
                :marks="{ 1: '1', 50: '50', 100: '100' }"
                style="width: 300px;"
              />
            </a-form-item>

            <!-- 容忍时间(遗留检测/徘徊检测专用) -->
            <a-form-item
              v-if="showToleranceTime"
              label="容忍时间"
              name="toleranceTime"
            >
              <a-input-number
                v-model:value="formState.toleranceTime"
                :min="1"
                :max="180"
                addon-after="秒"
                style="width: 200px;"
              />
            </a-form-item>
          </a-form>
        </a-card>

        <!-- 声光告警配置 -->
        <a-card title="声光告警配置" :bordered="false" style="margin-top: 16px;">
          <AudioLightAlarm
            v-model:audio-enable="formState.audioEnable"
            v-model:audio-file="formState.audioFile"
            v-model:audio-count="formState.audioCount"
            v-model:light-enable="formState.lightEnable"
            v-model:light-frequency="formState.whiteLightIlluminator"
            v-model:light-duration="formState.lightCount"
          />
        </a-card>

        <!-- 检测区域设置 -->
        <a-card title="检测区域设置" :bordered="false" style="margin-top: 16px;">
          <div class="area-actions">
            <a-button type="primary" @click="handleOpenDrawing">
              <template #icon><AimOutlined /></template>
              视频画线
            </a-button>
            <a-button @click="handleAddArea">
              <template #icon><PlusOutlined /></template>
              添加区域
            </a-button>
          </div>

          <!-- 区域列表 -->
          <a-table
            :columns="areaColumns"
            :data-source="areaList"
            :pagination="false"
            style="margin-top: 16px;"
          >
            <template #bodyCell="{ column, record, index }">
              <template v-if="column.key === 'index'">
                {{ index + 1 }}
              </template>
              <template v-else-if="column.key === 'enable'">
                <a-switch
                  v-model:checked="record.enable"
                  size="small"
                  @change="handleAreaEnableChange(record)"
                />
              </template>
              <template v-else-if="column.key === 'action'">
                <a-space>
                  <a-button
                    type="link"
                    size="small"
                    @click="handleEditArea(record)"
                  >
                    <EditOutlined />
                    编辑
                  </a-button>
                  <a-popconfirm
                    title="确定删除该区域吗？"
                    @confirm="handleDeleteArea(record)"
                  >
                    <a-button type="link" danger size="small">
                      <DeleteOutlined />
                      删除
                    </a-button>
                  </a-popconfirm>
                </a-space>
              </template>
            </template>
          </a-table>
        </a-card>

        <!-- 时间计划设置 -->
        <a-card title="时间计划设置" :bordered="false" style="margin-top: 16px;">
          <TimePlanConfig
            v-model:plans="formState.timePlans"
            @add="handleAddTimePlan"
            @delete="handleDeleteTimePlan"
          />
        </a-card>

        <!-- 操作按钮 -->
        <div class="action-buttons">
          <a-space>
            <a-button type="primary" size="large" @click="handleSave">
              <template #icon><SaveOutlined /></template>
              保存配置
            </a-button>
            <a-button size="large" @click="handleReset">
              <template #icon><ReloadOutlined /></template>
              重置
            </a-button>
          </a-space>
        </div>
      </a-col>

      <!-- 右侧视频预览 -->
      <a-col :span="10">
        <a-card title="视频预览" :bordered="false">
          <div class="video-preview">
            <video
              ref="videoRef"
              class="preview-video"
              autoplay
              muted
            >
              <source :src="videoStreamUrl" type="video/mp4">
            </video>

            <!-- 在视频上方显示已绘制的区域 -->
            <canvas
              ref="canvasRef"
              class="preview-canvas"
              @click="handleCanvasClick"
            ></canvas>
          </div>

          <!-- 联动配置 -->
          <a-divider />
          <div class="linkage-config">
            <div class="config-title">联动配置</div>
            <a-checkbox-group v-model:value="formState.linkageTypes">
              <a-checkbox value="email">邮件联动</a-checkbox>
              <a-checkbox value="sound">声音报警</a-checkbox>
              <a-checkbox value="monitor">监控联动</a-checkbox>
              <a-checkbox value="upload">上传中心</a-checkbox>
            </a-checkbox-group>
          </div>
        </a-card>
      </a-col>
    </a-row>

    <!-- 视频画线弹窗 -->
    <VideoDrawingModal
      v-model:visible="drawingModalVisible"
      :device-id="deviceId"
      :existing-areas="areaList"
      @save="handleSaveAreas"
    />
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  UserOutlined,
  CarOutlined,
  AimOutlined,
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  SaveOutlined,
  ReloadOutlined,
} from '@ant-design/icons-vue';
import AudioLightAlarm from './AudioLightAlarm.vue';
import TimePlanConfig from './TimePlanConfig.vue';
import VideoDrawingModal from './VideoDrawingModal.vue';
import { behaviorApi } from '/@/api/business/smart-video/behavior-api';

const props = defineProps({
  deviceId: {
    type: String,
    required: true,
  },
  ruleType: {
    type: String,
    default: 'intrusion',
  },
});

const formRef = ref(null);
const videoRef = ref(null);
const canvasRef = ref(null);
const drawingModalVisible = ref(false);

const formState = reactive({
  detectType: ['Pedestrian'],
  alarmInterval: 1,
  recognizeMode: 'Center',
  sensitivity: 50,
  toleranceTime: 5,
  audioEnable: false,
  audioFile: '',
  audioCount: 1,
  lightEnable: false,
  whiteLightIlluminator: 'Medium',
  lightCount: 5,
  timePlans: [],
  linkageTypes: [],
});

const areaList = ref([]);
const videoStreamUrl = ref('');

// 区域表格列定义
const areaColumns = [
  {
    title: '序号',
    key: 'index',
    width: 60,
    align: 'center',
  },
  {
    title: '区域名称',
    dataIndex: 'name',
    key: 'name',
  },
  {
    title: '启用状态',
    key: 'enable',
    width: 100,
    align: 'center',
  },
  {
    title: '操作',
    key: 'action',
    width: 150,
    align: 'center',
  },
];

// 是否显示容忍时间(遗留检测和徘徊检测需要)
const showToleranceTime = computed(() => {
  return ['itemLeave', 'loitering'].includes(props.ruleType);
});

onMounted(() => {
  loadConfig();
  loadAreas();
  initVideoPreview();
});

// 加载配置
const loadConfig = async () => {
  try {
    const res = await behaviorApi.getDetectionRule(
      props.deviceId,
      props.ruleType
    );
    if (res.data) {
      Object.assign(formState, res.data);
    }
  } catch (error) {
    console.error('加载配置失败:', error);
  }
};

// 加载区域列表
const loadAreas = async () => {
  try {
    const res = await behaviorApi.getDetectionAreas(
      props.deviceId,
      props.ruleType
    );
    if (res.data) {
      areaList.value = res.data;
      redrawCanvas();
    }
  } catch (error) {
    console.error('加载区域失败:', error);
  }
};

// 初始化视频预览
const initVideoPreview = async () => {
  try {
    const res = await behaviorApi.getVideoStreamForDrawing(props.deviceId);
    if (res.data && res.data.streamUrl) {
      videoStreamUrl.value = res.data.streamUrl;
    }
  } catch (error) {
    console.error('加载视频流失败:', error);
  }
};

// 监听视频加载完成，初始化canvas
watch(videoRef, (video) => {
  if (video) {
    video.onloadedmetadata = () => {
      const canvas = canvasRef.value;
      if (canvas) {
        canvas.width = video.videoWidth || 800;
        canvas.height = video.videoHeight || 600;
        redrawCanvas();
      }
    };
  }
});

// 重绘canvas上的区域
const redrawCanvas = () => {
  const canvas = canvasRef.value;
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 绘制所有区域
  areaList.value.forEach((area, index) => {
    if (!area.points || area.points.length < 2) return;

    // 将归一化坐标转换为像素坐标
    const pixelPoints = area.points.map(point => ({
      x: point.x * canvas.width,
      y: point.y * canvas.height,
    }));

    // 绘制多边形
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(pixelPoints[0].x, pixelPoints[0].y);
    for (let i = 1; i < pixelPoints.length; i++) {
      ctx.lineTo(pixelPoints[i].x, pixelPoints[i].y);
    }
    ctx.closePath();

    // 填充
    ctx.fillStyle = area.enable ? 'rgba(24, 144, 255, 0.3)' : 'rgba(156, 163, 175, 0.3)';
    ctx.fill();

    // 描边
    ctx.strokeStyle = area.enable ? '#1890ff' : '#9ca3af';
    ctx.lineWidth = 2;
    ctx.stroke();

    // 绘制区域编号
    const centerX = pixelPoints.reduce((sum, p) => sum + p.x, 0) / pixelPoints.length;
    const centerY = pixelPoints.reduce((sum, p) => sum + p.y, 0) / pixelPoints.length;

    ctx.fillStyle = '#fff';
    ctx.fillRect(centerX - 15, centerY - 15, 30, 30);

    ctx.fillStyle = area.enable ? '#1890ff' : '#9ca3af';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(index + 1, centerX, centerY);

    ctx.restore();
  });
};

// 打开视频画线弹窗
const handleOpenDrawing = () => {
  drawingModalVisible.value = true;
};

// 添加区域
const handleAddArea = () => {
  drawingModalVisible.value = true;
};

// 保存区域
const handleSaveAreas = (areas) => {
  areaList.value = areas;
  redrawCanvas();
  message.success('区域保存成功');
};

// 编辑区域
const handleEditArea = (record) => {
  message.info('编辑区域功能');
};

// 删除区域
const handleDeleteArea = async (record) => {
  try {
    await behaviorApi.deleteDetectionArea(record.id);
    areaList.value = areaList.value.filter(item => item.id !== record.id);
    redrawCanvas();
    message.success('删除成功');
  } catch (error) {
    console.error('删除失败:', error);
    message.error('删除失败');
  }
};

// 区域启用状态变化
const handleAreaEnableChange = (record) => {
  redrawCanvas();
};

// 添加时间计划
const handleAddTimePlan = () => {
  formState.timePlans.push({
    id: Date.now(),
    startTime: '00:00:00',
    endTime: '23:59:59',
    period: '0',
    cycleType: '0',
  });
};

// 删除时间计划
const handleDeleteTimePlan = (id) => {
  formState.timePlans = formState.timePlans.filter(plan => plan.id !== id);
};

// 保存配置
const handleSave = async () => {
  try {
    // 保存检测规则
    await behaviorApi.saveDetectionRule({
      deviceId: props.deviceId,
      ruleType: props.ruleType,
      ...formState,
    });

    // 保存检测区域
    for (const area of areaList.value) {
      await behaviorApi.saveDetectionArea({
        deviceId: props.deviceId,
        ruleType: props.ruleType,
        ...area,
      });
    }

    message.success('保存成功');
  } catch (error) {
    console.error('保存失败:', error);
    message.error('保存失败');
  }
};

// 重置
const handleReset = () => {
  loadConfig();
  loadAreas();
  message.info('已重置为初始配置');
};

// Canvas点击事件(用于区域选择等)
const handleCanvasClick = (e) => {
  const canvas = canvasRef.value;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  console.log('点击坐标:', { x, y });
};
</script>

<style scoped lang="less">
.intrusion-detection {
  padding: 24px;
  background: #f0f2f5;

  .area-actions {
    display: flex;
    gap: 8px;
  }

  .video-preview {
    position: relative;
    width: 100%;
    aspect-ratio: 16/9;
    background: #000;
    border-radius: 4px;
    overflow: hidden;

    .preview-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .preview-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
    }
  }

  .linkage-config {
    .config-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
    }

    :deep(.ant-checkbox-group) {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  }

  .action-buttons {
    margin-top: 24px;
    text-align: center;
  }
}
</style>
```

### 5. 视频画线弹窗组件
**功能说明**:
- 实时视频预览
- 多边形区域绘制
- 直线绘制(越线检测)
- 支持撤销、清除操作
- 最多支持4个区域
- 区域命名和管理

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/VideoDrawingModal.vue -->
<template>
  <a-modal
    :open="visible"
    title="视频画线"
    width="1200px"
    :footer="null"
    @cancel="handleCancel"
  >
    <div class="video-drawing-modal">
      <!-- 摄像头选择 -->
      <div class="camera-selector">
        <a-space>
          <span>选择摄像头:</span>
          <a-select
            v-model:value="selectedCamera"
            style="width: 300px;"
            @change="handleCameraChange"
          >
            <a-select-option
              v-for="camera in cameraList"
              :key="camera.id"
              :value="camera.id"
            >
              {{ camera.name }}
            </a-select-option>
          </a-select>
          <a-button type="primary" @click="handleStartPreview">
            <template #icon><PlayCircleOutlined /></template>
            开始预览
          </a-button>
          <a-button @click="handleStopPreview">
            <template #icon><PauseCircleOutlined /></template>
            停止预览
          </a-button>
        </a-space>
      </div>

      <div class="drawing-content">
        <!-- 左侧视频预览和绘图区 -->
        <div class="video-section">
          <div class="video-container">
            <video
              ref="videoRef"
              class="preview-video"
              autoplay
              muted
            >
              <source :src="currentStreamUrl" type="video/mp4">
            </video>

            <!-- Canvas绘图层 -->
            <canvas
              ref="canvasRef"
              class="drawing-canvas"
              @click="handleCanvasClick"
              @dblclick="handleCanvasDblClick"
              @mousemove="handleCanvasMouseMove"
            ></canvas>

            <!-- 绘图工具栏 -->
            <div v-if="videoPlaying" class="drawing-toolbar">
              <a-button-group>
                <a-button
                  :type="drawingMode === 'polygon' ? 'primary' : 'default'"
                  @click="setDrawingMode('polygon')"
                >
                  <template #icon><BorderOutlined /></template>
                  多边形
                </a-button>
                <a-button
                  :type="drawingMode === 'line' ? 'primary' : 'default'"
                  @click="setDrawingMode('line')"
                >
                  <template #icon><LineOutlined /></template>
                  直线
                </a-button>
                <a-button @click="handleUndo">
                  <template #icon><UndoOutlined /></template>
                  撤销
                </a-button>
                <a-button danger @click="handleClearCurrent">
                  <template #icon><ClearOutlined /></template>
                  清除当前
                </a-button>
              </a-button-group>
            </div>

            <!-- 状态提示 -->
            <div class="status-tip">
              <a-tag v-if="!videoPlaying" color="warning">
                请选择摄像头并开始预览
              </a-tag>
              <a-tag v-else-if="drawingMode === 'polygon'" color="processing">
                多边形模式: 点击添加顶点，双击完成绘制
              </a-tag>
              <a-tag v-else-if="drawingMode === 'line'" color="processing">
                直线模式: 点击起点和终点完成绘制
              </a-tag>
              <a-tag v-else color="default">
                请选择绘制模式
              </a-tag>
            </div>
          </div>

          <!-- 绘制说明 -->
          <a-alert
            message="绘制说明"
            type="info"
            style="margin-top: 12px;"
          >
            <template #description>
              <ul style="margin: 0; padding-left: 20px;">
                <li>选择摄像头并点击"开始预览"获取实时画面</li>
                <li>点击"多边形"在视频上绘制检测区域(点击确定顶点，双击完成)</li>
                <li>点击"直线"绘制越线检测(点击起点，再点击终点)</li>
                <li>最多可绘制 4 个检测区域</li>
              </ul>
            </template>
          </a-alert>
        </div>

        <!-- 右侧区域列表 -->
        <div class="area-list-section">
          <div class="section-header">
            <span>检测区域列表</span>
            <a-tag color="blue">{{ drawnAreas.length }} / 4</a-tag>
          </div>

          <div class="area-list">
            <div
              v-for="(area, index) in drawnAreas"
              :key="area.id"
              class="area-item"
              :class="{ active: selectedAreaIndex === index }"
              @click="handleSelectArea(index)"
            >
              <div class="area-header">
                <div class="area-title">
                  <component :is="getAreaIcon(area.type)" />
                  <a-input
                    v-model:value="area.name"
                    size="small"
                    style="width: 150px;"
                    @click.stop
                  />
                </div>
                <a-button
                  type="link"
                  danger
                  size="small"
                  @click.stop="handleDeleteArea(index)"
                >
                  <DeleteOutlined />
                </a-button>
              </div>

              <div class="area-info">
                <div class="info-item">
                  <span>类型:</span>
                  <span>{{ area.type === 'polygon' ? '多边形' : '直线' }}</span>
                </div>
                <div class="info-item">
                  <span>顶点数:</span>
                  <span>{{ area.points.length }}</span>
                </div>
              </div>
            </div>

            <a-empty
              v-if="drawnAreas.length === 0"
              description="暂无检测区域，请在左侧视频上绘制"
              :image="Empty.PRESENTED_IMAGE_SIMPLE"
            />
          </div>
        </div>
      </div>

      <!-- 底部操作栏 -->
      <div class="modal-footer">
        <a-space>
          <a-button @click="handleClearAll" danger>
            <template #icon><DeleteOutlined /></template>
            清除全部
          </a-button>
        </a-space>

        <a-space>
          <a-button @click="handleCancel">取消</a-button>
          <a-button
            type="primary"
            @click="handleSave"
            :disabled="drawnAreas.length === 0"
          >
            <template #icon><SaveOutlined /></template>
            保存配置
          </a-button>
        </a-space>
      </div>
    </div>
  </a-modal>
</template>

<script setup>
import { ref, watch, nextTick } from 'vue';
import { message, Empty } from 'ant-design-vue';
import {
  PlayCircleOutlined,
  PauseCircleOutlined,
  BorderOutlined,
  LineOutlined,
  UndoOutlined,
  ClearOutlined,
  DeleteOutlined,
  SaveOutlined,
} from '@ant-design/icons-vue';
import { behaviorApi } from '/@/api/business/smart-video/behavior-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  deviceId: {
    type: String,
    required: true,
  },
  existingAreas: {
    type: Array,
    default: () => [],
  },
});

const emit = defineEmits(['update:visible', 'save']);

const videoRef = ref(null);
const canvasRef = ref(null);

const cameraList = ref([
  { id: 'cam001', name: 'IPC_001 - 前门摄像头' },
  { id: 'cam002', name: 'IPC_002 - 大厅摄像头' },
  { id: 'cam003', name: 'IPC_003 - 走廊摄像头' },
  { id: 'cam004', name: 'IPC_004 - 停车场摄像头' },
]);

const selectedCamera = ref('');
const currentStreamUrl = ref('');
const videoPlaying = ref(false);

const drawingMode = ref(null);
const drawingPoints = ref([]);
const drawnAreas = ref([]);
const selectedAreaIndex = ref(-1);
const mousePosition = ref({ x: 0, y: 0 });

// 监听visible变化，初始化
watch(() => props.visible, (newVal) => {
  if (newVal) {
    initModal();
  } else {
    resetModal();
  }
});

// 初始化弹窗
const initModal = () => {
  // 加载已有区域
  if (props.existingAreas && props.existingAreas.length > 0) {
    drawnAreas.value = JSON.parse(JSON.stringify(props.existingAreas));
  }

  // 初始化canvas
  nextTick(() => {
    initCanvas();
  });
};

// 重置弹窗
const resetModal = () => {
  videoPlaying.value = false;
  drawingMode.value = null;
  drawingPoints.value = [];
  selectedAreaIndex.value = -1;
  currentStreamUrl.value = '';
};

// 初始化Canvas
const initCanvas = () => {
  const canvas = canvasRef.value;
  const video = videoRef.value;

  if (!canvas || !video) return;

  // 设置canvas尺寸
  const resizeCanvas = () => {
    const rect = video.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    redrawCanvas();
  };

  video.addEventListener('loadedmetadata', resizeCanvas);
  window.addEventListener('resize', resizeCanvas);

  // 初始调用
  resizeCanvas();
};

// 重绘Canvas
const redrawCanvas = () => {
  const canvas = canvasRef.value;
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  // 清除画布
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 绘制已保存的区域
  drawnAreas.value.forEach((area, index) => {
    drawPolygon(
      ctx,
      area.points,
      index === selectedAreaIndex.value ? '#52c41a' : '#1890ff',
      0.3
    );
  });

  // 绘制正在绘制的区域
  if (drawingPoints.value.length > 0) {
    drawPolygon(ctx, drawingPoints.value, '#faad14', 0.5, true);

    // 如果是多边形模式，绘制预览线
    if (drawingMode.value === 'polygon' && mousePosition.value) {
      ctx.save();
      ctx.strokeStyle = '#faad14';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      const lastPoint = drawingPoints.value[drawingPoints.value.length - 1];
      ctx.moveTo(lastPoint.x, lastPoint.y);
      ctx.lineTo(mousePosition.value.x, mousePosition.value.y);
      ctx.stroke();
      ctx.restore();
    }
  }
};

// 绘制多边形/线条
const drawPolygon = (ctx, points, color, alpha, isDrawing = false) => {
  if (points.length < 1) return;

  ctx.save();

  // 绘制线条
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) {
    ctx.lineTo(points[i].x, points[i].y);
  }

  if (!isDrawing && points.length > 2) {
    ctx.closePath();
    // 填充
    ctx.fillStyle = color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
    ctx.fill();
  }

  // 描边
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.stroke();

  // 绘制顶点
  points.forEach((point, index) => {
    ctx.beginPath();
    ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();

    // 绘制顶点编号
    ctx.fillStyle = color;
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(index + 1, point.x, point.y - 15);
  });

  ctx.restore();
};

// 摄像头变化
const handleCameraChange = () => {
  console.log('选择摄像头:', selectedCamera.value);
};

// 开始预览
const handleStartPreview = async () => {
  if (!selectedCamera.value) {
    message.warning('请先选择摄像头');
    return;
  }

  try {
    // 获取视频流地址
    const res = await behaviorApi.getVideoStreamForDrawing(selectedCamera.value);
    if (res.data && res.data.streamUrl) {
      currentStreamUrl.value = res.data.streamUrl;
      videoPlaying.value = true;
      message.success('视频预览已开始');
    }
  } catch (error) {
    console.error('获取视频流失败:', error);
    message.error('获取视频流失败');
  }
};

// 停止预览
const handleStopPreview = () => {
  videoPlaying.value = false;
  currentStreamUrl.value = '';
  message.info('视频预览已停止');
};

// 设置绘制模式
const setDrawingMode = (mode) => {
  if (!videoPlaying.value) {
    message.warning('请先开始视频预览');
    return;
  }

  if (drawnAreas.value.length >= 4) {
    message.warning('最多只能绘制4个区域');
    return;
  }

  drawingMode.value = mode;
  drawingPoints.value = [];
  selectedAreaIndex.value = -1;
};

// Canvas点击
const handleCanvasClick = (e) => {
  if (!drawingMode.value) return;

  const canvas = canvasRef.value;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if (drawingMode.value === 'polygon') {
    // 多边形模式: 添加顶点
    drawingPoints.value.push({ x, y });
    redrawCanvas();
  } else if (drawingMode.value === 'line') {
    // 直线模式: 需要两个点
    drawingPoints.value.push({ x, y });

    if (drawingPoints.value.length === 2) {
      // 完成绘制
      finishDrawing();
    } else {
      redrawCanvas();
    }
  }
};

// Canvas双击(完成多边形绘制)
const handleCanvasDblClick = (e) => {
  e.preventDefault();

  if (drawingMode.value === 'polygon' && drawingPoints.value.length >= 3) {
    finishDrawing();
  }
};

// Canvas鼠标移动(显示预览线)
const handleCanvasMouseMove = (e) => {
  if (drawingMode.value !== 'polygon' || drawingPoints.value.length === 0) {
    return;
  }

  const canvas = canvasRef.value;
  const rect = canvas.getBoundingClientRect();
  mousePosition.value = {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
  };

  redrawCanvas();
};

// 完成绘制
const finishDrawing = () => {
  if (drawingPoints.value.length < 2) {
    message.warning('至少需要2个点');
    return;
  }

  if (drawingMode.value === 'polygon' && drawingPoints.value.length < 3) {
    message.warning('多边形至少需要3个点');
    return;
  }

  // 保存区域
  const newArea = {
    id: Date.now(),
    name: `${drawingMode.value === 'polygon' ? '区域' : '线条'}${drawnAreas.value.length + 1}`,
    type: drawingMode.value,
    points: [...drawingPoints.value],
    enable: true,
  };

  drawnAreas.value.push(newArea);

  // 重置绘制状态
  drawingMode.value = null;
  drawingPoints.value = [];
  mousePosition.value = null;

  redrawCanvas();
  message.success('区域添加成功');
};

// 撤销上一个点
const handleUndo = () => {
  if (drawingPoints.value.length > 0) {
    drawingPoints.value.pop();
    redrawCanvas();
  }
};

// 清除当前绘制
const handleClearCurrent = () => {
  drawingPoints.value = [];
  drawingMode.value = null;
  redrawCanvas();
};

// 选择区域
const handleSelectArea = (index) => {
  selectedAreaIndex.value = index;
  redrawCanvas();
};

// 删除区域
const handleDeleteArea = (index) => {
  drawnAreas.value.splice(index, 1);
  if (selectedAreaIndex.value === index) {
    selectedAreaIndex.value = -1;
  }
  redrawCanvas();
  message.success('区域已删除');
};

// 清除全部
const handleClearAll = () => {
  if (drawnAreas.value.length === 0) {
    message.warning('没有可清除的区域');
    return;
  }

  drawnAreas.value = [];
  selectedAreaIndex.value = -1;
  redrawCanvas();
  message.success('已清除全部区域');
};

// 保存
const handleSave = () => {
  if (drawnAreas.value.length === 0) {
    message.warning('请至少绘制一个区域');
    return;
  }

  // 归一化坐标
  const canvas = canvasRef.value;
  const normalizedAreas = drawnAreas.value.map(area => ({
    ...area,
    points: area.points.map(point => ({
      x: point.x / canvas.width,
      y: point.y / canvas.height,
    })),
  }));

  emit('save', normalizedAreas);
  emit('update:visible', false);
};

// 取消
const handleCancel = () => {
  emit('update:visible', false);
};

// 获取区域图标
const getAreaIcon = (type) => {
  return type === 'polygon' ? BorderOutlined : LineOutlined;
};
</script>

<style scoped lang="less">
.video-drawing-modal {
  .camera-selector {
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .drawing-content {
    display: flex;
    gap: 16px;
    margin-top: 16px;

    .video-section {
      flex: 1;

      .video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
        border-radius: 4px;
        overflow: hidden;

        .preview-video {
          width: 100%;
          height: 100%;
          object-fit: contain;
        }

        .drawing-canvas {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          cursor: crosshair;
        }

        .drawing-toolbar {
          position: absolute;
          top: 12px;
          left: 12px;
          background: rgba(255, 255, 255, 0.95);
          padding: 8px;
          border-radius: 4px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .status-tip {
          position: absolute;
          bottom: 12px;
          left: 50%;
          transform: translateX(-50%);
        }
      }
    }

    .area-list-section {
      width: 320px;
      display: flex;
      flex-direction: column;

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #fafafa;
        border-radius: 4px 4px 0 0;
        border: 1px solid #f0f0f0;
        font-weight: 500;
      }

      .area-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #f0f0f0;
        border-top: none;
        border-radius: 0 0 4px 4px;
        padding: 8px;
        background: #fff;
        max-height: 500px;

        .area-item {
          padding: 12px;
          margin-bottom: 8px;
          border: 1px solid #f0f0f0;
          border-radius: 4px;
          cursor: pointer;
          transition: all 0.3s;

          &:hover {
            border-color: #1890ff;
            box-shadow: 0 2px 4px rgba(24, 144, 255, 0.15);
          }

          &.active {
            border-color: #52c41a;
            background: #f6ffed;
          }

          .area-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;

            .area-title {
              display: flex;
              align-items: center;
              gap: 8px;
            }
          }

          .area-info {
            font-size: 12px;
            color: #666;

            .info-item {
              display: flex;
              justify-content: space-between;
              margin-bottom: 4px;

              &:last-child {
                margin-bottom: 0;
              }
            }
          }
        }
      }
    }
  }

  .modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
  }
}
</style>
```

### 6. 声光告警配置组件
**功能说明**:
- 音频告警配置(启用/禁用、音频文件、播放次数)
- 白光灯告警配置(启用/禁用、频闪频率、闪烁时间)

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/AudioLightAlarm.vue -->
<template>
  <div class="audio-light-alarm">
    <a-row :gutter="16">
      <!-- 音频告警 -->
      <a-col :span="12">
        <div class="alarm-config-box">
          <div class="box-header">
            <SoundOutlined />
            <span>音频告警</span>
            <a-switch
              :checked="audioEnable"
              size="small"
              @change="handleAudioEnableChange"
            />
          </div>

          <div class="box-content">
            <a-form-item label="音频文件">
              <a-select
                :value="audioFile"
                :disabled="!audioEnable"
                @change="handleAudioFileChange"
              >
                <a-select-option value="">请选择音频文件</a-select-option>
                <a-select-option value="alarm1.mp3">警报音1</a-select-option>
                <a-select-option value="alarm2.mp3">警报音2</a-select-option>
                <a-select-option value="alarm3.mp3">警报音3</a-select-option>
              </a-select>
            </a-form-item>

            <a-form-item label="播放次数">
              <a-input-number
                :value="audioCount"
                :min="1"
                :max="50"
                :disabled="!audioEnable"
                addon-after="次"
                @change="handleAudioCountChange"
              />
            </a-form-item>
          </div>
        </div>
      </a-col>

      <!-- 白光灯告警 -->
      <a-col :span="12">
        <div class="alarm-config-box">
          <div class="box-header">
            <BulbOutlined />
            <span>白光灯告警</span>
            <a-switch
              :checked="lightEnable"
              size="small"
              @change="handleLightEnableChange"
            />
          </div>

          <div class="box-content">
            <a-form-item label="频闪频率">
              <a-select
                :value="lightFrequency"
                :disabled="!lightEnable"
                @change="handleLightFrequencyChange"
              >
                <a-select-option value="Low">低频</a-select-option>
                <a-select-option value="Medium">中频</a-select-option>
                <a-select-option value="High">高频</a-select-option>
                <a-select-option value="Steady on">常亮</a-select-option>
              </a-select>
            </a-form-item>

            <a-form-item label="闪烁时间">
              <a-input-number
                :value="lightDuration"
                :min="1"
                :max="50"
                :disabled="!lightEnable"
                addon-after="秒"
                @change="handleLightDurationChange"
              />
            </a-form-item>
          </div>
        </div>
      </a-col>
    </a-row>
  </div>
</template>

<script setup>
import { SoundOutlined, BulbOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  audioEnable: {
    type: Boolean,
    default: false,
  },
  audioFile: {
    type: String,
    default: '',
  },
  audioCount: {
    type: Number,
    default: 1,
  },
  lightEnable: {
    type: Boolean,
    default: false,
  },
  lightFrequency: {
    type: String,
    default: 'Medium',
  },
  lightDuration: {
    type: Number,
    default: 5,
  },
});

const emit = defineEmits([
  'update:audioEnable',
  'update:audioFile',
  'update:audioCount',
  'update:lightEnable',
  'update:lightFrequency',
  'update:lightDuration',
]);

const handleAudioEnableChange = (checked) => {
  emit('update:audioEnable', checked);
};

const handleAudioFileChange = (value) => {
  emit('update:audioFile', value);
};

const handleAudioCountChange = (value) => {
  emit('update:audioCount', value);
};

const handleLightEnableChange = (checked) => {
  emit('update:lightEnable', checked);
};

const handleLightFrequencyChange = (value) => {
  emit('update:lightFrequency', value);
};

const handleLightDurationChange = (value) => {
  emit('update:lightDuration', value);
};
</script>

<style scoped lang="less">
.audio-light-alarm {
  .alarm-config-box {
    border: 1px solid #f0f0f0;
    border-radius: 4px;
    overflow: hidden;

    .box-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #fafafa;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 500;

      span {
        flex: 1;
      }
    }

    .box-content {
      padding: 16px;

      :deep(.ant-form-item) {
        margin-bottom: 12px;

        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }
}
</style>
```

### 7. 时间计划配置组件
**功能说明**:
- 新增/删除时间计划
- 配置开始时间、结束时间
- 选择日期(每天/周一至周日)
- 设置循环模式

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/TimePlanConfig.vue -->
<template>
  <div class="time-plan-config">
    <div class="plan-actions">
      <a-space>
        <a-button type="primary" size="small" @click="handleAdd">
          <template #icon><PlusOutlined /></template>
          新增
        </a-button>
        <a-button danger size="small" @click="handleDeleteAll">
          <template #icon><DeleteOutlined /></template>
          删除全部
        </a-button>
      </a-space>
    </div>

    <a-table
      :columns="columns"
      :data-source="plans"
      :pagination="false"
      size="small"
      style="margin-top: 12px;"
    >
      <template #bodyCell="{ column, record, index }">
        <template v-if="column.key === 'startTime'">
          <a-time-picker
            v-model:value="record.startTime"
            format="HH:mm:ss"
            value-format="HH:mm:ss"
            style="width: 100%;"
          />
        </template>
        <template v-else-if="column.key === 'endTime'">
          <a-time-picker
            v-model:value="record.endTime"
            format="HH:mm:ss"
            value-format="HH:mm:ss"
            style="width: 100%;"
          />
        </template>
        <template v-else-if="column.key === 'period'">
          <a-select v-model:value="record.period" style="width: 100%;">
            <a-select-option value="0">每天</a-select-option>
            <a-select-option value="1">周一</a-select-option>
            <a-select-option value="2">周二</a-select-option>
            <a-select-option value="3">周三</a-select-option>
            <a-select-option value="4">周四</a-select-option>
            <a-select-option value="5">周五</a-select-option>
            <a-select-option value="6">周六</a-select-option>
            <a-select-option value="7">周日</a-select-option>
          </a-select>
        </template>
        <template v-else-if="column.key === 'cycleType'">
          <a-select v-model:value="record.cycleType" style="width: 100%;">
            <a-select-option value="0">不循环</a-select-option>
            <a-select-option value="1">循环</a-select-option>
          </a-select>
        </template>
        <template v-else-if="column.key === 'action'">
          <a-button
            type="link"
            danger
            size="small"
            @click="handleDelete(index)"
          >
            <DeleteOutlined />
          </a-button>
        </template>
      </template>
    </a-table>

    <a-empty
      v-if="plans.length === 0"
      description="暂无时间计划，请点击"新增"按钮添加"
      :image="Empty.PRESENTED_IMAGE_SIMPLE"
      style="margin-top: 20px;"
    />
  </div>
</template>

<script setup>
import { computed } from 'vue';
import { message, Empty } from 'ant-design-vue';
import { PlusOutlined, DeleteOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  plans: {
    type: Array,
    default: () => [],
  },
});

const emit = defineEmits(['update:plans', 'add', 'delete']);

const columns = [
  {
    title: '开始时间',
    key: 'startTime',
    width: 150,
  },
  {
    title: '结束时间',
    key: 'endTime',
    width: 150,
  },
  {
    title: '日期',
    key: 'period',
    width: 120,
  },
  {
    title: '循环模式',
    key: 'cycleType',
    width: 120,
  },
  {
    title: '操作',
    key: 'action',
    width: 80,
    align: 'center',
  },
];

const handleAdd = () => {
  if (props.plans.length >= 8) {
    message.warning('时间计划最多只能添加8个');
    return;
  }

  emit('add');
};

const handleDelete = (index) => {
  emit('delete', props.plans[index].id);
};

const handleDeleteAll = () => {
  if (props.plans.length === 0) {
    message.warning('没有可删除的时间计划');
    return;
  }

  emit('update:plans', []);
  message.success('已删除全部时间计划');
};
</script>

<style scoped lang="less">
.time-plan-config {
  .plan-actions {
    display: flex;
    justify-content: flex-start;
  }
}
</style>
```

### 8. 主页面集成
**技术实现**:
```vue
<!-- src/views/business/smart-video/behavioral-analysis.vue -->
<template>
  <div class="behavioral-analysis-page">
    <div class="page-header">
      <div class="header-left">
        <h2>
          <AimOutlined />
          <span>行为分析配置</span>
        </h2>
        <div class="device-info">
          <VideoCameraOutlined />
          <span>{{ currentDevice?.name || '请选择设备' }}</span>
        </div>
      </div>

      <div class="header-right">
        <a-button @click="handleRefresh">
          <template #icon><ReloadOutlined /></template>
          刷新配置
        </a-button>
      </div>
    </div>

    <div class="page-container">
      <!-- 左侧设备树 -->
      <DeviceTreeSelector
        :device-list="deviceList"
        @device-select="handleDeviceSelect"
      />

      <!-- 右侧配置区域 -->
      <div class="content-section">
        <!-- 检测类型Tab -->
        <DetectionTabs
          v-if="currentDevice"
          :device-id="currentDevice.id"
          :active-tab="activeTab"
          @tab-change="handleTabChange"
        />

        <!-- 未选择设备提示 -->
        <a-empty
          v-else
          description="请从左侧设备列表中选择一个设备进行配置"
          :image="Empty.PRESENTED_IMAGE_SIMPLE"
          style="margin-top: 100px;"
        />
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message, Empty } from 'ant-design-vue';
import {
  AimOutlined,
  VideoCameraOutlined,
  ReloadOutlined,
} from '@ant-design/icons-vue';
import DeviceTreeSelector from './components/DeviceTreeSelector.vue';
import DetectionTabs from './components/DetectionTabs.vue';
import { behaviorApi } from '/@/api/business/smart-video/behavior-api';

const currentDevice = ref(null);
const activeTab = ref('global');
const deviceList = ref([]);

onMounted(() => {
  loadDeviceList();
});

// 加载设备列表
const loadDeviceList = async () => {
  try {
    // 模拟数据
    deviceList.value = [
      {
        id: 'area1',
        name: '办公区',
        deviceType: 'folder',
        children: [
          {
            id: 'cam001',
            name: 'IPC_001 - 前门',
            code: 'CAM-001',
            status: 'online',
            deviceType: 'camera',
          },
          {
            id: 'cam002',
            name: 'IPC_002 - 大厅',
            code: 'CAM-002',
            status: 'online',
            deviceType: 'camera',
          },
        ],
      },
      {
        id: 'area2',
        name: '厂区',
        deviceType: 'folder',
        children: [
          {
            id: 'cam003',
            name: 'IPC_003 - 车间',
            code: 'CAM-003',
            status: 'offline',
            deviceType: 'camera',
          },
        ],
      },
    ];
  } catch (error) {
    console.error('加载设备列表失败:', error);
    message.error('加载设备列表失败');
  }
};

// 设备选择
const handleDeviceSelect = (device) => {
  currentDevice.value = device;
  message.success(`已选择设备: ${device.name}`);
};

// Tab切换
const handleTabChange = (tab) => {
  activeTab.value = tab;
};

// 刷新配置
const handleRefresh = () => {
  if (!currentDevice.value) {
    message.warning('请先选择设备');
    return;
  }

  loadDeviceList();
  message.success('配置已刷新');
};
</script>

<style scoped lang="less">
.behavioral-analysis-page {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: #f0f2f5;

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;

    .header-left {
      display: flex;
      align-items: center;
      gap: 24px;

      h2 {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      .device-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #f0f2f5;
        border-radius: 4px;
        font-size: 14px;
        color: #666;
      }
    }

    .header-right {
      display: flex;
      gap: 8px;
    }
  }

  .page-container {
    display: flex;
    flex: 1;
    overflow: hidden;

    .content-section {
      flex: 1;
      overflow-y: auto;
    }
  }
}
</style>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/behavior-mock-data.js

export const mockDeviceList = [
  {
    id: 'area1',
    name: '办公区',
    deviceType: 'folder',
    children: [
      {
        id: 'cam001',
        name: 'IPC_001 - 前门',
        code: 'CAM-001',
        status: 'online',
        deviceType: 'camera',
      },
      {
        id: 'cam002',
        name: 'IPC_002 - 大厅',
        code: 'CAM-002',
        status: 'online',
        deviceType: 'camera',
      },
    ],
  },
  {
    id: 'area2',
    name: '厂区',
    deviceType: 'folder',
    children: [
      {
        id: 'cam003',
        name: 'IPC_003 - 车间',
        code: 'CAM-003',
        status: 'offline',
        deviceType: 'camera',
      },
    ],
  },
];

export const mockGlobalConfig = {
  enable: true,
  sendMetadataSwitch: false,
  perimeterEnhanceSwitch: false,
  alertInhibitionSwitch: false,
  shadowRemovalMode: 'NormalShadow',
  detectionSensitivity: 'MiddleSensitivity',
  backgroundUpdateRate: 'Middle',
  minTargetSizeWidth: 5,
  minTargetSizeHeight: 5,
  maxTargetSizeWidth: 200,
  maxTargetSizeHeight: 200,
};

export const mockIntrusionConfig = {
  detectType: ['Pedestrian', 'Vehicle'],
  alarmInterval: 1,
  recognizeMode: 'Center',
  sensitivity: 50,
  audioEnable: false,
  audioFile: '',
  audioCount: 1,
  lightEnable: false,
  whiteLightIlluminator: 'Medium',
  lightCount: 5,
  timePlans: [
    {
      id: 1,
      startTime: '00:00:00',
      endTime: '23:59:59',
      period: '0',
      cycleType: '1',
    },
  ],
  linkageTypes: ['email', 'upload'],
};

export const mockDetectionAreas = [
  {
    id: 1,
    name: '检测区域1',
    type: 'polygon',
    enable: true,
    points: [
      { x: 0.1, y: 0.1 },
      { x: 0.9, y: 0.1 },
      { x: 0.9, y: 0.9 },
      { x: 0.1, y: 0.9 },
    ],
  },
  {
    id: 2,
    name: '检测区域2',
    type: 'polygon',
    enable: true,
    points: [
      { x: 0.2, y: 0.2 },
      { x: 0.5, y: 0.2 },
      { x: 0.5, y: 0.5 },
      { x: 0.2, y: 0.5 },
    ],
  },
];

export const mockDetectionResults = [
  {
    id: 1,
    deviceId: 'cam001',
    deviceName: 'IPC_001 - 前门',
    ruleType: 'intrusion',
    ruleName: '入侵检测',
    detectionTime: '2025-01-15 10:30:25',
    snapshotUrl: '/mock/snapshot1.jpg',
    videoUrl: '/mock/video1.mp4',
    targetType: 'Pedestrian',
    confidence: 0.95,
  },
  {
    id: 2,
    deviceId: 'cam002',
    deviceName: 'IPC_002 - 大厅',
    ruleType: 'lineCrossing',
    ruleName: '越线检测',
    detectionTime: '2025-01-15 10:28:15',
    snapshotUrl: '/mock/snapshot2.jpg',
    videoUrl: '/mock/video2.mp4',
    targetType: 'Vehicle',
    confidence: 0.88,
  },
];

export const mockStatistics = {
  totalEvents: 1250,
  todayEvents: 45,
  onlineDevices: 156,
  offlineDevices: 2,
  enabledRules: 8,
  disabledRules: 2,
  eventsByType: {
    intrusion: 320,
    lineCrossing: 280,
    loitering: 150,
    itemLeave: 120,
    fastMove: 100,
    electroMobile: 80,
    areaEnter: 100,
    areaExit: 100,
  },
};

export default {
  mockDeviceList,
  mockGlobalConfig,
  mockIntrusionConfig,
  mockDetectionAreas,
  mockDetectionResults,
  mockStatistics,
};
```

## 路由配置

```javascript
// src/router/business/smart-video.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/behavioral-analysis',
        name: 'SmartVideoBehavioralAnalysis',
        component: () => import('/@/views/business/smart-video/behavioral-analysis.vue'),
        meta: {
          title: '智能视频 - 行为分析',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'AimOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

## 菜单配置

```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  const behavioralAnalysisMenu = {
    menuId: maxMenuId + 1003,
    menuName: '行为分析',
    menuTitle: '行为分析',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/behavioral-analysis',
    component: '/business/smart-video/behavioral-analysis.vue',
    icon: 'AimOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 3,
    updateTime: new Date().toISOString(),
  };

  menuList.push(behavioralAnalysisMenu);
}
```

## Store管理

```javascript
// src/store/modules/business/smart-video/behavior-store.js
import { defineStore } from 'pinia';
import { behaviorApi } from '/@/api/business/smart-video/behavior-api';

export const useBehaviorStore = defineStore('behavior', {
  state: () => ({
    currentDevice: null,
    activeTab: 'global',
    globalConfig: null,
    detectionRules: {},
    detectionAreas: {},
    timePlans: {},
    alarmConfigs: {},
    detectionResults: [],
    statistics: null,
  }),

  actions: {
    // 设置当前设备
    setCurrentDevice(device) {
      this.currentDevice = device;
    },

    // 设置活动Tab
    setActiveTab(tab) {
      this.activeTab = tab;
    },

    // 加载全局配置
    async loadGlobalConfig(deviceId) {
      try {
        const res = await behaviorApi.getGlobalConfig(deviceId);
        this.globalConfig = res.data;
        return res.data;
      } catch (error) {
        console.error('加载全局配置失败:', error);
        throw error;
      }
    },

    // 保存全局配置
    async saveGlobalConfig(config) {
      try {
        await behaviorApi.saveGlobalConfig(config);
        this.globalConfig = config;
      } catch (error) {
        console.error('保存全局配置失败:', error);
        throw error;
      }
    },

    // 加载检测规则
    async loadDetectionRule(deviceId, ruleType) {
      try {
        const res = await behaviorApi.getDetectionRule(deviceId, ruleType);
        this.detectionRules[`${deviceId}_${ruleType}`] = res.data;
        return res.data;
      } catch (error) {
        console.error('加载检测规则失败:', error);
        throw error;
      }
    },

    // 保存检测规则
    async saveDetectionRule(rule) {
      try {
        await behaviorApi.saveDetectionRule(rule);
        const key = `${rule.deviceId}_${rule.ruleType}`;
        this.detectionRules[key] = rule;
      } catch (error) {
        console.error('保存检测规则失败:', error);
        throw error;
      }
    },

    // 加载检测区域
    async loadDetectionAreas(deviceId, ruleType) {
      try {
        const res = await behaviorApi.getDetectionAreas(deviceId, ruleType);
        const key = `${deviceId}_${ruleType}`;
        this.detectionAreas[key] = res.data;
        return res.data;
      } catch (error) {
        console.error('加载检测区域失败:', error);
        throw error;
      }
    },

    // 加载检测结果
    async loadDetectionResults(params) {
      try {
        const res = await behaviorApi.getDetectionResults(params);
        this.detectionResults = res.data;
        return res.data;
      } catch (error) {
        console.error('加载检测结果失败:', error);
        throw error;
      }
    },

    // 加载统计数据
    async loadStatistics(params) {
      try {
        const res = await behaviorApi.getDetectionStatistics(params);
        this.statistics = res.data;
        return res.data;
      } catch (error) {
        console.error('加载统计数据失败:', error);
        throw error;
      }
    },
  },
});
```

## 常见错误排查清单

### 1. Canvas绘图相关错误
- [ ] Canvas尺寸未正确设置：导致画布模糊或变形
- [ ] 坐标系未归一化：不同分辨率下区域位置错误
- [ ] 未清理Canvas状态：绘制残留
- [ ] 事件监听器未移除：内存泄漏

### 2. 区域绘制问题
- [ ] 多边形顶点少于3个：无法闭合
- [ ] 坐标超出范围：导致区域显示异常
- [ ] 区域数量超过限制：应限制最多4个
- [ ] 未保存前切换页面：数据丢失

### 3. 配置保存问题
- [ ] 未选择设备：配置保存失败
- [ ] 参数验证失败：检查参数范围
- [ ] 时间格式错误：确保正确的时间格式
- [ ] 并发保存冲突：使用锁机制

### 4. 视频预览问题
- [ ] 流地址错误：检查流协议和地址
- [ ] 跨域问题：配置CORS
- [ ] 视频未加载：检查网络连接
- [ ] Canvas叠加层位置错误：检查CSS定位

## 最佳实践建议

### ✅ Canvas绘图优化
1. **使用设备像素比** - 保证高清显示
2. **坐标归一化** - 适配不同分辨率
3. **分层绘制** - 背景层和交互层分离
4. **事件节流** - 减少重绘次数
5. **状态管理** - 使用状态机管理绘制流程

### ✅ 配置管理
1. **实时校验** - 输入时验证参数
2. **草稿保存** - 自动保存草稿
3. **版本控制** - 支持配置回滚
4. **批量操作** - 支持批量配置
5. **导入导出** - 配置文件管理

### ✅ 用户体验优化
1. **实时预览** - 配置后即时预览效果
2. **智能提示** - 参数说明和建议值
3. **错误提示** - 明确的错误信息
4. **操作引导** - 首次使用引导
5. **快捷键支持** - 常用操作快捷键

### ✅ 性能优化
1. **按需加载** - 只加载当前Tab的配置
2. **数据缓存** - 缓存已加载的配置
3. **防抖节流** - 优化高频操作
4. **虚拟滚动** - 大量数据列表优化
5. **懒加载** - 组件按需加载

### ✅ 安全性建议
1. **权限控制** - 不同角色不同权限
2. **参数验证** - 前后端双重验证
3. **操作审计** - 记录配置变更日志
4. **敏感操作确认** - 删除等操作二次确认

## 总结

行为分析页面是智能视频监控系统的核心配置模块,需要特别注意:

- ✅ **完善的设备管理** - 支持树形结构和分组
- ✅ **多种检测类型** - 支持10+种行为检测
- ✅ **可视化区域绘制** - Canvas实现区域绘制
- ✅ **灵活的参数配置** - 丰富的检测参数
- ✅ **声光告警联动** - 支持音频和灯光告警
- ✅ **时间计划管理** - 灵活的时间段配置
- ✅ **实时视频预览** - 配置时实时预览
- ✅ **配置持久化** - 支持保存和加载配置
- ✅ **良好的用户体验** - 直观的操作流程
- ✅ **完整的错误处理** - 友好的错误提示

通过遵循本文档的技术规范,可以开发出功能完善、易用性强、性能优异的行为分析配置系统。
