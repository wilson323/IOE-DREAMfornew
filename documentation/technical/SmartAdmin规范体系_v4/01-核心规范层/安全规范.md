# å®‰å…¨è§„èŒƒï¼ˆæƒå¨æ–‡æ¡£ï¼‰

> **ğŸ“‹ æ–‡æ¡£ç‰ˆæœ¬**: v4.0.0 (æ•´åˆç‰ˆ)
> **ğŸ“‹ æ–‡æ¡£èŒè´£**: SmartAdminé¡¹ç›®çš„å”¯ä¸€å®‰å…¨è§„èŒƒæƒå¨æ¥æºï¼ŒåŸºäºSa-Token 1.44.0ï¼Œè´´åˆé¡¹ç›®å®é™…æƒ…å†µã€‚

## âš ï¸ å®‰å…¨é“å¾‹ï¼ˆä¸å¯è¿åï¼‰

### ğŸš« ç»å¯¹ç¦æ­¢
```markdown
âŒ ç¦æ­¢ç¡¬ç¼–ç å¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
âŒ ç¦æ­¢åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ•æ„Ÿä¿¡æ¯
âŒ ç¦æ­¢æ˜æ–‡ä¼ è¾“æ•æ„Ÿæ•°æ®
âŒ ç¦æ­¢SQLæ³¨å…¥æ¼æ´
âŒ ç¦æ­¢XSSè·¨ç«™è„šæœ¬æ”»å‡»
âŒ ç¦æ­¢CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ 
âŒ ç¦æ­¢æœªç»æˆæƒçš„è®¿é—®
âŒ ç¦æ­¢ä½¿ç”¨å·²çŸ¥æ¼æ´çš„ä¾èµ–åº“
âŒ ç¦æ­¢ç»•è¿‡Sa-Tokenæƒé™æ£€æŸ¥
âŒ ç¦æ­¢åœ¨Controllerä¸­ç›´æ¥æ“ä½œæƒé™é€»è¾‘
```

### âœ… å¿…é¡»æ‰§è¡Œ
```markdown
âœ… æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯å’Œè¿‡æ»¤
âœ… æ‰€æœ‰æ•æ„Ÿæ•°æ®å¿…é¡»åŠ å¯†å­˜å‚¨
âœ… æ‰€æœ‰APIå¿…é¡»æœ‰æƒé™æ§åˆ¶
âœ… æ‰€æœ‰æ“ä½œå¿…é¡»æœ‰å®¡è®¡æ—¥å¿—
âœ… æ‰€æœ‰å¯†ç å¿…é¡»ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•
âœ… æ‰€æœ‰é€šä¿¡å¿…é¡»ä½¿ç”¨HTTPS
âœ… å®šæœŸè¿›è¡Œå®‰å…¨æ¼æ´æ‰«æ
âœ… å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æœºåˆ¶
âœ… å¿…é¡»ä½¿ç”¨Sa-Tokenè¿›è¡Œè®¤è¯æˆæƒ
âœ… å¿…é¡»ä½¿ç”¨Sa-Tokenæ³¨è§£è¿›è¡Œæƒé™æ§åˆ¶
```

## ğŸ” Sa-Tokenè®¤è¯æˆæƒè§„èŒƒ

### èº«ä»½è®¤è¯
```markdown
âœ… ä½¿ç”¨Sa-Tokenè¿›è¡Œèº«ä»½è®¤è¯
âœ… å¯†ç ä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
âœ… å®ç°ç™»å½•å¤±è´¥é”å®šæœºåˆ¶
âœ… æ”¯æŒå¼ºåˆ¶ç”¨æˆ·ä¿®æ”¹åˆå§‹å¯†ç 
âœ… å®ç°ä¼šè¯è¶…æ—¶æ§åˆ¶
âœ… æ”¯æŒç”¨æˆ·æ³¨é”€å’Œä¼šè¯å¤±æ•ˆ
âœ… æ”¯æŒå¤šç«¯ç™»å½•æ§åˆ¶
âœ… å®ç°è®°ä½ç™»å½•çŠ¶æ€åŠŸèƒ½
```

### æƒé™æ§åˆ¶
```markdown
âœ… ä½¿ç”¨Sa-Tokençš„@SaCheckPermissionæ³¨è§£
âœ… å®ç°RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰
âœ… æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
âœ… å®ç°æ•°æ®æƒé™æ§åˆ¶
âœ… æ”¯æŒæƒé™åŠ¨æ€åˆ·æ–°
âœ… å®ç°ä¸´æ—¶æƒé™æˆæƒ
âœ… æ”¯æŒæƒé™ç»§æ‰¿æœºåˆ¶
âœ… å®ç°æƒé™ç¼“å­˜ä¼˜åŒ–
```
âœ… æ”¯æŒæƒé™ç»§æ‰¿å’Œç»„åˆ
âœ… å®ç°åŠ¨æ€æƒé™åŠ è½½
âœ… æ”¯æŒæƒé™å®¡è®¡å’Œç›‘æ§
âœ… å®ç°æƒé™ç¼“å­˜æœºåˆ¶
```

## ğŸ› ï¸ Sa-Tokenå®ç°æ¨¡æ¿

### è®¤è¯å®ç°
```java
// Sa-Tokené…ç½®ç±»
@Configuration
public class SaTokenConfig {

    @Bean
    public SaTokenConfig saTokenConfig() {
        return new SaTokenConfig()
                // tokenåç§°ï¼ˆåŒæ—¶ä¹Ÿæ˜¯cookieåç§°ï¼‰
                .setTokenName("satoken")
                // tokenæœ‰æ•ˆæœŸï¼Œå•ä½s é»˜è®¤30å¤©, -1ä»£è¡¨æ°¸ä¸è¿‡æœŸ
                .setTimeout(30 * 24 * 60 * 60)
                // tokenä¸´æ—¶æœ‰æ•ˆæœŸ (æŒ‡å®šæ—¶é—´å†…æ— æ“ä½œå°±è§†ä¸ºtokenè¿‡æœŸ) å•ä½: ç§’
                .setActiveTimeout(-1)
                // æ˜¯å¦å…è®¸åŒä¸€è´¦å·å¹¶å‘ç™»å½• (ä¸ºtrueæ—¶å…è®¸ä¸€èµ·ç™»å½•, ä¸ºfalseæ—¶æ–°ç™»å½•æŒ¤æ‰æ—§ç™»å½•)
                .setIsConcurrent(true)
                // åœ¨å¤šäººç™»å½•åŒä¸€è´¦å·æ—¶ï¼Œæ˜¯å¦å…±ç”¨ä¸€ä¸ªtoken (ä¸ºtrueæ—¶æ‰€æœ‰ç™»å½•å…±ç”¨ä¸€ä¸ªtoken, ä¸ºfalseæ—¶æ¯æ¬¡ç™»å½•æ–°å»ºä¸€ä¸ªtoken)
                .setIsShare(true)
                // tokené£æ ¼
                .setTokenStyle(TokenStyle.UUID)
                // æ˜¯å¦è¾“å‡ºæ“ä½œæ—¥å¿—
                .setIsLog(true);
    }
}

// ç™»å½•æœåŠ¡å®ç°
@Service
public class AuthServiceImpl implements AuthService {

    @Resource
    private UserDao userDao;

    @Override
    public String login(LoginForm loginForm) {
        // 1. å‚æ•°éªŒè¯
        SmartValidatorUtil.validate(loginForm);

        // 2. æŸ¥è¯¢ç”¨æˆ·
        UserEntity user = userDao.selectByUserName(loginForm.getUserName());
        if (user == null || user.getDeletedFlag()) {
            throw new BusinessException("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨");
        }

        // 3. å¯†ç éªŒè¯
        if (!BCrypt.checkpw(loginForm.getPassword(), user.getPassword())) {
            throw new BusinessException("PASSWORD_ERROR", "å¯†ç é”™è¯¯");
        }

        // 4. ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
        if (user.getStatus() != 1) {
            throw new BusinessException("USER_DISABLED", "ç”¨æˆ·å·²è¢«ç¦ç”¨");
        }

        // 5. ç™»å½•å¹¶è·å–token
        SaLoginModel loginModel = new SaLoginModel()
                .setUser(user.getUserId())
                .setDevice(loginForm.getDevice())
                .setIsLastingCookie(true);

        String token = StpUtil.login(loginModel);

        // 6. æ›´æ–°ç™»å½•ä¿¡æ¯
        user.setLastLoginTime(LocalDateTime.now());
        user.setLastLoginIp(loginForm.getLoginIp());
        userDao.updateById(user);

        return token;
    }

    @Override
    public void logout() {
        StpUtil.logout();
    }

    @Override
    public void kickout(Long userId) {
        StpUtil.kickout(userId);
    }
}

// ç™»å½•Controller
@RestController
@RequestMapping("/api/auth")
@Tag(name = "è®¤è¯ç®¡ç†")
public class AuthController {

    @Resource
    private authService authService;

    @PostMapping("/login")
    @SaIgnore // ç™»å½•æ¥å£å¿½ç•¥é‰´æƒ
    public ResponseDTO<String> login(@RequestBody @Valid LoginForm loginForm) {
        String token = authService.login(loginForm);
        return ResponseDTO.ok(token);
    }

    @PostMapping("/logout")
    @SaCheckLogin
    public ResponseDTO<String> logout() {
        authService.logout();
        return ResponseDTO.ok();
    }

    @GetMapping("/info")
    @SaCheckLogin
    public ResponseDTO<UserVO> getUserInfo() {
        Long userId = StpUtil.getLoginIdAsLong();
        UserVO userVO = userService.getUserInfo(userId);
        return ResponseDTO.ok(userVO);
    }
}
```

### æƒé™æ§åˆ¶å®ç°
```java
// æƒé™æœåŠ¡å®ç°
@Service
public class PermissionServiceImpl implements PermissionService {

    @Resource
    private RolePermissionDao rolePermissionDao;

    @Override
    public List<String> getPermissionList(Long userId) {
        // 1. è·å–ç”¨æˆ·è§’è‰²
        List<Long> roleIds = userRoleDao.selectRoleIdsByUserId(userId);

        // 2. è·å–è§’è‰²æƒé™
        List<String> permissionList = new ArrayList<>();
        for (Long roleId : roleIds) {
            List<String> permissions = rolePermissionDao.selectPermissionCodesByRoleId(roleId);
            permissionList.addAll(permissions);
        }

        // 3. å»é‡å¹¶è¿”å›
        return permissionList.stream().distinct().collect(Collectors.toList());
    }

    @Override
    public boolean hasPermission(Long userId, String permission) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        UserEntity user = userDao.selectById(userId);
        if (user != null && user.getAdminFlag()) {
            return true;
        }

        // æ£€æŸ¥æƒé™
        List<String> permissionList = getPermissionList(userId);
        return permissionList.contains(permission);
    }
}

// Sa-Tokenæƒé™æ¥å£å®ç°
@Component
public class SaTokenPermissionImpl implements StpInterface {

    @Resource
    private PermissionService permissionService;

    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        Long userId = Long.parseLong(loginId.toString());
        return permissionService.getPermissionList(userId);
    }

    @Override
    public String getRoleList(Object loginId, String loginType) {
        Long userId = Long.parseLong(loginId.toString());
        List<Long> roleIds = userRoleDao.selectRoleIdsByUserId(userId);
        return roleIds.stream().map(String::valueOf).collect(Collectors.toList());
    }
}

// ä¸šåŠ¡Controlleræƒé™æ§åˆ¶ç¤ºä¾‹
@RestController
@RequestMapping("/api/user")
@Tag(name = "ç”¨æˆ·ç®¡ç†")
public class UserController {

    @PostMapping("/add")
    @SaCheckPermission("user:add")
    public ResponseDTO<String> addUser(@RequestBody @Valid UserAddForm addForm) {
        return ResponseDTO.ok(userService.addUser(addForm));
    }

    @PostMapping("/update")
    @SaCheckPermission("user:update")
    public ResponseDTO<String> updateUser(@RequestBody @Valid UserUpdateForm updateForm) {
        return ResponseDTO.ok(userService.updateUser(updateForm));
    }

    @PostMapping("/delete")
    @SaCheckPermission("user:delete")
    public ResponseDTO<String> deleteUser(@RequestBody @Valid IdForm idForm) {
        return ResponseDTO.ok(userService.deleteUser(idForm.getId()));
    }

    @GetMapping("/list")
    @SaCheckPermission("user:query")
    public ResponseDTO<PageResult<UserVO>> getUserList(@RequestBody @Valid UserQueryForm queryForm) {
        return ResponseDTO.ok(userService.getUserList(queryForm));
    }

    // æ•°æ®æƒé™æ§åˆ¶ç¤ºä¾‹
    @GetMapping("/dept-users")
    @SaCheckPermission("user:query")
    public ResponseDTO<List<UserVO>> getDeptUsers(@RequestParam Long deptId) {
        // è·å–å½“å‰ç”¨æˆ·
        Long currentUserId = StpUtil.getLoginIdAsLong();

        // æ£€æŸ¥æ•°æ®æƒé™
        if (!dataPermissionService.hasDeptPermission(currentUserId, deptId)) {
            throw new BusinessException("NO_PERMISSION", "æ²¡æœ‰è®¿é—®è¯¥éƒ¨é—¨ç”¨æˆ·çš„æƒé™");
        }

        return ResponseDTO.ok(userService.getDeptUsers(deptId));
    }
}
```

## ğŸ”’ æ•°æ®å®‰å…¨è§„èŒƒ

### æ•æ„Ÿæ•°æ®å¤„ç†
```java
// æ•æ„Ÿæ•°æ®åŠ å¯†å·¥å…·ç±»
@Component
public class DataSecurityUtil {

    private static final String AES_KEY = "your-aes-key-here";

    /**
     * å¯†ç åŠ å¯†
     */
    public static String encryptPassword(String password) {
        return BCrypt.hashpw(password, BCrypt.gensalt());
    }

    /**
     * å¯†ç éªŒè¯
     */
    public static boolean checkPassword(String rawPassword, String encodedPassword) {
        return BCrypt.checkpw(rawPassword, encodedPassword);
    }

    /**
     * æ•æ„Ÿæ•°æ®AESåŠ å¯†
     */
    public static String encryptSensitiveData(String data) {
        try {
            AES aes = SecureUtil.aes(AES_KEY.getBytes());
            return aes.encryptHex(data);
        } catch (Exception e) {
            log.error("æ•°æ®åŠ å¯†å¤±è´¥", e);
            throw new BusinessException("ENCRYPT_ERROR", "æ•°æ®åŠ å¯†å¤±è´¥");
        }
    }

    /**
     * æ•æ„Ÿæ•°æ®AESè§£å¯†
     */
    public static String decryptSensitiveData(String encryptedData) {
        try {
            AES aes = SecureUtil.aes(AES_KEY.getBytes());
            return aes.decryptStr(encryptedData);
        } catch (Exception e) {
            log.error("æ•°æ®è§£å¯†å¤±è´¥", e);
            throw new BusinessException("DECRYPT_ERROR", "æ•°æ®è§£å¯†å¤±è´¥");
        }
    }
}

// æ•æ„Ÿå­—æ®µå¤„ç†
@Data
@TableName("t_user_info")
public class UserEntity extends BaseEntity {

    @TableId(type = IdType.ASSIGN_ID)
    private Long userId;

    @TableField("user_name")
    private String userName;

    @TableField("email")
    private String email;

    @TableField("phone")
    private String phone;

    @TableField("password")
    private String password; // BCryptåŠ å¯†å­˜å‚¨

    @TableField("id_card")
    private String idCard; // AESåŠ å¯†å­˜å‚¨

    @TableField("bank_card")
    private String bankCard; // AESåŠ å¯†å­˜å‚¨

    // æ•æ„Ÿæ•°æ®è·å–/è®¾ç½®æ–¹æ³•
    public void setIdCard(String idCard) {
        this.idCard = DataSecurityUtil.encryptSensitiveData(idCard);
    }

    public String getIdCard() {
        return StringUtils.isBlank(idCard) ? null : DataSecurityUtil.decryptSensitiveData(idCard);
    }

    public void setBankCard(String bankCard) {
        this.bankCard = DataSecurityUtil.encryptSensitiveData(bankCard);
    }

    public String getBankCard() {
        return StringUtils.isBlank(bankCard) ? null : DataSecurityUtil.decryptSensitiveData(bankCard);
    }
}
```

## ğŸš¨ å®‰å…¨é˜²æŠ¤å®ç°

### SQLæ³¨å…¥é˜²æŠ¤
```java
// MyBatis-Pluså®‰å…¨é…ç½®
@Configuration
public class MyBatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();

        // é˜²SQLæ³¨å…¥æ”»å‡»
        interceptor.addInnerInterceptor(new IllegalSQLInnerInterceptor());

        // åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));

        return interceptor;
    }
}

// å®‰å…¨æŸ¥è¯¢ç¤ºä¾‹
@Mapper
public interface UserDao extends BaseMapper<UserEntity> {

    // âœ… å®‰å…¨æŸ¥è¯¢ - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    @Select("SELECT * FROM t_user_info WHERE user_name = #{userName} AND deleted_flag = 0")
    UserEntity selectByUserName(@Param("userName") String userName);

    // âœ… å®‰å…¨æŸ¥è¯¢ - ä½¿ç”¨MyBatis-PlusæŸ¥è¯¢æ„é€ å™¨
    default UserEntity selectByPhone(String phone) {
        return this.lambdaQuery()
                .eq(UserEntity::getPhone, phone)
                .eq(UserEntity::getDeletedFlag, false)
                .one();
    }

    // âŒ å±é™©æŸ¥è¯¢ - ç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥
    // @Select("SELECT * FROM t_user_info WHERE user_name = '" + userName + "'")
    // UserEntity selectByUserNameDangerous(String userName);
}
```

### XSSé˜²æŠ¤
```java
// XSSè¿‡æ»¤å·¥å…·ç±»
@Component
public class XssFilterUtil {

    private static final String[] XSS_STRINGS = {
        "<script>", "</script>", "<img", "src=", "onerror=", "onload=",
        "javascript:", "vbscript:", "onload", "onerror", "onclick"
    };

    /**
     * æ¸…ç†XSSæ”»å‡»å­—ç¬¦ä¸²
     */
    public static String cleanXss(String value) {
        if (StringUtils.isBlank(value)) {
            return value;
        }

        String cleanValue = value;
        for (String xssString : XSS_STRINGS) {
            cleanValue = cleanValue.replace(xssString, "");
        }

        return cleanValue;
    }

    /**
     * æ¸…ç†HTMLæ ‡ç­¾
     */
    public static String cleanHtml(String value) {
        if (StringUtils.isBlank(value)) {
            return value;
        }

        return value.replaceAll("<[^>]*>", "");
    }
}

// Formå‚æ•°XSSè¿‡æ»¤
@Data
public class UserAddForm {

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Length(max = 50, message = "ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50")
    private String userName;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    // XSSè¿‡æ»¤çš„setteræ–¹æ³•
    public void setUserName(String userName) {
        this.userName = XssFilterUtil.cleanXss(userName);
    }

    public void setEmail(String email) {
        this.email = XssFilterUtil.cleanXss(email);
    }
}
```

## ğŸ“Š å®‰å…¨å®¡è®¡

### æ“ä½œæ—¥å¿—è®°å½•
```java
// æ“ä½œæ—¥å¿—æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface OperationLog {

    /**
     * æ“ä½œåç§°
     */
    String value() default "";

    /**
     * æ“ä½œç±»å‹
     */
    OperationType type() default OperationType.OTHER;

    /**
     * æ˜¯å¦è®°å½•è¯·æ±‚å‚æ•°
     */
    boolean saveRequestData() default true;

    /**
     * æ˜¯å¦è®°å½•å“åº”ç»“æœ
     */
    boolean saveResponseData() default false;
}

// æ“ä½œæ—¥å¿—åˆ‡é¢
@Aspect
@Component
@Slf4j
public class OperationLogAspect {

    @Resource
    private OperationLogService operationLogService;

    @Around("@annotation(operationLog)")
    public Object around(ProceedingJoinPoint point, OperationLog operationLog) throws Throwable {
        long startTime = System.currentTimeMillis();

        // è·å–æ“ä½œä¿¡æ¯
        String methodName = point.getSignature().getName();
        Object[] args = point.getArgs();
        Long userId = StpUtil.getLoginIdAsLong();

        try {
            // æ‰§è¡Œæ–¹æ³•
            Object result = point.proceed();
            long endTime = System.currentTimeMillis();

            // è®°å½•æˆåŠŸæ—¥å¿—
            if (operationLog.saveResponseData()) {
                saveOperationLog(userId, methodName, args, result,
                    operationLog.type(), true, endTime - startTime);
            }

            return result;

        } catch (Exception e) {
            long endTime = System.currentTimeMillis();

            // è®°å½•å¤±è´¥æ—¥å¿—
            saveOperationLog(userId, methodName, args, e.getMessage(),
                operationLog.type(), false, endTime - startTime);

            throw e;
        }
    }

    private void saveOperationLog(Long userId, String methodName, Object[] args,
                                 Object result, OperationType type, boolean success,
                                 long costTime) {
        OperationLogEntity log = new OperationLogEntity();
        log.setUserId(userId);
        log.setMethodName(methodName);
        log.setRequestArgs(JSON.toJSONString(args));
        log.setResult(JSON.toJSONString(result));
        log.setOperationType(type.getCode());
        log.setSuccess(success);
        log.setCostTime(costTime);
        log.setCreateTime(LocalDateTime.now());

        operationLogService.save(log);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
@RequestMapping("/api/user")
public class UserController {

    @PostMapping("/add")
    @OperationLog(value = "æ–°å¢ç”¨æˆ·", type = OperationType.CREATE)
    public ResponseDTO<String> addUser(@RequestBody @Valid UserAddForm addForm) {
        return ResponseDTO.ok(userService.addUser(addForm));
    }

    @PostMapping("/delete")
    @OperationLog(value = "åˆ é™¤ç”¨æˆ·", type = OperationType.DELETE, saveResponseData = false)
    public ResponseDTO<String> deleteUser(@RequestBody @Valid IdForm idForm) {
        return ResponseDTO.ok(userService.deleteUser(idForm.getId()));
    }
}
```
```

---

## ğŸ“š å¼•ç”¨æœ¬æ–‡æ¡£

å…¶ä»–æ–‡æ¡£åº”é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼•ç”¨æœ¬æ–‡æ¡£å†…å®¹ï¼š

### Sa-Tokenå®‰å…¨è§„èŒƒå¼•ç”¨
```markdown
è®¤è¯æˆæƒè¯¦è§ [å®‰å…¨è§„èŒƒ - Sa-Tokenå®ç°](./01-æ ¸å¿ƒè§„èŒƒå±‚/å®‰å…¨è§„èŒƒ.md#sa-tokenè®¤è¯æˆæƒè§„èŒƒ)
```

### æ•°æ®å®‰å…¨è§„èŒƒå¼•ç”¨
```markdown
æ•æ„Ÿæ•°æ®å¤„ç†è¯¦è§ [å®‰å…¨è§„èŒƒ - æ•°æ®å®‰å…¨](./01-æ ¸å¿ƒè§„èŒƒå±‚/å®‰å…¨è§„èŒƒ.md#æ•°æ®å®‰å…¨è§„èŒƒ)
```

### å®‰å…¨é˜²æŠ¤è§„èŒƒå¼•ç”¨
```markdown
SQLæ³¨å…¥é˜²æŠ¤è¯¦è§ [å®‰å…¨è§„èŒƒ - å®‰å…¨é˜²æŠ¤](./01-æ ¸å¿ƒè§„èŒƒå±‚/å®‰å…¨è§„èŒƒ.md#å®‰å…¨é˜²æŠ¤å®ç°)
```

---

**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼š
1. **Sa-Tokenä¼˜å…ˆ** - ç»Ÿä¸€ä½¿ç”¨Sa-Tokenè¿›è¡Œè®¤è¯æˆæƒ
2. **å¤šå±‚é˜²æŠ¤** - è®¤è¯ã€æˆæƒã€æ•°æ®ã€ä¼ è¾“å¤šå±‚å®‰å…¨ä¿æŠ¤
3. **ä¸»åŠ¨é˜²æŠ¤** - é¢„é˜²ä¸ºä¸»ï¼Œæ£€æµ‹ä¸ºè¾…
4. **å®¡è®¡è¿½è¸ª** - å®Œæ•´çš„å®‰å…¨å®¡è®¡æ—¥å¿—
5. **æŒç»­æ”¹è¿›** - åŸºäºå¨èƒæƒ…æŠ¥æŒç»­ä¼˜åŒ–

**ğŸ“– ç›¸å…³æƒå¨æ–‡æ¡£**ï¼š
- [æ¶æ„è§„èŒƒ](./æ¶æ„è§„èŒƒ.md) - æ¶æ„å®‰å…¨è®¾è®¡
- [ç¼–ç è§„èŒƒ](./ç¼–ç è§„èŒƒ.md) - å®‰å…¨ç¼–ç è§„èŒƒ
- [APIè§„èŒƒ](./APIè§„èŒƒ.md) - APIå®‰å…¨è®¾è®¡
- [æ•°æ®è§„èŒƒ](./æ•°æ®è§„èŒƒ.md) - æ•°æ®å®‰å…¨è§„èŒƒ
- [æœ€ä½³å®è·µæ¡ˆä¾‹](../04-çŸ¥è¯†ç®¡ç†å±‚/æœ€ä½³å®è·µæ¡ˆä¾‹.md) - å®‰å…¨å®è·µæ¡ˆä¾‹
```java
@SaCheckLogin
@RestController
@RequestMapping("/api/users")
public class UserController {

    @SaCheckPermission("user:add")
    @PostMapping("/add")
    public ResponseDTO<String> add(@RequestBody @Valid UserAddForm addForm) {
        return ResponseDTO.ok(userService.add(addForm));
    }

    @SaCheckPermission("user:update")
    @PostMapping("/update")
    public ResponseDTO<String> update(@RequestBody @Valid UserUpdateForm updateForm) {
        return ResponseDTO.ok(userService.update(updateForm));
    }

    @SaCheckRole("admin")
    @PostMapping("/batch-delete")
    public ResponseDTO<String> batchDelete(@RequestBody @Valid IdForm idForm) {
        return ResponseDTO.ok(userService.batchDelete(idForm.getIds()));
    }
}
```

## ğŸ”’ æ•°æ®å®‰å…¨è§„èŒƒ

### æ•æ„Ÿæ•°æ®å¤„ç†
```markdown
âœ… å¯†ç ä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
âœ… èº«ä»½è¯å·ã€æ‰‹æœºå·ç­‰æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
âœ… é“¶è¡Œå¡å·ç­‰é‡‘èä¿¡æ¯ä½¿ç”¨ä¸“ç”¨åŠ å¯†ç®—æ³•
âœ… æ•°æ®åº“è¿æ¥ä¿¡æ¯åŠ å¯†é…ç½®
âœ… APIå¯†é’¥å’Œè¯ä¹¦å®‰å…¨å­˜å‚¨
âœ… æ•æ„Ÿæ–‡ä»¶åŠ å¯†å­˜å‚¨
âœ… æ•°æ®åº“æ•æ„Ÿå­—æ®µåŠ å¯†
âœ… æ—¥å¿—ä¸­æ•æ„Ÿä¿¡æ¯è„±æ•
```

### æ•°æ®è„±æ•è§„åˆ™
```java
@Component
public class DataMaskingUtil {

    /**
     * æ‰‹æœºå·è„±æ•ï¼š138****5678
     */
    public static String maskPhone(String phone) {
        if (StringUtils.isBlank(phone) || phone.length() < 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }

    /**
     * èº«ä»½è¯å·è„±æ•ï¼š110101********1234
     */
    public static String maskIdCard(String idCard) {
        if (StringUtils.isBlank(idCard) || idCard.length() < 18) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }

    /**
     * é‚®ç®±è„±æ•ï¼šz***@example.com
     */
    public static String maskEmail(String email) {
        if (StringUtils.isBlank(email) || !email.contains("@")) {
            return email;
        }
        String[] parts = email.split("@");
        String username = parts[0];
        if (username.length() > 1) {
            username = username.charAt(0) + "***" + username.charAt(username.length() - 1);
        }
        return username + "@" + parts[1];
    }
}
```

## ğŸ›¡ï¸ è¾“å…¥éªŒè¯è§„èŒƒ

### å‚æ•°éªŒè¯
```markdown
âœ… ä½¿ç”¨@Validæ³¨è§£è¿›è¡Œå‚æ•°éªŒè¯
âœ… å®ç°è‡ªå®šä¹‰éªŒè¯è§„åˆ™
âœ… é˜²æ­¢SQLæ³¨å…¥æ”»å‡»
âœ… é˜²æ­¢XSSè·¨ç«™è„šæœ¬æ”»å‡»
âœ… é˜²æ­¢CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ 
âœ… æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ£€æŸ¥
âœ… é˜²æ­¢XMLå¤–éƒ¨å®ä½“æ”»å‡»
âœ… å®ç°è¾“å…¥é•¿åº¦é™åˆ¶
```

### éªŒè¯å®ç°ç¤ºä¾‹
```java
@Data
public class UserAddForm {

    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Length(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String userName;

    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Length(min = 8, max = 20, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨8-20ä¹‹é—´")
    @Pattern(regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]+$",
             message = "å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦")
    private String password;

    @NotBlank(message = "é‚®ç®±ä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    @NotBlank(message = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")
    private String phone;
}
```

## ğŸŒ ç½‘ç»œå®‰å…¨è§„èŒƒ

### HTTPSé…ç½®
```markdown
âœ… å…¨ç«™å¯ç”¨HTTPS
âœ… é…ç½®å¼ºåŠ å¯†ç®—æ³•
âœ… ç¦ç”¨å¼±SSL/TLSç‰ˆæœ¬
âœ… å®ç°HSTSï¼ˆHTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨ï¼‰
âœ… é…ç½®å®‰å…¨çš„Cookieå±æ€§
âœ… å®ç°CSPï¼ˆå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰
âœ… é˜²æ­¢ç‚¹å‡»åŠ«æŒæ”»å‡»
âœ… å®šæœŸæ›´æ–°SSLè¯ä¹¦
```

### è·¨åŸŸå¤„ç†
```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("https://admin.example.com")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

## ğŸ“‹ å®‰å…¨å®¡è®¡è§„èŒƒ

### æ“ä½œæ—¥å¿—
```markdown
âœ… è®°å½•æ‰€æœ‰ç”¨æˆ·ç™»å½•æ“ä½œ
âœ… è®°å½•æ‰€æœ‰æ•æ„Ÿæ•°æ®è®¿é—®
âœ… è®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œ
âœ… è®°å½•æ‰€æœ‰ç³»ç»Ÿé…ç½®ä¿®æ”¹
âœ… è®°å½•æ‰€æœ‰å¼‚å¸¸å’Œé”™è¯¯
âœ… å®ç°æ—¥å¿—å®Œæ•´æ€§æ ¡éªŒ
âœ… å®šæœŸå¤‡ä»½å®¡è®¡æ—¥å¿—
âœ… å»ºç«‹æ—¥å¿—åˆ†ææœºåˆ¶
```

### å®¡è®¡æ—¥å¿—å®ç°
```java
@Aspect
@Component
@Slf4j
public class AuditLogAspect {

    @Around("@annotation(auditLog)")
    public Object around(ProceedingJoinPoint point, AuditLog auditLog) throws Throwable {
        String methodName = point.getSignature().getName();
        Object[] args = point.getArgs();

        // è®°å½•æ“ä½œå¼€å§‹
        log.info("ç”¨æˆ·æ“ä½œå¼€å§‹ - æ–¹æ³•: {}, å‚æ•°: {}", methodName, args);

        try {
            Object result = point.proceed();

            // è®°å½•æ“ä½œæˆåŠŸ
            log.info("ç”¨æˆ·æ“ä½œæˆåŠŸ - æ–¹æ³•: {}, ç»“æœ: {}", methodName, result);

            // å¼‚æ­¥ä¿å­˜å®¡è®¡æ—¥å¿—
            asyncSaveAuditLog(methodName, args, result, "SUCCESS");

            return result;
        } catch (Exception e) {
            // è®°å½•æ“ä½œå¤±è´¥
            log.error("ç”¨æˆ·æ“ä½œå¤±è´¥ - æ–¹æ³•: {}, å¼‚å¸¸: {}", methodName, e.getMessage(), e);

            // å¼‚æ­¥ä¿å­˜å®¡è®¡æ—¥å¿—
            asyncSaveAuditLog(methodName, args, null, "FAILED: " + e.getMessage());

            throw e;
        }
    }
}
```

## ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µæ£€æŸ¥
```markdown
â–¡ æ˜¯å¦è¿›è¡Œè¾“å…¥éªŒè¯ï¼Ÿ
â–¡ æ˜¯å¦é˜²æ­¢SQLæ³¨å…¥ï¼Ÿ
â–¡ æ˜¯å¦é˜²æ­¢XSSæ”»å‡»ï¼Ÿ
â–¡ æ˜¯å¦å®ç°æƒé™æ§åˆ¶ï¼Ÿ
â–¡ æ˜¯å¦ä½¿ç”¨HTTPSï¼Ÿ
â–¡ æ˜¯å¦åŠ å¯†æ•æ„Ÿæ•°æ®ï¼Ÿ
â–¡ æ˜¯å¦è®°å½•å®¡è®¡æ—¥å¿—ï¼Ÿ
â–¡ æ˜¯å¦è¿›è¡Œå®‰å…¨æµ‹è¯•ï¼Ÿ
```

### éƒ¨ç½²é˜¶æ®µæ£€æŸ¥
```markdown
â–¡ æ˜¯å¦é…ç½®é˜²ç«å¢™ï¼Ÿ
â–¡ æ˜¯å¦æ›´æ–°å®‰å…¨è¡¥ä¸ï¼Ÿ
â–¡ æ˜¯å¦ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡ï¼Ÿ
â–¡ æ˜¯å¦é…ç½®å®‰å…¨ç›‘æ§ï¼Ÿ
â–¡ æ˜¯å¦å»ºç«‹å¤‡ä»½æœºåˆ¶ï¼Ÿ
â–¡ æ˜¯å¦åˆ¶å®šåº”æ€¥é¢„æ¡ˆï¼Ÿ
â–¡ æ˜¯å¦è¿›è¡Œå®‰å…¨æ‰«æï¼Ÿ
â–¡ æ˜¯å¦è¿›è¡Œæ¸—é€æµ‹è¯•ï¼Ÿ
```

---

**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼š
1. **å®‰å…¨ç¬¬ä¸€** - å®‰å…¨æ˜¯æœ€é‡è¦çš„è€ƒé‡
2. **çºµæ·±é˜²å¾¡** - å¤šå±‚æ¬¡å®‰å…¨é˜²æŠ¤
3. **æœ€å°æƒé™** - åªç»™äºˆå¿…è¦çš„æƒé™
4. **æŒç»­ç›‘æ§** - å®æ—¶å®‰å…¨ç›‘æ§
5. **å¿«é€Ÿå“åº”** - åŠæ—¶å®‰å…¨äº‹ä»¶å“åº”

**ğŸ“– ç›¸å…³æ–‡æ¡£**ï¼š
- [æ¶æ„è§„èŒƒ](./æ¶æ„è§„èŒƒ.md) - ç³»ç»Ÿå®‰å…¨æ¶æ„
- [ç¼–ç è§„èŒƒ](./ç¼–ç è§„èŒƒ.md) - å®‰å…¨ç¼–ç è§„èŒƒ
- [APIè§„èŒƒ](./APIè§„èŒƒ.md) - APIå®‰å…¨è§„èŒƒ