# äººå‘˜åŒºåŸŸç®¡ç†æ¶æ„è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

äººå‘˜åŒºåŸŸç®¡ç†æ˜¯IOE-DREAMé¡¹ç›®çš„æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†äººå‘˜ä¸åŒºåŸŸçš„å…³è”å…³ç³»ï¼Œå¹¶è‡ªåŠ¨è§¦å‘ç›¸å…³è®¾å¤‡çš„æ•°æ®åŒæ­¥ã€‚è¯¥æ¨¡å—åŸºäºç»Ÿä¸€çš„åŒºåŸŸç®¡ç†å’Œè®¾å¤‡é€‚é…å™¨æ¶æ„ï¼Œä¸ºå„ä¸šåŠ¡æ¨¡å—æä¾›äººå‘˜æƒé™æ§åˆ¶çš„ç»Ÿä¸€æœåŠ¡ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äººå‘˜åŒºåŸŸç®¡ç†æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸šåŠ¡æ¥å…¥å±‚ (Controller)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PersonAreaController                                   â”‚  â”‚
â”‚  â”‚  - CRUDæ“ä½œ                                              â”‚  â”‚
â”‚  â”‚  - æƒé™æ£€æŸ¥                                              â”‚  â”‚
â”‚  â”‚  - æ•°æ®åŒæ­¥                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœåŠ¡å±‚ (Service)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PersonAreaServiceImpl                                  â”‚  â”‚
â”‚  â”‚  - ä¸šåŠ¡é€»è¾‘å¤„ç†                                          â”‚  â”‚
â”‚  â”‚  - äº‹åŠ¡ç®¡ç†                                              â”‚  â”‚
â”‚  â”‚  - æ•°æ®éªŒè¯                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼“å­˜ç®¡ç†å±‚ (Manager)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PersonAreaCacheManager                                  â”‚  â”‚
â”‚  â”‚  - L1æœ¬åœ°ç¼“å­˜ (Caffeine)                                â”‚  â”‚
â”‚  â”‚  - L2åˆ†å¸ƒå¼ç¼“å­˜ (Redis)                                  â”‚  â”‚
â”‚  â”‚  - L3æ•°æ®åº“ç¼“å­˜                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¾å¤‡ä¸‹å‘å±‚ (Engine)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DeviceDispatchEngine                                    â”‚  â”‚
â”‚  â”‚  - ç­–ç•¥åŒ¹é…                                              â”‚  â”‚
â”‚  â”‚  - åè®®é€‚é…                                              â”‚  â”‚
â”‚  â”‚  - å¼‚æ­¥æ‰§è¡Œ                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®è®¿é—®å±‚ (DAO)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PersonAreaRelationDao                                  â”‚  â”‚
â”‚  â”‚  - MyBatis-Plus CRUD                                    â”‚  â”‚
â”‚  â”‚  - å¤æ‚æŸ¥è¯¢                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å­˜å‚¨å±‚ (Database)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  t_person_area_relation                                  â”‚  â”‚
â”‚  â”‚  t_device_dispatch_strategy                              â”‚  â”‚
â”‚  â”‚  t_device_dispatch_record                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„**: ä¸¥æ ¼æŒ‰ç…§Controller â†’ Service â†’ Manager â†’ DAOçš„åˆ†å±‚æ¶æ„
2. **ç¼“å­˜ä¼˜å…ˆ**: å¤šçº§ç¼“å­˜ç­–ç•¥ï¼Œæä¾›é«˜æ€§èƒ½çš„æƒé™æ£€æŸ¥
3. **å¼‚æ­¥å¤„ç†**: è®¾å¤‡æ•°æ®åŒæ­¥å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸šåŠ¡æµç¨‹
4. **äº‹åŠ¡ä¸€è‡´**: å…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **å¯æ‰©å±•æ€§**: åŸºäºç­–ç•¥æ¨¡å¼çš„è®¾å¤‡ä¸‹å‘æœºåˆ¶ï¼Œæ”¯æŒæ–°è®¾å¤‡ç±»å‹æ‰©å±•

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### æ ¸å¿ƒè¡¨ç»“æ„

#### t_person_area_relation (äººå‘˜åŒºåŸŸå…³è”è¡¨)

```sql
CREATE TABLE `t_person_area_relation` (
  `relation_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'å…³è”ID',
  `person_id` BIGINT NOT NULL COMMENT 'äººå‘˜ID',
  `person_type` VARCHAR(32) NOT NULL COMMENT 'äººå‘˜ç±»å‹',
  `person_name` VARCHAR(100) NULL COMMENT 'äººå‘˜å§“å',
  `person_code` VARCHAR(50) NULL COMMENT 'äººå‘˜ç¼–å·',
  `area_id` BIGINT NOT NULL COMMENT 'åŒºåŸŸID',
  `relation_type` VARCHAR(32) NOT NULL COMMENT 'å…³è”ç±»å‹',
  `effective_time` DATETIME NOT NULL COMMENT 'ç”Ÿæ•ˆæ—¶é—´',
  `expire_time` DATETIME NULL COMMENT 'å¤±æ•ˆæ—¶é—´',
  `sync_device_types` JSON NULL COMMENT 'éœ€è¦åŒæ­¥çš„è®¾å¤‡ç±»å‹åˆ—è¡¨',
  `sync_config` JSON NULL COMMENT 'åŒæ­¥é…ç½®',
  `priority_level` INT NULL COMMENT 'ä¼˜å…ˆçº§',
  `auto_renew` BOOLEAN NULL COMMENT 'æ˜¯å¦è‡ªåŠ¨ç»­æœŸ',
  `renew_days` INT NULL COMMENT 'è‡ªåŠ¨ç»­æœŸå¤©æ•°',
  `status` INT NULL COMMENT 'çŠ¶æ€',
  `sync_status` INT NULL COMMENT 'åŒæ­¥çŠ¶æ€',
  `last_sync_time` DATETIME NULL COMMENT 'æœ€ååŒæ­¥æ—¶é—´',
  `sync_device_type_desc_list` JSON NULL COMMENT 'åŒæ­¥è®¾å¤‡ç±»å‹æè¿°åˆ—è¡¨',
  `remark` VARCHAR(500) NULL COMMENT 'å¤‡æ³¨ä¿¡æ¯',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `create_user_id` BIGINT NULL COMMENT 'åˆ›å»ºç”¨æˆ·ID',
  `update_user_id` BIGINT NULL COMMENT 'æ›´æ–°ç”¨æˆ·ID',
  `deleted_flag` TINYINT NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°',
  `version` INT NOT NULL DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
  PRIMARY KEY (`relation_id`),
  UNIQUE KEY `uk_person_area` (`person_id`, `area_id`, `deleted_flag`),
  KEY `idx_person_id` (`person_id`),
  KEY `idx_area_id` (`area_id`),
  KEY `idx_status` (`status`),
  KEY `idx_sync_status` (`sync_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='äººå‘˜åŒºåŸŸå…³è”è¡¨';
```

#### t_device_dispatch_strategy (è®¾å¤‡ä¸‹å‘ç­–ç•¥è¡¨)

```sql
CREATE TABLE `t_device_dispatch_strategy` (
  `strategy_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ç­–ç•¥ID',
  `strategy_name` VARCHAR(100) NOT NULL COMMENT 'ç­–ç•¥åç§°',
  `strategy_type` VARCHAR(32) NOT NULL COMMENT 'ç­–ç•¥ç±»å‹',
  `device_type` VARCHAR(32) NOT NULL COMMENT 'è®¾å¤‡ç±»å‹',
  `device_category` VARCHAR(32) NULL COMMENT 'è®¾å¤‡ç±»åˆ«',
  `manufacturer` VARCHAR(50) NOT NULL COMMENT 'åˆ¶é€ å•†',
  `protocol_type` VARCHAR(32) NOT NULL COMMENT 'åè®®ç±»å‹',
  `priority_level` INT NOT NULL COMMENT 'ä¼˜å…ˆçº§',
  `config_template` JSON NULL COMMENT 'é…ç½®æ¨¡æ¿',
  `dispatch_rules` JSON NULL COMMENT 'ä¸‹å‘è§„åˆ™',
  `retry_config` JSON NULL COMMENT 'é‡è¯•é…ç½®',
  `status` INT NOT NULL COMMENT 'çŠ¶æ€',
  `remark` VARCHAR(500) NULL COMMENT 'å¤‡æ³¨ä¿¡æ¯',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `create_user_id` BIGINT NULL COMMENT 'åˆ›å»ºç”¨æˆ·ID',
  `update_user_id` BIGINT NULL COMMENT 'æ›´æ–°ç”¨æˆ·ID',
  `deleted_flag` TINYINT NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°',
  `version` INT NOT NULL DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
  PRIMARY KEY (`strategy_id`),
  KEY `idx_device_type` (`device_type`),
  KEY `idx_manufacturer` (`manufacturer`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è®¾å¤‡ä¸‹å‘ç­–ç•¥è¡¨';
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### PersonAreaService (æœåŠ¡æ¥å£)

```java
public interface PersonAreaService {
    // CRUDæ“ä½œ
    ResponseDTO<Long> addPersonAreaRelation(PersonAreaRelationForm form);
    ResponseDTO<Void> updatePersonAreaRelation(PersonAreaRelationForm form);
    ResponseDTO<Void> deletePersonAreaRelation(Long relationId);
    ResponseDTO<Void> batchDeletePersonAreaRelation(List<Long> relationIds);

    // æŸ¥è¯¢æ“ä½œ
    ResponseDTO<PersonAreaRelationVO> getPersonAreaRelationById(Long relationId);
    ResponseDTO<PageResult<PersonAreaRelationVO>> queryPersonAreaRelationPage(PersonAreaRelationForm form);
    ResponseDTO<List<PersonAreaRelationVO>> getPersonAreaRelations(Long personId);
    ResponseDTO<List<PersonAreaRelationVO>> getAreaPersonRelations(Long areaId);

    // æƒé™æ£€æŸ¥
    ResponseDTO<List<AreaSimpleVO>> getPersonAccessibleAreas(Long personId);
    ResponseDTO<Boolean> checkPersonAreaPermission(Long personId, Long areaId);

    // æ‰¹é‡æ“ä½œ
    ResponseDTO<String> batchAddPersonAreaRelation(BatchPersonAreaRelationForm form);

    // è®¾å¤‡åŒæ­¥
    ResponseDTO<String> triggerDeviceSync(TriggerSyncForm form);
    ResponseDTO<String> batchTriggerDeviceSync(BatchTriggerSyncForm form);
    ResponseDTO<String> retryFailedSync(RetrySyncForm form);

    // çŠ¶æ€ç®¡ç†
    ResponseDTO<Void> updateRelationStatus(Long relationId, Integer status);
    ResponseDTO<String> autoRenewExpiredRelations(AutoRenewForm form);

    // æ•°æ®ç®¡ç†
    ResponseDTO<String> exportPersonAreaRelation(PersonAreaRelationForm form);
    ResponseDTO<String> importPersonAreaRelation(ImportPersonAreaRelationForm form);
    ResponseDTO<PersonAreaStatisticsVO> getPersonAreaStatistics();
}
```

### PersonAreaCacheManager (ç¼“å­˜ç®¡ç†å™¨)

```java
@Component
public class PersonAreaCacheManager {

    // L1æœ¬åœ°ç¼“å­˜ (Caffeine)
    private final Cache<String, Object> localCache;

    // L2åˆ†å¸ƒå¼ç¼“å­˜ (Redis)
    private final RedisTemplate<String, Object> redisTemplate;

    // ç¼“å­˜é”®å¸¸é‡
    private static final String CACHE_PREFIX = "person:area:relation:";
    private static final String PERSON_CACHE_PREFIX = "person:";
    private static final String AREA_CACHE_PREFIX = "area:";

    /**
     * è·å–äººå‘˜åŒºåŸŸå…³è”å…³ç³» (L1â†’L2â†’L3)
     */
    public List<PersonAreaRelationEntity> getPersonAreaRelations(Long personId);

    /**
     * è·å–åŒºåŸŸäººå‘˜å…³è”å…³ç³»
     */
    public List<PersonAreaRelationEntity> getAreaPersonRelations(Long areaId);

    /**
     * æ£€æŸ¥äººå‘˜æ˜¯å¦æœ‰åŒºåŸŸæƒé™
     */
    public boolean hasAreaPermission(Long personId, Long areaId);

    /**
     * ç¼“å­˜å¤±æ•ˆæ“ä½œ
     */
    public void evictPersonCache(Long personId);
    public void evictAreaCache(Long areaId);
    public void evictRelationCache(Long relationId);
}
```

### DeviceDispatchEngine (è®¾å¤‡ä¸‹å‘å¼•æ“)

```java
@Component
public class DeviceDispatchEngine {

    @Resource
    private DeviceProtocolAdapterFactory adapterFactory;

    @Resource
    private PersonAreaCacheManager cacheManager;

    /**
     * è§¦å‘äººå‘˜åŒºåŸŸå…³è”çš„è®¾å¤‡åŒæ­¥
     */
    @Async("dispatchExecutor")
    @Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000, multiplier = 2))
    public void triggerDispatchForRelation(Long relationId);

    /**
     * è§¦å‘äººå‘˜åŒºåŸŸå…³è”çš„è®¾å¤‡åŒæ­¥ (æŒ‡å®šè®¾å¤‡ç±»å‹)
     */
    @Async("dispatchExecutor")
    public void triggerDispatchForRelation(Long relationId, List<String> deviceTypes, boolean forceResync);

    /**
     * æ‰¹é‡è§¦å‘è®¾å¤‡åŒæ­¥
     */
    @Async("dispatchExecutor")
    public void batchTriggerDispatch(List<Long> relationIds);
}
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åŸºæœ¬CRUDæ“ä½œ

```java
@Service
public class PersonAreaBusinessService {

    @Resource
    private PersonAreaService personAreaService;

    public void addPersonAreaPermission(Long personId, Long areaId, String personType) {
        // æ„å»ºå…³è”è¡¨å•
        PersonAreaRelationForm form = new PersonAreaRelationForm();
        form.setPersonId(personId);
        form.setAreaId(areaId);
        form.setPersonType(personType);
        form.setRelationType("PRIMARY"); // ä¸»å½’å±
        form.setEffectiveTime(LocalDateTime.now());
        form.setSyncDeviceTypes(List.of("ACCESS", "ATTENDANCE")); // åŒæ­¥åˆ°é—¨ç¦å’Œè€ƒå‹¤è®¾å¤‡

        // æ·»åŠ å…³è”
        ResponseDTO<Long> result = personAreaService.addPersonAreaRelation(form);
        if (!result.getOk()) {
            throw new BusinessException("æ·»åŠ äººå‘˜åŒºåŸŸæƒé™å¤±è´¥: " + result.getMsg());
        }

        log.info("äººå‘˜åŒºåŸŸæƒé™æ·»åŠ æˆåŠŸ: personId={}, areaId={}, relationId={}",
                personId, areaId, result.getData());
    }
}
```

### æƒé™æ£€æŸ¥

```java
@Service
public class PermissionService {

    @Resource
    private PersonAreaService personAreaService;

    public boolean checkAreaPermission(Long userId, Long areaId, String requiredPermission) {
        // 1. æ£€æŸ¥äººå‘˜åŒºåŸŸå…³è”
        ResponseDTO<Boolean> permissionResult = personAreaService.checkPersonAreaPermission(userId, areaId);
        if (!permissionResult.getOk() || !permissionResult.getData()) {
            return false;
        }

        // 2. æ£€æŸ¥åŒºåŸŸæƒé™ç­‰çº§
        // TODO: å®ç°å…·ä½“çš„æƒé™ç­‰çº§æ£€æŸ¥é€»è¾‘

        return true;
    }

    public List<AreaSimpleVO> getUserAccessibleAreas(Long userId) {
        ResponseDTO<List<AreaSimpleVO>> result = personAreaService.getPersonAccessibleAreas(userId);
        if (result.getOk()) {
            return result.getData();
        }
        return List.of();
    }
}
```

### è®¾å¤‡åŒæ­¥ç®¡ç†

```java
@Service
public class DeviceSyncService {

    @Resource
    private PersonAreaService personAreaService;

    public void syncPersonToDevice(Long personId, Long areaId, List<String> deviceTypes) {
        // 1. æŸ¥è¯¢äººå‘˜åŒºåŸŸå…³è”
        ResponseDTO<List<PersonAreaRelationVO>> relationsResult =
            personAreaService.getPersonAreaRelations(personId);

        if (!relationsResult.getOk()) {
            throw new BusinessException("æŸ¥è¯¢äººå‘˜åŒºåŸŸå…³è”å¤±è´¥");
        }

        // 2. æ‰¾åˆ°å¯¹åº”åŒºåŸŸçš„å…³è”
        PersonAreaRelationVO targetRelation = relationsResult.getData().stream()
            .filter(relation -> relation.getAreaId().equals(areaId))
            .filter(relation -> relation.getActive())
            .findFirst()
            .orElse(null);

        if (targetRelation == null) {
            throw new BusinessException("æœªæ‰¾åˆ°æœ‰æ•ˆçš„åŒºåŸŸå…³è”");
        }

        // 3. è§¦å‘è®¾å¤‡åŒæ­¥
        TriggerSyncForm syncForm = new TriggerSyncForm();
        syncForm.setRelationId(targetRelation.getRelationId());
        syncForm.setDeviceTypes(deviceTypes);
        syncForm.setForceResync(true);

        ResponseDTO<String> syncResult = personAreaService.triggerDeviceSync(syncForm);
        if (!syncResult.getOk()) {
            throw new BusinessException("è§¦å‘è®¾å¤‡åŒæ­¥å¤±è´¥: " + syncResult.getMsg());
        }

        log.info("è®¾å¤‡åŒæ­¥å·²è§¦å‘: personId={}, areaId={}, deviceTypes={}",
                personId, areaId, deviceTypes);
    }
}
```

### æ‰¹é‡æ“ä½œ

```java
@Service
public class BatchPersonAreaService {

    @Resource
    private PersonAreaService personAreaService;

    public void assignEmployeesToArea(List<Long> employeeIds, Long areaId) {
        BatchPersonAreaRelationForm batchForm = new BatchPersonAreaRelationForm();
        batchForm.setPersonIds(employeeIds);
        batchForm.setAreaId(areaId);
        batchForm.setPersonType("EMPLOYEE");
        batchForm.setRelationType("PRIMARY");
        batchForm.setEffectiveTime(LocalDateTime.now());
        batchForm.setSyncDeviceTypes(List.of("ACCESS", "ATTENDANCE", "CONSUME"));
        batchForm.setPriorityLevel(5);
        batchForm.setOverwriteExisting(false);

        ResponseDTO<String> result = personAreaService.batchAddPersonAreaRelation(batchForm);
        if (!result.getOk()) {
            throw new BusinessException("æ‰¹é‡åˆ†é…å‘˜å·¥åˆ°åŒºåŸŸå¤±è´¥: " + result.getMsg());
        }

        log.info("æ‰¹é‡åˆ†é…å‘˜å·¥åˆ°åŒºåŸŸå®Œæˆ: employeeCount={}, areaId={}", employeeIds.size(), areaId);
    }
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å¤šçº§ç¼“å­˜ç­–ç•¥

1. **L1æœ¬åœ°ç¼“å­˜ (Caffeine)**:
   - ç¼“å­˜å®¹é‡: 1000ä¸ªå¯¹è±¡
   - è¿‡æœŸæ—¶é—´: 10åˆ†é’Ÿ
   - è®¿é—®é€Ÿåº¦å¿«ï¼Œæ— ç½‘ç»œå¼€é”€

2. **L2åˆ†å¸ƒå¼ç¼“å­˜ (Redis)**:
   - ç¼“å­˜å®¹é‡: æ— é™åˆ¶
   - è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
   - æ”¯æŒé›†ç¾¤å…±äº«

3. **L3æ•°æ®åº“æŸ¥è¯¢**:
   - ä½œä¸ºæœ€åçš„ç¼“å­˜å±‚
   - æŸ¥è¯¢ç»“æœç¼“å­˜1åˆ†é’Ÿ

### ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

```java
@Component
public class CacheMonitor {

    @EventListener
    public void handleCacheHit(CacheHitEvent event) {
        // è®°å½•ç¼“å­˜å‘½ä¸­
        log.debug("ç¼“å­˜å‘½ä¸­: key={}, type={}", event.getKey(), event.getType());
    }

    @EventListener
    public void handleCacheMiss(CacheMissEvent event) {
        // è®°å½•ç¼“å­˜æœªå‘½ä¸­
        log.debug("ç¼“å­˜æœªå‘½ä¸­: key={}, type={}", event.getKey(), event.getType());
    }

    public void printCacheStatistics() {
        // æ‰“å°ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
        log.info("L1ç¼“å­˜å‘½ä¸­ç‡: {:.2f}%", localCache.stats().hitRate() * 100);
        // TODO: å®ç°Redisç¼“å­˜ç»Ÿè®¡
    }
}
```

### å¼‚æ­¥å¤„ç†ä¼˜åŒ–

```java
@Configuration
@EnableAsync
public class AsyncConfig {

    @Bean("dispatchExecutor")
    public ThreadPoolTaskExecutor dispatchExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(1000);
        executor.setThreadNamePrefix("device-dispatch-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        return executor;
    }

    @Bean("syncExecutor")
    public ThreadPoolTaskExecutor syncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix("device-sync-");
        return executor;
    }
}
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æƒé™æ£€æŸ¥å¼‚å¸¸**
   - æ£€æŸ¥äººå‘˜IDå’ŒåŒºåŸŸIDæ˜¯å¦æœ‰æ•ˆ
   - ç¡®è®¤å…³è”å…³ç³»æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…
   - æŸ¥çœ‹ç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œ

2. **è®¾å¤‡åŒæ­¥å¤±è´¥**
   - æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿é€šæ€§
   - éªŒè¯è®¾å¤‡é…ç½®å‚æ•°
   - æŸ¥çœ‹åŒæ­¥é”™è¯¯æ—¥å¿—

3. **ç¼“å­˜ä¸ä¸€è‡´**
   - æ¸…ç†ç›¸å…³ç¼“å­˜: `cacheManager.evictPersonCache(personId)`
   - æ£€æŸ¥Redisè¿æ¥çŠ¶æ€
   - éªŒè¯ç¼“å­˜é”®æ ¼å¼

### è°ƒè¯•æŠ€å·§

```java
@Slf4j
@Service
public class PersonAreaDebugService {

    @Resource
    private PersonAreaCacheManager cacheManager;

    @Resource
    private PersonAreaRelationDao personAreaRelationDao;

    public void debugPersonAreaCache(Long personId) {
        log.info("=== è°ƒè¯•äººå‘˜åŒºåŸŸç¼“å­˜ ===");
        log.info("äººå‘˜ID: {}", personId);

        // 1. æ£€æŸ¥ç¼“å­˜æ•°æ®
        List<PersonAreaRelationEntity> cachedRelations = cacheManager.getPersonAreaRelations(personId);
        log.info("ç¼“å­˜å…³è”æ•°é‡: {}", cachedRelations.size());

        // 2. æ£€æŸ¥æ•°æ®åº“æ•°æ®
        List<PersonAreaRelationEntity> dbRelations = personAreaRelationDao.selectList(
            new LambdaQueryWrapper<PersonAreaRelationEntity>()
                .eq(PersonAreaRelationEntity::getPersonId, personId)
                .eq(PersonAreaRelationEntity::getDeletedFlag, 0)
        );
        log.info("æ•°æ®åº“å…³è”æ•°é‡: {}", dbRelations.size());

        // 3. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
        if (cachedRelations.size() != dbRelations.size()) {
            log.warn("ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸ä¸€è‡´!");
            // é‡æ–°åŠ è½½ç¼“å­˜
            cacheManager.evictPersonCache(personId);
            cacheManager.getPersonAreaRelations(personId);
        }
    }
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è®¾å¤‡åè®®é€‚é…å™¨æ¶æ„è®¾è®¡](./è®¾å¤‡åè®®é€‚é…å™¨æ¶æ„è®¾è®¡.md)
- [SmartDeviceEntityå®ä½“è®¾è®¡](./æ•°æ®åº“è®¾è®¡/è®¾å¤‡å®ä½“è®¾è®¡.md)
- [ç¼“å­˜ç®¡ç†ç­–ç•¥](./ç¼“å­˜ç®¡ç†ç­–ç•¥.md)
- [å¼‚æ­¥ä»»åŠ¡å¤„ç†](./å¼‚æ­¥ä»»åŠ¡å¤„ç†.md)

---

**æœ€åæ›´æ–°**: 2025-11-24
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**ç»´æŠ¤å›¢é˜Ÿ**: SmartAdmin Team