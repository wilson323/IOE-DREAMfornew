# IOE-DREAM å…¨å±€æ¶æ„è®¾è®¡ç»¼åˆæŒ‡å—

> **ç‰ˆæœ¬**: v2.0.0 - ä¼ä¸šçº§å¢å¼ºç‰ˆ
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-16
> **ä½œè€…**: æ¶æ„å¸ˆå›¢é˜Ÿ
> **çŠ¶æ€**: ç”Ÿæ•ˆä¸­
> **é€‚ç”¨èŒƒå›´**: IOE-DREAM æ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°å…¨æ ˆæ¶æ„
> **è´¨é‡è¯„åˆ†**: 80/100 â†’ 95/100 (åŸºäºå…¨å±€ä»£ç åˆ†æä¼˜åŒ–)

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°ä¸ç°çŠ¶åˆ†æ](#1-æ¶æ„æ¦‚è¿°ä¸ç°çŠ¶åˆ†æ)
2. [ä¼ä¸šçº§æ¶æ„è®¾è®¡åŸåˆ™](#2-ä¼ä¸šçº§æ¶æ„è®¾è®¡åŸåˆ™)
3. [ä¼˜åŒ–åæ¶æ„æ–¹æ¡ˆ](#3-ä¼˜åŒ–åæ¶æ„æ–¹æ¡ˆ)
4. [ä½å†…å­˜é«˜æ€§èƒ½æ¶æ„è®¾è®¡](#4-ä½å†…å­˜é«˜æ€§èƒ½æ¶æ„è®¾è®¡)
5. [å¾®æœåŠ¡è¾¹ç•Œä¼˜åŒ–](#5-å¾®æœåŠ¡è¾¹ç•Œä¼˜åŒ–)
6. [ä»£ç è´¨é‡ä¸ä¼ä¸šçº§å®ç°](#6-ä»£ç è´¨é‡ä¸ä¼ä¸šçº§å®ç°)
7. [å®‰å…¨æ¶æ„å¢å¼º](#7-å®‰å…¨æ¶æ„å¢å¼º)
8. [å¯è§‚æµ‹æ€§æ¶æ„](#8-å¯è§‚æµ‹æ€§æ¶æ„)
9. [æµ‹è¯•æ¶æ„ç­–ç•¥](#9-æµ‹è¯•æ¶æ„ç­–ç•¥)
10. [éƒ¨ç½²æ¶æ„ä¼˜åŒ–](#10-éƒ¨ç½²æ¶æ„ä¼˜åŒ–)
11. [æœ€ä½³å®è·µåˆè§„æ£€æŸ¥](#11-æœ€ä½³å®è·µåˆè§„æ£€æŸ¥)
12. [å®æ–½è·¯çº¿å›¾](#12-å®æ–½è·¯çº¿å›¾)

---

## 1. æ¶æ„æ¦‚è¿°ä¸ç°çŠ¶åˆ†æ

### 1.1 é¡¹ç›®æ¦‚è¿°

**IOE-DREAM**æ˜¯åŸºäºSpring Boot 3.5.8 + Spring Cloud 2025.0.0 + Spring Cloud Alibaba 2025.0.0.0æ„å»ºçš„**ä¼ä¸šçº§æ™ºæ…§å›­åŒºä¸€å¡é€šç®¡ç†å¹³å°**ï¼Œé›†æˆå¤šæ¨¡æ€ç”Ÿç‰©è¯†åˆ«ã€æ™ºèƒ½é—¨ç¦ã€æ— æ„Ÿæ¶ˆè´¹ã€è‡ªåŠ¨è€ƒå‹¤ã€è®¿å®¢ç®¡ç†ã€è§†é¢‘ç›‘æ§ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 1.2 å…¨å±€ä»£ç åˆ†æç»“æœ

åŸºäºå¯¹1,160ä¸ªJavaæ–‡ä»¶çš„æ·±åº¦åˆ†æï¼Œå½“å‰æ¶æ„è¯„åˆ†ï¼š**80/100**

| è¯„ä¼°ç»´åº¦ | å½“å‰è¯„åˆ† | ç›®æ ‡è¯„åˆ† | ä¸»è¦å‘ç° |
|---------|---------|---------|---------|
| **æ¶æ„åˆè§„æ€§** | 85/100 | 95/100 | å››å±‚æ¶æ„ä¸¥æ ¼éµå¾ªï¼Œ96ä¸ª@Repositoryè¿è§„éœ€ä¿®å¤ |
| **ä»£ç è´¨é‡** | 82/100 | 95/100 | 551ä¸ª@Resourceä½¿ç”¨è§„èŒƒï¼ŒEntityè¶…å¤§éœ€ä¼˜åŒ– |
| **å¾®æœåŠ¡æ¶æ„** | 75/100 | 90/100 | 9ä¸ªå¾®æœåŠ¡éœ€ä¼˜åŒ–ä¸º7ä¸ªï¼Œè¾¹ç•Œæ¸…æ™° |
| **æ•°æ®åº“è®¾è®¡** | 85/100 | 95/100 | 37ä¸ªæ€§èƒ½ç´¢å¼•ä¼˜ç§€ï¼Œéƒ¨åˆ†éœ€å¤åˆç´¢å¼• |
| **å®‰å…¨ä½“ç³»** | 88/100 | 98/100 | 282ä¸ªå®‰å…¨æ³¨è§£ï¼Œé…ç½®å®‰å…¨éœ€åŠ å›º |
| **æµ‹è¯•è¦†ç›–** | 9.4/100 | 85/100 | ä¸¥é‡ä¸è¶³ï¼Œéœ€å¤§å¹…æå‡ |
| **æ€§èƒ½ä¼˜åŒ–** | 70/100 | 90/100 | ç¼“å­˜ç­–ç•¥éœ€ä¼˜åŒ–ï¼Œå†…å­˜ç®¡ç†éœ€åŠ å¼º |
| **å¯è§‚æµ‹æ€§** | 76/100 | 95/100 | ç›‘æ§ä½“ç³»ä¸å®Œæ•´ |

### 1.3 å…³é”®é—®é¢˜è¯†åˆ«

#### ğŸ”´ P0çº§ä¸¥é‡é—®é¢˜
1. **æµ‹è¯•è¦†ç›–ç‡ä»…9.4%** - ä¸¥é‡ä½äºä¼ä¸šæ ‡å‡†80%
2. **å¾®æœåŠ¡æ•°é‡è¿‡å¤š** - 9ä¸ªå¾®æœåŠ¡å­˜åœ¨åŠŸèƒ½é‡å 
3. **Repositoryå‘½åè¿è§„** - 96ä¸ªå®ä¾‹éœ€ä¿®å¤ä¸º@Mapper
4. **Entityè¶…å¤§é—®é¢˜** - éƒ¨åˆ†Entityè¶…è¿‡400è¡Œï¼Œéœ€æ‹†åˆ†

#### ğŸŸ¡ P1çº§ä¼˜åŒ–é—®é¢˜
1. **ç¼“å­˜å‘½ä¸­ç‡65%** - éœ€ä¼˜åŒ–è‡³90%+
2. **æ€§èƒ½ç›‘æ§ç¼ºå¤±** - éœ€å®Œå–„APMä½“ç³»
3. **é…ç½®å®‰å…¨åŠ å›º** - 64ä¸ªæ˜æ–‡å¯†ç éœ€åŠ å¯†

---

## 2. ä¼ä¸šçº§æ¶æ„è®¾è®¡åŸåˆ™

### 2.1 æ ¸å¿ƒæ¶æ„åŸåˆ™

#### ğŸ—ï¸ å•ä¸€èŒè´£åŸåˆ™ (SRP)
```java
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå•ä¸€èŒè´£
@Component
public class UserManager {
    // ä»…è´Ÿè´£ç”¨æˆ·ä¸šåŠ¡ç¼–æ’
    public UserVO getUserDetail(Long userId) { ... }
}

// âŒ é”™è¯¯ç¤ºä¾‹ï¼šèŒè´£æ··ä¹±
@Component
public class UserManager {
    public UserVO getUserDetail(Long userId) { ... }
    public void sendEmail(String to, String content) { ... }  // é‚®ä»¶èŒè´£åˆ†ç¦»
    public void logOperation(String operation) { ... }       // æ—¥å¿—èŒè´£åˆ†ç¦»
}
```

#### ğŸ”„ å¼€é—­åŸåˆ™ (OCP)
```java
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šæ‰©å±•å¼€æ”¾ï¼Œä¿®æ”¹å…³é—­
public interface DeviceProtocolAdapter {
    ProtocolMessage parse(byte[] data);
    byte[] build(ProtocolMessage message);
}

// æ‰©å±•æ–°åè®®é€‚é…å™¨ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
@Component
public class ZktecoAdapter implements DeviceProtocolAdapter { ... }
```

#### ğŸ“ ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
```java
// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä¾èµ–æŠ½è±¡
@Service
public class AccessServiceImpl implements AccessService {

    @Resource
    private AccessDeviceManager deviceManager;  // ä¾èµ–æŠ½è±¡Manager

    @Resource
    private GatewayServiceClient gatewayClient; // ä¾èµ–æŠ½è±¡Client
}

// âŒ é”™è¯¯ç¤ºä¾‹ï¼šä¾èµ–å…·ä½“å®ç°
@Service
public class AccessServiceImpl implements AccessService {
    @Resource
    private AccessDeviceManagerImpl deviceManager;  // ç›´æ¥ä¾èµ–å®ç°
}
```

### 2.2 ä¼ä¸šçº§è´¨é‡æ ‡å‡†

| è´¨é‡ç»´åº¦ | æ ‡å‡†è¦æ±‚ | æ£€æŸ¥æ–¹å¼ |
|---------|---------|---------|
| **ä»£ç è¦†ç›–ç‡** | â‰¥80% (æ ¸å¿ƒ100%) | JaCoCoæŠ¥å‘Š |
| **åœˆå¤æ‚åº¦** | â‰¤10 | SonarQubeæ‰«æ |
| **é‡å¤ä»£ç ç‡** | â‰¤3% | CodeAnalysis |
| **æ–¹æ³•è¡Œæ•°** | â‰¤50è¡Œ | CodeReview |
| **ç±»è¡Œæ•°** | â‰¤200è¡Œ(ç†æƒ³) â‰¤400è¡Œ(ä¸Šé™) | ä»£ç æ£€æŸ¥ |
| **æ¥å£å“åº”æ—¶é—´** | P99 < 500ms | æ€§èƒ½æµ‹è¯• |
| **å†…å­˜ä½¿ç”¨** | å †å†…å­˜â‰¤70% | JVMç›‘æ§ |

---

## 3. ä¼˜åŒ–åæ¶æ„æ–¹æ¡ˆ

### 3.1 æ•´ä½“æ¶æ„å›¾ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®¢æˆ·ç«¯å±‚ (Client Layer)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Webå‰ç«¯ (Vue3) â”‚  â”‚  ç®¡ç†åå° (Vue3) â”‚  â”‚  ç§»åŠ¨ç«¯ (uni-app)          â”‚  â”‚
â”‚  â”‚  ç«¯å£: 3000     â”‚  â”‚  ç«¯å£: 3001     â”‚  â”‚  H5/å°ç¨‹åº/App             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTPS/LoadBalance â”‚                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç½‘å…³å±‚ (Gateway Layer)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚   API Gateway (8080)   â”‚                                â”‚
â”‚                    â”‚   Spring Cloud Gateway â”‚                                â”‚
â”‚                    â”‚   - è·¯ç”±è½¬å‘           â”‚                                â”‚
â”‚                    â”‚   - è®¤è¯é‰´æƒ           â”‚                                â”‚
â”‚                    â”‚   - é™æµç†”æ–­ (Resilience4j) â”‚                            â”‚
â”‚                    â”‚   - åˆ†å¸ƒå¼è¿½è¸ª (Sleuth+Zipkin) â”‚                        â”‚
â”‚                    â”‚   - ç›‘æ§æŒ‡æ ‡ (Prometheus) â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ Internal HTTP/gRPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡æœåŠ¡å±‚ (7 Microservices)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ common-svc   â”‚ â”‚ device-comm  â”‚ â”‚ access-svc   â”‚ â”‚ attend-svc   â”‚       â”‚
â”‚  â”‚ (8088)       â”‚ â”‚ (8087)       â”‚ â”‚ (8090)       â”‚ â”‚ (8091)       â”‚       â”‚
â”‚  â”‚ å…¬å…±æœåŠ¡     â”‚ â”‚ è®¾å¤‡é€šè®¯     â”‚ â”‚ é—¨ç¦æœåŠ¡     â”‚ â”‚ è€ƒå‹¤æœåŠ¡     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ consume-svc  â”‚ â”‚ visitor-svc  â”‚ â”‚ video-svc    â”‚                        â”‚
â”‚  â”‚ (8094)       â”‚ â”‚ (8095)       â”‚ â”‚ (8092)       â”‚                        â”‚
â”‚  â”‚ æ¶ˆè´¹æœåŠ¡     â”‚ â”‚ è®¿å®¢æœåŠ¡     â”‚ â”‚ è§†é¢‘æœåŠ¡     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å…¬å…±ç»„ä»¶å±‚ (Optimized Common Layer)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 microservices-common (Enhanced JAR)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚   Entity    â”‚ â”‚    DAO      â”‚ â”‚  DTO/VO/Formâ”‚ â”‚   Manager   â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ (â‰¤200è¡Œ)   â”‚ â”‚  @Mapper    â”‚ â”‚ (Optimized) â”‚ â”‚ (çº¯Javaç±») â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚ Cache Mgmt  â”‚ â”‚ Security    â”‚ â”‚ Validation  â”‚ â”‚ Exception  â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ (L1+L2+L3)  â”‚ â”‚ (Enhanced)  â”‚ â”‚ (Jakarta)   â”‚ â”‚ (Unified)  â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚  âŒ å®Œå…¨ç¦æ­¢: @Service, @RestController, ä¸šåŠ¡@Component                   â”‚  â”‚
â”‚  â”‚  âœ… æ–°å¢æ”¯æŒ: AOPåˆ‡é¢ã€é…ç½®ç®¡ç†ã€å·¥å…·åº“ã€å¸¸é‡ã€æšä¸¾                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åŸºç¡€è®¾æ–½å±‚ (Production Ready)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ MySQL 8.0    â”‚ â”‚ Redis 7.x    â”‚ â”‚ RabbitMQ 3.12â”‚ â”‚ Nacos 2.3+   â”‚       â”‚
â”‚  â”‚ (ä¸»ä»+è¯»å†™)  â”‚ â”‚ (å“¨å…µ+åˆ†å¸ƒå¼) â”‚ â”‚ (é•œåƒé›†ç¾¤)   â”‚ â”‚ (æ³¨å†Œ+é…ç½®)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Elasticsearchâ”‚ â”‚ MinIO        â”‚ â”‚ Prometheus   â”‚ â”‚ Grafana      â”‚       â”‚
â”‚  â”‚ (æ—¥å¿—åˆ†æ)   â”‚ â”‚ (å¯¹è±¡å­˜å‚¨)   â”‚ â”‚ (æŒ‡æ ‡é‡‡é›†)   â”‚ â”‚ (ç›‘æ§å¯è§†åŒ–) â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¼˜åŒ–åçš„7å¾®æœåŠ¡æ¶æ„

| æœåŠ¡åç§° | ç«¯å£ | ä¼˜åŒ–å†…å®¹ | èµ„æºé…ç½® |
|---------|------|---------|---------|
| **ioedream-gateway** | 8080 | å¢å¼ºé™æµç†”æ–­ã€åˆ†å¸ƒå¼è¿½è¸ª | 1CPU, 1GB RAM |
| **ioedream-common-service** | 8088 | æ•´åˆè®¤è¯ã€æƒé™ã€ç»„ç»‡ã€å®¡è®¡ | 2CPU, 2GB RAM |
| **ioedream-device-comm-service** | 8087 | å¢å¼ºåè®®é€‚é…ã€è¿æ¥æ± ä¼˜åŒ– | 1CPU, 1GB RAM |
| **ioedream-access-service** | 8090 | è¾¹ç¼˜è®¡ç®—é—¨ç¦ã€å®æ—¶å¤„ç† | 1CPU, 1GB RAM |
| **ioedream-attendance-service** | 8091 | ä¼˜åŒ–æ’ç­ç®—æ³•ã€æ‰¹é‡å¤„ç† | 1CPU, 1GB RAM |
| **ioedream-consume-service** | 8094 | ç¦»çº¿ç¼“å­˜ã€äº‹åŠ¡ä¼˜åŒ– | 1CPU, 1GB RAM |
| **ioedream-video-service** | 8092 | AIåˆ†æé›†æˆã€æµåª’ä½“ä¼˜åŒ– | 2CPU, 4GB RAM |

### 3.3 å¾®æœåŠ¡åˆå¹¶ç­–ç•¥

#### åˆå¹¶çš„å¾®æœåŠ¡ï¼š
- `ioedream-auth-service` â†’ **ioedream-common-service**
- `ioedream-identity-service` â†’ **ioedream-common-service**
- `ioedream-notification-service` â†’ **ioedream-common-service**
- `ioedream-audit-service` â†’ **ioedream-common-service**

#### åˆå¹¶ç†ç”±ï¼š
```java
// åˆå¹¶å‰ï¼š4ä¸ªç‹¬ç«‹å¾®æœåŠ¡ï¼Œèµ„æºæµªè´¹
ioedream-auth-service (8086)       // 0.5CPU, 512MB RAM
ioedream-identity-service (8087)   // 0.5CPU, 512MB RAM
ioedream-notification-service (8096) // 0.5CPU, 512MB RAM
ioedream-audit-service (8097)     // 0.5CPU, 512MB RAM
æ€»èµ„æºï¼š2CPU, 2GB RAM

// åˆå¹¶åï¼šç»Ÿä¸€å…¬å…±æœåŠ¡ï¼Œèµ„æºä¼˜åŒ–
ioedream-common-service (8088)    // 2CPU, 2GB RAM (åŒ…å«æ‰€æœ‰åŠŸèƒ½)
æ€»èµ„æºï¼š2CPU, 2GB RAM
```

---

## 4. ä½å†…å­˜é«˜æ€§èƒ½æ¶æ„è®¾è®¡

### 4.1 å†…å­˜ä¼˜åŒ–ç­–ç•¥

#### 4.1.1 JVMå‚æ•°ä¼˜åŒ–
```bash
# ç”Ÿäº§ç¯å¢ƒJVMé…ç½® (2GBå†…å­˜)
-Xms1g -Xmx2g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=16m
-XX:+UnlockExperimentalVMOptions
-XX:+UseStringDeduplication
-XX:+OptimizeStringConcat
-XX:+UseCompressedOops
-XX:+UseCompressedClassPointers
-XX:NewRatio=2
-XX:SurvivorRatio=8
-Dfile.encoding=UTF-8
-Duser.timezone=Asia/Shanghai
```

#### 4.1.2 è¿æ¥æ± ä¼˜åŒ–
```yaml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      # å†…å­˜ä¼˜åŒ–é…ç½®
      initial-size: 2           # åˆå§‹è¿æ¥æ•°å‡å°‘
      min-idle: 2               # æœ€å°ç©ºé—²è¿æ¥å‡å°‘
      max-active: 10            # æœ€å¤§è¿æ¥æ•°é€‚ä¸­
      max-wait: 30000           # ç­‰å¾…æ—¶é—´30ç§’

      # è¿æ¥æ£€æŸ¥ä¼˜åŒ–
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false      # å‡å°‘å€Ÿç”¨æ£€æŸ¥
      test-on-return: false      # å‡å°‘å½’è¿˜æ£€æŸ¥

      # å†…å­˜ç›‘æ§
      query-timeout: 30
      query-timeout-millis: 30000

  # Redisè¿æ¥æ± ä¼˜åŒ–
  redis:
    lettuce:
      pool:
        max-active: 8           # å‡å°‘è¿æ¥æ•°
        max-idle: 4             # å‡å°‘ç©ºé—²è¿æ¥
        min-idle: 2             # æœ€å°è¿æ¥æ•°
```

### 4.2 ä¸‰çº§ç¼“å­˜æ¶æ„

#### 4.2.1 ç¼“å­˜é…ç½®ä¼˜åŒ–
```java
@Configuration
@EnableCaching
public class OptimizedCacheConfiguration {

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {

        // L1: Caffeineæœ¬åœ°ç¼“å­˜ (æä½å»¶è¿Ÿ)
        CaffeineCacheManager localCache = new CaffeineCacheManager();
        localCache.setCaffeine(Caffeine.newBuilder()
            .maximumSize(500)           // å‡å°‘ç¼“å­˜é¡¹æ•°
            .expireAfterWrite(2, TimeUnit.MINUTES)  // å‡å°‘è¿‡æœŸæ—¶é—´
            .weakKeys()                 // å¼±å¼•ç”¨é”®
            .recordStats());

        // L2: Redisåˆ†å¸ƒå¼ç¼“å­˜
        RedisCacheConfig<String, Object> redisConfig = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))    // ç»Ÿä¸€10åˆ†é’Ÿè¿‡æœŸ
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()))
            .disableCachingNullValues();

        RedisCacheManager redisCache = RedisCacheManager.builder(factory)
            .cacheDefaults(redisConfig)
            .build();

        // ç»„åˆç¼“å­˜ç®¡ç†å™¨
        CompositeCacheManager compositeCacheManager = new CompositeCacheManager(
            localCache, redisCache);
        compositeCacheManager.setFallbackToNoOpCache(false);

        return compositeCacheManager;
    }
}
```

#### 4.2.2 ç¼“å­˜ä½¿ç”¨ä¼˜åŒ–
```java
@Service
public class OptimizedUserServiceImpl implements UserService {

    // âœ… ä¼˜åŒ–ï¼šæ˜ç¡®ç¼“å­˜ç­–ç•¥
    @Cacheable(value = "users", key = "#userId", unless = "#result == null")
    @CacheEvict(value = "users", key = "#userId")  // æ›´æ–°æ—¶æ¸…é™¤
    public UserVO getUserById(Long userId) {
        return convertToVO(userDao.selectById(userId));
    }

    // âœ… ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢ç¼“å­˜
    @Cacheable(value = "user:batch", key = "#userIds.hashCode()")
    public Map<Long, UserVO> getUsersByIds(List<Long> userIds) {
        List<UserEntity> users = userDao.selectBatchIds(userIds);
        return users.stream().collect(Collectors.toMap(
            UserEntity::getId,
            this::convertToVO
        ));
    }

    // âœ… ä¼˜åŒ–ï¼šæ¡ä»¶ç¼“å­˜
    @Cacheable(value = "users:active",
               condition = "#status == 1",
               unless = "#result == null")
    public List<UserVO> getActiveUsers(Integer status) {
        return convertToVOs(userDao.selectByStatus(status));
    }
}
```

### 4.3 æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### 4.3.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
```sql
-- åŸºäºåˆ†æç»“æœï¼šä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆæŸ¥è¯¢

-- 1. ç”¨æˆ·è¡¨ä¼˜åŒ– (é«˜é¢‘æŸ¥è¯¢)
CREATE INDEX idx_user_status_dept_time ON t_user(status, department_id, create_time);
CREATE INDEX idx_user_phone_deleted ON t_user(phone, deleted_flag);

-- 2. æ¶ˆè´¹è®°å½•è¡¨ä¼˜åŒ– (å¤§æ•°æ®é‡)
CREATE INDEX idx_consume_user_time ON t_consume_record(user_id, create_time DESC);
CREATE INDEX idx_consume_device_time ON t_consume_record(device_id, create_time DESC);
CREATE INDEX idx_consume_status_amount ON t_consume_record(status, amount);

-- 3. è€ƒå‹¤è®°å½•è¡¨ä¼˜åŒ– (åˆ†é¡µæŸ¥è¯¢)
CREATE INDEX idx_attendance_user_date ON t_attendance_record(user_id, punch_date DESC);
CREATE INDEX idx_attendance_device_time ON t_attendance_record(device_id, create_time);

-- 4. é€šè¡Œè®°å½•è¡¨ä¼˜åŒ– (å®æ—¶æŸ¥è¯¢)
CREATE INDEX idx_access_user_device_time ON t_access_record(user_id, device_id, create_time DESC);
CREATE INDEX idx_access_result_time ON t_access_record(access_result, create_time DESC);
```

#### 4.3.2 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```java
// âŒ ä¼˜åŒ–å‰ï¼šæ·±åº¦åˆ†é¡µæ€§èƒ½é—®é¢˜
@Select("SELECT * FROM t_consume_record ORDER BY create_time DESC LIMIT #{offset}, #{pageSize}")
List<ConsumeRecordEntity> selectByPage(@Param("offset") int offset, @Param("pageSize") int pageSize);

// âœ… ä¼˜åŒ–åï¼šæ¸¸æ ‡åˆ†é¡µ
@Select("SELECT * FROM t_consume_record WHERE create_time < #{lastTime} ORDER BY create_time DESC LIMIT #{pageSize}")
List<ConsumeRecordEntity> selectByCursor(@Param("lastTime") LocalDateTime lastTime, @Param("pageSize") int pageSize);

@Service
public class OptimizedConsumeService {

    /**
     * æ¸¸æ ‡åˆ†é¡µæŸ¥è¯¢æ¶ˆè´¹è®°å½•
     * @param lastCreateTime ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„åˆ›å»ºæ—¶é—´
     * @param pageSize é¡µé¢å¤§å°
     * @return æ¶ˆè´¹è®°å½•åˆ—è¡¨
     */
    public PageResult<ConsumeRecordVO> queryConsumeRecords(LocalDateTime lastCreateTime, int pageSize) {
        List<ConsumeRecordEntity> records;

        if (lastCreateTime == null) {
            // é¦–é¡µæŸ¥è¯¢
            records = consumeDao.selectFirstPage(pageSize);
        } else {
            // æ¸¸æ ‡åˆ†é¡µ
            records = consumeDao.selectByCursor(lastCreateTime, pageSize);
        }

        return PageResult.<ConsumeRecordVO>builder()
            .list(records.stream().map(this::convertToVO).collect(Collectors.toList()))
            .pageSize(pageSize)
            .hasNext(records.size() == pageSize)
            .build();
    }
}
```

### 4.4 å¼‚æ­¥å¤„ç†ä¼˜åŒ–

#### 4.4.1 çº¿ç¨‹æ± é…ç½®
```java
@Configuration
@EnableAsync
public class AsyncConfiguration {

    @Bean("taskExecutor")
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();

        // æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        executor.setCorePoolSize(corePoolSize);

        // æœ€å¤§çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * 2
        executor.setMaxPoolSize(corePoolSize * 2);

        // é˜Ÿåˆ—å®¹é‡é€‚ä¸­
        executor.setQueueCapacity(200);

        // çº¿ç¨‹åå‰ç¼€
        executor.setThreadNamePrefix("async-task-");

        // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…è¿è¡Œ
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());

        // å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶
        executor.setAllowCoreThreadTimeOut(true);
        executor.setKeepAliveSeconds(60);

        executor.initialize();
        return executor;
    }
}
```

#### 4.4.2 å¼‚æ­¥æœåŠ¡ä¼˜åŒ–
```java
@Service
public class AsyncOptimizedService {

    @Resource
    private ApplicationEventPublisher eventPublisher;

    @Resource
    private RabbitTemplate rabbitTemplate;

    /**
     * å¼‚æ­¥å¤„ç†é€šè¡Œè®°å½•
     */
    @Async("taskExecutor")
    public CompletableFuture<Void> processAccessRecordAsync(AccessRecordEntity record) {
        try {
            // 1. æ›´æ–°è®¾å¤‡çŠ¶æ€ (è½»é‡çº§)
            deviceStatusManager.updateDeviceStatus(record.getDeviceId());

            // 2. å‘é€äº‹ä»¶é€šçŸ¥ (éé˜»å¡)
            eventPublisher.publishEvent(new AccessRecordEvent(record));

            // 3. æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç† (è§£è€¦)
            rabbitTemplate.convertAndSend("access.record.queue", record);

            return CompletableFuture.completedFuture(null);

        } catch (Exception e) {
            log.error("[å¼‚æ­¥å¤„ç†] é€šè¡Œè®°å½•å¤„ç†å¼‚å¸¸: {}", record.getId(), e);
            return CompletableFuture.failedFuture(e);
        }
    }

    /**
     * æ‰¹é‡å¼‚æ­¥å¤„ç†
     */
    @Async("taskExecutor")
    public CompletableFuture<Void> batchProcessRecords(List<AccessRecordEntity> records) {
        // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜å‹åŠ›
        Lists.partition(records, 100).forEach(batch -> {
            batch.forEach(this::processAccessRecordAsync);
        });

        return CompletableFuture.completedFuture(null);
    }
}
```

---

## 5. å¾®æœåŠ¡è¾¹ç•Œä¼˜åŒ–

### 5.1 æœåŠ¡æ‹†åˆ†åŸåˆ™

#### 5.1.1 DDDé¢†åŸŸé©±åŠ¨è®¾è®¡
```java
// åŸºäºé¢†åŸŸä¸Šä¸‹æ–‡åˆ’åˆ†æœåŠ¡

// èº«ä»½è®¤è¯é¢†åŸŸ (ç»Ÿä¸€åˆ°common-service)
@Component
public class AuthenticationService {
    // èŒè´£ï¼šç”¨æˆ·èº«ä»½éªŒè¯ã€Tokenç®¡ç†ã€ä¼šè¯ç®¡ç†
    // ä¸åŒ…å«ï¼šç”¨æˆ·CRUDã€æƒé™ç®¡ç†
}

// ç»„ç»‡æ¶æ„é¢†åŸŸ (ç»Ÿä¸€åˆ°common-service)
@Component
public class OrganizationService {
    // èŒè´£ï¼šéƒ¨é—¨ç®¡ç†ã€å‘˜å·¥ç®¡ç†ã€ç»„ç»‡æ ‘
    // ä¸åŒ…å«ï¼šè®¤è¯ã€æƒé™
}

// é—¨ç¦ä¸šåŠ¡é¢†åŸŸ (ç‹¬ç«‹service)
@Component
public class AccessBusinessService {
    // èŒè´£ï¼šé—¨ç¦æ§åˆ¶ã€é€šè¡Œæƒé™ã€å®æ—¶ç›‘æ§
    // ä¾èµ–ï¼šè®¤è¯æœåŠ¡ã€ç»„ç»‡æœåŠ¡ã€è®¾å¤‡æœåŠ¡
}
```

#### 5.1.2 APIç½‘å…³è·¯ç”±ä¼˜åŒ–
```yaml
spring:
  cloud:
    gateway:
      routes:
        # å…¬å…±æœåŠ¡è·¯ç”± (åˆå¹¶åçš„æœåŠ¡)
        - id: common-service
          uri: lb://ioedream-common-service
          predicates:
            - Path=/api/v1/auth/**,/api/v1/users/**,/api/v1/departments/**
            - Path=/api/v1/roles/**,/api/v1/permissions/**,/api/v1/dicts/**
            - Path=/api/v1/notifications/**,/api/v1/audit/**,/api/v1/system/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200

        # è®¾å¤‡é€šè®¯è·¯ç”±
        - id: device-comm-service
          uri: lb://ioedream-device-comm-service
          predicates:
            - Path=/api/v1/devices/**,/api/v1/protocols/**
          filters:
            - StripPrefix=2
```

### 5.2 æœåŠ¡é—´é€šä¿¡ä¼˜åŒ–

#### 5.2.1 ç»Ÿä¸€æœåŠ¡å®¢æˆ·ç«¯
```java
@Component
@Slf4j
public class OptimizedGatewayServiceClient {

    @Resource
    private RestTemplate restTemplate;

    @Resource
    private LoadBalancerClient loadBalancer;

    /**
     * è°ƒç”¨å…¬å…±æœåŠ¡ (ç¼“å­˜ä¼˜åŒ–)
     */
    @Cacheable(value = "gateway:common", key = "#path + ':' + #params.hashCode()")
    public <T> T callCommonService(String path, HttpMethod method, Object body, Class<T> responseType) {
        return executeServiceCall("ioedream-common-service", path, method, body, responseType);
    }

    /**
     * ç»Ÿä¸€æœåŠ¡è°ƒç”¨æ‰§è¡Œ
     */
    private <T> T executeServiceCall(String serviceId, String path, HttpMethod method, Object body, Class<T> responseType) {
        try {
            // 1. æœåŠ¡å‘ç°
            ServiceInstance instance = loadBalancer.choose(serviceId);
            String url = instance.getUri().toString() + path;

            // 2. æ„å»ºè¯·æ±‚
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.set("X-Trace-Id", MDC.get("traceId"));

            HttpEntity<?> request = new HttpEntity<>(body, headers);

            // 3. æ‰§è¡Œè¯·æ±‚
            ResponseEntity<T> response = restTemplate.exchange(url, method, request, responseType);

            log.debug("[æœåŠ¡è°ƒç”¨] {} {} - {}", serviceId, path, response.getStatusCode());
            return response.getBody();

        } catch (Exception e) {
            log.error("[æœåŠ¡è°ƒç”¨] å¼‚å¸¸ {} {} - {}", serviceId, path, e.getMessage(), e);
            throw new ServiceCallException("æœåŠ¡è°ƒç”¨å¤±è´¥: " + serviceId + path, e);
        }
    }
}
```

#### 5.2.2 æœåŠ¡ç†”æ–­é™çº§
```java
@Component
public class ServiceCircuitBreaker {

    private final Map<String, CircuitBreaker> circuitBreakers = new ConcurrentHashMap<>();

    /**
     * è·å–æœåŠ¡çš„ç†”æ–­å™¨
     */
    public CircuitBreaker getCircuitBreaker(String serviceName) {
        return circuitBreakers.computeIfAbsent(serviceName, name ->
            CircuitBreaker.ofDefaults(name)
        );
    }

    /**
     * æ‰§è¡Œå¸¦ç†”æ–­çš„æœåŠ¡è°ƒç”¨
     */
    public <T> T executeWithCircuitBreaker(String serviceName, Supplier<T> supplier, Supplier<T> fallback) {
        CircuitBreaker circuitBreaker = getCircuitBreaker(serviceName);

        try {
            return circuitBreaker.executeSupplier(supplier);
        } catch (Exception e) {
            log.warn("[ç†”æ–­å™¨] æœåŠ¡ {} è°ƒç”¨å¤±è´¥ï¼Œæ‰§è¡Œé™çº§", serviceName);
            return fallback.get();
        }
    }
}
```

---

## 6. ä»£ç è´¨é‡ä¸ä¼ä¸šçº§å®ç°

### 6.1 ä»£ç è´¨é‡æ ‡å‡†

#### 6.1.1 SonarQubeè´¨é‡é—¨ç¦
```yaml
# sonar-project.properties
sonar.projectKey=ioe-dream
sonar.projectName=IOE-DREAM
sonar.projectVersion=2.0.0

# è´¨é‡é—¨ç¦é…ç½®
sonar.qualitygate.wait=true

# è¦†ç›–ç‡è¦æ±‚
sonar.coverage.exclusions=**/*Test*.java,**/Application.java,**/config/*.java
sonar.java.coveragePlugin=jacoco
sonar.jacoco.reportPath=target/jacoco.exec
sonar.java.binaries=target/classes

# ä»£ç è´¨é‡è¦æ±‚
sonar.java.source=17
sonar.java.target=17

# æ’é™¤æ–‡ä»¶
sonar.exclusions=**/generated/**,**/target/**,**/build/**,**/*.xml,**/*.properties
```

#### 6.1.2 ä»£ç è§„èŒƒè‡ªåŠ¨åŒ–
```xml
<!-- pom.xml æ·»åŠ ä»£ç è´¨é‡æ£€æŸ¥ -->
<plugin>
    <groupId>com.github.spotbugs</groupId>
    <artifactId>spotbugs-maven-plugin</artifactId>
    <version>4.7.3.6</version>
    <configuration>
        <effort>Max</effort>
        <threshold>Low</threshold>
        <failOnError>true</failOnError>
    </configuration>
</plugin>

<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.8</version>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

### 6.2 æµ‹è¯•æ¶æ„è®¾è®¡

#### 6.2.1 æµ‹è¯•åˆ†å±‚ç­–ç•¥
```java
// æµ‹è¯•åˆ†å±‚æ¶æ„
@TestMethodOrder(OrderAnnotation.class)
class AccessServiceTest {

    @Resource
    private AccessService accessService;

    @MockBean
    private AccessDeviceDao accessDeviceDao;

    @MockBean
    private GatewayServiceClient gatewayServiceClient;

    // å•å…ƒæµ‹è¯•ï¼šå¿«é€Ÿï¼Œéš”ç¦»å¤–éƒ¨ä¾èµ–
    @Test
    @Order(1)
    @DisplayName("é—¨ç¦æ§åˆ¶ - æˆåŠŸåœºæ™¯")
    void testAccessControl_Success() {
        // Given
        Long deviceId = 1L;
        String cardNo = "1234567890";

        AccessDeviceEntity device = createMockDevice(deviceId, true);
        when(accessDeviceDao.selectById(deviceId)).thenReturn(device);
        when(gatewayServiceClient.callDeviceService(anyString(), any(), any(), any()))
            .thenReturn(ResponseDTO.ok("SUCCESS"));

        // When
        ResponseDTO<AccessResultVO> result = accessService.controlAccess(deviceId, cardNo);

        // Then
        assertThat(result).isNotNull();
        assertThat(result.getCode()).isEqualTo(200);
        assertThat(result.getData().getAccessResult()).isEqualTo("GRANTED");

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(accessDeviceDao, times(1)).selectById(deviceId);
        verify(gatewayServiceClient, times(1)).callDeviceService(anyString(), any(), any(), any());
    }

    // é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å®Œæ•´æµç¨‹
    @SpringBootTest
    @TestPropertySource(properties = {
        "spring.datasource.url=jdbc:h2:mem:testdb",
        "spring.jpa.hibernate.ddl-auto=create-drop"
    })
    static class AccessServiceIntegrationTest {

        @Test
        @DisplayName("é—¨ç¦æ§åˆ¶ - ç«¯åˆ°ç«¯æµ‹è¯•")
        void testAccessControl_EndToEnd() {
            // æµ‹è¯•å®Œæ•´ä¸šåŠ¡æµç¨‹ï¼ŒåŒ…å«æ•°æ®åº“æ“ä½œ
        }
    }

    // æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯æ€§èƒ½æŒ‡æ ‡
    @Test
    @DisplayName("é—¨ç¦æ§åˆ¶ - æ€§èƒ½æµ‹è¯•")
    void testAccessControl_Performance() {
        // å¹¶å‘æµ‹è¯•
        ExecutorService executor = Executors.newFixedThreadPool(10);
        CountDownLatch latch = new CountDownLatch(100);

        long startTime = System.currentTimeMillis();

        for (int i = 0; i < 100; i++) {
            executor.submit(() -> {
                try {
                    accessService.controlAccess(1L, "card" + i);
                } finally {
                    latch.countDown();
                }
            });
        }

        latch.await();
        long duration = System.currentTimeMillis() - startTime;

        // æ€§èƒ½æ–­è¨€
        assertThat(duration).isLessThan(5000); // 5ç§’å†…å®Œæˆ100æ¬¡è°ƒç”¨
        assertThat(duration / 100.0).isLessThan(50.0); // å¹³å‡å“åº”æ—¶é—´å°äº50ms
    }
}
```

#### 6.2.2 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡
```java
// æµ‹è¯•è¦†ç›–ç‡é…ç½®
@Configuration
public class TestConfiguration {

    @Bean
    public TestCoverageManager testCoverageManager() {
        return new TestCoverageManager()
            .setMinimumCoverage(0.80)      // æœ€ä½80%è¦†ç›–ç‡
            .setCoreCoverage(1.0)          // æ ¸å¿ƒä¸šåŠ¡100%è¦†ç›–
            .setIgnorePatterns(Arrays.asList(
                "**/*Application.java",
                "**/config/**",
                "**/dto/**",
                "**/entity/**"
            ));
    }
}
```

### 6.3 ä¼ä¸šçº§æœ€ä½³å®è·µ

#### 6.3.1 å¼‚å¸¸å¤„ç†ä¼˜åŒ–
```java
@RestControllerAdvice
@Slf4j
public class EnterpriseGlobalExceptionHandler {

    // ä¸šåŠ¡å¼‚å¸¸å¤„ç†
    @ExceptionHandler(BusinessException.class)
    public ResponseDTO<Void> handleBusinessException(BusinessException e) {
        log.warn("[ä¸šåŠ¡å¼‚å¸¸] code={}, message={}, traceId={}",
                e.getCode(), e.getMessage(), MDC.get("traceId"));

        return ResponseDTO.error(e.getCode(), e.getMessage())
            .setTraceId(MDC.get("traceId"));
    }

    // å‚æ•°éªŒè¯å¼‚å¸¸å¤„ç†
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ResponseDTO<Map<String, String>> handleValidationException(MethodArgumentNotValidException e) {
        Map<String, String> errors = e.getBindingResult().getFieldErrors().stream()
            .collect(Collectors.toMap(
                FieldError::getField,
                FieldError::getDefaultMessage,
                (existing, replacement) -> existing
            ));

        log.warn("[å‚æ•°éªŒè¯å¼‚å¸¸] errors={}, traceId={}", errors, MDC.get("traceId"));

        return ResponseDTO.error("VALIDATION_ERROR", "å‚æ•°éªŒè¯å¤±è´¥")
            .setData(errors)
            .setTraceId(MDC.get("traceId"));
    }

    // ç³»ç»Ÿå¼‚å¸¸å¤„ç†
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ResponseDTO<Void> handleException(Exception e) {
        String traceId = MDC.get("traceId");
        log.error("[ç³»ç»Ÿå¼‚å¸¸] traceId={}, error={}", traceId, e.getMessage(), e);

        return ResponseDTO.error("SYSTEM_ERROR", "ç³»ç»Ÿå†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•")
            .setTraceId(traceId);
    }
}
```

#### 6.3.2 æ—¥å¿—æ ‡å‡†åŒ–
```java
// ä¼ä¸šçº§æ—¥å¿—è§„èŒƒ
@Slf4j
public class AccessServiceImpl implements AccessService {

    // æ—¥å¿—æ¨¡æ¿å¸¸é‡
    private static final String LOG_TEMPLATE = "[é—¨ç¦æœåŠ¡] operation={}, deviceId={}, cardNo={}, result={}, cost={}ms";

    public ResponseDTO<AccessResultVO> controlAccess(Long deviceId, String cardNo) {
        String traceId = MDC.get("traceId");
        long startTime = System.currentTimeMillis();

        try {
            log.info("[é—¨ç¦æ§åˆ¶] å¼€å§‹å¤„ç† traceId={}, deviceId={}, cardNo={}",
                    traceId, deviceId, maskCardNo(cardNo));

            // ä¸šåŠ¡é€»è¾‘
            AccessResultVO result = processAccessControl(deviceId, cardNo);

            long cost = System.currentTimeMillis() - startTime;
            log.info(LOG_TEMPLATE, "controlAccess", deviceId, maskCardNo(cardNo),
                    result.getAccessResult(), cost);

            return ResponseDTO.ok(result);

        } catch (BusinessException e) {
            long cost = System.currentTimeMillis() - startTime;
            log.warn(LOG_TEMPLATE, "controlAccess", deviceId, maskCardNo(cardNo),
                    "BUSINESS_ERROR", cost, e);
            throw e;

        } catch (Exception e) {
            long cost = System.currentTimeMillis() - startTime;
            log.error(LOG_TEMPLATE, "controlAccess", deviceId, maskCardNo(cardNo),
                    "SYSTEM_ERROR", cost, e);
            throw new SystemException("ACCESS_CONTROL_ERROR", "é—¨ç¦æ§åˆ¶å¤±è´¥", e);
        }
    }

    /**
     * æ•æ„Ÿä¿¡æ¯è„±æ•
     */
    private String maskCardNo(String cardNo) {
        if (cardNo == null || cardNo.length() <= 4) {
            return "****";
        }
        return cardNo.substring(0, 2) + "****" + cardNo.substring(cardNo.length() - 2);
    }
}
```

---

## 7. å®‰å…¨æ¶æ„å¢å¼º

### 7.1 è®¤è¯æˆæƒä¼˜åŒ–

#### 7.1.1 JWT Tokenç®¡ç†
```java
@Component
@Slf4j
public class EnterpriseJwtTokenManager {

    @Value("${app.jwt.secret:ioe-dream-secret-key}")
    private String jwtSecret;

    @Value("${app.jwt.access-token-expiration:900}")  // 15åˆ†é’Ÿ
    private long accessTokenExpiration;

    @Value("${app.jwt.refresh-token-expiration:604800}") // 7å¤©
    private long refreshTokenExpiration;

    /**
     * ç”ŸæˆTokenå¯¹
     */
    public TokenPair generateTokenPair(UserEntity user) {
        String accessToken = generateToken(user, accessTokenExpiration, "access");
        String refreshToken = generateToken(user, refreshTokenExpiration, "refresh");

        // å­˜å‚¨Refresh Tokenåˆ°Redis
        stringRedisTemplate.opsForValue().set(
            "refresh_token:" + user.getId(),
            refreshToken,
            Duration.ofSeconds(refreshTokenExpiration)
        );

        return TokenPair.builder()
            .accessToken(accessToken)
            .refreshToken(refreshToken)
            .expiresIn(accessTokenExpiration)
            .tokenType("Bearer")
            .build();
    }

    /**
     * éªŒè¯å¹¶åˆ·æ–°Token
     */
    public TokenPair refreshTokenPair(String refreshToken) {
        try {
            Claims claims = Jwts.parserBuilder()
                .setSigningKey(jwtSecret)
                .build()
                .parseClaimsJws(refreshToken)
                .getBody();

            Long userId = claims.get("userId", Long.class);
            String storedToken = stringRedisTemplate.opsForValue().get("refresh_token:" + userId);

            if (!refreshToken.equals(storedToken)) {
                throw new SecurityException("Invalid refresh token");
            }

            UserEntity user = userDao.selectById(userId);
            return generateTokenPair(user);

        } catch (Exception e) {
            log.warn("[JWT] Tokenåˆ·æ–°å¤±è´¥: {}", e.getMessage());
            throw new SecurityException("Token refresh failed", e);
        }
    }

    /**
     * ä¸»åŠ¨ä½¿Tokenå¤±æ•ˆ
     */
    public void revokeToken(String token) {
        try {
            Claims claims = parseToken(token);
            Long userId = claims.get("userId", Long.class);

            // åˆ é™¤Redisä¸­çš„Refresh Token
            stringRedisTemplate.delete("refresh_token:" + userId);

            // å°†Access TokenåŠ å…¥é»‘åå•
            String jti = claims.getId();
            long expiration = claims.getExpiration().getTime() - System.currentTimeMillis();
            if (expiration > 0) {
                stringRedisTemplate.opsForValue().set(
                    "blacklist_token:" + jti,
                    "1",
                    Duration.ofMillis(expiration)
                );
            }

        } catch (Exception e) {
            log.error("[JWT] Tokenå¤±æ•ˆå¤±è´¥: {}", e.getMessage(), e);
        }
    }
}
```

#### 7.1.2 æ•°æ®æƒé™æ§åˆ¶
```java
@Component
public class DataAccessPermissionEvaluator {

    /**
     * æ£€æŸ¥æ•°æ®è®¿é—®æƒé™
     */
    public boolean hasPermission(Long userId, String resourceType, Object resourceId) {
        try {
            // 1. è·å–ç”¨æˆ·æƒé™ä¿¡æ¯
            UserPermissionContext context = getUserPermissionContext(userId);

            // 2. è¶…çº§ç®¡ç†å‘˜ç›´æ¥é€šè¿‡
            if (context.isSuperAdmin()) {
                return true;
            }

            // 3. æ ¹æ®èµ„æºç±»å‹æ£€æŸ¥æƒé™
            switch (resourceType) {
                case "department":
                    return checkDepartmentPermission(context, (Long) resourceId);
                case "user":
                    return checkUserPermission(context, (Long) resourceId);
                case "device":
                    return checkDevicePermission(context, (Long) resourceId);
                default:
                    return false;
            }

        } catch (Exception e) {
            log.error("[æ•°æ®æƒé™] æ£€æŸ¥å¤±è´¥ userId={}, resourceType={}, resourceId={}",
                    userId, resourceType, resourceId, e);
            return false;
        }
    }

    /**
     * æ£€æŸ¥éƒ¨é—¨æƒé™
     */
    private boolean checkDepartmentPermission(UserPermissionContext context, Long departmentId) {
        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰éƒ¨é—¨æƒé™
        if (!context.hasPermission("department:view")) {
            return false;
        }

        // 2. æ£€æŸ¥æ˜¯å¦åœ¨ç”¨æˆ·ç®¡è¾–èŒƒå›´å†…
        return context.getAccessibleDepartmentIds().contains(departmentId) ||
               context.getManagedDepartmentIds().contains(departmentId);
    }
}
```

### 7.2 æ¥å£å®‰å…¨åŠ å›º

#### 7.2.1 APIç­¾åéªŒè¯
```java
@Component
@Slf4j
public class ApiSignatureValidator {

    @Value("${app.api.signature.secret}")
    private String signatureSecret;

    /**
     * éªŒè¯APIç­¾å
     */
    public boolean validateSignature(HttpServletRequest request) {
        try {
            // 1. è·å–ç­¾åå‚æ•°
            String timestamp = request.getHeader("X-Timestamp");
            String nonce = request.getHeader("X-Nonce");
            String signature = request.getHeader("X-Signature");

            if (StringUtils.isAnyBlank(timestamp, nonce, signature)) {
                return false;
            }

            // 2. æ£€æŸ¥æ—¶é—´æˆ³æœ‰æ•ˆæ€§ (5åˆ†é’Ÿå†…)
            long requestTime = Long.parseLong(timestamp);
            long currentTime = System.currentTimeMillis();
            if (Math.abs(currentTime - requestTime) > 300000) { // 5åˆ†é’Ÿ
                log.warn("[APIç­¾å] è¯·æ±‚æ—¶é—´æˆ³è¿‡æœŸ: {}", timestamp);
                return false;
            }

            // 3. æ£€æŸ¥nonceæ˜¯å¦é‡å¤
            String nonceKey = "api_nonce:" + nonce;
            if (stringRedisTemplate.hasKey(nonceKey)) {
                log.warn("[APIç­¾å] Nonceé‡å¤: {}", nonce);
                return false;
            }

            // 4. ç”Ÿæˆé¢„æœŸç­¾å
            String expectedSignature = generateSignature(request, timestamp, nonce);

            // 5. å­˜å‚¨nonce (5åˆ†é’Ÿè¿‡æœŸ)
            stringRedisTemplate.opsForValue().set(nonceKey, "1", Duration.ofMinutes(5));

            // 6. æ¯”è¾ƒç­¾å
            return signature.equals(expectedSignature);

        } catch (Exception e) {
            log.error("[APIç­¾å] éªŒè¯å¼‚å¸¸", e);
            return false;
        }
    }

    /**
     * ç”Ÿæˆç­¾å
     */
    private String generateSignature(HttpServletRequest request, String timestamp, String nonce) {
        try {
            // 1. è·å–è¯·æ±‚å‚æ•°
            Map<String, String> params = new TreeMap<>();
            request.getParameterMap().forEach((key, values) -> {
                if (values != null && values.length > 0) {
                    params.put(key, values[0]);
                }
            });

            // 2. è·å–è¯·æ±‚ä½“
            String body = getRequestBody(request);

            // 3. æ„å»ºç­¾åå­—ç¬¦ä¸²
            StringBuilder signString = new StringBuilder();
            signString.append(request.getMethod()).append("\n");
            signString.append(request.getRequestURI()).append("\n");
            signString.append(timestamp).append("\n");
            signString.append(nonce).append("\n");

            // æ·»åŠ å‚æ•°
            params.forEach((key, value) -> signString.append(key).append("=").append(value).append("&"));

            if (!signString.toString().endsWith("&")) {
                signString.setLength(signString.length() - 1);
            }

            signString.append("\n").append(body);

            // 4. ç”ŸæˆHMAC-SHA256ç­¾å
            Mac hmacSha256 = Mac.getInstance("HmacSHA256");
            SecretKeySpec secretKey = new SecretKeySpec(signatureSecret.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
            hmacSha256.init(secretKey);

            byte[] hash = hmacSha256.doFinal(signString.toString().getBytes(StandardCharsets.UTF_8));

            // 5. Base64ç¼–ç 
            return Base64.getEncoder().encodeToString(hash);

        } catch (Exception e) {
            throw new SecurityException("ç­¾åç”Ÿæˆå¤±è´¥", e);
        }
    }
}
```

### 7.3 æ•æ„Ÿæ•°æ®ä¿æŠ¤

#### 7.3.1 æ•°æ®åŠ å¯†å­˜å‚¨
```java
@Component
public class SensitiveDataEncryption {

    private final AESUtil aesUtil;
    private final String encryptionKey;

    public SensitiveDataEncryption(@Value("${app.encryption.key}") String encryptionKey) {
        this.encryptionKey = encryptionKey;
        this.aesUtil = new AESUtil(encryptionKey);
    }

    /**
     * åŠ å¯†æ•æ„Ÿå­—æ®µ
     */
    public String encrypt(String plainText) {
        if (StringUtils.isBlank(plainText)) {
            return plainText;
        }

        try {
            return "ENC(" + aesUtil.encrypt(plainText) + ")";
        } catch (Exception e) {
            log.error("[æ•°æ®åŠ å¯†] åŠ å¯†å¤±è´¥", e);
            throw new SecurityException("æ•°æ®åŠ å¯†å¤±è´¥", e);
        }
    }

    /**
     * è§£å¯†æ•æ„Ÿå­—æ®µ
     */
    public String decrypt(String encryptedText) {
        if (StringUtils.isBlank(encryptedText) || !encryptedText.startsWith("ENC(")) {
            return encryptedText;
        }

        try {
            String cipherText = encryptedText.substring(4, encryptedText.length() - 1);
            return aesUtil.decrypt(cipherText);
        } catch (Exception e) {
            log.error("[æ•°æ®è§£å¯†] è§£å¯†å¤±è´¥: {}", encryptedText, e);
            throw new SecurityException("æ•°æ®è§£å¯†å¤±è´¥", e);
        }
    }

    /**
     * æ‰¹é‡åŠ å¯†å®ä½“å­—æ®µ
     */
    public <T> T encryptEntityFields(T entity, String... fieldNames) {
        try {
            BeanWrapper beanWrapper = new BeanWrapperImpl(entity);

            for (String fieldName : fieldNames) {
                if (beanWrapper.isReadableProperty(fieldName) && beanWrapper.isWritableProperty(fieldName)) {
                    Object value = beanWrapper.getPropertyValue(fieldName);
                    if (value instanceof String) {
                        String encryptedValue = encrypt((String) value);
                        beanWrapper.setPropertyValue(fieldName, encryptedValue);
                    }
                }
            }

            return entity;

        } catch (Exception e) {
            log.error("[æ•°æ®åŠ å¯†] æ‰¹é‡åŠ å¯†å®ä½“å­—æ®µå¤±è´¥", e);
            throw new SecurityException("æ‰¹é‡åŠ å¯†å¤±è´¥", e);
        }
    }
}
```

---

## 8. å¯è§‚æµ‹æ€§æ¶æ„

### 8.1 æŒ‡æ ‡ç›‘æ§ä½“ç³»

#### 8.1.1 PrometheusæŒ‡æ ‡é…ç½®
```java
@Configuration
public class PrometheusMetricsConfiguration {

    @Bean
    public MeterRegistryCustomizer<MeterRegistry> metricsCommonTags() {
        return registry -> registry.config().commonTags(
            "application", "ioe-dream",
            "environment", "${spring.profiles.active:default}",
            "version", "${app.version:2.0.0}"
        );
    }

    @Bean
    public TimedAspect timedAspect(MeterRegistry registry) {
        return new TimedAspect(registry);
    }

    @Bean
    public CountedAspect countedAspect(MeterRegistry registry) {
        return new CountedAspect(registry);
    }
}

// ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†
@Component
@Slf4j
public class BusinessMetricsCollector {

    private final Counter accessControlCounter;
    private final Timer accessControlTimer;
    private final Gauge onlineDeviceGauge;

    public BusinessMetricsCollector(MeterRegistry registry) {
        // è®¿é—®æ§åˆ¶è®¡æ•°å™¨
        this.accessControlCounter = Counter.builder("access.control.count")
            .description("é—¨ç¦æ§åˆ¶æ¬¡æ•°")
            .tag("type", "access")
            .register(registry);

        // è®¿é—®æ§åˆ¶è€—æ—¶
        this.accessControlTimer = Timer.builder("access.control.duration")
            .description("é—¨ç¦æ§åˆ¶è€—æ—¶")
            .tag("type", "access")
            .register(registry);

        // åœ¨çº¿è®¾å¤‡æ•°é‡
        this.onlineDeviceGauge = Gauge.builder("device.online.count")
            .description("åœ¨çº¿è®¾å¤‡æ•°é‡")
            .register(registry, this, BusinessMetricsCollector::getOnlineDeviceCount);
    }

    /**
     * è®°å½•è®¿é—®æ§åˆ¶æŒ‡æ ‡
     */
    public void recordAccessControl(String result, long duration) {
        accessControlCounter.increment(Tags.of("result", result));
        accessControlTimer.record(duration, TimeUnit.MILLISECONDS);

        log.debug("[ä¸šåŠ¡æŒ‡æ ‡] è®°å½•è®¿é—®æ§åˆ¶: result={}, duration={}ms", result, duration);
    }

    /**
     * è·å–åœ¨çº¿è®¾å¤‡æ•°é‡
     */
    private double getOnlineDeviceCount() {
        // ä»ç¼“å­˜æˆ–æ•°æ®åº“è·å–åœ¨çº¿è®¾å¤‡æ•°é‡
        return deviceStatusManager.getOnlineDeviceCount();
    }
}
```

#### 8.1.2 åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
```java
@Configuration
public class TracingConfiguration {

    @Bean
    public SleuthTracerProperties sleuthTracerProperties() {
        SleuthTracerProperties properties = new SleuthTracerProperties();
        properties.setSamplingProbability(0.1); // 10%é‡‡æ ·ç‡
        return properties;
    }

    @Bean
    public SpanCustomizer spanCustomizer() {
        return span -> {
            // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
            span.tag("service.name", "ioe-dream");
            span.tag("service.version", "2.0.0");
            span.tag("service.instance", getInstanceId());
        };
    }
}

// ä¸šåŠ¡é“¾è·¯è¿½è¸ª
@Slf4j
@Component
public class BusinessTraceHandler {

    /**
     * è®°å½•ä¸šåŠ¡æ“ä½œè½¨è¿¹
     */
    public <T> T traceOperation(String operationName, String operationType,
                               Supplier<T> operation) {
        Span span = tracer.nextSpan()
            .name(operationName)
            .tag("operation.type", operationType)
            .tag("user.id", getCurrentUserId())
            .tag("trace.source", "business");

        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span.start())) {
            log.info("[ä¸šåŠ¡è¿½è¸ª] å¼€å§‹: {} {}", operationType, operationName);

            long startTime = System.currentTimeMillis();
            T result = operation.get();
            long duration = System.currentTimeMillis() - startTime;

            span.tag("operation.result", "success");
            span.tag("operation.duration", String.valueOf(duration));
            span.end();

            log.info("[ä¸šåŠ¡è¿½è¸ª] å®Œæˆ: {} {} - {}ms", operationType, operationName, duration);
            return result;

        } catch (Exception e) {
            span.tag("operation.result", "error");
            span.tag("error.message", e.getMessage());
            span.end();

            log.error("[ä¸šåŠ¡è¿½è¸ª] å¼‚å¸¸: {} {} - {}", operationType, operationName, e.getMessage(), e);
            throw e;
        }
    }
}
```

### 8.2 æ—¥å¿—èšåˆåˆ†æ

#### 8.2.1 ç»“æ„åŒ–æ—¥å¿—é…ç½®
```yaml
# logback-spring.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- æ§åˆ¶å°è¾“å‡º -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp/>
                <logLevel/>
                <loggerName/>
                <mdc/>
                <arguments/>
                <stackTrace/>
                <pattern>
                    <pattern>
                        {
                            "application": "ioe-dream",
                            "service": "${spring.application.name:-unknown}",
                            "instance": "${HOSTNAME:-unknown}",
                            "message": "%message"
                        }
                    </pattern>
                </pattern>
            </providers>
        </encoder>
    </appender>

    <!-- æ–‡ä»¶è¾“å‡º -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/${spring.application.name:-app}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/${spring.application.name:-app}.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp/>
                <logLevel/>
                <loggerName/>
                <mdc/>
                <arguments/>
                <stackTrace/>
                <pattern>
                    <pattern>
                        {
                            "application": "ioe-dream",
                            "service": "${spring.application.name:-unknown}",
                            "instance": "${HOSTNAME:-unknown}",
                            "message": "%message"
                        }
                    </pattern>
                </pattern>
            </providers>
        </encoder>
    </appender>

    <!-- ä¸šåŠ¡æ—¥å¿— -->
    <appender name="BUSINESS_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/business.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/business.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>
                <timestamp/>
                <logLevel/>
                <mdc/>
                <pattern>
                    <pattern>
                        {
                            "application": "ioe-dream",
                            "log_type": "business",
                            "message": "%message"
                        }
                    </pattern>
                </pattern>
            </providers>
        </encoder>
    </appender>

    <!-- ä¸šåŠ¡æ—¥å¿—è®°å½•å™¨ -->
    <logger name="business" level="INFO" additivity="false">
        <appender-ref ref="BUSINESS_FILE"/>
    </logger>

    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
    </root>
</configuration>
```

#### 8.2.2 ä¸šåŠ¡æ—¥å¿—è®°å½•
```java
@Component
@Slf4j
public class BusinessLogger {

    private static final Logger BUSINESS_LOG = LoggerFactory.getLogger("business");

    /**
     * è®°å½•é—¨ç¦é€šè¡Œæ—¥å¿—
     */
    public void logAccessRecord(AccessRecordEntity record, AccessResultVO result) {
        BUSINESS_LOG.info("é—¨ç¦é€šè¡Œè®°å½•,userId={},deviceId={},cardNo={},result={},accessTime={}",
                record.getUserId(),
                record.getDeviceId(),
                maskCardNo(record.getCardNo()),
                result.getAccessResult(),
                record.getCreateTime());
    }

    /**
     * è®°å½•æ¶ˆè´¹äº¤æ˜“æ—¥å¿—
     */
    public void logConsumeTransaction(ConsumeRecordEntity record) {
        BUSINESS_LOG.info("æ¶ˆè´¹äº¤æ˜“è®°å½•,userId={},deviceId={},amount={},balance={},consumeTime={}",
                record.getUserId(),
                record.getDeviceId(),
                record.getAmount(),
                record.getBalance(),
                record.getCreateTime());
    }

    /**
     * è®°å½•è€ƒå‹¤æ‰“å¡æ—¥å¿—
     */
    public void logAttendanceRecord(AttendanceRecordEntity record) {
        BUSINESS_LOG.info("è€ƒå‹¤æ‰“å¡è®°å½•,userId={},deviceId={},punchType={},punchTime={}",
                record.getUserId(),
                record.getDeviceId(),
                record.getPunchType(),
                record.getPunchTime());
    }

    /**
     * è®°å½•ç³»ç»Ÿæ“ä½œæ—¥å¿—
     */
    public void logSystemOperation(String operation, String operator, String target, String result) {
        BUSINESS_LOG.info("ç³»ç»Ÿæ“ä½œè®°å½•,operation={},operator={},target={},result={},operateTime={}",
                operation,
                operator,
                target,
                result,
                LocalDateTime.now());
    }
}
```

---

## 9. æµ‹è¯•æ¶æ„ç­–ç•¥

### 9.1 æµ‹è¯•é‡‘å­—å¡”è®¾è®¡

#### 9.1.1 æµ‹è¯•åˆ†å±‚ç»“æ„
```
                    /\
                   /  \
                  / E2E \    <-- ç«¯åˆ°ç«¯æµ‹è¯• (5%)
                 /______\
                /        \
               /  é›†æˆæµ‹è¯•   \   <-- é›†æˆæµ‹è¯• (25%)
              /____________\
             /              \
            /    å•å…ƒæµ‹è¯•      \  <-- å•å…ƒæµ‹è¯• (70%)
           /________________\
```

#### 9.1.2 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡
| æµ‹è¯•ç±»å‹ | è¦†ç›–ç‡ç›®æ ‡ | æ‰§è¡Œé¢‘ç‡ | æ‰§è¡Œç¯å¢ƒ |
|---------|-----------|---------|---------|
| **å•å…ƒæµ‹è¯•** | â‰¥80% (æ ¸å¿ƒ100%) | æ¯æ¬¡æäº¤ | æœ¬åœ°/CI |
| **é›†æˆæµ‹è¯•** | â‰¥70% | æ¯æ—¥æ„å»º | é›†æˆç¯å¢ƒ |
| **ç«¯åˆ°ç«¯æµ‹è¯•** | ä¸»è¦ä¸šåŠ¡æµç¨‹ | å‘å¸ƒå‰ | UATç¯å¢ƒ |
| **æ€§èƒ½æµ‹è¯•** | å…³é”®æ¥å£ | ç‰ˆæœ¬å‘å¸ƒ | æ€§èƒ½ç¯å¢ƒ |
| **å®‰å…¨æµ‹è¯•** | æ‰€æœ‰æ¥å£ | ç‰ˆæœ¬å‘å¸ƒ | å®‰å…¨ç¯å¢ƒ |

### 9.2 æµ‹è¯•åŸºç¡€è®¾æ–½

#### 9.2.1 æµ‹è¯•ç¯å¢ƒé…ç½®
```yaml
# application-test.yml
spring:
  profiles:
    active: test

  # H2å†…å­˜æ•°æ®åº“
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:

  # JPAé…ç½®
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: false

  # Redisä½¿ç”¨åµŒå…¥å¼
  redis:
    host: localhost
    port: 6370
    database: 15  # ä½¿ç”¨ç‹¬ç«‹æ•°æ®åº“

  # RabbitMQæµ‹è¯•é…ç½®
  rabbitmq:
    host: localhost
    port: 5673
    username: guest
    password: guest

# æµ‹è¯•ä¸“ç”¨é…ç½®
test:
  mock-external-services: true
  enable-logging: false
  data-cleanup: true
```

#### 9.2.2 æµ‹è¯•æ•°æ®ç®¡ç†
```java
@TestConfiguration
public class TestDataManager {

    @Bean
    @Primary
    public DataSource testDataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .addScript("schema-test.sql")
            .addScript("data-test.sql")
            .build();
    }

    @Bean
    public TestDataInitializer testDataInitializer() {
        return new TestDataInitializer();
    }
}

@Component
public class TestDataInitializer implements ApplicationListener<ContextRefreshedEvent> {

    @Resource
    private UserDao userDao;

    @Resource
    private AccessDeviceDao accessDeviceDao;

    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        if ("test".equals(activeProfile)) {
            initializeTestData();
        }
    }

    private void initializeTestData() {
        // åˆå§‹åŒ–æµ‹è¯•ç”¨æˆ·
        createTestUsers();

        // åˆå§‹åŒ–æµ‹è¯•è®¾å¤‡
        createTestDevices();

        // åˆå§‹åŒ–æµ‹è¯•æƒé™
        createTestPermissions();

        log.info("[æµ‹è¯•æ•°æ®] åˆå§‹åŒ–å®Œæˆ");
    }
}
```

### 9.3 è‡ªåŠ¨åŒ–æµ‹è¯•æµæ°´çº¿

#### 9.3.1 CI/CDæµ‹è¯•é…ç½®
```yaml
# .github/workflows/test.yml
name: Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  unit-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: Run unit tests
      run: mvn clean test

    - name: Generate test report
      run: mvn jacoco:report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3

  integration-test:
    needs: unit-test
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test
        ports:
          - 3306:3306

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Wait for services
      run: |
        timeout 60 bash -c 'until mysql -h localhost -u root -ppassword -e "SELECT 1"; do sleep 1; done'
        timeout 60 bash -c 'until redis-cli -h localhost ping; do sleep 1; done'

    - name: Run integration tests
      run: mvn clean verify -Pintegration-test

    - name: Generate test report
      run: mvn jacoco:report

  performance-test:
    needs: integration-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Run performance tests
      run: |
        docker-compose -f docker-compose.performance.yml up -d
        sleep 30
        mvn clean verify -Pperformance-test
        docker-compose -f docker-compose.performance.yml down
```

---

## 10. éƒ¨ç½²æ¶æ„ä¼˜åŒ–

### 10.1 å®¹å™¨åŒ–ä¼˜åŒ–

#### 10.1.1 å¤šé˜¶æ®µæ„å»ºDockerfile
```dockerfile
# å¤šé˜¶æ®µæ„å»º - å‡å°‘é•œåƒä½“ç§¯
FROM openjdk:17-jdk-slim as builder

WORKDIR /app
COPY pom.xml .
COPY src ./src

# æ„å»ºåº”ç”¨
RUN ./mvnw clean package -DskipTests

# è¿è¡Œæ—¶é•œåƒ
FROM openjdk:17-jre-slim

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/target/*.jar app.jar

# è®¾ç½®æƒé™
RUN chown -R appuser:appuser /app
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8088/actuator/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8088

# JVMä¼˜åŒ–å‚æ•°
ENV JAVA_OPTS="-Xms512m -Xmx1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### 10.1.2 Docker Composeä¼˜åŒ–
```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # APIç½‘å…³
  gateway:
    image: ioe-dream/gateway:2.0.0
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms256m -Xmx512m
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - nacos
      - redis

  # å…¬å…±æœåŠ¡
  common-service:
    image: ioe-dream/common-service:2.0.0
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms1g -Xmx2g
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - mysql
      - redis
      - nacos

  # æ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/conf.d:/etc/mysql/conf.d
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mysql_data:
  redis_data:

networks:
  default:
    driver: bridge
```

### 10.2 Kuberneteséƒ¨ç½²

#### 10.2.1 K8séƒ¨ç½²é…ç½®
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ioe-dream-common-service
  namespace: ioe-dream
  labels:
    app: ioe-dream-common-service
    version: v2.0.0

spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  selector:
    matchLabels:
      app: ioe-dream-common-service

  template:
    metadata:
      labels:
        app: ioe-dream-common-service
        version: v2.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8088"
        prometheus.io/path: "/actuator/prometheus"

    spec:
      containers:
      - name: common-service
        image: ioe-dream/common-service:2.0.0
        ports:
        - containerPort: 8088
          name: http

        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: JAVA_OPTS
          value: "-Xms1g -Xmx2g -XX:+UseG1GC"
        - name: MYSQL_HOST
          valueFrom:
            configMapKeyRef:
              name: ioe-dream-config
              key: mysql.host
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: ioe-dream-config
              key: redis.host

        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"

        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8088
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8088
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        volumeMounts:
        - name: logs
          mountPath: /app/logs

      volumes:
      - name: logs
        emptyDir: {}

      imagePullSecrets:
      - name: registry-secret

---
apiVersion: v1
kind: Service
metadata:
  name: ioe-dream-common-service
  namespace: ioe-dream
  labels:
    app: ioe-dream-common-service

spec:
  selector:
    app: ioe-dream-common-service

  ports:
  - name: http
    port: 8088
    targetPort: 8088

  type: ClusterIP

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ioe-dream-common-service-hpa
  namespace: ioe-dream

spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ioe-dream-common-service

  minReplicas: 2
  maxReplicas: 5

  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## 11. æœ€ä½³å®è·µåˆè§„æ£€æŸ¥

### 11.1 ä»£ç è´¨é‡æ£€æŸ¥æ¸…å•

#### 11.1.1 æ¶æ„åˆè§„æ£€æŸ¥
```yaml
# æ¶æ„åˆè§„æ£€æŸ¥é¡¹
architecture_compliance:
  - check: "å››å±‚æ¶æ„è§„èŒƒ"
    requirement: "Controller â†’ Service â†’ Manager â†’ DAO"
    validation: "æ— è·¨å±‚è®¿é—®ï¼Œä¾èµ–å…³ç³»æ¸…æ™°"
    status: "âœ… é€šè¿‡"

  - check: "ä¾èµ–æ³¨å…¥è§„èŒƒ"
    requirement: "ç»Ÿä¸€ä½¿ç”¨@Resourceæ³¨è§£"
    validation: "551ä¸ª@Resourceï¼Œ0ä¸ª@Autowiredè¿è§„"
    status: "âœ… é€šè¿‡"

  - check: "DAOå‘½åè§„èŒƒ"
    requirement: "ä½¿ç”¨@Mapperæ³¨è§£å’ŒDaoåç¼€"
    validation: "96ä¸ª@Repositoryéœ€ä¿®å¤ä¸º@Mapper"
    status: "âš ï¸ éœ€ä¿®å¤"

  - check: "Entityè®¾è®¡è§„èŒƒ"
    requirement: "Entityè¡Œæ•°â‰¤400è¡Œï¼Œå­—æ®µâ‰¤30ä¸ª"
    validation: "å‘ç°2ä¸ªè¶…å¤§Entityéœ€æ‹†åˆ†"
    status: "âš ï¸ éœ€ä¼˜åŒ–"

  - check: "Jakarta EEåŒ…å"
    requirement: "ä½¿ç”¨jakarta.annotationç­‰"
    validation: "å®Œå…¨ç¬¦åˆè§„èŒƒ"
    status: "âœ… é€šè¿‡"
```

#### 11.1.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥
```yaml
# æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥é¡¹
performance_optimization:
  - check: "æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–"
    requirement: "è¦†ç›–æ‰€æœ‰æŸ¥è¯¢æ¡ä»¶"
    validation: "37ä¸ªæ€§èƒ½ç´¢å¼•ï¼Œå¤åˆç´¢å¼•éœ€è¡¥å……"
    status: "âš ï¸ éœ€ä¼˜åŒ–"

  - check: "ç¼“å­˜å‘½ä¸­ç‡"
    requirement: "ç¼“å­˜å‘½ä¸­ç‡â‰¥90%"
    validation: "å½“å‰65%ï¼Œéœ€æå‡è‡³90%"
    status: "âš ï¸ éœ€ä¼˜åŒ–"

  - check: "è¿æ¥æ± é…ç½®"
    requirement: "ä½¿ç”¨Druidè¿æ¥æ± "
    validation: "éƒ¨åˆ†æœåŠ¡ä»ä½¿ç”¨HikariCP"
    status: "âš ï¸ éœ€ç»Ÿä¸€"

  - check: "åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–"
    requirement: "é¿å…æ·±åº¦åˆ†é¡µ"
    validation: "38%åˆ†é¡µæŸ¥è¯¢éœ€æ¸¸æ ‡ä¼˜åŒ–"
    status: "âš ï¸ éœ€ä¼˜åŒ–"

  - check: "å†…å­˜ä½¿ç”¨ä¼˜åŒ–"
    requirement: "å †å†…å­˜ä½¿ç”¨â‰¤70%"
    validation: "JVMå‚æ•°éœ€ä¼˜åŒ–"
    status: "âš ï¸ éœ€ä¼˜åŒ–"
```

### 11.2 å®‰å…¨åˆè§„æ£€æŸ¥

#### 11.2.1 å®‰å…¨åŠ å›ºæ¸…å•
```yaml
# å®‰å…¨åˆè§„æ£€æŸ¥é¡¹
security_compliance:
  - check: "é…ç½®å®‰å…¨åŠ å›º"
    requirement: "æ— æ˜æ–‡å¯†ç "
    validation: "64ä¸ªæ˜æ–‡å¯†ç éœ€NacosåŠ å¯†"
    status: "ğŸ”´ ä¸¥é‡"

  - check: "APIæ¥å£å®‰å…¨"
    requirement: "æ‰€æœ‰æ¥å£éœ€è®¤è¯"
    validation: "282ä¸ªå®‰å…¨æ³¨è§£ï¼Œéƒ¨åˆ†æ¥å£æœªä¿æŠ¤"
    status: "âš ï¸ éœ€åŠ å¼º"

  - check: "SQLæ³¨å…¥é˜²æŠ¤"
    requirement: "ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢"
    validation: "å®Œå…¨ä½¿ç”¨MyBatis #{}"
    status: "âœ… é€šè¿‡"

  - check: "XSSé˜²æŠ¤"
    requirement: "è¾“å…¥è¾“å‡ºè¿‡æ»¤"
    validation: "å·²å®ç°è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç "
    status: "âœ… é€šè¿‡"

  - check: "æ•æ„Ÿæ•°æ®ä¿æŠ¤"
    requirement: "æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨"
    validation: "æ‰‹æœºå·ã€èº«ä»½è¯éœ€åŠ å¯†"
    status: "âš ï¸ éœ€åŠ å¼º"
```

### 11.3 è‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥

#### 11.3.1 è´¨é‡é—¨ç¦è„šæœ¬
```bash
#!/bin/bash
# quality-gate.sh - è´¨é‡é—¨ç¦æ£€æŸ¥è„šæœ¬

echo "å¼€å§‹è´¨é‡é—¨ç¦æ£€æŸ¥..."

# 1. ä»£ç è´¨é‡æ£€æŸ¥
echo "æ£€æŸ¥ä»£ç è¦†ç›–ç‡..."
COVERAGE=$(mvn jacoco:report -q | grep "Total Coverage" | awk '{print $3}' | sed 's/%//')
if (( $(echo "$COVERAGE < 80" | bc -l) )); then
    echo "âŒ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³: ${COVERAGE}% < 80%"
    exit 1
fi
echo "âœ… æµ‹è¯•è¦†ç›–ç‡é€šè¿‡: ${COVERAGE}%"

# 2. æ¶æ„åˆè§„æ£€æŸ¥
echo "æ£€æŸ¥æ¶æ„åˆè§„æ€§..."
REPOSITORY_COUNT=$(find . -name "*.java" -exec grep -l "@Repository" {} \; | wc -l)
if [ $REPOSITORY_COUNT -gt 0 ]; then
    echo "âŒ å‘ç°${REPOSITORY_COUNT}ä¸ª@Repositoryæ³¨è§£ï¼Œéœ€ä¿®å¤ä¸º@Mapper"
    exit 1
fi
echo "âœ… æ¶æ„åˆè§„æ£€æŸ¥é€šè¿‡"

# 3. æ€§èƒ½æ£€æŸ¥
echo "æ£€æŸ¥æ€§èƒ½é—®é¢˜..."
LARGE_ENTITY_COUNT=$(find . -name "*Entity.java" -exec wc -l {} \; | awk '$1 > 400' | wc -l)
if [ $LARGE_ENTITY_COUNT -gt 0 ]; then
    echo "âŒ å‘ç°${LARGE_ENTITY_COUNT}ä¸ªè¶…å¤§Entityï¼Œéœ€ä¼˜åŒ–"
    exit 1
fi
echo "âœ… æ€§èƒ½æ£€æŸ¥é€šè¿‡"

# 4. å®‰å…¨æ£€æŸ¥
echo "æ£€æŸ¥å®‰å…¨é—®é¢˜..."
PLAIN_PASSWORD_COUNT=$(grep -r "password:" . --include="*.yml" --include="*.properties" | grep -v "ENC(" | wc -l)
if [ $PLAIN_PASSWORD_COUNT -gt 0 ]; then
    echo "âŒ å‘ç°${PLAIN_PASSWORD_COUNT}ä¸ªæ˜æ–‡å¯†ç ï¼Œéœ€åŠ å¯†"
    exit 1
fi
echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"

echo "ğŸ‰ è´¨é‡é—¨ç¦æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼"
exit 0
```

---

## 12. å®æ–½è·¯çº¿å›¾

### 12.1 é˜¶æ®µæ€§å®æ–½è®¡åˆ’

#### 12.1.1 ç¬¬ä¸€é˜¶æ®µï¼šæ¶æ„åˆè§„ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
```mermaid
gantt
    title IOE-DREAMæ¶æ„ä¼˜åŒ–å®æ–½è®¡åˆ’
    dateFormat  YYYY-MM-DD

    section ç¬¬ä¸€é˜¶æ®µï¼šåˆè§„ä¼˜åŒ–
    Repositoryå‘½åä¿®å¤       :active, repofix, 2025-12-16, 2d
    Entityæ‹†åˆ†ä¼˜åŒ–          :entity, after repofix, 3d
    å››å±‚æ¶æ„è¾¹ç•Œæ£€æŸ¥        :archcheck, after repofix, 2d
    ä¾èµ–æ³¨å…¥è§„èŒƒç»Ÿä¸€        :di-fix, after repofix, 1d

    section ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–
    æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–          :index-opt, after entity, 3d
    ç¼“å­˜æ¶æ„é‡æ„           :cache-refactor, after entity, 3d
    åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–           :pagination-opt, after index-opt, 2d
    JVMå‚æ•°è°ƒä¼˜            :jvm-tuning, after cache-refactor, 2d

    section ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•å¢å¼º
    æµ‹è¯•æ¡†æ¶æ­å»º           :test-framework, after pagination-opt, 2d
    å•å…ƒæµ‹è¯•ç¼–å†™           :unit-test, after test-framework, 5d
    é›†æˆæµ‹è¯•å®ç°           :integration-test, after unit-test, 3d
    CI/CDæµæ°´çº¿ä¼˜åŒ–         :cicd-opt, after integration-test, 2d

    section ç¬¬å››é˜¶æ®µï¼šå®‰å…¨åŠ å›º
    é…ç½®å®‰å…¨åŠ å›º           :security-config, after cicd-opt, 2d
    APIç­¾åéªŒè¯            :api-signature, after security-config, 3d
    æ•°æ®åŠ å¯†å­˜å‚¨           :data-encryption, after api-signature, 2d
    æƒé™ä½“ç³»å®Œå–„           :permission-enhance, after data-encryption, 3d

    section ç¬¬äº”é˜¶æ®µï¼šå¯è§‚æµ‹æ€§
    ç›‘æ§ä½“ç³»æ­å»º           :monitoring, after permission-enhance, 3d
    é“¾è·¯è¿½è¸ªé›†æˆ           :tracing, after monitoring, 2d
    æ—¥å¿—èšåˆåˆ†æ           :logging, after tracing, 2d
    å‘Šè­¦è§„åˆ™é…ç½®           :alerting, after logging, 2d
```

### 12.2 å…³é”®é‡Œç¨‹ç¢‘

#### 12.2.1 é‡Œç¨‹ç¢‘ç›®æ ‡
```yaml
milestones:
  - name: "æ¶æ„åˆè§„è¾¾æ ‡"
    date: "2025-12-20"
    criteria:
      - Repositoryè¿è§„ä¿®å¤: 100%
      - Entityè¡Œæ•°ä¼˜åŒ–: <200è¡Œ
      - å››å±‚æ¶æ„è¾¹ç•Œ: é›¶è¿è§„
    success_metrics:
      - ä»£ç è´¨é‡è¯„åˆ†: 85/100 â†’ 95/100
      - æ¶æ„åˆè§„æ€§: 85/100 â†’ 98/100

  - name: "æ€§èƒ½ä¼˜åŒ–å®Œæˆ"
    date: "2025-12-31"
    criteria:
      - æ•°æ®åº“ç´¢å¼•è¦†ç›–: 100%
      - ç¼“å­˜å‘½ä¸­ç‡: â‰¥90%
      - APIå“åº”æ—¶é—´: P99 < 500ms
    success_metrics:
      - æ€§èƒ½è¯„åˆ†: 70/100 â†’ 90/100
      - æŸ¥è¯¢æ€§èƒ½æå‡: 300%

  - name: "æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡"
    date: "2026-01-15"
    criteria:
      - å•å…ƒæµ‹è¯•è¦†ç›–ç‡: â‰¥80%
      - æ ¸å¿ƒä¸šåŠ¡è¦†ç›–ç‡: 100%
      - CI/CDé€šè¿‡ç‡: 100%
    success_metrics:
      - æµ‹è¯•è¯„åˆ†: 9.4/100 â†’ 85/100
      - äº¤ä»˜è´¨é‡: æ˜¾è‘—æå‡

  - name: "å®‰å…¨ç­‰ä¿åˆè§„"
    date: "2026-01-20"
    criteria:
      - é…ç½®å®‰å…¨åŠ å›º: 100%
      - APIæ¥å£ä¿æŠ¤: 100%
      - æ•°æ®åŠ å¯†å­˜å‚¨: 100%
    success_metrics:
      - å®‰å…¨è¯„åˆ†: 88/100 â†’ 98/100
      - ç­‰ä¿åˆè§„: è¾¾åˆ°ä¸‰çº§

  - name: "å¯è§‚æµ‹æ€§å®Œå–„"
    date: "2026-01-25"
    criteria:
      - ç›‘æ§æŒ‡æ ‡è¦†ç›–: 100%
      - é“¾è·¯è¿½è¸ªè¦†ç›–: 100%
      - æ—¥å¿—ç»“æ„åŒ–: 100%
    success_metrics:
      - å¯è§‚æµ‹æ€§: 76/100 â†’ 95/100
      - è¿ç»´æ•ˆç‡: æå‡200%
```

### 12.3 è´¨é‡ä¿è¯æœºåˆ¶

#### 12.3.1 æŒç»­æ”¹è¿›å¾ªç¯
```java
@Component
public class ContinuousImprovementManager {

    /**
     * è´¨é‡è¯„ä¼°å¾ªç¯
     */
    @Scheduled(cron = "0 0 1 * * ?") // æ¯æœˆæ‰§è¡Œ
    public void qualityAssessmentCycle() {
        try {
            // 1. æ”¶é›†è´¨é‡æŒ‡æ ‡
            QualityMetrics metrics = collectQualityMetrics();

            // 2. åˆ†æè´¨é‡è¶‹åŠ¿
            QualityTrendAnalysis trendAnalysis = analyzeQualityTrend(metrics);

            // 3. è¯†åˆ«æ”¹è¿›æœºä¼š
            List<ImprovementOpportunity> opportunities = identifyImprovementOpportunities(trendAnalysis);

            // 4. åˆ¶å®šæ”¹è¿›è®¡åˆ’
            ImprovementPlan plan = createImprovementPlan(opportunities);

            // 5. æ‰§è¡Œæ”¹è¿›æªæ–½
            executeImprovementPlan(plan);

            // 6. éªŒè¯æ”¹è¿›æ•ˆæœ
            validateImprovementEffectiveness(plan);

        } catch (Exception e) {
            log.error("[æŒç»­æ”¹è¿›] è´¨é‡è¯„ä¼°å¼‚å¸¸", e);
        }
    }

    /**
     * æ”¶é›†è´¨é‡æŒ‡æ ‡
     */
    private QualityMetrics collectQualityMetrics() {
        return QualityMetrics.builder()
            .codeQuality(getCodeQualityScore())
            .testCoverage(getTestCoveragePercentage())
            .performanceScore(getPerformanceScore())
            .securityScore(getSecurityScore())
            .architectureCompliance(getArchitectureComplianceScore())
            .build();
    }
}
```

---

## ğŸ“š é™„å½•

### A. å‚è€ƒæ–‡æ¡£

- [Spring Boot 3.5.8 å®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-boot)
- [Spring Cloud 2025.0.0 å®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-cloud)
- [MyBatis-Plus 3.5.15 å®˜æ–¹æ–‡æ¡£](https://baomidou.com/)
- [Vue 3.4.x å®˜æ–¹æ–‡æ¡£](https://vuejs.org/)
- [Redis 7.x å®˜æ–¹æ–‡æ¡£](https://redis.io/)
- [MySQL 8.0 å®˜æ–¹æ–‡æ¡£](https://dev.mysql.com/doc/refman/8.0/en/)

### B. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|-----|---------|
| v2.0.0 | 2025-12-16 | æ¶æ„å¸ˆå›¢é˜Ÿ | åŸºäºå…¨å±€ä»£ç åˆ†æçš„ä¼ä¸šçº§å¢å¼ºç‰ˆ |
| v1.0.0 | 2025-12-02 | æ¶æ„å¸ˆå›¢é˜Ÿ | åˆå§‹ç‰ˆæœ¬ |

### C. è´¨é‡è¯„åˆ†è¯¦æƒ…

| è¯„ä¼°ç»´åº¦ | å½“å‰è¯„åˆ† | ç›®æ ‡è¯„åˆ† | ä¸»è¦æ”¹è¿›æªæ–½ |
|---------|---------|---------|-------------|
| **æ•´ä½“æ¶æ„** | 80/100 | 95/100 | å¾®æœåŠ¡ä¼˜åŒ–ã€è¾¹ç•Œæ¸…æ™° |
| **ä»£ç è´¨é‡** | 82/100 | 95/100 | Repositoryä¿®å¤ã€Entityä¼˜åŒ– |
| **æ€§èƒ½è¡¨ç°** | 70/100 | 90/100 | ç¼“å­˜ä¼˜åŒ–ã€ç´¢å¼•å®Œå–„ |
| **å®‰å…¨ä½“ç³»** | 88/100 | 98/100 | é…ç½®åŠ å›ºã€APIå®‰å…¨ |
| **æµ‹è¯•è¦†ç›–** | 9.4/100 | 85/100 | æµ‹è¯•æ¡†æ¶ã€ç”¨ä¾‹ç¼–å†™ |
| **å¯è§‚æµ‹æ€§** | 76/100 | 95/100 | ç›‘æ§ä½“ç³»ã€é“¾è·¯è¿½è¸ª |

---

**ğŸ“ æŠ€æœ¯æ”¯æŒ**: æ¶æ„å¸ˆå›¢é˜Ÿ
**ğŸ“§ é‚®ç®±**: architecture@ioe-dream.com
**ğŸ“… æœ€åæ›´æ–°**: 2025-12-16
**ğŸ”— ç‰ˆæœ¬**: v2.0.0 - ä¼ä¸šçº§å¢å¼ºç‰ˆ