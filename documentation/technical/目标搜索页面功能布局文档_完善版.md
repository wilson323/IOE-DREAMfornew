# 目标搜索页面功能与布局文档

## 页面概述
目标搜索页面是智能视频监控系统的核心功能模块，用于基于目标属性和图片进行智能检索。该页面支持多种目标类型（人员、车辆、物体）的精准搜索，提供以图搜图、属性筛选、时空检索等功能，通过AI算法实现快速准确的目标定位和轨迹追踪。页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供直观的搜索界面、实时进度显示、多维度结果展示等功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **图片处理**: Compressor.js 1.2.1（图片压缩）
- **文件上传**: Ant Design Upload组件

### 项目文件组织结构
```
src/views/business/smart-video/
├── target-search/
│   ├── index.vue                       # 目标搜索主页面
│   ├── components/
│   │   ├── SearchPanel.vue            # 左侧搜索条件面板
│   │   ├── FilterConditions.vue      # 筛选条件组件
│   │   ├── ImageUpload.vue            # 图片上传组件
│   │   ├── SearchProgress.vue         # 搜索进度条组件
│   │   ├── ResultsGrid.vue            # 结果网格视图组件
│   │   ├── ResultsList.vue            # 结果列表视图组件
│   │   ├── ResultCard.vue             # 结果卡片组件
│   │   ├── ResultsSummary.vue         # 结果统计组件
│   │   ├── SamplePanel.vue            # 右侧样本面板组件
│   │   ├── SearchHistory.vue          # 搜索历史组件
│   │   ├── QuickActions.vue           # 快速操作组件
│   │   ├── TrajectoryDialog.vue       # 轨迹分析弹窗
│   │   ├── BatchSearchDialog.vue      # 批量检索弹窗
│   │   └── ResultDetailDrawer.vue     # 结果详情抽屉
│   ├── hooks/
│   │   ├── useTargetSearch.js         # 目标搜索业务逻辑Hook
│   │   ├── useImageUpload.js          # 图片上传Hook
│   │   ├── useSearchFilters.js        # 筛选条件管理Hook
│   │   └── useSearchHistory.js        # 搜索历史Hook
│   ├── mock/
│   │   └── target-search-mock.js      # 模拟数据
│   └── api/
│       └── target-search-api.js       # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/target-search-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const targetSearchApi = {
  // 开始目标检索
  startSearch: (params) => postRequest('/target-search/start', params),

  // 以图搜图
  searchByImage: (params) => postRequest('/target-search/image', params),

  // 获取搜索进度
  getSearchProgress: (taskId) => getRequest(`/target-search/progress/${taskId}`),

  // 获取搜索结果
  getSearchResults: (taskId) => getRequest(`/target-search/results/${taskId}`),

  // 取消搜索
  cancelSearch: (taskId) => postRequest(`/target-search/cancel/${taskId}`),

  // 获取搜索历史
  getSearchHistory: (params) => getRequest('/target-search/history', params),

  // 保存搜索条件
  saveSearchCondition: (params) => postRequest('/target-search/save-condition', params),

  // 删除搜索历史
  deleteSearchHistory: (id) => postRequest(`/target-search/history/delete/${id}`),

  // 导出搜索结果
  exportResults: (params) => postRequest('/target-search/export', params),

  // 批量检索
  batchSearch: (params) => postRequest('/target-search/batch', params),

  // 获取轨迹数据
  getTrajectory: (params) => postRequest('/target-search/trajectory', params),

  // 上传目标样本图片
  uploadSample: (file) => {
    const formData = new FormData();
    formData.append('file', file);
    return postRequest('/target-search/upload-sample', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
    });
  },

  // 获取设备列表
  getDeviceList: () => getRequest('/target-search/devices'),

  // 获取区域列表
  getAreaList: () => getRequest('/target-search/areas'),

  // 添加到黑名单
  addToBlacklist: (params) => postRequest('/target-search/blacklist/add', params),

  // 创建告警规则
  createAlert: (params) => postRequest('/target-search/alert/create', params),

  // 导出视频片段
  exportVideoClip: (params) => postRequest('/target-search/video/export', params),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. 图片上传注意事项

#### ❌ 错误用法：未对上传图片进行压缩和校验
```vue
<!-- 错误：直接上传原图，可能导致请求过大 -->
<script setup>
import { Upload } from 'ant-design-vue';

const handleUpload = (file) => {
  // ❌ 直接上传，没有压缩和校验
  targetSearchApi.uploadSample(file);
};
</script>
```

#### ✅ 正确用法：完整的图片上传处理
```vue
<template>
  <a-upload
    :before-upload="handleBeforeUpload"
    :custom-request="handleCustomRequest"
    :show-upload-list="false"
    accept="image/jpeg,image/png,image/jpg"
  >
    <a-button>
      <template #icon><UploadOutlined /></template>
      上传样本
    </a-button>
  </a-upload>
</template>

<script setup>
import { ref } from 'vue';
import { message } from 'ant-design-vue';
import { UploadOutlined } from '@ant-design/icons-vue';
import Compressor from 'compressorjs';
import { targetSearchApi } from '/@/api/business/smart-video/target-search-api';

const uploading = ref(false);

// 上传前校验
const handleBeforeUpload = (file) => {
  // ✅ 校验文件类型
  const isImage = file.type === 'image/jpeg' || file.type === 'image/png' || file.type === 'image/jpg';
  if (!isImage) {
    message.error('只支持上传 JPG/PNG 格式的图片！');
    return false;
  }

  // ✅ 校验文件大小（限制为10MB）
  const isLt10M = file.size / 1024 / 1024 < 10;
  if (!isLt10M) {
    message.error('图片大小不能超过 10MB！');
    return false;
  }

  return true;
};

// 自定义上传处理
const handleCustomRequest = async ({ file, onSuccess, onError }) => {
  try {
    uploading.value = true;

    // ✅ 压缩图片
    const compressedFile = await compressImage(file);

    // ✅ 上传压缩后的图片
    const response = await targetSearchApi.uploadSample(compressedFile);

    if (response.code === 0) {
      message.success('上传成功');
      onSuccess(response.data);
    } else {
      message.error(response.message || '上传失败');
      onError(new Error(response.message));
    }
  } catch (error) {
    console.error('上传失败:', error);
    message.error('上传失败，请重试');
    onError(error);
  } finally {
    uploading.value = false;
  }
};

// 压缩图片
const compressImage = (file) => {
  return new Promise((resolve, reject) => {
    new Compressor(file, {
      quality: 0.8, // 压缩质量
      maxWidth: 1920, // 最大宽度
      maxHeight: 1080, // 最大高度
      success(result) {
        resolve(result);
      },
      error(err) {
        reject(err);
      },
    });
  });
};
</script>
```

### 2. 搜索进度实时更新注意事项

#### ❌ 错误用法：频繁轮询导致性能问题
```vue
<!-- 错误：轮询间隔过短，造成服务器压力 -->
<script setup>
// ❌ 每100ms轮询一次，太频繁
const pollProgress = () => {
  const timer = setInterval(async () => {
    await fetchProgress();
  }, 100); // 太频繁！
};
</script>
```

#### ✅ 正确用法：合理的轮询策略
```vue
<script setup>
import { ref, onUnmounted } from 'vue';
import { targetSearchApi } from '/@/api/business/smart-video/target-search-api';

const searchTaskId = ref('');
const searchProgress = ref(0);
const isSearching = ref(false);
let progressTimer = null;
let pollCount = 0;
const MAX_POLL_COUNT = 600; // 最多轮询10分钟（600次 * 1秒）

// ✅ 开始轮询搜索进度
const startPollingProgress = (taskId) => {
  searchTaskId.value = taskId;
  isSearching.value = true;
  pollCount = 0;

  progressTimer = setInterval(async () => {
    try {
      const response = await targetSearchApi.getSearchProgress(taskId);

      if (response.code === 0) {
        searchProgress.value = response.data.progress;

        // ✅ 搜索完成，停止轮询
        if (response.data.status === 'completed') {
          stopPollingProgress();
          await loadSearchResults(taskId);
        }

        // ✅ 搜索失败，停止轮询
        if (response.data.status === 'failed') {
          stopPollingProgress();
          message.error(response.data.error || '搜索失败');
        }
      }

      pollCount++;

      // ✅ 超时保护，防止无限轮询
      if (pollCount >= MAX_POLL_COUNT) {
        stopPollingProgress();
        message.warning('搜索超时，请重试');
      }
    } catch (error) {
      console.error('获取搜索进度失败:', error);
    }
  }, 1000); // ✅ 1秒轮询一次，合理的间隔
};

// 停止轮询
const stopPollingProgress = () => {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
  isSearching.value = false;
  pollCount = 0;
};

// 组件销毁时清理定时器
onUnmounted(() => {
  stopPollingProgress();
});
</script>
```

### 3. 图标使用注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：这些图标可能不存在 -->
<script setup>
import {
  SearchTargetOutlined,    // ❌ 不存在
  PersonOutlined,          // ❌ 不存在
  CarOutlined,             // ❌ 不存在
  TrajectoryOutlined       // ❌ 不存在
} from '@ant-design/icons-vue';
</script>
```

#### ✅ 正确：使用实际存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  SearchOutlined,         // ✅ 搜索
  UserOutlined,           // ✅ 人员
  CarOutlined,            // ✅ 车辆（实际存在）
  InboxOutlined,          // ✅ 物体/物品
  PictureOutlined,        // ✅ 图片/样本
  ClockCircleOutlined,    // ✅ 时间
  EnvironmentOutlined,    // ✅ 地点/位置
  FilterOutlined,         // ✅ 筛选
  UploadOutlined,         // ✅ 上传
  DownloadOutlined,       // ✅ 下载
  ReloadOutlined,         // ✅ 刷新
  ClearOutlined,          // ✅ 清空
  PlayCircleOutlined,     // ✅ 播放
  EyeOutlined,            // ✅ 查看
  LineChartOutlined,      // ✅ 轨迹/趋势
  ApartmentOutlined,      // ✅ 轨迹/路径
  AppstoreOutlined,       // ✅ 网格视图
  UnorderedListOutlined,  // ✅ 列表视图
  HistoryOutlined,        // ✅ 历史记录
  StopOutlined,           // ✅ 停止
  LoadingOutlined,        // ✅ 加载中
  CheckCircleOutlined,    // ✅ 成功
  CloseCircleOutlined,    // ✅ 失败
  ExclamationCircleOutlined, // ✅ 警告
  BellOutlined,           // ✅ 告警
  VideoCameraOutlined,    // ✅ 摄像头
  FileExcelOutlined,      // ✅ 导出Excel
} from '@ant-design/icons-vue';
</script>
```

### 4. 搜索结果展示注意事项

#### ✅ 正确：虚拟滚动处理大量结果
```vue
<template>
  <div class="results-container">
    <!-- 结果数量较少时，使用普通渲染 -->
    <div v-if="results.length < 50" class="results-grid">
      <ResultCard
        v-for="result in results"
        :key="result.id"
        :data="result"
        @view="handleView"
        @play="handlePlay"
      />
    </div>

    <!-- 结果数量较多时，使用虚拟滚动 -->
    <a-list
      v-else
      :data-source="results"
      :grid="{ gutter: 16, xs: 1, sm: 2, md: 3, lg: 4, xl: 4, xxl: 6 }"
      :pagination="{
        pageSize: 24,
        showSizeChanger: true,
        showQuickJumper: true,
        showTotal: (total) => `共 ${total} 条结果`,
      }"
    >
      <template #renderItem="{ item }">
        <a-list-item>
          <ResultCard
            :data="item"
            @view="handleView"
            @play="handlePlay"
          />
        </a-list-item>
      </template>
    </a-list>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import ResultCard from './ResultCard.vue';

const results = ref([]);

const handleView = (resultId) => {
  console.log('查看结果:', resultId);
};

const handlePlay = (resultId) => {
  console.log('播放视频:', resultId);
};
</script>
```

### 5. 筛选条件管理注意事项

#### ✅ 正确：使用Pinia管理搜索条件
```javascript
// src/store/modules/target-search.js
import { defineStore } from 'pinia';

export const useTargetSearchStore = defineStore('targetSearch', {
  state: () => ({
    // 搜索条件
    searchCondition: {
      targetType: 'person', // 目标类型
      timeRange: {
        start: null,
        end: null,
      },
      devices: [], // 选中的设备
      similarity: 80, // 相似度阈值
      filters: {
        color: '', // 颜色
        gender: '', // 性别
        ageGroup: '', // 年龄段
        vehicleType: '', // 车辆类型
        plateNumber: '', // 车牌号
      },
    },

    // 搜索历史
    searchHistory: [],

    // 当前搜索任务
    currentTask: null,

    // 搜索结果
    searchResults: [],

    // 样本图片
    sampleImage: null,
  }),

  actions: {
    // 更新搜索条件
    updateSearchCondition(condition) {
      this.searchCondition = { ...this.searchCondition, ...condition };
    },

    // 重置搜索条件
    resetSearchCondition() {
      this.searchCondition = {
        targetType: 'person',
        timeRange: { start: null, end: null },
        devices: [],
        similarity: 80,
        filters: {
          color: '',
          gender: '',
          ageGroup: '',
          vehicleType: '',
          plateNumber: '',
        },
      };
      this.sampleImage = null;
    },

    // 保存搜索历史
    addSearchHistory(record) {
      this.searchHistory.unshift({
        ...record,
        timestamp: new Date().toISOString(),
      });

      // 只保留最近20条
      if (this.searchHistory.length > 20) {
        this.searchHistory = this.searchHistory.slice(0, 20);
      }
    },

    // 删除搜索历史
    removeSearchHistory(index) {
      this.searchHistory.splice(index, 1);
    },

    // 设置当前任务
    setCurrentTask(task) {
      this.currentTask = task;
    },

    // 设置搜索结果
    setSearchResults(results) {
      this.searchResults = results;
    },

    // 设置样本图片
    setSampleImage(image) {
      this.sampleImage = image;
    },
  },
});
```

## 核心功能模块

### 1. 左侧搜索面板

**位置**: 页面左侧，固定宽度320px

**功能说明**:
- 目标类型选择：人员、车辆、物体、全部类型
- 时间范围选择：开始时间、结束时间
- 设备选择：支持多选，可选择全部设备或指定设备
- 相似度阈值：60%-95%可调
- 高级筛选：颜色、性别、年龄段、车辆类型、车牌号等
- 搜索按钮、清空条件按钮

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/SearchPanel.vue -->
<template>
  <div class="search-panel">
    <a-card :bordered="false" title="搜索条件">
      <a-form layout="vertical">
        <!-- 目标类型 -->
        <a-form-item label="目标类型">
          <a-select
            v-model:value="searchCondition.targetType"
            placeholder="请选择目标类型"
            @change="handleTargetTypeChange"
          >
            <a-select-option value="person">
              <UserOutlined /> 人员
            </a-select-option>
            <a-select-option value="vehicle">
              <CarOutlined /> 车辆
            </a-select-option>
            <a-select-option value="object">
              <InboxOutlined /> 物体
            </a-select-option>
            <a-select-option value="all">
              <AppstoreOutlined /> 全部类型
            </a-select-option>
          </a-select>
        </a-form-item>

        <!-- 时间范围 -->
        <a-form-item label="时间范围">
          <a-space direction="vertical" style="width: 100%">
            <a-date-picker
              v-model:value="searchCondition.timeRange.start"
              show-time
              placeholder="开始时间"
              style="width: 100%"
              format="YYYY-MM-DD HH:mm:ss"
            />
            <a-date-picker
              v-model:value="searchCondition.timeRange.end"
              show-time
              placeholder="结束时间"
              style="width: 100%"
              format="YYYY-MM-DD HH:mm:ss"
            />
          </a-space>
        </a-form-item>

        <!-- 监控设备 -->
        <a-form-item label="监控设备">
          <div class="device-selection">
            <a-checkbox
              v-model:checked="allDevicesSelected"
              @change="handleAllDevicesChange"
            >
              全部设备
            </a-checkbox>
            <div class="device-list">
              <a-checkbox
                v-for="device in deviceList"
                :key="device.id"
                v-model:checked="device.selected"
                @change="handleDeviceChange"
              >
                {{ device.name }}
              </a-checkbox>
            </div>
          </div>
        </a-form-item>

        <!-- 相似度阈值 -->
        <a-form-item label="相似度阈值">
          <div class="similarity-control">
            <a-slider
              v-model:value="searchCondition.similarity"
              :min="60"
              :max="95"
              :marks="{ 60: '60%', 75: '75%', 90: '90%' }"
            />
            <span class="similarity-value">{{ searchCondition.similarity }}%</span>
          </div>
        </a-form-item>

        <!-- 高级筛选 -->
        <a-divider>高级筛选</a-divider>

        <!-- 人员筛选 -->
        <template v-if="searchCondition.targetType === 'person'">
          <a-form-item label="性别">
            <a-select v-model:value="searchCondition.filters.gender" placeholder="不限">
              <a-select-option value="">不限</a-select-option>
              <a-select-option value="male">男</a-select-option>
              <a-select-option value="female">女</a-select-option>
            </a-select>
          </a-form-item>

          <a-form-item label="年龄段">
            <a-select v-model:value="searchCondition.filters.ageGroup" placeholder="不限">
              <a-select-option value="">不限</a-select-option>
              <a-select-option value="child">儿童（0-12岁）</a-select-option>
              <a-select-option value="youth">青年（13-30岁）</a-select-option>
              <a-select-option value="middle">中年（31-55岁）</a-select-option>
              <a-select-option value="elderly">老年（56岁以上）</a-select-option>
            </a-select>
          </a-form-item>

          <a-form-item label="衣着颜色">
            <a-select v-model:value="searchCondition.filters.color" placeholder="不限">
              <a-select-option value="">不限</a-select-option>
              <a-select-option value="red">红色</a-select-option>
              <a-select-option value="blue">蓝色</a-select-option>
              <a-select-option value="green">绿色</a-select-option>
              <a-select-option value="black">黑色</a-select-option>
              <a-select-option value="white">白色</a-select-option>
              <a-select-option value="yellow">黄色</a-select-option>
              <a-select-option value="gray">灰色</a-select-option>
            </a-select>
          </a-form-item>
        </template>

        <!-- 车辆筛选 -->
        <template v-if="searchCondition.targetType === 'vehicle'">
          <a-form-item label="车辆类型">
            <a-select v-model:value="searchCondition.filters.vehicleType" placeholder="不限">
              <a-select-option value="">不限</a-select-option>
              <a-select-option value="car">轿车</a-select-option>
              <a-select-option value="suv">SUV</a-select-option>
              <a-select-option value="truck">货车</a-select-option>
              <a-select-option value="bus">客车</a-select-option>
              <a-select-option value="motorcycle">摩托车</a-select-option>
            </a-select>
          </a-form-item>

          <a-form-item label="车辆颜色">
            <a-select v-model:value="searchCondition.filters.color" placeholder="不限">
              <a-select-option value="">不限</a-select-option>
              <a-select-option value="red">红色</a-select-option>
              <a-select-option value="blue">蓝色</a-select-option>
              <a-select-option value="black">黑色</a-select-option>
              <a-select-option value="white">白色</a-select-option>
              <a-select-option value="silver">银色</a-select-option>
              <a-select-option value="gray">灰色</a-select-option>
            </a-select>
          </a-form-item>

          <a-form-item label="车牌号">
            <a-input
              v-model:value="searchCondition.filters.plateNumber"
              placeholder="输入车牌号（支持模糊搜索）"
            />
          </a-form-item>
        </template>

        <!-- 通用颜色筛选（物体） -->
        <template v-if="searchCondition.targetType === 'object'">
          <a-form-item label="颜色">
            <a-select v-model:value="searchCondition.filters.color" placeholder="不限">
              <a-select-option value="">不限</a-select-option>
              <a-select-option value="red">红色</a-select-option>
              <a-select-option value="blue">蓝色</a-select-option>
              <a-select-option value="green">绿色</a-select-option>
              <a-select-option value="black">黑色</a-select-option>
              <a-select-option value="white">白色</a-select-option>
              <a-select-option value="yellow">黄色</a-select-option>
            </a-select>
          </a-form-item>
        </template>

        <!-- 操作按钮 -->
        <a-space style="width: 100%; margin-top: 16px" direction="vertical">
          <a-button
            type="primary"
            block
            size="large"
            :loading="isSearching"
            :disabled="!canSearch"
            @click="handleStartSearch"
          >
            <template #icon><SearchOutlined /></template>
            开始检索
          </a-button>
          <a-button block @click="handleClearFilters">
            <template #icon><ClearOutlined /></template>
            清空条件
          </a-button>
        </a-space>
      </a-form>
    </a-card>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  SearchOutlined,
  ClearOutlined,
  UserOutlined,
  CarOutlined,
  InboxOutlined,
  AppstoreOutlined,
} from '@ant-design/icons-vue';
import { useTargetSearchStore } from '/@/store/modules/target-search';
import { targetSearchApi } from '/@/api/business/smart-video/target-search-api';

const emit = defineEmits(['start-search']);

const searchStore = useTargetSearchStore();
const searchCondition = computed(() => searchStore.searchCondition);
const isSearching = ref(false);
const allDevicesSelected = ref(true);

// 设备列表
const deviceList = ref([
  { id: 1, name: '主入口', selected: false },
  { id: 2, name: '停车场', selected: false },
  { id: 3, name: '大厅', selected: false },
  { id: 4, name: '走廊', selected: false },
  { id: 5, name: '电梯间', selected: false },
]);

// 是否可以开始搜索
const canSearch = computed(() => {
  // 必须选择时间范围或上传样本图片
  const hasTimeRange = searchCondition.value.timeRange.start && searchCondition.value.timeRange.end;
  const hasSampleImage = searchStore.sampleImage !== null;
  return hasTimeRange || hasSampleImage;
});

// 目标类型变化
const handleTargetTypeChange = () => {
  // 清空筛选条件
  searchStore.updateSearchCondition({
    filters: {
      color: '',
      gender: '',
      ageGroup: '',
      vehicleType: '',
      plateNumber: '',
    },
  });
};

// 全部设备选择变化
const handleAllDevicesChange = (e) => {
  if (e.target.checked) {
    deviceList.value.forEach(device => {
      device.selected = false;
    });
  }
};

// 单个设备选择变化
const handleDeviceChange = () => {
  const hasSelected = deviceList.value.some(device => device.selected);
  allDevicesSelected.value = !hasSelected;
};

// 开始检索
const handleStartSearch = async () => {
  if (!canSearch.value) {
    message.warning('请设置时间范围或上传样本图片');
    return;
  }

  try {
    isSearching.value = true;

    // 获取选中的设备
    const selectedDevices = allDevicesSelected.value
      ? []
      : deviceList.value.filter(d => d.selected).map(d => d.id);

    const params = {
      targetType: searchCondition.value.targetType,
      timeRange: searchCondition.value.timeRange,
      devices: selectedDevices,
      similarity: searchCondition.value.similarity,
      filters: searchCondition.value.filters,
      sampleImage: searchStore.sampleImage,
    };

    // 调用搜索接口
    const response = await targetSearchApi.startSearch(params);

    if (response.code === 0) {
      // 保存到搜索历史
      searchStore.addSearchHistory({
        targetType: searchCondition.value.targetType,
        condition: params,
        timestamp: new Date(),
      });

      // 触发搜索事件
      emit('start-search', response.data);
    } else {
      message.error(response.message || '搜索失败');
    }
  } catch (error) {
    console.error('开始检索失败:', error);
    message.error('搜索失败，请重试');
  } finally {
    isSearching.value = false;
  }
};

// 清空筛选条件
const handleClearFilters = () => {
  searchStore.resetSearchCondition();
  allDevicesSelected.value = true;
  deviceList.value.forEach(device => {
    device.selected = false;
  });
  message.info('搜索条件已清空');
};

// 加载设备列表
const loadDevices = async () => {
  try {
    const response = await targetSearchApi.getDeviceList();
    if (response.code === 0) {
      deviceList.value = response.data.map(device => ({
        id: device.id,
        name: device.name,
        selected: false,
      }));
    }
  } catch (error) {
    console.error('加载设备列表失败:', error);
  }
};

// 初始化
loadDevices();
</script>

<style scoped lang="less">
.search-panel {
  width: 320px;
  height: 100vh;
  overflow-y: auto;
  background: #fff;
  border-right: 1px solid #f0f0f0;

  :deep(.ant-card) {
    border: none;
    box-shadow: none;
  }

  :deep(.ant-card-head) {
    border-bottom: 1px solid #f0f0f0;
  }

  :deep(.ant-card-body) {
    padding: 16px;
  }
}

.device-selection {
  .device-list {
    max-height: 160px;
    overflow-y: auto;
    margin-top: 8px;
    padding-left: 8px;

    .ant-checkbox-wrapper {
      display: block;
      margin: 8px 0;
    }
  }
}

.similarity-control {
  display: flex;
  align-items: center;
  gap: 16px;

  .ant-slider {
    flex: 1;
  }

  .similarity-value {
    min-width: 48px;
    font-weight: 500;
    color: #1890ff;
  }
}
</style>
```

### 2. 主内容区域 - 搜索进度

**位置**: 主内容区域顶部

**功能说明**:
- 显示搜索进度百分比
- 显示已处理/总数
- 显示已找到的结果数
- 显示耗时

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/SearchProgress.vue -->
<template>
  <div v-if="visible" class="search-progress">
    <a-card :bordered="false">
      <div class="progress-header">
        <span class="progress-title">
          <LoadingOutlined spin />
          正在检索中...
        </span>
        <span class="progress-percent">{{ progressData.progress }}%</span>
      </div>

      <a-progress
        :percent="progressData.progress"
        :show-info="false"
        stroke-color="#1890ff"
      />

      <div class="progress-stats">
        <span>已处理: {{ progressData.processed }}/{{ progressData.total }}</span>
        <span>已找到: {{ progressData.found }}</span>
        <span>用时: {{ progressData.elapsed }}s</span>
      </div>

      <a-button
        v-if="cancellable"
        type="link"
        danger
        size="small"
        @click="handleCancel"
      >
        <template #icon><StopOutlined /></template>
        取消检索
      </a-button>
    </a-card>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { LoadingOutlined, StopOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  progressData: {
    type: Object,
    default: () => ({
      progress: 0,
      processed: 0,
      total: 0,
      found: 0,
      elapsed: 0,
    }),
  },
  cancellable: {
    type: Boolean,
    default: true,
  },
});

const emit = defineEmits(['cancel']);

const handleCancel = () => {
  emit('cancel');
};
</script>

<style scoped lang="less">
.search-progress {
  margin-bottom: 16px;

  :deep(.ant-card) {
    background: linear-gradient(135deg, #e6f7ff 0%, #f0f5ff 100%);
    border: 1px solid #91d5ff;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;

    .progress-title {
      font-size: 14px;
      font-weight: 500;
      color: #1890ff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-percent {
      font-size: 16px;
      font-weight: 600;
      color: #1890ff;
    }
  }

  .progress-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
    font-size: 12px;
    color: #1890ff;

    span {
      font-weight: 500;
    }
  }
}
</style>
```

### 3. 主内容区域 - 结果展示

**位置**: 主内容区域中部

**功能说明**:
- 支持网格视图和列表视图切换
- 显示搜索结果统计
- 显示结果卡片（缩略图、相似度、置信度、设备、时间）
- 支持查看详情、播放视频

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/ResultsGrid.vue -->
<template>
  <div class="results-section">
    <!-- 结果统计 -->
    <ResultsSummary
      v-if="results.length > 0"
      :total="results.length"
      :time-used="timeUsed"
      :accuracy="accuracy"
      @view-mode-change="handleViewModeChange"
    />

    <!-- 结果网格 -->
    <div v-if="viewMode === 'grid'" class="results-grid">
      <a-row :gutter="[16, 16]">
        <a-col
          v-for="result in displayResults"
          :key="result.id"
          :xs="24"
          :sm="12"
          :md="8"
          :lg="6"
          :xl="6"
        >
          <ResultCard
            :data="result"
            @view="handleViewDetail"
            @play="handlePlayVideo"
          />
        </a-col>
      </a-row>

      <!-- 分页 -->
      <div v-if="results.length > pageSize" class="pagination-wrapper">
        <a-pagination
          v-model:current="currentPage"
          v-model:page-size="pageSize"
          :total="results.length"
          :show-total="(total) => `共 ${total} 条结果`"
          :show-size-changer="true"
          :page-size-options="['12', '24', '48', '96']"
          show-quick-jumper
          @change="handlePageChange"
        />
      </div>
    </div>

    <!-- 结果列表 -->
    <div v-else-if="viewMode === 'list'" class="results-list">
      <a-list
        :data-source="displayResults"
        :pagination="{
          current: currentPage,
          pageSize: pageSize,
          total: results.length,
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total) => `共 ${total} 条结果`,
          onChange: handlePageChange,
        }"
      >
        <template #renderItem="{ item }">
          <a-list-item>
            <a-list-item-meta>
              <template #avatar>
                <a-image
                  :width="120"
                  :height="90"
                  :src="item.thumbnail"
                  :preview="false"
                  style="border-radius: 4px; object-fit: cover;"
                />
              </template>
              <template #title>
                <div class="list-item-title">
                  <span>{{ item.deviceName }}</span>
                  <a-tag color="blue">相似度: {{ item.similarity }}%</a-tag>
                </div>
              </template>
              <template #description>
                <div class="list-item-desc">
                  <div>
                    <ClockCircleOutlined />
                    <span>{{ item.timestamp }}</span>
                  </div>
                  <div>
                    <EnvironmentOutlined />
                    <span>{{ item.deviceName }}</span>
                  </div>
                  <div>
                    置信度: {{ item.confidence }}%
                  </div>
                </div>
              </template>
            </a-list-item-meta>
            <template #actions>
              <a-button size="small" @click="handleViewDetail(item.id)">
                <template #icon><EyeOutlined /></template>
                查看
              </a-button>
              <a-button size="small" @click="handlePlayVideo(item.id)">
                <template #icon><PlayCircleOutlined /></template>
                播放
              </a-button>
            </template>
          </a-list-item>
        </template>
      </a-list>
    </div>

    <!-- 空状态 -->
    <a-empty
      v-else-if="!isSearching && results.length === 0"
      description="未找到匹配结果"
    >
      <template #image>
        <SearchOutlined style="font-size: 64px; color: #d9d9d9;" />
      </template>
      <p style="color: #8c8c8c;">请尝试调整搜索条件或降低相似度阈值</p>
    </a-empty>

    <!-- 初始状态 -->
    <div v-else-if="!isSearching && results.length === 0" class="initial-state">
      <SearchOutlined style="font-size: 64px; color: #d9d9d9;" />
      <h3>开始智能检索</h3>
      <p>设置搜索条件后点击"开始检索"按钮</p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import {
  SearchOutlined,
  EyeOutlined,
  PlayCircleOutlined,
  ClockCircleOutlined,
  EnvironmentOutlined,
} from '@ant-design/icons-vue';
import ResultCard from './ResultCard.vue';
import ResultsSummary from './ResultsSummary.vue';

const props = defineProps({
  results: {
    type: Array,
    default: () => [],
  },
  isSearching: {
    type: Boolean,
    default: false,
  },
  timeUsed: {
    type: Number,
    default: 0,
  },
  accuracy: {
    type: Number,
    default: 0,
  },
});

const emit = defineEmits(['view-detail', 'play-video']);

const viewMode = ref('grid'); // grid | list
const currentPage = ref(1);
const pageSize = ref(24);

// 当前页显示的结果
const displayResults = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value;
  const end = start + pageSize.value;
  return props.results.slice(start, end);
});

// 视图模式变化
const handleViewModeChange = (mode) => {
  viewMode.value = mode;
  currentPage.value = 1;
};

// 分页变化
const handlePageChange = (page, size) => {
  currentPage.value = page;
  pageSize.value = size;
  // 滚动到顶部
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// 查看详情
const handleViewDetail = (resultId) => {
  emit('view-detail', resultId);
};

// 播放视频
const handlePlayVideo = (resultId) => {
  emit('play-video', resultId);
};
</script>

<style scoped lang="less">
.results-section {
  flex: 1;
  padding: 16px;
  background: #f0f2f5;
  min-height: calc(100vh - 64px);
}

.results-grid {
  margin-top: 16px;

  .pagination-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 24px;
    padding: 16px 0;
  }
}

.results-list {
  margin-top: 16px;

  :deep(.ant-list-item) {
    background: #fff;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;

    &:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }
  }

  .list-item-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .list-item-desc {
    display: flex;
    gap: 24px;
    font-size: 13px;
    color: #8c8c8c;

    div {
      display: flex;
      align-items: center;
      gap: 4px;
    }
  }
}

.initial-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;

  h3 {
    margin-top: 16px;
    font-size: 18px;
    color: #262626;
  }

  p {
    color: #8c8c8c;
    margin-top: 8px;
  }
}
</style>
```

### 4. 结果卡片组件

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/ResultCard.vue -->
<template>
  <div class="result-card" @click="handleClick">
    <div class="card-image">
      <a-image
        :src="data.thumbnail"
        :preview="false"
        :fallback="fallbackImage"
        style="width: 100%; height: 100%; object-fit: cover;"
      />

      <!-- 相似度标签 -->
      <div class="similarity-badge">
        相似度: {{ data.similarity }}%
      </div>

      <!-- 置信度标签 -->
      <div class="confidence-badge">
        置信度: {{ data.confidence }}%
      </div>

      <!-- 遮罩层 -->
      <div class="card-overlay">
        <a-space>
          <a-button type="primary" size="small" @click.stop="handleView">
            <template #icon><EyeOutlined /></template>
            查看
          </a-button>
          <a-button size="small" @click.stop="handlePlay">
            <template #icon><PlayCircleOutlined /></template>
            播放
          </a-button>
        </a-space>
      </div>
    </div>

    <div class="card-content">
      <div class="card-info">
        <span class="device-name">{{ data.deviceName }}</span>
        <span class="timestamp">{{ data.timestamp }}</span>
      </div>
    </div>
  </div>
</template>

<script setup>
import { EyeOutlined, PlayCircleOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  data: {
    type: Object,
    required: true,
  },
});

const emit = defineEmits(['view', 'play']);

const fallbackImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE4IiBmaWxsPSIjYmZiZmJmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5Yqg6L295aSx6LSlPC90ZXh0Pjwvc3ZnPg==';

const handleClick = () => {
  // 点击卡片整体
};

const handleView = () => {
  emit('view', props.data.id);
};

const handlePlay = () => {
  emit('play', props.data.id);
};
</script>

<style scoped lang="less">
.result-card {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  cursor: pointer;

  &:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);

    .card-overlay {
      opacity: 1;
    }
  }

  .card-image {
    position: relative;
    width: 100%;
    padding-top: 75%; // 4:3 比例
    background: #f5f5f5;
    overflow: hidden;

    :deep(.ant-image) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .similarity-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 12px;
      border-radius: 4px;
      backdrop-filter: blur(4px);
    }

    .confidence-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      padding: 4px 8px;
      background: rgba(24, 144, 255, 0.9);
      color: #fff;
      font-size: 12px;
      border-radius: 4px;
      backdrop-filter: blur(4px);
    }

    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(2px);
    }
  }

  .card-content {
    padding: 12px;
  }

  .card-info {
    display: flex;
    justify-content: space-between;
    align-items: center;

    .device-name {
      font-size: 14px;
      font-weight: 500;
      color: #262626;
    }

    .timestamp {
      font-size: 12px;
      color: #8c8c8c;
    }
  }
}
</style>
```

### 5. 右侧面板 - 样本上传

**位置**: 页面右侧，固定宽度320px

**功能说明**:
- 目标样本图片上传
- 支持拖拽上传
- 图片预览
- 以图搜图

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/SamplePanel.vue -->
<template>
  <div class="sample-panel">
    <!-- 目标样本 -->
    <a-card :bordered="false" title="目标样本">
      <div class="sample-upload">
        <a-upload
          v-if="!sampleImage"
          :before-upload="handleBeforeUpload"
          :custom-request="handleUpload"
          :show-upload-list="false"
          accept="image/jpeg,image/png,image/jpg"
          class="upload-dragger"
        >
          <div class="upload-placeholder">
            <PictureOutlined style="font-size: 48px; color: #d9d9d9;" />
            <p class="upload-text">点击或拖拽上传目标图片</p>
            <p class="upload-hint">支持 JPG、PNG 格式，大小不超过 10MB</p>
          </div>
        </a-upload>

        <div v-else class="sample-preview">
          <a-image
            :src="sampleImage.url"
            :preview="true"
            style="width: 100%; height: 200px; object-fit: contain;"
          />
          <div class="sample-actions">
            <a-button type="primary" block @click="handleSearchByImage">
              <template #icon><SearchOutlined /></template>
              以图搜图
            </a-button>
            <a-button block @click="handleRemoveSample">
              <template #icon><DeleteOutlined /></template>
              移除样本
            </a-button>
          </div>
        </div>
      </div>
    </a-card>

    <!-- 搜索历史 -->
    <SearchHistory @load-history="handleLoadHistory" />

    <!-- 快速操作 -->
    <QuickActions
      :disabled="!hasSelectedResult"
      @add-blacklist="handleAddBlacklist"
      @create-alert="handleCreateAlert"
      @export-clip="handleExportClip"
      @analyze-trajectory="handleAnalyzeTrajectory"
    />
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { message } from 'ant-design-vue';
import {
  PictureOutlined,
  SearchOutlined,
  DeleteOutlined,
} from '@ant-design/icons-vue';
import Compressor from 'compressorjs';
import { useTargetSearchStore } from '/@/store/modules/target-search';
import { targetSearchApi } from '/@/api/business/smart-video/target-search-api';
import SearchHistory from './SearchHistory.vue';
import QuickActions from './QuickActions.vue';

const emit = defineEmits(['search-by-image', 'load-history']);

const searchStore = useTargetSearchStore();
const sampleImage = computed(() => searchStore.sampleImage);
const hasSelectedResult = ref(false);

// 上传前校验
const handleBeforeUpload = (file) => {
  const isImage = file.type === 'image/jpeg' || file.type === 'image/png' || file.type === 'image/jpg';
  if (!isImage) {
    message.error('只支持上传 JPG/PNG 格式的图片！');
    return false;
  }

  const isLt10M = file.size / 1024 / 1024 < 10;
  if (!isLt10M) {
    message.error('图片大小不能超过 10MB！');
    return false;
  }

  return true;
};

// 处理上传
const handleUpload = async ({ file, onSuccess, onError }) => {
  try {
    // 压缩图片
    const compressedFile = await compressImage(file);

    // 上传到服务器
    const response = await targetSearchApi.uploadSample(compressedFile);

    if (response.code === 0) {
      // 保存到store
      searchStore.setSampleImage({
        url: response.data.url,
        file: compressedFile,
      });

      message.success('上传成功');
      onSuccess(response.data);
    } else {
      message.error(response.message || '上传失败');
      onError(new Error(response.message));
    }
  } catch (error) {
    console.error('上传失败:', error);
    message.error('上传失败，请重试');
    onError(error);
  }
};

// 压缩图片
const compressImage = (file) => {
  return new Promise((resolve, reject) => {
    new Compressor(file, {
      quality: 0.8,
      maxWidth: 1920,
      maxHeight: 1080,
      success(result) {
        resolve(result);
      },
      error(err) {
        reject(err);
      },
    });
  });
};

// 以图搜图
const handleSearchByImage = () => {
  emit('search-by-image');
};

// 移除样本
const handleRemoveSample = () => {
  searchStore.setSampleImage(null);
  message.info('样本已移除');
};

// 加载历史搜索
const handleLoadHistory = (history) => {
  emit('load-history', history);
};

// 快速操作
const handleAddBlacklist = () => {
  message.info('加入黑名单功能开发中');
};

const handleCreateAlert = () => {
  message.info('创建告警功能开发中');
};

const handleExportClip = () => {
  message.info('导出片段功能开发中');
};

const handleAnalyzeTrajectory = () => {
  message.info('轨迹分析功能开发中');
};
</script>

<style scoped lang="less">
.sample-panel {
  width: 320px;
  height: 100vh;
  overflow-y: auto;
  background: #fff;
  border-left: 1px solid #f0f0f0;

  :deep(.ant-card) {
    border: none;
    box-shadow: none;
    border-bottom: 1px solid #f0f0f0;
  }

  :deep(.ant-card-head) {
    border-bottom: 1px solid #f0f0f0;
  }

  :deep(.ant-card-body) {
    padding: 16px;
  }
}

.sample-upload {
  .upload-dragger {
    width: 100%;

    :deep(.ant-upload) {
      width: 100%;
    }
  }

  .upload-placeholder {
    padding: 32px 16px;
    text-align: center;
    background: #fafafa;
    border: 2px dashed #d9d9d9;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
      border-color: #1890ff;
      background: #f0f5ff;
    }

    .upload-text {
      margin: 12px 0 4px;
      font-size: 14px;
      color: #262626;
    }

    .upload-hint {
      margin: 0;
      font-size: 12px;
      color: #8c8c8c;
    }
  }

  .sample-preview {
    .sample-actions {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  }
}
</style>
```

### 6. 搜索历史组件

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/SearchHistory.vue -->
<template>
  <a-card :bordered="false" title="搜索历史">
    <div class="history-list">
      <div
        v-for="(item, index) in historyList"
        :key="index"
        class="history-item"
        @click="handleLoadHistory(item)"
      >
        <div class="history-content">
          <div class="history-header">
            <span class="history-type">
              <component :is="getTypeIcon(item.targetType)" />
              {{ getTypeName(item.targetType) }}
            </span>
            <a-button
              type="text"
              size="small"
              danger
              @click.stop="handleDeleteHistory(index)"
            >
              <template #icon><DeleteOutlined /></template>
            </a-button>
          </div>
          <div class="history-time">
            {{ formatTime(item.timestamp) }}
          </div>
          <div class="history-result">
            <a-tag color="blue">{{ item.resultCount || 0 }}个结果</a-tag>
          </div>
        </div>
      </div>

      <a-empty
        v-if="historyList.length === 0"
        description="暂无搜索历史"
        :image="Empty.PRESENTED_IMAGE_SIMPLE"
      />
    </div>
  </a-card>
</template>

<script setup>
import { computed } from 'vue';
import { message, Empty } from 'ant-design-vue';
import {
  UserOutlined,
  CarOutlined,
  InboxOutlined,
  AppstoreOutlined,
  DeleteOutlined,
} from '@ant-design/icons-vue';
import { useTargetSearchStore } from '/@/store/modules/target-search';
import dayjs from 'dayjs';

const emit = defineEmits(['load-history']);

const searchStore = useTargetSearchStore();
const historyList = computed(() => searchStore.searchHistory);

// 获取类型图标
const getTypeIcon = (type) => {
  const iconMap = {
    person: UserOutlined,
    vehicle: CarOutlined,
    object: InboxOutlined,
    all: AppstoreOutlined,
  };
  return iconMap[type] || AppstoreOutlined;
};

// 获取类型名称
const getTypeName = (type) => {
  const nameMap = {
    person: '人员检索',
    vehicle: '车辆检索',
    object: '物体检索',
    all: '全部检索',
  };
  return nameMap[type] || '检索';
};

// 格式化时间
const formatTime = (time) => {
  return dayjs(time).format('YYYY-MM-DD HH:mm');
};

// 加载历史记录
const handleLoadHistory = (item) => {
  emit('load-history', item);
  message.success('已加载历史搜索条件');
};

// 删除历史记录
const handleDeleteHistory = (index) => {
  searchStore.removeSearchHistory(index);
  message.info('已删除');
};
</script>

<style scoped lang="less">
.history-list {
  max-height: 300px;
  overflow-y: auto;

  .history-item {
    padding: 12px;
    margin-bottom: 8px;
    background: #fafafa;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
      background: #f0f0f0;
    }

    &:last-child {
      margin-bottom: 0;
    }

    .history-content {
      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;

        .history-type {
          font-size: 14px;
          font-weight: 500;
          color: #262626;
          display: flex;
          align-items: center;
          gap: 6px;
        }
      }

      .history-time {
        font-size: 12px;
        color: #8c8c8c;
        margin-bottom: 8px;
      }

      .history-result {
        display: flex;
        align-items: center;
      }
    }
  }
}
</style>
```

### 7. 快速操作组件

**技术实现**:
```vue
<!-- src/views/business/smart-video/target-search/components/QuickActions.vue -->
<template>
  <a-card :bordered="false" title="快速操作">
    <a-space direction="vertical" style="width: 100%">
      <a-button
        type="primary"
        danger
        block
        :disabled="disabled"
        @click="handleAddBlacklist"
      >
        <template #icon><StopOutlined /></template>
        加入黑名单
      </a-button>

      <a-button
        block
        :disabled="disabled"
        style="background: #faad14; border-color: #faad14; color: #fff;"
        @click="handleCreateAlert"
      >
        <template #icon><BellOutlined /></template>
        创建告警
      </a-button>

      <a-button
        block
        :disabled="disabled"
        style="background: #52c41a; border-color: #52c41a; color: #fff;"
        @click="handleExportClip"
      >
        <template #icon><VideoCameraOutlined /></template>
        导出片段
      </a-button>

      <a-button
        block
        :disabled="disabled"
        style="background: #722ed1; border-color: #722ed1; color: #fff;"
        @click="handleAnalyzeTrajectory"
      >
        <template #icon><ApartmentOutlined /></template>
        轨迹分析
      </a-button>
    </a-space>
  </a-card>
</template>

<script setup>
import {
  StopOutlined,
  BellOutlined,
  VideoCameraOutlined,
  ApartmentOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  disabled: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(['add-blacklist', 'create-alert', 'export-clip', 'analyze-trajectory']);

const handleAddBlacklist = () => {
  emit('add-blacklist');
};

const handleCreateAlert = () => {
  emit('create-alert');
};

const handleExportClip = () => {
  emit('export-clip');
};

const handleAnalyzeTrajectory = () => {
  emit('analyze-trajectory');
};
</script>
```

### 8. 完整页面组装

```vue
<!-- src/views/business/smart-video/target-search/index.vue -->
<template>
  <div class="target-search-page">
    <!-- 头部工具栏 -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">目标检索</h1>
        <div class="search-status">
          <SearchOutlined />
          <span>{{ searchStatusText }}</span>
        </div>
      </div>

      <div class="header-right">
        <a-space>
          <a-button @click="handleBatchSearch">
            <template #icon><AppstoreOutlined /></template>
            批量检索
          </a-button>
          <a-button
            type="primary"
            :disabled="searchResults.length === 0"
            @click="handleExportResults"
          >
            <template #icon><DownloadOutlined /></template>
            导出结果
          </a-button>
        </a-space>
      </div>
    </div>

    <!-- 主体内容 -->
    <div class="page-content">
      <!-- 左侧搜索面板 -->
      <SearchPanel @start-search="handleStartSearch" />

      <!-- 主内容区域 -->
      <div class="main-content">
        <!-- 搜索进度 -->
        <SearchProgress
          :visible="isSearching"
          :progress-data="progressData"
          @cancel="handleCancelSearch"
        />

        <!-- 搜索结果 -->
        <ResultsGrid
          :results="searchResults"
          :is-searching="isSearching"
          :time-used="timeUsed"
          :accuracy="95.2"
          @view-detail="handleViewDetail"
          @play-video="handlePlayVideo"
        />
      </div>

      <!-- 右侧面板 -->
      <SamplePanel
        @search-by-image="handleSearchByImage"
        @load-history="handleLoadHistory"
      />
    </div>

    <!-- 轨迹分析弹窗 -->
    <TrajectoryDialog
      v-model:visible="trajectoryVisible"
      :trajectory-data="trajectoryData"
    />

    <!-- 批量检索弹窗 -->
    <BatchSearchDialog
      v-model:visible="batchSearchVisible"
      @confirm="handleBatchSearchConfirm"
    />

    <!-- 结果详情抽屉 -->
    <ResultDetailDrawer
      v-model:visible="detailVisible"
      :result-id="currentResultId"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  SearchOutlined,
  AppstoreOutlined,
  DownloadOutlined,
} from '@ant-design/icons-vue';
import { useTargetSearchStore } from '/@/store/modules/target-search';
import { targetSearchApi } from '/@/api/business/smart-video/target-search-api';
import SearchPanel from './components/SearchPanel.vue';
import SearchProgress from './components/SearchProgress.vue';
import ResultsGrid from './components/ResultsGrid.vue';
import SamplePanel from './components/SamplePanel.vue';
import TrajectoryDialog from './components/TrajectoryDialog.vue';
import BatchSearchDialog from './components/BatchSearchDialog.vue';
import ResultDetailDrawer from './components/ResultDetailDrawer.vue';

const searchStore = useTargetSearchStore();

// 搜索状态
const isSearching = ref(false);
const searchStatusText = ref('准备检索');
const currentTaskId = ref('');

// 搜索进度
const progressData = ref({
  progress: 0,
  processed: 0,
  total: 0,
  found: 0,
  elapsed: 0,
});

// 搜索结果
const searchResults = ref([]);
const timeUsed = ref(0);

// 弹窗状态
const trajectoryVisible = ref(false);
const batchSearchVisible = ref(false);
const detailVisible = ref(false);

// 轨迹数据
const trajectoryData = ref([]);

// 当前查看的结果ID
const currentResultId = ref('');

// 定时器
let progressTimer = null;
let startTime = null;

// 开始检索
const handleStartSearch = async (taskData) => {
  try {
    isSearching.value = true;
    searchStatusText.value = '正在检索...';
    currentTaskId.value = taskData.taskId;
    startTime = Date.now();

    // 开始轮询进度
    startPollingProgress(taskData.taskId);
  } catch (error) {
    console.error('开始检索失败:', error);
    message.error('检索失败，请重试');
    isSearching.value = false;
  }
};

// 开始轮询搜索进度
const startPollingProgress = (taskId) => {
  let pollCount = 0;
  const MAX_POLL_COUNT = 600;

  progressTimer = setInterval(async () => {
    try {
      const response = await targetSearchApi.getSearchProgress(taskId);

      if (response.code === 0) {
        const { progress, processed, total, found, status, error } = response.data;

        // 更新进度数据
        progressData.value = {
          progress,
          processed,
          total,
          found,
          elapsed: Math.floor((Date.now() - startTime) / 1000),
        };

        // 搜索完成
        if (status === 'completed') {
          stopPollingProgress();
          await loadSearchResults(taskId);
          searchStatusText.value = `检索完成 - 找到 ${found} 个结果`;
          message.success(`检索完成！找到 ${found} 个匹配结果`);
        }

        // 搜索失败
        if (status === 'failed') {
          stopPollingProgress();
          searchStatusText.value = '检索失败';
          message.error(error || '搜索失败');
        }
      }

      pollCount++;

      // 超时保护
      if (pollCount >= MAX_POLL_COUNT) {
        stopPollingProgress();
        searchStatusText.value = '检索超时';
        message.warning('搜索超时，请重试');
      }
    } catch (error) {
      console.error('获取搜索进度失败:', error);
    }
  }, 1000);
};

// 停止轮询进度
const stopPollingProgress = () => {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
  isSearching.value = false;
};

// 加载搜索结果
const loadSearchResults = async (taskId) => {
  try {
    const response = await targetSearchApi.getSearchResults(taskId);

    if (response.code === 0) {
      searchResults.value = response.data.results || [];
      timeUsed.value = response.data.timeUsed || 0;

      // 保存结果到store
      searchStore.setSearchResults(searchResults.value);
    }
  } catch (error) {
    console.error('加载搜索结果失败:', error);
    message.error('加载结果失败');
  }
};

// 取消检索
const handleCancelSearch = async () => {
  try {
    await targetSearchApi.cancelSearch(currentTaskId.value);
    stopPollingProgress();
    searchStatusText.value = '已取消';
    message.info('已取消检索');
  } catch (error) {
    console.error('取消检索失败:', error);
    message.error('取消失败');
  }
};

// 以图搜图
const handleSearchByImage = async () => {
  if (!searchStore.sampleImage) {
    message.warning('请先上传样本图片');
    return;
  }

  try {
    const params = {
      sampleImage: searchStore.sampleImage,
      targetType: searchStore.searchCondition.targetType,
      similarity: searchStore.searchCondition.similarity,
    };

    const response = await targetSearchApi.searchByImage(params);

    if (response.code === 0) {
      handleStartSearch(response.data);
    } else {
      message.error(response.message || '搜索失败');
    }
  } catch (error) {
    console.error('以图搜图失败:', error);
    message.error('搜索失败，请重试');
  }
};

// 加载历史搜索
const handleLoadHistory = (history) => {
  searchStore.updateSearchCondition(history.condition);
};

// 批量检索
const handleBatchSearch = () => {
  batchSearchVisible.value = true;
};

// 批量检索确认
const handleBatchSearchConfirm = async (data) => {
  try {
    const response = await targetSearchApi.batchSearch(data);

    if (response.code === 0) {
      message.success('批量检索任务已创建');
      batchSearchVisible.value = false;
    } else {
      message.error(response.message || '创建失败');
    }
  } catch (error) {
    console.error('批量检索失败:', error);
    message.error('创建失败，请重试');
  }
};

// 导出结果
const handleExportResults = async () => {
  try {
    const response = await targetSearchApi.exportResults({
      taskId: currentTaskId.value,
      results: searchResults.value,
    });

    if (response.code === 0) {
      // 下载文件
      const link = document.createElement('a');
      link.href = response.data.url;
      link.download = response.data.filename;
      link.click();

      message.success('导出成功');
    } else {
      message.error(response.message || '导出失败');
    }
  } catch (error) {
    console.error('导出结果失败:', error);
    message.error('导出失败，请重试');
  }
};

// 查看详情
const handleViewDetail = (resultId) => {
  currentResultId.value = resultId;
  detailVisible.value = true;
};

// 播放视频
const handlePlayVideo = (resultId) => {
  const result = searchResults.value.find(r => r.id === resultId);
  if (result) {
    // 打开视频播放器
    console.log('播放视频:', result);
    message.info('视频播放功能开发中');
  }
};

// 组件销毁
onUnmounted(() => {
  stopPollingProgress();
});
</script>

<style scoped lang="less">
.target-search-page {
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: #f0f2f5;

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;

      .page-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #262626;
      }

      .search-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #8c8c8c;
      }
    }

    .header-right {
      // 样式已包含在a-space中
    }
  }

  .page-content {
    display: flex;
    flex: 1;
    overflow: hidden;

    .main-content {
      flex: 1;
      overflow-y: auto;
    }
  }
}
</style>
```

## 路由配置

```javascript
// src/router/modules/business.js
export default [
  {
    path: '/business/smart-video',
    name: 'SmartVideo',
    component: () => import('/@/layout/index.vue'),
    meta: {
      title: '智能视频',
      icon: 'VideoCameraOutlined',
    },
    children: [
      {
        path: 'target-search',
        name: 'TargetSearch',
        component: () => import('/@/views/business/smart-video/target-search/index.vue'),
        meta: {
          title: '目标检索',
          icon: 'SearchOutlined',
        },
      },
      // 其他子路由...
    ],
  },
];
```

## 菜单配置

```javascript
// src/constants/menu-const.js
export const MENU_CONFIG = [
  {
    menuKey: 'smart-video',
    menuName: '智能视频',
    icon: 'VideoCameraOutlined',
    children: [
      {
        menuKey: 'target-search',
        menuName: '目标检索',
        path: '/business/smart-video/target-search',
        icon: 'SearchOutlined',
      },
      // 其他菜单项...
    ],
  },
];
```

## Mock数据示例

```javascript
// src/mock/business/smart-video/target-search-mock.js
import { defineMock } from '/@/mock/base';

export default defineMock([
  {
    url: '/target-search/start',
    method: 'post',
    response: ({ body }) => {
      return {
        code: 0,
        message: 'success',
        data: {
          taskId: `task_${Date.now()}`,
          status: 'processing',
        },
      };
    },
  },
  {
    url: '/target-search/progress/:taskId',
    method: 'get',
    response: () => {
      // 模拟进度
      const progress = Math.floor(Math.random() * 100);
      const total = 156;
      const processed = Math.floor((progress / 100) * total);
      const found = Math.floor(Math.random() * 25);

      return {
        code: 0,
        message: 'success',
        data: {
          progress,
          processed,
          total,
          found,
          status: progress >= 100 ? 'completed' : 'processing',
        },
      };
    },
  },
  {
    url: '/target-search/results/:taskId',
    method: 'get',
    response: () => {
      const results = [];
      const devices = ['主入口', '停车场', '大厅', '走廊', '电梯间'];
      const count = Math.floor(Math.random() * 20) + 5;

      for (let i = 0; i < count; i++) {
        results.push({
          id: `result_${i + 1}`,
          deviceId: Math.floor(Math.random() * 5) + 1,
          deviceName: devices[Math.floor(Math.random() * devices.length)],
          timestamp: `2024-01-30 ${String(Math.floor(Math.random() * 24)).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}`,
          similarity: Math.floor(Math.random() * 15) + 80,
          confidence: Math.floor(Math.random() * 20) + 75,
          thumbnail: `https://picsum.photos/seed/${i + 1}/400/300`,
        });
      }

      return {
        code: 0,
        message: 'success',
        data: {
          results,
          timeUsed: Math.floor(Math.random() * 30) + 5,
        },
      };
    },
  },
  {
    url: '/target-search/upload-sample',
    method: 'post',
    response: () => {
      return {
        code: 0,
        message: 'success',
        data: {
          url: `https://picsum.photos/seed/${Date.now()}/400/300`,
          filename: `sample_${Date.now()}.jpg`,
        },
      };
    },
  },
  {
    url: '/target-search/devices',
    method: 'get',
    response: () => {
      return {
        code: 0,
        message: 'success',
        data: [
          { id: 1, name: '主入口', type: 'camera', status: 'online' },
          { id: 2, name: '停车场', type: 'camera', status: 'online' },
          { id: 3, name: '大厅', type: 'camera', status: 'online' },
          { id: 4, name: '走廊', type: 'camera', status: 'online' },
          { id: 5, name: '电梯间', type: 'camera', status: 'online' },
          { id: 6, name: '后门', type: 'camera', status: 'offline' },
        ],
      };
    },
  },
  {
    url: '/target-search/history',
    method: 'get',
    response: () => {
      return {
        code: 0,
        message: 'success',
        data: {
          list: [
            {
              id: 1,
              targetType: 'person',
              timestamp: '2024-01-30 14:25:00',
              resultCount: 23,
              condition: {
                targetType: 'person',
                timeRange: {
                  start: '2024-01-30 08:00:00',
                  end: '2024-01-30 18:00:00',
                },
                similarity: 80,
              },
            },
            {
              id: 2,
              targetType: 'vehicle',
              timestamp: '2024-01-30 13:15:00',
              resultCount: 8,
              condition: {
                targetType: 'vehicle',
                timeRange: {
                  start: '2024-01-30 06:00:00',
                  end: '2024-01-30 12:00:00',
                },
                similarity: 85,
              },
            },
          ],
        },
      };
    },
  },
  {
    url: '/target-search/cancel/:taskId',
    method: 'post',
    response: () => {
      return {
        code: 0,
        message: 'success',
        data: {
          cancelled: true,
        },
      };
    },
  },
  {
    url: '/target-search/export',
    method: 'post',
    response: () => {
      return {
        code: 0,
        message: 'success',
        data: {
          url: '/downloads/target-search-results.xlsx',
          filename: `target-search-results-${Date.now()}.xlsx`,
        },
      };
    },
  },
]);
```

## 最佳实践建议

### 1. 性能优化
- **图片懒加载**: 使用 IntersectionObserver 实现结果图片的懒加载
- **虚拟滚动**: 搜索结果数量超过50时使用分页或虚拟滚动
- **图片压缩**: 上传前压缩图片，减少传输时间
- **防抖处理**: 搜索条件变化时使用防抖，避免频繁请求

### 2. 用户体验
- **实时反馈**: 搜索过程中显示进度条和实时统计
- **错误提示**: 搜索失败时提供明确的错误信息和建议
- **历史记录**: 保存搜索历史，方便用户重用搜索条件
- **快捷操作**: 提供常用的快捷操作按钮

### 3. 数据管理
- **状态管理**: 使用 Pinia 集中管理搜索状态和结果
- **缓存策略**: 对搜索结果进行缓存，避免重复请求
- **数据持久化**: 将搜索历史保存到本地存储

### 4. 安全性
- **文件校验**: 上传前严格校验文件类型和大小
- **参数校验**: 搜索参数进行前端校验
- **XSS防护**: 对用户输入进行转义处理

### 5. 可维护性
- **组件化**: 将复杂页面拆分为独立的组件
- **Hook复用**: 将通用逻辑封装为可复用的 Hook
- **类型定义**: 使用 TypeScript 定义数据类型
- **文档注释**: 为关键函数添加注释说明

## 常见问题与解决方案

### 问题1：图片上传失败
**原因**:
- 文件过大
- 格式不支持
- 网络问题

**解决方案**:
```javascript
// 1. 严格的文件校验
const validateFile = (file) => {
  // 检查类型
  const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
  if (!validTypes.includes(file.type)) {
    throw new Error('不支持的文件格式');
  }

  // 检查大小
  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    throw new Error('文件大小超过限制');
  }

  return true;
};

// 2. 图片压缩
const compressImage = async (file) => {
  return new Promise((resolve, reject) => {
    new Compressor(file, {
      quality: 0.8,
      maxWidth: 1920,
      maxHeight: 1080,
      success: resolve,
      error: reject,
    });
  });
};

// 3. 错误重试
const uploadWithRetry = async (file, maxRetries = 3) => {
  let lastError;

  for (let i = 0; i < maxRetries; i++) {
    try {
      return await targetSearchApi.uploadSample(file);
    } catch (error) {
      lastError = error;
      if (i < maxRetries - 1) {
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
      }
    }
  }

  throw lastError;
};
```

### 问题2：搜索结果过多导致页面卡顿
**原因**:
- 一次性渲染大量DOM元素
- 图片加载过多

**解决方案**:
```vue
<template>
  <!-- 使用分页 -->
  <a-list
    :data-source="results"
    :pagination="{
      pageSize: 24,
      showSizeChanger: true,
      showQuickJumper: true,
    }"
  >
    <template #renderItem="{ item }">
      <!-- 使用图片懒加载 -->
      <a-image
        :src="item.thumbnail"
        loading="lazy"
        :preview="false"
      />
    </template>
  </a-list>
</template>
```

### 问题3：搜索进度不准确
**原因**:
- 后端进度计算不准确
- 网络延迟导致进度更新不及时

**解决方案**:
```javascript
// 1. 前端模拟进度（仅在后端不支持时使用）
const simulateProgress = (duration = 10000) => {
  const startTime = Date.now();
  const interval = 100;

  return setInterval(() => {
    const elapsed = Date.now() - startTime;
    const progress = Math.min((elapsed / duration) * 100, 99);

    progressData.value.progress = Math.floor(progress);
  }, interval);
};

// 2. 结合真实进度和模拟进度
const updateProgress = (realProgress) => {
  // 确保进度只增不减
  progressData.value.progress = Math.max(
    progressData.value.progress,
    realProgress
  );
};
```

### 问题4：搜索历史过多导致存储溢出
**原因**:
- 未限制历史记录数量
- 存储了过多不必要的数据

**解决方案**:
```javascript
// Pinia Store
export const useTargetSearchStore = defineStore('targetSearch', {
  state: () => ({
    searchHistory: [],
  }),

  actions: {
    addSearchHistory(record) {
      // 1. 只保存必要的字段
      const historyRecord = {
        id: record.id,
        targetType: record.targetType,
        timestamp: record.timestamp,
        resultCount: record.resultCount,
        condition: {
          // 只保存核心条件
          targetType: record.condition.targetType,
          timeRange: record.condition.timeRange,
          similarity: record.condition.similarity,
        },
      };

      this.searchHistory.unshift(historyRecord);

      // 2. 限制数量为20条
      if (this.searchHistory.length > 20) {
        this.searchHistory = this.searchHistory.slice(0, 20);
      }

      // 3. 持久化到本地存储
      localStorage.setItem(
        'target-search-history',
        JSON.stringify(this.searchHistory)
      );
    },
  },
});
```

## 总结

目标搜索页面是智能视频监控系统的核心功能，通过AI算法实现快速准确的目标检索和轨迹追踪。在开发过程中需要特别注意：

1. **图片处理** - 上传前进行压缩和校验，优化传输效率
2. **搜索进度** - 合理的轮询策略，实时反馈搜索状态
3. **结果展示** - 支持多种视图模式，处理大量结果时使用分页
4. **用户体验** - 提供搜索历史、快捷操作等便利功能
5. **性能优化** - 图片懒加载、虚拟滚动、防抖节流等优化手段

遵循本文档的规范和最佳实践，可以快速开发出高质量、高性能的目标搜索页面。
