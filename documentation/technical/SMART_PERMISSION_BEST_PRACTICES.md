# SmartPermission æƒé™ç®¡ç†æœ€ä½³å®è·µæŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2025-11-14
> **é€‚ç”¨èŒƒå›´**: SmartAdmin v3 é¡¹ç›®æƒé™ç®¡ç†

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [5çº§å®‰å…¨æƒé™ä½“ç³»](#5çº§å®‰å…¨æƒé™ä½“ç³»)
4. [ä¸šåŠ¡æƒé™é…ç½®](#ä¸šåŠ¡æƒé™é…ç½®)
5. [æƒé™éªŒè¯æœºåˆ¶](#æƒé™éªŒè¯æœºåˆ¶)
6. [ç¼“å­˜ä¼˜åŒ–ç­–ç•¥](#ç¼“å­˜ä¼˜åŒ–ç­–ç•¥)
7. [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)
8. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
9. [å¸¸è§é—®é¢˜è§£å†³](#å¸¸è§é—®é¢˜è§£å†³)
10. [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)

---

## ğŸ“– æ¦‚è¿°

SmartPermission æ˜¯ SmartAdmin v3 çš„æ ¸å¿ƒæƒé™ç®¡ç†æ¨¡å—ï¼Œæä¾›ä¼ä¸šçº§çš„5çº§å®‰å…¨æƒé™ç®¡ç†èƒ½åŠ›ã€‚æœ¬æ–‡æ¡£ä»‹ç»æƒé™ç®¡ç†çš„æœ€ä½³å®è·µã€è®¾è®¡åŸåˆ™å’Œå®æ–½æŒ‡å—ã€‚

### æ ¸å¿ƒä»·å€¼

- **ç»Ÿä¸€æƒé™ç®¡ç†**: ä¸ºæ‰€æœ‰ä¸šåŠ¡æ¨¡å—æä¾›ä¸€è‡´çš„æƒé™æ§åˆ¶
- **ç»†ç²’åº¦æ§åˆ¶**: æ”¯æŒåŒºåŸŸã€è®¾å¤‡ã€æ—¶é—´ã€IPç­‰å¤šç»´åº¦æƒé™é™åˆ¶
- **å®‰å…¨åˆè§„**: æ»¡è¶³ä¼ä¸šçº§å®‰å…¨å®¡è®¡å’Œåˆè§„è¦æ±‚
- **é«˜æ€§èƒ½**: åŸºäºç¼“å­˜æœºåˆ¶å®ç°æ¯«ç§’çº§æƒé™éªŒè¯

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SmartPermission æƒé™ç®¡ç†æ¶æ„                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Frontend (Vue 3 + Ant Design Vue)                              â”‚
â”‚  â”œâ”€â”€ æƒé™ç®¡ç†ç•Œé¢                                                       â”‚
â”‚  â”œâ”€â”€ å®‰å…¨çº§åˆ«ç®¡ç†                                                       â”‚
â”‚  â”œâ”€â”€ ä¸šåŠ¡æƒé™é…ç½®                                                       â”‚
â”‚  â””â”€â”€ æƒé™å®¡è®¡æ—¥å¿—                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Backend (Spring Boot 3)                                            â”‚
â”‚  â”œâ”€â”€ Controller Layer (RESTful API)                                  â”‚
â”‚  â”‚   â””â”€â”€ SmartPermissionController                                    â”‚
â”‚  â”œâ”€â”€ Service Layer (ä¸šåŠ¡é€»è¾‘)                                         â”‚
â”‚  â”‚   â””â”€â”€ SecurityLevelPermissionService (851è¡Œ)                    â”‚
â”‚  â”œâ”€â”€ Manager Layer (ç¼“å­˜å’ŒéªŒè¯)                                       â”‚
â”‚  â”‚   â”œâ”€â”€ æƒé™ç¼“å­˜ç®¡ç†                                                    â”‚
â”‚  â”‚   â””â”€â”€ æƒé™éªŒè¯å™¨                                                      â”‚
â”‚  â””â”€â”€ DAO Layer (æ•°æ®è®¿é—®)                                               â”‚
â”‚      â””â”€â”€ MyBatis-Plus Mapper                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Infrastructure (åŸºç¡€è®¾æ–½)                                           â”‚
â”‚  â”œâ”€â”€ MySQL Database                                                    â”‚
â”‚  â”œâ”€â”€ Redis Cache                                                        â”‚
â”‚  â””â”€â”€ Sa-Token Authentication                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªå±‚çº§ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½
2. **å¼€é—­åŸåˆ™**: æ”¯æŒæ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
3. **ä¾èµ–å€’ç½®**: é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
4. **æ¥å£éš”ç¦»**: æƒé™æ¥å£ç»†ç²’åº¦è®¾è®¡

---

## ğŸ” 5çº§å®‰å…¨æƒé™ä½“ç³»

### æƒé™çº§åˆ«å®šä¹‰

| çº§åˆ« | åç§° | æƒé™èŒƒå›´ | é€‚ç”¨åœºæ™¯ | è®¿é—®é™åˆ¶ |
|------|------|----------|----------|----------|
| 1çº§ | **å…¬å¼€çº§** | åŸºç¡€å…¬å¼€ä¿¡æ¯ | å…¬å¼€æŸ¥è¯¢ã€åŸºç¡€å¯¼èˆª | æœ€å°é™åˆ¶ |
| 2çº§ | **å†…éƒ¨çº§** | å†…éƒ¨ä¸šåŠ¡æ•°æ® | å‘˜å·¥æ—¥å¸¸å·¥ä½œ | éƒ¨é—¨é™åˆ¶ |
| 3çº§ | **ç§˜å¯†çº§** | æ•æ„Ÿä¸šåŠ¡æ•°æ® | éƒ¨é—¨ç®¡ç†ã€ä¸šåŠ¡é…ç½® | æ—¶é—´+IPé™åˆ¶ |
| 4çº§ | **æœºå¯†çº§** | é«˜åº¦æ•æ„Ÿæ•°æ® | é«˜çº§ç®¡ç†ã€è´¢åŠ¡æ•°æ® | ä¸¥æ ¼é™åˆ¶ |
| 5çº§ | **ç»å¯†çº§** | æ ¸å¿ƒæœºå¯†æ•°æ® | ç³»ç»Ÿç®¡ç†ã€å®‰å…¨é…ç½® | æœ€ä¸¥æ ¼é™åˆ¶ |

### å®‰å…¨çº§åˆ«çŸ©é˜µ

```java
// å®‰å…¨çº§åˆ«æƒé™æ˜ å°„ç¤ºä¾‹
public enum SecurityLevel {
    PUBLIC(1, "å…¬å¼€çº§"),
    INTERNAL(2, "å†…éƒ¨çº§"),
    CONFIDENTIAL(3, "ç§˜å¯†çº§"),
    SECRET(4, "æœºå¯†çº§"),
    TOP_SECRET(5, "ç»å¯†çº§");

    // æ¯ä¸ªçº§åˆ«å¯¹åº”çš„æƒé™é…ç½®
    private static final Map<Integer, SecurityLevelConfig> LEVEL_CONFIGS = Map.of(
        1, new SecurityLevelConfig(false, false, false),  // å…¬å¼€çº§
        2, new SecurityLevelConfig(true, false, false),   // å†…éƒ¨çº§
        3, new SecurityLevelConfig(true, true, false),     // ç§˜å¯†çº§
        4, new SecurityLevelConfig(true, true, true),      // æœºå¯†çº§
        5, new SecurityLevelConfig(true, true, true)       // ç»å¯†çº§
    );
}
```

### çº§åˆ«å‡çº§æœºåˆ¶

1. **è‡ªåŠ¨å‡çº§**: åŸºäºç”¨æˆ·è¡Œä¸ºå’Œç»©æ•ˆè‡ªåŠ¨è°ƒæ•´
2. **æ‰‹åŠ¨å‡çº§**: ç®¡ç†å‘˜å®¡æ‰¹åå‡çº§
3. **ä¸´æ—¶å‡çº§**: ç‰¹æ®Šé¡¹ç›®ä¸´æ—¶æƒé™æå‡
4. **è‡ªåŠ¨é™çº§**: æƒé™é—²ç½®æˆ–è¿è§„æ—¶è‡ªåŠ¨é™çº§

---

## ğŸ› ä¸šåŠ¡æƒé™é…ç½®

### åŒºåŸŸæƒé™ç®¡ç†

#### æƒé™ç±»å‹

- **è®¿é—®æƒé™ (ACCESS)**: è¿›å…¥å’ŒæŸ¥çœ‹åŒºåŸŸ
- **ç®¡ç†æƒé™ (MANAGE)**: åŒºåŸŸä¿¡æ¯å¢åˆ æ”¹
- **é…ç½®æƒé™ (CONFIG)**: åŒºåŸŸå‚æ•°å’Œé«˜çº§é…ç½®

#### é…ç½®ç¤ºä¾‹

```java
// åŒºåŸŸæƒé™é…ç½®è¯·æ±‚
AreaPermissionRequest request = AreaPermissionRequest.builder()
    .areaId(1001L)
    .userId(2001L)
    .permissionType("MANAGE")
    .effectiveTime(LocalDateTime.now())
    .expireTime(LocalDateTime.now().plusDays(30))
    .timeRestriction(TimeRestriction.builder()
        .workHours(true)
        .weekend(false)
        .holiday(false)
        .build())
    .ipRestrictions(List.of("192.168.1.0/24"))
    .build();
```

### è®¾å¤‡æƒé™ç®¡ç†

#### è®¾å¤‡ç±»å‹æƒé™

| è®¾å¤‡ç±»å‹ | é»˜è®¤æƒé™çº§åˆ« | ç‰¹æ®Šæƒé™ |
|----------|--------------|----------|
| æ‘„åƒå¤´ | 2çº§ | å®æ—¶æŸ¥çœ‹ |
| é—¨ç¦æ§åˆ¶å™¨ | 3çº§ | è¿œç¨‹æ§åˆ¶ |
| è€ƒå‹¤æœº | 2çº§ | æ•°æ®å¯¼å‡º |
| æ¶ˆè´¹ç»ˆç«¯ | 3çº§ | é…ç½®ç®¡ç† |

### è€ƒå‹¤æƒé™ç®¡ç†

#### æ•°æ®æƒé™èŒƒå›´

- **ä»…è‡ªå·± (self)**: åªèƒ½æŸ¥çœ‹è‡ªå·±è€ƒå‹¤è®°å½•
- **æœ¬éƒ¨é—¨ (department)**: å¯æŸ¥çœ‹éƒ¨é—¨å†…æ‰€æœ‰è€ƒå‹¤
- **ä¸‹å±éƒ¨é—¨ (sub_department)**: å¯æŸ¥çœ‹ä¸‹çº§éƒ¨é—¨è€ƒå‹¤
- **å…¨éƒ¨ (all)**: å¯æŸ¥çœ‹æ‰€æœ‰è€ƒå‹¤æ•°æ®

### é—¨ç¦æƒé™ç®¡ç†

#### å‘¨é€šè¡Œé…ç½®

```java
// å‘¨é€šè¡Œæƒé™é…ç½®
WeekdayAccessConfig weekConfig = WeekdayAccessConfig.builder()
    .mondayAccess(1)    // å‘¨ä¸€å…è®¸
    .tuesdayAccess(1)   // å‘¨äºŒå…è®¸
    .wednesdayAccess(1)  // å‘¨ä¸‰å…è®¸
    .thursdayAccess(1)   // å‘¨å››å…è®¸
    .fridayAccess(1)     // å‘¨äº”å…è®¸
    .saturdayAccess(0)   // å‘¨å…­ç¦æ­¢
    .sundayAccess(0)     // å‘¨æ—¥ç¦æ­¢
    .timeConfigs(List.of(
        TimeConfig.of("09:00-18:00"),  // å·¥ä½œæ—¶é—´
        TimeConfig.of("19:00-21:00")   // åŠ ç­æ—¶é—´
    ))
    .build();
```

---

## ğŸ” æƒé™éªŒè¯æœºåˆ¶

### éªŒè¯æµç¨‹

```java
// æƒé™éªŒè¯æµç¨‹
public class PermissionValidator {

    public PermissionResult validate(Long userId, String permissionCode,
                                      ResourceContext resourceContext) {
        // 1. ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™ä¿¡æ¯
        UserPermission userPermission = getFromCache(userId);
        if (userPermission == null) {
            userPermission = loadFromDatabase(userId);
            putToCache(userId, userPermission);
        }

        // 2. éªŒè¯å®‰å…¨çº§åˆ«
        SecurityLevel userLevel = userPermission.getSecurityLevel();
        SecurityLevel requiredLevel = getRequiredLevel(permissionCode);
        if (userLevel.getValue() < requiredLevel.getValue()) {
            return PermissionResult.denied("å®‰å…¨çº§åˆ«ä¸è¶³");
        }

        // 3. éªŒè¯å…·ä½“æƒé™
        if (!hasPermission(userPermission, permissionCode)) {
            return PermissionResult.denied("æƒé™ä¸è¶³");
        }

        // 4. éªŒè¯æ—¶é—´å’ŒIPé™åˆ¶
        if (!validateRestrictions(userPermission, resourceContext)) {
            return PermissionResult.denied("è®¿é—®å—é™");
        }

        // 5. è®°å½•å®¡è®¡æ—¥å¿—
        auditLog(userId, permissionCode, resourceContext, "ALLOWED");

        return PermissionResult.granted();
    }
}
```

### æƒé™ä¼˜å…ˆçº§

1. **å®‰å…¨çº§åˆ«**: æœ€é«˜ä¼˜å…ˆçº§ï¼Œå†³å®šåŸºç¡€è®¿é—®æƒé™
2. **å…·ä½“æƒé™**: ä¸šåŠ¡åŠŸèƒ½çº§åˆ«æƒé™
3. **æ•°æ®æƒé™**: æ•°æ®è®¿é—®èŒƒå›´æƒé™
4. **æ—¶é—´é™åˆ¶**: è®¿é—®æ—¶é—´çª—å£æƒé™
5. **IPé™åˆ¶**: ç½‘ç»œè®¿é—®ä½ç½®æƒé™

---

## ğŸ’¾ ç¼“å­˜ä¼˜åŒ–ç­–ç•¥

### å¤šçº§ç¼“å­˜æ¶æ„

```
Level 1: Caffeine (æœ¬åœ°ç¼“å­˜)
â”œâ”€â”€ å“åº”æ—¶é—´: < 1ms
â”œâ”€â”€ å®¹é‡: 1000 entries
â””â”€â”€ TTL: 10 minutes

Level 2: Redis (åˆ†å¸ƒå¼ç¼“å­˜)
â”œâ”€â”€ å“åº”æ—¶é—´: < 10ms
â”œâ”€â”€ å®¹é‡: 10,000 entries
â””â”€â”€ TTL: 30 minutes

Level 3: Database (æ•°æ®æŒä¹…åŒ–)
â”œâ”€â”€ å“åº”æ—¶é—´: < 100ms
â”œâ”€â”€ å®¹é‡: æ— é™åˆ¶
â””â”€â”€ æŒä¹…åŒ–å­˜å‚¨
```

### ç¼“å­˜ç­–ç•¥

#### ç¼“å­˜é”®è®¾è®¡

```java
// æƒé™ç¼“å­˜é”®æ ¼å¼
String cacheKey = "permission:" + userId + ":" + resourceType + ":" + resourceId;

// ç¤ºä¾‹
// permission:1001:area:2001  - ç”¨æˆ·1001å¯¹åŒºåŸŸ2001çš„æƒé™
// permission:1001:device:3001 - ç”¨æˆ·1001å¯¹è®¾å¤‡3001çš„æƒé™
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥

```java
@EventListener
public class PermissionChangeListener {

    @CacheEvict(value = "permission", key = "#userId + ':*")
    public void onPermissionChanged(Long userId, PermissionChangeEvent event) {
        // æƒé™å˜æ›´æ—¶æ¸…é™¤ç”¨æˆ·æ‰€æœ‰æƒé™ç¼“å­˜
        log.info("æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜: userId={}", userId);
    }

    @CachePut(value = "permission", key = "#userId + ':' + #resourceType + ':' + #resourceId")
    public UserPermission onPermissionUpdate(Long userId, String resourceType,
                                             Long resourceId, UserPermission permission) {
        return permission;
    }
}
```

### ç¼“å­˜ç›‘æ§

```java
@Component
public class PermissionCacheMonitor {

    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void monitorCacheHitRate() {
        long totalRequests = cacheStats.totalRequests();
        long cacheHits = cacheStats.cacheHits();
        double hitRate = (double) cacheHits / totalRequests * 100;

        log.info("æƒé™ç¼“å­˜å‘½ä¸­ç‡: {:.2f}%", hitRate);

        if (hitRate < 90.0) {
            log.warn("æƒé™ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼Œå»ºè®®ä¼˜åŒ–ç¼“å­˜ç­–ç•¥");
        }
    }
}
```

---

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### æƒé™éªŒè¯å®‰å…¨

#### 1. æ‰€æœ‰APIæ¥å£å¿…é¡»éªŒè¯æƒé™

```java
@RestController
@RequestMapping("/api/area")
@SaCheckLogin
public class AreaController {

    @GetMapping("/list")
    @SaCheckPermission("area:list")
    public ResponseDTO<List<AreaVO>> getAreaList() {
        // å®ç°é€»è¾‘
    }

    @PostMapping("/add")
    @SaCheckPermission("area:add")
    public ResponseDTO<String> addArea(@Valid @RequestBody AreaAddForm addForm) {
        // å®ç°é€»è¾‘
    }
}
```

#### 2. æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡éªŒè¯

```java
@PostMapping("/delete/{areaId}")
@SaCheckPermission("area:delete")
public ResponseDTO<String> deleteArea(@PathVariable Long areaId,
                                      @RequestParam String confirmCode) {
    // éªŒè¯ç¡®è®¤ç 
    if (!"DELETE_CONFIRM".equals(confirmCode)) {
        throw new BusinessException("è¯·ç¡®è®¤åˆ é™¤æ“ä½œ");
    }

    // æ‰§è¡Œåˆ é™¤é€»è¾‘
    return areaService.deleteArea(areaId);
}
```

#### 3. é˜²æ­¢æƒé™ç»•è¿‡

```java
@Aspect
@Component
public class PermissionCheckAspect {

    @Around("@annotation(SaCheckPermission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint) throws Throwable {
        // è·å–æ³¨è§£æƒé™
        SaCheckPermission annotation = getAnnotation(joinPoint, SaCheckPermission.class);

        // è·å–å½“å‰ç”¨æˆ·
        Long userId = StpUtil.getLoginId();
        if (userId == null) {
            throw new NotLoginException("ç”¨æˆ·æœªç™»å½•");
        }

        // éªŒè¯æƒé™ï¼ˆç»•è¿‡Sa-Tokenç›´æ¥è°ƒç”¨æˆ‘ä»¬çš„éªŒè¯å™¨ï¼‰
        String permissionCode = annotation.value()[0];
        if (!permissionValidator.validate(userId, permissionCode)) {
            throw new PermissionDeniedException("æƒé™ä¸è¶³");
        }

        return joinPoint.proceed();
    }
}
```

### æ•°æ®å®‰å…¨

#### 1. æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

```java
@Entity
@Table(name = "t_permission_audit")
public class PermissionAuditEntity {

    @TableId(type = IdType.AUTO)
    private Long auditId;

    @Column(name = "sensitive_data")
    @Convert(converter = SensitiveDataConverter.class)
    private String sensitiveData;  // æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

    // å…¶ä»–å­—æ®µ...
}
```

#### 2. å®¡è®¡æ—¥å¿—å®Œæ•´æ€§

```java
@Component
public class AuditLogService {

    public void auditPermissionOperation(Long userId, String operation,
                                           String resourceType, Long resourceId,
                                           String result, String details) {
        PermissionAuditLog auditLog = PermissionAuditLog.builder()
            .userId(userId)
            .operation(operation)
            .resourceType(resourceType)
            .resourceId(resourceId)
            .result(result)
            .details(details)
            .ipAddress(getClientIP())
            .userAgent(getUserAgent())
            .operationTime(LocalDateTime.now())
            .build();

        // å¼‚æ­¥ä¿å­˜å®¡è®¡æ—¥å¿—
        CompletableFuture.runAsync(() -> {
            auditLogRepository.save(auditLog);
        });
    }
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æƒé™éªŒè¯ä¼˜åŒ–

#### æ‰¹é‡æƒé™éªŒè¯

```java
@Service
public class BatchPermissionValidator {

    public Map<String, Boolean> validatePermissions(Long userId,
                                                   List<PermissionRequest> requests) {
        // ä¸€æ¬¡æ€§è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
        UserPermission userPermission = userPermissionService.getUserPermission(userId);

        return requests.stream()
            .collect(Collectors.toMap(
                PermissionRequest::getResourceKey,
                request -> validateSinglePermission(userPermission, request)
            ));
    }
}
```

#### æƒé™é¢„åŠ è½½

```java
@Component
public class PermissionPreloader {

    @EventListener
    public void onUserLogin(UserLoginEvent event) {
        // ç”¨æˆ·ç™»å½•æ—¶é¢„åŠ è½½å¸¸ç”¨æƒé™
        CompletableFuture.runAsync(() -> {
            permissionCache.preloadUserPermissions(event.getUserId());
        });
    }
}
```

### 2. æ•°æ®åº“ä¼˜åŒ–

#### æƒé™æŸ¥è¯¢ç´¢å¼•

```sql
-- ç”¨æˆ·æƒé™æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_user_permission ON t_user_permission(user_id, permission_code, expire_time);

-- å®¡è®¡æ—¥å¿—æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_audit_log ON t_permission_audit(user_id, operation_time, resource_type);

-- ç¼“å­˜é”®ç´¢å¼•
CREATE INDEX idx_cache_key ON t_permission_cache(cache_key, expire_time);
```

#### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

```java
public Page<UserPermission> getUserPermissions(Long userId, Pageable pageable) {
    return userPermissionRepository.findByUserIdOrderByCreateTimeDesc(userId, pageable);
}
```

### 3. ç½‘ç»œä¼ è¾“ä¼˜åŒ–

#### æƒé™ä¿¡æ¯å‹ç¼©

```java
public class PermissionCompressor {

    public byte[] compress(UserPermission permission) {
        // ä½¿ç”¨GZIPå‹ç¼©æƒé™ä¿¡æ¯
        return gzipCompress(objectMapper.writeValueAsBytes(permission));
    }

    public UserPermission decompress(byte[] compressed) {
        return objectMapper.readValue(gzipDecompress(compressed), UserPermission.class);
    }
}
```

---

## â“ å¸¸è§é—®é¢˜è§£å†³

### 1. æƒé™éªŒè¯å¤±è´¥

#### é—®é¢˜è¡¨ç°
- 403 Forbidden é”™è¯¯
- æƒé™ä¸è¶³å¼‚å¸¸

#### è§£å†³æ–¹æ¡ˆ

```java
// æ£€æŸ¥æ­¥éª¤
public void debugPermissionValidation(Long userId, String permissionCode) {
    // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
    if (StpUtil.isLogin()) {
        log.info("ç”¨æˆ·å·²ç™»å½•: {}", StpUtil.getLoginId());
    } else {
        log.error("ç”¨æˆ·æœªç™»å½•");
        return;
    }

    // 2. æ£€æŸ¥ç”¨æˆ·å®‰å…¨çº§åˆ«
    UserPermission userPermission = userPermissionService.getUserPermission(userId);
    log.info("ç”¨æˆ·å®‰å…¨çº§åˆ«: {}", userPermission.getSecurityLevel());

    // 3. æ£€æŸ¥å…·ä½“æƒé™
    boolean hasPermission = permissionValidator.hasPermission(userId, permissionCode);
    log.info("ç”¨æˆ·æƒé™ {}: {}", hasPermission ? "å·²æˆæƒ" : "æœªæˆæƒ", permissionCode);

    // 4. æ£€æŸ¥æƒé™æ—¶æ•ˆæ€§
    boolean isValid = permissionValidator.isPermissionValid(userId, permissionCode);
    log.info("æƒé™æ—¶æ•ˆæ€§: {}", isValid ? "æœ‰æ•ˆ" : "å·²è¿‡æœŸ");
}
```

### 2. ç¼“å­˜ä¸ä¸€è‡´

#### é—®é¢˜è¡¨ç°
- æƒé™æ›´æ–°åç¼“å­˜æœªåŠæ—¶åˆ·æ–°
- æƒé™éªŒè¯ç»“æœä¸ä¸€è‡´

#### è§£å†³æ–¹æ¡ˆ

```java
// å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
public void forceRefreshUserCache(Long userId) {
    // æ¸…é™¤æœ¬åœ°ç¼“å­˜
    localPermissionCache.evict(userId);

    // æ¸…é™¤Redisç¼“å­˜
    redisPermissionCache.evict(userId);

    // é‡æ–°åŠ è½½æƒé™æ•°æ®
    UserPermission userPermission = userPermissionService.loadFromDatabase(userId);

    // æ›´æ–°ç¼“å­˜
    putToAllCaches(userId, userPermission);

    log.info("å¼ºåˆ¶åˆ·æ–°ç”¨æˆ·æƒé™ç¼“å­˜: userId={}", userId);
}

// å®šæœŸç¼“å­˜ä¸€è‡´æ€§æ£€æŸ¥
@Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œ
public void validateCacheConsistency() {
    // éšæœºæŠ½æŸ¥ç¼“å­˜ä¸€è‡´æ€§
    List<Long> userIds = getRandomUserIds(10);

    for (Long userId : userIds) {
        UserPermission dbPermission = userPermissionService.loadFromDatabase(userId);
        UserPermission cachePermission = getFromCache(userId);

        if (!Objects.equals(dbPermission, cachePermission)) {
            log.warn("å‘ç°ç¼“å­˜ä¸ä¸€è‡´ï¼Œç”¨æˆ·ID: {}", userId);
            forceRefreshUserCache(userId);
        }
    }
}
```

### 3. æ€§èƒ½é—®é¢˜

#### æƒé™éªŒè¯å“åº”æ…¢

##### è¯Šæ–­æ–¹æ³•

```java
@Component
public class PermissionPerformanceMonitor {

    @EventListener
    public void monitorPermissionValidation(PermissionValidationEvent event) {
        long startTime = System.currentTimeMillis();

        // æ‰§è¡Œæƒé™éªŒè¯
        PermissionResult result = permissionValidator.validate(
            event.getUserId(),
            event.getPermissionCode(),
            event.getResourceContext()
        );

        long duration = System.currentTimeMillis() - startTime;

        // è®°å½•æ€§èƒ½æ•°æ®
        if (duration > 50) { // è¶…è¿‡50msè®°å½•æ…¢æŸ¥è¯¢
            log.warn("æƒé™éªŒè¯è€—æ—¶è¿‡é•¿: {}ms, userId={}, permission={}",
                     duration, event.getUserId(), event.getPermissionCode());
        }

        performanceMetrics.recordPermissionValidation(duration);
    }
}
```

##### ä¼˜åŒ–ç­–ç•¥

```java
// 1. å¹¶è¡Œæƒé™éªŒè¯
public CompletableFuture<Boolean> validatePermissionAsync(Long userId,
                                                        String permissionCode) {
    return CompletableFuture.supplyAsync(() ->
        permissionValidator.validate(userId, permissionCode)
    );
}

// 2. æƒé™ç»“æœç¼“å­˜
@Cacheable(value = "permission:result", key = "#userId + ':' + #permissionCode")
public boolean validatePermissionWithCache(Long userId, String permissionCode) {
    return permissionValidator.validate(userId, permissionCode).isAllowed();
}
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### å…³é”®æŒ‡æ ‡ç›‘æ§

#### 1. æƒé™éªŒè¯æ€§èƒ½æŒ‡æ ‡

```java
@Component
public class PermissionMetrics {

    private final MeterRegistry meterRegistry;

    // æƒé™éªŒè¯æ¬¡æ•°
    private final Counter permissionValidationCounter;

    // æƒé™éªŒè¯è€—æ—¶
    private final Timer permissionValidationTimer;

    // æƒé™éªŒè¯æˆåŠŸç‡
    private final Counter permissionSuccessCounter;
    private final Counter permissionFailureCounter;

    public PermissionMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.permissionValidationCounter = Counter.builder("permission.validation.count")
            .description("æƒé™éªŒè¯æ€»æ¬¡æ•°")
            .register(meterRegistry);

        this.permissionValidationTimer = Timer.builder("permission.validation.duration")
            .description("æƒé™éªŒè¯è€—æ—¶")
            .register(meterRegistry);

        this.permissionSuccessCounter = Counter.builder("permission.success.count")
            .description("æƒé™éªŒè¯æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);

        this.permissionFailureCounter = Counter.builder("permission.failure.count")
            .description("æƒé™éªŒè¯å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);
    }

    public void recordPermissionValidation(long duration, boolean success) {
        permissionValidationCounter.increment();
        permissionValidationTimer.record(duration, TimeUnit.MILLISECONDS);

        if (success) {
            permissionSuccessCounter.increment();
        } else {
            permissionFailureCounter.increment();
        }
    }
}
```

#### 2. å¥åº·æ£€æŸ¥

```java
@Component
public class PermissionHealthIndicator implements HealthIndicator {

    @Override
    public Health health() {
        try {
            // æ£€æŸ¥æƒé™æœåŠ¡å¯ç”¨æ€§
            boolean serviceAvailable = permissionService.isHealthy();

            // æ£€æŸ¥ç¼“å­˜è¿æ¥çŠ¶æ€
            boolean cacheHealthy = cacheService.isHealthy();

            // æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
            boolean dbHealthy = databaseService.isHealthy();

            if (serviceAvailable && cacheHealthy && dbHealthy) {
                return Health.up()
                    .withDetail("service", "æƒé™æœåŠ¡æ­£å¸¸")
                    .withDetail("cache", "ç¼“å­˜æœåŠ¡æ­£å¸¸")
                    .withDetail("database", "æ•°æ®åº“è¿æ¥æ­£å¸¸")
                    .build();
            } else {
                return Health.down()
                    .withDetail("service", serviceAvailable ? "æ­£å¸¸" : "å¼‚å¸¸")
                    .withDetail("cache", cacheHealthy ? "æ­£å¸¸" : "å¼‚å¸¸")
                    .withDetail("database", dbHealthy ? "æ­£å¸¸" : "å¼‚å¸¸")
                    .build();
            }

        } catch (Exception e) {
            return Health.down(e)
                .withDetail("error", e.getMessage())
                .build();
        }
    }
}
```

### 3. å‘Šè­¦æœºåˆ¶

#### æƒé™å¼‚å¸¸å‘Šè­¦

```java
@Component
public class PermissionAlertService {

    @EventListener
    public void handlePermissionFailure(PermissionFailureEvent event) {
        // æƒé™éªŒè¯å¤±è´¥å‘Šè­¦
        AlertLevel alertLevel = determineAlertLevel(event);

        String alertMessage = String.format(
            "æƒé™éªŒè¯å¤±è´¥: ç”¨æˆ·=%d, æƒé™=%s, èµ„æº=%s, IP=%s",
            event.getUserId(),
            event.getPermissionCode(),
            event.getResourceInfo(),
            event.getClientIP()
        );

        // å‘é€å‘Šè­¦é€šçŸ¥
        alertService.sendAlert(alertLevel, "æƒé™éªŒè¯å¼‚å¸¸", alertMessage);

        // è®°å½•å‘Šè­¦æ—¥å¿—
        log.error("æƒé™éªŒè¯å¼‚å¸¸å‘Šè­¦: {}", alertMessage);
    }

    private AlertLevel determineAlertLevel(PermissionFailureEvent event) {
        // æ ¹æ®å¤±è´¥æ¬¡æ•°å’Œæ•æ„Ÿåº¦ç¡®å®šå‘Šè­¦çº§åˆ«
        int failureCount = event.getFailureCount();
        SecurityLevel securityLevel = event.getSecurityLevel();

        if (failureCount >= 10 || securityLevel.getValue() >= 4) {
            return AlertLevel.CRITICAL;
        } else if (failureCount >= 5 || securityLevel.getValue() >= 3) {
            return AlertLevel.WARNING;
        } else {
            return AlertLevel.INFO;
        }
    }
}
```

---

## ğŸ“š é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [SmartAdmin å¼€å‘è§„èŒƒæ–‡æ¡£](../DEV_STANDARDS.md)
- [æ•°æ®åº“è®¾è®¡è§„èŒƒ](../DATABASE_DESIGN_STANDARDS.md)
- [APIè®¾è®¡è§„èŒƒ](../API_DESIGN_STANDARDS.md)
- [ç³»ç»Ÿå®‰å…¨è§„èŒƒ](../SYSTEM_SECURITY_STANDARDS.md)

### B. é…ç½®å‚æ•°

```yaml
# application.yml
smart:
  permission:
    # ç¼“å­˜é…ç½®
    cache:
      caffeine:
        max-size: 1000
        expire-after-write: 10m
      redis:
        key-prefix: "smart:permission:"
        default-timeout: 30m

    # å®‰å…¨é…ç½®
    security:
      default-security-level: 2
      max-security-level: 5
      session-timeout: 30m

    # å®¡è®¡é…ç½®
    audit:
      enabled: true
      retention-days: 90
      async: true
```

### C. APIæ¥å£æ–‡æ¡£

è¯¦ç»†çš„APIæ¥å£æ–‡æ¡£è¯·å‚è€ƒç”Ÿæˆçš„Swaggeræ–‡æ¡£ï¼š
- å¼€å‘ç¯å¢ƒ: http://localhost:1024/doc.html
- æµ‹è¯•ç¯å¢ƒ: http://test.smartadmin.com/doc.html
- ç”Ÿäº§ç¯å¢ƒ: http://prod.smartadmin.com/doc.html

---

**ç»´æŠ¤å›¢é˜Ÿ**: SmartAdmin å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-14
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0