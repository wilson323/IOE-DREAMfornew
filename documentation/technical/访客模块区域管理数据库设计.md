# è®¿å®¢æ¨¡å—åŒºåŸŸç®¡ç†æ•°æ®åº“è®¾è®¡

> **è®¾è®¡æ—¶é—´**: 2025-12-08
> **è®¾è®¡ç›®æ ‡**: æ”¯æŒè®¿å®¢åŒºåŸŸç²¾ç»†åŒ–ç®¡ç†å’Œè®¿é—®æ§åˆ¶
> **è®¾è®¡åŸåˆ™**: ç»§æ‰¿ç»Ÿä¸€åŒºåŸŸæ¦‚å¿µï¼Œæ‰©å±•è®¿å®¢ä¸“ç”¨ä¸šåŠ¡å±æ€§
> **æ•°æ®åº“**: MySQL 8.0+

---

## ğŸ“‹ æ•°æ®åº“è¡¨è®¾è®¡

### 1. è®¿å®¢åŒºåŸŸè¡¨ (t_visitor_area)

#### è¡¨ç»“æ„å®šä¹‰

```sql
CREATE TABLE `t_visitor_area` (
  `visitor_area_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'è®¿å®¢åŒºåŸŸIDï¼ˆä¸»é”®ï¼‰',
  `area_id` BIGINT NOT NULL COMMENT 'åŒºåŸŸIDï¼ˆå…³è”åŒºåŸŸè¡¨ï¼‰',
  `visit_type` INT NOT NULL COMMENT 'è®¿é—®ç±»å‹(1-é¢„çº¦è®¿é—® 2-ä¸´æ—¶è®¿é—® 3-VIPè®¿é—® 4-ä¾›åº”å•†è®¿é—® 5-ç»´ä¿®è®¿é—®)',
  `access_level` INT NOT NULL DEFAULT 2 COMMENT 'è®¿é—®æƒé™çº§åˆ«(1-å…¬å¼€åŒºåŸŸ 2-é™åˆ¶åŒºåŸŸ 3-ä¿å¯†åŒºåŸŸ 4-ç¦åŒº)',
  `max_visitors` INT DEFAULT 50 COMMENT 'æœ€å¤§åŒæ—¶è®¿å®¢æ•°é‡',
  `current_visitors` INT DEFAULT 0 COMMENT 'å½“å‰è®¿å®¢æ•°é‡',
  `reception_required` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'æ˜¯å¦éœ€è¦æ¥å¾…äººå‘˜',
  `receptionist_id` BIGINT DEFAULT NULL COMMENT 'æ¥å¾…äººå‘˜ID',
  `receptionist_name` VARCHAR(50) DEFAULT NULL COMMENT 'æ¥å¾…äººå‘˜å§“å',
  `photo_allowed` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å…è®¸æ‹ç…§',
  `video_allowed` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å…è®¸å½•åˆ¶',
  `visit_time_limit` INT DEFAULT 120 COMMENT 'è®¿é—®æ—¶é—´é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰',
  `appointment_days_limit` INT DEFAULT 7 COMMENT 'é¢„çº¦æå‰å¤©æ•°é™åˆ¶',
  `health_check_required` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦éœ€è¦å¥åº·æ£€æŸ¥',
  `health_check_standard` TEXT DEFAULT NULL COMMENT 'å¥åº·æ£€æŸ¥æ ‡å‡†(JSONæ ¼å¼)',
  `id_card_required` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'æ˜¯å¦éœ€è¦èº«ä»½è¯éªŒè¯',
  `face_recognition_required` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦éœ€è¦äººè„¸è¯†åˆ«',
  `visitor_devices` TEXT DEFAULT NULL COMMENT 'è®¿å®¢è®¾å¤‡é…ç½®(JSONæ ¼å¼)',
  `safety_notes` VARCHAR(500) DEFAULT NULL COMMENT 'å®‰å…¨æ³¨æ„äº‹é¡¹',
  `open_hours` TEXT DEFAULT NULL COMMENT 'åŒºåŸŸå¼€æ”¾æ—¶é—´é…ç½®(JSONæ ¼å¼)',
  `approval_process` INT DEFAULT 1 COMMENT 'è®¿å®¢å®¡æ‰¹æµç¨‹(1-æ— éœ€å®¡æ‰¹ 2-éƒ¨é—¨ç»ç†å®¡æ‰¹ 3-å®‰å…¨éƒ¨é—¨å®¡æ‰¹ 4-å¤šçº§å®¡æ‰¹)',
  `approver_id` BIGINT DEFAULT NULL COMMENT 'å®¡æ‰¹äººID',
  `approver_name` VARCHAR(50) DEFAULT NULL COMMENT 'å®¡æ‰¹äººå§“å',
  `emergency_contact` TEXT DEFAULT NULL COMMENT 'ç´§æ€¥è”ç³»äººä¿¡æ¯(JSONæ ¼å¼)',
  `visitor_instructions` TEXT DEFAULT NULL COMMENT 'è®¿å®¢é¡»çŸ¥',
  `visitor_statistics_config` TEXT DEFAULT NULL COMMENT 'è®¿å®¢ç»Ÿè®¡é…ç½®(JSONæ ¼å¼)',
  `enabled` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
  `effective_time` DATETIME DEFAULT NULL COMMENT 'ç”Ÿæ•ˆæ—¶é—´',
  `expire_time` DATETIME DEFAULT NULL COMMENT 'å¤±æ•ˆæ—¶é—´',
  `remark` VARCHAR(500) DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `create_user_id` BIGINT DEFAULT NULL COMMENT 'åˆ›å»ºäººID',
  `update_user_id` BIGINT DEFAULT NULL COMMENT 'æ›´æ–°äººID',
  `deleted_flag` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°(0-æœªåˆ é™¤ 1-å·²åˆ é™¤)',
  `version` INT NOT NULL DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  PRIMARY KEY (`visitor_area_id`),
  UNIQUE KEY `uk_area_id` (`area_id`, `deleted_flag`),
  KEY `idx_visit_type` (`visit_type`),
  KEY `idx_access_level` (`access_level`),
  KEY `idx_receptionist_id` (`receptionist_id`),
  KEY `idx_approver_id` (`approver_id`),
  KEY `idx_enabled` (`enabled`),
  KEY `idx_create_time` (`create_time`),
  KEY `idx_visit_access` (`visit_type`, `access_level`),
  KEY `idx_reception_enabled` (`reception_required`, `enabled`),
  KEY `idx_area_visitor_capacity` (`area_id`, `current_visitors`, `max_visitors`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è®¿å®¢åŒºåŸŸè¡¨';

-- æ·»åŠ è¡¨æ³¨é‡Š
ALTER TABLE `t_visitor_area` COMMENT = 'è®¿å®¢åŒºåŸŸè¡¨ - ç®¡ç†è®¿å®¢ä¸“ç”¨åŒºåŸŸé…ç½®å’Œè®¿é—®æ§åˆ¶è§„åˆ™';
```

#### å­—æ®µè¯¦ç»†è¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| **visitor_area_id** | BIGINT | è®¿å®¢åŒºåŸŸIDï¼Œä¸»é”®ï¼Œè‡ªå¢ | 1001 |
| **area_id** | BIGINT | åŒºåŸŸIDï¼Œå…³è”åŒºåŸŸè¡¨ | 1001 |
| **visit_type** | INT | è®¿é—®ç±»å‹ï¼Œæ ‡å‡†æšä¸¾å€¼ | 1(é¢„çº¦è®¿é—®) |
| **access_level** | INT | è®¿é—®æƒé™çº§åˆ«ï¼Œæ ‡å‡†æšä¸¾å€¼ | 2(é™åˆ¶åŒºåŸŸ) |
| **max_visitors** | INT | æœ€å¤§åŒæ—¶è®¿å®¢æ•°é‡ | 50 |
| **current_visitors** | INT | å½“å‰è®¿å®¢æ•°é‡ | 15 |
| **reception_required** | TINYINT(1) | æ˜¯å¦éœ€è¦æ¥å¾…äººå‘˜ | 1(éœ€è¦) |
| **health_check_standard** | TEXT | å¥åº·æ£€æŸ¥æ ‡å‡†ï¼ŒJSONæ ¼å¼ | `{"temperature": true, "mask": true}` |
| **visitor_devices** | TEXT | è®¿å®¢è®¾å¤‡é…ç½®ï¼ŒJSONæ ¼å¼ | `{"registrationDevice": "DEV001"}` |
| **open_hours** | TEXT | å¼€æ”¾æ—¶é—´é…ç½®ï¼ŒJSONæ ¼å¼ | `{"workdays": {"start": "09:00", "end": "18:00"}}` |

### 2. è®¿é—®ç±»å‹æšä¸¾å®šä¹‰

#### è®¿é—®ç±»å‹
```sql
-- è®¿é—®ç±»å‹æšä¸¾
-- 1: é¢„çº¦è®¿é—® (Appointment Visit) - éœ€è¦æå‰é¢„çº¦
-- 2: ä¸´æ—¶è®¿é—® (Temporary Visit) - ç°åœºç™»è®°
-- 3: VIPè®¿é—® (VIP Visit) - ç»¿è‰²é€šé“
-- 4: ä¾›åº”å•†è®¿é—® (Supplier Visit) - é•¿æœŸæƒé™
-- 5: ç»´ä¿®è®¿é—® (Maintenance Visit) - è®¾å¤‡ç»´æŠ¤
```

#### è®¿é—®æƒé™çº§åˆ«
```sql
-- è®¿é—®æƒé™çº§åˆ«æšä¸¾
-- 1: å…¬å¼€åŒºåŸŸ (Public Area) - æ— éœ€ç‰¹æ®Šæƒé™
-- 2: é™åˆ¶åŒºåŸŸ (Restricted Area) - éœ€è¦é¢„çº¦æˆ–å®¡æ‰¹
-- 3: ä¿å¯†åŒºåŸŸ (Confidential Area) - éœ€è¦é«˜çº§åˆ«å®¡æ‰¹
-- 4: ç¦åŒº (Prohibited Area) - ç¦æ­¢è®¿å®¢è¿›å…¥
```

#### å®¡æ‰¹æµç¨‹
```sql
-- å®¡æ‰¹æµç¨‹æšä¸¾
-- 1: æ— éœ€å®¡æ‰¹ (No Approval Required)
-- 2: éƒ¨é—¨ç»ç†å®¡æ‰¹ (Department Manager Approval)
-- 3: å®‰å…¨éƒ¨é—¨å®¡æ‰¹ (Security Department Approval)
-- 4: å¤šçº§å®¡æ‰¹ (Multi-level Approval)
```

### 3. ä¸šåŠ¡å±æ€§æ¨¡æ¿

#### å¥åº·æ£€æŸ¥æ ‡å‡†æ¨¡æ¿
```json
{
  "temperature": true,        // æ˜¯å¦æµ‹ä½“æ¸©
  "temperatureThreshold": 37.3, // ä½“æ¸©é˜ˆå€¼
  "mask": true,               // æ˜¯å¦éœ€è¦æˆ´å£ç½©
  "healthCode": true,         // æ˜¯å¦éœ€è¦å¥åº·ç 
  "travelHistory": false,     // æ˜¯å¦æ£€æŸ¥æ—…è¡Œå²
  "contactHistory": false,    // æ˜¯å¦æ£€æŸ¥æ¥è§¦å²
  "symptomCheck": true        // æ˜¯å¦ç—‡çŠ¶æ£€æŸ¥
}
```

#### è®¿å®¢è®¾å¤‡é…ç½®æ¨¡æ¿
```json
{
  "registrationDevice": "DEV001",     // è®¿å®¢ç™»è®°ç»ˆç«¯
  "accessDevice": "DEV002",           // é—¨ç¦è®¾å¤‡
  "cameraDevice": "CAM001",           // æ‘„åƒå¤´è®¾å¤‡
  "printerDevice": "PRINTER001",      // è®¿å®¢è¯æ‰“å°æœº
  "temperatureDevice": "TEMP001",     // ä½“æ¸©æ£€æµ‹è®¾å¤‡
  "qrCodeReader": "QR001"            // äºŒç»´ç æ‰«æå™¨
}
```

#### å¼€æ”¾æ—¶é—´é…ç½®æ¨¡æ¿
```json
{
  "workdays": {
    "start": "09:00",
    "end": "18:00",
    "lunchBreak": {
      "start": "12:00",
      "end": "13:00"
    }
  },
  "weekends": {
    "start": "10:00",
    "end": "16:00"
  },
  "holidays": {
    "enabled": false,
    "specialHours": []
  }
}
```

#### ç´§æ€¥è”ç³»äººä¿¡æ¯æ¨¡æ¿
```json
{
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "department": "å®‰å…¨éƒ¨",
  "title": "å®‰å…¨ç®¡ç†å‘˜",
  "backupContact": {
    "name": "æå››",
    "phone": "13900139000"
  },
  "emergencyProcedure": "ç«‹å³æ‹¨æ‰“å†…çº¿8888"
}
```

#### è®¿å®¢ç»Ÿè®¡é…ç½®æ¨¡æ¿
```json
{
  "enableStatistics": true,
  "reportInterval": "daily",        // daily/weekly/monthly
  "alerts": {
    "maxVisitors": true,             // è¶…è¿‡æœ€å¤§è®¿å®¢æ•°å‘Šè­¦
    "overstay": true,                // è¶…æ—¶é€—ç•™å‘Šè­¦
    "unauthorizedAccess": true,      // æœªæˆæƒè®¿é—®å‘Šè­¦
    "healthIssue": true              // å¥åº·é—®é¢˜å‘Šè­¦
  },
  "notifications": {
    "email": ["security@company.com"],
    "sms": ["13800138000"],
    "wechat": ["security_bot"]
  }
}
```

---

## ğŸ” ç´¢å¼•è®¾è®¡è¯´æ˜

### 1. ä¸»è¦ç´¢å¼•ç”¨é€”

```sql
-- ä¸»è¦æŸ¥è¯¢ç´¢å¼•
UNIQUE KEY `uk_area_id` (`area_id`, `deleted_flag`)                    -- åŒºåŸŸå”¯ä¸€æ€§çº¦æŸ
KEY `idx_visit_type` (`visit_type`)                                      -- è®¿é—®ç±»å‹æŸ¥è¯¢
KEY `idx_access_level` (`access_level`)                                   -- æƒé™çº§åˆ«æŸ¥è¯¢
KEY `idx_receptionist_id` (`receptionist_id`)                             -- æ¥å¾…äººå‘˜æŸ¥è¯¢
KEY `idx_approver_id` (`approver_id`)                                      -- å®¡æ‰¹äººæŸ¥è¯¢

-- ç»„åˆç´¢å¼•
KEY `idx_visit_access` (`visit_type`, `access_level`)                     -- è®¿é—®ç±»å‹å’Œæƒé™çº§åˆ«ç»„åˆæŸ¥è¯¢
KEY `idx_reception_enabled` (`reception_required`, `enabled`)             -- éœ€è¦æ¥å¾…çš„å¼€æ”¾åŒºåŸŸæŸ¥è¯¢
KEY `idx_area_visitor_capacity` (`area_id`, `current_visitors`, `max_visitors`) -- åŒºåŸŸå®¹é‡æŸ¥è¯¢
```

### 2. æŸ¥è¯¢åœºæ™¯ä¼˜åŒ–

#### å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼
```sql
-- 1. æ ¹æ®åŒºåŸŸIDè·å–è®¿å®¢é…ç½®
SELECT * FROM t_visitor_area
WHERE area_id = ? AND enabled = 1 AND deleted_flag = 0
  AND (expire_time IS NULL OR expire_time > NOW());

-- 2. æ ¹æ®è®¿é—®ç±»å‹è·å–è®¿å®¢åŒºåŸŸ
SELECT va.*, a.area_name, a.area_code
FROM t_visitor_area va
INNER JOIN t_area a ON va.area_id = a.area_id
WHERE va.visit_type = ? AND va.enabled = 1 AND va.deleted_flag = 0
  AND a.status = 1;

-- 3. è·å–éœ€è¦æ¥å¾…äººå‘˜çš„è®¿å®¢åŒºåŸŸ
SELECT * FROM t_visitor_area
WHERE reception_required = 1 AND enabled = 1 AND deleted_flag = 0;

-- 4. æ£€æŸ¥åŒºåŸŸè®¿å®¢å®¹é‡
SELECT area_id, current_visitors, max_visitors
FROM t_visitor_area
WHERE area_id = ? AND enabled = 1 AND deleted_flag = 0;

-- 5. è·å–å½“å‰æ—¶æ®µå¼€æ”¾çš„è®¿å®¢åŒºåŸŸ
SELECT va.*, a.area_name
FROM t_visitor_area va
INNER JOIN t_area a ON va.area_id = a.area_id
WHERE va.enabled = 1 AND va.deleted_flag = 0 AND a.status = 1
  AND (
    va.open_hours IS NULL
    OR JSON_EXTRACT(va.open_hours, CONCAT('$.',
      CASE DAYOFWEEK(NOW())
        WHEN 1 THEN 'sunday'
        WHEN 2 THEN 'monday'
        WHEN 3 THEN 'tuesday'
        WHEN 4 THEN 'wednesday'
        WHEN 5 THEN 'thursday'
        WHEN 6 THEN 'friday'
        WHEN 7 THEN 'saturday'
      END)) IS NOT NULL
  );
```

---

## ğŸ“Š ç»Ÿè®¡æŸ¥è¯¢è®¾è®¡

### 1. è®¿å®¢åŒºåŸŸç»Ÿè®¡æŸ¥è¯¢

```sql
-- è®¿å®¢åŒºåŸŸåŸºç¡€ç»Ÿè®¡
SELECT
  COUNT(*) as total_areas,
  SUM(CASE WHEN access_level = 1 THEN 1 ELSE 0 END) as public_areas,
  SUM(CASE WHEN access_level = 2 THEN 1 ELSE 0 END) as restricted_areas,
  SUM(CASE WHEN access_level = 3 THEN 1 ELSE 0 END) as confidential_areas,
  SUM(max_visitors) as total_capacity,
  SUM(current_visitors) as current_visitors,
  ROUND(SUM(current_visitors) * 100.0 / SUM(max_visitors), 2) as occupancy_rate
FROM t_visitor_area
WHERE enabled = 1 AND deleted_flag = 0;

-- æŒ‰è®¿é—®ç±»å‹ç»Ÿè®¡
SELECT
  visit_type,
  CASE visit_type
    WHEN 1 THEN 'é¢„çº¦è®¿é—®'
    WHEN 2 THEN 'ä¸´æ—¶è®¿é—®'
    WHEN 3 THEN 'VIPè®¿é—®'
    WHEN 4 THEN 'ä¾›åº”å•†è®¿é—®'
    WHEN 5 THEN 'ç»´ä¿®è®¿é—®'
  END as visit_type_name,
  COUNT(*) as area_count,
  SUM(max_visitors) as total_capacity,
  SUM(current_visitors) as current_visitors
FROM t_visitor_area
WHERE enabled = 1 AND deleted_flag = 0
GROUP BY visit_type
ORDER BY visit_type;

-- æŒ‰æ¥å¾…äººå‘˜ç»Ÿè®¡
SELECT
  receptionist_id,
  receptionist_name,
  COUNT(*) as managed_areas,
  SUM(max_visitors) as total_capacity,
  SUM(current_visitors) as current_visitors
FROM t_visitor_area
WHERE reception_required = 1 AND enabled = 1 AND deleted_flag = 0
GROUP BY receptionist_id, receptionist_name
ORDER BY managed_areas DESC;
```

### 2. å®¹é‡ç›‘æ§æŸ¥è¯¢

```sql
-- è®¿å®¢å®¹é‡è¶…é™ç›‘æ§
SELECT
  va.area_id,
  a.area_name,
  va.current_visitors,
  va.max_visitors,
  (va.current_visitors - va.max_visitors) as over_capacity,
  ROUND(va.current_visitors * 100.0 / va.max_visitors, 2) as occupancy_rate
FROM t_visitor_area va
INNER JOIN t_area a ON va.area_id = a.area_id
WHERE va.enabled = 1 AND va.deleted_flag = 0
  AND va.current_visitors >= va.max_visitors
ORDER BY over_capacity DESC;

-- è®¿å®¢å®¹é‡é¢„è­¦
SELECT
  va.area_id,
  a.area_name,
  va.current_visitors,
  va.max_visitors,
  ROUND(va.current_visitors * 100.0 / va.max_visitors, 2) as occupancy_rate
FROM t_visitor_area va
INNER JOIN t_area a ON va.area_id = a.area_id
WHERE va.enabled = 1 AND va.deleted_flag = 0
  AND va.current_visitors * 100.0 / va.max_visitors >= 80  -- 80%é¢„è­¦
ORDER BY occupancy_rate DESC;
```

### 3. æ—¶é—´ç»´åº¦ç»Ÿè®¡

```sql
-- è®¿å®¢åŒºåŸŸä½¿ç”¨è¶‹åŠ¿
SELECT
  DATE(update_time) as stat_date,
  COUNT(*) as area_count,
  SUM(max_visitors) as total_capacity,
  SUM(current_visitors) as current_visitors,
  ROUND(SUM(current_visitors) * 100.0 / SUM(max_visitors), 2) as avg_occupancy_rate
FROM t_visitor_area
WHERE enabled = 1 AND deleted_flag = 0
  AND update_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(update_time)
ORDER BY stat_date;

-- è®¿å®¢åŒºåŸŸé…ç½®å˜æ›´ç»Ÿè®¡
SELECT
  DATE(update_time) as change_date,
  COUNT(*) as change_count,
  SUM(CASE WHEN enabled = 1 THEN 1 ELSE 0 END) as enabled_count,
  SUM(CASE WHEN enabled = 0 THEN 1 ELSE 0 END) as disabled_count
FROM t_visitor_area
WHERE update_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(update_time)
ORDER BY change_date;
```

---

## ğŸ”§ æ•°æ®åº“ä¼˜åŒ–å»ºè®®

### 1. åˆ†åŒºç­–ç•¥

```sql
-- æŒ‰æœˆåˆ†åŒºï¼ˆé€‚ç”¨äºå¤§æ•°æ®é‡åœºæ™¯ï¼‰
ALTER TABLE t_visitor_area
PARTITION BY RANGE (YEAR(create_time) * 100 + MONTH(create_time)) (
    PARTITION p202512 VALUES LESS THAN (202601),
    PARTITION p202601 VALUES LESS THAN (202602),
    PARTITION p202602 VALUES LESS THAN (202603),
    -- ... ç»§ç»­æ·»åŠ åˆ†åŒº
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. æ€§èƒ½ä¼˜åŒ–é…ç½®

```sql
-- MySQLé…ç½®ä¼˜åŒ–å»ºè®®
-- innodb_buffer_pool_size: è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„70-80%
-- innodb_log_file_size: è®¾ç½®ä¸º256M-1G
-- query_cache_type: é’ˆå¯¹è®¿å®¢ç»Ÿè®¡æŸ¥è¯¢å¯ä»¥è€ƒè™‘å¼€å¯
-- max_connections: æ ¹æ®è®¿å®¢å¹¶å‘è®¿é—®éœ€æ±‚é…ç½®

-- è®¿å®¢åŒºåŸŸç‰¹å®šä¼˜åŒ–
-- sort_buffer_size: å¢å¤§æ’åºç¼“å†²åŒºï¼Œæ”¯æŒè®¿å®¢ç»Ÿè®¡åˆ†æ
-- tmp_table_size: å¢å¤§ä¸´æ—¶è¡¨å¤§å°ï¼Œæ”¯æŒå¤æ‚ç»Ÿè®¡æŸ¥è¯¢
-- join_buffer_size: å¢å¤§è¿æ¥ç¼“å†²åŒºï¼Œæ”¯æŒåŒºåŸŸå…³è”æŸ¥è¯¢
```

### 3. å®šæœŸç»´æŠ¤ä»»åŠ¡

```sql
-- å®šæœŸæ¸…ç†è½¯åˆ é™¤æ•°æ®
DELETE FROM t_visitor_area
WHERE deleted_flag = 1
  AND update_time < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- å®šæœŸä¼˜åŒ–è¡¨ç»“æ„
OPTIMIZE TABLE t_visitor_area;

-- å®šæœŸæ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE t_visitor_area;

-- å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
SELECT COUNT(*) FROM t_visitor_area va
LEFT JOIN t_area a ON va.area_id = a.area_id
WHERE va.area_id IS NOT NULL AND a.area_id IS NULL;
```

### 4. ç›‘æ§æŒ‡æ ‡

```sql
-- è®¿å®¢åŒºåŸŸå®¹é‡ç›‘æ§è§†å›¾
CREATE VIEW v_visitor_area_capacity_monitor AS
SELECT
  va.visitor_area_id,
  va.area_id,
  a.area_name,
  va.max_visitors,
  va.current_visitors,
  (va.max_visitors - va.current_visitors) as available_capacity,
  ROUND(va.current_visitors * 100.0 / va.max_visitors, 2) as occupancy_rate,
  CASE
    WHEN va.current_visitors >= va.max_visitors THEN 'FULL'
    WHEN va.current_visitors * 100.0 / va.max_visitors >= 90 THEN 'CRITICAL'
    WHEN va.current_visitors * 100.0 / va.max_visitors >= 80 THEN 'WARNING'
    ELSE 'NORMAL'
  END as status
FROM t_visitor_area va
INNER JOIN t_area a ON va.area_id = a.area_id
WHERE va.enabled = 1 AND va.deleted_flag = 0;
```

---

## ğŸ”„ æ•°æ®åŒæ­¥è®¾è®¡

### 1. ä¸åŒºåŸŸè¡¨åŒæ­¥

```sql
-- è®¿å®¢åŒºåŸŸä¸åŒºåŸŸè¡¨æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
SELECT
  va.area_id,
  'visitor_area_missing_area' as issue_type
FROM t_visitor_area va
LEFT JOIN t_area a ON va.area_id = a.area_id
WHERE a.area_id IS NULL AND va.deleted_flag = 0

UNION ALL

SELECT
  a.area_id,
  'area_missing_visitor_config' as issue_type
FROM t_area a
LEFT JOIN t_visitor_area va ON a.area_id = va.area_id AND va.deleted_flag = 0
WHERE va.area_id IS NULL AND a.status = 1;
```

### 2. æ•°æ®æ›´æ–°è§¦å‘å™¨

```sql
-- åŒºåŸŸçŠ¶æ€å˜æ›´è§¦å‘è®¿å®¢åŒºåŸŸæ›´æ–°
DELIMITER $$
CREATE TRIGGER tr_area_status_update
AFTER UPDATE ON t_area
FOR EACH ROW
BEGIN
  IF NEW.status != OLD.status THEN
    UPDATE t_visitor_area
    SET enabled = NEW.status,
        update_time = NOW()
    WHERE area_id = NEW.area_id AND deleted_flag = 0;
  END IF;
END$$
DELIMITER ;
```

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2025-12-08
**è®¾è®¡ç‰ˆæœ¬**: v1.0
**å…¼å®¹æ€§**: MySQL 8.0+
**å­—ç¬¦é›†**: utf8mb4
**å­˜å‚¨å¼•æ“**: InnoDB