# Access / Attendance / Consume Gap Analysis

## 1. Spec Baselines

### 1.1 Smart Access（门禁）

- **核心参考文档**
  - `docs/各业务模块文档/门禁/README.md`：七大核心模块（设备管理、区域空间管理、实时监控、事件记录查询、审批流程管理、系统配置、高级功能）与全链路流程图。
  - `docs/各业务模块文档/门禁/11-关键控制点和性能指标.md`：设备/区域/监控/审批/系统配置/高级功能的关键控制点与SLA、容量、实时性、应急要求。
  - `docs/COMMON_MODULES/smart-access.md`：smart-access公共模块的数据库表、指令队列、生物识别扩展表、权限模型等。
  - `docs/CHECKLISTS/门禁系统开发检查清单.md`：后端/前端/数据库/安全/性能/测试/部署的执行清单。
  - `docs/repowiki/zh/content/核心功能模块/企业OA系统/门禁管理系统/*.md`：系统架构、模块设计、交互流程的规范化描述。
- **功能范围**
  - 设备生命周期：注册、配置、分组、固件升级、状态监控、健康度检测、远程控制（`系统整体架构设计.md`、`smart-access.md`）。
  - 区域空间：多级区域树、权限继承、容量监控、冲突检测、设备/人员/区域绑定与同步（`03-区域空间管理模块流程图.md`、`11-关键控制点和性能指标.md`）。
  - 实时监控：7×24实时状态、告警分级、视频联动、人员轨迹、WebSocket 推送、指标延迟≤5s（`04-实时监控模块流程图.md`、`11-关键控制点和性能指标.md`）。
  - 事件查询：通行/异常/报警事件多维查询、统计报表、媒体预览、导出、完整性校验（`05-事件记录查询模块流程图.md`）。
  - 审批与访客：临时/跨区域/紧急权限申请、访客预约、warm-flow审批节点、超时升级（`06-审批流程管理模块流程图.md`、`11-关键控制点和性能指标.md`）。
  - 系统配置：参数校验、最小权限、许可证合规、备份恢复、操作审计（`07-系统配置模块流程图.md`）。
  - 高级功能：反潜、全局联动、互锁、疏散、人数控制，要求规则冲突检测与执行可靠性（`08-高级功能模块流程图.md`、`11-关键控制点和性能指标.md`）。
- **数据/接口要求**
  - smart-access数据库需落地设备、权限、通行记录、指令、设备状态、区域权限组、生物识别模板/记录、认证策略等表结构（`docs/COMMON_MODULES/smart-access.md`）。
  - 所有实体继承 `BaseEntity`，保留完整审计字段；门禁事件与视频、考勤、消费系统需共享关键字段，满足 `docs/repowiki/zh/content/核心功能模块/企业OA系统/门禁管理系统/系统交互流程图.md` 描述的跨模块数据流。
  - 事件/实时模块需支持MQ或WebSocket推送机制以及API权限编码（`access:*`），接口必须在Controller层使用 `@SaCheckLogin` + `@SaCheckPermission`，并统一返回 `ResponseDTO`（`门禁系统开发检查清单.md`）。
- **性能与安全基线**
  - SLA：登录<2s、设备控制<1s、报警响应<30s、实时事件处理≥10k条/秒、可用性≥99.9%（`11-关键控制点和性能指标.md`）。
  - 安全：双重权限校验、设备通信加密、数据加密与审计、最小权限与许可证限制、异常与安全事件自动告警（`11-关键控制点和性能指标.md`、`门禁系统开发检查清单.md`）。
  - 架构：后端四层、前端Vue3+TS+Pinia+Composition API、API统一封装、WS连接管理、测试覆盖率≥80%、部署前需通过六层验证脚本（CLAUDE.md、`门禁系统开发检查清单.md`）。

### 1.2 Attendance（考勤）

- **核心参考文档**
  - `docs/各业务模块文档/考勤/*.md`：原始记录与计算、考勤规则配置、排班管理、班次时间段、异常管理、考勤区域管理、汇总报表等全链路流程。
  - `docs/repowiki/zh/content/核心功能模块/企业OA系统/考勤管理/*.md`：多模态考勤计算引擎、智能排班、异常管理、规则配置等详细架构。
  - `docs/COMMON_MODULES/`（若有 future smart-attendance）及 `门禁集成方案` 中关于门禁考勤联动、考勤/消费联动条目。
- **功能/数据范围**
  - **数据采集与计算**：`attendance_raw_records`、`attendance_results`、`attendance_warning_records`、`attendance_event_stream`、MQ/实时推送、AI 异常检测、考勤重新计算接口（`原始记录及考勤计算.md`、`多模态生物识别考勤计算引擎.md`）。
  - **规则配置**：`attendance_rules`、`attendance_points`（GPS/WiFi/蓝牙考勤点 + 门禁设备关联）、`mobile_configs`、`warning_rules`、`notification_rules`，包含 JSON 可配置字段、地理围栏、防代打卡、预警升级等（`考勤规则配置.md` 及同名 repowiki 文档）。
  - **排班/班次**：`schedule_records/templates/overrides`、`shift_definitions`、`time_periods` 等表，支持模板、临时排班、智能排班算法、冲突检测、API/批量导入（`排班管理.md`、`班次时间段管理.md`）。
  - **异常管理**：基于工作流/Drools/AI 推荐的请假、补签、加班、调班、异常认定流程，集成 warm-flow 审批、短信/邮件/企微通知（`异常管理.md`、repowiki《智能异常管理系统》）。
  - **统计与报表**：按日/周/月/季度/年、个人/部门/岗位/项目维度的统计报表、钻取、导出（`考勤汇总报表.md`、`repowiki/考勤汇总报表`）、与消费补贴、绩效等模块数据联动。
  - **区域/权限联动**：考勤区域 vs 门禁区域绑定、考勤点与门禁设备/消费终端共享、跨模块同步（`考勤区域管理.md`、`门禁集成方案.md`）。
- **技术/非功能要求**
  - Spring Boot 3.5.4 + Java 17、Sa-Token 权限、Activiti（或 warm-flow）工作流、Drools 规则引擎、Redis + MQ + 多模态识别、国密算法保护。
  - SLA：实时计算毫秒级、预警响应 <30s、统计查询 <3s、日活百万级、高可用（repowiki文档列出）。
  - 安全：数据脱敏、审计日志、Geo 防作弊（GPS/WiFi/BLE）、AI 风控、权限最小化。
  - 接口：REST + WebSocket + MQ 事件、对外 `attendance-*` API（规则、考勤点、排班、异常、报表、计算引擎等）以及门禁/消费集成契约。

### 1.3 Consume（消费）

- **核心参考文档**
  - `docs/各业务模块文档/消费/01-15*.md`：区域管理、餐别分类、账户类别与消费模式、区域权限、权限验证、消费处理流程、订餐、充值退款、补贴管理、离线消费、商品管理、报表统计、设备管理、数据准确性与性能设计、缓存架构等。
  - `docs/repowiki/zh/content/核心功能模块/企业OA系统/一卡通消费系统/*.md`：智能消费处理流程、智能权限验证、智能区域权限、智能账户类别与消费模式、餐别分类等高阶规范。
  - `docs/CHECKLISTS/消费系统开发检查清单.md` 及相关项目计划。
- **功能/数据范围**
  - **统一消费引擎**：7 步消费流程（身份识别→权限验证→模式识别→扣费→联动→账务→日志），支持定值/金额/商品/计次/混合/AI 智能模式、考勤消费、联动补贴（`智能消费处理流程管理系统.md`）。
  - **区域/餐别/账户/权限体系**：区域层级 + 消费模式 + 限额 + 设备绑定 + 餐别窗口 + 权限验证矩阵 + 自动继承（`智能区域权限管理系统.md`、`智能餐别分类管理系统.md`、`智能账户类别与消费模式管理系统.md`）。
  - **消费周边流程**：订餐、充值、退款、补单、冲正、补贴、优惠、积分、离线容灾、设备监控（`06-消费处理流程重构设计.md`、`08-充值退款流程重构设计.md`、`10-补贴管理模块重构设计.md`、`11-离线消费模块重构设计.md`、`14-设备管理模块重构设计.md`）。
  - **商品/库存/报表**：商品管理、库存同步、商品消费明细、餐别/区域/账户/人员/考勤等多维报表与 KPI（`12-商品管理模块重构设计.md`、`13-报表统计模块重构设计.md`、`15-消费流水数据准确性与性能设计.md`）。
  - **性能与一致性**：交易按月分表、Redis 多级缓存、幂等/重试/补偿、TPS>3000、低延迟、审计日志、Prometheus 监控、熔断/降级（`15-消费流水数据准确性与性能设计.md`、repowiki 性能章节）。
  - **跨模块联动**：考勤补贴、门禁考勤消费、审批工作流、智能视频联动告警、多系统（HR/财务/食材）集成（各文档 + `门禁集成方案.md`）。
- **技术非功能**
  - Spring Boot 3.5.4 + Java 17 + MyBatis-Plus + Redis + RocketMQ/Canal 等，国密加密，Sa-Token 权限、SecurityAudit 注解、限流、灰度、分表分区。
  - API 契约覆盖 REST + WebSocket + RPC（终端接入）、批处理任务、实时监控与告警。
  - 质量：消费流水一致性校验、对账、异常回溯、压测、缓存一致性、离线容灾。

## 2. Implementation Findings

### 2.1 Smart Access（门禁）

#### 当前实现概览（门禁）

- **后端仅有 `SmartAccessControlController` / `SmartAccessControlServiceImpl`**，暴露的接口只有通行校验、卡/人脸/指纹/密码验证、远程开门、手工记录通行、生成/校验临时令牌以及简单统计；未发现设备管理、区域管理、事件查询、审批流程、系统配置、联动控制等任何 Controller/Service/DAO（与 `docs/各业务模块文档/门禁/01-10*.md` 以及 `docs/repowiki/核心功能模块/企业OA系统/门禁管理系统/*.md` 要求严重不符）。
- **数据层缺口**：仅建模 `smart_access_permission` 与 `smart_access_record` 实体；`docs/COMMON_MODULES/smart-access.md` 强制的 `smart_access_device/device_status/command/alarm/area_group/...`、生物识别模板/记录、认证策略表等全部缺失，也未见 Mapper/SQL。
- **业务逻辑残缺**：
  - `recordAccessEvent` 仅将记录放入 Redis Hash，DAO 调用被注释掉，导致数据库无通行日志，难以满足 `05-事件记录查询模块流程图.md`、「数据完整性/报表/审计」要求。
  - `remoteOpenDoor` 没有设备访问、无权限校验、无事件落库/联动，不满足 `11-关键控制点和性能指标.md` 的「双重权限、操作审计、执行可靠性」。
  - `checkTimePermission` 标注 TODO，仅校验星期，不解析 `timePeriods` JSON，无法支撑 `门禁规则`、`高级功能` 时间窗控制。
  - `isForcedOpen` 恒 false，缺少事件判断逻辑与视频/报警联动监测。
  - `findPermissionByCredential` 仅支持 CARD/FACE/FINGERPRINT，未覆盖二维码、掌纹、虹膜、临时令牌等多模态认证（`smart-access.md`、`门禁高级功能`）。
  - `SmartAccessPermissionDao` 无 mapper XML，也未实现区域/设备组/审批状态等复杂查询；`incrementAccessCount` 缺少 SQL。
- **安全与规范问题**：
  - Controller 未添加 `@SaCheckLogin`、`@SaCheckPermission` 或访问频控，违背 `CLAUDE.md` 与 `门禁系统开发检查清单`。
  - 缺少 `@Validated` Form/DTO 分层，直接暴露 `@RequestParam` 基元，未复用统一表单对象。
  - Service 中大量业务逻辑耦合在一个类，缺乏 Manager、组件解耦，不符四层架构。
  - 未落地任何事件驱动/消息机制，无法满足实时监控、统计、联动 SLA。
- **前端/后端严重脱节**：
  - 前端 `smart-admin-web-javascript/src/views/business/access/**` 已包含「设备、权限、实时监控、配置、统计」等页面，并依赖 `accessDeviceApi`、`accessMonitorApi` 等 ~20 个 REST/WS 接口（`/access/device/...`, `/access/monitor/...`, `/ws/access/monitor`）；后端完全无对应 Controller/路由，全部请求将 404。
  - Pinia Store（`useAccessDeviceStore`、`useAccessMonitorStore`）默认需要 WebSocket 推送、批量查询、批量操作、告警处理等能力，而服务端无实现；也未实现任何 `monitor`、`alert`、`stats` 数据结构。

#### 规范对齐差距总结（需落地的开发任务示例）

  1. **按模块补齐后端接口**：设备管理（CRUD、分组、状态同步、远程控制、批量操作）、区域空间管理（区域树、权限继承、容量监控）、实时监控/告警（WS、心跳、推送、统计）、事件查询（分页/多维检索/导出）、审批流程（与 warm-flow 集成）、系统配置/高级功能（反潜/联动/互锁/紧急）、API 权限控制等。
  2. **重构数据模型**：依据 `smart-access.md` 建表 + MyBatis Mapper，实现设备、指令、状态、区域、权限组、生物识别、报警、日志等实体，并补齐迁移脚本/初始化数据。
  3. **完善核心业务逻辑**：权限校验、时间段解析、访问次数/并发控制、异常检测、远程开门硬件适配、事件落库 + MQ 推送、统计聚合、SLA 指标监控。
  4. **补齐安全/规范**：Controller 加 `@SaCheckLogin/@SaCheckPermission`，使用 DTO + `@Validated`，实现审计日志、限流、操作确认、异常处理与返回码统一。
  5. **实现 WebSocket / 实时通道**：为监控与前端实时列表提供 `/ws/access/monitor`（握手、订阅、心跳、推送），并与设备状态/事件处理链路对接。
  6. **同步前端调用契约**：根据前端 `accessDeviceApi`/`accessMonitorApi` 等接口定义补齐 REST，或同步修改前端契约，确保路由、返回结构与权限一致。
  7. **测试 & 质量**：针对权限校验、实时监控、审批流程等关键路径补充单元/集成/UI/性能测试，满足 `门禁系统开发检查清单` 中 ≥80% 覆盖与六层验证。

#### 门禁整改建议（优先级）

| 优先级 | 缺口 / 待办 | 关联规范/文档 | 风险影响 |
| --- | --- | --- | --- |
| P0 | 建立设备/区域/监控/审批等后端 API（Controller + Service + Manager + Dao）并与前端契约一致 | `门禁01-07流程图`、`smart-access.md`、`门禁系统开发检查清单` | 没有这些接口，前端所有功能 404，无法上线 |
| P0 | 落地 `smart_access_*` 完整数据模型（设备、状态、指令、报警、生物识别等）及 SQL/Mapper | `smart-access.md`、`11-关键控制点与性能指标` | 数据无法持久化，事件/统计/审计全失效 |
| P0 | 实现实时监控/告警链路：MQ/WS、心跳、告警处理、事件落库 | `04-实时监控模块流程图`、`门禁系统架构` | 无法满足 7×24 监控、报警响应 ≤30s 的 SLA |
| P1 | 完善访问校验逻辑：时间段解析、权限冲突、访问次数、强制开门检测 | `03-区域空间管理`、`05-事件记录查询`、`高级功能` | 存在错误放行/误判风险，安全审计缺失 |
| P1 | 补齐安全控制：`@SaCheckLogin/@SaCheckPermission`、操作日志、限流、双因子开门 | `CLAUDE.md`、`门禁系统开发检查清单` | 接口可被未授权访问，违反安全规范 |
| P1 | 与审批/访客/考勤等模块集成（warm-flow + 跨模块数据同步） | `06-审批流程管理`、`系统交互流程图` | 权限审批与考勤关联缺失，影响业务闭环 |
| P2 | 提供完整的报表、导出、统计、缓存加速与多语言配置 | `05-事件记录查询`、前端 `access/record` 需求 | 用户无法获得合规报表，性能不达标 |
| P2 | 构建自动化测试矩阵与质量脚本（单测、接口测试、E2E、性能、六层验证） | `CLAUDE.md` 六层验证、`门禁系统开发检查清单` | 无测试保障，难以通过强制验证流程 |

### 2.2 Attendance（考勤）

#### 当前实现概览（考勤）

- **后端完全缺失考勤模块**：`smart-admin-api-java17-springboot3/sa-admin/src/main/java` 下不存在 `attendance` 目录，`grep "attendance"` 无任何 Java 定义，也没有 `attendance` 表的 MyBatis Mapper、Service、Controller。数据库迁移脚本亦未创建 `attendance_*` 系列表，与 `docs/各业务模块文档/考勤/*.md` 与 `repowiki/企业OA系统/考勤管理` 中的庞大数据结构完全脱节。
- **前端/API 早已约定大量考勤接口**：
  - `smart-admin-web-javascript/src/api/business/smart-video/attendance-api.js` 定义了 30+ REST 接口 (`/attendance/shift/**`, `/attendance/exception/**`, `/attendance/approval/**`, `/attendance/statistics/**` 等)。
  - `views/smart-permission/components/AttendancePermissionConfig.vue`、`TemporaryPermissionApplication.vue`、`PermissionAuditLog.vue` 等页面依赖考勤权限配置、审批、导出、报表、异常处理等功能。
  - 权限指令、路由、Store（`directives/permission.js`、`api/smart-permission.js`）均包含 `attendance` 相关编码，前端 UI 已露出入口。
- **结果**：所有考勤相关前端操作均会访问不存在的后端路由（统一 404），且缺乏任何数据模型/业务实现，无法满足排班、打卡、异常处理、统计、审批、通知等规范。

#### 差距与影响（考勤）

- **基础数据模型缺失**：`attendance_raw_records/results/warnings`, `attendance_rules/points/mobile_configs`, `schedule_*`, `shift_*`, `attendance_area`, `exception/approval` 等表/实体/DAO 均未实现，导致无法落地打卡采集、规则配置、排班、异常审批等核心能力。
- **实时计算/预警引擎缺位**：没有考勤计算服务、事件处理器、MQ consumer 或定时任务，`多模态生物识别考勤计算引擎`、`智能排班管理系统`、`智能异常管理系统` 的所有 API（如 `triggerRecalculate`、`getRealtimeStatus`、`/attendance/exception/*`）都不存在。
- **规则/审批/集成链路中断**：`AttendancePermissionConfig`、`AttendanceApproval`、`warm-flow` 集成、门禁/消费联动（考勤补贴、考勤消费）完全没有后端支撑，违反 `门禁考勤一体化` 要求。
- **技术规范无法执行**：缺少模块意味着无法应用 Sa-Token 权限、Activiti/Drools、国密加密、Geo 防作弊、六层验证脚本等考勤专属规范。

> 结论：考勤模块需自底向上（数据库 → DAO → Manager → Service → Controller → API → WS → 任务引擎）重建，才可能满足项目规范和现有前端契约。

#### 考勤整改建议（优先级）

| 优先级 | 缺口 / 待办 | 关联规范/文档 | 风险影响 |
| --- | --- | --- | --- |
| P0 | 初始化考勤数据库（原始记录、计算结果、规则、排班、异常、汇总等表）+ MyBatis 层 | `原始记录及考勤计算.md`、`考勤规则配置.md`、`排班管理.md`、repowiki《多模态生物识别考勤计算引擎》 | 没有数据承载，无法存储打卡/规则/排班/统计 |
| P0 | 构建考勤核心服务：打卡采集、实时计算、规则引擎、排班引擎、异常审批、汇总报表及 REST API | 同上 + `repowiki/智能异常管理系统`、`考勤汇总报表.md` | 所有前端/集成接口 404，考勤功能完全不可用 |
| P0 | 搭建审批/工作流链路，与 warm-flow/Activiti 集成异常申请、补卡、加班等流程 | `异常管理.md`、`repowiki/智能异常管理系统` | 无法处理任何考勤异常，影响人事流程 |
| P1 | 实现规则/考勤点/移动端/GPS 防作弊配置、地理围栏校验、移动 SDK 接口 | `考勤规则配置.md`、`repowiki/考勤规则配置` | 移动考勤、预警机制无法落地，存在代打卡风险 |
| P1 | 构建排班模板/智能排班/临时排班、班次时间段管理、冲突检测、批量操作 | `排班管理.md`、`班次时间段管理.md`、`repowiki/智能排班管理系统` | 排班相关页面、统计、规则全部无数据 |
| P1 | 联动门禁/消费：门禁打卡入库、消费补贴依据考勤、统计共享 | `门禁集成方案.md`、消费系统文档 | 门禁考勤一体化、补贴、绩效均无法实现 |
| P2 | 报表、导出、BI、通知/预警渠道、AI 异常分析、性能/压测脚本 | `考勤汇总报表.md`、`repowiki/多模态引擎` | 无法满足管理决策、合规审计与 SLA |

### 2.3 Consume（消费）

#### 当前实现概览（消费）

- **后端无消费模块代码**：`smart-admin-api-java17-springboot3` 中没有 `consume/consumption` 目录、Controller、Service 或 Dao。数据库脚本、Mapper、任务、缓存、MQ 亦均未实现，无法支撑任何消费交易。
- **前端已挂载完整消费模块**：
  - `router/business/consumption.js`、`constants/business/consumption/consumption-const.js`、`views/business/consumption/**`、`api/business/consumption/consumption-api.js` 提供仪表盘、区域、账户类别、餐别、参数、设备、商品、补贴、报表等页面与 REST 契约。
  - SQL 菜单脚本 `views/business/consumption/消费管理菜单配置.sql` 已向后台菜单注入 `/consumption/**` 接口权限，前端按钮、指令、枚举（`quick action menu` 等）默认会调后端。
- **结果**：消费模块所有 UI 入口加载后均触发不存在的后端 API，且缺少任何消费账户、区域、模式、补贴、报表、设备等数据结构。

#### 差距与影响（消费）

- **核心交易链路缺失**：统一消费流程、权限验证、模式引擎、余额/限额校验、补偿/冲正、批处理、指标监控全部没有实现，无法完成任何消费、订餐、充值退款等操作。
- **数据与缓存体系缺位**：`t_posid_transaction` 分表、明细表、账户余额、区域/餐别/账户类别配置、补贴、商品、库存、报表、Redis Key 设计、RocketMQ 事件等均缺失，与文档所述高并发、高一致性要求完全不符。
- **跨模块联动无法落地**：考勤消费字段 `is_attendance_consume`、门禁联动扣费、补贴与工资对接、审批/财务对账、智能视频联动告警都无落地点。
- **安全与合规风险**：未实现任何 `SecurityAudit`、权限控制、限额、风控、日志审计、国密加密、离线防篡改，违反 `消费系统开发检查清单`。

#### 消费整改建议（优先级）

| 优先级 | 缺口 / 待办 | 关联规范/文档 | 风险影响 |
| --- | --- | --- | --- |
| P0 | 建立消费领域数据库（区域、餐别、账户类别、权限、交易主/明细、补贴、充值、退款、商品、设备、指标）+ MyBatis Mapper | `消费01-15*.md`、repowiki《智能消费处理流程等》 | 无数据承载与配置，所有交易/配置均不可用 |
| P0 | 实现消费核心引擎（统一流程、权限矩阵、模式识别、扣费、补偿、日志、MQ事件、监控）及 REST API | `智能消费处理流程管理系统.md`、`智能权限验证与流程管理系统.md` | UI 与终端全部 404/失败，消费场景为零 |
| P0 | 落地账户/区域/餐别/补贴/商品/设备等管理模块，保证与前端、菜单脚本契约一致 | `01-区域管理`、`02-餐别分类`、`03-账户类别`、`04-区域权限`、`05-权限验证`、`10-补贴管理`、`14-设备管理` | 配置界面、策略、权限均无数据，无法运营 |
| P1 | 构建订餐、充值退款、报表统计、离线消费、防串场、审批对账等周边流程 | `06`~`13` 章节、repowiki 性能&准确性文档 | 财务对账、离线容灾、合规审计均不可行 |
| P1 | 性能 & 一致性体系：分表、缓存、幂等、熔断、Prometheus 指标、自动化压测脚本 | `15-消费流水数据准确性与性能设计.md` | 无法满足 TPS/一致性要求，风险高 |
| P2 | 与考勤/门禁/智能视频/AI 分析联动（考勤补贴、消费风控、设备告警），提供开放 API | `门禁集成方案`、`消费系统跨模块说明` | 无法实现“一卡通”融合体验 |

## 3. Cross-Module Insights

### 3.1 考勤 × 消费联动缺口

1. **考勤消费标记未落地**：`repowiki/智能消费处理流程管理系统.md`、`智能账户类别与消费模式管理系统.md` 要求 `is_attendance_consume`、`attendance_consume_stats` 字段用于「打卡即消费」与补贴结算，但目前既无消费交易表也无考勤集成，无法依据考勤结果触发消费/补贴。
2. **考勤补贴/餐补依赖消费账户**：`消费/10-补贴管理模块重构设计.md` 规定补贴发放依据考勤出勤率与班次，缺乏考勤结果/统计接口，无法计算补贴金额与有效期。
3. **门禁打卡 → 考勤 → 消费流程断裂**：门禁控制器没有向考勤/消费写入事件，考勤模块缺席导致 `门禁考勤一体化` 与「门禁验证即扣费/打卡」场景失效。
4. **权限与区域一致性**：考勤区域、门禁区域、消费区域需要统一的区域树/权限模型（`考勤区域管理.md`、`消费01-区域管理`），目前三个模块互不兼容，无法实现同一张卡跨模块权限联动。
5. **统一指标/报表**：`attendance_consume_stats`、`考勤消费统计` 指标要求以考勤数据驱动消费分析（迟到扣补贴、按考勤计算餐补发放），但缺乏统一数据仓与对账流程。

### 3.2 联动改造建议

| 优先级 | 联动项 | 需求摘要 | 建议动作 |
| --- | --- | --- | --- |
| P0 | 门禁打卡 → 考勤原始记录 → 消费补贴 | 门禁通过校验后推送考勤事件，考勤引擎实时计算并通知消费系统更新补贴/考勤消费 | 建立统一事件总线：门禁写 `attendance_raw_records`，考勤触发 `attendance_consume` 事件供消费引擎监听 |
| P0 | 统一区域/权限模型 | 门禁、考勤、消费的区域/餐别/权限需同源配置，减少冲突 | 抽象 `smart_area`、`smart_permission` 公共域，提供 API/同步脚本 |
| P1 | 考勤结果驱动补贴/限额 | 考勤异常需冻结补贴、考勤达标发放补贴/解除限额 | 在消费账户模型中增加考勤状态钩子，定时任务同步统计结果 |
| P1 | 统一报表与对账 | 管理层需要考勤 × 消费关联报表（迟到扣费用、部门出勤 VS 餐补发放） | 建立 BI/ETL 任务，输出多维数据集；对接 `考勤汇总报表` 与消费流水 |
| P2 | 安全/风控联动 | 考勤与消费异常共享 AI 风控模型（代打卡、异常消费） | 共享 AI 风控特征，联动预警/通知，统一审计 |

## 4. Roadmap & Next Steps

| 阶段 | 时间/顺序 | 模块 | 关键交付 | 依赖 |
| --- | --- | --- | --- | --- |
| Stage-0 | 立即 | **公共工作** | 统一区域/权限/事件规范；补充数据库建表与脚本；完善 Sa-Token/`@Validated`/DTO 规范；启用六层验证脚本与 Serena/Mentor 质量守卫 | 影响所有模块 |
| Stage-1 | 门禁 MVP | 门禁 | ① 设备/区域/事件/审批接口 ② 数据模型 + Mapper ③ 实时监控 & WebSocket ④ 权限/安全/审计补齐 ⑤ 单元+集成测试 | 依赖 Stage-0 |
| Stage-2 | 考勤 MVP | 考勤 | ① 原始记录、规则、排班、异常、报表全链路 ② 实时计算 & 预警引擎 ③ 门禁事件写入 ④ 前端契约落地 ⑤ 工作流集成 + 测试体系 | Stage-0、Stage-1（提供考勤事件） |
| Stage-3 | 消费 MVP | 消费 | ① 消费引擎 & 权限矩阵 & 模式引擎 ② 区域/餐别/账户/补贴/商品模块 ③ 交易表/缓存/监控/对账 ④ 与考勤补贴联动 ⑤ 压测与可靠性验证 | Stage-0、Stage-2（考勤数据） |
| Stage-4 | 联动优化 | 门禁+考勤+消费 | ① 事件总线与补贴分发 ② AI 风控联动 ③ 统一报表/BI/对账 ④ 高可用/容灾 ⑤ 全链路监控与运维脚本 | 前三阶段完成 |

### 执行要点

1. **先 Proposal 再编码**：每阶段需根据 `@/openspec/AGENTS.md` 产出变更提案，明确范围、接口、数据库、测试计划。
2. **数据库优先**：先补齐数据模型与迁移脚本，再创建 DAO/Service/Controller；禁止直接在 Controller 中拼业务逻辑。
3. **契约同步**：任何 REST/WS改动必须同步 `smart-admin-web-javascript` API、路由、菜单 SQL 与权限枚举，保持前后端一致。
4. **质量栈**：强制执行 CLAUDE.md 六层验证 + repowiki 检查清单 + Serena/Mentor（代码审查、文档检查、测试覆盖率、性能分析），关键路径覆盖率 ≥80%，需附日志/报告。
5. **可观测性与审计**：门禁/考勤/消费模块上线前必须具备结构化日志、Prometheus 指标、链路追踪、SecurityAudit、操作留痕，确保生产定位问题。
