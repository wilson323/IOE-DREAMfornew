# 视频回放模块 - 数据结构设计

## ER图

```
┌─────────────────┐       ┌─────────────────┐
│   ivs_device    │       │   ivs_record    │
├─────────────────┤       ├─────────────────┤
│ PK device_id    │──────<│ FK device_id    │
│    device_name  │       │ PK record_id    │
│    device_type  │       │    channel_id   │
└─────────────────┘       │    start_time   │
                          │    end_time     │
                          │    duration     │
                          │    file_path    │
                          │    file_size    │
                          │    record_type  │
                          │    storage_type │
                          └─────────────────┘
                                  │
        ┌─────────────────────────┴─────────────────────────┐
        ▼                                                   ▼
┌─────────────────┐                               ┌─────────────────┐
│ivs_record_index │                               │ivs_download_task│
├─────────────────┤                               ├─────────────────┤
│ PK index_id     │                               │ PK task_id      │
│ FK record_id    │                               │ FK record_id    │
│    time_slot    │                               │ FK user_id      │
│    has_video    │                               │    start_time   │
│    has_event    │                               │    end_time     │
│    thumbnail    │                               │    status       │
└─────────────────┘                               │    progress     │
                                                  │    file_path    │
                                                  └─────────────────┘
```

## 核心表结构

### ivs_record (录像主表)

```sql
CREATE TABLE ivs_record (
    record_id BIGSERIAL PRIMARY KEY COMMENT '录像ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id INT DEFAULT 1 COMMENT '通道号',
    start_time TIMESTAMP NOT NULL COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    duration INT COMMENT '时长(秒)',
    file_path VARCHAR(500) COMMENT '文件路径',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_format VARCHAR(10) DEFAULT 'mp4' COMMENT '文件格式',
    resolution VARCHAR(20) COMMENT '分辨率',
    bitrate INT COMMENT '码率(kbps)',
    fps INT DEFAULT 25 COMMENT '帧率',
    record_type TINYINT DEFAULT 0 COMMENT '录像类型:0定时1手动2告警3移动检测',
    storage_type TINYINT DEFAULT 0 COMMENT '存储类型:0设备端1服务端2云存储',
    storage_tier TINYINT DEFAULT 0 COMMENT '存储层级:0热1温2冷',
    has_audio BOOLEAN DEFAULT FALSE COMMENT '是否有音频',
    locked BOOLEAN DEFAULT FALSE COMMENT '是否锁定(防覆盖)',
    deleted_flag TINYINT DEFAULT 0 COMMENT '删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_time (device_id, start_time),
    INDEX idx_start_time (start_time),
    INDEX idx_record_type (record_type)
) COMMENT='录像主表'
PARTITION BY RANGE (start_time);

-- 按月分区示例
CREATE TABLE ivs_record_202401 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE ivs_record_202402 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

### ivs_record_index (录像时间索引)

```sql
CREATE TABLE ivs_record_index (
    index_id BIGSERIAL PRIMARY KEY COMMENT '索引ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    record_date DATE NOT NULL COMMENT '录像日期',
    time_slot INT NOT NULL COMMENT '时间段(0-287,每5分钟一个)',
    has_video BOOLEAN DEFAULT FALSE COMMENT '是否有录像',
    has_event BOOLEAN DEFAULT FALSE COMMENT '是否有事件',
    event_count INT DEFAULT 0 COMMENT '事件数量',
    thumbnail VARCHAR(500) COMMENT '缩略图路径',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE INDEX uk_device_date_slot (device_id, record_date, time_slot),
    INDEX idx_device_date (device_id, record_date)
) COMMENT='录像时间索引表';
```

### ivs_download_task (下载任务表)

```sql
CREATE TABLE ivs_download_task (
    task_id BIGSERIAL PRIMARY KEY COMMENT '任务ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    record_id BIGINT COMMENT '录像ID(时间段下载为空)',
    start_time TIMESTAMP NOT NULL COMMENT '开始时间',
    end_time TIMESTAMP NOT NULL COMMENT '结束时间',
    expected_size BIGINT COMMENT '预计大小(字节)',
    actual_size BIGINT COMMENT '实际大小(字节)',
    file_path VARCHAR(500) COMMENT '下载文件路径',
    status TINYINT DEFAULT 0 COMMENT '状态:0等待1下载中2完成3失败4取消',
    progress INT DEFAULT 0 COMMENT '进度(0-100)',
    error_msg VARCHAR(500) COMMENT '错误信息',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    complete_time TIMESTAMP COMMENT '完成时间',
    
    INDEX idx_user_status (user_id, status),
    INDEX idx_create_time (create_time)
) COMMENT='录像下载任务表';
```

### ivs_record_archive (归档录像表)

```sql
CREATE TABLE ivs_record_archive (
    archive_id BIGSERIAL PRIMARY KEY COMMENT '归档ID',
    original_record_id BIGINT COMMENT '原录像ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    start_time TIMESTAMP NOT NULL COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    duration INT COMMENT '时长(秒)',
    file_path VARCHAR(500) COMMENT '归档路径',
    file_size BIGINT COMMENT '文件大小',
    storage_bucket VARCHAR(100) COMMENT '存储桶',
    archive_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '归档时间',
    expire_time TIMESTAMP COMMENT '过期时间',
    
    INDEX idx_device_time (device_id, start_time)
) COMMENT='归档录像表';
```

## 缓存设计

| Key模式 | 数据类型 | 过期时间 | 说明 |
|---------|----------|----------|------|
| `record:index:{deviceId}:{date}` | String | 1天 | 日录像时间索引 |
| `record:list:{deviceId}:{date}` | List | 30分钟 | 日录像列表 |
| `download:task:{taskId}` | Hash | 任务完成后 | 下载任务状态 |
| `playback:session:{sessionId}` | Hash | 30分钟 | 回放会话信息 |
