# 视频管理模块 - 模块间关联设计文档

> **版本**: v1.0.0  
> **微服务**: ioedream-video-service (8092)  
> **创建日期**: 2025-12-17

---

## 📊 模块关联全景图

```mermaid
graph TB
    subgraph 视频微服务内部模块
        LIVE[01-实时监控]
        DEVICE[02-设备管理]
        PLAYBACK[03-视频回放]
        AI[04-行为分析]
        ALARM[05-告警管理]
        WALL[06-解码上墙]
        MSG[07-消息中心]
        MAP[08-地图展示]
    end
    
    subgraph 外部微服务
        GW[Gateway:8080]
        CMN[Common:8088]
        DC[DeviceComm:8087]
        ACC[Access:8090]
        VIS[Visitor:8095]
    end
    
    %% 内部关联
    DEVICE --> LIVE
    DEVICE --> PLAYBACK
    LIVE --> AI
    LIVE --> ALARM
    LIVE --> WALL
    AI --> ALARM
    ALARM --> MSG
    DEVICE --> MAP
    
    %% 外部关联
    DEVICE <--> DC
    LIVE <--> ACC
    AI <--> ACC
    ALARM --> CMN
    LIVE <--> VIS
```

---

## 🔗 内部模块关联详细设计

### 1. 设备管理 ↔ 实时监控

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 设备列表 | 监控时获取可用设备 | DEVICE → LIVE |
| 流地址 | 获取视频流地址 | DEVICE → LIVE |
| 状态同步 | 设备在线状态同步 | DEVICE → LIVE |

**关键接口**:
```java
// CameraDeviceService.java
List<CameraVO> getOnlineCameras(Long areaId);
StreamUrlVO getStreamUrl(Long cameraId, String streamType);

// LiveMonitorService.java
void startMonitor(Long cameraId, String clientId);
```

### 2. 实时监控 ↔ 行为分析

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 视频流 | AI分析实时视频流 | LIVE → AI |
| 分析结果 | 分析结果叠加显示 | AI → LIVE |
| 告警触发 | 异常行为触发告警 | AI → ALARM |

**关键接口**:
```java
// AIAnalysisService.java
void startAnalysis(Long cameraId, List<String> analysisTypes);
AIAnalysisResultVO getAnalysisResult(Long cameraId);
```

### 3. 告警管理 ↔ 消息中心

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 告警推送 | 告警产生时推送消息 | ALARM → MSG |
| 处理通知 | 告警处理结果通知 | ALARM → MSG |

**关键接口**:
```java
// VideoAlarmService.java
void createAlarm(VideoAlarmDTO alarm);

// VideoMessageService.java
void pushAlarmMessage(AlarmMessageDTO message);
```

### 4. 解码上墙 ↔ 实时监控

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 视频源 | 上墙使用监控视频源 | LIVE → WALL |
| 布局控制 | 电视墙布局管理 | WALL → LIVE |

**关键接口**:
```java
// VideoWallService.java
void setLayout(Long wallId, LayoutDTO layout);
void assignCamera(Long windowId, Long cameraId);
```

---

## 🌐 外部微服务关联设计

### 1. 视频服务 ↔ 设备通讯服务 (8087)

```mermaid
sequenceDiagram
    participant VID as Video
    participant DC as DeviceComm
    participant CAM as 摄像头
    
    VID->>DC: 获取视频流
    DC->>CAM: ONVIF/RTSP请求
    CAM-->>DC: 返回视频流
    DC-->>VID: 转发视频流
    
    VID->>DC: PTZ控制命令
    DC->>CAM: 下发控制指令
    CAM-->>DC: 执行结果
    DC-->>VID: 返回结果
```

**关键API**:
```
GET  /api/device-comm/v1/video/stream/{cameraId}  # 获取视频流
POST /api/device-comm/v1/video/ptz/control        # PTZ控制
POST /api/device-comm/v1/video/capture            # 抓拍
```

### 2. 视频服务 ↔ 门禁服务 (8090)

```mermaid
sequenceDiagram
    participant ACC as Access
    participant VID as Video
    
    ACC->>VID: 请求关联摄像头
    VID-->>ACC: 返回摄像头列表
    
    ACC->>VID: 触发联动录像
    VID->>VID: 开始录像
    VID-->>ACC: 返回录像信息
    
    ACC->>VID: 请求事件回放
    VID-->>ACC: 返回回放地址
```

**关键API**:
```
GET  /api/video/v1/camera/bindDevice/{deviceId}  # 获取关联摄像头
POST /api/video/v1/recording/start               # 启动录像
GET  /api/video/v1/playback/url                  # 获取回放地址
```

### 3. 视频服务 ↔ 访客服务 (8095)

```mermaid
sequenceDiagram
    participant VIS as Visitor
    participant VID as Video
    
    VIS->>VID: 人脸采集请求
    VID->>VID: 调用摄像头采集
    VID-->>VIS: 返回人脸图像
    
    VIS->>VID: 人脸比对请求
    VID->>VID: AI人脸比对
    VID-->>VIS: 返回比对结果
```

**关键API**:
```
POST /api/video/v1/face/capture   # 人脸采集
POST /api/video/v1/face/compare   # 人脸比对
POST /api/video/v1/face/search    # 人脸搜索
```

---

## 📋 数据流转设计

### 视频流数据流

```mermaid
flowchart LR
    A[摄像头] -->|RTSP| B[设备通讯服务]
    B -->|转码| C[流媒体服务]
    C -->|HLS/FLV| D[Web播放器]
    C -->|RTMP| E[电视墙]
    B -->|抓拍| F[视频服务]
    F -->|存储| G[(对象存储)]
```

### 告警数据流

```mermaid
flowchart LR
    A[AI分析] -->|异常检测| B[告警服务]
    B -->|生成告警| C[(MySQL)]
    B -->|推送| D[消息中心]
    D -->|WebSocket| E[前端]
    D -->|短信/邮件| F[用户]
```

---

## 🔧 接口契约规范

| 调用方 | 被调用方 | 接口 | 超时 | 重试 |
|--------|----------|------|------|------|
| VID | DC | getStream | 5s | 2次 |
| ACC | VID | bindCamera | 2s | 2次 |
| VIS | VID | captureFace | 10s | 1次 |
| VID | CMN | pushMessage | 3s | 3次 |

---

## ⚠️ 关键注意事项

1. **视频流延迟**: 实时监控延迟控制在3秒以内
2. **存储管理**: 录像文件按保留策略自动清理
3. **并发控制**: 单摄像头最大支持20路并发观看
4. **AI资源**: AI分析需要GPU资源，合理调度
5. **带宽优化**: 支持多码流切换，自适应带宽

---

**📝 文档维护**: IOE-DREAM架构团队 | 2025-12-17
