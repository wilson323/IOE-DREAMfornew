# 解码上墙模块 - 数据结构设计

## ER图

```
┌─────────────────┐       ┌─────────────────┐
│  ivs_decoder    │       │ivs_display_wall │
├─────────────────┤       ├─────────────────┤
│ PK decoder_id   │       │ PK wall_id      │
│    decoder_name │       │    wall_name    │
│    decoder_sn   │       │    rows         │
│    ip_address   │       │    cols         │
│    channel_count│       │    resolution   │
│    status       │       │    status       │
└─────────────────┘       └─────────────────┘
        │                         │
        │                         │
        ▼                         ▼
┌─────────────────┐       ┌─────────────────┐
│ivs_decoder_channel│     │ivs_wall_window  │
├─────────────────┤       ├─────────────────┤
│ PK channel_id   │       │ PK window_id    │
│ FK decoder_id   │       │ FK wall_id      │
│    channel_no   │       │    window_no    │
│    output_type  │       │    x_pos        │
│    resolution   │       │    y_pos        │
│    status       │       │    width        │
└─────────────────┘       │    height       │
        │                 └─────────────────┘
        │                         │
        └───────────┬─────────────┘
                    ▼
            ┌─────────────────┐
            │ivs_display_task │
            ├─────────────────┤
            │ PK task_id      │
            │ FK wall_id      │
            │ FK window_id    │
            │ FK device_id    │
            │ FK decoder_id   │
            │    channel_no   │
            │    status       │
            │    start_time   │
            └─────────────────┘
```

## 核心表结构

### ivs_decoder (解码器表)

```sql
CREATE TABLE ivs_decoder (
    decoder_id BIGSERIAL PRIMARY KEY COMMENT '解码器ID',
    decoder_name VARCHAR(100) NOT NULL COMMENT '解码器名称',
    decoder_sn VARCHAR(64) UNIQUE COMMENT '设备序列号',
    manufacturer VARCHAR(50) COMMENT '厂商',
    model VARCHAR(50) COMMENT '型号',
    ip_address VARCHAR(50) NOT NULL COMMENT 'IP地址',
    port INT DEFAULT 8000 COMMENT '端口',
    username VARCHAR(50) COMMENT '用户名',
    password_enc VARCHAR(256) COMMENT '加密密码',
    channel_count INT DEFAULT 4 COMMENT '解码通道数',
    max_resolution VARCHAR(20) DEFAULT '4K' COMMENT '最大分辨率',
    protocol VARCHAR(20) DEFAULT 'GB28181' COMMENT '协议类型',
    status TINYINT DEFAULT 0 COMMENT '状态:0离线1在线2故障',
    last_online_time TIMESTAMP COMMENT '最后在线时间',
    region_id BIGINT COMMENT '所属区域',
    description VARCHAR(500) COMMENT '描述',
    deleted_flag TINYINT DEFAULT 0 COMMENT '删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_status (status),
    INDEX idx_region (region_id)
) COMMENT='解码器表';
```

### ivs_decoder_channel (解码通道表)

```sql
CREATE TABLE ivs_decoder_channel (
    channel_id BIGSERIAL PRIMARY KEY COMMENT '通道ID',
    decoder_id BIGINT NOT NULL COMMENT '解码器ID',
    channel_no INT NOT NULL COMMENT '通道号(从1开始)',
    channel_name VARCHAR(100) COMMENT '通道名称',
    output_type VARCHAR(20) DEFAULT 'HDMI' COMMENT '输出类型(HDMI/VGA/DVI)',
    output_port INT COMMENT '输出端口号',
    resolution VARCHAR(20) DEFAULT '1080P' COMMENT '输出分辨率',
    status TINYINT DEFAULT 0 COMMENT '状态:0空闲1播放中',
    current_device_id BIGINT COMMENT '当前播放设备ID',
    current_stream_url VARCHAR(500) COMMENT '当前流地址',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_channel_decoder 
        FOREIGN KEY (decoder_id) REFERENCES ivs_decoder(decoder_id),
    UNIQUE INDEX uk_decoder_channel (decoder_id, channel_no)
) COMMENT='解码通道表';
```

### ivs_display_wall (电视墙表)

```sql
CREATE TABLE ivs_display_wall (
    wall_id BIGSERIAL PRIMARY KEY COMMENT '电视墙ID',
    wall_name VARCHAR(100) NOT NULL COMMENT '电视墙名称',
    wall_code VARCHAR(50) UNIQUE COMMENT '电视墙编码',
    rows INT NOT NULL COMMENT '行数',
    cols INT NOT NULL COMMENT '列数',
    total_screens INT COMMENT '总屏幕数',
    screen_width INT COMMENT '单屏宽度(像素)',
    screen_height INT COMMENT '单屏高度(像素)',
    total_width INT COMMENT '总宽度(像素)',
    total_height INT COMMENT '总高度(像素)',
    location VARCHAR(200) COMMENT '安装位置',
    region_id BIGINT COMMENT '所属区域',
    status TINYINT DEFAULT 1 COMMENT '状态:0禁用1启用',
    description VARCHAR(500) COMMENT '描述',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_region (region_id)
) COMMENT='电视墙配置表';
```

### ivs_wall_window (电视墙窗口表)

```sql
CREATE TABLE ivs_wall_window (
    window_id BIGSERIAL PRIMARY KEY COMMENT '窗口ID',
    wall_id BIGINT NOT NULL COMMENT '电视墙ID',
    window_no INT NOT NULL COMMENT '窗口编号',
    window_name VARCHAR(100) COMMENT '窗口名称',
    x_pos INT NOT NULL COMMENT 'X坐标(像素)',
    y_pos INT NOT NULL COMMENT 'Y坐标(像素)',
    width INT NOT NULL COMMENT '宽度(像素)',
    height INT NOT NULL COMMENT '高度(像素)',
    z_index INT DEFAULT 0 COMMENT '层级',
    decoder_id BIGINT COMMENT '绑定解码器ID',
    channel_no INT COMMENT '绑定解码通道号',
    status TINYINT DEFAULT 0 COMMENT '状态:0空闲1播放中',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_window_wall 
        FOREIGN KEY (wall_id) REFERENCES ivs_display_wall(wall_id),
    UNIQUE INDEX uk_wall_window (wall_id, window_no)
) COMMENT='电视墙窗口表';
```

### ivs_wall_preset (电视墙预案表)

```sql
CREATE TABLE ivs_wall_preset (
    preset_id BIGSERIAL PRIMARY KEY COMMENT '预案ID',
    wall_id BIGINT NOT NULL COMMENT '电视墙ID',
    preset_name VARCHAR(100) NOT NULL COMMENT '预案名称',
    preset_code VARCHAR(50) COMMENT '预案编码',
    group_id BIGINT COMMENT '分组ID',
    description VARCHAR(500) COMMENT '描述',
    config JSONB NOT NULL COMMENT '预案配置(窗口-设备映射)',
    is_default BOOLEAN DEFAULT FALSE COMMENT '是否默认预案',
    create_by BIGINT COMMENT '创建人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_preset_wall 
        FOREIGN KEY (wall_id) REFERENCES ivs_display_wall(wall_id),
    INDEX idx_wall (wall_id)
) COMMENT='电视墙预案表';
```

### ivs_display_task (上墙任务表)

```sql
CREATE TABLE ivs_display_task (
    task_id BIGSERIAL PRIMARY KEY COMMENT '任务ID',
    wall_id BIGINT NOT NULL COMMENT '电视墙ID',
    window_id BIGINT NOT NULL COMMENT '窗口ID',
    device_id BIGINT NOT NULL COMMENT '视频设备ID',
    decoder_id BIGINT NOT NULL COMMENT '解码器ID',
    channel_no INT NOT NULL COMMENT '解码通道号',
    stream_type VARCHAR(20) DEFAULT 'MAIN' COMMENT '码流类型(MAIN/SUB)',
    task_type TINYINT DEFAULT 0 COMMENT '任务类型:0手动1预案2轮巡3告警联动',
    preset_id BIGINT COMMENT '关联预案ID',
    tour_id BIGINT COMMENT '关联轮巡ID',
    alarm_id BIGINT COMMENT '关联告警ID',
    status TINYINT DEFAULT 0 COMMENT '状态:0等待1执行中2完成3失败',
    error_msg VARCHAR(500) COMMENT '错误信息',
    start_time TIMESTAMP COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    create_by BIGINT COMMENT '操作人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_wall_window (wall_id, window_id),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time)
) COMMENT='上墙任务表';
```

### ivs_wall_tour (电视墙轮巡表)

```sql
CREATE TABLE ivs_wall_tour (
    tour_id BIGSERIAL PRIMARY KEY COMMENT '轮巡ID',
    wall_id BIGINT NOT NULL COMMENT '电视墙ID',
    tour_name VARCHAR(100) NOT NULL COMMENT '轮巡名称',
    window_ids VARCHAR(500) COMMENT '轮巡窗口ID列表',
    device_ids TEXT COMMENT '轮巡设备ID列表',
    interval_seconds INT DEFAULT 30 COMMENT '轮巡间隔(秒)',
    status TINYINT DEFAULT 0 COMMENT '状态:0停止1运行中',
    current_index INT DEFAULT 0 COMMENT '当前轮巡索引',
    create_by BIGINT COMMENT '创建人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_wall (wall_id),
    INDEX idx_status (status)
) COMMENT='电视墙轮巡配置表';
```

## 缓存设计

| Key模式 | 数据类型 | 过期时间 | 说明 |
|---------|----------|----------|------|
| `decoder:info:{decoderId}` | Hash | 30分钟 | 解码器信息 |
| `decoder:status:{decoderId}` | String | 1分钟 | 解码器状态 |
| `wall:config:{wallId}` | Hash | 30分钟 | 电视墙配置 |
| `wall:task:{wallId}` | Hash | 实时更新 | 当前上墙任务 |
| `wall:preset:{wallId}` | List | 30分钟 | 预案列表 |
