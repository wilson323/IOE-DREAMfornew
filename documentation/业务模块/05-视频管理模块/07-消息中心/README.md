# æ¶ˆæ¯ä¸­å¿ƒæ¨¡å— - å®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### æ¨¡å—å®šä½
æ¶ˆæ¯ä¸­å¿ƒæ˜¯è§†é¢‘æœåŠ¡çš„äº‹ä»¶è®¢é˜…ä¸­æ¢ï¼Œè´Ÿè´£ä¸è®¾å¤‡é€šè®¯æœåŠ¡ã€å…¶ä»–ä¸šåŠ¡æœåŠ¡ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’å’Œäº‹ä»¶åˆ†å‘ã€‚

### æ ¸å¿ƒä»·å€¼
- **äº‹ä»¶è®¢é˜…**: è®¢é˜…è®¾å¤‡çŠ¶æ€ã€å‘Šè­¦ç­‰äº‹ä»¶
- **æ¶ˆæ¯æ¨é€**: WebSocketå®æ—¶æ¨é€æ¶ˆæ¯åˆ°å‰ç«¯
- **æ¶ˆæ¯å­˜å‚¨**: æŒä¹…åŒ–é‡è¦æ¶ˆæ¯ä¾¿äºæŸ¥è¯¢

### æ¶ˆæ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ¶ˆæ¯ä¸­å¿ƒæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ è®¾å¤‡æœåŠ¡    â”‚â”€â”€â”€â”€â”€â”€RabbitMQâ”€â”€â”€â”€â”€â”€â”‚ æ¶ˆæ¯ä¸­å¿ƒ    â”‚         â”‚
â”‚  â”‚ (ç”Ÿäº§è€…)    â”‚                    â”‚ (æ¶ˆè´¹è€…)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                           â”‚                â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                                    â”‚ WebSocket   â”‚         â”‚
â”‚                                    â”‚ æ¨é€æœåŠ¡    â”‚         â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                           â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Webå‰ç«¯    â”‚  â”‚ APP         â”‚  â”‚ ç¬¬ä¸‰æ–¹ç³»ç»Ÿ  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ ç”¨æˆ·æ•…äº‹

### US-MSG-001: æ¶ˆæ¯å®æ—¶æ¨é€
**ä½œä¸º** å‰ç«¯åº”ç”¨  
**æˆ‘å¸Œæœ›** é€šè¿‡WebSocketæ¥æ”¶å®æ—¶æ¶ˆæ¯  
**ä»¥ä¾¿** åŠæ—¶æ›´æ–°ç•Œé¢çŠ¶æ€

**éªŒæ”¶æ ‡å‡†**:
1. WebSocketè¿æ¥ç¨³å®š
2. æ¶ˆæ¯å»¶è¿Ÿâ‰¤1ç§’
3. æ”¯æŒæ–­çº¿è‡ªåŠ¨é‡è¿

### US-MSG-002: æ¶ˆæ¯å†å²æŸ¥è¯¢
**ä½œä¸º** ç”¨æˆ·  
**æˆ‘å¸Œæœ›** æŸ¥è¯¢å†å²æ¶ˆæ¯è®°å½•  
**ä»¥ä¾¿** å›é¡¾å·²å¤„ç†å’Œæœªè¯»æ¶ˆæ¯

**éªŒæ”¶æ ‡å‡†**:
1. æ”¯æŒæŒ‰ç±»å‹/æ—¶é—´ç­›é€‰
2. åˆ†é¡µæŸ¥è¯¢æ€§èƒ½è‰¯å¥½
3. æ”¯æŒæ ‡è®°å·²è¯»/æœªè¯»

---

## ğŸ“Š ä¸šåŠ¡æµç¨‹å›¾

### æ¶ˆæ¯è®¢é˜…å‘å¸ƒæµç¨‹

```mermaid
sequenceDiagram
    participant DS as è®¾å¤‡æœåŠ¡
    participant MQ as RabbitMQ
    participant MC as æ¶ˆæ¯ä¸­å¿ƒ
    participant WS as WebSocket
    participant FE as å‰ç«¯
    
    DS->>MQ: å‘å¸ƒè®¾å¤‡äº‹ä»¶
    MQ->>MC: æ¶ˆè´¹æ¶ˆæ¯
    MC->>MC: æ¶ˆæ¯å¤„ç†(è¿‡æ»¤/è½¬æ¢)
    MC->>MC: æŒä¹…åŒ–æ¶ˆæ¯
    MC->>WS: æ¨é€æ¶ˆæ¯
    WS->>FE: WebSocketæ¨é€
    FE->>FE: æ›´æ–°UI
```

### WebSocketè¿æ¥ç®¡ç†

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥] --> B[Tokenè®¤è¯]
    B --> C{è®¤è¯é€šè¿‡?}
    C -->|å¦| D[æ‹’ç»è¿æ¥]
    C -->|æ˜¯| E[å»ºç«‹WebSocket]
    E --> F[åŠ å…¥ç”¨æˆ·ä¼šè¯]
    F --> G[è®¢é˜…ç”¨æˆ·é¢‘é“]
    G --> H[ç›‘å¬æ¶ˆæ¯]
    H --> I{è¿æ¥æ–­å¼€?}
    I -->|æ˜¯| J[æ¸…ç†ä¼šè¯]
    I -->|å¦| H
```

---

## ğŸ—„ï¸ æ•°æ®ç»“æ„è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- æ¶ˆæ¯è®°å½•è¡¨
CREATE TABLE t_message (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ¶ˆæ¯ID',
    message_code    VARCHAR(64) NOT NULL COMMENT 'æ¶ˆæ¯ç¼–ç ',
    message_type    TINYINT NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹:1-ç³»ç»Ÿ,2-å‘Šè­¦,3-è®¾å¤‡,4-ä¸šåŠ¡',
    title           VARCHAR(256) NOT NULL COMMENT 'æ¶ˆæ¯æ ‡é¢˜',
    content         TEXT COMMENT 'æ¶ˆæ¯å†…å®¹',
    sender_id       BIGINT COMMENT 'å‘é€è€…ID',
    sender_type     VARCHAR(32) COMMENT 'å‘é€è€…ç±»å‹:system/user/service',
    target_type     TINYINT NOT NULL COMMENT 'ç›®æ ‡ç±»å‹:1-å…¨å‘˜,2-è§’è‰²,3-ç”¨æˆ·',
    target_ids      JSON COMMENT 'ç›®æ ‡IDåˆ—è¡¨',
    priority        TINYINT NOT NULL DEFAULT 2 COMMENT 'ä¼˜å…ˆçº§:1-é«˜,2-ä¸­,3-ä½',
    expire_time     DATETIME COMMENT 'è¿‡æœŸæ—¶é—´',
    extra_data      JSON COMMENT 'é™„åŠ æ•°æ®',
    create_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_message_code (message_code),
    INDEX idx_message_type (message_type),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¶ˆæ¯è®°å½•è¡¨';

-- ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€è¡¨
CREATE TABLE t_user_message (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    user_id         BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    message_id      BIGINT NOT NULL COMMENT 'æ¶ˆæ¯ID',
    is_read         TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å·²è¯»:0-æœªè¯»,1-å·²è¯»',
    read_time       DATETIME COMMENT 'é˜…è¯»æ—¶é—´',
    is_deleted      TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤',
    create_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_message (user_id, message_id),
    INDEX idx_user_id (user_id),
    INDEX idx_is_read (is_read)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·æ¶ˆæ¯çŠ¶æ€è¡¨';

-- WebSocketä¼šè¯è¡¨
CREATE TABLE t_ws_session (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¼šè¯ID',
    session_id      VARCHAR(64) NOT NULL COMMENT 'WebSocketä¼šè¯ID',
    user_id         BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    client_type     VARCHAR(32) COMMENT 'å®¢æˆ·ç«¯ç±»å‹:web/app',
    client_ip       VARCHAR(64) COMMENT 'å®¢æˆ·ç«¯IP',
    connect_time    DATETIME NOT NULL COMMENT 'è¿æ¥æ—¶é—´',
    last_heartbeat  DATETIME COMMENT 'æœ€åå¿ƒè·³',
    status          TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€:1-åœ¨çº¿,2-ç¦»çº¿',
    UNIQUE KEY uk_session_id (session_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='WebSocketä¼šè¯è¡¨';
```

---

## ğŸ”Œ æ¥å£è®¾è®¡

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| GET | /api/v1/messages | æ¶ˆæ¯åˆ—è¡¨ | Level 2+ |
| GET | /api/v1/messages/unread-count | æœªè¯»æ•°é‡ | Level 2+ |
| PUT | /api/v1/messages/{id}/read | æ ‡è®°å·²è¯» | Level 2+ |
| PUT | /api/v1/messages/read-all | å…¨éƒ¨å·²è¯» | Level 2+ |
| WS | /ws/message | WebSocketè¿æ¥ | Level 2+ |

### WebSocketæ¶ˆæ¯æ ¼å¼

```json
{
  "type": "DEVICE_STATUS",
  "action": "UPDATE",
  "data": {
    "deviceId": 1001,
    "status": 2,
    "updateTime": "2024-01-15T10:30:00Z"
  },
  "timestamp": 1705312200000
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è¦æ±‚ |
|------|------|
| WebSocketè¿æ¥æ•° | â‰¥ 5000 |
| æ¶ˆæ¯æ¨é€å»¶è¿Ÿ | â‰¤ 1ç§’ |
| æ¶ˆæ¯ååé‡ | â‰¥ 10000/ç§’ |

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] WebSocketè¿æ¥ç¨³å®šå¯é 
- [ ] æ¶ˆæ¯æ¨é€å»¶è¿Ÿâ‰¤1ç§’
- [ ] æ–­çº¿è‡ªåŠ¨é‡è¿æ­£å¸¸
- [ ] æ¶ˆæ¯å†å²æŸ¥è¯¢æ€§èƒ½è‰¯å¥½
