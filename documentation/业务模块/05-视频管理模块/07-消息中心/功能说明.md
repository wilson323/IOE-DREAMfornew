# 消息中心模块 - 功能说明

## 模块概述

消息中心模块是视频服务与其他微服务进行数据交互的枢纽，采用事件订阅中心架构，支持消息订阅、发布、推送和任务队列管理。

## 功能清单

### 1. 事件订阅

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 订阅管理 | 管理事件订阅配置 | Level 3+ |
| 订阅设备事件 | 订阅设备状态变更 | Level 2+ |
| 订阅告警事件 | 订阅告警消息 | Level 2+ |
| 订阅分析事件 | 订阅AI分析结果 | Level 3+ |
| 取消订阅 | 取消事件订阅 | Level 2+ |

### 2. 消息推送

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| WebSocket推送 | 实时消息推送 | Level 2+ |
| APP推送 | 移动端消息推送 | Level 2+ |
| 短信通知 | 短信告警通知 | Level 4+ |
| 邮件通知 | 邮件告警通知 | Level 4+ |
| 语音呼叫 | 紧急语音告警 | Level 5 |

### 3. 消息管理

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 消息列表 | 查看历史消息 | Level 2+ |
| 消息详情 | 查看消息详情 | Level 2+ |
| 消息已读 | 标记消息已读 | Level 2+ |
| 消息删除 | 删除历史消息 | Level 3+ |
| 消息搜索 | 按条件搜索消息 | Level 2+ |

### 4. 任务队列

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 任务监控 | 监控任务执行状态 | Level 4+ |
| 任务重试 | 失败任务重试 | Level 4+ |
| 任务取消 | 取消等待中任务 | Level 4+ |
| 死信处理 | 处理死信队列 | Level 5 |
| 队列统计 | 队列性能统计 | Level 4+ |

## 事件订阅架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     事件订阅中心架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   事件生产者     │    │   事件消费者     │                    │
│  ├─────────────────┤    ├─────────────────┤                    │
│  │ 设备服务        │    │ 视频服务        │                    │
│  │ 告警服务        │    │ 门禁服务        │                    │
│  │ 分析服务        │    │ 考勤服务        │                    │
│  │ 访客服务        │    │ 消费服务        │                    │
│  └────────┬────────┘    └────────┬────────┘                    │
│           │                      │                              │
│           ▼                      ▼                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   RabbitMQ 消息中间件                    │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │ Exchange: event.topic (Topic类型)               │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │       │              │              │                   │   │
│  │       ▼              ▼              ▼                   │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐              │   │
│  │  │device.# │   │alarm.#  │   │analysis.#│              │   │
│  │  │Queue    │   │Queue    │   │Queue     │              │   │
│  │  └─────────┘   └─────────┘   └─────────┘              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   消息推送服务                           │   │
│  │  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐ │   │
│  │  │WebSocket│   │APP Push │   │SMS      │   │Email    │ │   │
│  │  └─────────┘   └─────────┘   └─────────┘   └─────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 消息格式规范

### 事件消息格式

```json
{
  "eventId": "evt_20240115103025_001",
  "eventType": "DEVICE_STATUS_CHANGE",
  "source": "device-comm-service",
  "timestamp": "2024-01-15T10:30:25Z",
  "payload": {
    "deviceId": 1001,
    "oldStatus": "ONLINE",
    "newStatus": "OFFLINE",
    "reason": "NETWORK_TIMEOUT"
  },
  "metadata": {
    "traceId": "trace_123456",
    "version": "1.0"
  }
}
```

### 推送消息格式

```json
{
  "messageId": "msg_20240115103025_001",
  "messageType": "ALARM_NOTIFICATION",
  "title": "紧急告警",
  "content": "围墙摄像机检测到越界行为",
  "level": "URGENT",
  "targetUsers": [1001, 1002],
  "pushChannels": ["WEBSOCKET", "APP"],
  "data": {
    "alarmId": 10001,
    "deviceId": 1001,
    "snapshotUrl": "https://xxx/snapshot.jpg"
  },
  "createTime": "2024-01-15T10:30:25Z"
}
```

## 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│ 📨 消息中心                                        未读: 5      │
├─────────────────────────────────────────────────────────────────┤
│ 类型:[全部▼] 状态:[全部▼] 时间:[最近7天▼] 🔍 搜索...           │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 🔴 紧急告警 - 越界检测                          10:30 未读  │ │
│ │    围墙摄像机检测到越界行为，请立即处理                     │ │
│ ├─────────────────────────────────────────────────────────────┤ │
│ │ 🟠 设备离线 - 大门摄像机                        10:28 未读  │ │
│ │    设备大门摄像机已离线，请检查网络连接                     │ │
│ ├─────────────────────────────────────────────────────────────┤ │
│ │ 🔵 系统通知 - 录像存储空间不足                  09:00 已读  │ │
│ │    当前存储空间使用率已达85%，建议清理历史数据             │ │
│ └─────────────────────────────────────────────────────────────┘ │
│ 分页: < 1 2 3 ... >                                             │
├─────────────────────────────────────────────────────────────────┤
│ 订阅设置:                                                        │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ [✓] 设备状态变更  [✓] 告警通知  [✓] 分析结果  [ ] 系统消息 │ │
│ │ 推送方式: [✓] 网页  [✓] APP  [ ] 短信  [ ] 邮件            │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 数据结构

### msg_subscription (订阅配置表)

```sql
CREATE TABLE msg_subscription (
    sub_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    push_channels VARCHAR(200),
    filter_conditions JSONB,
    enabled BOOLEAN DEFAULT TRUE,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE INDEX uk_user_event (user_id, event_type)
) COMMENT='消息订阅配置表';
```

### msg_message (消息表)

```sql
CREATE TABLE msg_message (
    message_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    message_type VARCHAR(50) NOT NULL,
    title VARCHAR(200),
    content TEXT,
    level VARCHAR(20),
    source_type VARCHAR(50),
    source_id BIGINT,
    read_flag BOOLEAN DEFAULT FALSE,
    read_time TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_read (user_id, read_flag),
    INDEX idx_create_time (create_time)
) COMMENT='用户消息表';
```
