# 地图展示模块 - 功能说明

## 模块概述

地图展示模块提供基于GIS的设备定位、区域管理和可视化监控功能，支持多种地图服务集成。

## 功能清单

### 1. 地图基础

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 地图加载 | 加载基础地图 | Level 1+ |
| 地图缩放 | 放大/缩小地图 | Level 1+ |
| 地图平移 | 拖拽移动地图 | Level 1+ |
| 图层切换 | 卫星图/路线图 | Level 2+ |
| 全屏展示 | 地图全屏显示 | Level 2+ |

### 2. 设备定位

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 设备标注 | 地图显示设备位置 | Level 2+ |
| 设备聚合 | 缩小时设备聚合显示 | Level 2+ |
| 设备筛选 | 按类型/状态筛选 | Level 2+ |
| 设备搜索 | 搜索定位设备 | Level 2+ |
| 设备详情 | 点击查看设备信息 | Level 2+ |
| 快速预览 | 点击设备预览视频 | Level 2+ |

### 3. 区域管理

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 区域绘制 | 绘制管辖区域 | Level 4+ |
| 区域编辑 | 编辑区域边界 | Level 4+ |
| 区域着色 | 不同区域不同颜色 | Level 3+ |
| 区域统计 | 区域内设备统计 | Level 3+ |
| 区域告警 | 区域告警高亮 | Level 3+ |

### 4. 告警展示

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 告警标记 | 告警位置闪烁标记 | Level 2+ |
| 告警聚合 | 告警数量聚合显示 | Level 2+ |
| 告警跳转 | 点击跳转告警处理 | Level 2+ |
| 热力图 | 告警热力分布图 | Level 3+ |

### 5. 轨迹展示

| 功能点 | 说明 | 权限要求 |
|--------|------|----------|
| 人员轨迹 | 显示人员移动轨迹 | Level 4+ |
| 车辆轨迹 | 显示车辆移动轨迹 | Level 4+ |
| 轨迹回放 | 轨迹动画回放 | Level 4+ |
| 轨迹导出 | 导出轨迹数据 | Level 4+ |

## 地图架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      地图展示架构                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    前端地图组件                          │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │          地图渲染引擎 (高德/百度/Leaflet)        │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │   │
│  │  │设备图层  │  │区域图层  │  │告警图层  │  │轨迹图层  │  │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    后端地图服务                          │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │   │
│  │  │设备位置  │  │区域数据  │  │告警数据  │  │轨迹数据  │   │   │
│  │  │服务     │  │服务     │  │服务     │  │服务     │   │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            │                                    │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    数据存储层                            │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │     PostgreSQL + PostGIS (空间数据库)             │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│ 🗺️ 地图监控                                                     │
├─────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 🔍 搜索设备...                    图层:[全部▼] 状态:[全部▼]│   │
│ ├───────────────────────────────────────────────────────────┤   │
│ │                                                           │   │
│ │                                                           │   │
│ │         📹●─────────●📹                                   │   │
│ │              园区A                                        │   │
│ │        📹●           ●📹                                  │   │
│ │              ⚠️                                            │   │
│ │                   ●📹                                     │   │
│ │         📹●───────────────●📹                            │   │
│ │                                                           │   │
│ │    📹: 在线(15)  📹: 离线(3)  ⚠️: 告警(2)                 │   │
│ │                                                           │   │
│ │ [+] [-] [⊕全屏] [📍定位] [🔄刷新]                         │   │
│ └───────────────────────────────────────────────────────────┘   │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 设备信息卡片 (点击设备显示)                                │   │
│ │ ┌─────────────────────────────────────────────────────┐   │   │
│ │ │ 📹 大门摄像机                               🟢 在线  │   │   │
│ │ │ 位置: 东门入口  IP: 192.168.1.100                   │   │   │
│ │ │ [预览] [详情] [导航]                                │   │   │
│ │ └─────────────────────────────────────────────────────┘   │   │
│ └───────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 数据结构

### 空间索引设计

```sql
-- 设备位置空间索引
CREATE INDEX idx_device_location 
ON ivs_device USING GIST(
    ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)
);

-- 区域边界空间索引
CREATE TABLE ivs_region_boundary (
    boundary_id BIGSERIAL PRIMARY KEY,
    region_id BIGINT NOT NULL,
    boundary GEOMETRY(POLYGON, 4326),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_boundary USING GIST(boundary)
) COMMENT='区域边界表';
```

### 轨迹数据表

```sql
CREATE TABLE ivs_track_point (
    point_id BIGSERIAL PRIMARY KEY,
    track_id BIGINT NOT NULL,
    target_type VARCHAR(20),
    target_id BIGINT,
    device_id BIGINT,
    longitude DECIMAL(10,7),
    latitude DECIMAL(10,7),
    capture_time TIMESTAMP NOT NULL,
    confidence DECIMAL(5,2),
    snapshot_url VARCHAR(500),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_track_time (track_id, capture_time),
    INDEX idx_location USING GIST(ST_SetSRID(ST_MakePoint(longitude, latitude), 4326))
) COMMENT='轨迹点表'
PARTITION BY RANGE (capture_time);
```

## 性能指标

| 指标 | 要求 |
|------|------|
| 地图加载 | < 2秒 |
| 设备渲染 | 1000设备 < 500ms |
| 聚合计算 | < 200ms |
| 区域查询 | < 100ms |
| 轨迹回放 | 流畅无卡顿 |
