# åœ°å›¾å±•ç¤ºæ¨¡å— - å®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### æ¨¡å—å®šä½
åœ°å›¾å±•ç¤ºæ¨¡å—æä¾›GISåœ°å›¾ä¸Šçš„è®¾å¤‡åˆ†å¸ƒå¯è§†åŒ–ï¼Œæ”¯æŒè®¾å¤‡å®šä½ã€è½¨è¿¹å±•ç¤ºã€åŒºåŸŸåˆ’åˆ†ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒä»·å€¼
- **å¯è§†åŒ–ç®¡ç†**: åœ°å›¾ä¸Šç›´è§‚å±•ç¤ºè®¾å¤‡åˆ†å¸ƒ
- **å¿«é€Ÿå®šä½**: é€šè¿‡åœ°å›¾å¿«é€Ÿå®šä½ç›®æ ‡è®¾å¤‡
- **è½¨è¿¹è¿½è¸ª**: äººå‘˜/è½¦è¾†è½¨è¿¹åœ°å›¾å±•ç¤º

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GISåœ°å›¾å±•ç¤º                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ é«˜å¾·åœ°å›¾API â”‚  â”‚ ç™¾åº¦åœ°å›¾API â”‚  â”‚ å¤©åœ°å›¾API   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                         â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚   åœ°å›¾æœåŠ¡é€‚é…å±‚     â”‚                       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ è®¾å¤‡å›¾å±‚    â”‚  â”‚ åŒºåŸŸå›¾å±‚    â”‚  â”‚ è½¨è¿¹å›¾å±‚    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ ç”¨æˆ·æ•…äº‹

### US-MAP-001: è®¾å¤‡åœ°å›¾å±•ç¤º
**ä½œä¸º** å®‰ä¿äººå‘˜  
**æˆ‘å¸Œæœ›** åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹æ‰€æœ‰è®¾å¤‡ä½ç½®  
**ä»¥ä¾¿** ç›´è§‚äº†è§£ç›‘æ§è¦†ç›–èŒƒå›´

**éªŒæ”¶æ ‡å‡†**:
1. è®¾å¤‡æŒ‰ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
2. åœ¨çº¿/ç¦»çº¿çŠ¶æ€é¢œè‰²åŒºåˆ†
3. ç‚¹å‡»è®¾å¤‡æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—

### US-MAP-002: åŒºåŸŸåˆ’åˆ†ç®¡ç†
**ä½œä¸º** ç³»ç»Ÿç®¡ç†å‘˜  
**æˆ‘å¸Œæœ›** åœ¨åœ°å›¾ä¸Šåˆ’åˆ†ç›‘æ§åŒºåŸŸ  
**ä»¥ä¾¿** æŒ‰åŒºåŸŸç®¡ç†è®¾å¤‡å’Œæƒé™

**éªŒæ”¶æ ‡å‡†**:
1. æ”¯æŒç»˜åˆ¶å¤šè¾¹å½¢åŒºåŸŸ
2. åŒºåŸŸæ”¯æŒå±‚çº§åµŒå¥—
3. åŒºåŸŸè®¾å¤‡è‡ªåŠ¨å…³è”

### US-MAP-003: äººå‘˜è½¨è¿¹å±•ç¤º
**ä½œä¸º** å®‰ä¿ä¸»ç®¡  
**æˆ‘å¸Œæœ›** åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹äººå‘˜æ´»åŠ¨è½¨è¿¹  
**ä»¥ä¾¿** è¿˜åŸäººå‘˜è¡ŒåŠ¨è·¯çº¿

**éªŒæ”¶æ ‡å‡†**:
1. è½¨è¿¹æŒ‰æ—¶é—´é¡ºåºå±•ç¤º
2. æ”¯æŒè½¨è¿¹å›æ”¾åŠ¨ç”»
3. å…³é”®èŠ‚ç‚¹æ ‡æ³¨äº‹ä»¶ä¿¡æ¯

---

## ğŸ“Š ä¸šåŠ¡æµç¨‹å›¾

### è®¾å¤‡å®šä½æµç¨‹

```mermaid
flowchart TD
    A[åŠ è½½åœ°å›¾] --> B[è·å–è®¾å¤‡åˆ—è¡¨]
    B --> C[ç­›é€‰æœ‰åæ ‡è®¾å¤‡]
    C --> D[åˆ›å»ºè®¾å¤‡æ ‡è®°]
    D --> E[æ·»åŠ åˆ°åœ°å›¾å›¾å±‚]
    E --> F[ç»‘å®šç‚¹å‡»äº‹ä»¶]
    F --> G{ç”¨æˆ·ç‚¹å‡»è®¾å¤‡?}
    G -->|æ˜¯| H[æ˜¾ç¤ºè®¾å¤‡è¯¦æƒ…]
    H --> I[æä¾›å¿«æ·æ“ä½œ]
    I --> J[é¢„è§ˆ/äº‘å°/ä¸Šå¢™]
    G -->|å¦| K[ç­‰å¾…äº¤äº’]
```

### è½¨è¿¹ç»˜åˆ¶æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant M as åœ°å›¾ç»„ä»¶
    participant VS as è§†é¢‘æœåŠ¡
    participant DB as æ•°æ®åº“
    
    U->>M: é€‰æ‹©äººå‘˜+æ—¶é—´èŒƒå›´
    M->>VS: è¯·æ±‚è½¨è¿¹æ•°æ®
    VS->>DB: æŸ¥è¯¢ä½ç½®è®°å½•
    DB-->>VS: è¿”å›è½¨è¿¹ç‚¹åˆ—è¡¨
    VS-->>M: è¿”å›è½¨è¿¹æ•°æ®
    M->>M: ç»˜åˆ¶è½¨è¿¹çº¿
    M->>M: æ·»åŠ å…³é”®ç‚¹æ ‡è®°
    M-->>U: å±•ç¤ºè½¨è¿¹åœ°å›¾
    U->>M: ç‚¹å‡»æ’­æ”¾
    M->>M: è½¨è¿¹åŠ¨ç”»å›æ”¾
```

---

## ğŸ—„ï¸ æ•°æ®ç»“æ„è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- è®¾å¤‡ä½ç½®è¡¨
CREATE TABLE t_device_location (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ID',
    device_id       BIGINT NOT NULL COMMENT 'è®¾å¤‡ID',
    device_type     TINYINT NOT NULL COMMENT 'è®¾å¤‡ç±»å‹',
    longitude       DECIMAL(10,7) NOT NULL COMMENT 'ç»åº¦',
    latitude        DECIMAL(10,7) NOT NULL COMMENT 'çº¬åº¦',
    altitude        DECIMAL(8,2) COMMENT 'æµ·æ‹”',
    floor           VARCHAR(32) COMMENT 'æ¥¼å±‚',
    address         VARCHAR(256) COMMENT 'åœ°å€æè¿°',
    region_id       BIGINT COMMENT 'æ‰€å±åŒºåŸŸID',
    update_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_device_id (device_id),
    INDEX idx_region_id (region_id),
    INDEX idx_location (longitude, latitude)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡ä½ç½®è¡¨';

-- åœ°å›¾åŒºåŸŸè¡¨
CREATE TABLE t_map_region (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'åŒºåŸŸID',
    region_name     VARCHAR(100) NOT NULL COMMENT 'åŒºåŸŸåç§°',
    region_code     VARCHAR(64) NOT NULL COMMENT 'åŒºåŸŸç¼–ç ',
    parent_id       BIGINT DEFAULT 0 COMMENT 'çˆ¶åŒºåŸŸID',
    level           TINYINT NOT NULL DEFAULT 1 COMMENT 'å±‚çº§',
    region_type     TINYINT NOT NULL DEFAULT 1 COMMENT 'ç±»å‹:1-è¡Œæ”¿åŒº,2-åŠŸèƒ½åŒº,3-ç›‘æ§åŒº',
    boundary        JSON COMMENT 'è¾¹ç•Œåæ ‡[[lng,lat],...]',
    center_lng      DECIMAL(10,7) COMMENT 'ä¸­å¿ƒç»åº¦',
    center_lat      DECIMAL(10,7) COMMENT 'ä¸­å¿ƒçº¬åº¦',
    zoom_level      TINYINT DEFAULT 15 COMMENT 'ç¼©æ”¾çº§åˆ«',
    fill_color      VARCHAR(32) DEFAULT '#1890ff' COMMENT 'å¡«å……é¢œè‰²',
    fill_opacity    DECIMAL(3,2) DEFAULT 0.2 COMMENT 'å¡«å……é€æ˜åº¦',
    stroke_color    VARCHAR(32) DEFAULT '#1890ff' COMMENT 'è¾¹æ¡†é¢œè‰²',
    status          TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€',
    deleted_flag    TINYINT NOT NULL DEFAULT 0,
    create_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_region_code (region_code),
    INDEX idx_parent_id (parent_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åœ°å›¾åŒºåŸŸè¡¨';

-- ä½ç½®è½¨è¿¹è¡¨
CREATE TABLE t_location_track (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è½¨è¿¹ID',
    target_id       BIGINT NOT NULL COMMENT 'ç›®æ ‡ID(äººå‘˜ID/è½¦è¾†ID)',
    target_type     TINYINT NOT NULL COMMENT 'ç›®æ ‡ç±»å‹:1-äººå‘˜,2-è½¦è¾†',
    device_id       BIGINT COMMENT 'é‡‡é›†è®¾å¤‡ID',
    longitude       DECIMAL(10,7) NOT NULL COMMENT 'ç»åº¦',
    latitude        DECIMAL(10,7) NOT NULL COMMENT 'çº¬åº¦',
    capture_time    DATETIME NOT NULL COMMENT 'é‡‡é›†æ—¶é—´',
    event_type      TINYINT COMMENT 'äº‹ä»¶ç±»å‹',
    snapshot_path   VARCHAR(512) COMMENT 'æˆªå›¾è·¯å¾„',
    create_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_target (target_type, target_id),
    INDEX idx_capture_time (capture_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä½ç½®è½¨è¿¹è¡¨';
```

---

## ğŸ”Œ æ¥å£è®¾è®¡

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| GET | /api/v1/map/devices | è®¾å¤‡ä½ç½®åˆ—è¡¨ | Level 2+ |
| PUT | /api/v1/map/devices/{id}/location | æ›´æ–°è®¾å¤‡ä½ç½® | Level 4+ |
| GET | /api/v1/map/regions | åŒºåŸŸåˆ—è¡¨ | Level 2+ |
| POST | /api/v1/map/regions | åˆ›å»ºåŒºåŸŸ | Level 4+ |
| GET | /api/v1/map/tracks | è½¨è¿¹æŸ¥è¯¢ | Level 3+ |

### è¯·æ±‚/å“åº”ç¤ºä¾‹

```java
// è®¾å¤‡ä½ç½®æŸ¥è¯¢
public class DeviceLocationVO {
    private Long deviceId;
    private String deviceName;
    private Integer deviceType;
    private BigDecimal longitude;
    private BigDecimal latitude;
    private Integer status;
    private String regionName;
}

// è½¨è¿¹æŸ¥è¯¢è¯·æ±‚
public class TrackQueryForm {
    @NotNull
    private Long targetId;
    @NotNull
    private Integer targetType;
    @NotNull
    private LocalDateTime startTime;
    @NotNull
    private LocalDateTime endTime;
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è¦æ±‚ |
|------|------|
| åœ°å›¾åŠ è½½æ—¶é—´ | â‰¤ 3ç§’ |
| è®¾å¤‡æ ‡è®°æ¸²æŸ“ | â‰¤ 1ç§’(1000ç‚¹) |
| è½¨è¿¹æŸ¥è¯¢å“åº” | â‰¤ 2ç§’ |

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] åœ°å›¾æ­£å¸¸åŠ è½½æ˜¾ç¤º
- [ ] è®¾å¤‡ä½ç½®æ ‡è®°å‡†ç¡®
- [ ] åŒºåŸŸç»˜åˆ¶å’Œç®¡ç†æ­£å¸¸
- [ ] è½¨è¿¹æŸ¥è¯¢å’Œå›æ”¾æµç•…
- [ ] å¤šåœ°å›¾æœåŠ¡é€‚é…æ­£å¸¸
