# è®¾å¤‡ç®¡ç†äº¤äº’æ¨¡å— - å®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

### æ¨¡å—å®šä½
è®¾å¤‡ç®¡ç†äº¤äº’æ¨¡å—æ˜¯è§†é¢‘æœåŠ¡ä¸è®¾å¤‡é€šè®¯æœåŠ¡ä¹‹é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£è®¾å¤‡ä¿¡æ¯çš„è®¢é˜…ã€åŒæ­¥å’ŒçŠ¶æ€ç®¡ç†ï¼Œé€šè¿‡äº‹ä»¶è®¢é˜…ä¸­å¿ƒå®ç°å®æ—¶æ•°æ®äº¤äº’ã€‚

### æ ¸å¿ƒä»·å€¼
- **ç»Ÿä¸€è®¾å¤‡ç®¡ç†**: é›†ä¸­ç®¡ç†æ‰€æœ‰è§†é¢‘ç›‘æ§è®¾å¤‡
- **å®æ—¶çŠ¶æ€åŒæ­¥**: é€šè¿‡äº‹ä»¶è®¢é˜…å®æ—¶æ„ŸçŸ¥è®¾å¤‡çŠ¶æ€
- **æ™ºèƒ½å‘Šè­¦æ¨é€**: è®¾å¤‡å¼‚å¸¸æ—¶è‡ªåŠ¨è§¦å‘å‘Šè­¦

### ä¾èµ–æœåŠ¡
| æœåŠ¡ | ç«¯å£ | äº¤äº’æ–¹å¼ |
|------|------|----------|
| ioedream-device-comm-service | 8087 | äº‹ä»¶è®¢é˜…/RabbitMQ |
| ioedream-common-service | 8088 | REST API |
| ioedream-gateway-service | 8080 | APIç½‘å…³ |

---

## ğŸ‘¥ ç”¨æˆ·æ•…äº‹

### US-DEV-001: è®¾å¤‡çŠ¶æ€ç›‘æ§
**ä½œä¸º** å®‰ä¿ä¸»ç®¡  
**æˆ‘å¸Œæœ›** å®æ—¶æŸ¥çœ‹æ‰€æœ‰è§†é¢‘è®¾å¤‡çš„åœ¨çº¿çŠ¶æ€  
**ä»¥ä¾¿** åŠæ—¶å‘ç°è®¾å¤‡æ•…éšœå¹¶å®‰æ’ç»´æŠ¤

**éªŒæ”¶æ ‡å‡†**:
1. è®¾å¤‡çŠ¶æ€å˜æ›´å3ç§’å†…ç•Œé¢æ›´æ–°
2. æ”¯æŒæŒ‰åŒºåŸŸã€ç±»å‹ã€çŠ¶æ€ç­›é€‰è®¾å¤‡
3. ç¦»çº¿è®¾å¤‡é«˜äº®æ˜¾ç¤ºå¹¶ç½®é¡¶

### US-DEV-002: è®¾å¤‡ä¿¡æ¯è®¢é˜…
**ä½œä¸º** ç³»ç»Ÿç®¡ç†å‘˜  
**æˆ‘å¸Œæœ›** è®¢é˜…æŒ‡å®šåŒºåŸŸçš„è®¾å¤‡ä¿¡æ¯å˜æ›´  
**ä»¥ä¾¿** åªå…³æ³¨è´Ÿè´£åŒºåŸŸçš„è®¾å¤‡çŠ¶æ€

**éªŒæ”¶æ ‡å‡†**:
1. æ”¯æŒæŒ‰åŒºåŸŸè®¢é˜…è®¾å¤‡
2. è®¢é˜…åè‡ªåŠ¨æ¥æ”¶å¢é‡æ›´æ–°
3. æ”¯æŒå–æ¶ˆè®¢é˜…

### US-DEV-003: è®¾å¤‡ç¦»çº¿å‘Šè­¦
**ä½œä¸º** å®‰ä¿äººå‘˜  
**æˆ‘å¸Œæœ›** è®¾å¤‡ç¦»çº¿æ—¶æ”¶åˆ°å‘Šè­¦é€šçŸ¥  
**ä»¥ä¾¿** å¿«é€Ÿå“åº”è®¾å¤‡æ•…éšœ

**éªŒæ”¶æ ‡å‡†**:
1. è®¾å¤‡ç¦»çº¿30ç§’åè§¦å‘å‘Šè­¦
2. å‘Šè­¦æ¨é€è‡³Webç«¯å’Œç§»åŠ¨ç«¯
3. å‘Šè­¦éœ€ç¡®è®¤å¤„ç†

### US-DEV-004: è®¾å¤‡æ ‘æŸ¥è¯¢
**ä½œä¸º** æ™®é€šç”¨æˆ·  
**æˆ‘å¸Œæœ›** é€šè¿‡æ ‘å½¢ç»“æ„æŸ¥æ‰¾è®¾å¤‡  
**ä»¥ä¾¿** å¿«é€Ÿå®šä½ç›®æ ‡æ‘„åƒæœº

**éªŒæ”¶æ ‡å‡†**:
1. æŒ‰åŒºåŸŸå±‚çº§å±•ç¤ºè®¾å¤‡æ ‘
2. æ”¯æŒè®¾å¤‡åç§°/IPæ¨¡ç³Šæœç´¢
3. æ˜¾ç¤ºå„èŠ‚ç‚¹è®¾å¤‡æ•°é‡ç»Ÿè®¡

---

## ğŸ“Š ä¸šåŠ¡æµç¨‹å›¾

### è®¾å¤‡ä¿¡æ¯è®¢é˜…æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant VS as è§†é¢‘æœåŠ¡
    participant MQ as RabbitMQ
    participant DS as è®¾å¤‡é€šè®¯æœåŠ¡
    
    U->>VS: è®¢é˜…è®¾å¤‡ä¿¡æ¯(åŒºåŸŸID)
    VS->>MQ: æ³¨å†Œæ¶ˆè´¹è€…(topic: device.info.{regionId})
    DS->>MQ: å‘å¸ƒè®¾å¤‡ä¿¡æ¯äº‹ä»¶
    MQ->>VS: æ¨é€è®¾å¤‡ä¿¡æ¯
    VS->>VS: æ›´æ–°æœ¬åœ°ç¼“å­˜
    VS->>U: WebSocketæ¨é€æ›´æ–°
```

### è®¾å¤‡çŠ¶æ€åŒæ­¥æµç¨‹

```mermaid
flowchart TD
    A[è®¾å¤‡é€šè®¯æœåŠ¡] -->|çŠ¶æ€å˜æ›´äº‹ä»¶| B[RabbitMQ]
    B -->|æ¶ˆè´¹| C[è§†é¢‘æœåŠ¡-äº‹ä»¶ç›‘å¬å™¨]
    C --> D{äº‹ä»¶ç±»å‹}
    D -->|ONLINE| E[æ›´æ–°çŠ¶æ€ä¸ºåœ¨çº¿]
    D -->|OFFLINE| F[æ›´æ–°çŠ¶æ€ä¸ºç¦»çº¿]
    D -->|ALARM| G[è§¦å‘å‘Šè­¦å¤„ç†]
    E --> H[æ›´æ–°Redisç¼“å­˜]
    F --> H
    G --> I[å‘Šè­¦æœåŠ¡å¤„ç†]
    H --> J[WebSocketå¹¿æ’­]
    J --> K[å‰ç«¯å®æ—¶æ›´æ–°]
```

### è®¾å¤‡ç¦»çº¿å‘Šè­¦æµç¨‹

```mermaid
flowchart TD
    A[è®¾å¤‡å¿ƒè·³æ£€æµ‹] -->|è¶…æ—¶30ç§’| B[è§¦å‘ç¦»çº¿äº‹ä»¶]
    B --> C[æ›´æ–°è®¾å¤‡çŠ¶æ€]
    C --> D[ç”Ÿæˆå‘Šè­¦è®°å½•]
    D --> E[å‘Šè­¦ç­‰çº§åˆ¤å®š]
    E -->|å…³é”®è®¾å¤‡| F[P1ç´§æ€¥å‘Šè­¦]
    E -->|æ™®é€šè®¾å¤‡| G[P2æ™®é€šå‘Šè­¦]
    F --> H[çŸ­ä¿¡+APPæ¨é€]
    G --> I[ä»…APPæ¨é€]
    H --> J[ç­‰å¾…å¤„ç†]
    I --> J
    J --> K{ç¡®è®¤å¤„ç†}
    K -->|æ˜¯| L[æ›´æ–°å‘Šè­¦çŠ¶æ€]
    K -->|è¶…æ—¶| M[å‡çº§å‘Šè­¦ç­‰çº§]
```

---

## ğŸ—„ï¸ æ•°æ®ç»“æ„è®¾è®¡

### ERå›¾

```mermaid
erDiagram
    T_VIDEO_DEVICE ||--o{ T_DEVICE_STATUS_LOG : "çŠ¶æ€è®°å½•"
    T_VIDEO_DEVICE ||--o{ T_DEVICE_SUBSCRIPTION : "è®¢é˜…å…³ç³»"
    T_VIDEO_DEVICE }|--|| T_VIDEO_REGION : "æ‰€å±åŒºåŸŸ"
    T_VIDEO_DEVICE ||--o{ T_DEVICE_OFFLINE_ALERT : "ç¦»çº¿å‘Šè­¦"
    
    T_VIDEO_DEVICE {
        bigint id PK "è®¾å¤‡ID"
        varchar device_name "è®¾å¤‡åç§°"
        varchar device_code "è®¾å¤‡ç¼–ç "
        int device_type "è®¾å¤‡ç±»å‹"
        varchar ip_address "IPåœ°å€"
        int port "ç«¯å£"
        varchar username "è´¦å·"
        varchar password "å¯†ç (åŠ å¯†)"
        bigint region_id FK "åŒºåŸŸID"
        int status "çŠ¶æ€:1åœ¨çº¿2ç¦»çº¿"
        int priority "è®¾å¤‡ä¼˜å…ˆçº§"
        datetime last_heartbeat "æœ€åå¿ƒè·³"
        int deleted_flag "åˆ é™¤æ ‡è®°"
        datetime create_time "åˆ›å»ºæ—¶é—´"
        datetime update_time "æ›´æ–°æ—¶é—´"
    }
    
    T_VIDEO_REGION {
        bigint id PK "åŒºåŸŸID"
        varchar region_name "åŒºåŸŸåç§°"
        varchar region_code "åŒºåŸŸç¼–ç "
        bigint parent_id "çˆ¶åŒºåŸŸID"
        int level "å±‚çº§"
        int sort "æ’åº"
        int deleted_flag "åˆ é™¤æ ‡è®°"
    }
    
    T_DEVICE_STATUS_LOG {
        bigint id PK "æ—¥å¿—ID"
        bigint device_id FK "è®¾å¤‡ID"
        int old_status "åŸçŠ¶æ€"
        int new_status "æ–°çŠ¶æ€"
        varchar change_reason "å˜æ›´åŸå› "
        datetime change_time "å˜æ›´æ—¶é—´"
    }
    
    T_DEVICE_SUBSCRIPTION {
        bigint id PK "è®¢é˜…ID"
        bigint user_id "ç”¨æˆ·ID"
        bigint region_id "åŒºåŸŸID"
        int subscription_type "è®¢é˜…ç±»å‹"
        int status "çŠ¶æ€"
        datetime create_time "åˆ›å»ºæ—¶é—´"
    }
    
    T_DEVICE_OFFLINE_ALERT {
        bigint id PK "å‘Šè­¦ID"
        bigint device_id FK "è®¾å¤‡ID"
        int alert_level "å‘Šè­¦ç­‰çº§"
        datetime offline_time "ç¦»çº¿æ—¶é—´"
        datetime recover_time "æ¢å¤æ—¶é—´"
        bigint handler_id "å¤„ç†äººID"
        int status "çŠ¶æ€"
        varchar remark "å¤‡æ³¨"
    }
```

### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- è§†é¢‘è®¾å¤‡è¡¨
CREATE TABLE t_video_device (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®¾å¤‡ID',
    device_name     VARCHAR(100) NOT NULL COMMENT 'è®¾å¤‡åç§°',
    device_code     VARCHAR(64) NOT NULL COMMENT 'è®¾å¤‡ç¼–ç ',
    device_type     TINYINT NOT NULL DEFAULT 131 COMMENT 'è®¾å¤‡ç±»å‹:131-IPC,118-NVR,111-DVR',
    ip_address      VARCHAR(64) NOT NULL COMMENT 'IPåœ°å€',
    port            INT NOT NULL DEFAULT 554 COMMENT 'ç«¯å£',
    username        VARCHAR(64) COMMENT 'è´¦å·',
    password        VARCHAR(256) COMMENT 'å¯†ç (AESåŠ å¯†)',
    region_id       BIGINT NOT NULL COMMENT 'åŒºåŸŸID',
    status          TINYINT NOT NULL DEFAULT 2 COMMENT 'çŠ¶æ€:1-åœ¨çº¿,2-ç¦»çº¿',
    priority        TINYINT NOT NULL DEFAULT 2 COMMENT 'ä¼˜å…ˆçº§:1-å…³é”®,2-æ™®é€š,3-ä½',
    channel_count   INT DEFAULT 1 COMMENT 'é€šé“æ•°',
    manufacturer    VARCHAR(64) COMMENT 'å‚å•†',
    model           VARCHAR(64) COMMENT 'å‹å·',
    last_heartbeat  DATETIME COMMENT 'æœ€åå¿ƒè·³æ—¶é—´',
    deleted_flag    TINYINT NOT NULL DEFAULT 0 COMMENT 'åˆ é™¤æ ‡è®°',
    create_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_device_code (device_code),
    INDEX idx_region_id (region_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§†é¢‘è®¾å¤‡è¡¨';

-- è®¾å¤‡çŠ¶æ€æ—¥å¿—è¡¨
CREATE TABLE t_device_status_log (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ—¥å¿—ID',
    device_id       BIGINT NOT NULL COMMENT 'è®¾å¤‡ID',
    old_status      TINYINT COMMENT 'åŸçŠ¶æ€',
    new_status      TINYINT NOT NULL COMMENT 'æ–°çŠ¶æ€',
    change_reason   VARCHAR(256) COMMENT 'å˜æ›´åŸå› ',
    change_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å˜æ›´æ—¶é—´',
    INDEX idx_device_id (device_id),
    INDEX idx_change_time (change_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡çŠ¶æ€æ—¥å¿—è¡¨';

-- è®¾å¤‡è®¢é˜…è¡¨
CREATE TABLE t_device_subscription (
    id                BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®¢é˜…ID',
    user_id           BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    region_id         BIGINT COMMENT 'åŒºåŸŸID(nullè¡¨ç¤ºå…¨éƒ¨)',
    subscription_type TINYINT NOT NULL DEFAULT 1 COMMENT 'è®¢é˜…ç±»å‹:1-è®¾å¤‡ä¿¡æ¯,2-çŠ¶æ€å˜æ›´,3-å‘Šè­¦',
    status            TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€:1-æœ‰æ•ˆ,2-å·²å–æ¶ˆ',
    create_time       DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_region_type (user_id, region_id, subscription_type),
    INDEX idx_region_id (region_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡è®¢é˜…è¡¨';

-- è®¾å¤‡ç¦»çº¿å‘Šè­¦è¡¨
CREATE TABLE t_device_offline_alert (
    id              BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å‘Šè­¦ID',
    device_id       BIGINT NOT NULL COMMENT 'è®¾å¤‡ID',
    alert_level     TINYINT NOT NULL DEFAULT 2 COMMENT 'å‘Šè­¦ç­‰çº§:1-ç´§æ€¥,2-æ™®é€š,3-ä½',
    offline_time    DATETIME NOT NULL COMMENT 'ç¦»çº¿æ—¶é—´',
    recover_time    DATETIME COMMENT 'æ¢å¤æ—¶é—´',
    handler_id      BIGINT COMMENT 'å¤„ç†äººID',
    handle_time     DATETIME COMMENT 'å¤„ç†æ—¶é—´',
    status          TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€:1-å¾…å¤„ç†,2-å·²å¤„ç†,3-å·²æ¢å¤',
    remark          VARCHAR(512) COMMENT 'å¤‡æ³¨',
    create_time     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_id (device_id),
    INDEX idx_status (status),
    INDEX idx_offline_time (offline_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¾å¤‡ç¦»çº¿å‘Šè­¦è¡¨';
```

---

## ğŸ”Œ æ¥å£è®¾è®¡

### RESTful API

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| GET | /api/v1/video/devices | è®¾å¤‡åˆ†é¡µåˆ—è¡¨ | Level 2+ |
| GET | /api/v1/video/devices/{id} | è®¾å¤‡è¯¦æƒ… | Level 2+ |
| GET | /api/v1/video/devices/tree | è®¾å¤‡æ ‘ | Level 2+ |
| GET | /api/v1/video/devices/status | è®¾å¤‡çŠ¶æ€ç»Ÿè®¡ | Level 2+ |
| POST | /api/v1/video/subscriptions | åˆ›å»ºè®¢é˜… | Level 2+ |
| DELETE | /api/v1/video/subscriptions/{id} | å–æ¶ˆè®¢é˜… | Level 2+ |
| GET | /api/v1/video/alerts/offline | ç¦»çº¿å‘Šè­¦åˆ—è¡¨ | Level 3+ |
| PUT | /api/v1/video/alerts/offline/{id}/handle | å¤„ç†å‘Šè­¦ | Level 3+ |

### è¯·æ±‚/å“åº”ç¤ºä¾‹

```java
// è®¾å¤‡åˆ†é¡µæŸ¥è¯¢è¯·æ±‚
public class DeviceQueryForm extends PageParam {
    /** åŒºåŸŸID */
    private Long regionId;
    /** è®¾å¤‡çŠ¶æ€:1-åœ¨çº¿,2-ç¦»çº¿ */
    private Integer status;
    /** è®¾å¤‡ç±»å‹ */
    private Integer deviceType;
    /** æœç´¢å…³é”®è¯(è®¾å¤‡åç§°/IP) */
    private String keyword;
}

// è®¾å¤‡å“åº”VO
public class VideoDeviceVO {
    /** è®¾å¤‡ID */
    private Long id;
    /** è®¾å¤‡åç§° */
    private String deviceName;
    /** è®¾å¤‡ç¼–ç  */
    private String deviceCode;
    /** è®¾å¤‡ç±»å‹ */
    private Integer deviceType;
    /** IPåœ°å€ */
    private String ipAddress;
    /** åŒºåŸŸID */
    private Long regionId;
    /** åŒºåŸŸåç§° */
    private String regionName;
    /** çŠ¶æ€ */
    private Integer status;
    /** æœ€åå¿ƒè·³æ—¶é—´ */
    private LocalDateTime lastHeartbeat;
}
```

### WebSocketæ¨é€

```json
{
  "type": "DEVICE_STATUS_CHANGE",
  "data": {
    "deviceId": 1001,
    "deviceName": "å¤§é—¨æ‘„åƒæœº",
    "oldStatus": 1,
    "newStatus": 2,
    "changeTime": "2024-01-15T10:30:00Z"
  }
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è¦æ±‚ | ç›‘æ§æ–¹å¼ |
|------|------|----------|
| çŠ¶æ€åŒæ­¥å»¶è¿Ÿ | â‰¤ 3ç§’ | Prometheus |
| è®¾å¤‡åˆ—è¡¨å“åº” | â‰¤ 500ms | APM |
| è®¾å¤‡æ ‘åŠ è½½ | â‰¤ 1ç§’ | APM |
| WebSocketæ¨é€ | â‰¤ 1ç§’ | æ—¥å¿—ç»Ÿè®¡ |
| å¹¶å‘è®¢é˜…æ•° | â‰¥ 1000 | Redis |

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] è®¾å¤‡çŠ¶æ€å®æ—¶åŒæ­¥,å»¶è¿Ÿâ‰¤3ç§’
- [ ] è®¾å¤‡æ ‘æ”¯æŒ10å±‚çº§ä»¥ä¸ŠåŒºåŸŸç»“æ„
- [ ] è®¾å¤‡æœç´¢æ”¯æŒåç§°/IPæ¨¡ç³ŠåŒ¹é…
- [ ] ç¦»çº¿å‘Šè­¦30ç§’å†…è§¦å‘
- [ ] å‘Šè­¦æ¨é€åˆ°è¾¾ç‡â‰¥99%

### æ€§èƒ½éªŒæ”¶
- [ ] 1000å°è®¾å¤‡çŠ¶æ€æŸ¥è¯¢<500ms
- [ ] æ”¯æŒ1000å¹¶å‘WebSocketè¿æ¥
- [ ] æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å»¶è¿Ÿ<100ms

### å®‰å…¨éªŒæ”¶
- [ ] è®¾å¤‡å¯†ç AESåŠ å¯†å­˜å‚¨
- [ ] APIæƒé™æ ¡éªŒå®Œæ•´
- [ ] æ“ä½œæ—¥å¿—å®Œæ•´è®°å½•
