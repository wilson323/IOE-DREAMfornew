# 设备管理交互模块 - 数据结构设计

## ER图

```
┌─────────────────┐       ┌─────────────────┐
│   ivs_region    │       │   ivs_device    │
├─────────────────┤       ├─────────────────┤
│ PK region_id    │──────<│ FK region_id    │
│    region_name  │       │ PK device_id    │
│    parent_id    │       │    device_sn    │
│    region_path  │       │    device_name  │
│    level        │       │    device_type  │
└─────────────────┘       │    ip_address   │
                          │    port         │
                          │    username     │
                          │    password_enc │
                          │    latitude     │
                          │    longitude    │
                          │    status       │
                          │    last_online  │
                          │    channel_count│
                          └─────────────────┘
                                  │
        ┌─────────────────────────┴─────────────────────────┐
        ▼                                                   ▼
┌─────────────────┐                               ┌─────────────────┐
│ ivs_subscription│                               │ivs_device_status│
├─────────────────┤                               ├─────────────────┤
│ PK sub_id       │                               │ PK status_id    │
│ FK user_id      │                               │ FK device_id    │
│ FK device_id    │                               │    status       │
│    sub_type     │                               │    change_time  │
│    status       │                               │    reason       │
│    create_time  │                               │    duration     │
└─────────────────┘                               └─────────────────┘
```

## 核心表结构

### ivs_device (设备主表)

```sql
CREATE TABLE ivs_device (
    device_id BIGSERIAL PRIMARY KEY COMMENT '设备ID',
    device_sn VARCHAR(64) UNIQUE NOT NULL COMMENT '设备序列号',
    device_name VARCHAR(100) NOT NULL COMMENT '设备名称',
    device_type VARCHAR(20) NOT NULL COMMENT '设备类型(IPC/NVR/DVR/PTZ)',
    manufacturer VARCHAR(50) COMMENT '厂商',
    model VARCHAR(50) COMMENT '型号',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    port INT DEFAULT 554 COMMENT '端口',
    username VARCHAR(50) COMMENT '用户名',
    password_enc VARCHAR(256) COMMENT '加密密码',
    region_id BIGINT COMMENT '区域ID',
    latitude DECIMAL(10,7) COMMENT '纬度',
    longitude DECIMAL(10,7) COMMENT '经度',
    altitude DECIMAL(10,2) COMMENT '海拔',
    install_time TIMESTAMP COMMENT '安装时间',
    channel_count INT DEFAULT 1 COMMENT '通道数',
    status TINYINT DEFAULT 0 COMMENT '状态:0离线1在线2故障',
    last_online_time TIMESTAMP COMMENT '最后在线时间',
    ptz_support BOOLEAN DEFAULT FALSE COMMENT '是否支持PTZ',
    security_level INT DEFAULT 2 COMMENT '安全级别(1-5)',
    deleted_flag TINYINT DEFAULT 0 COMMENT '删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_region (region_id),
    INDEX idx_status (status),
    INDEX idx_type (device_type),
    INDEX idx_device_location USING GIST(ll_to_earth(latitude, longitude))
) COMMENT='视频设备主表';
```

### ivs_region (区域表)

```sql
CREATE TABLE ivs_region (
    region_id BIGSERIAL PRIMARY KEY COMMENT '区域ID',
    region_name VARCHAR(100) NOT NULL COMMENT '区域名称',
    region_code VARCHAR(50) COMMENT '区域编码',
    parent_id BIGINT DEFAULT 0 COMMENT '父区域ID',
    region_path VARCHAR(500) COMMENT '区域路径(如:1/2/3)',
    level INT DEFAULT 1 COMMENT '层级',
    sort_order INT DEFAULT 0 COMMENT '排序',
    security_level INT DEFAULT 2 COMMENT '安全级别',
    description VARCHAR(500) COMMENT '描述',
    deleted_flag TINYINT DEFAULT 0 COMMENT '删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_parent (parent_id),
    INDEX idx_path (region_path)
) COMMENT='区域表';
```

### ivs_subscription (订阅配置表)

```sql
CREATE TABLE ivs_subscription (
    sub_id BIGSERIAL PRIMARY KEY COMMENT '订阅ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    device_id BIGINT COMMENT '设备ID(null表示全部)',
    region_id BIGINT COMMENT '区域ID(null表示全部)',
    sub_type VARCHAR(20) NOT NULL COMMENT '订阅类型(STATUS/INFO/ALARM)',
    push_type VARCHAR(20) DEFAULT 'WEBSOCKET' COMMENT '推送方式',
    status TINYINT DEFAULT 1 COMMENT '状态:0禁用1启用',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user (user_id),
    INDEX idx_device (device_id),
    INDEX idx_region (region_id)
) COMMENT='设备订阅配置表';
```

### ivs_device_status_log (设备状态日志)

```sql
CREATE TABLE ivs_device_status_log (
    log_id BIGSERIAL PRIMARY KEY COMMENT '日志ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    old_status TINYINT COMMENT '原状态',
    new_status TINYINT NOT NULL COMMENT '新状态',
    change_time TIMESTAMP NOT NULL COMMENT '变更时间',
    reason VARCHAR(200) COMMENT '变更原因',
    duration INT COMMENT '持续时长(秒)',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_time (device_id, change_time)
) COMMENT='设备状态变更日志'
PARTITION BY RANGE (change_time);

-- 按月分区
CREATE TABLE ivs_device_status_log_202401 PARTITION OF ivs_device_status_log
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

## 缓存设计

| Key模式 | 数据类型 | 过期时间 | 说明 |
|---------|----------|----------|------|
| `device:info:{deviceId}` | Hash | 30分钟 | 设备基本信息 |
| `device:status:{deviceId}` | String | 1分钟 | 设备在线状态 |
| `device:tree:{regionId}` | String | 10分钟 | 区域设备树 |
| `device:list:region:{regionId}` | List | 5分钟 | 区域设备列表 |
| `subscription:user:{userId}` | Set | 无 | 用户订阅列表 |
