# 实时监控模块 - 概要设计

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue3 + TypeScript)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 视频播放组件  │  │ 云台控制组件  │  │ 设备树组件   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└───────────────────────────┬─────────────────────────────────────┘
                            │ HTTP/WebSocket
┌───────────────────────────┴─────────────────────────────────────┐
│                    API Gateway (8080)                           │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│              ioedream-video-service (8092)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ MonitorController│ │ PTZController │ │ StreamController│      │
│  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘          │
│          └─────────────────┴─────────────────┘                  │
│                            │                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ MonitorService │ │ PTZService   │ │ StreamService │          │
│  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘          │
│          └─────────────────┴─────────────────┘                  │
│                            │                                     │
│  ┌──────────────┐  ┌──────────────┐                             │
│  │ StreamManager │  │ CacheManager │                             │
│  └───────┬──────┘  └───────┬──────┘                             │
│          └─────────────────┘                                     │
│                            │                                     │
│  ┌──────────────┐  ┌──────────────┐                             │
│  │ StreamDao    │  │ SnapshotDao  │                             │
│  └──────────────┘  └──────────────┘                             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│  PostgreSQL (主从) │ Redis Cluster │ 文件存储 (MinIO)           │
└─────────────────────────────────────────────────────────────────┘
```

## 模块设计

### Controller层

| 类名 | 职责 | 主要接口 |
|------|------|----------|
| MonitorController | 视频预览控制 | 获取流地址、截图、录制 |
| PTZController | 云台控制 | 方向控制、变焦、预置位 |
| StreamController | 流管理 | 协议切换、流状态查询 |

### Service层

| 类名 | 职责 |
|------|------|
| MonitorService | 视频预览业务逻辑 |
| PTZService | 云台控制业务逻辑 |
| StreamService | 流地址获取、协议转换 |
| SnapshotService | 截图业务逻辑 |
| RecordService | 录制业务逻辑 |

### Manager层

| 类名 | 职责 |
|------|------|
| StreamManager | 流地址管理、协议适配 |
| PTZLockManager | 云台设备锁管理 |
| CacheManager | 缓存管理 |

### DAO层

| 类名 | 职责 |
|------|------|
| StreamDao | 视频流数据访问 |
| PresetDao | 预置位数据访问 |
| SnapshotDao | 截图记录数据访问 |
| LocalRecordDao | 本地录像数据访问 |

## 技术选型

| 类别 | 选型 | 说明 |
|------|------|------|
| 流媒体服务 | ZLMediaKit | 支持多协议转换 |
| 视频播放器 | flv.js/hls.js | 前端播放器 |
| 设备对接 | GB/T 28181 | 国标设备协议 |
| 缓存 | Redis+Caffeine | 多级缓存 |
| 消息队列 | RabbitMQ | 异步消息 |

## 接口设计

### 视频流接口

```
GET /ivs/v1/monitor/stream/{deviceId}
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| deviceId | Long | 是 | 设备ID |
| protocol | String | 否 | 协议(默认ws-flv) |

**响应**:
```json
{
  "code": 200,
  "data": {
    "streamUrl": "ws://xxx/live/xxx.flv",
    "protocol": "ws-flv"
  }
}
```

### 云台控制接口

```
POST /ivs/v1/ptz/control
```

**请求体**:
```json
{
  "deviceId": 1001,
  "command": "LEFT",
  "speed": 50
}
```

### 截图接口

```
POST /ivs/v1/monitor/snapshot/{deviceId}
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "snapshotId": 10001,
    "url": "https://xxx/snapshots/xxx.jpg"
  }
}
```

## 数据库概念模型

```
ivs_device (设备) 1───N ivs_stream (视频流)
    │
    ├── 1───N ivs_ptz_preset (预置位)
    │
    ├── 1───N ivs_snapshot (截图)
    │
    └── 1───N ivs_local_record (本地录像)
```
