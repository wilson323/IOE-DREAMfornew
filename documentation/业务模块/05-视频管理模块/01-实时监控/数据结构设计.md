# 实时监控模块 - 数据结构设计

## ER图

```
┌─────────────────┐       ┌─────────────────┐
│   ivs_device    │       │  ivs_stream     │
├─────────────────┤       ├─────────────────┤
│ PK device_id    │──────<│ FK device_id    │
│    device_name  │       │ PK stream_id    │
│    device_type  │       │    protocol     │
│    ip_address   │       │    stream_url   │
│    latitude     │       │    status       │
│    longitude    │       └─────────────────┘
│    status       │
│    region_id    │       ┌─────────────────┐
└─────────────────┘       │ ivs_ptz_preset  │
        │                 ├─────────────────┤
        │                 │ FK device_id    │
        └────────────────>│ PK preset_id    │
                          │    preset_name  │
                          │    pan          │
                          │    tilt         │
                          │    zoom         │
                          └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│ ivs_snapshot    │       │ ivs_local_record│
├─────────────────┤       ├─────────────────┤
│ PK snapshot_id  │       │ PK record_id    │
│ FK device_id    │       │ FK device_id    │
│ FK user_id      │       │ FK user_id      │
│    capture_time │       │    start_time   │
│    file_path    │       │    end_time     │
│    file_size    │       │    file_path    │
└─────────────────┘       │    file_size    │
                          └─────────────────┘
```

## 核心表结构

### ivs_stream (视频流表)

```sql
CREATE TABLE ivs_stream (
    stream_id BIGSERIAL PRIMARY KEY COMMENT '流ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    protocol VARCHAR(20) NOT NULL COMMENT '协议类型',
    stream_url VARCHAR(500) NOT NULL COMMENT '流地址',
    main_sub TINYINT DEFAULT 0 COMMENT '主/子码流:0主1子',
    resolution VARCHAR(20) COMMENT '分辨率',
    bitrate INT COMMENT '码率(kbps)',
    fps INT DEFAULT 25 COMMENT '帧率',
    status TINYINT DEFAULT 1 COMMENT '状态:0离线1在线',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_stream_device 
        FOREIGN KEY (device_id) REFERENCES ivs_device(device_id),
    INDEX idx_device_protocol (device_id, protocol)
) COMMENT='视频流配置表';
```

### ivs_ptz_preset (云台预置位表)

```sql
CREATE TABLE ivs_ptz_preset (
    preset_id BIGSERIAL PRIMARY KEY COMMENT '预置位ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    preset_no INT NOT NULL COMMENT '预置位编号(1-256)',
    preset_name VARCHAR(50) COMMENT '预置位名称',
    pan DECIMAL(10,4) COMMENT '水平角度',
    tilt DECIMAL(10,4) COMMENT '垂直角度',
    zoom DECIMAL(10,4) COMMENT '变焦倍数',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    create_by BIGINT COMMENT '创建人',
    
    CONSTRAINT fk_preset_device 
        FOREIGN KEY (device_id) REFERENCES ivs_device(device_id),
    UNIQUE INDEX uk_device_preset (device_id, preset_no)
) COMMENT='云台预置位表';
```

### ivs_snapshot (截图记录表)

```sql
CREATE TABLE ivs_snapshot (
    snapshot_id BIGSERIAL PRIMARY KEY COMMENT '截图ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    user_id BIGINT NOT NULL COMMENT '操作用户ID',
    capture_time TIMESTAMP NOT NULL COMMENT '截图时间',
    file_path VARCHAR(500) NOT NULL COMMENT '文件路径',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_format VARCHAR(10) DEFAULT 'jpg' COMMENT '文件格式',
    width INT COMMENT '图片宽度',
    height INT COMMENT '图片高度',
    trigger_type TINYINT DEFAULT 0 COMMENT '触发类型:0手动1定时2事件',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_snapshot_device 
        FOREIGN KEY (device_id) REFERENCES ivs_device(device_id),
    INDEX idx_capture_time (capture_time),
    INDEX idx_device_time (device_id, capture_time)
) COMMENT='视频截图记录表';
```

### ivs_local_record (本地录像表)

```sql
CREATE TABLE ivs_local_record (
    record_id BIGSERIAL PRIMARY KEY COMMENT '录像ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    user_id BIGINT NOT NULL COMMENT '操作用户ID',
    start_time TIMESTAMP NOT NULL COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    duration INT COMMENT '时长(秒)',
    file_path VARCHAR(500) COMMENT '文件路径',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_format VARCHAR(10) DEFAULT 'mp4' COMMENT '文件格式',
    status TINYINT DEFAULT 0 COMMENT '状态:0录制中1完成2失败',
    trigger_type TINYINT DEFAULT 0 COMMENT '触发类型:0手动1定时2事件',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_record_device 
        FOREIGN KEY (device_id) REFERENCES ivs_device(device_id),
    INDEX idx_start_time (start_time),
    INDEX idx_device_time (device_id, start_time)
) COMMENT='本地录像记录表';
```

## 缓存设计

| Key模式 | 数据类型 | 过期时间 | 说明 |
|---------|----------|----------|------|
| `stream:{deviceId}:{protocol}` | String | 5分钟 | 流地址缓存 |
| `preset:{deviceId}` | Hash | 30分钟 | 预置位列表 |
| `device:online:{deviceId}` | String | 1分钟 | 设备在线状态 |
