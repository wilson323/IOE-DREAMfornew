# 智能视频模块 - 接口设计规范

## API规范

### URL规范

```
/ivs/v1/{module}/{resource}/{id}

示例:
- /ivs/v1/monitor/stream/1001      # 获取设备1001的视频流
- /ivs/v1/device/list              # 获取设备列表
- /ivs/v1/alarm/10001              # 获取告警10001详情
```

### 统一响应格式

**成功响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": { ... },
  "timestamp": "2024-01-15T10:30:25Z",
  "requestId": "req_abc123"
}
```

**分页响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [...],
    "total": 100,
    "pageNum": 1,
    "pageSize": 20,
    "pages": 5
  }
}
```

**错误响应**:
```json
{
  "code": 404001,
  "message": "设备不存在",
  "timestamp": "2024-01-15T10:30:25Z",
  "requestId": "req_abc123"
}
```

## 错误码规范

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400xxx | 参数错误 |
| 401xxx | 认证错误 |
| 403xxx | 权限不足 |
| 404xxx | 资源不存在 |
| 500xxx | 服务器错误 |

---

## 接口清单

### 实时监控模块 (/ivs/v1/monitor)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /stream/{deviceId} | 获取视频流地址 | Level 2+ |
| POST | /snapshot/{deviceId} | 视频截图 | Level 2+ |
| POST | /record/start/{deviceId} | 开始录制 | Level 3+ |
| POST | /record/stop/{recordId} | 停止录制 | Level 3+ |

### 云台控制 (/ivs/v1/ptz)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| POST | /control | 云台方向控制 | Level 3+ |
| POST | /preset | 设置预置位 | Level 3+ |
| POST | /preset/call/{presetId} | 调用预置位 | Level 3+ |
| GET | /preset/list/{deviceId} | 获取预置位列表 | Level 3+ |
| DELETE | /preset/{presetId} | 删除预置位 | Level 3+ |

### 设备管理 (/ivs/v1/device)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /list | 获取设备列表 | Level 2+ |
| GET | /{deviceId} | 获取设备详情 | Level 2+ |
| GET | /tree | 获取设备树 | Level 2+ |
| GET | /status/{deviceId} | 获取设备状态 | Level 2+ |
| POST | /subscribe | 订阅设备事件 | Level 2+ |
| DELETE | /subscribe/{subId} | 取消订阅 | Level 2+ |

### 视频回放 (/ivs/v1/playback)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /records | 查询录像列表 | Level 2+ |
| GET | /timeline/{deviceId} | 获取录像时间轴 | Level 2+ |
| GET | /stream/{recordId} | 获取回放流地址 | Level 2+ |
| POST | /download | 创建下载任务 | Level 3+ |
| GET | /download/{taskId} | 获取下载进度 | Level 3+ |

### 告警管理 (/ivs/v1/alarm)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /list | 获取告警列表 | Level 2+ |
| GET | /{alarmId} | 获取告警详情 | Level 2+ |
| POST | /{alarmId}/confirm | 确认告警 | Level 2+ |
| POST | /{alarmId}/handle | 处理告警 | Level 3+ |
| POST | /{alarmId}/assign | 派发告警 | Level 4+ |
| GET | /statistics | 告警统计 | Level 3+ |

### 智能分析 (/ivs/v1/analysis)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /algorithms | 获取算法列表 | Level 3+ |
| POST | /rule | 创建分析规则 | Level 4+ |
| PUT | /rule/{ruleId} | 更新分析规则 | Level 4+ |
| DELETE | /rule/{ruleId} | 删除分析规则 | Level 4+ |
| GET | /results | 查询分析结果 | Level 3+ |
| POST | /face/search | 人脸搜索 | Level 4+ |

### 解码上墙 (/ivs/v1/wall)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /decoders | 获取解码器列表 | Level 3+ |
| GET | /walls | 获取电视墙列表 | Level 3+ |
| POST | /task | 创建上墙任务 | Level 3+ |
| DELETE | /task/{taskId} | 取消上墙任务 | Level 3+ |
| POST | /preset | 保存预案 | Level 4+ |
| POST | /preset/{presetId}/apply | 调用预案 | Level 3+ |

### 消息中心 (/ivs/v1/message)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /list | 获取消息列表 | Level 2+ |
| GET | /unread/count | 获取未读数量 | Level 2+ |
| POST | /{messageId}/read | 标记已读 | Level 2+ |
| POST | /subscription | 创建订阅 | Level 2+ |
| GET | /subscription | 获取订阅配置 | Level 2+ |

### 地图服务 (/ivs/v1/map)

| 方法 | 接口 | 说明 | 权限 |
|------|------|------|------|
| GET | /devices | 获取设备位置 | Level 2+ |
| GET | /regions | 获取区域数据 | Level 2+ |
| GET | /alarms | 获取告警位置 | Level 2+ |
| GET | /track/{targetId} | 获取轨迹数据 | Level 4+ |
| GET | /heatmap | 获取热力图数据 | Level 3+ |

---

## 接口示例

### 获取视频流

**请求**:
```http
GET /ivs/v1/monitor/stream/1001?protocol=ws-flv
Authorization: Bearer xxx
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "deviceId": 1001,
    "streamUrl": "ws://192.168.1.100:8080/live/1001.flv",
    "protocol": "ws-flv",
    "expireTime": "2024-01-15T11:30:25Z"
  }
}
```

### 云台控制

**请求**:
```http
POST /ivs/v1/ptz/control
Content-Type: application/json
Authorization: Bearer xxx

{
  "deviceId": 1001,
  "command": "LEFT",
  "speed": 50,
  "duration": 1000
}
```

**响应**:
```json
{
  "code": 200,
  "message": "success"
}
```

### 查询告警列表

**请求**:
```http
GET /ivs/v1/alarm/list?pageNum=1&pageSize=20&status=0&level=1
Authorization: Bearer xxx
```

**响应**:
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "alarmId": 10001,
        "deviceId": 1001,
        "deviceName": "围墙摄像机",
        "alarmType": "CROSS_LINE",
        "alarmLevel": 1,
        "alarmTime": "2024-01-15T10:30:25Z",
        "status": 0,
        "snapshotUrl": "https://xxx/snapshot.jpg"
      }
    ],
    "total": 128,
    "pageNum": 1,
    "pageSize": 20
  }
}
```
