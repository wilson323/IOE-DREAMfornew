# 智能视频模块 - 数据库设计总览

## 数据库架构

- **数据库**: PostgreSQL 14+
- **分库策略**: 按业务模块垂直分库
- **分表策略**: 按时间水平分表(月)
- **读写分离**: 主从架构

## 表清单

### 设备管理 (共5张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| ivs_device | 设备主表 | 无 |
| ivs_region | 区域表 | 无 |
| ivs_stream | 视频流配置表 | 无 |
| ivs_ptz_preset | 云台预置位表 | 无 |
| ivs_device_status_log | 设备状态日志 | 按月分表 |

### 录像管理 (共4张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| ivs_record | 录像主表 | 按月分表 |
| ivs_record_index | 录像时间索引表 | 无 |
| ivs_snapshot | 截图记录表 | 无 |
| ivs_download_task | 下载任务表 | 无 |

### 告警管理 (共5张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| ivs_alarm | 告警主表 | 按月分表 |
| ivs_alarm_rule | 告警规则表 | 无 |
| ivs_alarm_handle | 告警处理记录表 | 无 |
| ivs_alarm_push | 告警推送记录表 | 无 |
| ivs_alarm_statistics | 告警统计表 | 无 |

### 智能分析 (共4张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| ivs_analysis_rule | 分析规则表 | 无 |
| ivs_analysis_result | 分析结果表 | 按月分表 |
| ivs_face_library | 人脸库表 | 无 |
| ivs_face_record | 人脸抓拍记录表 | 按月分表 |

### 解码上墙 (共4张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| ivs_decoder | 解码器表 | 无 |
| ivs_display_wall | 电视墙表 | 无 |
| ivs_wall_layout | 墙布局配置表 | 无 |
| ivs_display_task | 上墙任务表 | 无 |

### 消息中心 (共2张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| msg_subscription | 订阅配置表 | 无 |
| msg_message | 消息表 | 按月分表 |

### 地图服务 (共2张表)

| 表名 | 说明 | 分表策略 |
|------|------|----------|
| ivs_region_boundary | 区域边界表 | 无 |
| ivs_track_point | 轨迹点表 | 按月分表 |

**总计: 26张核心表**

## ER图总览

```
┌───────────────────────────────────────────────────────────────────────────┐
│                          智能视频模块ER图                                  │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐           │
│  │ ivs_region  │───────<│ ivs_device  │───────<│ ivs_stream  │           │
│  └─────────────┘        └──────┬──────┘        └─────────────┘           │
│                                │                                          │
│         ┌──────────────────────┼──────────────────────┐                  │
│         │                      │                      │                  │
│         ▼                      ▼                      ▼                  │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐           │
│  │ivs_ptz_preset│       │ ivs_record  │        │ ivs_alarm   │           │
│  └─────────────┘        └──────┬──────┘        └──────┬──────┘           │
│                                │                      │                  │
│                                ▼                      ▼                  │
│                         ┌─────────────┐        ┌─────────────┐           │
│                         │ivs_snapshot │        │ivs_alarm_handle│        │
│                         └─────────────┘        └─────────────┘           │
│                                                                           │
│  ┌─────────────┐        ┌─────────────┐        ┌─────────────┐           │
│  │ivs_decoder  │───────<│ivs_display_task│────>│ivs_display_wall│       │
│  └─────────────┘        └─────────────┘        └─────────────┘           │
│                                                                           │
│  ┌─────────────┐        ┌─────────────┐                                  │
│  │msg_subscription│────>│ msg_message │                                  │
│  └─────────────┘        └─────────────┘                                  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

## 索引策略

### 单列索引

```sql
-- 设备表
CREATE INDEX idx_device_region ON ivs_device(region_id);
CREATE INDEX idx_device_status ON ivs_device(status);
CREATE INDEX idx_device_type ON ivs_device(device_type);

-- 录像表
CREATE INDEX idx_record_device ON ivs_record(device_id);
CREATE INDEX idx_record_time ON ivs_record(start_time);

-- 告警表
CREATE INDEX idx_alarm_device ON ivs_alarm(device_id);
CREATE INDEX idx_alarm_time ON ivs_alarm(alarm_time);
CREATE INDEX idx_alarm_status ON ivs_alarm(status);
```

### 复合索引

```sql
CREATE INDEX idx_record_device_time ON ivs_record(device_id, start_time);
CREATE INDEX idx_alarm_type_level ON ivs_alarm(alarm_type, alarm_level);
CREATE INDEX idx_message_user_read ON msg_message(user_id, read_flag);
```

### 空间索引

```sql
CREATE INDEX idx_device_location ON ivs_device 
    USING GIST(ST_SetSRID(ST_MakePoint(longitude, latitude), 4326));

CREATE INDEX idx_region_boundary ON ivs_region_boundary 
    USING GIST(boundary);
```

## 分表规则

### 按月分区示例

```sql
-- 创建分区父表
CREATE TABLE ivs_record (
    record_id BIGSERIAL,
    device_id BIGINT NOT NULL,
    start_time TIMESTAMP NOT NULL,
    ...
) PARTITION BY RANGE (start_time);

-- 创建月分区
CREATE TABLE ivs_record_202401 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE ivs_record_202402 PARTITION OF ivs_record
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... 以此类推
```

## 数据归档

```sql
-- 归档6个月前的数据
CREATE OR REPLACE FUNCTION archive_old_data() 
RETURNS VOID AS $$
BEGIN
    -- 归档录像数据
    INSERT INTO ivs_record_archive 
    SELECT * FROM ivs_record 
    WHERE start_time < NOW() - INTERVAL '6 months';
    
    DELETE FROM ivs_record 
    WHERE start_time < NOW() - INTERVAL '6 months';
    
    -- 归档告警数据
    INSERT INTO ivs_alarm_archive 
    SELECT * FROM ivs_alarm 
    WHERE alarm_time < NOW() - INTERVAL '6 months';
    
    DELETE FROM ivs_alarm 
    WHERE alarm_time < NOW() - INTERVAL '6 months';
END;
$$ LANGUAGE plpgsql;
```
