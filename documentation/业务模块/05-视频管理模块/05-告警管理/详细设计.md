# å‘Šè­¦ç®¡ç† - è¯¦ç»†è®¾è®¡

> **ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“Š ç±»ç»“æ„è®¾è®¡

```mermaid
classDiagram
    class VideoAlarmController {
        +list(form: AlarmQueryForm): ResponseDTO
        +getDetail(id: Long): ResponseDTO
        +handle(form: AlarmHandleForm): ResponseDTO
        +batchHandle(form: BatchHandleForm): ResponseDTO
        +getStatistics(form: StatForm): ResponseDTO
    }
    
    class VideoAlarmService {
        <<interface>>
        +createAlarm(alarm: VideoAlarmDTO): Long
        +queryAlarms(form: AlarmQueryForm): PageResult
        +getAlarmDetail(id: Long): AlarmDetailVO
        +handleAlarm(form: AlarmHandleForm): void
        +getStatistics(form: StatForm): AlarmStatVO
    }
    
    class VideoAlarmServiceImpl {
        -alarmDao: VideoAlarmDao
        -messageService: VideoMessageService
        -linkageService: AlarmLinkageService
        +createAlarm(alarm: VideoAlarmDTO): Long
        +queryAlarms(form: AlarmQueryForm): PageResult
    }
    
    class AlarmLinkageService {
        +executeLinkage(alarmId: Long): void
        +getLinkageConfig(alarmType: String): LinkageConfigVO
    }
    
    class VideoMessageService {
        +pushAlarmMessage(message: AlarmMessageDTO): void
        +subscribeAlarm(userId: Long, config: SubscribeConfig): void
    }
    
    VideoAlarmController --> VideoAlarmService
    VideoAlarmServiceImpl ..|> VideoAlarmService
    VideoAlarmServiceImpl --> AlarmLinkageService
    VideoAlarmServiceImpl --> VideoMessageService
```

---

## ğŸ“‹ æ•°æ®åº“è¡¨è®¾è®¡

### t_video_alarm (è§†é¢‘å‘Šè­¦è¡¨)

```sql
CREATE TABLE t_video_alarm (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'å‘Šè­¦ID',
    alarm_no VARCHAR(32) NOT NULL COMMENT 'å‘Šè­¦ç¼–å·',
    camera_id BIGINT NOT NULL COMMENT 'æ‘„åƒå¤´ID',
    area_id BIGINT COMMENT 'åŒºåŸŸID',
    alarm_type VARCHAR(50) NOT NULL COMMENT 'å‘Šè­¦ç±»å‹',
    alarm_level VARCHAR(20) NOT NULL COMMENT 'å‘Šè­¦çº§åˆ«:LOW/MEDIUM/HIGH/CRITICAL',
    alarm_time DATETIME NOT NULL COMMENT 'å‘Šè­¦æ—¶é—´',
    alarm_desc VARCHAR(500) COMMENT 'å‘Šè­¦æè¿°',
    snapshot_url VARCHAR(200) COMMENT 'å‘Šè­¦å¿«ç…§URL',
    video_url VARCHAR(200) COMMENT 'å‘Šè­¦è§†é¢‘URL',
    handle_status TINYINT DEFAULT 0 COMMENT 'å¤„ç†çŠ¶æ€:0æœªå¤„ç†1å¤„ç†ä¸­2å·²å¤„ç†3å·²å¿½ç•¥',
    handler_id BIGINT COMMENT 'å¤„ç†äººID',
    handle_time DATETIME COMMENT 'å¤„ç†æ—¶é—´',
    handle_result VARCHAR(20) COMMENT 'å¤„ç†ç»“æœ:TRUE_ALARM/FALSE_ALARM',
    handle_remark VARCHAR(500) COMMENT 'å¤„ç†å¤‡æ³¨',
    linkage_status TINYINT DEFAULT 0 COMMENT 'è”åŠ¨çŠ¶æ€:0æœªè§¦å‘1å·²è§¦å‘2æ‰§è¡ŒæˆåŠŸ3æ‰§è¡Œå¤±è´¥',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    UNIQUE KEY uk_alarm_no (alarm_no),
    INDEX idx_camera_id (camera_id),
    INDEX idx_alarm_time (alarm_time),
    INDEX idx_alarm_type (alarm_type),
    INDEX idx_handle_status (handle_status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§†é¢‘å‘Šè­¦è¡¨';
```

### t_video_alarm_subscribe (å‘Šè­¦è®¢é˜…è¡¨)

```sql
CREATE TABLE t_video_alarm_subscribe (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®¢é˜…ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    alarm_types VARCHAR(500) COMMENT 'è®¢é˜…å‘Šè­¦ç±»å‹,é€—å·åˆ†éš”',
    area_ids VARCHAR(500) COMMENT 'è®¢é˜…åŒºåŸŸID,é€—å·åˆ†éš”',
    alarm_levels VARCHAR(100) COMMENT 'è®¢é˜…å‘Šè­¦çº§åˆ«,é€—å·åˆ†éš”',
    notify_channels VARCHAR(100) COMMENT 'é€šçŸ¥æ¸ é“:SMS,EMAIL,WEBSOCKET,APP',
    time_range VARCHAR(50) COMMENT 'æ¥æ”¶æ—¶é—´èŒƒå›´,å¦‚08:00-22:00',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:0ç¦ç”¨1å¯ç”¨',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å‘Šè­¦è®¢é˜…è¡¨';
```

---

## ğŸ”§ APIæ¥å£è®¾è®¡

### å‘Šè­¦åˆ—è¡¨æŸ¥è¯¢

```
GET /api/video/v1/alarm/list
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "cameraId": 1001,
  "alarmType": "INTRUSION",
  "alarmLevel": "HIGH",
  "handleStatus": 0,
  "startTime": "2025-12-01 00:00:00",
  "endTime": "2025-12-17 23:59:59",
  "pageNum": 1,
  "pageSize": 20
}
```

**å“åº”**:
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "alarmNo": "ALM202512170001",
        "cameraName": "å¤§é—¨æ‘„åƒå¤´",
        "alarmType": "INTRUSION",
        "alarmLevel": "HIGH",
        "alarmTime": "2025-12-17 10:30:00",
        "snapshotUrl": "/alarm/snapshot/001.jpg",
        "handleStatus": 0
      }
    ],
    "total": 100,
    "pageNum": 1,
    "pageSize": 20
  }
}
```

### å‘Šè­¦å¤„ç†

```
POST /api/video/v1/alarm/handle
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "alarmId": 1,
  "handleResult": "TRUE_ALARM",
  "handleRemark": "å·²ç¡®è®¤ä¸ºçœŸå®å…¥ä¾µäº‹ä»¶ï¼Œå·²é€šçŸ¥å®‰ä¿äººå‘˜"
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **å‘Šè­¦å­˜å‚¨**: ä½¿ç”¨Elasticsearchå­˜å‚¨å‘Šè­¦æ•°æ®ï¼Œæ”¯æŒå¿«é€Ÿæ£€ç´¢
2. **å®æ—¶æ¨é€**: ä½¿ç”¨WebSocket + Redis Pub/Subå®ç°å®æ—¶æ¨é€
3. **å‘Šè­¦å»é‡**: åŒä¸€æ‘„åƒå¤´çŸ­æ—¶é—´å†…ç›¸åŒç±»å‹å‘Šè­¦å»é‡
4. **å¼‚æ­¥å¤„ç†**: å‘Šè­¦è”åŠ¨ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—å¤„ç†

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
