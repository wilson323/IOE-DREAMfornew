# 告警管理模块 - 数据结构设计

## ER图

```
┌─────────────────┐       ┌─────────────────┐
│ ivs_alarm_rule  │       │   ivs_alarm     │
├─────────────────┤       ├─────────────────┤
│ PK rule_id      │──────<│ FK rule_id      │
│    rule_name    │       │ PK alarm_id     │
│    alarm_type   │       │ FK device_id    │
│    alarm_level  │       │    alarm_type   │
│    conditions   │       │    alarm_level  │
│    enabled      │       │    alarm_time   │
└─────────────────┘       │    alarm_content│
                          │    status       │
                          │    handler_id   │
                          │    handle_time  │
                          │    snapshot_url │
                          │    video_url    │
                          └─────────────────┘
                                  │
        ┌─────────────────────────┴─────────────────────────┐
        ▼                                                   ▼
┌─────────────────┐                               ┌─────────────────┐
│ivs_alarm_handle │                               │ivs_alarm_push   │
├─────────────────┤                               ├─────────────────┤
│ PK handle_id    │                               │ PK push_id      │
│ FK alarm_id     │                               │ FK alarm_id     │
│ FK handler_id   │                               │ FK user_id      │
│    handle_type  │                               │    push_type    │
│    handle_result│                               │    push_time    │
│    handle_time  │                               │    push_status  │
│    remark       │                               │    read_time    │
└─────────────────┘                               └─────────────────┘
```

## 核心表结构

### ivs_alarm (告警主表)

```sql
CREATE TABLE ivs_alarm (
    alarm_id BIGSERIAL PRIMARY KEY COMMENT '告警ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id INT DEFAULT 1 COMMENT '通道号',
    rule_id BIGINT COMMENT '规则ID',
    alarm_type VARCHAR(50) NOT NULL COMMENT '告警类型',
    alarm_level TINYINT NOT NULL COMMENT '告警级别(1紧急2重要3一般4提示)',
    alarm_time TIMESTAMP NOT NULL COMMENT '告警时间',
    alarm_content VARCHAR(500) COMMENT '告警内容',
    region_id BIGINT COMMENT '区域ID',
    location_x DECIMAL(10,6) COMMENT '位置X坐标',
    location_y DECIMAL(10,6) COMMENT '位置Y坐标',
    snapshot_url VARCHAR(500) COMMENT '抓拍图URL',
    video_url VARCHAR(500) COMMENT '关联视频URL',
    extra_data JSONB COMMENT '扩展数据(JSON)',
    status TINYINT DEFAULT 0 COMMENT '状态:0未处理1已确认2处理中3已处理4已关闭',
    handler_id BIGINT COMMENT '处理人ID',
    handle_time TIMESTAMP COMMENT '处理时间',
    is_false_alarm BOOLEAN DEFAULT FALSE COMMENT '是否误报',
    deleted_flag TINYINT DEFAULT 0 COMMENT '删除标记',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_time (device_id, alarm_time),
    INDEX idx_alarm_time (alarm_time),
    INDEX idx_type_level (alarm_type, alarm_level),
    INDEX idx_status (status),
    INDEX idx_region (region_id)
) COMMENT='告警主表'
PARTITION BY RANGE (alarm_time);

-- 按月分区
CREATE TABLE ivs_alarm_202401 PARTITION OF ivs_alarm
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### ivs_alarm_rule (告警规则表)

```sql
CREATE TABLE ivs_alarm_rule (
    rule_id BIGSERIAL PRIMARY KEY COMMENT '规则ID',
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    rule_code VARCHAR(50) UNIQUE COMMENT '规则编码',
    alarm_type VARCHAR(50) NOT NULL COMMENT '告警类型',
    alarm_level TINYINT NOT NULL COMMENT '默认告警级别',
    description VARCHAR(500) COMMENT '规则描述',
    conditions JSONB COMMENT '触发条件(JSON)',
    time_schedule JSONB COMMENT '生效时间计划(JSON)',
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    auto_confirm BOOLEAN DEFAULT FALSE COMMENT '是否自动确认',
    notify_config JSONB COMMENT '通知配置(JSON)',
    linkage_config JSONB COMMENT '联动配置(JSON)',
    create_by BIGINT COMMENT '创建人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_type (alarm_type),
    INDEX idx_enabled (enabled)
) COMMENT='告警规则配置表';
```

### ivs_alarm_handle (告警处理记录表)

```sql
CREATE TABLE ivs_alarm_handle (
    handle_id BIGSERIAL PRIMARY KEY COMMENT '处理ID',
    alarm_id BIGINT NOT NULL COMMENT '告警ID',
    handler_id BIGINT NOT NULL COMMENT '处理人ID',
    handle_type TINYINT NOT NULL COMMENT '处理类型:1确认2处理3派发4升级5关闭6误报',
    handle_result VARCHAR(500) COMMENT '处理结果',
    assign_to BIGINT COMMENT '派发给(用户ID)',
    remark VARCHAR(500) COMMENT '备注',
    handle_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '处理时间',
    
    CONSTRAINT fk_handle_alarm 
        FOREIGN KEY (alarm_id) REFERENCES ivs_alarm(alarm_id),
    INDEX idx_alarm (alarm_id),
    INDEX idx_handler (handler_id)
) COMMENT='告警处理记录表';
```

### ivs_alarm_push (告警推送记录表)

```sql
CREATE TABLE ivs_alarm_push (
    push_id BIGSERIAL PRIMARY KEY COMMENT '推送ID',
    alarm_id BIGINT NOT NULL COMMENT '告警ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    push_type VARCHAR(20) NOT NULL COMMENT '推送类型(WEBSOCKET/APP/SMS/EMAIL)',
    push_content VARCHAR(500) COMMENT '推送内容',
    push_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '推送时间',
    push_status TINYINT DEFAULT 0 COMMENT '推送状态:0待发送1成功2失败',
    read_flag BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    read_time TIMESTAMP COMMENT '阅读时间',
    error_msg VARCHAR(200) COMMENT '错误信息',
    
    INDEX idx_alarm (alarm_id),
    INDEX idx_user_status (user_id, push_status)
) COMMENT='告警推送记录表';
```

### ivs_alarm_statistics (告警统计表)

```sql
CREATE TABLE ivs_alarm_statistics (
    stat_id BIGSERIAL PRIMARY KEY COMMENT '统计ID',
    stat_date DATE NOT NULL COMMENT '统计日期',
    device_id BIGINT COMMENT '设备ID(null表示全局)',
    region_id BIGINT COMMENT '区域ID(null表示全局)',
    alarm_type VARCHAR(50) COMMENT '告警类型(null表示全部)',
    total_count INT DEFAULT 0 COMMENT '总数',
    level1_count INT DEFAULT 0 COMMENT '紧急数',
    level2_count INT DEFAULT 0 COMMENT '重要数',
    level3_count INT DEFAULT 0 COMMENT '一般数',
    level4_count INT DEFAULT 0 COMMENT '提示数',
    handled_count INT DEFAULT 0 COMMENT '已处理数',
    false_alarm_count INT DEFAULT 0 COMMENT '误报数',
    avg_handle_time INT COMMENT '平均处理时长(秒)',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE INDEX uk_date_device_region_type (stat_date, device_id, region_id, alarm_type),
    INDEX idx_stat_date (stat_date)
) COMMENT='告警统计表';
```

## 缓存设计

| Key模式 | 数据类型 | 过期时间 | 说明 |
|---------|----------|----------|------|
| `alarm:unread:{userId}` | String | 实时更新 | 用户未读告警数 |
| `alarm:recent:{deviceId}` | List | 5分钟 | 设备最近告警 |
| `alarm:rule:{ruleId}` | Hash | 30分钟 | 告警规则配置 |
| `alarm:stat:today` | Hash | 实时更新 | 今日告警统计 |
