# 行为分析模块 - 数据结构设计

## ER图

```
┌─────────────────┐       ┌─────────────────┐
│ivs_analysis_rule│       │ivs_analysis_result│
├─────────────────┤       ├─────────────────┤
│ PK rule_id      │──────<│ FK rule_id      │
│ FK device_id    │       │ PK result_id    │
│    rule_type    │       │ FK device_id    │
│    rule_name    │       │    result_type  │
│    config       │       │    detect_time  │
│    enabled      │       │    snapshot_url │
│    schedule     │       │    confidence   │
└─────────────────┘       │    extra_data   │
                          └─────────────────┘
                                  │
        ┌─────────────────────────┴─────────────────────────┐
        ▼                                                   ▼
┌─────────────────┐                               ┌─────────────────┐
│ ivs_face_capture│                               │ivs_face_library │
├─────────────────┤                               ├─────────────────┤
│ PK capture_id   │                               │ PK face_id      │
│ FK device_id    │                               │    person_id    │
│    capture_time │                               │    person_name  │
│    face_image   │                               │    face_image   │
│    quality      │                               │    feature      │
│    matched_id   │                               │    group_id     │
│    similarity   │                               │    status       │
└─────────────────┘                               └─────────────────┘
```

## 核心表结构

### ivs_analysis_rule (分析规则表)

```sql
CREATE TABLE ivs_analysis_rule (
    rule_id BIGSERIAL PRIMARY KEY COMMENT '规则ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id INT DEFAULT 1 COMMENT '通道号',
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    rule_type VARCHAR(50) NOT NULL COMMENT '规则类型(FACE_DETECT/CROSS_LINE/INTRUSION/LOITER/LICENSE_PLATE)',
    algorithm_id VARCHAR(50) COMMENT '算法ID',
    detection_area JSONB COMMENT '检测区域(多边形坐标)',
    alert_line JSONB COMMENT '警戒线(越界检测)',
    sensitivity INT DEFAULT 50 COMMENT '灵敏度(1-100)',
    threshold JSONB COMMENT '阈值配置',
    schedule JSONB COMMENT '生效时间计划',
    alarm_level TINYINT DEFAULT 3 COMMENT '告警级别',
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    linkage_config JSONB COMMENT '联动配置',
    create_by BIGINT COMMENT '创建人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device (device_id),
    INDEX idx_type (rule_type),
    INDEX idx_enabled (enabled)
) COMMENT='智能分析规则表';
```

### ivs_analysis_result (分析结果表)

```sql
CREATE TABLE ivs_analysis_result (
    result_id BIGSERIAL PRIMARY KEY COMMENT '结果ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id INT DEFAULT 1 COMMENT '通道号',
    rule_id BIGINT COMMENT '触发规则ID',
    result_type VARCHAR(50) NOT NULL COMMENT '结果类型',
    detect_time TIMESTAMP NOT NULL COMMENT '检测时间',
    snapshot_url VARCHAR(500) COMMENT '抓拍图URL',
    video_url VARCHAR(500) COMMENT '关联视频URL',
    target_rect JSONB COMMENT '目标框坐标',
    confidence DECIMAL(5,2) COMMENT '置信度',
    extra_data JSONB COMMENT '扩展数据',
    alarm_generated BOOLEAN DEFAULT FALSE COMMENT '是否已生成告警',
    alarm_id BIGINT COMMENT '关联告警ID',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_time (device_id, detect_time),
    INDEX idx_detect_time (detect_time),
    INDEX idx_type (result_type),
    INDEX idx_rule (rule_id)
) COMMENT='智能分析结果表'
PARTITION BY RANGE (detect_time);
```

### ivs_face_capture (人脸抓拍表)

```sql
CREATE TABLE ivs_face_capture (
    capture_id BIGSERIAL PRIMARY KEY COMMENT '抓拍ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    channel_id INT DEFAULT 1 COMMENT '通道号',
    capture_time TIMESTAMP NOT NULL COMMENT '抓拍时间',
    face_image VARCHAR(500) NOT NULL COMMENT '人脸图片URL',
    scene_image VARCHAR(500) COMMENT '场景图片URL',
    face_rect JSONB COMMENT '人脸框坐标',
    quality DECIMAL(5,2) COMMENT '质量分数',
    age INT COMMENT '预估年龄',
    gender VARCHAR(10) COMMENT '性别',
    glasses VARCHAR(20) COMMENT '眼镜',
    mask VARCHAR(20) COMMENT '口罩',
    feature BYTEA COMMENT '人脸特征向量',
    matched_face_id BIGINT COMMENT '匹配的人脸库ID',
    similarity DECIMAL(5,2) COMMENT '相似度',
    match_result VARCHAR(50) COMMENT '匹配结果',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_time (device_id, capture_time),
    INDEX idx_capture_time (capture_time),
    INDEX idx_matched (matched_face_id)
) COMMENT='人脸抓拍记录表'
PARTITION BY RANGE (capture_time);
```

### ivs_face_library (人脸库表)

```sql
CREATE TABLE ivs_face_library (
    face_id BIGSERIAL PRIMARY KEY COMMENT '人脸ID',
    person_id VARCHAR(64) COMMENT '人员ID',
    person_name VARCHAR(100) COMMENT '人员姓名',
    id_number VARCHAR(20) COMMENT '身份证号',
    face_image VARCHAR(500) NOT NULL COMMENT '人脸图片URL',
    feature BYTEA COMMENT '人脸特征向量',
    group_id BIGINT COMMENT '分组ID',
    group_type VARCHAR(50) COMMENT '分组类型(WHITE/BLACK/VIP)',
    source VARCHAR(50) COMMENT '来源',
    status TINYINT DEFAULT 1 COMMENT '状态:0禁用1启用',
    expire_time TIMESTAMP COMMENT '过期时间',
    remark VARCHAR(500) COMMENT '备注',
    create_by BIGINT COMMENT '创建人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_person (person_id),
    INDEX idx_group (group_id),
    INDEX idx_status (status)
) COMMENT='人脸库表';
```

### ivs_face_group (人脸分组表)

```sql
CREATE TABLE ivs_face_group (
    group_id BIGSERIAL PRIMARY KEY COMMENT '分组ID',
    group_name VARCHAR(100) NOT NULL COMMENT '分组名称',
    group_type VARCHAR(50) NOT NULL COMMENT '分组类型(WHITE/BLACK/VIP/STAFF)',
    parent_id BIGINT DEFAULT 0 COMMENT '父分组ID',
    face_count INT DEFAULT 0 COMMENT '人脸数量',
    description VARCHAR(500) COMMENT '描述',
    create_by BIGINT COMMENT '创建人',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_type (group_type),
    INDEX idx_parent (parent_id)
) COMMENT='人脸分组表';
```

### ivs_license_plate (车牌识别表)

```sql
CREATE TABLE ivs_license_plate (
    plate_id BIGSERIAL PRIMARY KEY COMMENT '记录ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    capture_time TIMESTAMP NOT NULL COMMENT '抓拍时间',
    plate_number VARCHAR(20) NOT NULL COMMENT '车牌号',
    plate_color VARCHAR(20) COMMENT '车牌颜色',
    vehicle_type VARCHAR(50) COMMENT '车辆类型',
    vehicle_color VARCHAR(20) COMMENT '车身颜色',
    plate_image VARCHAR(500) COMMENT '车牌图片',
    vehicle_image VARCHAR(500) COMMENT '车辆图片',
    confidence DECIMAL(5,2) COMMENT '识别置信度',
    direction VARCHAR(20) COMMENT '行驶方向',
    speed DECIMAL(6,2) COMMENT '速度(km/h)',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_time (device_id, capture_time),
    INDEX idx_plate_number (plate_number),
    INDEX idx_capture_time (capture_time)
) COMMENT='车牌识别记录表'
PARTITION BY RANGE (capture_time);
```

## 缓存设计

| Key模式 | 数据类型 | 过期时间 | 说明 |
|---------|----------|----------|------|
| `analysis:rule:{deviceId}` | List | 30分钟 | 设备分析规则列表 |
| `face:feature:{faceId}` | String | 1小时 | 人脸特征向量 |
| `face:group:{groupId}` | Hash | 30分钟 | 人脸分组信息 |
| `analysis:stat:today` | Hash | 实时更新 | 今日分析统计 |
