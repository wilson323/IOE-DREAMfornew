# 14-设备管理模块重构设计

## 📋 模块概述

**重构目标**：构建完整的设备管理体系，支持设备全生命周期管理。

**核心问题**：
- 设备注册流程不规范
- 设备状态监控缺失
- 设备配置管理混乱
- 缺乏设备运维工具
- **未明确设备与经营模式的关系**

**重构收益**：
- ✅ 规范的设备注册流程
- ✅ 实时设备状态监控
- ✅ 灵活的设备参数配置
- ✅ 完整的设备运维体系
- ✅ **明确设备能力与经营模式的适配关系**

---

## 🏗️ 设备与经营模式关系

### 设备能力与模式适配

**设备关联区域时需验证能力匹配**：

| 设备类型 | 支持的经营模式 | 必需功能 | 适用场景 |
|---------|---------------|---------|---------|
| **定值消费终端** | 餐别制(1)、混合(3) | 人脸识别/刷卡、定值扣款 | 食堂、餐厅固定餐次 |
| **商品扫码终端** | 超市制(2)、混合(3) | 扫码枪、商品查询、金额计算 | 超市、便利店 |
| **综合消费终端** | 全部支持(1/2/3) | 全功能支持 | 高端综合场所 |
| **移动POS终端** | 全部支持(1/2/3) | 便携、多模式切换 | 临时活动、外卖 |

### 设备配置与区域经营模式

**设备关联区域时的校验规则**：

| 校验项 | 规则 | 失败提示 |
|--------|------|---------|
| **设备与区域模式匹配** | 设备必须支持区域的经营模式 | "该设备不支持当前区域的经营模式" |
| **消费模式配置** | 设备的`consume_mode`必须与区域`manage_mode`匹配 | "设备消费模式与区域经营模式不一致" |
| **离线能力** | 餐别制需要离线定值配置 | "餐别制区域设备需要离线配置能力" |

**业务规则**：
1. **餐别制区域**：只能关联定值消费终端或综合终端
2. **超市制区域**：只能关联商品扫码终端或综合终端
3. **混合模式区域**：可关联任何类型设备，但需支持模式切换

---

## 🔄 业务流程设计

### 1.1 设备注册流程

```mermaid
flowchart TD
    A[新设备接入] --> B[填写设备信息]
    
    B --> C[设备基础信息]
    C --> D[设备编号]
    D --> E[设备名称]
    E --> F[设备类型]
    F --> G[设备型号]
    
    G --> H[网络配置]
    H --> I[IP地址]
    I --> J[端口号]
    J --> K[MAC地址]
    
    K --> L[业务配置]
    L --> M[所属区域]
    M --> N[支持的消费模式]
    N --> O[是否启用离线]
    
    O --> P{验证数据}
    P -->|失败| Q[显示错误]
    P -->|成功| R[生成设备密钥]
    
    R --> S[保存设备信息]
    S --> T[生成配置文件]
    T --> U[下发到设备]
    
    U --> V{设备响应}
    V -->|超时| W[注册失败]
    V -->|成功| X[设备激活]
    
    X --> Y[开始心跳监控]
    Y --> Z[注册完成]
    
    style W fill:#ff6b6b
    style Z fill:#51cf66
```

### 1.2 设备心跳监控流程

```mermaid
flowchart TD
    A[设备运行中] --> B[定时发送心跳]
    B --> C[心跳包内容]
    
    C --> D[设备ID]
    D --> E[当前时间]
    E --> F[设备状态]
    F --> G[离线流水数]
    G --> H[设备版本]
    
    H --> I[服务端接收]
    I --> J[验证设备签名]
    
    J --> K{签名有效?}
    K -->|否| L[拒绝心跳]
    K -->|是| M[更新在线状态]
    
    M --> N[记录心跳时间]
    N --> O[更新Redis缓存]
    O --> P[检查设备健康]
    
    P --> Q{健康检查}
    Q -->|正常| R[返回ACK]
    Q -->|异常| S[发送告警]
    
    R --> T{有待下发任务?}
    T -->|是| U[推送任务]
    T -->|否| V[心跳完成]
    
    S --> W[记录异常日志]
    U --> V
    W --> V
    
    style L fill:#ff6b6b
    style V fill:#51cf66
```

### 1.3 设备配置下发流程

```mermaid
flowchart TD
    A[管理员修改配置] --> B{配置类型}
    
    B -->|基础配置| C1[设备参数]
    B -->|业务配置| C2[消费规则]
    B -->|名单配置| C3[离线名单]
    B -->|固件升级| C4[固件包]
    
    C1 --> D[生成配置包]
    C2 --> D
    C3 --> D
    C4 --> E[上传固件文件]
    
    E --> D
    D --> F[加密配置数据]
    F --> G[生成MD5校验]
    
    G --> H{下发方式}
    H -->|立即下发| I1[推送到设备]
    H -->|定时下发| I2[加入定时队列]
    H -->|批量下发| I3[批量推送]
    
    I1 --> J[设备接收]
    I2 --> K[等待定时触发]
    I3 --> J
    K --> I1
    
    J --> L{校验通过?}
    L -->|否| M[重新下发]
    L -->|是| N[设备应用配置]
    
    N --> O[配置生效]
    O --> P[上报配置状态]
    P --> Q[更新下发记录]
    Q --> R[配置完成]
    
    style M fill:#ffd93d
    style R fill:#51cf66
```

### 1.4 设备故障处理流程

```mermaid
flowchart TD
    A[检测到设备异常] --> B{异常类型}
    
    B -->|离线| C1[超过5分钟无心跳]
    B -->|故障| C2[设备上报故障]
    B -->|数据异常| C3[数据校验失败]
    
    C1 --> D1[标记设备离线]
    C2 --> D2[记录故障信息]
    C3 --> D3[记录异常日志]
    
    D1 --> E[生成告警]
    D2 --> E
    D3 --> E
    
    E --> F[确定告警级别]
    F --> G{告警级别}
    
    G -->|一般| H1[邮件通知]
    G -->|重要| H2[短信通知]
    G -->|紧急| H3[电话+短信+邮件]
    
    H1 --> I[推送运维人员]
    H2 --> I
    H3 --> I
    
    I --> J[创建工单]
    J --> K[运维人员处理]
    
    K --> L{处理结果}
    L -->|已修复| M[恢复设备]
    L -->|需更换| N[设备报废]
    
    M --> O[清除告警]
    N --> P[标记设备状态]
    
    O --> Q[完成]
    P --> Q
    
    style Q fill:#51cf66
```

---

## 🗄️ 数据库设计

### 2.1 ER关系图

```mermaid
erDiagram
    POSID_DEVICE ||--o{ POSID_DEVICE_HEARTBEAT : "心跳记录"
    POSID_DEVICE ||--o{ POSID_DEVICE_CONFIG : "配置记录"
    POSID_DEVICE ||--o{ POSID_DEVICE_ALARM : "告警记录"
    POSID_DEVICE ||--o{ POSID_DEVICE_LOG : "操作日志"
    POSID_AREA ||--o{ POSID_DEVICE : "设备所属区域"
    
    POSID_DEVICE {
        VARCHAR id PK "设备ID"
        VARCHAR device_no UK "设备编号"
        VARCHAR device_name "设备名称"
        VARCHAR device_type "设备类型"
        VARCHAR device_model "设备型号"
        VARCHAR area_id FK "所属区域"
        VARCHAR ip_address "IP地址"
        INT port "端口号"
        VARCHAR mac_address "MAC地址"
        VARCHAR secret_key "设备密钥"
        VARCHAR online_status "在线状态"
        DATETIME last_heartbeat "最后心跳"
        VARCHAR firmware_version "固件版本"
        BOOLEAN offline_enabled "启用离线"
        INT offline_capacity "离线容量"
        VARCHAR status "设备状态"
        DATETIME register_time "注册时间"
    }
    
    POSID_DEVICE_HEARTBEAT {
        VARCHAR id PK "心跳ID"
        VARCHAR device_id FK "设备ID"
        VARCHAR device_status "设备状态"
        INT offline_count "离线流水数"
        INT cpu_usage "CPU使用率"
        INT memory_usage "内存使用率"
        INT disk_usage "磁盘使用率"
        DATETIME heartbeat_time "心跳时间"
    }
    
    POSID_DEVICE_CONFIG {
        VARCHAR id PK "配置ID"
        VARCHAR device_id FK "设备ID"
        VARCHAR config_type "配置类型"
        TEXT config_data "配置数据"
        VARCHAR config_md5 "配置校验"
        VARCHAR push_status "推送状态"
        DATETIME push_time "推送时间"
        DATETIME confirm_time "确认时间"
    }
    
    POSID_DEVICE_ALARM {
        VARCHAR id PK "告警ID"
        VARCHAR device_id FK "设备ID"
        VARCHAR alarm_type "告警类型"
        VARCHAR alarm_level "告警级别"
        TEXT alarm_content "告警内容"
        VARCHAR handle_status "处理状态"
        VARCHAR handler_id "处理人"
        DATETIME alarm_time "告警时间"
        DATETIME handle_time "处理时间"
    }
    
    POSID_DEVICE_LOG {
        VARCHAR id PK "日志ID"
        VARCHAR device_id FK "设备ID"
        VARCHAR log_type "日志类型"
        VARCHAR operator_id "操作人"
        TEXT log_content "日志内容"
        DATETIME create_time "创建时间"
    }
```

### 2.2 设备类型体系

```mermaid
graph TB
    subgraph 设备类型
        A[消费设备]
        
        B1[刷卡设备]
        B2[人脸识别设备]
        B3[扫码设备]
        B4[自助终端]
        
        C1[台式刷卡机]
        C2[挂式刷卡机]
        C3[人脸消费机]
        C4[二维码扫码枪]
        C5[自助点餐机]
        C6[自助结算机]
    end
    
    A --> B1
    A --> B2
    A --> B3
    A --> B4
    
    B1 --> C1
    B1 --> C2
    B2 --> C3
    B3 --> C4
    B4 --> C5
    B4 --> C6
    
    style A fill:#4ecdc4
    style B1 fill:#ff6b6b
    style B2 fill:#ffd93d
    style B3 fill:#74b9ff
    style B4 fill:#a29bfe
```

### 2.3 设备状态机

```mermaid
stateDiagram-v2
    [*] --> 待注册
    待注册 --> 注册中: 提交注册
    注册中 --> 已激活: 激活成功
    注册中 --> 注册失败: 激活失败
    
    已激活 --> 在线: 开始心跳
    在线 --> 离线: 心跳超时
    离线 --> 在线: 恢复心跳
    
    在线 --> 故障: 设备异常
    离线 --> 故障: 持续离线
    故障 --> 维修中: 创建工单
    维修中 --> 在线: 修复完成
    维修中 --> 已报废: 无法修复
    
    在线 --> 停用: 人工停用
    停用 --> 在线: 重新启用
    停用 --> 已报废: 设备淘汰
    
    已报废 --> [*]
```

### 2.4 设备配置分类

```mermaid
mindmap
  root((设备配置))
    网络配置
      IP地址
      端口号
      网关
      DNS
    业务配置
      消费模式
      支付方式
      小票打印
      语音播报
    离线配置
      离线名单容量
      离线流水容量
      同步策略
    显示配置
      欢迎语
      广告图片
      UI主题
    硬件配置
      刷卡读卡器
      打印机
      摄像头
      扫码枪
```

---

## 💾 缓存策略设计

### 3.1 核心缓存

| 缓存项 | Redis Key | 过期时间 | 说明 |
|-------|-----------|---------|------|
| 设备在线状态 | `device:online:{deviceId}` | 5分钟 | 心跳更新 |
| 设备基础信息 | `device:info:{deviceId}` | 30分钟 | 设备详情 |
| 设备配置 | `device:config:{deviceId}` | 1小时 | 当前配置 |
| 在线设备列表 | `device:online:list` | 1分钟 | 在线设备ID |
| 告警队列 | `device:alarm:queue` | 持久化 | 待处理告警 |

---

## 📊 监控指标

### 4.1 核心指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 设备在线率 | 在线设备/总设备 | < 90% |
| 设备故障率 | 故障设备/总设备 | > 5% |
| 心跳延迟 | 平均心跳间隔 | > 90秒 |
| 配置下发成功率 | 成功/总推送 | < 95% |
| 告警响应时长 | 平均处理时间 | > 30分钟 |

### 4.2 运维报表

- **设备在线监控大屏**：实时在线率、区域分布
- **设备健康报告**：设备状态、故障统计
- **告警统计报表**：告警类型、处理效率
- **设备使用分析**：消费笔数、使用率排行

---

## 🔧 设备运维工具

### 5.1 远程控制

```mermaid
flowchart LR
    A[运维平台] --> B[远程重启]
    A --> C[远程升级]
    A --> D[远程配置]
    A --> E[远程诊断]
    
    B --> F[设备]
    C --> F
    D --> F
    E --> F
    
    F --> G[执行结果]
    G --> A
    
    style A fill:#4ecdc4
    style F fill:#ff6b6b
```

### 5.2 批量操作

- **批量注册**：Excel导入批量注册设备
- **批量配置**：按区域/类型批量修改配置
- **批量升级**：分批次推送固件升级
- **批量重启**：维护窗口批量重启设备

---

## 🎯 总结

### 关键设计

✅ **规范注册**：标准化设备接入流程  
✅ **实时监控**：心跳机制，5分钟监控周期  
✅ **配置管理**：灵活的配置下发和版本管理  
✅ **告警机制**：多级告警，自动工单创建  
✅ **运维工具**：远程控制、批量操作

### 支持场景

- 🏫 **校园食堂**：50+设备统一管理
- 🏢 **企业园区**：跨区域设备集中监控
- 🏭 **工厂车间**：恶劣环境设备健康监控
- 🏥 **医院餐厅**：7×24小时设备运维保障

---

## 📝 更新说明

### v2.0 (2025-10-31)
- ✅ 新增"设备与经营模式关系"章节
- ✅ 明确设备能力与模式适配关系
- ✅ 补充设备关联区域时的校验规则

---

**文档版本**：v2.0  
**创建时间**：2025-10-31  
**适用版本**：POSID v3.13.1+

