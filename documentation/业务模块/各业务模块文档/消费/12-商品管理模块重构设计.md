# 12-商品管理模块重构设计

## 📋 模块概述

**重构目标**：构建完整的商品管理体系，支持超市、便利店等商品消费场景。

**核心问题**：
- 商品分类管理混乱
- 商品价格策略单一
- 库存管理缺失
- 商品条码管理不规范

**重构收益**：
- ✅ 树形商品分类结构
- ✅ 灵活的价格策略
- ✅ 完整的库存管理
- ✅ 标准化条码管理

---

## 🔗 与区域经营模式的关联

### 适用场景

**商品管理模块主要服务于超市制区域（manage_mode=2）**：

| 区域经营模式 | 是否需要商品管理 | 使用场景 | 说明 |
|------------|---------------|---------|------|
| **餐别制**（1） | ❌ 不需要 | 食堂、员工餐厅 | 使用定值消费，不涉及商品扫码 |
| **超市制**（2） | ✅ **必需** | 超市、便利店 | 核心消费方式为商品扫码 |
| **混合模式**（3） | ✅ 可选 | 综合餐厅、美食广场 | 支持定值+商品混合消费 |

### 业务关联关系

```mermaid
graph TB
    A[POSID_AREA<br/>区域管理] -->|manage_mode=2| B[超市制区域]
    A -->|manage_mode=3| C[混合模式区域]
    
    B -->|强关联| D[POSID_PRODUCT<br/>商品管理]
    C -->|可选关联| D
    
    D --> E[商品分类]
    D --> F[商品资料]
    D --> G[价格策略]
    D --> H[库存管理]
    
    B -->|inventory_flag=TRUE| H
    C -->|inventory_flag=TRUE| H
    
    style B fill:#ff6b6b
    style D fill:#51cf66
    style H fill:#ffd93d
```

### 核心设计原则

**1. 超市制区域与商品管理的强绑定**：
- 创建`manage_mode=2`的区域时，系统提示配置商品分类
- 超市制区域的设备必须支持`PRODUCT`消费模式
- 推荐启用`inventory_flag`进行库存管理

**2. 进销存（inventory_flag）与商品管理的关系**：
- `inventory_flag=TRUE`：启用完整的进销存管理（入库、出库、盘点、报表）
- `inventory_flag=FALSE`：仅使用商品价格，不管理库存（适合小型便利店）

**3. 商品与区域的关联方式**：
```sql
-- 商品表新增区域关联字段
ALTER TABLE POSID_PRODUCT
ADD COLUMN area_ids TEXT COMMENT '可售区域ID列表(JSON数组)';

-- 示例
-- area_ids: ["area001", "area002", "area003"]
-- 表示该商品可在这3个区域销售
```

**配置示例**：

**超市制区域配置**：
```json
{
  "id": "area001",
  "name": "园区超市",
  "type": 2,
  "area_sub_type": 1,
  "manage_mode": 2,
  "inventory_flag": true,
  "business_hours": {
    "weekday": "08:00-22:00",
    "weekend": "09:00-21:00"
  }
}
```

**商品配置（关联区域）**：
```json
{
  "id": "product001",
  "name": "农夫山泉550ml",
  "category_id": "cat001",
  "barcode": "6901939121351",
  "price": 2.00,
  "area_ids": ["area001", "area002"],
  "inventory_enabled": true,
  "stock": 1000
}
```

### 业务流程说明

**超市制区域消费流程**：
1. 用户刷卡/刷脸 → 身份识别
2. 获取区域信息（manage_mode=2）
3. 扫描商品条码
4. 查询商品信息（价格、库存、可售区域）
5. 验证商品是否可在当前区域销售（检查area_ids）
6. 累计商品金额
7. 扣减账户余额
8. 扣减商品库存（如果inventory_flag=TRUE）
9. 记录交易流水

---

## 🔄 业务流程设计

### 1.1 商品分类管理流程

```mermaid
flowchart TD
    A[商品分类管理] --> B{操作类型}
    
    B -->|新增分类| C1[填写分类信息]
    B -->|编辑分类| C2[修改分类信息]
    B -->|删除分类| C3[检查是否有商品]
    
    C1 --> D[分类编号]
    D --> E[分类名称]
    E --> F[选择父分类]
    F --> G[设置排序]
    
    G --> H{验证数据}
    H -->|失败| I[显示错误]
    H -->|成功| J[保存分类]
    
    C2 --> D
    
    C3 --> K{有商品或子分类?}
    K -->|是| L[禁止删除]
    K -->|否| M[确认删除]
    
    M --> N[删除分类]
    J --> O[刷新分类树]
    N --> O
    
    style L fill:#ff6b6b
    style O fill:#51cf66
```

### 1.2 商品资料管理流程

```mermaid
flowchart TD
    A[商品资料管理] --> B[填写商品信息]
    
    B --> C[基础信息]
    C --> D[商品编号/名称]
    D --> E[所属分类]
    E --> F[商品单位]
    
    F --> G[价格信息]
    G --> H{价格策略}
    H -->|统一价格| I1[设置统一价]
    H -->|区域定价| I2[各区域价格]
    H -->|时段定价| I3[时段价格]
    
    I1 --> J[库存管理]
    I2 --> J
    I3 --> J
    
    J --> K[启用库存管理?]
    K -->|是| L[设置初始库存]
    K -->|否| M[无限库存]
    
    L --> N[条码管理]
    M --> N
    
    N --> O[商品条码]
    O --> P[规格重量]
    P --> Q[商品图片]
    
    Q --> R[保存商品]
    R --> S[生成商品标签]
    S --> T[完成]
    
    style T fill:#51cf66
```

### 1.3 商品消费流程

```mermaid
flowchart TD
    A[开始消费] --> B{扫码方式}
    
    B -->|扫商品码| C1[识别商品条码]
    B -->|手动选择| C2[从分类选择商品]
    
    C1 --> D[查询商品信息]
    C2 --> D
    
    D --> E{商品存在?}
    E -->|否| F[提示商品不存在]
    E -->|是| G[显示商品信息]
    
    G --> H[输入数量]
    H --> I[检查库存]
    
    I --> J{库存充足?}
    J -->|否| K[提示库存不足]
    J -->|是| L[加入购物车]
    
    L --> M{继续添加?}
    M -->|是| B
    M -->|否| N[显示购物车]
    
    N --> O[计算总价]
    O --> P[确认支付]
    P --> Q[扣除账户余额]
    Q --> R[扣减库存]
    R --> S[生成消费流水]
    S --> T[打印小票]
    T --> U[消费完成]
    
    style F fill:#ff6b6b
    style K fill:#ff6b6b
    style U fill:#51cf66
```

### 1.4 库存管理流程

```mermaid
flowchart TD
    A[库存管理] --> B{操作类型}
    
    B -->|入库| C1[填写入库信息]
    B -->|出库| C2[填写出库信息]
    B -->|盘点| C3[库存盘点]
    B -->|调拨| C4[库存调拨]
    
    C1 --> D1[选择商品]
    D1 --> E1[入库数量]
    E1 --> F1[入库价格]
    F1 --> G1[供应商]
    G1 --> H1[生成入库单]
    
    C2 --> D2[选择商品]
    D2 --> E2[出库数量]
    E2 --> F2[出库原因]
    F2 --> G2[生成出库单]
    
    C3 --> D3[扫描盘点]
    D3 --> E3[实际数量]
    E3 --> F3{有差异?}
    F3 -->|是| G3[生成差异报告]
    F3 -->|否| H3[盘点完成]
    
    C4 --> D4[源仓库]
    D4 --> E4[目标仓库]
    E4 --> F4[调拨数量]
    F4 --> G4[生成调拨单]
    
    H1 --> I[更新库存]
    G2 --> I
    G3 --> I
    G4 --> I
    
    I --> J[记录库存流水]
    J --> K[库存预警检查]
    
    K --> L{低于预警值?}
    L -->|是| M[发送预警通知]
    L -->|否| N[完成]
    
    style M fill:#ffd93d
    style N fill:#51cf66
```

---

## 🗄️ 数据库设计

### 2.1 ER关系图

```mermaid
erDiagram
    POSID_PRODUCT_CATEGORY ||--o{ POSID_PRODUCT_CATEGORY : "子分类"
    POSID_PRODUCT_CATEGORY ||--o{ POSID_PRODUCT : "商品"
    POSID_PRODUCT ||--o{ POSID_PRODUCT_PRICE : "价格策略"
    POSID_PRODUCT ||--o{ POSID_PRODUCT_BARCODE : "商品条码"
    POSID_PRODUCT ||--o{ POSID_STOCK : "库存"
    POSID_STOCK ||--o{ POSID_STOCK_FLOW : "库存流水"
    POSID_TRANSACTION_ITEM }o--|| POSID_PRODUCT : "商品明细"
    
    POSID_PRODUCT_CATEGORY {
        VARCHAR id PK "分类ID"
        VARCHAR code UK "分类编号"
        VARCHAR name "分类名称"
        VARCHAR parent_id FK "父分类ID"
        VARCHAR full_path "完整路径"
        INT level "层级"
        INT sort_order "排序"
        BOOLEAN available "是否启用"
    }
    
    POSID_PRODUCT {
        VARCHAR id PK "商品ID"
        VARCHAR code UK "商品编号"
        VARCHAR name "商品名称"
        VARCHAR category_id FK "分类ID"
        VARCHAR unit "单位"
        INT default_price "默认价格"
        VARCHAR price_strategy "价格策略"
        BOOLEAN stock_enabled "启用库存"
        VARCHAR image_url "商品图片"
        BOOLEAN available "是否上架"
    }
    
    POSID_PRODUCT_PRICE {
        VARCHAR id PK "价格ID"
        VARCHAR product_id FK "商品ID"
        VARCHAR price_type "价格类型"
        VARCHAR area_id FK "区域ID"
        VARCHAR time_range "时间段"
        INT price "价格"
        DATE start_date "生效日期"
        DATE end_date "结束日期"
    }
    
    POSID_PRODUCT_BARCODE {
        VARCHAR id PK "条码ID"
        VARCHAR product_id FK "商品ID"
        VARCHAR barcode UK "商品条码"
        VARCHAR barcode_type "条码类型"
        DECIMAL spec "规格"
        BOOLEAN is_default "默认条码"
    }
    
    POSID_STOCK {
        VARCHAR id PK "库存ID"
        VARCHAR product_id FK "商品ID"
        VARCHAR area_id FK "区域/仓库"
        INT quantity "库存数量"
        INT warning_quantity "预警数量"
        INT lock_quantity "锁定数量"
        DATETIME last_check_time "最后盘点时间"
    }
    
    POSID_STOCK_FLOW {
        VARCHAR id PK "流水ID"
        VARCHAR stock_id FK "库存ID"
        VARCHAR flow_type "流水类型"
        INT quantity "数量"
        INT balance_before "操作前库存"
        INT balance_after "操作后库存"
        VARCHAR business_id "业务ID"
        VARCHAR operator_id "操作人"
        DATETIME create_time "创建时间"
    }
```

### 2.2 商品分类树形结构

```mermaid
graph TB
    subgraph 商品分类体系
        A[全部商品]
        
        B1[食品饮料]
        B2[日用百货]
        B3[文体用品]
        
        C1[主食类]
        C2[饮料类]
        C3[零食类]
        C4[清洁用品]
        C5[文具]
        C6[体育用品]
        
        D1[米面]
        D2[面包]
        D3[碳酸饮料]
        D4[果汁]
        D5[膨化食品]
    end
    
    A --> B1
    A --> B2
    A --> B3
    
    B1 --> C1
    B1 --> C2
    B1 --> C3
    B2 --> C4
    B3 --> C5
    B3 --> C6
    
    C1 --> D1
    C1 --> D2
    C2 --> D3
    C2 --> D4
    C3 --> D5
    
    style A fill:#4ecdc4
    style B1 fill:#ff6b6b
    style B2 fill:#ffd93d
    style B3 fill:#74b9ff
```

### 2.3 商品价格策略

```mermaid
graph TB
    subgraph 价格策略类型
        A[商品价格]
        
        B1[统一定价]
        B2[区域定价]
        B3[时段定价]
        B4[组合定价]
    end
    
    B1 --> C1[所有区域统一价格\n最简单]
    
    B2 --> C2[食堂价格\n3元]
    B2 --> C3[便利店价格\n4元]
    B2 --> C4[超市价格\n3.5元]
    
    B3 --> C5[早餐时段\n优惠价2.5元]
    B3 --> C6[午餐时段\n正常价3元]
    B3 --> C7[晚上时段\n促销价2元]
    
    B4 --> C8[区域+时段\n组合定价]
    
    A --> B1
    A --> B2
    A --> B3
    A --> B4
    
    style A fill:#4ecdc4
    style B1 fill:#95e1d3
    style B2 fill:#ff6b6b
    style B3 fill:#ffd93d
    style B4 fill:#a29bfe
```

### 2.4 库存流水类型

```mermaid
mindmap
  root((库存流水))
    入库
      采购入库
      退货入库
      调拨入库
      盘盈入库
    出库
      销售出库
      报损出库
      调拨出库
      盘亏出库
    锁定
      订单锁定
      活动锁定
    解锁
      订单取消
      超时解锁
```

---

## 💾 缓存策略设计

### 3.1 核心缓存

| 缓存项 | Redis Key | 过期时间 | 说明 |
|-------|-----------|---------|------|
| 商品信息 | `product:info:{productId}` | 30分钟 | 商品基础信息 |
| 商品分类树 | `product:category:tree` | 1小时 | 完整分类树 |
| 商品价格 | `product:price:{productId}:{areaId}` | 1小时 | 区域价格 |
| 商品库存 | `product:stock:{productId}:{areaId}` | 5分钟 | 实时库存 |
| 热销商品 | `product:hot:top100` | 10分钟 | TOP100热销 |

---

## 📊 监控指标

### 4.1 核心指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 商品销售TOP10 | 热销商品排行 | - |
| 库存预警商品数 | 低于预警线 | > 50个 |
| 缺货商品数 | 库存为0 | > 10个 |
| 商品条码识别率 | 扫码成功率 | < 95% |
| 库存准确率 | 系统vs实际 | < 98% |

### 4.2 业务报表

- **商品销售统计**：按商品、分类、时间统计销量
- **库存状况报表**：库存分布、周转率、呆滞商品
- **价格调整记录**：价格变更历史、调价分析
- **进销存报表**：采购、销售、库存综合分析

---

## 🎯 总结

### 关键设计

✅ **树形分类**：支持无限层级商品分类  
✅ **灵活定价**：统一价/区域价/时段价多种策略  
✅ **库存管理**：入库/出库/盘点/调拨完整流程  
✅ **条码管理**：支持多条码、规格管理  
✅ **实时监控**：库存预警、热销分析

### 支持场景

- 🏪 **校园超市**：文具、零食、日用品销售
- 🏬 **企业便利店**：员工购物，卡片结算
- 🍞 **园区面包房**：面包、糕点、饮料销售
- 🍎 **水果店**：称重商品、组合商品销售

---

**文档版本**：v2.0  
**创建时间**：2025-10-31  
**更新时间**：2025-10-31  
**适用版本**：POSID v3.13.1+  
**更新说明**：
- v2.0: 新增与区域经营模式的关联章节，明确商品管理适用于超市制（manage_mode=2）和混合模式（manage_mode=3），新增商品与区域关联设计
- v1.0: 初始版本，完整的商品管理体系设计

