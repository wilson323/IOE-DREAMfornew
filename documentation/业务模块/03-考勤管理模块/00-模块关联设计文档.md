# 考勤管理模块 - 模块间关联设计文档

> **版本**: v1.0.0  
> **微服务**: ioedream-attendance-service (8091)  
> **创建日期**: 2025-12-17

---

## 📊 模块关联全景图

```mermaid
graph TB
    subgraph 考勤微服务内部模块
        SHIFT[01-班次时间管理]
        SCHED[02-排班管理]
        RULE[03-考勤规则配置]
        EXCEPT[04-异常管理]
        COLLECT[05-考勤数据采集]
        REPORT[06-考勤汇总报表]
        AREA[07-设备区域管理]
    end
    
    subgraph 外部微服务
        GW[Gateway:8080]
        CMN[Common:8088]
        DC[DeviceComm:8087]
        OA[OA:8089]
        ACC[Access:8090]
    end
    
    %% 内部关联
    SHIFT --> SCHED
    SHIFT --> RULE
    SCHED --> COLLECT
    RULE --> COLLECT
    COLLECT --> EXCEPT
    COLLECT --> REPORT
    EXCEPT --> REPORT
    AREA --> COLLECT
    
    %% 外部关联
    COLLECT <--> DC
    COLLECT <--> ACC
    EXCEPT <--> OA
    REPORT --> CMN
```

---

## 🔗 内部模块关联详细设计

### 1. 班次时间管理 ↔ 排班管理

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 班次引用 | 排班时选择班次 | SHIFT → SCHED |
| 时间继承 | 排班继承班次时间规则 | SHIFT → SCHED |
| 班次修改 | 班次变更影响排班 | SHIFT → SCHED |

**关键接口**:
```java
// ShiftService.java
List<ShiftVO> getAvailableShifts(Long departmentId);

// ScheduleService.java
void assignSchedule(Long employeeId, Long shiftId, LocalDate date);
```

### 2. 排班管理 ↔ 考勤数据采集

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 排班查询 | 采集时查询当日排班 | SCHED → COLLECT |
| 打卡校验 | 根据排班判断打卡是否有效 | SCHED → COLLECT |
| 加班识别 | 识别加班打卡记录 | SCHED → COLLECT |

**关键接口**:
```java
// ScheduleService.java
ScheduleVO getEmployeeSchedule(Long employeeId, LocalDate date);

// AttendanceCollectService.java
void processClockRecord(ClockRecordDTO record);
```

### 3. 考勤规则配置 ↔ 考勤数据采集

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 规则应用 | 打卡时应用考勤规则 | RULE → COLLECT |
| 迟到判定 | 根据规则判定迟到 | RULE → COLLECT |
| 早退判定 | 根据规则判定早退 | RULE → COLLECT |

**关键接口**:
```java
// AttendanceRuleService.java
AttendanceRuleVO getApplicableRule(Long employeeId, LocalDate date);

// AttendanceCalculateService.java
AttendanceResultVO calculate(ClockRecordDTO record, AttendanceRuleVO rule);
```

### 4. 考勤数据采集 ↔ 异常管理

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 异常生成 | 采集时发现异常自动记录 | COLLECT → EXCEPT |
| 状态同步 | 异常处理后更新考勤状态 | EXCEPT → COLLECT |

**关键接口**:
```java
// AttendanceExceptionService.java
void createException(AttendanceExceptionDTO exception);
void handleException(Long exceptionId, HandleForm form);
```

---

## 🌐 外部微服务关联设计

### 1. 考勤服务 ↔ 设备通讯服务 (8087)

```mermaid
sequenceDiagram
    participant DEV as 考勤设备
    participant DC as DeviceComm
    participant ATT as Attendance
    
    DEV->>DC: 上报打卡数据
    DC->>ATT: 转发打卡记录
    ATT->>ATT: 查询排班规则
    ATT->>ATT: 计算考勤结果
    ATT->>ATT: 保存考勤记录
    ATT-->>DC: 返回处理结果
```

**关键API**:
```
POST /api/attendance/v1/clock/receive    # 接收打卡数据
POST /api/attendance/v1/device/sync      # 同步设备人员
```

### 2. 考勤服务 ↔ 门禁服务 (8090)

```mermaid
sequenceDiagram
    participant ACC as Access
    participant ATT as Attendance
    
    ACC->>ATT: 门禁通行作为打卡
    ATT->>ATT: 验证通行数据
    ATT->>ATT: 生成打卡记录
    ATT-->>ACC: 返回处理结果
```

**关键API**:
```
POST /api/attendance/v1/clock/from-access  # 门禁数据作为打卡
```

### 3. 考勤服务 ↔ OA服务 (8089)

```mermaid
sequenceDiagram
    participant ATT as Attendance
    participant OA as OA
    
    ATT->>OA: 发起补卡/请假申请
    OA->>OA: 审批流程
    OA-->>ATT: 回调审批结果
    ATT->>ATT: 更新考勤状态
```

**关键API**:
```
POST /api/oa/v1/workflow/attendance/apply  # 考勤申请
POST /api/attendance/v1/workflow/callback  # 审批回调
```

---

## 📋 数据流转设计

### 打卡数据流

```mermaid
flowchart LR
    A[考勤设备] -->|上报| B[设备通讯服务]
    B -->|转发| C[考勤服务]
    C -->|查询| D[排班规则]
    C -->|计算| E[考勤结果]
    E -->|存储| F[(MySQL)]
    E -->|缓存| G[(Redis)]
    C -->|异常| H[异常处理]
    H -->|审批| I[OA服务]
```

---

## 🔧 接口契约规范

| 调用方 | 被调用方 | 接口 | 超时 | 重试 |
|--------|----------|------|------|------|
| ATT | DC | receiveClockData | 2s | 3次 |
| ATT | OA | startWorkflow | 5s | 2次 |
| ACC | ATT | clockFromAccess | 1s | 2次 |

---

**📝 文档维护**: IOE-DREAM架构团队 | 2025-12-17
