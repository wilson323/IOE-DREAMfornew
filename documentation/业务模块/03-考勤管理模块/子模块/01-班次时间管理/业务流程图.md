# 班次时间管理 - 业务流程图

> **版本**: v1.0.0  
> **微服务**: ioedream-attendance-service (8091)  
> **创建日期**: 2025-12-17

---

## 📋 核心业务流程

### 1. 班次创建流程

```mermaid
flowchart TD
    A[开始] --> B[选择班次类型]
    B --> C{班次类型}
    C -->|标准班| D1[配置固定上下班时间]
    C -->|弹性班| D2[配置弹性时间范围]
    C -->|跨天班| D3[配置跨天时间段]
    
    D1 --> E[配置休息时间]
    D2 --> E
    D3 --> E
    
    E --> F[配置打卡时间窗口]
    F --> G{是否有多段休息}
    G -->|是| H[添加多段休息配置]
    G -->|否| I[验证班次配置]
    H --> I
    
    I --> J{配置是否有效}
    J -->|是| K[保存班次]
    J -->|否| L[提示错误信息]
    L --> B
    
    K --> M[生成班次代码]
    M --> N[结束]
```

### 2. 班次修改流程

```mermaid
flowchart TD
    A[开始] --> B[选择班次]
    B --> C{班次是否在使用中}
    C -->|是| D[提示影响范围]
    C -->|否| E[进入编辑模式]
    
    D --> F{确认修改}
    F -->|是| E
    F -->|否| G[取消操作]
    
    E --> H[修改班次配置]
    H --> I[验证配置有效性]
    I --> J{验证通过}
    J -->|是| K[保存修改]
    J -->|否| L[提示错误]
    L --> H
    
    K --> M{是否更新关联排班}
    M -->|是| N[更新关联排班记录]
    M -->|否| O[仅更新班次配置]
    N --> P[结束]
    O --> P
    G --> P
```

### 3. 班次时间计算流程

```mermaid
flowchart TD
    A[开始] --> B[输入班次信息]
    B --> C[获取上班时间]
    C --> D[获取下班时间]
    D --> E{是否跨天}
    
    E -->|是| F[计算跨天时长]
    E -->|否| G[计算同日时长]
    
    F --> H[获取休息时段]
    G --> H
    
    H --> I[计算总休息时长]
    I --> J[工作时长 = 总时长 - 休息时长]
    J --> K[返回计算结果]
    K --> L[结束]
```

---

## 🔄 时序图

### 班次配置时序

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as Controller
    participant S as ShiftService
    participant V as Validator
    participant D as ShiftDao
    participant Cache as Redis

    U->>C: POST /api/shifts
    C->>V: 验证请求参数
    V-->>C: 验证结果
    
    alt 验证失败
        C-->>U: 返回错误信息
    else 验证通过
        C->>S: createShift(form)
        S->>S: 生成班次代码
        S->>S: 计算工作时长
        S->>D: insert(shiftEntity)
        D-->>S: 返回ID
        S->>Cache: 清除班次缓存
        S-->>C: 返回班次ID
        C-->>U: 创建成功
    end
```

---

## 📊 状态图

### 班次状态流转

```mermaid
stateDiagram-v2
    [*] --> 草稿: 创建班次
    草稿 --> 启用: 审核通过
    草稿 --> 已删除: 删除
    启用 --> 禁用: 禁用班次
    禁用 --> 启用: 重新启用
    禁用 --> 已删除: 删除
    启用 --> 使用中: 被排班引用
    使用中 --> 启用: 无排班引用
    使用中 --> 禁用: 强制禁用
    已删除 --> [*]
```

---

## 🎯 关键控制点

| 控制点 | 说明 | 验证规则 |
|--------|------|----------|
| 时间有效性 | 上班时间必须早于下班时间（跨天除外） | work_end > work_start |
| 休息时间范围 | 休息时间必须在工作时间内 | break ∈ [work_start, work_end] |
| 打卡窗口 | 打卡窗口不能超过工作时间范围 | clock_window ≤ work_duration |
| 班次唯一性 | 班次代码必须唯一 | shift_code UNIQUE |
| 最小工时 | 弹性班必须配置最小工作时长 | flex -> min_hours NOT NULL |

---

**📝 文档维护**: IOE-DREAM架构团队 | 2025-12-17
