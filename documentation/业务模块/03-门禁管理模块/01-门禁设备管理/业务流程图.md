# 01-门禁设备管理 - 业务流程图

> **模块编号**: 01
> **模块名称**: 门禁设备管理
> **文档类型**: 业务流程图
> **创建日期**: 2025-12-17

---

## 📋 流程概述

本文档包含门禁设备管理模块的完整业务流程图，基于备份文档中的业务需求和IOE-DREAM全局架构规范，确保流程设计的完整性和一致性。

---

## 🔄 核心业务流程

### 1. 设备注册流程

#### 1.1 自动设备发现流程

```mermaid
flowchart TD
    Start([开始]) --> InitScan[启动设备扫描]
    InitScan --> SetRange{设置扫描范围}
    SetRange --> ScanNetwork[扫描网络设备]
    ScanNetwork --> DeviceFound{发现设备?}

    DeviceFound -->|是| IdentifyDevice[识别设备类型]
    DeviceFound -->|否| NoDevice[未发现设备]

    IdentifyDevice --> ValidateDevice{设备类型匹配?}
    ValidateDevice -->|是| GetDeviceInfo[获取设备信息]
    ValidateDevice -->|否| NextDevice[检查下一个设备]

    GetDeviceInfo --> ShowDeviceList[显示设备列表]
    ShowDeviceList --> SelectDevices{选择要注册的设备}

    SelectDevices -->|取消| Cancel[取消注册]
    SelectDevices -->|确认| ValidateSelection{验证选择}

    ValidateSelection --> ValidateConfig{配置验证}
    ValidateConfig -->|验证失败| ShowError[显示错误信息]
    ValidateConfig -->|验证成功| TestConnection{测试设备连接}

    TestConnection -->|连接失败| ShowConnectionError[显示连接错误]
    TestConnection -->|连接成功| RegisterDevice[注册设备]

    RegisterDevice --> SaveToDatabase[保存到数据库]
    SaveToDatabase --> AssignDeviceId[分配设备ID]
    AssignDeviceId --> InitMonitor[启动设备监控]
    InitMonitor --> RegistrationSuccess[注册成功]

    RegistrationSuccess --> End([结束])
    NextDevice --> ScanNetwork
    NoDevice --> End
    Cancel --> End
    ShowError --> End
    ShowConnectionError --> End
```

#### 1.2 手动设备添加流程

```mermaid
flowchart TD
    Start([开始]) --> EnterDeviceInfo[输入设备信息]
    EnterDeviceInfo --> ValidateInput{验证输入信息}

    ValidateInput -->|验证失败| ShowInputError[显示输入错误]
    ValidateInput -->|验证通过| SelectDeviceType[选择设备类型]

    SelectDeviceType --> LoadTemplate[加载设备模板]
    LoadTemplate --> FillForm[填写设备配置]

    FillForm --> TestConnection{测试设备连接}
    TestConnection -->|连接失败| ShowConnectionError[显示连接错误]
    TestConnection -->|连接成功| ConfirmRegistration{确认注册信息}

    ConfirmRegistration -->|取消| Cancel[取消注册]
    ConfirmRegistration -->|确认| CreateDevice[创建设备记录]

    CreateDevice --> SaveToDatabase[保存到数据库]
    SaveToDatabase --> CreateNetworkConfig[创建网络配置]
    CreateNetworkConfig --> CreateFunctionConfig[创建功能配置]

    CreateFunctionConfig --> AssignDeviceId[分配设备ID]
    AssignDeviceId --> InitMonitor[启动设备监控]
    InitMonitor --> RegistrationSuccess[注册成功]

    RegistrationSuccess --> End([结束])
    ShowInputError --> EnterDeviceInfo
    ShowConnectionError --> FillForm
    Cancel --> End
```

#### 1.3 批量设备导入流程

```mermaid
flowchart TD
    Start([开始]) --> DownloadTemplate[下载导入模板]
    DownloadTemplate --> FillTemplate[填写设备信息]

    FillTemplate --> ValidateFormat{验证文件格式}
    ValidateFormat -->|格式错误| ShowFormatError[显示格式错误]
    ValidateFormat -->|格式正确| UploadFile[上传文件]

    UploadFile --> ParseFile[解析文件数据]
    ParseFile --> ValidateData{验证数据有效性}

    ValidateData -->|数据无效| ShowDataError[显示数据错误]
    ValidateData -->|数据有效| PreviewImport[预览导入数据]

    PreviewImport --> SelectAllOrPart{选择导入方式}
    SelectAllOrPart -->|全部导入| ImportAll[导入所有设备]
    SelectAllOrPart -->|部分导入| SelectDevices[选择部分设备]

    SelectDevices --> ImportSelected[导入选中设备]

    ImportAll --> BatchRegister[批量注册设备]
    ImportSelected --> BatchRegister

    BatchRegister --> CreateDeviceRecords[创建设备记录]
    CreateDeviceRecords --> CreateConfigs[创建配置记录]
    CreateConfigs --> UpdateDatabase[更新数据库]

    UpdateDatabase --> GenerateReport[生成导入报告]
    GenerateReport --> ShowResults[显示导入结果]

    ShowResults --> ImportSuccess[导入完成]
    ImportSuccess --> End([结束])

    ShowFormatError --> FillTemplate
    ShowDataError --> FillTemplate
```

### 2. 设备配置管理流程

#### 2.1 网络配置流程

```mermaid
flowchart TD
    Start([开始]) --> SelectDevice[选择设备]
    SelectDevice --> CheckDeviceStatus{检查设备状态}

    CheckDeviceStatus -->|设备在线| GetNetworkConfig[获取当前网络配置]
    CheckDeviceStatus -->|设备离线| ShowOfflineError[设备离线提示]

    GetNetworkConfig --> ShowConfigForm[显示网络配置表单]
    ShowConfigForm --> EditConfig[编辑网络参数]

    EditConfig --> ValidateConfig{验证配置参数}
    ValidateConfig -->|验证失败| ShowValidationError[显示验证错误]
    ValidateConfig -->|验证成功| TestConnection{测试网络连接}

    TestConnection -->|连接失败| ShowTestError[显示测试错误]
    TestConnection -->|连接成功| ConfirmSave{确认保存配置}

    ConfirmSave -->|取消| Cancel[取消保存]
    ConfirmSave -->|确认| SaveConfig[保存配置]

    SaveConfig --> UpdateDatabase[更新数据库]
    UpdateDatabase --> PushToDevice{推送到设备}

    PushToDevice -->|推送失败| ShowPushError[显示推送错误]
    PushToDevice -->|推送成功| UpdateStatus[更新设备状态]

    UpdateStatus --> CreateConfigLog[创建配置日志]
    CreateConfigLog --> SaveSuccess[保存成功]

    SaveSuccess --> End([结束])
    ShowOfflineError --> End
    ShowValidationError --> EditConfig
    ShowTestError --> EditConfig
    Cancel --> End
    ShowPushError --> End
```

#### 2.2 功能配置流程

```mermaid
flowchart TD
    Start([开始]) --> SelectDevice[选择设备]
    SelectDevice --> LoadFunctionConfig[加载功能配置]

    LoadFunctionConfig --> ShowConfigTabs[显示配置标签页]
    ShowConfigTabs --> SelectConfigType{选择配置类型}

    SelectConfigType -->|门控配置| DoorControlConfig[门控配置]
    SelectConfigType -->|认证配置| AuthConfig[认证配置]
    SelectConfigType -->|安全配置| SecurityConfig[安全配置]
    SelectConfigType -->|时间配置| TimeConfig[时间配置]

    DoorControlConfig --> EditDoorParams[编辑门控参数]
    AuthConfig --> EditAuthParams[编辑认证参数]
    SecurityConfig --> EditSecurityParams[编辑安全参数]
    TimeConfig --> EditTimeParams[编辑时间参数]

    EditDoorParams --> ValidateDoorConfig{验证门控配置}
    EditAuthParams --> ValidateAuthConfig{验证认证配置}
    EditSecurityParams --> ValidateSecurityConfig{验证安全配置}
    EditTimeParams --> ValidateTimeConfig{验证时间配置}

    ValidateDoorConfig -->|验证失败| ShowDoorError[显示门控错误]
    ValidateAuthConfig -->|验证失败| ShowAuthError[显示认证错误]
    ValidateSecurityConfig -->|验证失败| ShowSecurityError[显示安全错误]
    ValidateTimeConfig -->|验证失败| ShowTimeError[显示时间错误]

    ValidateDoorConfig -->|验证成功| ValidateAllConfig{验证所有配置}
    ValidateAuthConfig -->|验证成功| ValidateAllConfig
    ValidateSecurityConfig -->|验证成功| ValidateAllConfig
    ValidateTimeConfig -->|验证成功| ValidateAllConfig

    ValidateAllConfig --> ConfirmApply{确认应用配置}
    ConfirmApply -->|取消| Cancel[取消应用]
    ConfirmApply -->|确认| ApplyConfig[应用配置]

    ApplyConfig --> SaveToDatabase[保存到数据库]
    SaveToDatabase --> SyncToDevice[同步到设备]

    SyncToDevice -->|同步失败| ShowSyncError[显示同步错误]
    SyncToDevice -->|同步成功| UpdateConfigStatus[更新配置状态]

    UpdateConfigStatus --> CreateConfigLog[创建配置日志]
    CreateConfigLog --> ApplySuccess[应用成功]

    ApplySuccess --> End([结束])
    ShowDoorError --> DoorControlConfig
    ShowAuthError --> AuthConfig
    ShowSecurityError --> SecurityConfig
    ShowTimeError --> TimeConfig
    Cancel --> End
    ShowSyncError --> End
```

### 3. 设备监控管理流程

#### 3.1 实时状态监控流程

```mermaid
flowchart TD
    Start([开始]) --> InitMonitor[初始化监控]
    InitMonitor --> StartHeartbeat[启动心跳检测]

    StartHeartbeat --> DeviceHeartbeat{设备心跳?}
    DeviceHeartbeat -->|有心跳| UpdateOnlineStatus[更新在线状态]
    DeviceHeartbeat -->|无心跳| UpdateOfflineStatus[更新离线状态]

    UpdateOnlineStatus --> CollectMetrics[收集性能指标]
    UpdateOfflineStatus --> CreateOfflineAlert[创建离线告警]

    CollectMetrics --> AnalyzeMetrics{分析性能指标}
    AnalyzeMetrics -->|正常| UpdateMonitorData[更新监控数据]
    AnalyzeMetrics -->|异常| CreatePerformanceAlert[创建性能告警]

    UpdateMonitorData --> CheckHealthStatus{检查健康状态}
    CreatePerformanceAlert --> UpdateAlertData[更新告警数据]
    CreateOfflineAlert --> UpdateAlertData

    CheckHealthStatus -->|健康| UpdateHealthScore[更新健康评分]
    CheckHealthStatus -->|警告| CreateHealthAlert[创建健康告警]

    UpdateHealthScore --> DisplayStatus[显示设备状态]
    CreateHealthAlert --> DisplayStatus
    UpdateAlertData --> DisplayStatus

    DisplayStatus --> CheckNextDevice{检查下一个设备}
    CheckNextDevice -->|是| DeviceHeartbeat
    CheckNextDevice -->|否| WaitInterval[等待监控间隔]

    WaitInterval --> DeviceHeartbeat
```

#### 3.2 健康检查流程

```mermaid
flowchart TD
    Start([开始]) --> SelectDevice[选择检查设备]
    SelectDevice --> ScheduleHealthCheck[调度健康检查]

    ScheduleHealthCheck --> NetworkTest{网络连通性测试}
    NetworkTest -->|测试成功| ResponseTest[响应性能测试]
    NetworkTest -->|测试失败| NetworkError[网络错误]

    ResponseTest -->|测试成功| FunctionTest[功能模块测试]
    ResponseTest -->|测试失败| ResponseError[响应错误]

    FunctionTest -->|测试成功| StorageTest[存储空间测试]
    FunctionTest -->|测试失败| FunctionError[功能错误]

    StorageTest -->|测试成功| BatteryTest[电池电量测试]
    StorageTest -->|测试失败| StorageError[存储错误]

    BatteryTest -->|测试成功| CalculateHealthScore[计算健康评分]
    BatteryTest -->|测试失败| BatteryError[电池错误]

    CalculateHealthScore --> DetermineHealthLevel{确定健康等级}

    NetworkError --> UpdateHealthScore[更新健康评分: 差]
    ResponseError --> UpdateHealthScore
    FunctionError --> UpdateHealthScore
    StorageError --> UpdateHealthScore
    BatteryError --> UpdateHealthScore

    UpdateHealthScore --> DetermineHealthLevel

    DetermineHealthLevel -->|优秀| HealthyLevel[健康等级: 优秀]
    DetermineHealthLevel -->|良好| GoodLevel[健康等级: 良好]
    DetermineHealthLevel -->|一般| NormalLevel[健康等级: 一般]
    DetermineHealthLevel -->|警告| WarningLevel[健康等级: 警告]
    DetermineHealthLevel -->|故障| FaultLevel[健康等级: 故障]

    HealthyLevel --> GenerateReport[生成健康报告]
    GoodLevel --> GenerateReport
    NormalLevel --> GenerateReport
    WarningLevel --> GenerateReport
    FaultLevel --> GenerateReport

    GenerateReport --> SaveHealthRecord[保存健康记录]
    SaveHealthRecord --> SendNotification[发送通知]
    SendNotification --> End([结束])
```

### 4. 设备控制管理流程

#### 4.1 远程门控流程

```mermaid
flowchart TD
    Start([开始]) --> SelectDevice[选择设备]
    SelectDevice --> CheckPermission{检查控制权限}

    CheckPermission -->|权限不足| ShowPermissionError[显示权限错误]
    CheckPermission -->|权限正常| SelectControlType{选择控制类型}

    SelectControlType -->|开门| OpenDoor[远程开门]
    SelectControlType -->|关门| CloseDoor[远程关门]
    SelectControlType -->|锁定| LockDoor[远程锁定]
    SelectControlType -->|解锁| UnlockDoor[远程解锁]

    OpenDoor --> SetOpenParams[设置开门参数]
    CloseDoor --> SetCloseParams[设置关门参数]
    LockDoor --> SetLockParams[设置锁定参数]
    UnlockDoor --> SetUnlockParams[设置解锁参数]

    SetOpenParams --> ConfirmControl{确认控制操作}
    SetCloseParams --> ConfirmControl
    SetLockParams --> ConfirmControl
    SetUnlockParams --> ConfirmControl

    ConfirmControl -->|取消| Cancel[取消操作]
    ConfirmControl -->|确认| SendControlCommand[发送控制命令]

    SendControlCommand --> ExecuteControl[执行控制操作]
    ExecuteControl --> WaitForResponse{等待设备响应}

    WaitForResponse -->|响应成功| RecordOperation[记录操作结果]
    WaitForResponse -->|响应失败| HandleControlError[处理控制错误]

    RecordOperation --> UpdateDeviceStatus[更新设备状态]
    HandleControlError --> LogError[记录错误日志]

    UpdateDeviceStatus --> CreateAuditLog[创建审计日志]
    LogError --> CreateAuditLog

    CreateAuditLog --> NotifySuccess[通知操作成功]
    NotifySuccess --> End([结束])

    ShowPermissionError --> End
    Cancel --> End
    LogError --> End
```

#### 4.2 固件升级流程

```mermaid
flowchart TD
    Start([开始]) --> SelectDevice[选择设备]
    SelectDevice --> CheckUpgradeCondition{检查升级条件}

    CheckUpgradeCondition -->|条件不满足| ShowConditionError[显示条件错误]
    CheckUpgradeCondition -->|条件满足| SelectFirmware[选择固件版本]

    SelectFirmware --> ValidateFirmware{验证固件文件}
    ValidateFirmware -->|验证失败| ShowFirmwareError[显示固件错误]
    ValidateFirmware -->|验证成功| CreateUpgradePlan[创建升级计划]

    CreateUpgradePlan --> CheckDeviceStatus{检查设备状态}
    CheckDeviceStatus -->|设备忙碌| ShowBusyError[设备忙碌错误]
    CheckDeviceStatus -->|设备空闲| BackupDevice[备份当前固件]

    BackupDevice -->|备份失败| ShowBackupError[显示备份错误]
    BackupDevice -->|备份成功| StartUpgrade[开始升级]

    StartUpgrade --> UploadFirmware[上传固件文件]
    UploadFirmware --> VerifyUpload{验证上传}

    VerifyUpload -->|验证失败| ShowUploadError[显示上传错误]
    VerifyUpload -->|验证成功| InstallFirmware[安装固件]

    InstallFirmware --> MonitorProgress[监控升级进度]
    MonitorProgress --> CheckUpgradeResult{检查升级结果}

    CheckUpgradeResult -->|升级失败| RollbackFirmware[回滚固件]
    CheckUpgradeResult -->|升级成功| VerifyFirmware[验证新固件]

    RollbackFirmware --> RestoreBackup[恢复备份]
    RestoreBackup --> UpdateUpgradeStatus[更新升级状态: 失败]

    VerifyFirmware -->|验证失败| RollbackFirmware
    VerifyFirmware -->|验证成功| UpdateFirmwareInfo[更新固件信息]

    UpdateUpgradeStatus --> CreateUpgradeLog[创建升级日志]
    UpdateFirmwareInfo --> CreateUpgradeLog

    CreateUpgradeLog --> NotifyUpgradeResult[通知升级结果]
    NotifyUpgradeResult --> End([结束])

    ShowConditionError --> End
    ShowFirmwareError --> End
    ShowBusyError --> End
    ShowBackupError --> End
    ShowUploadError --> End
    UpdateUpgradeStatus --> End
```

### 5. 设备维护管理流程

#### 5.1 预防性维护流程

```mermaid
flowchart TD
    Start([开始]) --> CheckMaintenanceSchedule[检查维护计划]
    CheckMaintenanceSchedule --> GenerateMaintenanceList[生成维护清单]

    GenerateMaintenanceList --> AssignMaintenancePersonnel[分派维护人员]
    AssignMaintenancePersonnel --> NotifyPersonnel[通知维护人员]

    NotifyPersonnel --> ScheduleMaintenance[安排维护时间]
    ScheduleMaintenance --> PrepareMaintenance[准备维护资源]

    PrepareMaintenance --> StartMaintenance[开始维护]
    StartMaintenance --> ExecuteMaintenance{执行维护}

    ExecuteMaintenance -->|清洁保养| CleaningMaintenance[清洁维护]
    ExecuteMaintenance -->|功能测试| FunctionTest[功能测试]
    ExecuteMaintenance -->|部件检查| PartInspection[部件检查]
    ExecuteMaintenance -->|参数校准| ParameterCalibration[参数校准]

    CleaningMaintenance --> RecordMaintenance[记录维护内容]
    FunctionTest --> RecordMaintenance
    PartInspection --> RecordMaintenance
    ParameterCalibration --> RecordMaintenance

    RecordMaintenance --> QualityCheck{质量检查}
    QualityCheck -->|检查不通过| RectifyDefects[整改缺陷]
    QualityCheck -->|检查通过| CompleteMaintenance[完成维护]

    RectifyDefects --> RecheckQuality[重新检查]
    RecheckQuality --> QualityCheck

    CompleteMaintenance --> UpdateMaintenanceStatus[更新维护状态]
    UpdateMaintenanceStatus --> GenerateMaintenanceReport[生成维护报告]

    GenerateMaintenanceReport --> SaveMaintenanceRecord[保存维护记录]
    SaveMaintenanceRecord --> UpdateDeviceStatus[更新设备状态]
    UpdateDeviceStatus --> ScheduleNextMaintenance[安排下次维护]

    ScheduleNextMaintenance --> NotifyMaintenanceResult[通知维护结果]
    NotifyMaintenanceResult --> End([结束])
```

---

## 🎯 流程关键控制点

### 1. 设备注册控制点

1. **设备类型验证**: 确保只有支持的设备类型才能注册
2. **网络连接测试**: 注册前必须验证网络连接正常
3. **配置数据验证**: 所有配置数据必须符合规范要求
4. **权限检查**: 只有授权用户才能执行设备注册

### 2. 设备配置控制点

1. **配置参数验证**: 所有配置参数必须通过有效性验证
2. **设备状态检查**: 配置前检查设备在线状态
3. **配置同步确认**: 配置必须成功同步到设备
4. **操作日志记录**: 所有配置操作必须记录审计日志

### 3. 设备监控控制点

1. **心跳检测**: 定期检测设备心跳状态
2. **性能指标采集**: 实时采集设备性能指标
3. **异常状态识别**: 及时识别设备异常状态
4. **告警通知**: 关键异常必须及时通知相关人员

### 4. 设备控制控制点

1. **权限验证**: 严格控制设备操作权限
2. **操作确认**: 重要操作需要二次确认
3. **状态同步**: 控制操作后必须同步设备状态
4. **审计记录**: 所有控制操作必须记录完整日志

---

## 📊 流程性能指标

### 响应时间指标

| 流程类型 | 目标响应时间 | 测量方法 |
|---------|-------------|---------|
| 设备注册 | ≤30秒 | 从开始到注册完成 |
| 配置更新 | ≤10秒 | 从保存到设备生效 |
| 状态监控 | ≤5秒 | 状态变更到系统显示 |
| 远程控制 | ≤500ms | 从发送到设备响应 |

### 成功率指标

| 流程类型 | 目标成功率 | 计算方法 |
|---------|------------|---------|
| 设备注册 | ≥99% | 成功注册/总注册数 |
| 配置同步 | ≥99.5% | 成功同步/总配置数 |
| 设备发现 | ≥95% | 发现设备/总设备数 |
| 固件升级 | ≥98% | 成功升级/总升级数 |

---

## 📚 相关文档

- [功能说明](./功能说明.md)
- [用户故事](./用户故事.md)
- [数据结构设计](./数据结构设计.md)
- [API接口设计](./API接口设计.md)
- [验收测试用例](./验收测试用例.md)

---

**📝 文档信息**
- **创建人**: 门禁设备管理模块组
- **审核人**: 业务流程设计师
- **最后更新**: 2025-12-17
- **版本**: v1.0.0