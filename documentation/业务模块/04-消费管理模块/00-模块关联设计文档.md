# 消费管理模块 - 模块间关联设计文档

> **版本**: v1.0.0  
> **微服务**: ioedream-consume-service (8094)  
> **创建日期**: 2025-12-17

---

## 📊 模块关联全景图

```mermaid
graph TB
    subgraph 消费微服务内部模块
        AREA[01-区域管理]
        MEAL[02-餐别分类]
        ACCOUNT[03-账户类别]
        PERM[04-区域权限]
        CONSUME[05-消费处理]
        RECHARGE[06-充值退款]
        SUBSIDY[07-补贴管理]
    end
    
    subgraph 外部微服务
        GW[Gateway:8080]
        CMN[Common:8088]
        DC[DeviceComm:8087]
        OA[OA:8089]
    end
    
    %% 内部关联
    AREA --> PERM
    AREA --> CONSUME
    MEAL --> CONSUME
    ACCOUNT --> CONSUME
    ACCOUNT --> RECHARGE
    ACCOUNT --> SUBSIDY
    PERM --> CONSUME
    RECHARGE --> ACCOUNT
    SUBSIDY --> ACCOUNT
    
    %% 外部关联
    CONSUME <--> DC
    RECHARGE <--> OA
    SUBSIDY --> CMN
```

---

## 🔗 内部模块关联详细设计

### 1. 账户类别 ↔ 消费处理

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 余额查询 | 消费前查询账户余额 | ACCOUNT → CONSUME |
| 余额扣减 | 消费成功扣减余额 | CONSUME → ACCOUNT |
| 消费限额 | 按账户类型控制消费限额 | ACCOUNT → CONSUME |

**关键接口**:
```java
// AccountService.java
AccountBalanceVO getBalance(Long userId, String accountType);
void deductBalance(Long userId, BigDecimal amount, String consumeNo);

// ConsumeService.java
ConsumeResultVO processConsume(ConsumeRequestDTO request);
```

### 2. 区域权限 ↔ 消费处理

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 权限校验 | 消费前校验区域权限 | PERM → CONSUME |
| 餐别限制 | 按区域控制餐别 | PERM → CONSUME |

**关键接口**:
```java
// ConsumePermissionService.java
Boolean checkConsumePermission(Long userId, Long areaId, String mealType);
```

### 3. 充值退款 ↔ 账户类别

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 充值入账 | 充值成功增加余额 | RECHARGE → ACCOUNT |
| 退款扣减 | 退款成功扣减余额 | RECHARGE → ACCOUNT |
| 流水记录 | 记录账户变动流水 | RECHARGE → ACCOUNT |

**关键接口**:
```java
// RechargeService.java
RechargeResultVO recharge(RechargeForm form);
RefundResultVO refund(RefundForm form);

// AccountService.java
void addBalance(Long userId, BigDecimal amount, String tradeNo);
```

### 4. 补贴管理 ↔ 账户类别

| 关联点 | 说明 | 数据流向 |
|--------|------|----------|
| 补贴发放 | 补贴入账到指定账户 | SUBSIDY → ACCOUNT |
| 批量发放 | 按部门/人员批量发放 | SUBSIDY → ACCOUNT |

**关键接口**:
```java
// SubsidyService.java
void grantSubsidy(SubsidyGrantForm form);
void batchGrantSubsidy(BatchSubsidyForm form);
```

---

## 🌐 外部微服务关联设计

### 1. 消费服务 ↔ 设备通讯服务 (8087)

```mermaid
sequenceDiagram
    participant DEV as 消费设备
    participant DC as DeviceComm
    participant CON as Consume
    
    DEV->>DC: 上报消费请求
    DC->>CON: 转发消费请求
    CON->>CON: 权限校验
    CON->>CON: 余额校验
    CON->>CON: 执行扣款
    CON-->>DC: 返回消费结果
    DC-->>DEV: 显示消费结果
```

**关键API**:
```
POST /api/consume/v1/transaction/process  # 处理消费
POST /api/consume/v1/device/sync          # 同步设备配置
```

### 2. 消费服务 ↔ OA服务 (8089)

```mermaid
sequenceDiagram
    participant CON as Consume
    participant OA as OA
    
    CON->>OA: 发起退款申请
    OA->>OA: 审批流程
    OA-->>CON: 回调审批结果
    CON->>CON: 执行退款
```

**关键API**:
```
POST /api/oa/v1/workflow/refund/apply  # 退款申请
POST /api/consume/v1/workflow/callback # 审批回调
```

---

## 📋 数据流转设计

### 消费数据流

```mermaid
flowchart LR
    A[消费设备] -->|请求| B[设备通讯服务]
    B -->|转发| C[消费服务]
    C -->|校验| D[权限/余额]
    D -->|扣款| E[账户服务]
    E -->|记录| F[(MySQL)]
    C -->|流水| F
    C -->|缓存| G[(Redis)]
```

---

## 🔧 接口契约规范

| 调用方 | 被调用方 | 接口 | 超时 | 重试 |
|--------|----------|------|------|------|
| CON | DC | processConsume | 3s | 0次 |
| CON | OA | startRefundWorkflow | 5s | 2次 |
| CMN | CON | grantSubsidy | 10s | 3次 |

---

**📝 文档维护**: IOE-DREAM架构团队 | 2025-12-17
