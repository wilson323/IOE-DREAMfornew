# 消费管理模块 - 功能说明

> **版本**: v2.0.0  
> **更新日期**: 2025-12-17

---

## 1. 模块概述

消费管理模块是IOE-DREAM智慧园区一卡通平台的核心业务模块，提供完整的消费场景解决方案。

### 1.1 核心定位

- **业务定位**: 园区一卡通消费管理平台
- **技术定位**: 高并发、高可用的微服务架构
- **安全定位**: 满足三级等保要求的资金安全体系

### 1.2 核心能力

| 能力 | 说明 |
|------|------|
| 多经营模式 | 餐别制、超市制、混合模式 |
| 多消费模式 | 6种核心消费模式 |
| 多支付方式 | 余额、补贴、混合支付 |
| 离线消费 | 支持网络中断场景 |
| 实时统计 | 消费数据实时汇总 |

---

## 2. 功能模块

### 2.1 区域管理

**功能描述**: 统一区域管理，支持多级层级结构

**核心功能**:
- 区域CRUD操作
- 多级区域层级（园区→楼栋→楼层→区域）
- 区域类型管理（餐饮/商店/办公/医疗）
- 区域经营模式配置
- 区域餐别分类配置

**区域类型**:

| 类型 | type值 | 细分类型 |
|------|--------|----------|
| 餐饮 | 1 | 食堂、餐厅、快餐店、咖啡厅 |
| 商店 | 2 | 超市、便利店、专卖店 |
| 办公 | 3 | 办公区域 |
| 医疗 | 4 | 医疗区域 |

### 2.2 餐别分类管理

**功能描述**: 二级餐别分类体系，支持分类级别权限控制

**核心功能**:
- 餐别分类CRUD（早餐/午餐/晚餐/夜宵等）
- 具体餐别管理
- 时间窗口配置
- 价格规则配置

**分类体系**:
```
餐别分类（大类）
├── 早餐分类
│   ├── 普通早餐
│   └── 营养早餐
├── 午餐分类
│   ├── 工作餐
│   └── 商务餐
└── 晚餐分类
    ├── 普通晚餐
    └── 特色晚餐
```

### 2.3 账户类别管理

**功能描述**: 账户类别与消费模式配置

**核心功能**:
- 账户类别CRUD
- 消费模式配置（mode_config）
- 区域权限配置（area_config）
- 折扣规则配置
- 限额控制配置

**配置项**:

| 配置项 | 说明 |
|--------|------|
| mode_config | 消费模式参数配置 |
| area_config | 可用区域权限配置 |
| discount_type | 折扣类型 |
| date_max_money | 每日限额 |
| date_max_count | 每日限次 |

### 2.4 消费处理

**功能描述**: 核心消费流程处理

**核心功能**:
- 身份识别（刷卡/刷脸/扫码）
- 权限验证
- 金额计算
- 余额扣除
- 交易记录
- SAGA分布式事务

**消费流程**:
1. 身份识别 → 2. 权限验证 → 3. 场景识别 → 4. 金额计算 → 5. 余额扣除 → 6. 记录交易 → 7. 打印小票

### 2.5 订餐管理

**功能描述**: 订餐预约与取餐管理

**核心功能**:
- 菜品管理
- 订餐预约
- 取餐核销
- 订餐统计

### 2.6 充值退款

**功能描述**: 资金管理

**核心功能**:
- 多渠道充值（微信/支付宝/现金/转账）
- 退款申请与审核
- 资金流水记录
- 对账管理

### 2.7 补贴管理

**功能描述**: 补贴发放与使用

**核心功能**:
- 补贴类型管理
- 补贴发放（按人员/部门/卡类）
- 补贴使用（优先级扣款）
- 补贴清零策略

**补贴类型**:

| 类型 | 清零策略 | 使用范围 |
|------|----------|----------|
| 餐补 | 月末清零 | 食堂专用 |
| 交通补贴 | 不清零 | 指定区域 |
| 通用补贴 | 年末清零 | 全区域 |
| 节日补贴 | 60天有效 | 全区域 |

### 2.8 离线消费

**功能描述**: 离线消费与同步

**核心功能**:
- 离线名单下发
- 离线消费处理
- 数据同步上传
- 冲突处理

### 2.9 商品管理

**功能描述**: 商品与库存管理

**核心功能**:
- 商品CRUD
- 商品分类管理
- 库存管理
- 进销存报表

### 2.10 报表统计

**功能描述**: 消费报表与分析

**核心功能**:
- 消费汇总报表
- 区域消费统计
- 账户消费分析
- 趋势分析

### 2.11 设备管理

**功能描述**: 消费设备管理

**核心功能**:
- 设备CRUD
- 设备区域绑定
- 设备状态监控
- 设备参数配置

---

## 3. 业务场景

### 3.1 食堂消费场景

**场景描述**: 员工在食堂刷卡消费

**业务流程**:
1. 员工刷卡/刷脸
2. 系统识别身份，获取账户类别
3. 根据区域经营模式判断消费方式
4. 餐别制：按定值扣款
5. 超市制：扫码商品计价
6. 优先扣除补贴，不足扣现金
7. 生成消费流水

### 3.2 超市购物场景

**场景描述**: 员工在超市购物

**业务流程**:
1. 员工选购商品
2. 收银员扫描商品条码
3. 系统累计商品总额
4. 员工刷卡支付
5. 扣除余额，扣减库存
6. 打印小票

### 3.3 订餐取餐场景

**场景描述**: 员工提前订餐，到店取餐

**业务流程**:
1. 员工通过APP订餐
2. 选择菜品，确认订单
3. 扣除餐费，生成订餐记录
4. 到店刷卡取餐
5. 系统核销订餐记录

---

## 4. 性能指标

| 指标 | 目标值 |
|------|--------|
| 消费TPS | 2000+ |
| 平均响应时间 | <50ms |
| P99响应时间 | <150ms |
| 系统可用性 | 99.9% |
| 数据一致性 | 100% |

---

*本文档持续更新中*

