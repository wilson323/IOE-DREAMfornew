# 消费管理模块 - 业务流程图

> **版本**: v2.0.0  
> **更新日期**: 2025-12-17

---

## 1. 消费处理核心流程

```
消费请求 --> 身份识别 --> 账户验证 --> 区域权限 --> 消费模式判断
                                                        |
            +-------------------------------------------+
            |           |           |           |
          定值       自由金额     商品       计量
            |           |           |           |
            +-------------------------------------------+
                                |
                            余额检查
                                |
                    +-----------+-----------+
                    |                       |
                  足够                    不足
                    |                       |
                扣款处理              余额不足拒绝
                    |
              生成交易记录
                    |
                更新统计
                    |
                返回结果
```

---

## 2. 充值流程

```
充值请求 --> 支付方式选择
                |
    +-----------+-----------+-----------+
    |           |           |           |
  现金        微信/支付宝   银行卡       转账
    |           |           |           |
    |       创建支付订单     |           |
    |           |           |           |
    |       调用支付渠道     |           |
    |           |           |           |
    +-----------+-----------+-----------+
                |
            支付结果
                |
        +-------+-------+
        |               |
      成功            失败
        |               |
    更新账户余额    标记失败
        |
    计算赠送金额
        |
    记录资金流水
        |
    发送通知
```

---

## 3. 退款流程

```
退款申请 --> 审批流程
                |
        +-------+-------+
        |               |
      通过            拒绝
        |               |
    退款方式选择     退款失败
        |
    +---+---+---+
    |   |   |   |
  原路 余额 现金 银行
    |   |   |   |
    +---+---+---+
        |
    更新账户
        |
    记录资金流水
```

---

## 4. 补贴发放流程

```
补贴发放请求 --> 发放类型
                    |
            +-------+-------+
            |               |
        定期发放        临时发放
            |               |
            +-------+-------+
                    |
              获取发放人员
                    |
              补贴账户检查
                    |
            +-------+-------+
            |               |
          存在          不存在
            |               |
            |         创建补贴账户
            |               |
            +-------+-------+
                    |
              增加补贴余额
                    |
              记录发放流水
                    |
              更新统计
```

---

## 5. 消费扣款优先级

```
消费金额 --> 检查补贴账户
                |
        +-------+-------+
        |               |
      有补贴          无补贴
        |               |
    按优先级扣补贴      |
        |               |
    补贴是否足够?       |
        |               |
    +---+---+           |
    |       |           |
  足够    不足          |
    |       |           |
  全额    混合扣除      |
    |       |           |
    +-------+-----------+
            |
        扣现金余额
            |
        完成扣款
```

---

## 6. SAGA分布式事务流程

```
消费事务开始
    |
    v
[1] 账户冻结 --> 成功 --> [2] 余额扣减 --> 成功 --> [3] 交易记录 --> 成功 --> 事务提交
    |                         |                         |
  失败                      失败                      失败
    |                         |                         |
    v                         v                         v
  回滚                   解冻账户                 解冻+回滚余额
    |                         |                         |
    +-------------------------+-------------------------+
                              |
                          事务回滚
```

---

*本文档持续更新中*

