# è¡¥è´´ç®¡ç† - æ•°æ®ç»“æ„è®¾è®¡

> **ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“Š ERå›¾

```mermaid
erDiagram
    t_consume_subsidy_plan {
        bigint id PK "æ–¹æ¡ˆID"
        varchar plan_name "æ–¹æ¡ˆåç§°"
        varchar plan_code "æ–¹æ¡ˆç¼–ç "
        varchar subsidy_type "è¡¥è´´ç±»å‹"
        decimal amount "è¡¥è´´é‡‘é¢"
        varchar grant_cycle "å‘æ”¾å‘¨æœŸ"
        varchar target_type "å‘æ”¾å¯¹è±¡ç±»å‹"
        varchar target_ids "å‘æ”¾å¯¹è±¡IDs"
        datetime valid_start "æœ‰æ•ˆæœŸå¼€å§‹"
        datetime valid_end "æœ‰æ•ˆæœŸç»“æŸ"
        tinyint status "çŠ¶æ€"
    }
    
    t_consume_subsidy_record {
        bigint id PK "è®°å½•ID"
        bigint plan_id FK "æ–¹æ¡ˆID"
        bigint account_id FK "è´¦æˆ·ID"
        bigint user_id FK "ç”¨æˆ·ID"
        decimal amount "è¡¥è´´é‡‘é¢"
        decimal used_amount "å·²ç”¨é‡‘é¢"
        decimal remain_amount "å‰©ä½™é‡‘é¢"
        datetime grant_time "å‘æ”¾æ—¶é—´"
        datetime expire_time "è¿‡æœŸæ—¶é—´"
        tinyint status "çŠ¶æ€"
    }
    
    t_consume_subsidy_use {
        bigint id PK "ä½¿ç”¨ID"
        bigint subsidy_id FK "è¡¥è´´ID"
        bigint transaction_id FK "æ¶ˆè´¹äº¤æ˜“ID"
        decimal amount "ä½¿ç”¨é‡‘é¢"
        datetime use_time "ä½¿ç”¨æ—¶é—´"
    }
    
    t_consume_subsidy_plan ||--o{ t_consume_subsidy_record : "å‘æ”¾"
    t_consume_subsidy_record ||--o{ t_consume_subsidy_use : "ä½¿ç”¨"
```

---

## ğŸ“‹ è¡¨ç»“æ„è¯¦ç»†è®¾è®¡

### t_consume_subsidy_plan (è¡¥è´´æ–¹æ¡ˆè¡¨)

```sql
CREATE TABLE t_consume_subsidy_plan (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æ–¹æ¡ˆID',
    plan_name VARCHAR(100) NOT NULL COMMENT 'æ–¹æ¡ˆåç§°',
    plan_code VARCHAR(50) NOT NULL COMMENT 'æ–¹æ¡ˆç¼–ç ',
    subsidy_type VARCHAR(20) NOT NULL COMMENT 'è¡¥è´´ç±»å‹:MEAL/TRANSPORT/WELFARE',
    amount DECIMAL(10,2) NOT NULL COMMENT 'è¡¥è´´é‡‘é¢',
    grant_cycle VARCHAR(20) NOT NULL COMMENT 'å‘æ”¾å‘¨æœŸ:DAILY/WEEKLY/MONTHLY/ONCE',
    grant_day INT COMMENT 'å‘æ”¾æ—¥(æœˆåº¦:1-28,å‘¨åº¦:1-7)',
    grant_time TIME DEFAULT '00:00:00' COMMENT 'å‘æ”¾æ—¶é—´',
    target_type VARCHAR(20) NOT NULL COMMENT 'å¯¹è±¡ç±»å‹:ALL/DEPT/EMPLOYEE/ACCOUNT_KIND',
    target_ids TEXT COMMENT 'å¯¹è±¡IDs,é€—å·åˆ†éš”',
    area_limit TEXT COMMENT 'åŒºåŸŸé™åˆ¶JSON',
    meal_limit TEXT COMMENT 'é¤åˆ«é™åˆ¶JSON',
    valid_start DATETIME COMMENT 'æœ‰æ•ˆæœŸå¼€å§‹',
    valid_end DATETIME COMMENT 'æœ‰æ•ˆæœŸç»“æŸ',
    expire_days INT DEFAULT 30 COMMENT 'åˆ°æœŸå¤©æ•°(å‘æ”¾åå¤šå°‘å¤©è¿‡æœŸ)',
    carry_over TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å…è®¸ç»“è½¬:0å¦1æ˜¯',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:0ç¦ç”¨1å¯ç”¨',
    remark VARCHAR(500) COMMENT 'å¤‡æ³¨',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_plan_code (plan_code),
    INDEX idx_status (status),
    INDEX idx_grant_cycle (grant_cycle)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è¡¥è´´æ–¹æ¡ˆè¡¨';
```

### t_consume_subsidy_record (è¡¥è´´å‘æ”¾è®°å½•è¡¨)

```sql
CREATE TABLE t_consume_subsidy_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®°å½•ID',
    plan_id BIGINT NOT NULL COMMENT 'æ–¹æ¡ˆID',
    plan_name VARCHAR(100) COMMENT 'æ–¹æ¡ˆåç§°',
    account_id BIGINT NOT NULL COMMENT 'è´¦æˆ·ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    user_name VARCHAR(50) COMMENT 'ç”¨æˆ·å§“å',
    amount DECIMAL(10,2) NOT NULL COMMENT 'è¡¥è´´é‡‘é¢',
    used_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT 'å·²ä½¿ç”¨é‡‘é¢',
    remain_amount DECIMAL(10,2) NOT NULL COMMENT 'å‰©ä½™é‡‘é¢',
    grant_time DATETIME NOT NULL COMMENT 'å‘æ”¾æ—¶é—´',
    expire_time DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    period VARCHAR(20) COMMENT 'å‘æ”¾å‘¨æœŸæ ‡è¯†(å¦‚:2025-12)',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€:0å·²è¿‡æœŸ1å¯ç”¨2å·²ç”¨å®Œ',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_account_id (account_id),
    INDEX idx_user_id (user_id),
    INDEX idx_plan_id (plan_id),
    INDEX idx_status_expire (status, expire_time),
    INDEX idx_grant_time (grant_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è¡¥è´´å‘æ”¾è®°å½•è¡¨';
```

### t_consume_subsidy_use (è¡¥è´´ä½¿ç”¨æ˜ç»†è¡¨)

```sql
CREATE TABLE t_consume_subsidy_use (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä½¿ç”¨ID',
    subsidy_id BIGINT NOT NULL COMMENT 'è¡¥è´´è®°å½•ID',
    transaction_id BIGINT NOT NULL COMMENT 'æ¶ˆè´¹äº¤æ˜“ID',
    trade_no VARCHAR(32) NOT NULL COMMENT 'äº¤æ˜“æµæ°´å·',
    amount DECIMAL(10,2) NOT NULL COMMENT 'ä½¿ç”¨é‡‘é¢',
    balance_before DECIMAL(10,2) NOT NULL COMMENT 'ä½¿ç”¨å‰ä½™é¢',
    balance_after DECIMAL(10,2) NOT NULL COMMENT 'ä½¿ç”¨åä½™é¢',
    use_time DATETIME NOT NULL COMMENT 'ä½¿ç”¨æ—¶é—´',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_subsidy_id (subsidy_id),
    INDEX idx_transaction_id (transaction_id),
    INDEX idx_use_time (use_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è¡¥è´´ä½¿ç”¨æ˜ç»†è¡¨';
```

---

## ğŸ”§ è¡¥è´´æ‰£æ¬¾é€»è¾‘

### æ‰£æ¬¾ä¼˜å…ˆçº§æ’åº

```sql
-- è¡¥è´´æ‰£æ¬¾é¡ºåºï¼šæœ‰æ•ˆæœŸæœ€è¿‘ä¼˜å…ˆï¼Œé‡‘é¢å°ä¼˜å…ˆ
SELECT * FROM t_consume_subsidy_record
WHERE account_id = #{accountId}
  AND status = 1
  AND remain_amount > 0
  AND expire_time > NOW()
ORDER BY expire_time ASC, remain_amount ASC;
```

### è¡¥è´´ä½¿ç”¨é™åˆ¶æ£€æŸ¥

```json
{
  "areaLimit": [100, 101, 102],
  "mealLimit": ["BREAKFAST", "LUNCH", "DINNER"],
  "minAmount": 10.00
}
```

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
