# æ¶ˆè´¹å¤„ç† - è¯¦ç»†è®¾è®¡

> **ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“Š ç±»ç»“æ„è®¾è®¡

```mermaid
classDiagram
    class ConsumeTransactionController {
        +process(form: ConsumeForm): ResponseDTO
        +cancel(form: CancelForm): ResponseDTO
        +queryRecords(form: QueryForm): ResponseDTO
        +getDetail(id: Long): ResponseDTO
    }
    
    class ConsumeTransactionService {
        <<interface>>
        +processConsume(form: ConsumeForm): ConsumeResultVO
        +cancelConsume(form: CancelForm): void
        +queryRecords(form: QueryForm): PageResult
    }
    
    class ConsumeTransactionServiceImpl {
        -accountService: AccountService
        -permissionService: ConsumePermissionService
        -limitService: ConsumeLimitService
        -recordDao: ConsumeRecordDao
        +processConsume(form: ConsumeForm): ConsumeResultVO
    }
    
    class AccountService {
        +getBalance(userId: Long): BigDecimal
        +deductBalance(userId: Long, amount: BigDecimal): void
        +addBalance(userId: Long, amount: BigDecimal): void
    }
    
    class ConsumeLimitService {
        +checkLimit(userId: Long, amount: BigDecimal): LimitCheckResult
        +updateUsedAmount(userId: Long, amount: BigDecimal): void
    }
    
    ConsumeTransactionController --> ConsumeTransactionService
    ConsumeTransactionServiceImpl ..|> ConsumeTransactionService
    ConsumeTransactionServiceImpl --> AccountService
    ConsumeTransactionServiceImpl --> ConsumeLimitService
```

---

## ğŸ”§ æ ¸å¿ƒç®—æ³•

### æ¶ˆè´¹æ‰£æ¬¾äº‹åŠ¡

```java
@Transactional(rollbackFor = Exception.class)
public ConsumeResultVO processConsume(ConsumeForm form) {
    // 1. å¹‚ç­‰æ€§æ£€æŸ¥
    if (recordDao.existsByTradeNo(form.getTradeNo())) {
        return getExistingResult(form.getTradeNo());
    }
    
    // 2. åŠ é”é˜²æ­¢å¹¶å‘
    String lockKey = "consume:user:" + form.getUserId();
    RLock lock = redissonClient.getLock(lockKey);
    try {
        lock.lock(5, TimeUnit.SECONDS);
        
        // 3. æƒé™æ ¡éªŒ
        checkPermission(form.getUserId(), form.getAreaId());
        
        // 4. ä½™é¢æ ¡éªŒ
        BigDecimal balance = accountService.getBalance(form.getUserId());
        if (balance.compareTo(form.getAmount()) < 0) {
            throw new BusinessException("ä½™é¢ä¸è¶³");
        }
        
        // 5. é™é¢æ ¡éªŒ
        LimitCheckResult limitResult = limitService.checkLimit(
            form.getUserId(), form.getAmount());
        if (!limitResult.isAllowed()) {
            throw new BusinessException(limitResult.getReason());
        }
        
        // 6. æ‰§è¡Œæ‰£æ¬¾
        accountService.deductBalance(form.getUserId(), form.getAmount());
        
        // 7. è®°å½•æµæ°´
        ConsumeRecordEntity record = buildRecord(form, balance);
        recordDao.insert(record);
        
        // 8. æ›´æ–°é™é¢ç»Ÿè®¡
        limitService.updateUsedAmount(form.getUserId(), form.getAmount());
        
        return buildSuccessResult(record);
    } finally {
        lock.unlock();
    }
}
```

---

## ğŸ“‹ APIæ¥å£è®¾è®¡

### æ¶ˆè´¹æ‰£æ¬¾

```
POST /api/consume/v1/transaction/process
```

**è¯·æ±‚**:
```json
{
  "tradeNo": "CON20251217100001",
  "userId": 1001,
  "areaId": 100,
  "deviceSn": "CON-001",
  "amount": 15.50,
  "consumeType": "FACE",
  "mealType": "LUNCH"
}
```

**å“åº”**:
```json
{
  "code": 0,
  "data": {
    "tradeNo": "CON20251217100001",
    "amount": 15.50,
    "balanceBefore": 200.00,
    "balanceAfter": 184.50,
    "consumeTime": "2025-12-17 12:30:00"
  }
}
```

### æ¶ˆè´¹æ’¤é”€

```
POST /api/consume/v1/transaction/cancel
```

**è¯·æ±‚**:
```json
{
  "tradeNo": "CON20251217100001",
  "reason": "è¯¯æ“ä½œ"
}
```

### æ¶ˆè´¹è®°å½•æŸ¥è¯¢

```
GET /api/consume/v1/transaction/records
```

**è¯·æ±‚å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| userId | Long | å¦ | ç”¨æˆ·ID |
| areaId | Long | å¦ | åŒºåŸŸID |
| startTime | String | å¦ | å¼€å§‹æ—¶é—´ |
| endTime | String | å¦ | ç»“æŸæ—¶é—´ |
| pageNum | Integer | æ˜¯ | é¡µç  |
| pageSize | Integer | æ˜¯ | æ¯é¡µæ¡æ•° |

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ä½™é¢ç¼“å­˜**: Redisç¼“å­˜è´¦æˆ·ä½™é¢ï¼Œå‡å°‘DBæŸ¥è¯¢
2. **åˆ†å¸ƒå¼é”**: Redissoné˜²æ­¢å¹¶å‘æ‰£æ¬¾
3. **å¹‚ç­‰è®¾è®¡**: tradeNoå”¯ä¸€ç´¢å¼•é˜²æ­¢é‡å¤æ¶ˆè´¹
4. **å¼‚æ­¥è®°å½•**: æ¶ˆè´¹æˆåŠŸåå¼‚æ­¥å†™å…¥ç»Ÿè®¡è¡¨

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
