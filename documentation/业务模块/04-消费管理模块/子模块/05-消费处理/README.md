# 消费处理模块

> **版本**: v2.0.0  
> **更新日期**: 2025-12-17

---

## 1. 功能说明

统一的7步消费处理流程，支持SAGA分布式事务。

### 7步处理流程

1. 身份识别与账户验证
2. 区域权限验证
3. 消费模式判断
4. 金额计算
5. 余额检查与扣款
6. 交易记录生成
7. 统计更新与通知

---

## 2. 用户故事

| 角色 | 故事 |
|------|------|
| 消费者 | 刷卡/刷脸完成消费 |
| 系统 | 自动判断消费模式并扣款 |
| 系统 | 生成完整交易记录 |

---

## 3. 消费模式判断

```
餐别制区域 --> 定值/自由金额/订餐
超市制区域 --> 商品/自由金额/计量
混合区域 --> 根据设备模式判断
```

---

## 4. SAGA事务流程

| 步骤 | 正向操作 | 补偿操作 |
|------|----------|----------|
| 1 | 冻结账户 | 解冻账户 |
| 2 | 扣减余额 | 回滚余额 |
| 3 | 创建交易 | 标记作废 |

---

## 5. 并发控制

- 乐观锁：版本号控制
- 分布式锁：Redis锁
- 幂等性：交易号唯一

---

*本文档持续更新中*

