# æ¶ˆè´¹ç®¡ç†å¾®æœåŠ¡ - æ€»ä½“è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.1.0 - ä¸­å¿ƒå®æ—¶éªŒè¯æ¨¡å¼  
> **å¾®æœåŠ¡**: ioedream-consume-service (8094)  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17  
> **è®¾å¤‡äº¤äº’æ¨¡å¼**: ä¸­å¿ƒå®æ—¶éªŒè¯æ¨¡å¼ï¼ˆMode 2ï¼‰

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

æ¶ˆè´¹ç®¡ç†å¾®æœåŠ¡è´Ÿè´£ä¼ä¸šå†…éƒ¨æ¶ˆè´¹åœºæ™¯çš„å…¨æµç¨‹ç®¡ç†ï¼ŒåŒ…æ‹¬é£Ÿå ‚å°±é¤ã€ä¾¿åˆ©åº—è´­ç‰©ã€è‡ªåŠ©å”®å–ç­‰æ¶ˆè´¹åœºæ™¯çš„è´¦æˆ·ç®¡ç†ã€äº¤æ˜“å¤„ç†å’Œç»Ÿè®¡åˆ†æã€‚

æœ¬æ–‡æ¡£æ˜¯IOE-DREAMæ™ºæ…§æ¶ˆè´¹ç®¡ç†å¾®æœåŠ¡çš„æ€»ä½“è®¾è®¡æ–‡æ¡£ï¼ŒåŸºäº**ä¸­å¿ƒå®æ—¶éªŒè¯æ¨¡å¼**è®¾è®¡ï¼Œç¡®ä¿æ¶ˆè´¹å¾®æœåŠ¡ä¸‹æ¯ä¸ªå­æ¨¡å—çš„å®Œæ•´æ€§ã€ç³»ç»Ÿæ€§å’Œä¸€è‡´æ€§ã€‚

---

## â­ ä¸­å¿ƒå®æ—¶éªŒè¯æ¨¡å¼ï¼ˆMode 2ï¼‰

### æ ¸å¿ƒç†å¿µ

æ¶ˆè´¹ç³»ç»Ÿé‡‡ç”¨**ä¸­å¿ƒå®æ—¶éªŒè¯æ¨¡å¼**ï¼Œè®¾å¤‡ç«¯é‡‡é›†ç”Ÿç‰©ç‰¹å¾æˆ–å¡ç‰‡ä¿¡æ¯ï¼ŒæœåŠ¡å™¨ç«¯å®æ—¶éªŒè¯å’Œæ‰£æ¬¾ã€‚

### è®¾å¤‡äº¤äº’æµç¨‹

```
ã€æ•°æ®ä¸‹å‘ã€‘è½¯ä»¶ â†’ è®¾å¤‡
  â”œâ”€ ç”Ÿç‰©æ¨¡æ¿ï¼ˆå¯é€‰ï¼Œéƒ¨åˆ†è®¾å¤‡ä¸éœ€è¦ï¼‰
  â””â”€ è®¾å¤‡é…ç½®ï¼ˆæ¶ˆè´¹å•ä»·ã€é™é¢ç­‰ï¼‰

ã€å®æ—¶æ¶ˆè´¹ã€‘è®¾å¤‡ â‡„ è½¯ä»¶ï¼ˆå¿…é¡»åœ¨çº¿ï¼‰
  è®¾å¤‡ç«¯é‡‡é›† â†’ ä¸Šä¼ biometricData/cardNo â†’ æœåŠ¡å™¨éªŒè¯
  æœåŠ¡å™¨å¤„ç† â†’ è¯†åˆ«ç”¨æˆ· â†’ æ£€æŸ¥ä½™é¢ â†’ æ‰§è¡Œæ‰£æ¬¾
  æœåŠ¡å™¨è¿”å› â†’ æ‰£æ¬¾ç»“æœ â†’ è®¾å¤‡æ˜¾ç¤º+è¯­éŸ³æç¤º

ã€ç¦»çº¿é™çº§ã€‘è®¾å¤‡ç«¯å¤„ç†
  âš ï¸ ç½‘ç»œæ•…éšœæ—¶: æ”¯æŒæœ‰é™æ¬¡æ•°çš„ç¦»çº¿æ¶ˆè´¹
  â”œâ”€ ç™½åå•éªŒè¯: ä»…å…è®¸ç™½åå•ç”¨æˆ·
  â”œâ”€ å›ºå®šé¢åº¦: å•æ¬¡æ¶ˆè´¹å›ºå®šé‡‘é¢
  â””â”€ äº‹åè¡¥å½•: ç½‘ç»œæ¢å¤åä¸Šä¼ è¡¥å½•
```

### æŠ€æœ¯ä¼˜åŠ¿

- âœ… **æ•°æ®å®‰å…¨**: ä½™é¢å­˜å‚¨åœ¨æœåŠ¡å™¨ï¼Œé˜²æ­¢ç¯¡æ”¹
- âœ… **å®æ—¶è¡¥è´´**: å¯ç«‹å³å‘æ”¾è¡¥è´´åˆ°è´¦æˆ·
- âœ… **çµæ´»å®šä»·**: å¯æ ¹æ®æ—¶æ®µ/èœå“åŠ¨æ€å®šä»·

### æ¶æ„è¦æ±‚

- âœ… è®¾å¤‡ç«¯é‡‡é›†ç”Ÿç‰©ç‰¹å¾æˆ–å¡ç‰‡ä¿¡æ¯
- âœ… æœåŠ¡å™¨ç«¯å®æ—¶éªŒè¯å’Œæ‰£æ¬¾
- âœ… æ”¯æŒç¦»çº¿é™çº§æ¨¡å¼ï¼ˆç™½åå•+å›ºå®šé¢åº¦ï¼‰
- âœ… ç½‘ç»œæ¢å¤åè‡ªåŠ¨è¡¥å½•ç¦»çº¿æ¶ˆè´¹

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
    subgraph æ¥å…¥å±‚
        API[REST API]
        MQ[RabbitMQ]
    end
    
    subgraph ä¸šåŠ¡å±‚
        AREA[åŒºåŸŸç®¡ç†]
        MEAL[é¤åˆ«ç®¡ç†]
        ACCOUNT[è´¦æˆ·ç®¡ç†]
        PERM[æƒé™ç®¡ç†]
        CONSUME[æ¶ˆè´¹å¤„ç†]
        RECHARGE[å……å€¼ç®¡ç†]
        SUBSIDY[è¡¥è´´ç®¡ç†]
        REPORT[æŠ¥è¡¨ç»Ÿè®¡]
    end
    
    subgraph æ•°æ®å±‚
        MySQL[(MySQL)]
        Redis[(Redis)]
    end
    
    API --> AREA
    API --> ACCOUNT
    API --> RECHARGE
    MQ --> CONSUME
    
    CONSUME --> MySQL
    ACCOUNT --> MySQL
    ACCOUNT --> Redis
```

---

## ğŸ“ ä»£ç ç»“æ„

```
ioedream-consume-service/src/main/java/net/lab1024/sa/consume/
â”œâ”€â”€ ConsumeApplication.java                 # å¯åŠ¨ç±»
â”œâ”€â”€ controller/                             # Controllerå±‚
â”‚   â”œâ”€â”€ ConsumeAreaController.java         # åŒºåŸŸç®¡ç†
â”‚   â”œâ”€â”€ MealTypeController.java            # é¤åˆ«ç®¡ç†
â”‚   â”œâ”€â”€ AccountController.java             # è´¦æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ ConsumePermissionController.java   # æƒé™ç®¡ç†
â”‚   â”œâ”€â”€ ConsumeTransactionController.java  # æ¶ˆè´¹äº¤æ˜“
â”‚   â”œâ”€â”€ RechargeController.java            # å……å€¼ç®¡ç†
â”‚   â”œâ”€â”€ SubsidyController.java             # è¡¥è´´ç®¡ç†
â”‚   â””â”€â”€ ConsumeReportController.java       # æŠ¥è¡¨ç»Ÿè®¡
â”œâ”€â”€ service/                                # Serviceå±‚
â”‚   â”œâ”€â”€ ConsumeAreaService.java
â”‚   â”œâ”€â”€ MealTypeService.java
â”‚   â”œâ”€â”€ AccountService.java
â”‚   â”œâ”€â”€ ConsumePermissionService.java
â”‚   â”œâ”€â”€ ConsumeTransactionService.java
â”‚   â”œâ”€â”€ RechargeService.java
â”‚   â”œâ”€â”€ SubsidyService.java
â”‚   â””â”€â”€ ConsumeReportService.java
â”œâ”€â”€ dao/                                    # DAOå±‚
â”‚   â”œâ”€â”€ ConsumeAreaDao.java
â”‚   â”œâ”€â”€ AccountDao.java
â”‚   â”œâ”€â”€ ConsumeRecordDao.java
â”‚   â””â”€â”€ SubsidyRecordDao.java
â”œâ”€â”€ domain/                                 # é¢†åŸŸå¯¹è±¡
â”‚   â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ form/
â”‚   â””â”€â”€ vo/
â””â”€â”€ manager/                                # Managerå±‚
    â”œâ”€â”€ AccountBalanceManager.java
    â””â”€â”€ ConsumeStatisticsManager.java
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. åŒºåŸŸç®¡ç†
- æ¶ˆè´¹åŒºåŸŸå®šä¹‰ï¼ˆé£Ÿå ‚ã€ä¾¿åˆ©åº—ã€è‡ªåŠ¨å”®è´§æœºï¼‰
- åŒºåŸŸè®¾å¤‡ç»‘å®š
- åŒºåŸŸè¥ä¸šæ—¶é—´é…ç½®

### 2. é¤åˆ«åˆ†ç±»
- é¤åˆ«å®šä¹‰ï¼ˆæ—©é¤ã€åˆé¤ã€æ™šé¤ã€å¤œå®µï¼‰
- é¤åˆ«æ—¶é—´é…ç½®
- é¤åˆ«æ¶ˆè´¹é™é¢

### 3. è´¦æˆ·ç®¡ç†
- å‘˜å·¥è´¦æˆ·
- è®¿å®¢ä¸´æ—¶è´¦æˆ·
- è´¦æˆ·ç±»å‹ï¼ˆç°é‡‘è´¦æˆ·ã€è¡¥è´´è´¦æˆ·ï¼‰
- ä½™é¢æŸ¥è¯¢

### 4. æ¶ˆè´¹å¤„ç†
- å®æ—¶æ¶ˆè´¹æ‰£æ¬¾
- æ¶ˆè´¹è®°å½•
- æ¶ˆè´¹é™é¢æ§åˆ¶
- æ¶ˆè´¹æ’¤é”€

### 5. å……å€¼é€€æ¬¾
- ç°é‡‘å……å€¼
- çº¿ä¸Šå……å€¼
- é€€æ¬¾ç”³è¯·
- é€€æ¬¾å®¡æ‰¹

### 6. è¡¥è´´ç®¡ç†
- è¡¥è´´æ–¹æ¡ˆé…ç½®
- å®šæ—¶å‘æ”¾
- æ‰‹åŠ¨å‘æ”¾
- è¡¥è´´æŸ¥è¯¢

### 7. æŠ¥è¡¨ç»Ÿè®¡
- æ¶ˆè´¹æ˜ç»†æŠ¥è¡¨
- å……å€¼ç»Ÿè®¡æŠ¥è¡¨
- è¡¥è´´å‘æ”¾æŠ¥è¡¨
- åŒºåŸŸæ¶ˆè´¹åˆ†æ

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

| è¡¨å | è¯´æ˜ |
|------|------|
| t_consume_area | æ¶ˆè´¹åŒºåŸŸè¡¨ |
| t_consume_meal_type | é¤åˆ«åˆ†ç±»è¡¨ |
| t_consume_account | æ¶ˆè´¹è´¦æˆ·è¡¨ |
| t_consume_account_type | è´¦æˆ·ç±»å‹è¡¨ |
| t_consume_record | æ¶ˆè´¹è®°å½•è¡¨ |
| t_consume_recharge | å……å€¼è®°å½•è¡¨ |
| t_consume_subsidy | è¡¥è´´è®°å½•è¡¨ |
| t_consume_permission | æ¶ˆè´¹æƒé™è¡¨ |

### ERå›¾

```mermaid
erDiagram
    t_consume_account {
        bigint id PK
        bigint user_id FK
        varchar account_type
        decimal balance
        decimal frozen_amount
        tinyint status
    }
    
    t_consume_record {
        bigint id PK
        bigint account_id FK
        bigint area_id FK
        varchar meal_type
        decimal amount
        datetime consume_time
        varchar device_sn
        varchar trade_no
    }
    
    t_consume_recharge {
        bigint id PK
        bigint account_id FK
        decimal amount
        varchar recharge_type
        varchar trade_no
        tinyint status
        datetime recharge_time
    }
    
    t_consume_subsidy {
        bigint id PK
        bigint account_id FK
        decimal amount
        varchar subsidy_type
        varchar period
        datetime grant_time
    }
    
    t_consume_account ||--o{ t_consume_record : "æ¶ˆè´¹"
    t_consume_account ||--o{ t_consume_recharge : "å……å€¼"
    t_consume_account ||--o{ t_consume_subsidy : "è¡¥è´´"
```

---

## ğŸ”§ APIæ¥å£è®¾è®¡

### è´¦æˆ·ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/consume/v1/account/balance | æŸ¥è¯¢ä½™é¢ |
| GET | /api/consume/v1/account/detail | è´¦æˆ·è¯¦æƒ… |
| POST | /api/consume/v1/account/freeze | å†»ç»“è´¦æˆ· |

### æ¶ˆè´¹äº¤æ˜“

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/consume/v1/transaction/process | æ¶ˆè´¹æ‰£æ¬¾ |
| POST | /api/consume/v1/transaction/cancel | æ¶ˆè´¹æ’¤é”€ |
| GET | /api/consume/v1/transaction/records | æ¶ˆè´¹è®°å½• |

### å……å€¼ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/consume/v1/recharge/cash | ç°é‡‘å……å€¼ |
| POST | /api/consume/v1/recharge/online | çº¿ä¸Šå……å€¼ |
| POST | /api/consume/v1/refund/apply | é€€æ¬¾ç”³è¯· |

### è¡¥è´´ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | /api/consume/v1/subsidy/grant | å‘æ”¾è¡¥è´´ |
| POST | /api/consume/v1/subsidy/batch | æ‰¹é‡å‘æ”¾ |
| GET | /api/consume/v1/subsidy/records | è¡¥è´´è®°å½• |

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡é¡¹ | è¦æ±‚ |
|--------|------|
| æ¶ˆè´¹æ‰£æ¬¾å»¶è¿Ÿ | â‰¤ 500ms |
| ä½™é¢æŸ¥è¯¢å»¶è¿Ÿ | â‰¤ 100ms |
| å¹¶å‘æ¶ˆè´¹æ”¯æŒ | â‰¥ 500æ¬¡/ç§’ |
| æ‰¹é‡è¡¥è´´å‘æ”¾ | â‰¥ 10000äºº/åˆ†é’Ÿ |
| æ•°æ®ä¿å­˜å‘¨æœŸ | â‰¥ 5å¹´ |

---

## ğŸ” å®‰å…¨è¦æ±‚

- è´¦æˆ·ä½™é¢æ“ä½œéœ€è¦äº‹åŠ¡ä¿è¯
- æ¶ˆè´¹è®°å½•ä¸å¯ç¯¡æ”¹
- æ•æ„Ÿæ“ä½œéœ€è¦å®¡è®¡æ—¥å¿—
- æ”¯æŒå¹‚ç­‰æ€§è®¾è®¡é˜²æ­¢é‡å¤æ‰£æ¬¾

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
