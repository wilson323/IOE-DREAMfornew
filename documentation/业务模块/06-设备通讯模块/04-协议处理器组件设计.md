# åè®®å¤„ç†å™¨ç»„ä»¶è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0.0  
> **å¾®æœåŠ¡**: ioedream-device-comm-service  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“‹ ç»„ä»¶æ¦‚è¿°

åè®®å¤„ç†å™¨æ˜¯è®¾å¤‡é€šè®¯å¾®æœåŠ¡çš„æ ¸å¿ƒç»„ä»¶ï¼Œé‡‡ç”¨ç­–ç•¥æ¨¡å¼å®ç°å¤šåè®®æ”¯æŒï¼Œæ¯ç§åè®®å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨å®ç°ã€‚

---

## ğŸ—ï¸ ç»„ä»¶æ¶æ„

### ç±»å›¾

```mermaid
classDiagram
    class ProtocolHandler {
        <<interface>>
        +getProtocolType() String
        +getManufacturer() String
        +getVersion() String
        +parseMessage(byte[]) ProtocolMessage
        +parseMessage(String) ProtocolMessage
        +validateMessage(ProtocolMessage) boolean
        +processMessage(ProtocolMessage, Long) void
        +buildResponse(ProtocolMessage, boolean, String, String) byte[]
    }
    
    class AccessProtocolHandler {
        -gatewayServiceClient: GatewayServiceClient
        -rabbitTemplate: RabbitTemplate
        -meterRegistry: MeterRegistry
        +processAccessEvent(ProtocolMessage) void
        +processDeviceStatus(ProtocolMessage) void
        +processAlarmEvent(ProtocolMessage) void
        -parseVerifyType(String) int
    }
    
    class AttendanceProtocolHandler {
        -rabbitTemplate: RabbitTemplate
        +processAttendanceRecord(ProtocolMessage) void
        +processOperationLog(ProtocolMessage) void
    }
    
    class ConsumeProtocolHandler {
        -rabbitTemplate: RabbitTemplate
        +processConsumeRecord(ProtocolMessage) void
        +processRechargeRecord(ProtocolMessage) void
        +processSubsidyRecord(ProtocolMessage) void
    }
    
    class BiometricProtocolHandler {
        +processBiometricData(ProtocolMessage) void
        +processPhotoData(ProtocolMessage) void
    }
    
    class ProtocolAdapterFactory {
        -handlers: Map~String, ProtocolHandler~
        +getHandler(String) ProtocolHandler
        +registerHandler(ProtocolHandler) void
    }
    
    ProtocolHandler <|.. AccessProtocolHandler
    ProtocolHandler <|.. AttendanceProtocolHandler
    ProtocolHandler <|.. ConsumeProtocolHandler
    ProtocolHandler <|.. BiometricProtocolHandler
    
    ProtocolAdapterFactory --> ProtocolHandler
```

---

## ğŸ“¦ æ ¸å¿ƒæ¥å£

### ProtocolHandleræ¥å£

```java
/**
 * åè®®å¤„ç†å™¨æ¥å£
 * <p>
 * å®šä¹‰åè®®å¤„ç†çš„æ ‡å‡†æ¥å£ï¼Œæ‰€æœ‰åè®®å¤„ç†å™¨å¿…é¡»å®ç°æ­¤æ¥å£
 * </p>
 */
public interface ProtocolHandler {
    
    /**
     * è·å–åè®®ç±»å‹
     * @return åè®®ç±»å‹ä»£ç 
     */
    String getProtocolType();
    
    /**
     * è·å–è®¾å¤‡å‚å•†
     * @return å‚å•†åç§°
     */
    String getManufacturer();
    
    /**
     * è·å–åè®®ç‰ˆæœ¬
     * @return ç‰ˆæœ¬å·
     */
    String getVersion();
    
    /**
     * è§£æåè®®æ¶ˆæ¯ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰
     * @param rawData åŸå§‹å­—èŠ‚æ•°æ®
     * @return è§£æåçš„åè®®æ¶ˆæ¯
     * @throws ProtocolParseException è§£æå¼‚å¸¸
     */
    ProtocolMessage parseMessage(byte[] rawData) throws ProtocolParseException;
    
    /**
     * è§£æåè®®æ¶ˆæ¯ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
     * @param rawData åŸå§‹æ–‡æœ¬æ•°æ®
     * @return è§£æåçš„åè®®æ¶ˆæ¯
     * @throws ProtocolParseException è§£æå¼‚å¸¸
     */
    ProtocolMessage parseMessage(String rawData) throws ProtocolParseException;
    
    /**
     * éªŒè¯æ¶ˆæ¯æœ‰æ•ˆæ€§
     * @param message åè®®æ¶ˆæ¯
     * @return true-éªŒè¯é€šè¿‡ï¼Œfalse-éªŒè¯å¤±è´¥
     */
    boolean validateMessage(ProtocolMessage message);
    
    /**
     * å¤„ç†æ¶ˆæ¯
     * @param message åè®®æ¶ˆæ¯
     * @param deviceId è®¾å¤‡ID
     * @throws ProtocolProcessException å¤„ç†å¼‚å¸¸
     */
    void processMessage(ProtocolMessage message, Long deviceId) throws ProtocolProcessException;
    
    /**
     * æ„å»ºå“åº”æ¶ˆæ¯
     * @param requestMessage è¯·æ±‚æ¶ˆæ¯
     * @param success æ˜¯å¦æˆåŠŸ
     * @param errorCode é”™è¯¯ç 
     * @param errorMessage é”™è¯¯ä¿¡æ¯
     * @return å“åº”å­—èŠ‚æ•°æ®
     */
    byte[] buildResponse(ProtocolMessage requestMessage, boolean success, 
                         String errorCode, String errorMessage);
}
```

---

## ğŸ”§ å¤„ç†å™¨å®ç°

### 1. é—¨ç¦åè®®å¤„ç†å™¨ (AccessProtocolHandler)

**èŒè´£**:
- è§£æå®‰é˜²PUSHåè®®ï¼ˆç†µåŸºç§‘æŠ€V4.8ï¼‰
- å¤„ç†é—¨ç¦é€šè¡Œäº‹ä»¶
- å¤„ç†è®¾å¤‡çŠ¶æ€æ›´æ–°
- å¤„ç†æŠ¥è­¦äº‹ä»¶

**æ¶ˆæ¯ç±»å‹**:

| ç±»å‹ | è¯´æ˜ | ç›®æ ‡é˜Ÿåˆ— |
|------|------|----------|
| ACCESS_RECORD | é—¨ç¦é€šè¡Œè®°å½• | protocol.access.record |
| DEVICE_STATUS | è®¾å¤‡çŠ¶æ€ | protocol.device.status |
| ALARM_EVENT | æŠ¥è­¦äº‹ä»¶ | protocol.alarm.event |

**æ•°æ®å­—æ®µæ˜ å°„**:

| åè®®å­—æ®µ | ä¸šåŠ¡å­—æ®µ | è¯´æ˜ |
|----------|----------|------|
| pin | userId | ç”¨æˆ·ID |
| time | passTime | é€šè¡Œæ—¶é—´ |
| eventaddr | doorNo | é—¨å· |
| event | eventCode | äº‹ä»¶ç  |
| inoutstatus | passType | è¿›å‡ºç±»å‹ |
| verifytype | passMethod | éªŒè¯æ–¹å¼ |
| temperature | temperature | ä½“æ¸© |
| maskflag | maskFlag | å£ç½©çŠ¶æ€ |

### 2. è€ƒå‹¤åè®®å¤„ç†å™¨ (AttendanceProtocolHandler)

**èŒè´£**:
- è§£æè€ƒå‹¤PUSHåè®®ï¼ˆç†µåŸºç§‘æŠ€V4.0ï¼‰
- å¤„ç†è€ƒå‹¤æ‰“å¡è®°å½•
- å¤„ç†æ“ä½œæ—¥å¿—

**æ¶ˆæ¯ç±»å‹**:

| ç±»å‹ | è¯´æ˜ | ç›®æ ‡é˜Ÿåˆ— |
|------|------|----------|
| ATTENDANCE_RECORD | è€ƒå‹¤è®°å½• | protocol.attendance.record |
| OPERATION_LOG | æ“ä½œæ—¥å¿— | protocol.operation.log |

**æ•°æ®å­—æ®µæ˜ å°„**:

| åè®®å­—æ®µ | ä¸šåŠ¡å­—æ®µ | è¯´æ˜ |
|----------|----------|------|
| Pin | userId | ç”¨æˆ·ID |
| Time | punchTime | æ‰“å¡æ—¶é—´ |
| Status | punchType | æ‰“å¡ç±»å‹ |
| Verify | verifyMethod | éªŒè¯æ–¹å¼ |
| Workcode | workCode | å·¥ä½œä»£ç  |

### 3. æ¶ˆè´¹åè®®å¤„ç†å™¨ (ConsumeProtocolHandler)

**èŒè´£**:
- è§£ææ¶ˆè´¹PUSHåè®®ï¼ˆä¸­æ§æ™ºæ…§V1.0ï¼‰
- å¤„ç†æ¶ˆè´¹äº¤æ˜“è®°å½•
- å¤„ç†å……å€¼è®°å½•
- å¤„ç†è¡¥è´´è®°å½•

**æ¶ˆæ¯ç±»å‹**:

| ç±»å‹ | è¯´æ˜ | ç›®æ ‡é˜Ÿåˆ— |
|------|------|----------|
| CONSUME_RECORD | æ¶ˆè´¹è®°å½• | protocol.consume.record |
| RECHARGE_RECORD | å……å€¼è®°å½• | protocol.recharge.record |
| SUBSIDY_RECORD | è¡¥è´´è®°å½• | protocol.subsidy.record |

**æ•°æ®å­—æ®µæ˜ å°„**:

| åè®®å­—æ®µ | ä¸šåŠ¡å­—æ®µ | è¯´æ˜ |
|----------|----------|------|
| Pin | userId | ç”¨æˆ·ID |
| Time | transTime | äº¤æ˜“æ—¶é—´ |
| TransAmount | amount | äº¤æ˜“é‡‘é¢ |
| TransType | transType | äº¤æ˜“ç±»å‹ |
| Balance | balance | ä½™é¢ |
| AccNo | cardNo | å¡å· |

### 4. ç”Ÿç‰©è¯†åˆ«åè®®å¤„ç†å™¨ (BiometricProtocolHandler)

**èŒè´£**:
- å¤„ç†ç”Ÿç‰©è¯†åˆ«æ¨¡æ¿æ•°æ®
- å¤„ç†æ¯”å¯¹ç…§ç‰‡æ•°æ®
- æ”¯æŒå¤šç§ç”Ÿç‰©è¯†åˆ«ç±»å‹

**æ”¯æŒçš„ç”Ÿç‰©è¯†åˆ«ç±»å‹**:

| ç±»å‹ç  | è¯´æ˜ |
|--------|------|
| 0-3 | æŒ‡çº¹æ¨¡æ¿ |
| 4 | æŒ‡é™è„‰æ¨¡æ¿ |
| 5 | çº¢å¤–äººè„¸ |
| 6 | å¯è§å…‰äººè„¸ |
| 7 | æŒçº¹æ¨¡æ¿ |
| 9 | è™¹è†œæ¨¡æ¿ |

---

## ğŸ­ åè®®é€‚é…å™¨å·¥å‚

### ProtocolAdapterFactory

```java
/**
 * åè®®é€‚é…å™¨å·¥å‚
 * <p>
 * ç®¡ç†æ‰€æœ‰åè®®å¤„ç†å™¨ï¼Œæ ¹æ®åè®®ç±»å‹è·å–å¯¹åº”çš„å¤„ç†å™¨
 * </p>
 */
@Component
public class ProtocolAdapterFactory {
    
    private final Map<String, ProtocolHandler> handlers = new ConcurrentHashMap<>();
    
    /**
     * æ³¨å†Œåè®®å¤„ç†å™¨
     */
    @PostConstruct
    public void init() {
        // è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰ProtocolHandlerå®ç°
    }
    
    /**
     * æ ¹æ®åè®®ç±»å‹è·å–å¤„ç†å™¨
     * @param protocolType åè®®ç±»å‹
     * @return åè®®å¤„ç†å™¨
     */
    public ProtocolHandler getHandler(String protocolType) {
        return handlers.get(protocolType);
    }
    
    /**
     * æ ¹æ®è®¾å¤‡ç±»å‹å’Œå‚å•†è·å–å¤„ç†å™¨
     * @param deviceType è®¾å¤‡ç±»å‹
     * @param manufacturer å‚å•†
     * @return åè®®å¤„ç†å™¨
     */
    public ProtocolHandler getHandler(String deviceType, String manufacturer) {
        ProtocolTypeEnum type = ProtocolTypeEnum.getByDeviceTypeAndManufacturer(
            deviceType, manufacturer);
        return type != null ? handlers.get(type.getCode()) : null;
    }
}
```

---

## ğŸ“Š æ‰©å±•æ–°åè®®

### æ­¥éª¤

1. **å®šä¹‰åè®®ç±»å‹æšä¸¾**

```java
// åœ¨ProtocolTypeEnumä¸­æ·»åŠ æ–°åè®®
NEW_PROTOCOL("NEW_PROTOCOL_V1.0", "æ–°åè®®", "å‚å•†", "V1.0", "DEVICE_TYPE");
```

2. **å®ç°åè®®å¤„ç†å™¨**

```java
@Component
public class NewProtocolHandler implements ProtocolHandler {
    
    @Override
    public String getProtocolType() {
        return ProtocolTypeEnum.NEW_PROTOCOL.getCode();
    }
    
    @Override
    public ProtocolMessage parseMessage(String rawData) throws ProtocolParseException {
        // å®ç°åè®®è§£æé€»è¾‘
    }
    
    @Override
    public void processMessage(ProtocolMessage message, Long deviceId) 
            throws ProtocolProcessException {
        // å®ç°ä¸šåŠ¡å¤„ç†é€»è¾‘
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

3. **é…ç½®æ¶ˆæ¯é˜Ÿåˆ—**

```java
// åœ¨ProtocolMessageQueueConfigä¸­æ·»åŠ é˜Ÿåˆ—é…ç½®
@Bean
public Queue newProtocolQueue() {
    return new Queue("protocol.new.record", true);
}
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### MicrometeræŒ‡æ ‡

| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| protocol.message.process | Counter | æ¶ˆæ¯å¤„ç†æ¬¡æ•° |
| protocol.message.process.duration | Timer | æ¶ˆæ¯å¤„ç†è€—æ—¶ |
| protocol.message.error | Counter | æ¶ˆæ¯å¤„ç†é”™è¯¯æ¬¡æ•° |
| protocol.queue.operation | Counter | é˜Ÿåˆ—æ“ä½œæ¬¡æ•° |

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
