# è®¾å¤‡é€šè®¯å¾®æœåŠ¡æ€»ä½“è®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0.0  
> **å¾®æœåŠ¡**: ioedream-device-comm-service (ç«¯å£: 8087)  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17  
> **æŠ€æœ¯æ ˆ**: Spring Boot 3.5.8 + Java 17 + RabbitMQ + Netty

---

## ğŸ“‹ æœåŠ¡æ¦‚è¿°

è®¾å¤‡é€šè®¯å¾®æœåŠ¡ï¼ˆioedream-device-comm-serviceï¼‰æ˜¯IOE-DREAMæ™ºæ…§å›­åŒºç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½æœåŠ¡ï¼Œè´Ÿè´£ä¸é—¨ç¦ã€è€ƒå‹¤ã€æ¶ˆè´¹ç­‰ç»ˆç«¯è®¾å¤‡è¿›è¡Œé€šè®¯ï¼Œå®ç°è®¾å¤‡æ•°æ®çš„é‡‡é›†ã€è§£æã€è½¬å‘å’Œå‘½ä»¤ä¸‹å‘ã€‚

### æ ¸å¿ƒèŒè´£

1. **åè®®è§£æ** - è§£æå¤šç§è®¾å¤‡åè®®ï¼ˆPUSHåè®®ï¼‰
2. **æ•°æ®é‡‡é›†** - å®æ—¶é‡‡é›†è®¾å¤‡äº‹ä»¶å’ŒçŠ¶æ€æ•°æ®
3. **æ¶ˆæ¯è·¯ç”±** - å°†è§£æåçš„æ•°æ®è·¯ç”±åˆ°å¯¹åº”ä¸šåŠ¡æœåŠ¡
4. **å‘½ä»¤ä¸‹å‘** - å‘è®¾å¤‡ä¸‹å‘æ§åˆ¶å‘½ä»¤å’Œé…ç½®æ•°æ®
5. **è®¾å¤‡ç®¡ç†** - è®¾å¤‡æ³¨å†Œã€çŠ¶æ€ç›‘æ§ã€å¥åº·æ£€æŸ¥

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç»ˆç«¯è®¾å¤‡å±‚"
        D1[é—¨ç¦è®¾å¤‡<br/>ç†µåŸºç§‘æŠ€]
        D2[è€ƒå‹¤è®¾å¤‡<br/>ç†µåŸºç§‘æŠ€]
        D3[æ¶ˆè´¹è®¾å¤‡<br/>ä¸­æ§æ™ºæ…§]
    end
    
    subgraph "è®¾å¤‡é€šè®¯å¾®æœåŠ¡"
        subgraph "åè®®å±‚"
            PS[TCP/HTTP Push Server<br/>Netty]
            PA[åè®®é€‚é…å™¨å·¥å‚<br/>ProtocolAdapterFactory]
        end
        
        subgraph "å¤„ç†å™¨å±‚"
            PH1[é—¨ç¦åè®®å¤„ç†å™¨<br/>AccessProtocolHandler]
            PH2[è€ƒå‹¤åè®®å¤„ç†å™¨<br/>AttendanceProtocolHandler]
            PH3[æ¶ˆè´¹åè®®å¤„ç†å™¨<br/>ConsumeProtocolHandler]
        end
        
        subgraph "æ¶ˆæ¯å±‚"
            MQ[æ¶ˆæ¯é˜Ÿåˆ—<br/>RabbitMQ]
            MR[æ¶ˆæ¯è·¯ç”±å™¨<br/>MessageRouter]
        end
        
        subgraph "ç¼“å­˜å±‚"
            RC[åè®®ç¼“å­˜<br/>Redis + Caffeine]
        end
    end
    
    subgraph "ä¸šåŠ¡å¾®æœåŠ¡å±‚"
        AS[é—¨ç¦æœåŠ¡<br/>8090]
        ATS[è€ƒå‹¤æœåŠ¡<br/>8091]
        CS[æ¶ˆè´¹æœåŠ¡<br/>8094]
    end
    
    D1 -->|PUSH V4.8| PS
    D2 -->|PUSH V4.0| PS
    D3 -->|PUSH V1.0| PS
    
    PS --> PA
    PA --> PH1
    PA --> PH2
    PA --> PH3
    
    PH1 --> MQ
    PH2 --> MQ
    PH3 --> MQ
    
    MQ --> MR
    MR --> AS
    MR --> ATS
    MR --> CS
    
    PH1 -.-> RC
    PH2 -.-> RC
    PH3 -.-> RC
```

### ä»£ç ç»“æ„

```
ioedream-device-comm-service/
â””â”€â”€ src/main/java/net/lab1024/sa/devicecomm/
    â”œâ”€â”€ biometric/                    # ç”Ÿç‰©è¯†åˆ«æ•°æ®ç®¡ç†
    â”‚   â””â”€â”€ BiometricDataManager.java
    â”œâ”€â”€ cache/                        # åè®®ç¼“å­˜æœåŠ¡
    â”‚   â”œâ”€â”€ ProtocolCacheService.java
    â”‚   â””â”€â”€ ProtocolCacheServiceImpl.java
    â”œâ”€â”€ config/                       # é…ç½®ç±»
    â”‚   â”œâ”€â”€ DynamicThreadPoolConfig.java
    â”‚   â””â”€â”€ ProtocolMessageQueueConfig.java
    â”œâ”€â”€ consumer/                     # æ¶ˆæ¯æ¶ˆè´¹è€…
    â”‚   â””â”€â”€ ProtocolMessageConsumer.java
    â”œâ”€â”€ controller/                   # æ§åˆ¶å™¨å±‚
    â”‚   â”œâ”€â”€ BiometricController.java
    â”‚   â”œâ”€â”€ BiometricIntegrationController.java
    â”‚   â”œâ”€â”€ DeviceSyncController.java
    â”‚   â””â”€â”€ ProtocolController.java
    â”œâ”€â”€ device/                       # è®¾å¤‡ç®¡ç†
    â”‚   â”œâ”€â”€ enums/DeviceTypeEnum.java
    â”‚   â”œâ”€â”€ manager/DeviceStatusManager.java
    â”‚   â””â”€â”€ monitor/DeviceHealthMonitor.java
    â”œâ”€â”€ domain/                       # é¢†åŸŸå¯¹è±¡
    â”‚   â”œâ”€â”€ form/DeviceQueryForm.java
    â”‚   â””â”€â”€ vo/DeviceListVO.java
    â”œâ”€â”€ integration/                  # é›†æˆæœåŠ¡
    â”‚   â””â”€â”€ BiometricIntegrationService.java
    â”œâ”€â”€ protocol/                     # åè®®å¤„ç†æ ¸å¿ƒ
    â”‚   â”œâ”€â”€ adapter/ProtocolAdapterFactory.java
    â”‚   â”œâ”€â”€ client/DeviceProtocolClient.java
    â”‚   â”œâ”€â”€ enums/                    # åè®®æšä¸¾
    â”‚   â”‚   â”œâ”€â”€ AccessEventTypeEnum.java
    â”‚   â”‚   â”œâ”€â”€ AttendanceStatusEnum.java
    â”‚   â”‚   â”œâ”€â”€ ProtocolTypeEnum.java
    â”‚   â”‚   â”œâ”€â”€ PunchTypeEnum.java
    â”‚   â”‚   â””â”€â”€ VerifyTypeEnum.java
    â”‚   â”œâ”€â”€ handler/                  # åè®®å¤„ç†å™¨
    â”‚   â”‚   â”œâ”€â”€ impl/
    â”‚   â”‚   â”‚   â”œâ”€â”€ AccessProtocolHandler.java
    â”‚   â”‚   â”‚   â”œâ”€â”€ AttendanceProtocolHandler.java
    â”‚   â”‚   â”‚   â”œâ”€â”€ BiometricProtocolHandler.java
    â”‚   â”‚   â”‚   â””â”€â”€ ConsumeProtocolHandler.java
    â”‚   â”‚   â”œâ”€â”€ ProtocolHandler.java
    â”‚   â”‚   â”œâ”€â”€ ProtocolParseException.java
    â”‚   â”‚   â””â”€â”€ ProtocolProcessException.java
    â”‚   â”œâ”€â”€ message/ProtocolMessage.java
    â”‚   â”œâ”€â”€ router/MessageRouter.java
    â”‚   â””â”€â”€ server/TcpPushServer.java
    â””â”€â”€ service/                      # æœåŠ¡å±‚
        â”œâ”€â”€ BiometricService.java
        â””â”€â”€ DeviceSyncService.java
```

---

## ğŸ“¡ æ”¯æŒçš„åè®®

### åè®®ç±»å‹æšä¸¾

| åè®®ä»£ç  | åè®®åç§° | å‚å•† | ç‰ˆæœ¬ | è®¾å¤‡ç±»å‹ |
|----------|----------|------|------|----------|
| ACCESS_ENTROPY_V4.8 | å®‰é˜²PUSHåè®® | ç†µåŸºç§‘æŠ€ | V4.8 | é—¨ç¦ |
| ATTENDANCE_ENTROPY_V4.0 | è€ƒå‹¤PUSHåè®® | ç†µåŸºç§‘æŠ€ | V4.0 | è€ƒå‹¤ |
| CONSUME_ZKTECO_V1.0 | æ¶ˆè´¹PUSHåè®® | ä¸­æ§æ™ºæ…§ | V1.0 | æ¶ˆè´¹ |

### åè®®ç‰¹ç‚¹

- **åŸºäºHTTP**: æ‰€æœ‰åè®®å‡åŸºäºHTTPåè®®ï¼Œä½¿ç”¨POSTæ–¹æ³•ä¼ è¾“æ•°æ®
- **ç¼–ç **: UTF-8ï¼ˆä¸­æ–‡æ—¶å¯èƒ½ä½¿ç”¨GB2312/GB18030ï¼‰
- **æ•°æ®æ ¼å¼**: é”®å€¼å¯¹æ ¼å¼ï¼Œä½¿ç”¨åˆ¶è¡¨ç¬¦ï¼ˆ\tï¼‰åˆ†éš”
- **ä¸»åŠ¨ä¸Šä¼ **: è®¾å¤‡ä¸»åŠ¨å‘æœåŠ¡å™¨æ¨é€æ•°æ®
- **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒç½‘ç»œä¸­æ–­åçš„æ•°æ®ç»­ä¼ 

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. åè®®å¤„ç†å™¨æ¥å£

```java
public interface ProtocolHandler {
    /**
     * è·å–åè®®ç±»å‹
     */
    String getProtocolType();
    
    /**
     * è·å–è®¾å¤‡å‚å•†
     */
    String getManufacturer();
    
    /**
     * è·å–åè®®ç‰ˆæœ¬
     */
    String getVersion();
    
    /**
     * è§£æåè®®æ¶ˆæ¯ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰
     */
    ProtocolMessage parseMessage(byte[] rawData) throws ProtocolParseException;
    
    /**
     * è§£æåè®®æ¶ˆæ¯ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
     */
    ProtocolMessage parseMessage(String rawData) throws ProtocolParseException;
    
    /**
     * éªŒè¯æ¶ˆæ¯
     */
    boolean validateMessage(ProtocolMessage message);
    
    /**
     * å¤„ç†æ¶ˆæ¯
     */
    void processMessage(ProtocolMessage message, Long deviceId) throws ProtocolProcessException;
    
    /**
     * æ„å»ºå“åº”
     */
    byte[] buildResponse(ProtocolMessage requestMessage, boolean success, String errorCode, String errorMessage);
}
```

### 2. åè®®æ¶ˆæ¯ç»“æ„

```java
public class ProtocolMessage {
    private String protocolType;      // åè®®ç±»å‹
    private String messageType;       // æ¶ˆæ¯ç±»å‹
    private String deviceCode;        // è®¾å¤‡ç¼–å·
    private Long deviceId;            // è®¾å¤‡ID
    private LocalDateTime timestamp;  // æ—¶é—´æˆ³
    private Map<String, Object> data; // è§£æåçš„æ•°æ®
    private String status;            // å¤„ç†çŠ¶æ€
    private String errorCode;         // é”™è¯¯ç 
    private String errorMessage;      // é”™è¯¯ä¿¡æ¯
    private String rawDataHex;        // åŸå§‹æ•°æ®ï¼ˆåå…­è¿›åˆ¶ï¼‰
    private byte[] rawDataBytes;      // åŸå§‹æ•°æ®ï¼ˆå­—èŠ‚ï¼‰
}
```

### 3. æ¶ˆæ¯é˜Ÿåˆ—é…ç½®

| é˜Ÿåˆ—åç§° | ç”¨é€” | æ¶ˆè´¹è€… |
|----------|------|--------|
| protocol.access.record | é—¨ç¦é€šè¡Œè®°å½• | é—¨ç¦æœåŠ¡ |
| protocol.attendance.record | è€ƒå‹¤æ‰“å¡è®°å½• | è€ƒå‹¤æœåŠ¡ |
| protocol.consume.record | æ¶ˆè´¹äº¤æ˜“è®°å½• | æ¶ˆè´¹æœåŠ¡ |
| protocol.device.status | è®¾å¤‡çŠ¶æ€æ›´æ–° | è®¾å¤‡ç®¡ç†æœåŠ¡ |
| protocol.alarm.event | æŠ¥è­¦äº‹ä»¶ | ç›‘æ§æœåŠ¡ |

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡é¡¹ | è¦æ±‚ |
|--------|------|
| åè®®è§£æå»¶è¿Ÿ | â‰¤ 10æ¯«ç§’ |
| æ¶ˆæ¯å¤„ç†ååé‡ | â‰¥ 10000æ¡/ç§’ |
| è®¾å¤‡è¿æ¥æ•° | â‰¥ 5000ä¸ª |
| æ¶ˆæ¯é˜Ÿåˆ—å»¶è¿Ÿ | â‰¤ 100æ¯«ç§’ |
| æœåŠ¡å¯ç”¨æ€§ | â‰¥ 99.99% |

---

## ğŸ”— æœåŠ¡ä¾èµ–

### ä¾èµ–çš„åŸºç¡€è®¾æ–½

- **RabbitMQ**: æ¶ˆæ¯é˜Ÿåˆ—
- **Redis**: ç¼“å­˜ã€åˆ†å¸ƒå¼é”
- **Nacos**: æœåŠ¡æ³¨å†Œä¸é…ç½®ä¸­å¿ƒ

### ä¸‹æ¸¸æœåŠ¡

- **ioedream-access-service**: é—¨ç¦æœåŠ¡
- **ioedream-attendance-service**: è€ƒå‹¤æœåŠ¡
- **ioedream-consume-service**: æ¶ˆè´¹æœåŠ¡

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
