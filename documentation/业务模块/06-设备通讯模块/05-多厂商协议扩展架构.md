# å¤šå‚å•†åè®®æ‰©å±•æ¶æ„è®¾è®¡

> **ç‰ˆæœ¬**: v1.0.0  
> **å¾®æœåŠ¡**: ioedream-device-comm-service  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“‹ è®¾è®¡ç›®æ ‡

æ”¯æŒå¤šå‚å•†ã€å¤šåè®®çš„è®¾å¤‡æ¥å…¥ï¼Œå®ç°åè®®å¤„ç†çš„ç»„ä»¶åŒ–ã€æ’ä»¶åŒ–ï¼Œä¾¿äºåç»­æ‰©å±•æ–°å‚å•†è®¾å¤‡ã€‚

---

## ğŸ—ï¸ å¤šå‚å•†åè®®æ¶æ„

### æ¶æ„æ€»è§ˆ

```mermaid
graph TB
    subgraph "è®¾å¤‡å±‚"
        subgraph "é—¨ç¦è®¾å¤‡"
            A1[ç†µåŸºç§‘æŠ€<br/>PUSH V4.8]
            A2[æµ·åº·å¨è§†<br/>ISAPI]
            A3[å¤§å<br/>SDK]
            A4[å®‡è§†<br/>HTTP API]
        end
        subgraph "è€ƒå‹¤è®¾å¤‡"
            B1[ç†µåŸºç§‘æŠ€<br/>PUSH V4.0]
            B2[æ±‰ç‹<br/>HTTP API]
            B3[å¾—åŠ›<br/>SDK]
        end
        subgraph "æ¶ˆè´¹è®¾å¤‡"
            C1[ä¸­æ§æ™ºæ…§<br/>PUSH V1.0]
            C2[æ–°å¼€æ™®<br/>HTTP API]
            C3[é‡‘ä»•è¾¾<br/>TCP]
        end
    end
    
    subgraph "åè®®é€‚é…å±‚"
        PA[åè®®é€‚é…å™¨å·¥å‚<br/>ProtocolAdapterFactory]
        
        subgraph "é—¨ç¦åè®®å¤„ç†å™¨"
            PH1[ç†µåŸºé—¨ç¦Handler]
            PH2[æµ·åº·é—¨ç¦Handler]
            PH3[å¤§åé—¨ç¦Handler]
            PH4[å®‡è§†é—¨ç¦Handler]
        end
        
        subgraph "è€ƒå‹¤åè®®å¤„ç†å™¨"
            PH5[ç†µåŸºè€ƒå‹¤Handler]
            PH6[æ±‰ç‹è€ƒå‹¤Handler]
            PH7[å¾—åŠ›è€ƒå‹¤Handler]
        end
        
        subgraph "æ¶ˆè´¹åè®®å¤„ç†å™¨"
            PH8[ä¸­æ§æ¶ˆè´¹Handler]
            PH9[æ–°å¼€æ™®æ¶ˆè´¹Handler]
            PH10[é‡‘ä»•è¾¾æ¶ˆè´¹Handler]
        end
    end
    
    subgraph "ç»Ÿä¸€æ¶ˆæ¯å±‚"
        MQ[RabbitMQ]
        UM[ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼<br/>UnifiedMessage]
    end
    
    A1 --> PH1
    A2 --> PH2
    A3 --> PH3
    A4 --> PH4
    B1 --> PH5
    B2 --> PH6
    B3 --> PH7
    C1 --> PH8
    C2 --> PH9
    C3 --> PH10
    
    PH1 & PH2 & PH3 & PH4 --> UM
    PH5 & PH6 & PH7 --> UM
    PH8 & PH9 & PH10 --> UM
    
    UM --> MQ
```

---

## ğŸ“¦ åè®®ç±»å‹æšä¸¾æ‰©å±•

```java
@Getter
public enum ProtocolTypeEnum {

    // ==================== é—¨ç¦åè®® ====================
    // ç†µåŸºç§‘æŠ€
    ACCESS_ENTROPY_V4_8("ACCESS_ENTROPY_V4.8", "å®‰é˜²PUSHåè®®", "ç†µåŸºç§‘æŠ€", "V4.8", "ACCESS", "PUSH"),
    
    // æµ·åº·å¨è§†
    ACCESS_HIKVISION_ISAPI("ACCESS_HIKVISION_ISAPI", "ISAPIåè®®", "æµ·åº·å¨è§†", "V2.0", "ACCESS", "HTTP"),
    ACCESS_HIKVISION_EHOME("ACCESS_HIKVISION_EHOME", "EHOMEåè®®", "æµ·åº·å¨è§†", "V5.0", "ACCESS", "TCP"),
    
    // å¤§å
    ACCESS_DAHUA_SDK("ACCESS_DAHUA_SDK", "SDKåè®®", "å¤§å", "V3.0", "ACCESS", "SDK"),
    ACCESS_DAHUA_HTTP("ACCESS_DAHUA_HTTP", "HTTPåè®®", "å¤§å", "V1.0", "ACCESS", "HTTP"),
    
    // å®‡è§†
    ACCESS_UNIVIEW_HTTP("ACCESS_UNIVIEW_HTTP", "HTTP API", "å®‡è§†", "V2.0", "ACCESS", "HTTP"),

    // ==================== è€ƒå‹¤åè®® ====================
    // ç†µåŸºç§‘æŠ€
    ATTENDANCE_ENTROPY_V4_0("ATTENDANCE_ENTROPY_V4.0", "è€ƒå‹¤PUSHåè®®", "ç†µåŸºç§‘æŠ€", "V4.0", "ATTENDANCE", "PUSH"),
    
    // æ±‰ç‹
    ATTENDANCE_HANWANG_HTTP("ATTENDANCE_HANWANG_HTTP", "HTTPåè®®", "æ±‰ç‹", "V1.0", "ATTENDANCE", "HTTP"),
    
    // å¾—åŠ›
    ATTENDANCE_DELI_SDK("ATTENDANCE_DELI_SDK", "SDKåè®®", "å¾—åŠ›", "V2.0", "ATTENDANCE", "SDK"),

    // ==================== æ¶ˆè´¹åè®® ====================
    // ä¸­æ§æ™ºæ…§
    CONSUME_ZKTECO_V1_0("CONSUME_ZKTECO_V1.0", "æ¶ˆè´¹PUSHåè®®", "ä¸­æ§æ™ºæ…§", "V1.0", "CONSUME", "PUSH"),
    
    // æ–°å¼€æ™®
    CONSUME_NEWCAPEC_HTTP("CONSUME_NEWCAPEC_HTTP", "HTTPåè®®", "æ–°å¼€æ™®", "V3.0", "CONSUME", "HTTP"),
    
    // é‡‘ä»•è¾¾
    CONSUME_KINGSTAR_TCP("CONSUME_KINGSTAR_TCP", "TCPåè®®", "é‡‘ä»•è¾¾", "V2.0", "CONSUME", "TCP");

    private final String code;           // åè®®ä»£ç 
    private final String name;           // åè®®åç§°
    private final String manufacturer;   // å‚å•†
    private final String version;        // ç‰ˆæœ¬
    private final String deviceType;     // è®¾å¤‡ç±»å‹
    private final String transportType;  // ä¼ è¾“ç±»å‹: PUSH/HTTP/TCP/SDK
    
    // ... æ„é€ å‡½æ•°å’Œæ–¹æ³•
}
```

---

## ğŸ”§ åè®®å¤„ç†å™¨æ³¨å†Œæœºåˆ¶

### è‡ªåŠ¨æ³¨å†Œ

```java
@Component
public class ProtocolAdapterFactory implements ApplicationContextAware {
    
    private final Map<String, ProtocolHandler> handlers = new ConcurrentHashMap<>();
    private final Map<String, List<ProtocolHandler>> manufacturerHandlers = new ConcurrentHashMap<>();
    
    @Override
    public void setApplicationContext(ApplicationContext context) {
        // è‡ªåŠ¨å‘ç°å¹¶æ³¨å†Œæ‰€æœ‰ProtocolHandlerå®ç°
        Map<String, ProtocolHandler> beans = context.getBeansOfType(ProtocolHandler.class);
        beans.values().forEach(this::registerHandler);
    }
    
    public void registerHandler(ProtocolHandler handler) {
        handlers.put(handler.getProtocolType(), handler);
        
        // æŒ‰å‚å•†åˆ†ç»„
        manufacturerHandlers
            .computeIfAbsent(handler.getManufacturer(), k -> new ArrayList<>())
            .add(handler);
            
        log.info("[åè®®å·¥å‚] æ³¨å†Œåè®®å¤„ç†å™¨: {} - {} - {}", 
            handler.getManufacturer(), handler.getProtocolType(), handler.getVersion());
    }
    
    /**
     * æ ¹æ®è®¾å¤‡ä¿¡æ¯è‡ªåŠ¨åŒ¹é…åè®®å¤„ç†å™¨
     */
    public ProtocolHandler matchHandler(String deviceType, String manufacturer, String model) {
        // 1. ç²¾ç¡®åŒ¹é…
        for (ProtocolHandler handler : handlers.values()) {
            if (handler.supports(deviceType, manufacturer, model)) {
                return handler;
            }
        }
        
        // 2. å‚å•†+è®¾å¤‡ç±»å‹åŒ¹é…
        ProtocolTypeEnum type = ProtocolTypeEnum.getByDeviceTypeAndManufacturer(deviceType, manufacturer);
        return type != null ? handlers.get(type.getCode()) : null;
    }
}
```

---

## ğŸ“‹ å‚å•†åè®®æ–‡æ¡£è§„åˆ’

### å¾…é›†æˆåè®®æ¸…å•

| å‚å•† | è®¾å¤‡ç±»å‹ | åè®® | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|----------|------|--------|------|
| **ç†µåŸºç§‘æŠ€** | é—¨ç¦ | PUSH V4.8 | P0 | âœ… å·²å®Œæˆ |
| **ç†µåŸºç§‘æŠ€** | è€ƒå‹¤ | PUSH V4.0 | P0 | âœ… å·²å®Œæˆ |
| **ä¸­æ§æ™ºæ…§** | æ¶ˆè´¹ | PUSH V1.0 | P0 | âœ… å·²å®Œæˆ |
| **æµ·åº·å¨è§†** | é—¨ç¦ | ISAPI | P1 | ğŸ“‹ å¾…é›†æˆ |
| **æµ·åº·å¨è§†** | é—¨ç¦ | EHOME | P1 | ğŸ“‹ å¾…é›†æˆ |
| **å¤§å** | é—¨ç¦ | SDK | P1 | ğŸ“‹ å¾…é›†æˆ |
| **å®‡è§†** | é—¨ç¦ | HTTP API | P2 | ğŸ“‹ å¾…é›†æˆ |
| **æ±‰ç‹** | è€ƒå‹¤ | HTTP | P2 | ğŸ“‹ å¾…é›†æˆ |
| **æ–°å¼€æ™®** | æ¶ˆè´¹ | HTTP | P2 | ğŸ“‹ å¾…é›†æˆ |

### æ–‡æ¡£ç»“æ„è§„åˆ’

```
06-è®¾å¤‡é€šè®¯æ¨¡å—/
â”œâ”€â”€ 00-è®¾å¤‡é€šè®¯å¾®æœåŠ¡æ€»ä½“è®¾è®¡.md
â”œâ”€â”€ 01-é—¨ç¦è®¾å¤‡åè®®/
â”‚   â”œâ”€â”€ 01-ç†µåŸºç§‘æŠ€-PUSH-V4.8.md        âœ…
â”‚   â”œâ”€â”€ 02-æµ·åº·å¨è§†-ISAPI-V2.0.md       ğŸ“‹
â”‚   â”œâ”€â”€ 03-æµ·åº·å¨è§†-EHOME-V5.0.md       ğŸ“‹
â”‚   â”œâ”€â”€ 04-å¤§å-SDK-V3.0.md             ğŸ“‹
â”‚   â””â”€â”€ 05-å®‡è§†-HTTP-V2.0.md            ğŸ“‹
â”œâ”€â”€ 02-è€ƒå‹¤è®¾å¤‡åè®®/
â”‚   â”œâ”€â”€ 01-ç†µåŸºç§‘æŠ€-PUSH-V4.0.md        âœ…
â”‚   â”œâ”€â”€ 02-æ±‰ç‹-HTTP-V1.0.md            ğŸ“‹
â”‚   â””â”€â”€ 03-å¾—åŠ›-SDK-V2.0.md             ğŸ“‹
â”œâ”€â”€ 03-æ¶ˆè´¹è®¾å¤‡åè®®/
â”‚   â”œâ”€â”€ 01-ä¸­æ§æ™ºæ…§-PUSH-V1.0.md        âœ…
â”‚   â”œâ”€â”€ 02-æ–°å¼€æ™®-HTTP-V3.0.md          ğŸ“‹
â”‚   â””â”€â”€ 03-é‡‘ä»•è¾¾-TCP-V2.0.md           ğŸ“‹
â”œâ”€â”€ 04-åè®®å¤„ç†å™¨ç»„ä»¶è®¾è®¡.md
â””â”€â”€ 05-å¤šå‚å•†åè®®æ‰©å±•æ¶æ„.md             âœ…
```

---

## ğŸ”Œ æ–°å‚å•†åè®®æ¥å…¥æµç¨‹

### æ¥å…¥æ­¥éª¤

1. **åè®®åˆ†æ** - è·å–å‚å•†åè®®æ–‡æ¡£ï¼Œåˆ†æé€šè®¯æ–¹å¼å’Œæ•°æ®æ ¼å¼
2. **æšä¸¾æ³¨å†Œ** - åœ¨`ProtocolTypeEnum`ä¸­æ·»åŠ æ–°åè®®ç±»å‹
3. **å¤„ç†å™¨å®ç°** - å®ç°`ProtocolHandler`æ¥å£
4. **æ¶ˆæ¯æ˜ å°„** - å°†å‚å•†æ•°æ®æ˜ å°„åˆ°ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
5. **é˜Ÿåˆ—é…ç½®** - é…ç½®æ¶ˆæ¯é˜Ÿåˆ—è·¯ç”±
6. **æµ‹è¯•éªŒè¯** - è¿›è¡Œåè®®æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•
7. **æ–‡æ¡£ç¼–å†™** - ç¼–å†™åè®®è§„èŒƒæ–‡æ¡£

### å¤„ç†å™¨æ¨¡æ¿

```java
@Slf4j
@Component
public class NewManufacturerProtocolHandler implements ProtocolHandler {
    
    private static final String PROTOCOL_TYPE = ProtocolTypeEnum.XXX.getCode();
    
    @Resource
    private RabbitTemplate rabbitTemplate;
    
    @Override
    public String getProtocolType() {
        return PROTOCOL_TYPE;
    }
    
    @Override
    public String getManufacturer() {
        return "æ–°å‚å•†";
    }
    
    @Override
    public boolean supports(String deviceType, String manufacturer, String model) {
        // åˆ¤æ–­æ˜¯å¦æ”¯æŒè¯¥è®¾å¤‡
        return "æ–°å‚å•†".equals(manufacturer) && supportedModels.contains(model);
    }
    
    @Override
    public ProtocolMessage parseMessage(String rawData) throws ProtocolParseException {
        // å®ç°åè®®è§£æ
    }
    
    @Override
    public void processMessage(ProtocolMessage message, Long deviceId) {
        // è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼å¹¶å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        UnifiedMessage unified = convertToUnified(message);
        rabbitTemplate.convertAndSend("protocol.unified.record", unified);
    }
}
```

---

## ğŸ“Š ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼

```java
/**
 * ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
 * æ‰€æœ‰å‚å•†åè®®æœ€ç»ˆè½¬æ¢ä¸ºæ­¤æ ¼å¼
 */
@Data
public class UnifiedMessage {
    private String messageId;         // æ¶ˆæ¯ID
    private String protocolType;      // åè®®ç±»å‹
    private String manufacturer;      // å‚å•†
    private String deviceType;        // è®¾å¤‡ç±»å‹: ACCESS/ATTENDANCE/CONSUME
    private String deviceCode;        // è®¾å¤‡ç¼–å·
    private Long deviceId;            // è®¾å¤‡ID
    private String messageType;       // æ¶ˆæ¯ç±»å‹: RECORD/STATUS/ALARM
    private LocalDateTime eventTime;  // äº‹ä»¶æ—¶é—´
    private Map<String, Object> data; // ä¸šåŠ¡æ•°æ®ï¼ˆç»Ÿä¸€å­—æ®µåï¼‰
    private String rawData;           // åŸå§‹æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
}
```

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
