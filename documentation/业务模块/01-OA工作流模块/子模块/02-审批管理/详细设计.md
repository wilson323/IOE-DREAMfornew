# å®¡æ‰¹ç®¡ç† - è¯¦ç»†è®¾è®¡

> **ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“Š ç±»ç»“æ„è®¾è®¡

```mermaid
classDiagram
    class ApprovalController {
        +approve(form: ApprovalForm): ResponseDTO
        +reject(form: RejectForm): ResponseDTO
        +rollback(form: RollbackForm): ResponseDTO
        +transfer(form: TransferForm): ResponseDTO
        +batchApprove(form: BatchApprovalForm): ResponseDTO
    }
    
    class ApprovalService {
        <<interface>>
        +approve(taskId: String, comment: String): void
        +reject(taskId: String, reason: String): void
        +rollback(taskId: String, targetNode: String): void
        +transfer(taskId: String, targetUserId: Long): void
    }
    
    class ApprovalServiceImpl {
        -taskService: TaskService
        -runtimeService: RuntimeService
        -callbackManager: WorkflowCallbackManager
        +approve(taskId: String, comment: String): void
        +reject(taskId: String, reason: String): void
    }
    
    class WorkflowCallbackManager {
        +executeCallback(instanceId: String, result: String): void
        +getCallbackConfig(processKey: String): CallbackConfig
    }
    
    class ApprovalRecordService {
        +saveRecord(record: ApprovalRecordEntity): void
        +queryRecords(instanceId: Long): List~ApprovalRecordVO~
    }
    
    ApprovalController --> ApprovalService
    ApprovalServiceImpl ..|> ApprovalService
    ApprovalServiceImpl --> WorkflowCallbackManager
    ApprovalServiceImpl --> ApprovalRecordService
```

---

## ğŸ”§ APIæ¥å£è®¾è®¡

### å®¡æ‰¹é€šè¿‡

```
POST /api/oa/v1/approval/approve
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "taskId": "task-001",
  "comment": "åŒæ„ï¼Œç¬¦åˆè§„å®š",
  "variables": {
    "amount": 5000
  }
}
```

**å“åº”**:
```json
{
  "code": 0,
  "msg": "å®¡æ‰¹æˆåŠŸ",
  "data": {
    "processInstanceId": "instance-001",
    "nextNode": "éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹",
    "nextApprovers": ["å¼ ä¸‰", "æå››"]
  }
}
```

### å®¡æ‰¹æ‹’ç»

```
POST /api/oa/v1/approval/reject
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "taskId": "task-001",
  "reason": "é‡‘é¢è¶…å‡ºé¢„ç®—ï¼Œè¯·ä¿®æ”¹åé‡æ–°æäº¤"
}
```

### ä»»åŠ¡å›é€€

```
POST /api/oa/v1/approval/rollback
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "taskId": "task-001",
  "targetNodeId": "node-apply",
  "reason": "ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·è¡¥å……"
}
```

### æ‰¹é‡å®¡æ‰¹

```
POST /api/oa/v1/approval/batch
```

**è¯·æ±‚å‚æ•°**:
```json
{
  "taskIds": ["task-001", "task-002", "task-003"],
  "action": "APPROVE",
  "comment": "æ‰¹é‡å®¡æ‰¹é€šè¿‡"
}
```

---

## ğŸ“‹ å›è°ƒæœºåˆ¶è®¾è®¡

### å›è°ƒé…ç½®è¡¨

```sql
CREATE TABLE t_oa_workflow_callback (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    process_key VARCHAR(50) NOT NULL COMMENT 'æµç¨‹æ ‡è¯†',
    callback_url VARCHAR(200) NOT NULL COMMENT 'å›è°ƒåœ°å€',
    callback_method VARCHAR(10) DEFAULT 'POST' COMMENT 'è¯·æ±‚æ–¹æ³•',
    retry_times INT DEFAULT 3 COMMENT 'é‡è¯•æ¬¡æ•°',
    timeout INT DEFAULT 5000 COMMENT 'è¶…æ—¶æ¯«ç§’',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### å›è°ƒè¯·æ±‚æ ¼å¼

```json
{
  "processInstanceId": "instance-001",
  "processKey": "access_permission_apply",
  "businessKey": "apply-20251217-001",
  "result": "APPROVED",
  "applicantId": 1001,
  "formData": {
    "areaId": 100,
    "validDays": 30
  },
  "approvalRecords": [
    {
      "approver": "å¼ ä¸‰",
      "action": "APPROVE",
      "comment": "åŒæ„",
      "time": "2025-12-17 10:30:00"
    }
  ]
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ä»»åŠ¡ç¼“å­˜**: Redisç¼“å­˜å¾…åŠä»»åŠ¡åˆ—è¡¨
2. **å¼‚æ­¥å›è°ƒ**: å®¡æ‰¹å®Œæˆåå¼‚æ­¥æ‰§è¡Œä¸šåŠ¡å›è°ƒ
3. **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡å®¡æ‰¹å‡å°‘æ•°æ®åº“äº¤äº’
4. **ç´¢å¼•ä¼˜åŒ–**: å®¡æ‰¹è®°å½•è¡¨æŒ‰æ—¶é—´åˆ†åŒº

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
