# IOE-DREAM é€šçŸ¥ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æ›´æ–°æ—¥æœŸ**: 2025-12-16
**æ‰€å±æ¨¡å—**: å…¬å…±æ¨¡å—
**æœåŠ¡åç§°**: ioedream-common-service

---

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

### åŠŸèƒ½å®šä½
IOE-DREAMé€šçŸ¥ç³»ç»Ÿæ˜¯ä¼ä¸šçº§å¤šæ¸ é“æ™ºèƒ½é€šçŸ¥æ¨é€å¹³å°ï¼Œæä¾›ç»Ÿä¸€çš„æ¶ˆæ¯æ¨¡æ¿ç®¡ç†ã€å¤šæ¸ é“æ¨é€ã€æ™ºèƒ½è·¯ç”±ã€é™æµä¿æŠ¤ã€é‡è¯•æœºåˆ¶ç­‰åŠŸèƒ½ï¼Œæ”¯æŒé‚®ä»¶ã€çŸ­ä¿¡ã€å¾®ä¿¡ã€é’‰é’‰ã€Appæ¨é€ç­‰å¤šç§é€šçŸ¥æ–¹å¼ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… **å¤šæ¸ é“æ”¯æŒ**: é‚®ä»¶ã€çŸ­ä¿¡ã€å¾®ä¿¡ã€é’‰é’‰ã€Appæ¨é€ã€Webhook
- âœ… **æ™ºèƒ½æ¨¡æ¿ç®¡ç†**: æ”¯æŒå˜é‡æ›¿æ¢ã€å¤šçº§ç¼“å­˜ã€æ¨¡æ¿çƒ­æ›´æ–°
- âœ… **ç»Ÿä¸€é™æµä¿æŠ¤**: æ»‘åŠ¨çª—å£ç®—æ³•ï¼Œæ”¯æŒå¤šæ¸ é“ç‹¬ç«‹é™æµ
- âœ… **æ™ºèƒ½é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œæ”¯æŒé”™è¯¯ç æ£€æŸ¥
- âœ… **å®æ—¶ç›‘æ§**: Micrometeré›†æˆï¼Œæ”¯æŒPrometheuså¯¼å‡º
- âœ… **æ¶ˆæ¯æ ¼å¼**: æ”¯æŒMarkdownã€ActionCardã€FeedCardç­‰å¤šç§æ ¼å¼
- âœ… **é…ç½®ç®¡ç†**: ç»Ÿä¸€é…ç½®ç®¡ç†ï¼Œæ”¯æŒåŠ å¯†å­˜å‚¨ã€çƒ­æ›´æ–°

### ä¸šåŠ¡ä»·å€¼
- **ç»Ÿä¸€ç®¡ç†**: å»ºç«‹ä¼ä¸šçº§ç»Ÿä¸€é€šçŸ¥å¹³å°ï¼Œé¿å…é‡å¤å»ºè®¾
- **æå‡æ•ˆç‡**: æ™ºèƒ½æ¨é€å’Œè‡ªåŠ¨åŒ–å¤„ç†ï¼Œæå‡é€šçŸ¥é€è¾¾æ•ˆç‡
- **é™ä½æˆæœ¬**: ç»Ÿä¸€æ¸ é“ç®¡ç†å’Œä¼˜åŒ–ï¼Œé™ä½é€šçŸ¥å‘é€æˆæœ¬
- **å¢å¼ºä½“éªŒ**: ä¸ªæ€§åŒ–é€šçŸ¥å’Œå¤šæ¸ é“è¦†ç›–ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **æ•°æ®é©±åŠ¨**: å®Œæ•´çš„é€šçŸ¥æ•°æ®åˆ†æå’Œç›‘æ§ï¼Œæ”¯æŒä¸šåŠ¡å†³ç­–

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```mermaid
flowchart TD
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[Webç®¡ç†ç«¯]
        B[ç§»åŠ¨ç«¯App]
        C[ä¸šåŠ¡ç³»ç»Ÿ]
        D[ç¬¬ä¸‰æ–¹ç³»ç»Ÿ]
    end

    subgraph "APIç½‘å…³å±‚"
        E[API Gateway<br/>ioedream-gateway-service]
    end

    subgraph "é€šçŸ¥ç³»ç»Ÿå±‚"
        F[é€šçŸ¥ç®¡ç†æ§åˆ¶å™¨<br/>NotificationController]
        G[é€šçŸ¥æœåŠ¡<br/>NotificationService]
        H[æ¨¡æ¿ç®¡ç†å™¨<br/>NotificationTemplateManager]
        I[å‘é€ç®¡ç†å™¨<br/>NotificationSender]
        J[é™æµå™¨<br/>RateLimiter]
        K[é‡è¯•ç®¡ç†å™¨<br/>RetryManager]
        L[ç›‘æ§æ”¶é›†å™¨<br/>MetricsCollector]
    end

    subgraph "æ¸ é“é€‚é…å±‚"
        M[é‚®ä»¶é€‚é…å™¨<br/>EmailAdapter]
        N[çŸ­ä¿¡é€‚é…å™¨<br/>SmsAdapter]
        O[å¾®ä¿¡é€‚é…å™¨<br/>WechatAdapter]
        P[é’‰é’‰é€‚é…å™¨<br/>DingTalkAdapter]
        Q[Appæ¨é€é€‚é…å™¨<br/>AppPushAdapter]
        R[Webhooké€‚é…å™¨<br/>WebhookAdapter]
    end

    subgraph "ç¬¬ä¸‰æ–¹æœåŠ¡å±‚"
        S[é‚®ä»¶æœåŠ¡å•†<br/>SMTP/é˜¿é‡Œäº‘é‚®ä»¶]
        T[çŸ­ä¿¡æœåŠ¡å•†<br/>é˜¿é‡Œäº‘/è…¾è®¯äº‘çŸ­ä¿¡]
        U[å¾®ä¿¡æœåŠ¡<br/>ä¼ä¸šå¾®ä¿¡API]
        V[é’‰é’‰æœåŠ¡<br/>é’‰é’‰æœºå™¨äººAPI]
        W[æ¨é€æœåŠ¡<br/>æå…‰/å°ç±³æ¨é€]
        X[WebhookæœåŠ¡<br/>ç¬¬ä¸‰æ–¹ç³»ç»Ÿ]
    end

    subgraph "æ•°æ®å­˜å‚¨å±‚"
        Y[(MySQL<br/>é€šçŸ¥æ•°æ®)]
        Z[(Redis<br/>ç¼“å­˜&é˜Ÿåˆ—)]
        AA[(Elasticsearch<br/>æ—¥å¿—ç´¢å¼•)]
    end

    A --> E
    B --> E
    C --> E
    D --> E

    E --> F
    F --> G
    G --> H
    G --> I
    I --> J
    I --> K
    G --> L

    I --> M
    I --> N
    I --> O
    I --> P
    I --> Q
    I --> R

    M --> S
    N --> T
    O --> U
    P --> V
    Q --> W
    R --> X

    G --> Y
    G --> Z
    G --> AA
```

### æ ¸å¿ƒç»„ä»¶æ¶æ„

```mermaid
flowchart TD
    A[é€šçŸ¥è¯·æ±‚] --> B[å‚æ•°éªŒè¯]
    B --> C[æƒé™æ£€æŸ¥]
    C --> D[æ¨¡æ¿æ¸²æŸ“]
    D --> E[é™æµæ£€æŸ¥]
    E --> F[å¤šæ¸ é“å‘é€]
    F --> G[ç»“æœæ±‡æ€»]
    G --> H[çŠ¶æ€æ›´æ–°]
    H --> I[ç›‘æ§è®°å½•]
    I --> J[å“åº”è¿”å›]

    subgraph "æ¨¡æ¿å¤„ç†"
        D1[æ¨¡æ¿åŠ è½½å™¨]
        D2[å˜é‡æ›¿æ¢å™¨]
        D3[å†…å®¹æ¸²æŸ“å™¨]
        D4[æ ¼å¼è½¬æ¢å™¨]
    end

    subgraph "å‘é€å¤„ç†"
        F1[é‚®ä»¶å‘é€å™¨]
        F2[çŸ­ä¿¡å‘é€å™¨]
        F3[å¾®ä¿¡å‘é€å™¨]
        F4[é’‰é’‰å‘é€å™¨]
        F5[Appæ¨é€å‘é€å™¨]
        F6[Webhookå‘é€å™¨]
    end

    subgraph "å¼‚å¸¸å¤„ç†"
        E1[é™æµæ‹¦æˆªå™¨]
        E2[é¢‘ç‡æ§åˆ¶å™¨]
        E3[é»‘åå•æ£€æŸ¥å™¨]
        E4[å†…å®¹è¿‡æ»¤å™¨]
    end

    subgraph "ç›‘æ§å¤„ç†"
        I1[æˆåŠŸç»Ÿè®¡å™¨]
        I2[å¤±è´¥ç»Ÿè®¡å™¨]
        I3[æ€§èƒ½ç»Ÿè®¡å™¨]
        I4[æ¸ é“ç»Ÿè®¡å™¨]
    end

    D --> D1
    D1 --> D2
    D2 --> D3
    D3 --> D4

    E --> E1
    E1 --> E2
    E2 --> E3
    E3 --> E4

    F --> F1
    F --> F2
    F --> F3
    F --> F4
    F --> F5
    F --> F6

    I --> I1
    I --> I2
    I --> I3
    I --> I4
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### é€šçŸ¥æ¶ˆæ¯è¡¨

```sql
CREATE TABLE `t_notification` (
    `notification_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'é€šçŸ¥ID',
    `batch_id` VARCHAR(50) COMMENT 'æ‰¹æ¬¡ID',
    `sender_id` BIGINT COMMENT 'å‘é€è€…ID',
    `sender_name` VARCHAR(100) COMMENT 'å‘é€è€…å§“å',
    `receiver_type` VARCHAR(20) NOT NULL COMMENT 'æ¥æ”¶è€…ç±»å‹ï¼šUSER-ç”¨æˆ· ROLE-è§’è‰² DEPT-éƒ¨é—¨ ALL-å…¨éƒ¨',
    `receiver_ids` TEXT COMMENT 'æ¥æ”¶è€…IDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰',
    `receiver_count` INT DEFAULT 0 COMMENT 'æ¥æ”¶è€…æ•°é‡',
    `notification_type` VARCHAR(20) NOT NULL COMMENT 'é€šçŸ¥ç±»å‹ï¼šSYSTEM-ç³»ç»Ÿ BUSINESS-ä¸šåŠ¡ SECURITY-å®‰å…¨ REMINDER-æé†’',
    `title` VARCHAR(200) NOT NULL COMMENT 'é€šçŸ¥æ ‡é¢˜',
    `content` TEXT NOT NULL COMMENT 'é€šçŸ¥å†…å®¹',
    `template_code` VARCHAR(50) COMMENT 'æ¨¡æ¿ç¼–ç ',
    `template_data` TEXT COMMENT 'æ¨¡æ¿æ•°æ®JSON',
    `channels` VARCHAR(100) COMMENT 'æ¨é€æ¸ é“ï¼šEMAIL-é‚®ä»¶ SMS-çŸ­ä¿¡ WECHAT-å¾®ä¿¡ DINGTALK-é’‰é’‰ APP-åº”ç”¨',
    `priority` VARCHAR(10) DEFAULT 'MEDIUM' COMMENT 'ä¼˜å…ˆçº§ï¼šHIGH-é«˜ MEDIUM-ä¸­ LOW-ä½',
    `status` VARCHAR(20) DEFAULT 'PENDING' COMMENT 'çŠ¶æ€ï¼šPENDING-å¾…å‘é€ SENDING-å‘é€ä¸­ SENT-å·²å‘é€ FAILED-å¤±è´¥ CANCELLED-å·²å–æ¶ˆ',
    `send_status` VARCHAR(100) COMMENT 'å„æ¸ é“å‘é€çŠ¶æ€JSON',
    `schedule_type` VARCHAR(20) DEFAULT 'IMMEDIATE' COMMENT 'å‘é€ç±»å‹ï¼šIMMEDIATE-ç«‹å³ SCHEDULE-è®¡åˆ’',
    `schedule_time` DATETIME COMMENT 'è®¡åˆ’å‘é€æ—¶é—´',
    `sent_time` DATETIME COMMENT 'å‘é€æ—¶é—´',
    `read_time` DATETIME COMMENT 'é˜…è¯»æ—¶é—´',
    `expire_time` DATETIME COMMENT 'è¿‡æœŸæ—¶é—´',
    `retry_count` INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    `max_retry_count` INT DEFAULT 3 COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°',
    `attachments` TEXT COMMENT 'é™„ä»¶ä¿¡æ¯JSON',
    `buttons` TEXT COMMENT 'æŒ‰é’®ä¿¡æ¯JSON',
    `extra_data` TEXT COMMENT 'æ‰©å±•æ•°æ®JSON',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`notification_id`),
    KEY `idx_batch_id` (`batch_id`),
    KEY `idx_sender_id` (`sender_id`),
    KEY `idx_type_status` (`notification_type`, `status`),
    KEY `idx_priority_time` (`priority`, `create_time`),
    KEY `idx_schedule_time` (`schedule_time`),
    KEY `idx_receiver_type` (`receiver_type`),
    KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šçŸ¥æ¶ˆæ¯è¡¨';
```

#### é€šçŸ¥æ¨¡æ¿è¡¨

```sql
CREATE TABLE `t_notification_template` (
    `template_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'æ¨¡æ¿ID',
    `template_code` VARCHAR(50) NOT NULL COMMENT 'æ¨¡æ¿ç¼–ç ',
    `template_name` VARCHAR(100) NOT NULL COMMENT 'æ¨¡æ¿åç§°',
    `template_type` VARCHAR(20) NOT NULL COMMENT 'æ¨¡æ¿ç±»å‹ï¼šEMAIL-é‚®ä»¶ SMS-çŸ­ä¿¡ WECHAT-å¾®ä¿¡ DINGTALK-é’‰é’‰ APP-åº”ç”¨',
    `category` VARCHAR(20) COMMENT 'åˆ†ç±»ï¼šSYSTEM-ç³»ç»Ÿ BUSINESS-ä¸šåŠ¡ SECURITY-å®‰å…¨ REMINDER-æé†’ MARKETING-è¥é”€',
    `subject` VARCHAR(200) COMMENT 'ä¸»é¢˜ï¼ˆé‚®ä»¶ä¸“ç”¨ï¼‰',
    `content` TEXT NOT NULL COMMENT 'å†…å®¹æ¨¡æ¿',
    `variables` TEXT COMMENT 'å˜é‡å®šä¹‰JSON',
    `attachment_enabled` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦æ”¯æŒé™„ä»¶',
    `button_enabled` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦æ”¯æŒæŒ‰é’®',
    `html_enabled` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦æ”¯æŒHTML',
    `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-å¯ç”¨ 0-ç¦ç”¨',
    `version` INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
    `usage_count` INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
    `success_rate` DECIMAL(5,4) DEFAULT 0.0000 COMMENT 'æˆåŠŸç‡',
    `description` VARCHAR(500) COMMENT 'æ¨¡æ¿æè¿°',
    `created_by` BIGINT COMMENT 'åˆ›å»ºäººID',
    `updated_by` BIGINT COMMENT 'æ›´æ–°äººID',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`template_id`),
    UNIQUE KEY `uk_template_code` (`template_code`),
    KEY `idx_type_status` (`template_type`, `status`),
    KEY `idx_category` (`category`),
    KEY `idx_status_success_rate` (`status`, `success_rate`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šçŸ¥æ¨¡æ¿è¡¨';
```

#### é€šçŸ¥é…ç½®è¡¨

```sql
CREATE TABLE `t_notification_config` (
    `config_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'é…ç½®ID',
    `config_key` VARCHAR(100) NOT NULL COMMENT 'é…ç½®é”®',
    `config_value` TEXT COMMENT 'é…ç½®å€¼',
    `config_type` VARCHAR(20) NOT NULL COMMENT 'é…ç½®ç±»å‹ï¼šCHANNEL-æ¸ é“ TEMPLATE-æ¨¡æ¿ GLOBAL-å…¨å±€',
    `config_desc` VARCHAR(200) COMMENT 'é…ç½®æè¿°',
    `is_encrypted` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦åŠ å¯†ï¼š1-æ˜¯ 0-å¦',
    `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-å¯ç”¨ 0-ç¦ç”¨',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`config_id`),
    UNIQUE KEY `uk_config_key` (`config_key`),
    KEY `idx_type_status` (`config_type`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šçŸ¥é…ç½®è¡¨';
```

#### é€šçŸ¥å‘é€è®°å½•è¡¨

```sql
CREATE TABLE `t_notification_send_record` (
    `record_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•ID',
    `notification_id` BIGINT NOT NULL COMMENT 'é€šçŸ¥ID',
    `channel` VARCHAR(20) NOT NULL COMMENT 'å‘é€æ¸ é“',
    `receiver_id` BIGINT COMMENT 'æ¥æ”¶è€…ID',
    `receiver_address` VARCHAR(200) COMMENT 'æ¥æ”¶è€…åœ°å€ï¼ˆé‚®ç®±/æ‰‹æœºå·ç­‰ï¼‰',
    `message_id` VARCHAR(100) COMMENT 'å¤–éƒ¨æ¶ˆæ¯ID',
    `send_status` VARCHAR(20) NOT NULL COMMENT 'å‘é€çŠ¶æ€ï¼šPENDING-å¾…å‘é€ SENDING-å‘é€ä¸­ SUCCESS-æˆåŠŸ FAILED-å¤±è´¥',
    `send_time` DATETIME COMMENT 'å‘é€æ—¶é—´',
    `response_time` DATETIME COMMENT 'å“åº”æ—¶é—´',
    `duration` BIGINT COMMENT 'å‘é€è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰',
    `error_code` VARCHAR(50) COMMENT 'é”™è¯¯ç ',
    `error_message` TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    `response_data` TEXT COMMENT 'å“åº”æ•°æ®JSON',
    `retry_count` INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    `is_success` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦æˆåŠŸï¼š1-æ˜¯ 0-å¦',
    `read_status` VARCHAR(20) COMMENT 'é˜…è¯»çŠ¶æ€ï¼šUNREAD-æœªè¯» READ-å·²è¯»',
    `read_time` DATETIME COMMENT 'é˜…è¯»æ—¶é—´',
    `click_status` VARCHAR(20) COMMENT 'ç‚¹å‡»çŠ¶æ€ï¼šUNCHECKED-æœªç‚¹å‡» CLICKED-å·²ç‚¹å‡»',
    `click_time` DATETIME COMMENT 'ç‚¹å‡»æ—¶é—´',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    PRIMARY KEY (`record_id`),
    KEY `idx_notification_id` (`notification_id`),
    KEY `idx_channel_status` (`channel`, `send_status`),
    KEY `idx_receiver_id` (`receiver_id`),
    KEY `idx_send_time` (`send_time`),
    KEY `idx_success` (`is_success`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šçŸ¥å‘é€è®°å½•è¡¨';
```

#### ç”¨æˆ·é€šçŸ¥åå¥½è¡¨

```sql
CREATE TABLE `t_user_notification_preference` (
    `preference_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'åå¥½ID',
    `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    `email_enabled` TINYINT DEFAULT 1 COMMENT 'é‚®ä»¶é€šçŸ¥å¼€å…³',
    `sms_enabled` TINYINT DEFAULT 1 COMMENT 'çŸ­ä¿¡é€šçŸ¥å¼€å…³',
    `wechat_enabled` TINYINT DEFAULT 1 COMMENT 'å¾®ä¿¡é€šçŸ¥å¼€å…³',
    `dingtalk_enabled` TINYINT DEFAULT 1 COMMENT 'é’‰é’‰é€šçŸ¥å¼€å…³',
    `app_push_enabled` TINYINT DEFAULT 1 COMMENT 'Appæ¨é€å¼€å…³',
    `quiet_hours_enabled` TINYINT DEFAULT 0 COMMENT 'å…æ‰“æ‰°æ—¶é—´å¼€å…³',
    `quiet_hours_start` TIME COMMENT 'å…æ‰“æ‰°å¼€å§‹æ—¶é—´',
    `quiet_hours_end` TIME COMMENT 'å…æ‰“æ‰°ç»“æŸæ—¶é—´',
    `notification_types` TEXT COMMENT 'é€šçŸ¥ç±»å‹åå¥½JSON',
    `max_daily_count` INT DEFAULT 50 COMMENT 'æ¯æ—¥æœ€å¤§é€šçŸ¥æ•°é‡',
    `frequency_control` VARCHAR(20) DEFAULT 'NORMAL' COMMENT 'é¢‘ç‡æ§åˆ¶ï¼šNORMAL-æ­£å¸¸ LOW-ä½ FREQUENCY-æä½',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`preference_id`),
    UNIQUE KEY `uk_user_id` (`user_id`),
    KEY `idx_enabled_flags` (`email_enabled`, `sms_enabled`, `wechat_enabled`, `app_push_enabled`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·é€šçŸ¥åå¥½è¡¨';
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### é€šçŸ¥å‘é€æ¥å£

#### å‘é€å•ä¸ªé€šçŸ¥

```java
@RestController
@RequestMapping("/api/v1/notification")
@Tag(name = "é€šçŸ¥å‘é€")
public class NotificationController {

    @PostMapping("/send")
    @Operation(summary = "å‘é€é€šçŸ¥")
    @RateLimiter(name = "notification-send", fallbackMethod = "sendFallback")
    public ResponseDTO<NotificationResultVO> sendNotification(
            @Valid @RequestBody NotificationSendDTO sendDTO) {

        NotificationResultDTO result = notificationService.sendNotification(sendDTO);
        return ResponseDTO.ok(convertToVO(result));
    }

    @PostMapping("/batch")
    @Operation(summary = "æ‰¹é‡å‘é€é€šçŸ¥")
    @RateLimiter(name = "notification-batch", fallbackMethod = "batchSendFallback")
    public ResponseDTO<List<NotificationResultVO>> batchSendNotification(
            @Valid @RequestBody NotificationBatchDTO batchDTO) {

        List<NotificationResultDTO> results = notificationService.batchSendNotification(batchDTO);
        return ResponseDTO.ok(results.stream().map(this::convertToVO).collect(Collectors.toList()));
    }

    @PostMapping("/schedule")
    @Operation(summary = "è®¡åˆ’å‘é€é€šçŸ¥")
    public ResponseDTO<String> scheduleNotification(
            @Valid @RequestBody NotificationScheduleDTO scheduleDTO) {

        String scheduleId = notificationService.scheduleNotification(scheduleDTO);
        return ResponseDTO.ok(scheduleId);
    }
}
```

#### é€šçŸ¥ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/v1/notification/manage")
@Tag(name = "é€šçŸ¥ç®¡ç†")
public class NotificationManageController {

    @GetMapping("/list")
    @Operation(summary = "è·å–é€šçŸ¥åˆ—è¡¨")
    public ResponseDTO<PageResult<NotificationVO>> getNotificationList(
            @Valid @ModelAttribute NotificationQueryForm queryForm) {

        PageResult<NotificationEntity> pageResult = notificationService.queryNotificationPage(queryForm);
        return ResponseDTO.ok(convertToVO(pageResult));
    }

    @GetMapping("/{notificationId}")
    @Operation(summary = "è·å–é€šçŸ¥è¯¦æƒ…")
    public ResponseDTO<NotificationDetailVO> getNotificationDetail(@PathVariable Long notificationId) {

        NotificationEntity notification = notificationService.getById(notificationId);
        List<NotificationSendRecordEntity> records = notificationService.getSendRecords(notificationId);
        return ResponseDTO.ok(convertToDetailVO(notification, records));
    }

    @PutMapping("/{notificationId}/read")
    @Operation(summary = "æ ‡è®°é€šçŸ¥å·²è¯»")
    public ResponseDTO<Void> markNotificationRead(@PathVariable Long notificationId) {

        notificationService.markAsRead(notificationId);
        return ResponseDTO.ok();
    }

    @DeleteMapping("/{notificationId}")
    @Operation(summary = "å–æ¶ˆé€šçŸ¥")
    public ResponseDTO<Void> cancelNotification(@PathVariable Long notificationId) {

        notificationService.cancelNotification(notificationId);
        return ResponseDTO.ok();
    }
}
```

#### æ¨¡æ¿ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/v1/notification/template")
@Tag(name = "é€šçŸ¥æ¨¡æ¿")
public class NotificationTemplateController {

    @GetMapping("/list")
    @Operation(summary = "è·å–æ¨¡æ¿åˆ—è¡¨")
    public ResponseDTO<PageResult<NotificationTemplateVO>> getTemplateList(
            @Valid @ModelAttribute TemplateQueryForm queryForm) {

        PageResult<NotificationTemplateEntity> pageResult = templateService.queryTemplatePage(queryForm);
        return ResponseDTO.ok(convertToVO(pageResult));
    }

    @PostMapping
    @Operation(summary = "åˆ›å»ºé€šçŸ¥æ¨¡æ¿")
    public ResponseDTO<Long> createTemplate(@Valid @RequestBody NotificationTemplateAddForm addForm) {

        Long templateId = templateService.createTemplate(addForm);
        return ResponseDTO.ok(templateId);
    }

    @PutMapping("/{templateId}")
    @Operation(summary = "æ›´æ–°é€šçŸ¥æ¨¡æ¿")
    public ResponseDTO<Void> updateTemplate(@PathVariable Long templateId,
                                           @Valid @RequestBody NotificationTemplateUpdateForm updateForm) {

        templateService.updateTemplate(templateId, updateForm);
        return ResponseDTO.ok();
    }

    @DeleteMapping("/{templateId}")
    @Operation(summary = "åˆ é™¤é€šçŸ¥æ¨¡æ¿")
    public ResponseDTO<Void> deleteTemplate(@PathVariable Long templateId) {

        templateService.deleteTemplate(templateId);
        return ResponseDTO.ok();
    }

    @PostMapping("/render")
    @Operation(summary = "æ¸²æŸ“æ¨¡æ¿")
    public ResponseDTO<String> renderTemplate(@Valid @RequestBody TemplateRenderDTO renderDTO) {

        String content = templateService.renderTemplate(renderDTO);
        return ResponseDTO.ok(content);
    }

    @GetMapping("/{templateCode}/variables")
    @Operation(summary = "è·å–æ¨¡æ¿å˜é‡")
    public ResponseDTO<List<TemplateVariableVO>> getTemplateVariables(@PathVariable String templateCode) {

        List<TemplateVariableEntity> variables = templateService.getTemplateVariables(templateCode);
        return ResponseDTO.ok(convertToVO(variables));
    }
}
```

#### ç»Ÿè®¡åˆ†ææ¥å£

```java
@RestController
@RequestMapping("/api/v1/notification/statistics")
@Tag(name = "é€šçŸ¥ç»Ÿè®¡")
public class NotificationStatisticsController {

    @GetMapping("/overview")
    @Operation(summary = "è·å–é€šçŸ¥æ€»è§ˆç»Ÿè®¡")
    public ResponseDTO<NotificationOverviewVO> getOverviewStatistics(
            @Valid @ModelAttribute StatisticsQueryForm queryForm) {

        NotificationOverviewDTO statistics = statisticsService.getOverviewStatistics(queryForm);
        return ResponseDTO.ok(convertToVO(statistics));
    }

    @GetMapping("/channel")
    @Operation(summary = "è·å–æ¸ é“ç»Ÿè®¡")
    public ResponseDTO<List<ChannelStatisticsVO>> getChannelStatistics(
            @Valid @ModelAttribute StatisticsQueryForm queryForm) {

        List<ChannelStatisticsDTO> statistics = statisticsService.getChannelStatistics(queryForm);
        return ResponseDTO.ok(statistics.stream().map(this::convertToVO).collect(Collectors.toList()));
    }

    @GetMapping("/trend")
    @Operation(summary = "è·å–è¶‹åŠ¿ç»Ÿè®¡")
    public ResponseDTO<NotificationTrendVO> getTrendStatistics(
            @Valid @ModelAttribute TrendStatisticsQueryForm queryForm) {

        NotificationTrendDTO statistics = statisticsService.getTrendStatistics(queryForm);
        return ResponseDTO.ok(convertToVO(statistics));
    }

    @GetMapping("/performance")
    @Operation(summary = "è·å–æ€§èƒ½ç»Ÿè®¡")
    public ResponseDTO<NotificationPerformanceVO> getPerformanceStatistics(
            @Valid @ModelAttribute PerformanceQueryForm queryForm) {

        NotificationPerformanceDTO statistics = statisticsService.getPerformanceStatistics(queryForm);
        return ResponseDTO.ok(convertToVO(statistics));
    }
}
```

---

## ğŸ› ï¸ æ ¸å¿ƒåŠŸèƒ½å®ç°

### é€šçŸ¥å‘é€æœåŠ¡

#### æ ¸å¿ƒå‘é€é€»è¾‘

```java
@Service
@Slf4j
public class NotificationServiceImpl implements NotificationService {

    @Resource
    private NotificationSender notificationSender;

    @Resource
    private NotificationTemplateService templateService;

    @Resource
    private RateLimiter rateLimiter;

    @Resource
    private RetryManager retryManager;

    @Resource
    private NotificationDao notificationDao;

    @Override
    @Async("notificationTaskExecutor")
    @Retry(name = "notification-send", fallbackMethod = "sendFallback")
    public NotificationResultDTO sendNotification(NotificationSendDTO sendDTO) {
        log.info("å¼€å§‹å‘é€é€šçŸ¥: title={}, channels={}", sendDTO.getTitle(), sendDTO.getChannels());

        try {
            // 1. å‚æ•°éªŒè¯
            validateSendDTO(sendDTO);

            // 2. æ¨¡æ¿æ¸²æŸ“
            if (StringUtils.isNotEmpty(sendDTO.getTemplateCode())) {
                renderTemplateContent(sendDTO);
            }

            // 3. åˆ›å»ºé€šçŸ¥è®°å½•
            NotificationEntity notification = createNotification(sendDTO);

            // 4. é™æµæ£€æŸ¥
            checkRateLimit(sendDTO);

            // 5. å¤šæ¸ é“å‘é€
            NotificationResultDTO result = notificationSender.sendNotification(notification);

            // 6. æ›´æ–°é€šçŸ¥çŠ¶æ€
            updateNotificationStatus(notification.getNotificationId(), result);

            // 7. è®°å½•å‘é€è®°å½•
            recordSendHistory(notification, result);

            log.info("é€šçŸ¥å‘é€å®Œæˆ: notificationId={}, success={}",
                    notification.getNotificationId(), result.isOverallSuccess());

            return result;

        } catch (Exception e) {
            log.error("é€šçŸ¥å‘é€å¤±è´¥: title=" + sendDTO.getTitle(), e);
            throw new BusinessException("NOTIFICATION_SEND_FAILED", "é€šçŸ¥å‘é€å¤±è´¥: " + e.getMessage());
        }
    }

    private void renderTemplateContent(NotificationSendDTO sendDTO) {
        Map<String, Object> variables = new HashMap<>();
        if (sendDTO.getTemplateData() != null) {
            variables.putAll(sendDTO.getTemplateData());
        }

        String content = templateService.renderTemplate(
            sendDTO.getTemplateCode(),
            variables
        );

        sendDTO.setContent(content);
    }

    private void checkRateLimit(NotificationSendDTO sendDTO) {
        String[] channels = sendDTO.getChannels().split(",");
        for (String channel : channels) {
            if (!rateLimiter.tryAcquire(channel, getChannelLimit(channel), 60)) {
                throw new BusinessException("RATE_LIMIT_EXCEEDED",
                    "é€šçŸ¥å‘é€é¢‘ç‡è¶…é™: " + channel);
            }
        }
    }
}
```

#### å¤šæ¸ é“å‘é€å™¨

```java
@Service
@Slf4j
public class NotificationSender {

    @Resource
    private Map<String, NotificationChannel> channelMap;

    @Resource
    private NotificationMetricsCollector metricsCollector;

    /**
     * å¤šæ¸ é“å‘é€é€šçŸ¥
     */
    public NotificationResultDTO sendNotification(NotificationEntity notification) {
        List<NotificationChannelResult> channelResults = new ArrayList<>();
        boolean overallSuccess = false;

        String[] channels = notification.getChannels().split(",");
        Duration totalDuration = Duration.ZERO;

        for (String channel : channels) {
            Duration channelDuration = Duration.ZERO;
            boolean channelSuccess = false;

            try {
                long startTime = System.currentTimeMillis();

                NotificationChannelResult result = sendByChannel(notification, channel.trim());
                channelResults.add(result);
                channelSuccess = result.isSuccess();

                long endTime = System.currentTimeMillis();
                channelDuration = Duration.ofMillis(endTime - startTime);
                totalDuration = totalDuration.plus(channelDuration);

                if (channelSuccess) {
                    overallSuccess = true;
                    log.info("æ¸ é“å‘é€æˆåŠŸ: channel={}, messageId={}, duration={}ms",
                            channel, result.getMessageId(), channelDuration.toMillis());
                } else {
                    log.error("æ¸ é“å‘é€å¤±è´¥: channel={}, error={}, duration={}ms",
                            channel, result.getErrorMessage(), channelDuration.toMillis());
                }

            } catch (Exception e) {
                log.error("æ¸ é“å‘é€å¼‚å¸¸: channel=" + channel, e);
                channelResults.add(NotificationChannelResult.failure(channel, e.getMessage()));
            }

            // è®°å½•æŒ‡æ ‡
            metricsCollector.recordSend(channel, channelSuccess);
            metricsCollector.recordSendTime(channel, channelDuration);
        }

        return NotificationResultDTO.builder()
                .notificationId(notification.getNotificationId())
                .channelResults(channelResults)
                .overallSuccess(overallSuccess)
                .totalDuration(totalDuration)
                .successCount((int) channelResults.stream().mapToInt(r -> r.isSuccess() ? 1 : 0).sum())
                .failureCount((int) channelResults.stream().mapToInt(r -> r.isSuccess() ? 0 : 1).sum())
                .build();
    }

    private NotificationChannelResult sendByChannel(NotificationEntity notification, String channel) {
        NotificationChannel channelSender = channelMap.get(channel.toUpperCase());
        if (channelSender == null) {
            throw new IllegalArgumentException("ä¸æ”¯æŒçš„é€šçŸ¥æ¸ é“: " + channel);
        }

        return channelSender.send(notification);
    }
}
```

### é™æµä¿æŠ¤æœºåˆ¶

#### æ»‘åŠ¨çª—å£é™æµå™¨

```java
@Service
@Slf4j
public class SlidingWindowRateLimiter implements RateLimiter {

    @Resource
    private RedisTemplate<String, Object> redisTemplate;

    @Override
    public boolean tryAcquire(String key, int limit, int windowSizeInSeconds) {
        String redisKey = "rate_limit:notification:" + key;
        long currentTime = System.currentTimeMillis();
        long windowStart = currentTime - windowSizeInSeconds * 1000L;

        // Redis Luaè„šæœ¬å®ç°æ»‘åŠ¨çª—å£
        String script =
            "local current = redis.call('ZRANGEBYSCORE', KEYS[1], ARGV[1], ARGV[2]) " +
            "redis.call('ZREMRANGEBYSCORE', KEYS[1], '-inf', ARGV[1]) " +
            "redis.call('ZADD', KEYS[1], ARGV[3], ARGV[4]) " +
            "redis.call('EXPIRE', KEYS[1], ARGV[2]) " +
            "return #current";

        try {
            List<Object> result = redisTemplate.execute(
                new DefaultRedisScript<>(script, List.class),
                Collections.singletonList(redisKey),
                String.valueOf(windowStart),
                String.valueOf(windowSizeInSeconds),
                String.valueOf(currentTime),
                currentTime + ":" + ThreadLocalRandom.current().nextInt(1000)
            );

            return ((List<Long>) result.get(0)).size() < limit;

        } catch (Exception e) {
            log.error("é™æµæ£€æŸ¥å¤±è´¥: key=" + key, e);
            return false;
        }
    }

    /**
     * è·å–æ¸ é“é™æµé…ç½®
     */
    private int getChannelLimit(String channel) {
        // ä»é…ç½®ä¸­è·å–å„æ¸ é“çš„é™æµå€¼
        return switch (channel.toUpperCase()) {
            case "EMAIL" -> 100;
            case "SMS" -> 50;
            case "WECHAT" -> 200;
            case "DINGTALK" -> 200;
            case "APP" -> 500;
            default -> 100;
        };
    }
}
```

### é‡è¯•æœºåˆ¶

#### æŒ‡æ•°é€€é¿é‡è¯•å™¨

```java
@Service
@Slf4j
public class ExponentialBackoffRetryManager implements RetryManager {

    @Value("${notification.retry.max-attempts:3}")
    private int maxAttempts;

    @Value("${notification.retry.initial-delay:1000}")
    private long initialDelayMs;

    @Value("${notification.retry.max-delay:60000}")
    private long maxDelayMs;

    @Value("${notification.retry.multiplier:2}")
    private double multiplier;

    @Override
    public boolean shouldRetry(String errorCode, int attemptCount) {
        return attemptCount < maxAttempts && isRetryableError(errorCode);
    }

    @Override
    public long calculateRetryDelay(int attemptCount) {
        long delay = (long) (initialDelayMs * Math.pow(multiplier, attemptCount - 1));
        return Math.min(delay, maxDelayMs);
    }

    @Override
    public void retrySend(NotificationEntity notification, int attemptCount) {
        log.info("é‡è¯•å‘é€é€šçŸ¥: notificationId={}, attemptCount={}",
                notification.getNotificationId(), attemptCount);

        try {
            long delay = calculateRetryDelay(attemptCount);
            if (delay > 0) {
                Thread.sleep(delay);
            }

            // é‡æ–°å‘é€
            NotificationResultDTO result = notificationSender.sendNotification(notification);

            if (result.isOverallSuccess()) {
                log.info("é‡è¯•å‘é€æˆåŠŸ: notificationId={}", notification.getNotificationId());
            } else {
                log.warn("é‡è¯•å‘é€ä»ç„¶å¤±è´¥: notificationId={}", notification.getNotificationId());
            }

        } catch (Exception e) {
            log.error("é‡è¯•å‘é€å¤±è´¥: notificationId={}, attemptCount={}",
                    notification.getNotificationId(), attemptCount, e);
        }
    }

    private boolean isRetryableError(String errorCode) {
        // å®šä¹‰å¯é‡è¯•çš„é”™è¯¯ç 
        List<String> retryableErrors = Arrays.asList(
            "TIMEOUT", "NETWORK_ERROR", "SERVICE_UNAVAILABLE",
            "RATE_LIMIT", "TEMPORARY_FAILURE"
        );
        return retryableErrors.contains(errorCode);
    }
}
```

### æ¨¡æ¿ç®¡ç†

#### æ¨¡æ¿æ¸²æŸ“å¼•æ“

```java
@Service
@Slf4j
public class FreemarkerTemplateRenderer implements TemplateRenderer {

    @Resource
    private Configuration freemarkerConfiguration;

    @Resource
    private NotificationTemplateDao templateDao;

    @Cacheable(value = "template:content", key = "#templateCode")
    public String renderTemplate(String templateCode, Map<String, Object> variables) {
        try {
            // è·å–æ¨¡æ¿
            NotificationTemplateEntity template = templateDao.selectByCode(templateCode);
            if (template == null || template.getStatus() != 1) {
                throw new BusinessException("TEMPLATE_NOT_FOUND", "æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨: " + templateCode);
            }

            // è§£ææ¨¡æ¿å†…å®¹
            Template template = new Template("template",
                    template.getContent(),
                    freemarkerConfiguration);

            // æ¸²æŸ“æ¨¡æ¿
            StringWriter writer = new StringWriter();
            template.process(variables, writer);

            // æ›´æ–°ä½¿ç”¨æ¬¡æ•°
            templateDao.incrementUsageCount(template.getTemplateId());

            return writer.toString();

        } catch (Exception e) {
            log.error("æ¨¡æ¿æ¸²æŸ“å¤±è´¥: templateCode=" + templateCode, e);
            throw new BusinessException("TEMPLATE_RENDER_FAILED",
                "æ¨¡æ¿æ¸²æŸ“å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * éªŒè¯æ¨¡æ¿å˜é‡
     */
    public void validateTemplateVariables(String templateCode, Map<String, Object> variables) {
        NotificationTemplateEntity template = templateDao.selectByCode(templateCode);
        if (template == null) {
            return;
        }

        List<TemplateVariable> requiredVariables = parseTemplateVariables(template.getVariables());

        for (TemplateVariable variable : requiredVariables) {
            if (variable.isRequired() && !variables.containsKey(variable.getName())) {
                throw new BusinessException("MISSING_VARIABLE",
                    "ç¼ºå°‘å¿…éœ€çš„æ¨¡æ¿å˜é‡: " + variable.getName());
            }
        }
    }

    private List<TemplateVariable> parseTemplateVariables(String variablesJson) {
        try {
            if (StringUtils.isEmpty(variablesJson)) {
                return Collections.emptyList();
            }

            ObjectMapper mapper = new ObjectMapper();
            return mapper.readValue(variablesJson,
                new TypeReference<List<TemplateVariable>>() {});

        } catch (Exception e) {
            log.error("è§£ææ¨¡æ¿å˜é‡å¤±è´¥", e);
            return Collections.emptyList();
        }
    }
}
```

---

## ğŸ”§ æ¸ é“é€‚é…å™¨

### é‚®ä»¶å‘é€é€‚é…å™¨

```java
@Component("EMAIL")
@Slf4j
public class EmailNotificationAdapter implements NotificationChannel {

    @Resource
    private JavaMailSender mailSender;

    @Resource
    private FreemarkerTemplateRenderer templateRenderer;

    @Value("${notification.email.from}")
    private String fromEmail;

    @Value("${notification.email.from-name}")
    private String fromName;

    @Override
    public NotificationChannelResult send(NotificationEntity notification) {
        try {
            MimeMessage message = createMimeMessage(notification);
            mailSender.send(message);

            String messageId = generateMessageId();
            log.info("é‚®ä»¶å‘é€æˆåŠŸ: to={}, messageId={}",
                    getReceiverAddresses(notification), messageId);

            return NotificationChannelResult.success("EMAIL", messageId, "é‚®ä»¶å‘é€æˆåŠŸ");

        } catch (Exception e) {
            log.error("é‚®ä»¶å‘é€å¤±è´¥: to=" + getReceiverAddresses(notification), e);
            return NotificationChannelResult.failure("EMAIL", "é‚®ä»¶å‘é€å¤±è´¥: " + e.getMessage());
        }
    }

    private MimeMessage createMimeMessage(NotificationEntity notification) throws MessagingException {
        MimeMessage message = mailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");

        // å‘ä»¶äººä¿¡æ¯
        helper.setFrom(new InternetAddress(fromEmail, fromName));

        // æ”¶ä»¶äººä¿¡æ¯
        String[] toAddresses = parseReceiverAddresses(notification);
        helper.setTo(toAddresses);

        // é‚®ä»¶ä¸»é¢˜å’Œå†…å®¹
        helper.setSubject(notification.getTitle());
        helper.setText(notification.getContent(), true);

        // æ·»åŠ é™„ä»¶
        addAttachments(helper, notification);

        // æ·»åŠ æŒ‰é’®ï¼ˆHTMLæ ¼å¼ï¼‰
        if (notification.getButtons() != null) {
            String htmlContent = addButtonsToContent(notification.getContent(), notification.getButtons());
            helper.setText(htmlContent, true);
        }

        return message;
    }

    private void addAttachments(MimeMessageHelper helper, NotificationEntity notification)
            throws MessagingException {

        if (StringUtils.isEmpty(notification.getAttachments())) {
            return;
        }

        try {
            ObjectMapper mapper = new ObjectMapper();
            List<NotificationAttachment> attachments = mapper.readValue(
                notification.getAttachments(),
                new TypeReference<List<NotificationAttachment>>() {}
            );

            for (NotificationAttachment attachment : attachments) {
                // ä»æ–‡ä»¶URLä¸‹è½½é™„ä»¶æˆ–ä»ä¸Šä¼ ä¸­è·å–
                byte[] attachmentData = downloadAttachment(attachment.getFileUrl());

                helper.addAttachment(
                    attachment.getFileName(),
                    new ByteArrayResource(attachmentData),
                    attachment.getContentType()
                );
            }

        } catch (Exception e) {
            log.error("æ·»åŠ é‚®ä»¶é™„ä»¶å¤±è´¥", e);
        }
    }
}
```

### çŸ­ä¿¡å‘é€é€‚é…å™¨

```java
@Component("SMS")
@Slf4j
public class SmsNotificationAdapter implements NotificationChannel {

    @Resource
    private AliyunSmsService aliyunSmsService;

    @Resource
    private TencentSmsService tencentSmsService;

    @Override
    public NotificationChannelResult send(NotificationEntity notification) {
        try {
            List<String> phoneNumbers = parseReceiverPhones(notification);
            List<SmsResult> results = new ArrayList<>();

            for (String phoneNumber : phoneNumbers) {
                SmsResult result = sendSms(phoneNumber, notification);
                results.add(result);
            }

            boolean allSuccess = results.stream().allMatch(SmsResult::isSuccess);
            String messageId = results.stream()
                    .filter(SmsResult::isSuccess)
                    .map(SmsResult::getMessageId)
                    .collect(Collectors.joining(","));

            if (allSuccess) {
                return NotificationChannelResult.success("SMS", messageId, "çŸ­ä¿¡å‘é€æˆåŠŸ");
            } else {
                long successCount = results.stream().mapToLong(r -> r.isSuccess() ? 1 : 0).sum();
                return NotificationChannelResult.failure("SMS",
                    String.format("éƒ¨åˆ†å‘é€å¤±è´¥: æˆåŠŸ%d/%d", successCount, results.size()));
            }

        } catch (Exception e) {
            log.error("çŸ­ä¿¡å‘é€å¤±è´¥: phones=" + parseReceiverPhones(notification), e);
            return NotificationChannelResult.failure("SMS", "çŸ­ä¿¡å‘é€å¤±è´¥: " + e.getMessage());
        }
    }

    private SmsResult sendSms(String phoneNumber, NotificationEntity notification) {
        // æ ¹æ®é…ç½®é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†
        if (isUseAliyunSms()) {
            return aliyunSmsService.sendSms(phoneNumber, notification);
        } else {
            return tencentSmsService.sendSms(phoneNumber, notification);
        }
    }

    private boolean isUseAliyunSms() {
        // æ ¹æ®é…ç½®æˆ–æƒé‡é€‰æ‹©æœåŠ¡å•†
        return true; // ç®€åŒ–å®ç°
    }
}
```

### å¾®ä¿¡å‘é€é€‚é…å™¨

```java
@Component("WECHAT")
@Slf4j
public class WechatNotificationAdapter implements NotificationChannel {

    @Resource
    private WechatService wechatService;

    @Override
    public NotificationChannelResult send(NotificationEntity notification) {
        try {
            List<String> userIds = parseReceiverUserIds(notification);
            List<WechatResult> results = new ArrayList<>();

            for (String userId : userIds) {
                WechatResult result = sendWechatMessage(userId, notification);
                results.add(result);
            }

            boolean allSuccess = results.stream().allMatch(WechatResult::isSuccess);
            String messageId = results.stream()
                    .filter(WechatResult::isSuccess)
                    .map(WechatResult::getMessageId)
                    .collect(Collectors.joining(","));

            if (allSuccess) {
                return NotificationChannelResult.success("WECHAT", messageId, "å¾®ä¿¡æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                return NotificationChannelResult.failure("WECHAT", "å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥");
            }

        } catch (Exception e) {
            log.error("å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥: userIds=" + parseReceiverUserIds(notification), e);
            return NotificationChannelResult.failure("WECHAT", "å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥: " + e.getMessage());
        }
    }

    private WechatResult sendWechatMessage(String userId, NotificationEntity notification) {
        WechatMessageType messageType = determineMessageType(notification);

        switch (messageType) {
            case TEXT:
                return wechatService.sendTextMessage(userId, notification.getContent());
            case MARKDOWN:
                return wechatService.sendMarkdownMessage(userId, notification.getTitle(), notification.getContent());
            case NEWS:
                return wechatService.sendNewsMessage(userId, createNewsMessage(notification));
            case TEMPLATE_CARD:
                return wechatService.sendTemplateCardMessage(userId, createTemplateCardMessage(notification));
            default:
                return wechatService.sendTextMessage(userId, notification.getContent());
        }
    }
}
```

---

## ğŸ“Š ç›‘æ§ä¸è¿ç»´

### ç›‘æ§æŒ‡æ ‡æ”¶é›†

```java
@Component
@Slf4j
public class NotificationMetricsCollector {

    private final Counter notificationSendCounter;
    private final Counter notificationSuccessCounter;
    private final Counter notificationFailureCounter;
    private final Timer notificationSendTimer;
    private final Gauge activeNotificationsGauge;

    public NotificationMetricsCollector(MeterRegistry meterRegistry) {
        this.notificationSendCounter = Counter.builder("notification.send.total")
                .description("é€šçŸ¥å‘é€æ€»æ•°")
                .register(meterRegistry);

        this.notificationSuccessCounter = Counter.builder("notification.send.success")
                .description("é€šçŸ¥å‘é€æˆåŠŸæ•°")
                .register(meterRegistry);

        this.notificationFailureCounter = Counter.builder("notification.send.failure")
                .description("é€šçŸ¥å‘é€å¤±è´¥æ•°")
                .register(meterRegistry);

        this.notificationSendTimer = Timer.builder("notification.send.duration")
                .description("é€šçŸ¥å‘é€è€—æ—¶")
                .register(meterRegistry);

        this.activeNotificationsGauge = Gauge.builder("notification.active.count")
                .description("æ´»è·ƒé€šçŸ¥æ•°é‡")
                .register(meterRegistry, this, NotificationMetricsCollector::getActiveNotificationCount);
    }

    public void recordSend(String channel, boolean success) {
        notificationSendCounter.increment(Tags.of("channel", channel));

        if (success) {
            notificationSuccessCounter.increment(Tags.of("channel", channel));
        } else {
            notificationFailureCounter.increment(Tags.of("channel", channel));
        }
    }

    public void recordSendTime(String channel, Duration duration) {
        notificationSendTimer.record(duration, Tags.of("channel", channel));
    }

    private double getActiveNotificationCount() {
        // å®ç°è·å–æ´»è·ƒé€šçŸ¥æ•°é‡çš„é€»è¾‘
        return notificationService.getActiveNotificationCount();
    }
}
```

### å¥åº·æ£€æŸ¥

```java
@Component
public class NotificationHealthIndicator implements HealthIndicator {

    @Resource
    private NotificationService notificationService;

    @Override
    public Health health() {
        try {
            // æ£€æŸ¥å„æ¸ é“æœåŠ¡çŠ¶æ€
            Map<String, Boolean> channelStatus = checkChannelHealth();

            boolean allHealthy = channelStatus.values().stream().allMatch(Boolean::booleanValue);

            if (allHealthy) {
                return Health.up()
                        .withDetail("channels", channelStatus)
                        .withDetail("message", "æ‰€æœ‰é€šçŸ¥æ¸ é“æ­£å¸¸")
                        .build();
            } else {
                List<String> unhealthyChannels = channelStatus.entrySet().stream()
                        .filter(entry -> !entry.getValue())
                        .map(Map.Entry::getKey)
                        .collect(Collectors.toList());

                return Health.down()
                        .withDetail("unhealthy_channels", unhealthyChannels)
                        .withDetail("channels", channelStatus)
                        .withDetail("message", "éƒ¨åˆ†é€šçŸ¥æ¸ é“å¼‚å¸¸")
                        .build();
            }

        } catch (Exception e) {
            return Health.down()
                    .withDetail("error", e.getMessage())
                    .withDetail("message", "é€šçŸ¥ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥")
                    .build();
        }
    }

    private Map<String, Boolean> checkChannelHealth() {
        Map<String, Boolean> status = new HashMap<>();

        status.put("EMAIL", checkEmailHealth());
        status.put("SMS", checkSmsHealth());
        status.put("WECHAT", checkWechatHealth());
        status.put("DINGTALK", checkDingTalkHealth());
        status.put("APP", checkAppHealth());

        return status;
    }

    private boolean checkEmailHealth() {
        // å®ç°é‚®ä»¶æœåŠ¡å¥åº·æ£€æŸ¥
        return true; // ç®€åŒ–å®ç°
    }

    private boolean checkSmsHealth() {
        // å®ç°çŸ­ä¿¡æœåŠ¡å¥åº·æ£€æŸ¥
        return true; // ç®€åŒ–å®ç°
    }

    private boolean checkWechatHealth() {
        // å®ç°å¾®ä¿¡æœåŠ¡å¥åº·æ£€æŸ¥
        return true; // ç®€åŒ–å®ç°
    }

    private boolean checkDingTalkHealth() {
        // å®ç°é’‰é’‰æœåŠ¡å¥åº·æ£€æŸ¥
        return true; // ç®€åŒ–å®ç°
    }

    private boolean checkAppHealth() {
        // å®ç°Appæ¨é€æœåŠ¡å¥åº·æ£€æŸ¥
        return true; // ç®€åŒ–å®ç°
    }
}
```

---

## ğŸš€ éƒ¨ç½²é…ç½®

### Dockeré…ç½®

```dockerfile
FROM openjdk:17-jdk-slim

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r notification && useradd -r -g notification notification

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶jaråŒ…
COPY target/ioedream-common-service-1.0.0.jar app.jar

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /app/logs && chown -R notification:notification /app

# è®¾ç½®ç”¨æˆ·
USER notification

# JVMå‚æ•°
ENV JAVA_OPTS="-Xms2g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 \
               -XX:+PrintGCDetails -XX:+PrintGCTimeStamps \
               -Xloggc:/app/logs/gc.log"

# åº”ç”¨å‚æ•°
ENV SPRING_PROFILES_ACTIVE=prod
ENV SERVER_PORT=8088

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8088/actuator/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8088

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar --spring.profiles.active=$SPRING_PROFILES_ACTIVE"]
```

### Kuberneteséƒ¨ç½²é…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service
  namespace: ioedream
  labels:
    app: notification-service
    version: v1.0.0
spec:
  replicas: 2
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
        version: v1.0.0
    spec:
      containers:
      - name: notification-service
        image: ioedream/notification-service:1.0.0
        ports:
        - containerPort: 8088
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: MYSQL_HOST
          value: "mysql"
        - name: REDIS_HOST
          value: "redis"
        - name: JVM_OPTS
          value: "-Xms2g -Xmx4g -XX:+UseG1GC"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8088
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8088
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        volumeMounts:
        - name: logs
          mountPath: /app/logs
      volumes:
      - name: logs
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service
  namespace: ioedream
spec:
  selector:
    app: notification-service
  ports:
  - protocol: TCP
    port: 8088
    targetPort: 8088
    name: http
  type: ClusterIP
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: notification-service-hpa
  namespace: ioedream
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: notification-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **å…¬å…±æ¨¡å—æ€»ä½“è®¾è®¡**: [01-å…¬å…±æ¨¡å—æ€»ä½“è®¾è®¡æ–‡æ¡£.md](./01-å…¬å…±æ¨¡å—æ€»ä½“è®¾è®¡æ–‡æ¡£.md)
2. **AIæ™ºèƒ½åˆ†æè®¾è®¡**: [03-AIæ™ºèƒ½åˆ†æè®¾è®¡æ–‡æ¡£.md](./03-AIæ™ºèƒ½åˆ†æè®¾è®¡æ–‡æ¡£.md)
3. **æƒé™ç®¡ç†è®¾è®¡**: [04-æƒé™ç®¡ç†è®¾è®¡æ–‡æ¡£.md](./04-æƒé™ç®¡ç†è®¾è®¡æ–‡æ¡£.md)
4. **APIæ¥å£è§„èŒƒ**: [../api/notification/notification-api-contract.md](../api/notification/notification-api-contract.md)
5. **éƒ¨ç½²è¿ç»´æŒ‡å—**: [../../deployment/docker/notification-deployment.md](../../deployment/docker/notification-deployment.md)

---

**æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMé€šçŸ¥å›¢é˜Ÿ
**ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-16