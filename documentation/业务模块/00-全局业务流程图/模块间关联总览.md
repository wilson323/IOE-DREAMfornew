# IOE-DREAM æ¨¡å—é—´å…³è”æ€»è§ˆ

> **ç‰ˆæœ¬**: v1.0.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-17

---

## ğŸ“Š ç³»ç»Ÿå…¨å±€å…³è”å›¾

```mermaid
graph TB
    subgraph ç½‘å…³å±‚
        GW[Gateway Service:8080]
    end
    
    subgraph ä¸šåŠ¡å¾®æœåŠ¡
        CMN[Common:8088<br/>å…¬å…±æœåŠ¡]
        DC[DeviceComm:8087<br/>è®¾å¤‡é€šè®¯]
        OA[OA:8089<br/>å·¥ä½œæµ]
        ACC[Access:8090<br/>é—¨ç¦]
        ATT[Attendance:8091<br/>è€ƒå‹¤]
        VID[Video:8092<br/>è§†é¢‘]
        CON[Consume:8094<br/>æ¶ˆè´¹]
        VIS[Visitor:8095<br/>è®¿å®¢]
    end
    
    subgraph åŸºç¡€è®¾æ–½
        MySQL[(MySQL)]
        Redis[(Redis)]
        Nacos[Nacos]
        MQ[RabbitMQ]
    end
    
    GW --> CMN
    GW --> DC
    GW --> OA
    GW --> ACC
    GW --> ATT
    GW --> VID
    GW --> CON
    GW --> VIS
    
    %% æœåŠ¡é—´å…³è”
    ACC <-->|è®¾å¤‡æŒ‡ä»¤/äº‹ä»¶| DC
    ATT <-->|æ‰“å¡æ•°æ®| DC
    CON <-->|æ¶ˆè´¹æ•°æ®| DC
    VID <-->|è§†é¢‘æµ| DC
    
    ACC <-->|è§†é¢‘è”åŠ¨| VID
    ACC <-->|å®¡æ‰¹æµç¨‹| OA
    ACC <-->|è®¿å®¢æƒé™| VIS
    ACC -->|è€ƒå‹¤æ•°æ®| ATT
    
    ATT <-->|å®¡æ‰¹æµç¨‹| OA
    VIS <-->|å®¡æ‰¹æµç¨‹| OA
    
    CMN --> MySQL
    CMN --> Redis
```

---

## ğŸ”— å¾®æœåŠ¡é—´å…³è”çŸ©é˜µ

| æœåŠ¡ | Gateway | Common | DeviceComm | OA | Access | Attendance | Video | Consume | Visitor |
|------|:-------:|:------:|:----------:|:--:|:------:|:----------:|:-----:|:-------:|:-------:|
| **Gateway** | - | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ |
| **Common** | - | - | - | - | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ |
| **DeviceComm** | - | âœ“ | - | - | âœ“ | âœ“ | âœ“ | âœ“ | - |
| **OA** | - | âœ“ | - | - | âœ“ | âœ“ | - | - | âœ“ |
| **Access** | - | âœ“ | âœ“ | âœ“ | - | âœ“ | âœ“ | - | âœ“ |
| **Attendance** | - | âœ“ | âœ“ | âœ“ | âœ“ | - | - | - | - |
| **Video** | - | âœ“ | âœ“ | - | âœ“ | - | - | - | âœ“ |
| **Consume** | - | âœ“ | âœ“ | - | - | - | - | - | - |
| **Visitor** | - | âœ“ | - | âœ“ | âœ“ | - | âœ“ | - | - |

---

## ğŸ“‹ å…³é”®ä¸šåŠ¡åœºæ™¯å…³è”

### åœºæ™¯1: å‘˜å·¥é—¨ç¦é€šè¡Œ

```mermaid
sequenceDiagram
    participant DEV as é—¨ç¦è®¾å¤‡
    participant DC as DeviceComm
    participant ACC as Access
    participant VID as Video
    participant ATT as Attendance
    
    DEV->>DC: é€šè¡Œäº‹ä»¶ä¸ŠæŠ¥
    DC->>ACC: è½¬å‘é€šè¡Œäº‹ä»¶
    ACC->>ACC: æƒé™æ ¡éªŒ
    ACC->>ACC: ä¿å­˜é€šè¡Œè®°å½•
    
    par å¹¶è¡Œå¤„ç†
        ACC->>VID: è§¦å‘è§†é¢‘è”åŠ¨
        ACC->>ATT: åŒæ­¥è€ƒå‹¤æ‰“å¡
    end
    
    ACC-->>DC: è¿”å›é€šè¡Œç»“æœ
    DC-->>DEV: ä¸‹å‘å¼€é—¨æŒ‡ä»¤
```

### åœºæ™¯2: è®¿å®¢é¢„çº¦é€šè¡Œ

```mermaid
sequenceDiagram
    participant VIS as Visitor
    participant OA as OA
    participant ACC as Access
    participant DC as DeviceComm
    
    VIS->>OA: æäº¤è®¿å®¢é¢„çº¦
    OA->>OA: å®¡æ‰¹æµç¨‹
    OA-->>VIS: å®¡æ‰¹é€šè¿‡
    VIS->>ACC: æˆäºˆä¸´æ—¶é—¨ç¦æƒé™
    ACC->>DC: åŒæ­¥æƒé™åˆ°è®¾å¤‡
    
    Note over VIS,DC: è®¿å®¢åˆ°è¾¾å
    DC->>ACC: è®¿å®¢é€šè¡Œäº‹ä»¶
    ACC->>VIS: æ›´æ–°è®¿å®¢çŠ¶æ€
```

### åœºæ™¯3: é—¨ç¦å‘Šè­¦è”åŠ¨

```mermaid
sequenceDiagram
    participant DEV as é—¨ç¦è®¾å¤‡
    participant DC as DeviceComm
    participant ACC as Access
    participant VID as Video
    participant CMN as Common
    
    DEV->>DC: å¼‚å¸¸äº‹ä»¶ä¸ŠæŠ¥
    DC->>ACC: è½¬å‘å¼‚å¸¸äº‹ä»¶
    ACC->>ACC: ç”Ÿæˆå‘Šè­¦
    
    par è”åŠ¨å¤„ç†
        ACC->>VID: è¯·æ±‚å…³è”è§†é¢‘
        VID-->>ACC: è¿”å›è§†é¢‘æµ
        ACC->>CMN: å‘é€å‘Šè­¦é€šçŸ¥
    end
```

---

## ğŸ”§ æ•°æ®å…±äº«è®¾è®¡

### å…±äº«æ•°æ®è¡¨ï¼ˆmicroservices-commonï¼‰

| æ•°æ®åŸŸ | è¡¨å | ä½¿ç”¨æœåŠ¡ |
|--------|------|----------|
| ç”¨æˆ· | t_common_user | å…¨éƒ¨ |
| éƒ¨é—¨ | t_common_department | å…¨éƒ¨ |
| åŒºåŸŸ | t_common_area | Access, Visitor, Video |
| è®¾å¤‡ | t_common_device | Access, Attendance, Consume |
| æƒé™ | t_common_permission | å…¨éƒ¨ |

### æœåŠ¡ä¸“æœ‰æ•°æ®è¡¨

| æœåŠ¡ | è¡¨å‰ç¼€ | ç¤ºä¾‹ |
|------|--------|------|
| Access | t_access_ | t_access_record, t_access_device |
| Attendance | t_attendance_ | t_attendance_record |
| Video | t_video_ | t_video_device |
| Consume | t_consume_ | t_consume_record |
| Visitor | t_visitor_ | t_visitor_appointment |

---

## âš¡ æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡

### Exchangeå®šä¹‰

| Exchange | Type | è¯´æ˜ |
|----------|------|------|
| ioedream.access | topic | é—¨ç¦äº‹ä»¶ |
| ioedream.attendance | topic | è€ƒå‹¤äº‹ä»¶ |
| ioedream.alert | fanout | å‘Šè­¦å¹¿æ’­ |
| ioedream.notification | topic | é€šçŸ¥æ¶ˆæ¯ |

### Queueç»‘å®š

| Queue | Exchange | Routing Key | Consumer |
|-------|----------|-------------|----------|
| access.event.attendance | ioedream.access | access.event.* | Attendance |
| access.alert.video | ioedream.alert | # | Video |
| notification.push | ioedream.notification | notification.* | Common |

---

## ğŸ” æœåŠ¡è°ƒç”¨å®‰å…¨

### å†…éƒ¨æœåŠ¡è®¤è¯

```yaml
# æœåŠ¡é—´è°ƒç”¨æºå¸¦å†…éƒ¨Token
headers:
  X-Service-Name: ioedream-access-service
  X-Service-Token: ${internal.service.token}
  X-Trace-Id: ${trace.id}
```

### è°ƒç”¨é“¾è·¯è¿½è¸ª

- ä½¿ç”¨Micrometer + Zipkinè¿›è¡Œé“¾è·¯è¿½è¸ª
- æ‰€æœ‰è·¨æœåŠ¡è°ƒç”¨æºå¸¦TraceId
- æ—¥å¿—è®°å½•åŒ…å«å®Œæ•´è°ƒç”¨é“¾ä¿¡æ¯

---

**ğŸ“ æ–‡æ¡£ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ | 2025-12-17
