# 身份验证子模块 - 详细设计说明书

> **版本**: v1.0.0  
> **更新日期**: 2025-01-30

## 1. 模块概述

身份验证子模块负责访客身份的多维度验证，包括证件识别、人脸比对、黑名单校验等。

## 2. 类结构设计

### 2.1 实体类 (IdentityVerificationEntity)

| 字段 | 类型 | 说明 |
|------|------|------|
| verificationNo | String | 验证编号 |
| visitorId | Long | 访客ID |
| verificationType | String | 验证类型 |
| idCardNo | String | 身份证号(加密) |
| idCardName | String | 身份证姓名 |
| faceImage | String | 人脸图片路径 |
| faceScore | BigDecimal | 人脸相似度 |
| verificationResult | String | 验证结果 |
| verificationTime | LocalDateTime | 验证时间 |
| deviceId | Long | 验证设备ID |

### 2.2 Manager层核心方法

- verifyIdCard: 身份证OCR识别和验证
- verifyFace: 人脸比对验证
- checkBlacklist: 黑名单校验
- multiFactorVerify: 多因素综合验证

## 3. 数据库详细设计

### 3.1 身份验证记录表 (vis_identity_verification)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| verification_no | VARCHAR(32) | 验证编号 |
| visitor_id | BIGINT | 访客ID |
| verification_type | VARCHAR(20) | 验证类型 |
| id_card_no | VARCHAR(100) | 身份证号(加密) |
| id_card_name | VARCHAR(50) | 身份证姓名 |
| face_image | VARCHAR(500) | 人脸图片路径 |
| face_score | DECIMAL(5,2) | 人脸相似度 |
| verification_result | VARCHAR(20) | 验证结果 |
| verification_time | DATETIME | 验证时间 |
| device_id | BIGINT | 验证设备ID |
| fail_reason | VARCHAR(200) | 失败原因 |

### 3.2 黑名单表 (vis_blacklist)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| id_card_no | VARCHAR(100) | 身份证号(加密) |
| name | VARCHAR(50) | 姓名 |
| reason | VARCHAR(500) | 拉黑原因 |
| level | VARCHAR(20) | 黑名单级别 |
| start_time | DATETIME | 生效时间 |
| end_time | DATETIME | 失效时间 |
| operator_id | BIGINT | 操作人ID |

## 4. 接口详细设计

### 4.1 身份证验证
- **URL**: POST /api/v1/visitor/identity/verifyIdCard
- **请求参数**: idCardImage (身份证照片)
- **响应**: idCardNo, name, gender, address, verifyResult

### 4.2 人脸验证
- **URL**: POST /api/v1/visitor/identity/verifyFace
- **请求参数**: visitorId, faceImage
- **响应**: verified, score, message

### 4.3 黑名单校验
- **URL**: POST /api/v1/visitor/identity/checkBlacklist
- **请求参数**: idCardNo
- **响应**: inBlacklist, level, reason

### 4.4 综合验证
- **URL**: POST /api/v1/visitor/identity/multiVerify
- **请求参数**: idCardImage, faceImage
- **响应**: verificationResult

## 5. 业务规则

| 规则 | 说明 |
|------|------|
| 人脸相似度阈值 | ≥80%为通过 |
| 身份证有效期 | 必须在有效期内 |
| 黑名单优先级 | 黑名单直接拒绝 |
| 验证记录保留 | 保留180天 |

## 6. 错误码定义

| 错误码 | 说明 |
|--------|------|
| VIS_IDT_001 | 身份证识别失败 |
| VIS_IDT_002 | 身份证已过期 |
| VIS_IDT_003 | 人脸比对失败 |
| VIS_IDT_004 | 在黑名单中 |
| VIS_IDT_005 | 验证超时 |

