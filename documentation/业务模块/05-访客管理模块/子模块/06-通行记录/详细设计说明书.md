# 通行记录子模块 - 详细设计说明书

> **版本**: v1.0.0  
> **更新日期**: 2025-01-30

## 1. 模块概述

通行记录子模块负责记录访客在园区内的通行轨迹，与门禁系统联动。

## 2. 类结构设计

### 2.1 实体类 (AccessRecordEntity)

| 字段 | 类型 | 说明 |
|------|------|------|
| recordNo | String | 记录编号 |
| registrationId | Long | 登记ID |
| visitorId | Long | 访客ID |
| deviceId | Long | 设备ID |
| areaId | Long | 区域ID |
| accessType | String | 通行类型(进/出) |
| accessTime | LocalDateTime | 通行时间 |
| accessMethod | String | 通行方式 |
| captureImage | String | 抓拍图片 |
| accessResult | String | 通行结果 |

### 2.2 Manager层核心方法

- recordAccess: 记录通行事件
- getVisitorTrack: 获取访客轨迹
- checkAccessPermission: 检查通行权限
- getAreaAccessStats: 区域通行统计

## 3. 数据库详细设计

### 3.1 通行记录表 (vis_access_record)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| record_no | VARCHAR(32) | 记录编号 |
| registration_id | BIGINT | 登记ID |
| visitor_id | BIGINT | 访客ID |
| device_id | BIGINT | 设备ID |
| area_id | BIGINT | 区域ID |
| access_type | VARCHAR(10) | 通行类型 |
| access_time | DATETIME | 通行时间 |
| access_method | VARCHAR(20) | 通行方式 |
| capture_image | VARCHAR(500) | 抓拍图片 |
| access_result | VARCHAR(20) | 通行结果 |

### 3.2 索引设计

- idx_visitor_id: 访客ID索引
- idx_access_time: 通行时间索引
- idx_area_id: 区域ID索引

## 4. 接口详细设计

### 4.1 记录通行
- **URL**: POST /api/v1/visitor/access/record
- **请求参数**: registrationId, deviceId, accessType
- **响应**: recordNo, accessResult

### 4.2 获取访客轨迹
- **URL**: GET /api/v1/visitor/access/track
- **请求参数**: registrationId
- **响应**: 轨迹列表

### 4.3 区域通行统计
- **URL**: GET /api/v1/visitor/access/stats
- **请求参数**: areaId, startTime, endTime
- **响应**: 统计数据

## 5. 业务规则

| 规则 | 说明 |
|------|------|
| 权限验证 | 必须在授权区域内 |
| 时间限制 | 必须在有效时间内 |
| 抓拍留存 | 每次通行抓拍留存 |
| 异常告警 | 越权通行实时告警 |

## 6. 错误码定义

| 错误码 | 说明 |
|--------|------|
| VIS_ACC_001 | 无通行权限 |
| VIS_ACC_002 | 超出有效时间 |
| VIS_ACC_003 | 区域未授权 |
| VIS_ACC_004 | 访客已签出 |

