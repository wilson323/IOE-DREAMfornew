# 预约管理子模块 - 详细设计说明书

> **版本**: v1.0.0  
> **更新日期**: 2025-01-30  
> **所属模块**: 访客管理微服务 (ioedream-visitor-service)

## 1. 模块概述

预约管理子模块是访客管理系统的核心入口，负责访客来访前的预约申请、审批流程、预约变更等全流程管理。

## 2. 类结构设计

### 2.1 实体类 (ReservationEntity)

| 字段 | 类型 | 说明 |
|------|------|------|
| reservationNo | String | 预约编号 |
| visitorId | Long | 访客ID |
| intervieweeId | Long | 被访人ID |
| visitPurpose | String | 来访事由 |
| visitDate | LocalDate | 来访日期 |
| startTime | LocalTime | 开始时间 |
| endTime | LocalTime | 结束时间 |
| visitAreaId | Long | 访问区域ID |
| companionCount | Integer | 随行人数 |
| vehicleNo | String | 车牌号 |
| status | String | 预约状态 |
| approvalStatus | String | 审批状态 |
| qrCode | String | 预约二维码 |

### 2.2 Manager层核心方法

- createReservation: 创建预约，包含黑名单检查、时间冲突检查
- approveReservation: 审批预约，生成二维码
- cancelReservation: 取消预约
- extendReservation: 延期预约

## 3. 数据库详细设计

### 3.1 预约信息表 (vis_reservation)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| reservation_no | VARCHAR(32) | 预约编号 |
| visitor_id | BIGINT | 访客ID |
| interviewee_id | BIGINT | 被访人ID |
| visit_purpose | VARCHAR(200) | 来访事由 |
| visit_date | DATE | 来访日期 |
| start_time | TIME | 开始时间 |
| end_time | TIME | 结束时间 |
| visit_area_id | BIGINT | 访问区域ID |
| companion_count | INT | 随行人数 |
| vehicle_no | VARCHAR(20) | 车牌号 |
| status | VARCHAR(20) | 预约状态 |
| approval_status | VARCHAR(20) | 审批状态 |
| qr_code | VARCHAR(1000) | 预约二维码 |

### 3.2 索引设计

- uk_reservation_no: 预约编号唯一索引
- idx_visitor_id: 访客ID索引
- idx_visit_date: 来访日期索引
- idx_interviewee_id: 被访人ID索引

## 4. 接口详细设计

### 4.1 创建预约
- **URL**: POST /api/v1/visitor/reservation/create
- **请求参数**: visitorId, intervieweeId, visitPurpose, visitDate, startTime, endTime
- **响应**: reservationId, reservationNo, status

### 4.2 审批预约
- **URL**: POST /api/v1/visitor/reservation/approve
- **请求参数**: reservationId, approved, remark
- **响应**: status, qrCode

### 4.3 取消预约
- **URL**: POST /api/v1/visitor/reservation/cancel
- **请求参数**: reservationId, reason
- **响应**: success

### 4.4 延期预约
- **URL**: POST /api/v1/visitor/reservation/extend
- **请求参数**: reservationId, newVisitDate, newStartTime, newEndTime
- **响应**: success

## 5. 业务规则

| 规则 | 说明 |
|------|------|
| 提前预约时间 | 最少提前2小时 |
| 最大预约天数 | 最多提前30天 |
| 单日预约上限 | 同一访客每日最多3次 |
| 随行人数限制 | 最多5人 |

## 6. 错误码定义

| 错误码 | 说明 |
|--------|------|
| VIS_RSV_001 | 预约不存在 |
| VIS_RSV_002 | 访客已在黑名单 |
| VIS_RSV_003 | 预约时间冲突 |
| VIS_RSV_004 | 超出预约时间范围 |
| VIS_RSV_005 | 被访人不存在 |
| VIS_RSV_006 | 无权审批 |

