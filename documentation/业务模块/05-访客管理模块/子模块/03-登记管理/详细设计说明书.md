# 登记管理子模块 - 详细设计说明书

> **版本**: v1.0.0  
> **更新日期**: 2025-01-30

## 1. 模块概述

登记管理子模块负责访客到达后的签到、签出、凭证管理和在场监控等功能。

## 2. 类结构设计

### 2.1 实体类 (RegistrationEntity)

| 字段 | 类型 | 说明 |
|------|------|------|
| registrationNo | String | 登记编号 |
| reservationId | Long | 预约ID |
| visitorId | Long | 访客ID |
| intervieweeId | Long | 被访人ID |
| registrationType | String | 登记类型 |
| checkInTime | LocalDateTime | 签到时间 |
| checkOutTime | LocalDateTime | 签出时间 |
| expectedLeaveTime | LocalDateTime | 预计离开时间 |
| visitorCardNo | String | 访客卡号 |
| qrCode | String | 访客二维码 |
| accessAreas | JSON | 可访问区域 |
| status | String | 状态 |

### 2.2 Manager层核心方法

- checkIn: 访客签到，核验预约信息，发放凭证
- checkOut: 访客签出，回收访客卡
- forceCheckOut: 强制签出超时访客
- getOnsiteVisitors: 获取在场访客列表

## 3. 数据库详细设计

### 3.1 登记信息表 (vis_registration)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| registration_no | VARCHAR(32) | 登记编号 |
| reservation_id | BIGINT | 预约ID |
| visitor_id | BIGINT | 访客ID |
| interviewee_id | BIGINT | 被访人ID |
| registration_type | VARCHAR(20) | 登记类型 |
| check_in_time | DATETIME | 签到时间 |
| check_out_time | DATETIME | 签出时间 |
| expected_leave_time | DATETIME | 预计离开时间 |
| visitor_card_no | VARCHAR(50) | 访客卡号 |
| qr_code | VARCHAR(500) | 访客二维码 |
| access_areas | JSON | 可访问区域 |
| status | VARCHAR(20) | 状态 |
| check_in_device_id | BIGINT | 签到设备ID |
| check_out_device_id | BIGINT | 签出设备ID |

### 3.2 索引设计

- uk_registration_no: 登记编号唯一索引
- idx_visitor_id: 访客ID索引
- idx_check_in_time: 签到时间索引
- idx_status: 状态索引

## 4. 接口详细设计

### 4.1 访客签到
- **URL**: POST /api/v1/visitor/registration/checkIn
- **请求参数**: reservationId, visitorId, faceImage, deviceId
- **响应**: registrationId, visitorCardNo, qrCode

### 4.2 访客签出
- **URL**: POST /api/v1/visitor/registration/checkOut
- **请求参数**: registrationId, deviceId
- **响应**: success

### 4.3 获取在场访客
- **URL**: GET /api/v1/visitor/registration/onsite
- **请求参数**: areaId, pageNum, pageSize
- **响应**: 在场访客列表

### 4.4 临时访客登记
- **URL**: POST /api/v1/visitor/registration/walkIn
- **请求参数**: visitorInfo, intervieweeId, visitPurpose
- **响应**: registrationId

## 5. 业务规则

| 规则 | 说明 |
|------|------|
| 签到有效期 | 预约时间前后30分钟内可签到 |
| 超时预警 | 超过预计离开时间30分钟预警 |
| 强制签出 | 超过预计离开时间2小时强制签出 |
| 访客卡回收 | 签出时必须回收访客卡 |

## 6. 错误码定义

| 错误码 | 说明 |
|--------|------|
| VIS_REG_001 | 登记不存在 |
| VIS_REG_002 | 预约未审批通过 |
| VIS_REG_003 | 预约已过期 |
| VIS_REG_004 | 人脸识别失败 |
| VIS_REG_005 | 已签到 |
| VIS_REG_006 | 已签出 |

