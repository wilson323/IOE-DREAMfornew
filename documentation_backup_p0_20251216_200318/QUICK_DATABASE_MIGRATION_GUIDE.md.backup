# ğŸš€ IOE-DREAM æ•°æ®åº“è¿ç§»å¿«é€ŸæŒ‡å—

> **ç‰ˆæœ¬**: v1.0.0
> **æŠ€æœ¯æ ˆ**: Spring Boot 3.5.8 + Spring Cloud Alibaba 2025.0.0 + Flyway 9.x
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-15
> **é€‚ç”¨å¯¹è±¡**: IOE-DREAMé¡¹ç›®å¼€å‘è€…å’Œè¿ç»´äººå‘˜
> **ç›®æ ‡**: å¿«é€ŸæŒæ¡æ•°æ®åº“è¿ç§»æ“ä½œå’Œæœ€ä½³å®è·µ

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### ğŸ¯ è¿ç§»æ¦‚è¿°
IOE-DREAMé¡¹ç›®é‡‡ç”¨**ç»Ÿä¸€æ•°æ®åº“æ¶æ„**ï¼Œæ‰€æœ‰å¾®æœåŠ¡å…±äº«`ioedream`æ•°æ®åº“ï¼Œä½¿ç”¨Flywayè¿›è¡Œä¼ä¸šçº§ç‰ˆæœ¬ç®¡ç†ã€‚

### ğŸ—ï¸ æŠ€æœ¯æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨å±‚ (9ä¸ªå¾®æœåŠ¡)                â”‚
â”‚  ioedream-common-service (8088)                     â”‚
â”‚  ioedream-access-service (8090)                      â”‚
â”‚  ioedream-attendance-service (8091)                    â”‚
â”‚  ioedream-consume-service (8094)                        â”‚
â”‚  ...                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è¿ç§»æ§åˆ¶å±‚ (Flyway 9.x)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   V1.x.x         â”‚  â”‚   V2.x.x         â”‚  â”‚   V3.x.x         â”‚ â”‚
â”‚  â”‚  åŸºç¡€æ¶æ„è¿ç§»    â”‚  â”‚  åŠŸèƒ½å¢å¼ºè¿ç§»    â”‚  â”‚  ä¸šåŠ¡ä¼˜åŒ–è¿ç§»    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ï¿½  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ•°æ®åº“å±‚ (MySQL 8.0)                   â”‚
â”‚  ç»Ÿä¸€æ•°æ®åº“: ioedream                              â”‚
â”‚  å®ä½“æ€»æ•°: 76ä¸ª (å…¬å…±æ¨¡å—38ä¸ª + ä¸šåŠ¡æ¨¡å—38ä¸ª)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ 5åˆ†é’Ÿå¿«é€Ÿè¿ç§»

### æ­¥éª¤ 1: ç¯å¢ƒå‡†å¤‡
```bash
# 1. ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸
mysql -h 127.0.0.1 -P 3306 -u root -p123456 -e "SELECT 1 as test;" ioedream

# 2. æ£€æŸ¥Flywayä¾èµ–
mvn dependency:tree | grep flyway
```

### æ­¥éª¤ 2: é…ç½®Flyway
```yaml
# åœ¨ application.yml ä¸­æ·»åŠ  Flyway é…ç½®
spring:
  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    table: flyway_schema_history
    validate-on-migrate: true
    clean-disabled: true
```

### æ­¥éª¤ 3: æ‰§è¡Œè¿ç§»
```bash
# æ–¹å¼ä¸€: ä½¿ç”¨Spring Bootå¯åŠ¨
mvn spring-boot:run -Dspring-boot.run.arguments="--spring.flyway.enabled=true"

# æ–¹å¼äºŒ: ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆæ¨èï¼‰
cd D:\IOE-DREAM
.\scripts\database\migration-automation.ps1
```

### æ­¥éª¤ 4: éªŒè¯ç»“æœ
```sql
-- æ£€æŸ¥è¿ç§»å†å²
SELECT version, description, installed_on
FROM flyway_schema_history
ORDER BY installed_on DESC
LIMIT 5;
```

---

## ğŸ”§ å¾®æœåŠ¡è¿ç§»é…ç½®

### ğŸ¯ å·²é…ç½®æœåŠ¡çŠ¶æ€
| æœåŠ¡åç§° | ç«¯å£ | FlywayçŠ¶æ€ | é…ç½®æ–‡ä»¶ä½ç½® |
|---------|------|------------|----------------|
| âœ… ioedream-device-comm-service | 8087 | **å·²é…ç½®** | `src/main/resources/application.yml` |
| âœ… ioedream-common-service | 8088 | **å·²é…ç½®** | `src/main/resources/application.yml` |
| âŒ ioedream-oa-service | 8089 | **å¾…é…ç½®** | éœ€è¦æ·»åŠ é…ç½® |
| âŒ ioedream-access-service | 8090 | **å¾…é…ç½®** | éœ€è¦æ·»åŠ é…ç½® |
| âŒ ioedream-attendance-service | 8091 | **å¾…é…ç½®** | éœ€è¦æ·»åŠ é…ç½® |
| âŒ ioedream-video-service | 8092 | **å¾…é…ç½®** | éœ€è¦æ·»åŠ é…ç½® |
| âŒ ioedream-consume-service | 8094 | **å¾…é…ç½®** | éœ€è¦æ·»åŠ é…ç½® |
| âŒ ioedream-visitor-service | 8095 | **å¾…é…ç½®** | éœ€è¦æ·»åŠ é…ç½® |

### ğŸ“ å¿«é€Ÿé…ç½®æ¨¡æ¿

#### 1. å¤åˆ¶æ ‡å‡†é…ç½®
```bash
# å¤åˆ¶æ ‡å‡†é…ç½®æ¨¡æ¿åˆ°æœåŠ¡ç›®å½•
copy microservices\config-templates\flyway-standard-template.yml microservices\ioedream-xxx-service\src\main\resources\
```

#### 2. åœ¨ application.yml ä¸­å¯¼å…¥
```yaml
spring:
  config:
    import:
      - "optional:classpath:flyway-standard-template.yml"
```

#### 3. ç¯å¢ƒç‰¹å®šé…ç½®
```yaml
# devç¯å¢ƒé…ç½®
spring:
  profiles:
    active: dev
  flyway:
      baseline-on-migrate: true
      clean-disabled: false
```

---

## ğŸ› ï¸ è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨

### ğŸš€ PowerShell è¿ç§»å·¥å…·

#### åŸºæœ¬ç”¨æ³•
```powershell
# æŸ¥çœ‹å¸®åŠ©
.\scripts\database\migration-automation.ps1 --help

# è¿ç§»æ‰€æœ‰æœåŠ¡
.\scripts\database\migration-automation.ps1

# è¿ç§»æŒ‡å®šæœåŠ¡
.\scripts\database\migration-automation.ps1 -Service ioedream-access-service

# éªŒè¯è¿ç§»ç»“æœ
.\scripts\database\migration-automation.ps1 -Action validate

# ç”Ÿæˆè¿ç§»æŠ¥å‘Š
.\scripts\database\migration-automation.ps1 -Action report

# ç”Ÿäº§ç¯å¢ƒæ¼”ç»ƒ
.\scripts\database\migration-automation.ps1 -Environment prod -DryRun
```

#### é«˜çº§ç”¨æ³•
```powershell
# ä»…æ£€æŸ¥é…ç½®
.\scripts\database\migration-automation.ps1 -Action config-check

# æ‰§è¡Œæ•°æ®åº“å¤‡ä»½
.\scripts\database-automation.ps1 -Action backup

# å›æ»šæ“ä½œï¼ˆå¼€å‘ä¸­ï¼‰
.\scripts\database\migration-automation.ps1 -Action rollback
```

### ğŸ“Š è‡ªåŠ¨åŒ–æŠ¥å‘Šç”Ÿæˆ
å·¥å…·ä¼šè‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„HTMLæŠ¥å‘Šï¼ŒåŒ…å«ï¼š
- âœ… è¿ç§»æ‰§è¡Œç»Ÿè®¡
- âœ… æ€§èƒ½å½±å“åˆ†æ
- âœ… é”™è¯¯è¯Šæ–­ä¿¡æ¯
- âœ… æ”¹è¿›å»ºè®®

---

## ğŸ” å¸¸è§é—®é¢˜è§£å†³

### âŒ é—®é¢˜1: Flywayè¿æ¥å¤±è´¥
**é”™è¯¯ä¿¡æ¯**: `Found non-empty schema(s) 'ioedream' but no schema history table`

**è§£å†³æ–¹æ¡ˆ**:
```yaml
spring:
  flyway:
    baseline-on-migrate: true  # è‡ªåŠ¨baseline
    baseline-version: 0
```

### âŒ é—®é¢˜2: è¿ç§»è„šæœ¬è¯­æ³•é”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `Syntax error in migration script`

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- æ£€æŸ¥SQLè¯­æ³•
-- ä½¿ç”¨SET FOREIGN_KEY_CHECKS = 0;
-- æ£€æŸ¥è¡¨åå’Œå­—æ®µå
-- éªŒè¯SQLè¯­å¥å®Œæ•´æ€§
```

### âŒ é—®é¢˜3: é…ç½®ä¸ç”Ÿæ•ˆ
**é”™è¯¯ä¿¡æ¯**: `Configuration properties not loaded`

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# ç¡®ä¿é…ç½®ä½ç½®æ­£ç¡®
spring:
  config:
    import:
      - "classpath:application.yml"
```

### âŒ é—®é¢˜4: æ•°æ®åº“æƒé™ä¸è¶³
**é”™è¯¯ä¿¡æ¯**: `Access denied for user`

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- æˆäºˆå¿…è¦æƒé™
GRANT ALL PRIVILEGES ON ioedream.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. è¿ç§»è„šæœ¬è§„èŒƒ
```sql
-- âœ… å¥½çš„ç¤ºä¾‹
-- =====================================================
-- IOE-DREAM Flyway è¿ç§»è„šæœ¬
-- ç‰ˆæœ¬: V2_1_9__ENHANCE_TABLE_STRUCTURE
-- æè¿°: å¢å¼ºè¡¨ç»“æ„ï¼Œæ·»åŠ ç´¢å¼•ä¼˜åŒ–
-- =====================================================

SET FOREIGN_KEY_CHECKS = 0;
START TRANSACTION;

-- å˜æ›´è¯­å¥
CREATE TABLE IF NOT EXISTS t_new_table (...);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_name ON t_table (column_name);

-- éªŒè¯è¯­å¥
SELECT COUNT(*) FROM t_new_table;

COMMIT;

-- âŒ é”™è¯¯ç¤ºä¾‹
-- æ²¡æœ‰äº‹åŠ¡æ§åˆ¶
-- æ²¡æœ‰é”™è¯¯å¤„ç†
-- æ²¡æœ‰éªŒè¯è¯­å¥
```

### 2. ç‰ˆæœ¬å·ç®¡ç†
```
ç‰ˆæœ¬å·æ ¼å¼: V{major}_{minor}_{patch}__{Description}
ç¤ºä¾‹: V2_1_9__ENHANCE_TABLE_STRUCTURE.sql
è§„åˆ™: è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œæ¸…æ™°æè¿°å˜æ›´å†…å®¹
```

### 3. ç¯å¢ƒéš”ç¦»
```yaml
# å¼€å‘ç¯å¢ƒ
dev:
  flyway:
    clean-disabled: false
    validate-on-migrate: false

# ç”Ÿäº§ç¯å¢ƒ
prod:
  flyway:
    clean-disabled: true
    validate-on-migrate: true
```

### 4. å¤‡ä»½ç­–ç•¥
```powershell
# æ¯æ¬¡è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½
- å¤‡ä»½ä½ç½®: scripts\database\backup\
- ä¿ç•™æ—¶é—´: 30å¤©
- å¤‡ä»½éªŒè¯: å®Œæ•´æ€§æ£€æŸ¥
```

---

## ğŸ“š è¿›é˜¶å­¦ä¹ 

### ğŸ“– æ ¸å¿ƒæ–‡æ¡£
1. **å®Œæ•´è¿ç§»ç­–ç•¥**: [DATABASE_MIGRATION_COMPREHENSIVE_STRATEGY.md](./DATABASE_MIGRATION_COMPREHENSIVE_STRATEGY.md)
2. **Flywayå®˜æ–¹æ–‡æ¡£**: https://flywaydb.org/documentation/
3. **Spring Booté›†æˆ**: https://spring.io/guides/gs/using-flyway-with-spring-boot/

### ğŸ› ï¸ ç›¸å…³æŠ€èƒ½
- **database-migration-specialist**: æ•°æ®åº“è¿ç§»ä¸“å®¶æŠ€èƒ½
- **four-tier-architecture-guardian**: å››å±‚æ¶æ„å®ˆæŠ¤
- **spring-boot-jakarta-guardian**: Jakarta EEè¿ç§»æ”¯æŒ

### ğŸ”— å¤–éƒ¨èµ„æº
- **Spring Cloud Alibabaæ–‡æ¡£**: https://spring-cloud-alibaba.github.io/
- **MyBatis-Plusæ–‡æ¡£**: https://baomidou.com/
- **Druidç›‘æ§æ–‡æ¡£**: https://github.com/alibaba/druid

---

## ğŸ†˜ æ•…éšœæ’é™¤

### ğŸ” è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—
```yaml
logging:
  level:
    org.flywaydb: DEBUG
    net.lab1024.sa: DEBUG
```

#### 2. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
SHOW TABLES;
DESCRIBE t_table_name;

-- æŸ¥çœ‹è¿ç§»å†å²
SELECT * FROM flyway_schema_history;
```

#### 3. éªŒè¯é…ç½®åŠ è½½
```bash
# æ£€æŸ¥Spring Booté…ç½®
mvn spring-boot:run -Ddebug --logging.level.org.springframework.boot=DEBUG
```

### ğŸ“ å¯»æ±‚å¸®åŠ©

1. **æŸ¥é˜…æ–‡æ¡£**: å…ˆæŸ¥çœ‹æœ¬æ–‡æ¡£å’Œç›¸å…³æŠ€æœ¯æ–‡æ¡£
2. **æ£€æŸ¥æ—¥å¿—**: ä»”ç»†åˆ†æé”™è¯¯æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
3. **ç¤¾åŒºæ”¯æŒ**: åœ¨é¡¹ç›®issueä¸­æå‡ºé—®é¢˜
4. **å›¢é˜Ÿåä½œ**: è”ç³»æ¶æ„å¸ˆå›¢é˜Ÿæˆ–ç›¸å…³æ¨¡å—è´Ÿè´£äºº

---

## ğŸ‰ æˆåŠŸæ ‡å‡†

### âœ… è¿ç§»å®Œæˆæ ‡å¿—
- [ ] æ‰€æœ‰æœåŠ¡Flywayé…ç½®å®Œæ•´
- [ ] è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] æ•°æ®åº“è¡¨ç»“æ„æ›´æ–°æ­£ç¡®
- [ ] è¿ç§»å†å²è®°å½•å®Œæ•´
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å›æ»šæœºåˆ¶éªŒè¯æˆåŠŸ

### ğŸ“Š è´¨é‡æŒ‡æ ‡
- **æˆåŠŸç‡**: 100%
- **æ‰§è¡Œæ—¶é—´**: å•æœåŠ¡ < 5åˆ†é’Ÿ
- **å¤‡ä»½æ—¶é—´**: < 2åˆ†é’Ÿ
- **å›æ»šæ—¶é—´**: < 30ç§’
- **é”™è¯¯ç‡**: < 0.1%

---

**å¿«é€ŸæŒ‡å—ç»´æŠ¤**: IOE-DREAMæ¶æ„å›¢é˜Ÿ
**æŠ€æœ¯æ”¯æŒ**: è€ç‹ï¼ˆæ•°æ®åº“æ¶æ„ä¸“å®¶ï¼‰
**æœ€åæ›´æ–°**: 2025-12-15
**ç‰ˆæœ¬**: v1.0.0 - å¿«é€ŸæŒ‡å—ç‰ˆ