# 11-离线消费模块重构设计

## 📋 模块概述

**重构目标**：构建完整的离线消费体系，保障网络故障时业务连续性。

**核心问题**：
- 设备离线后无法消费
- 离线数据同步机制缺失
- 离线余额冲突无法处理
- 离线名单管理混乱
- **离线数据未包含新增配置字段**

**重构收益**：
- ✅ 设备离线也能正常消费
- ✅ 自动同步离线数据
- ✅ 智能处理余额冲突
- ✅ 完整的离线审计日志
- ✅ **离线数据结构完整，支持所有经营模式**

---

## 🏗️ 离线消费与经营模式

### 离线数据结构更新

**离线名单必须包含区域核心配置字段**：

| 字段 | 是否下发 | 下发原因 | 影响 |
|------|---------|---------|------|
| **manage_mode** | ✅ 必需 | 离线设备需判断消费模式 | 决定定值/商品/混合消费流程 |
| **area_sub_type** | ⚠️ 可选 | 用于离线统计分类 | 仅影响数据分析，可选 |
| **fixed_value_config** | ✅ 必需（餐别制） | 离线计算定值金额 | 餐别制区域必需，超市制不需要 |
| **meal_categories** | ✅ 必需（餐别制） | 离线验证餐别权限 | 餐别制区域必需，超市制不需要 |

### 不同经营模式的离线支持

| 经营模式 | 离线支持程度 | 必需数据 | 特殊处理 |
|---------|------------|---------|---------|
| **餐别制** | ✅ 完全支持 | 区域配置+餐别配置+定值配置 | 需下发完整餐别时间窗口 |
| **超市制** | ⚠️ 部分支持 | 区域配置+商品基础信息 | 商品价格可离线，库存需在线 |
| **混合模式** | ⚠️ 部分支持 | 两种模式数据均需下发 | 数据量较大，需压缩传输 |

**业务规则**：
1. **餐别制离线**：定值金额直接从离线配置读取，无需联网
2. **超市制离线**：商品价格可用，但库存扣减需上线后同步
3. **混合模式离线**：用户只能选择其中一种方式消费

---

## 🔄 业务流程设计
## 📋 IOE-DREAM七微服务架构

**核心架构组成**:
- **Gateway Service (8080)**: API网关
- **Common Service (8088)**: 公共模块微服务
- **DeviceComm Service (8087)**: 设备通讯微服务
- **OA Service (8089)**: OA微服务
- **Access Service (8090)**: 门禁服务
- **Attendance Service (8091)**: 考勤服务
- **Video Service (8092)**: 视频服务
- **Consume Service (8094)**: 消费服务
- **Visitor Service (8095)**: 访客服务

**架构特点**:
- 基于Spring Boot 3.5.8 + Java 17
- 严格遵循企业级微服务规范
- 支持高并发、高可用、水平扩展

**技术栈标准**:
- **数据库**: MySQL 8.0 + Druid连接池
- **缓存**: Redis + Caffeine多级缓存
- **注册中心**: Nacos
- **配置中心**: Nacos Config
- **认证授权**: Sa-Token

## 🏗️ 四层架构规范

**标准架构模式**:
```
Controller (接口控制层)
    ↓
Service (核心业务层)
    ↓
Manager (流程管理层)
    ↓
DAO (数据访问层)
```

**层级职责**:
- **Controller层**: HTTP请求处理、参数验证、权限控制
- **Service层**: 核心业务逻辑、事务管理、业务规则验证
- **Manager层**: 复杂流程编排、多数据组装、第三方服务集成
- **DAO层**: 数据库CRUD操作、SQL查询实现、数据访问边界

**严格禁止跨层访问**: Controller不能直接调用Manager/DAO！
### 1.1 离线名单下发流程
## ⚠️ IOE-DREAM零容忍规则（强制执行）

**必须遵守的架构规则**:
- ✅ **必须使用 @Resource 注入依赖**
- ✅ **必须使用 @Mapper 注解** (禁止@Repository)
- ✅ **必须使用 Dao 后缀** (禁止Repository)
- ✅ **必须使用 @RestController 注解**
- ✅ **必须使用 @Valid 参数校验**
- ✅ **必须返回统一ResponseDTO格式**
- ✅ **必须遵循四层架构边界**

**严格禁止事项**:
- ❌ **禁止使用 @Autowired 注入**
- ❌ **禁止使用 @Repository 注解**
- ❌ **禁止使用 Repository 后缀命名**
- ❌ **禁止跨层访问**
- ❌ **禁止在Controller中包含业务逻辑**
- ❌ **禁止直接访问数据库**

**违规后果**: P0级问题，立即修复，禁止合并！

```mermaid
flowchart TD
    A[系统定时任务] --> B[采集设备信息]
    B --> C[确定需要下发的设备]
    
    C --> D[构建离线名单包]
    D --> E[账户基础信息]
    E --> F[账户余额信息]
    F --> G[权限配置]
    G --> H[定值规则]
    H --> I[黑白名单]
    I --> J[餐别信息]
    J --> K[区域信息]
    
    K --> L[数据加密]
    L --> M[生成MD5校验]
    M --> N[压缩数据包]
    
    N --> O{设备在线?}
    O -->|是| P[立即推送]
    O -->|否| Q[存入待下发队列]
    
    P --> R[设备接收确认]
    R --> S{校验通过?}
    S -->|是| T[设备加载名单]
    S -->|否| U[重新下发]
    
    T --> V[更新下发状态]
    Q --> W[等待设备上线]
    W --> P
    
    style V fill:#51cf66
```

### 1.2 离线消费流程

```mermaid
flowchart TD
    A[用户刷卡] --> B[设备检测网络]
    B --> C{网络状态}
    
    C -->|在线| D1[在线消费流程]
    C -->|离线| D2[读取本地名单]
    
    D2 --> E{账户存在?}
    E -->|否| F[拒绝消费-账户不存在]
    E -->|是| G[读取账户信息]
    
    G --> H[检查黑名单]
    H --> I{在黑名单?}
    I -->|是| J[拒绝消费-黑名单]
    I -->|否| K[检查权限]
    
    K --> L{权限验证}
    L -->|失败| M[拒绝消费-无权限]
    L -->|通过| N[计算消费金额]
    
    N --> O[检查离线余额]
    O --> P{余额充足?}
    P -->|否| Q[拒绝消费-余额不足]
    P -->|是| R[扣除本地余额]
    
    R --> S[生成离线流水]
    S --> T[存储设备本地]
    T --> U[打印小票]
    U --> V[消费成功]
    
    style F fill:#ff6b6b
    style J fill:#ff6b6b
    style M fill:#ff6b6b
    style Q fill:#ff6b6b
    style V fill:#51cf66
```

### 1.3 离线数据上传流程

```mermaid
flowchart TD
    A[设备恢复网络] --> B[检测到在线]
    B --> C[读取本地离线流水]
    
    C --> D{有离线数据?}
    D -->|否| E[无需上传]
    D -->|是| F[按时间排序]
    
    F --> G[批量上传流水]
    G --> H[服务端接收]
    
    H --> I[验证流水签名]
    I --> J{签名有效?}
    J -->|否| K[拒绝上传-数据异常]
    J -->|是| L[逐条处理流水]
    
    L --> M{流水已存在?}
    M -->|是| N[标记已上传-跳过]
    M -->|否| O[校验余额]
    
    O --> P{余额冲突?}
    P -->|是| Q[冲突处理流程]
    P -->|否| R[写入数据库]
    
    Q --> S{冲突策略}
    S -->|补单| R
    S -->|回滚| T[标记异常]
    
    R --> U[更新账户余额]
    U --> V[标记已上传]
    V --> W[删除设备本地流水]
    
    N --> W
    T --> W
    W --> X{还有数据?}
    X -->|是| L
    X -->|否| Y[上传完成]
    
    style K fill:#ff6b6b
    style T fill:#ffd93d
    style Y fill:#51cf66
```

### 1.4 余额冲突处理流程

```mermaid
flowchart TD
    A[检测到余额冲突] --> B[获取冲突信息]
    B --> C[服务端余额]
    B --> D[离线消费前余额]
    B --> E[离线消费金额]
    
    C --> F[计算差异]
    D --> F
    E --> F
    
    F --> G{冲突类型}
    
    G -->|差异<5元| H1[小额差异-自动补单]
    G -->|服务端余额>离线余额| H2[在线充值导致-补单]
    G -->|服务端余额<离线余额| H3[在线消费导致-补单]
    G -->|差异>50元| H4[重大差异-人工审核]
    
    H1 --> I[生成补单流水]
    H2 --> I
    H3 --> I
    
    I --> J[写入数据库]
    J --> K[同步到设备]
    K --> L[发送通知]
    L --> M[冲突解决]
    
    H4 --> N[生成冲突工单]
    N --> O[人工审核]
    O --> P{审核结果}
    P -->|通过| I
    P -->|拒绝| Q[标记异常流水]
    
    Q --> R[锁定账户]
    R --> S[通知管理员]
    
    style M fill:#51cf66
    style S fill:#ff6b6b
```

---

## 🗄️ 数据库设计

### 2.1 ER关系图

```mermaid
erDiagram
    POSID_DEVICE ||--o{ POSID_OFFLINE_PACKAGE : "下发名单包"
    POSID_DEVICE ||--o{ POSID_OFFLINE_TRANSACTION : "离线流水"
    POSID_OFFLINE_PACKAGE ||--o{ POSID_OFFLINE_PACKAGE_DETAIL : "名单明细"
    POSID_OFFLINE_TRANSACTION }o--|| POSID_ACCOUNT : "消费账户"
    POSID_OFFLINE_CONFLICT ||--|| POSID_OFFLINE_TRANSACTION : "冲突流水"
    
    POSID_OFFLINE_PACKAGE {
        VARCHAR id PK "名单包ID"
        VARCHAR device_id FK "设备ID"
        VARCHAR package_no UK "名单包编号"
        INT account_count "账户数量"
        VARCHAR package_md5 "数据校验"
        VARCHAR status "状态"
        DATETIME generate_time "生成时间"
        DATETIME push_time "推送时间"
        DATETIME confirm_time "确认时间"
    }
    
    POSID_OFFLINE_PACKAGE_DETAIL {
        VARCHAR id PK "明细ID"
        VARCHAR package_id FK "名单包ID"
        VARCHAR account_id "账户ID"
        INT balance "账户余额"
        JSON permissions "权限配置"
        JSON fixed_rules "定值规则"
        DATE expire_date "过期日期"
    }
    
    POSID_OFFLINE_TRANSACTION {
        VARCHAR id PK "流水ID"
        VARCHAR transaction_no UK "交易流水号"
        VARCHAR device_id FK "设备ID"
        VARCHAR account_id FK "账户ID"
        INT consume_money "消费金额"
        INT balance_before "消费前余额"
        INT balance_after "消费后余额"
        VARCHAR status "状态"
        DATETIME consume_time "消费时间"
        DATETIME upload_time "上传时间"
        BOOLEAN has_conflict "是否冲突"
    }
    
    POSID_OFFLINE_CONFLICT {
        VARCHAR id PK "冲突ID"
        VARCHAR offline_transaction_id FK "离线流水ID"
        INT server_balance "服务端余额"
        INT offline_balance "离线余额"
        INT diff_money "差异金额"
        VARCHAR conflict_type "冲突类型"
        VARCHAR resolve_strategy "处理策略"
        VARCHAR resolve_status "处理状态"
        VARCHAR auditor_id "审核人"
        DATETIME resolve_time "处理时间"
    }
    
    POSID_DEVICE {
        VARCHAR id PK "设备ID"
        VARCHAR device_no UK "设备编号"
        VARCHAR device_name "设备名称"
        VARCHAR area_id FK "所属区域"
        VARCHAR online_status "在线状态"
        DATETIME last_heartbeat "最后心跳"
        BOOLEAN offline_enabled "是否启用离线"
        INT offline_capacity "离线容量"
    }
```

### 2.2 离线名单包结构

```mermaid
graph TB
    subgraph 离线名单包
        A[名单包头]
        B[账户列表]
        C[权限配置]
        D[定值规则]
        E[黑白名单]
        F[餐别配置]
    end
    
    A --> A1[包编号]
    A --> A2[生成时间]
    A --> A3[有效期]
    A --> A4[MD5校验]
    
    B --> B1[账户ID]
    B --> B2[卡号]
    B --> B3[姓名]
    B --> B4[余额]
    B --> B5[账户类别]
    
    C --> C1[可用区域]
    C --> C2[可用餐别]
    C --> C3[日限额]
    C --> C4[次数限制]
    
    D --> D1[定值金额]
    D --> D2[消费次数]
    D --> D3[时间段]
    
    E --> E1[黑名单ID列表]
    E --> E2[白名单ID列表]
    
    F --> F1[餐别ID]
    F --> F2[餐别名称]
    F --> F3[时间段]
    
    style A fill:#4ecdc4
    style B fill:#ff6b6b
    style C fill:#ffd93d
    style D fill:#74b9ff
    style E fill:#a29bfe
    style F fill:#95e1d3
```

### 2.3 离线消费状态机

```mermaid
stateDiagram-v2
    [*] --> 离线消费
    离线消费 --> 本地存储: 消费成功
    本地存储 --> 待上传: 设备恢复在线
    待上传 --> 上传中: 开始上传
    上传中 --> 服务端验证: 上传完成
    
    服务端验证 --> 已同步: 验证通过
    服务端验证 --> 余额冲突: 检测到冲突
    
    余额冲突 --> 自动补单: 小额差异
    余额冲突 --> 人工审核: 重大差异
    
    自动补单 --> 已同步: 补单完成
    人工审核 --> 已同步: 审核通过
    人工审核 --> 异常: 审核拒绝
    
    已同步 --> [*]
    异常 --> [*]
```

---

## 💾 缓存策略设计

### 3.1 核心缓存

| 缓存项 | Redis Key | 过期时间 | 说明 |
|-------|-----------|---------|------|
| 设备在线状态 | `device:online:{deviceId}` | 5分钟 | 心跳更新 |
| 待下发名单 | `offline:pending:{deviceId}` | 1小时 | 待推送队列 |
| 离线流水锁 | `lock:offline:{transactionNo}` | 5分钟 | 防重复上传 |
| 冲突处理队列 | `offline:conflict:queue` | 持久化 | 待处理冲突 |

---

## 📊 监控指标

### 4.1 核心指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 设备离线率 | 离线设备/总设备 | > 10% |
| 名单下发成功率 | 成功/总推送 | < 95% |
| 离线流水上传延迟 | 上传时间-消费时间 | > 24小时 |
| 余额冲突率 | 冲突流水/离线流水 | > 5% |
| 冲突解决时长 | 平均处理时间 | > 1小时 |

### 4.2 业务报表

- **设备在线监控**：实时在线率、离线时长分布
- **离线消费统计**：离线消费笔数、金额、占比
- **名单下发日志**：下发频率、成功率、失败原因
- **冲突处理报告**：冲突类型分布、处理效率

---

## 🎯 总结

### 关键设计

✅ **离线名单**：完整的账户、权限、规则打包下发  
✅ **离线消费**：设备本地验证和扣款，无需网络  
✅ **数据同步**：恢复网络后自动批量上传  
✅ **冲突处理**：智能识别冲突类型，自动/人工处理  
✅ **审计追溯**：每笔离线消费都有完整日志

### 支持场景

- 🏔️ **山区工地**：网络不稳定，设备频繁离线
- 🚢 **船舶食堂**：长期离线，定期同步数据
- 🏭 **工厂车间**：网络隔离，只能离线消费
- 🎓 **临时活动**：无网络环境，移动设备消费

---

## 📝 更新说明

### v2.0 (2025-10-31)
- ✅ 新增"离线消费与经营模式"章节
- ✅ 更新离线数据结构，包含新增配置字段
- ✅ 明确不同经营模式的离线支持程度

---

**文档版本**：v2.0  
**创建时间**：2025-10-31  
**适用版本**：POSID v3.13.1+

