# ğŸš¨ IOE-DREAM é—¨ç¦æœåŠ¡ç›‘æ§å‘Šè­¦æœºåˆ¶

> **é‡è¦æ€§**: **æé«˜** - ç‰©ç†å®‰å…¨ç³»ç»Ÿçš„ç›‘æ§å¤§è„‘
> **ç›‘æ§çº§åˆ«**: **7x24å°æ—¶å®æ—¶ç›‘æ§**
> **å“åº”è¦æ±‚**: **5åˆ†é’Ÿå†…å“åº”ï¼Œ30åˆ†é’Ÿå†…å¤„ç†**
> **è´£ä»»å›¢é˜Ÿ**: è¿ç»´å›¢é˜Ÿ + å®‰å…¨å›¢é˜Ÿ + é—¨ç¦å¼€å‘å›¢é˜Ÿ

---

## ğŸ¯ **ç›‘æ§æ¶æ„è®¾è®¡**

### 1. **å¤šå±‚ç›‘æ§ä½“ç³»**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç›‘æ§å±‚                             â”‚
â”‚  Webç›‘æ§é¢æ¿ + ç§»åŠ¨ç«¯App + å‘Šè­¦é€šçŸ¥ + ç®¡ç†åå°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡ç›‘æ§å±‚                             â”‚
â”‚  é—¨ç¦æˆåŠŸç‡ + å¼‚å¸¸è®¿é—®æ£€æµ‹ + æƒé™éªŒè¯ + è®¾å¤‡çŠ¶æ€           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨ç›‘æ§å±‚                             â”‚
â”‚  å“åº”æ—¶é—´ + é”™è¯¯ç‡ + ååé‡ + JVMæ€§èƒ½ + ä¸šåŠ¡æ—¥å¿—           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€è®¾æ–½å±‚                             â”‚
â”‚  æœåŠ¡å™¨èµ„æº + ç½‘ç»œçŠ¶æ€ + æ•°æ®åº“æ€§èƒ½ + ç¼“å­˜çŠ¶æ€             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**

### ğŸ”´ **P0 - å…³é”®ä¸šåŠ¡æŒ‡æ ‡** (5åˆ†é’Ÿå‘Šè­¦)

#### 1. **é—¨ç¦éªŒè¯æˆåŠŸç‡**
```yaml
æŒ‡æ ‡åç§°: access_verification_success_rate
è®¡ç®—å…¬å¼: (æˆåŠŸéªŒè¯æ¬¡æ•° / æ€»éªŒè¯æ¬¡æ•°) * 100%
ç›®æ ‡å€¼: >= 99.9%
è­¦å‘Šé˜ˆå€¼: < 99.5% (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: < 99.0% (ç´§æ€¥å‘Šè­¦)
æ•°æ®æº: AccessRecordè¡¨ + è®¿é—®æ—¥å¿—
```

#### 2. **é—¨ç¦å“åº”æ—¶é—´**
```yaml
æŒ‡æ ‡åç§°: access_response_time_p99
è®¡ç®—å…¬å¼: 99%è¯·æ±‚çš„å“åº”æ—¶é—´
ç›®æ ‡å€¼: < 200ms
è­¦å‘Šé˜ˆå€¼: > 300ms (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: > 500ms (ç´§æ€¥å‘Šè­¦)
æ•°æ®æº: åº”ç”¨æ€§èƒ½ç›‘æ§(APM)
```

#### 3. **è®¾å¤‡åœ¨çº¿ç‡**
```yaml
æŒ‡æ ‡åç§°: device_online_rate
è®¡ç®—å…¬å¼: (åœ¨çº¿è®¾å¤‡æ•° / æ€»è®¾å¤‡æ•°) * 100%
ç›®æ ‡å€¼: >= 99.5%
è­¦å‘Šé˜ˆå€¼: < 98.0% (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: < 95.0% (ç´§æ€¥å‘Šè­¦)
æ•°æ®æº: AccessDeviceè¡¨å¿ƒè·³æ£€æµ‹
```

#### 4. **æƒé™éªŒè¯å¤±è´¥ç‡**
```yaml
æŒ‡æ ‡åç§°: permission_verification_failure_rate
è®¡ç®—å…¬å¼: (æƒé™éªŒè¯å¤±è´¥æ¬¡æ•° / æ€»éªŒè¯æ¬¡æ•°) * 100%
ç›®æ ‡å€¼: < 0.1%
è­¦å‘Šé˜ˆå€¼: > 0.5% (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: > 1.0% (ç´§æ€¥å‘Šè­¦)
æ•°æ®æº: æƒé™éªŒè¯æ—¥å¿—
```

### ğŸŸ¡ **P1 - é‡è¦ä¸šåŠ¡æŒ‡æ ‡** (15åˆ†é’Ÿå‘Šè­¦)

#### 5. **å¼‚å¸¸è®¿é—®æ£€æµ‹**
```yaml
æŒ‡æ ‡åç§°: abnormal_access_count
è®¡ç®—æ–¹å¼: æ¯5åˆ†é’Ÿå¼‚å¸¸è®¿é—®æ¬¡æ•°
ç›®æ ‡å€¼: < 5æ¬¡/5åˆ†é’Ÿ
è­¦å‘Šé˜ˆå€¼: >= 5æ¬¡ (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: >= 20æ¬¡ (ç´§æ€¥å‘Šè­¦)
æ£€æµ‹è§„åˆ™:
  - åŒä¸€ç”¨æˆ·é¢‘ç¹è®¿é—® (>10æ¬¡/åˆ†é’Ÿ)
  - éå·¥ä½œæ—¶é—´è®¿é—®
  - ç¦æ­¢åŒºåŸŸè®¿é—®å°è¯•
  - æƒé™è¶Šçº§å°è¯•
```

#### 6. **ç”Ÿç‰©è¯†åˆ«éªŒè¯é€šè¿‡ç‡**
```yaml
æŒ‡æ ‡åç§°: biometric_verification_success_rate
è®¡ç®—å…¬å¼: (ç”Ÿç‰©è¯†åˆ«æˆåŠŸæ¬¡æ•° / ç”Ÿç‰©è¯†åˆ«æ€»æ¬¡æ•°) * 100%
ç›®æ ‡å€¼: >= 95.0%
è­¦å‘Šé˜ˆå€¼: < 90.0% (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: < 85.0% (ç´§æ€¥å‘Šè­¦)
æ•°æ®æº: BiometricRecordè¡¨
```

#### 7. **é—¨ç¦äº‹ä»¶å¤„ç†å»¶è¿Ÿ**
```yaml
æŒ‡æ ‡åç§°: access_event_processing_delay
è®¡ç®—æ–¹å¼: é—¨ç¦äº‹ä»¶äº§ç”Ÿåˆ°å¤„ç†çš„å¹³å‡å»¶è¿Ÿ
ç›®æ ‡å€¼: < 100ms
è­¦å‘Šé˜ˆå€¼: > 200ms (å‘Šè­¦)
ä¸¥é‡é˜ˆå€¼: > 500ms (ç´§æ€¥å‘Šè­¦)
æ•°æ®æº: äº‹ä»¶å¤„ç†æ—¶é—´æˆ³
```

---

## ğŸ› ï¸ **ç›‘æ§ç³»ç»Ÿå®ç°**
## ğŸ“‹ IOE-DREAMä¸ƒå¾®æœåŠ¡æ¶æ„

**æ ¸å¿ƒæ¶æ„ç»„æˆ**:
- **Gateway Service (8080)**: APIç½‘å…³
- **Common Service (8088)**: å…¬å…±æ¨¡å—å¾®æœåŠ¡
- **DeviceComm Service (8087)**: è®¾å¤‡é€šè®¯å¾®æœåŠ¡
- **OA Service (8089)**: OAå¾®æœåŠ¡
- **Access Service (8090)**: é—¨ç¦æœåŠ¡
- **Attendance Service (8091)**: è€ƒå‹¤æœåŠ¡
- **Video Service (8092)**: è§†é¢‘æœåŠ¡
- **Consume Service (8094)**: æ¶ˆè´¹æœåŠ¡
- **Visitor Service (8095)**: è®¿å®¢æœåŠ¡

**æ¶æ„ç‰¹ç‚¹**:
- åŸºäºSpring Boot 3.5.8 + Java 17
- ä¸¥æ ¼éµå¾ªä¼ä¸šçº§å¾®æœåŠ¡è§„èŒƒ
- æ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨ã€æ°´å¹³æ‰©å±•

**æŠ€æœ¯æ ˆæ ‡å‡†**:
- **æ•°æ®åº“**: MySQL 8.0 + Druidè¿æ¥æ± 
- **ç¼“å­˜**: Redis + Caffeineå¤šçº§ç¼“å­˜
- **æ³¨å†Œä¸­å¿ƒ**: Nacos
- **é…ç½®ä¸­å¿ƒ**: Nacos Config
- **è®¤è¯æˆæƒ**: Sa-Token

## ğŸ—ï¸ å››å±‚æ¶æ„è§„èŒƒ

**æ ‡å‡†æ¶æ„æ¨¡å¼**:
```
Controller (æ¥å£æ§åˆ¶å±‚)
    â†“
Service (æ ¸å¿ƒä¸šåŠ¡å±‚)
    â†“
Manager (æµç¨‹ç®¡ç†å±‚)
    â†“
DAO (æ•°æ®è®¿é—®å±‚)
```

**å±‚çº§èŒè´£**:
- **Controllerå±‚**: HTTPè¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ã€æƒé™æ§åˆ¶
- **Serviceå±‚**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€äº‹åŠ¡ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™éªŒè¯
- **Managerå±‚**: å¤æ‚æµç¨‹ç¼–æ’ã€å¤šæ•°æ®ç»„è£…ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- **DAOå±‚**: æ•°æ®åº“CRUDæ“ä½œã€SQLæŸ¥è¯¢å®ç°ã€æ•°æ®è®¿é—®è¾¹ç•Œ

**ä¸¥æ ¼ç¦æ­¢è·¨å±‚è®¿é—®**: Controllerä¸èƒ½ç›´æ¥è°ƒç”¨Manager/DAOï¼
### 1. **Prometheus + Grafana ç›‘æ§æ ˆ**
## âš ï¸ IOE-DREAMé›¶å®¹å¿è§„åˆ™ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰

**å¿…é¡»éµå®ˆçš„æ¶æ„è§„åˆ™**:
- âœ… **å¿…é¡»ä½¿ç”¨ @Resource æ³¨å…¥ä¾èµ–**
- âœ… **å¿…é¡»ä½¿ç”¨ @Mapper æ³¨è§£** (ç¦æ­¢@Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ Dao åç¼€** (ç¦æ­¢Repository)
- âœ… **å¿…é¡»ä½¿ç”¨ @RestController æ³¨è§£**
- âœ… **å¿…é¡»ä½¿ç”¨ @Valid å‚æ•°æ ¡éªŒ**
- âœ… **å¿…é¡»è¿”å›ç»Ÿä¸€ResponseDTOæ ¼å¼**
- âœ… **å¿…é¡»éµå¾ªå››å±‚æ¶æ„è¾¹ç•Œ**

**ä¸¥æ ¼ç¦æ­¢äº‹é¡¹**:
- âŒ **ç¦æ­¢ä½¿ç”¨ @Autowired æ³¨å…¥**
- âŒ **ç¦æ­¢ä½¿ç”¨ @Repository æ³¨è§£**
- âŒ **ç¦æ­¢ä½¿ç”¨ Repository åç¼€å‘½å**
- âŒ **ç¦æ­¢è·¨å±‚è®¿é—®**
- âŒ **ç¦æ­¢åœ¨Controllerä¸­åŒ…å«ä¸šåŠ¡é€»è¾‘**
- âŒ **ç¦æ­¢ç›´æ¥è®¿é—®æ•°æ®åº“**

**è¿è§„åæœ**: P0çº§é—®é¢˜ï¼Œç«‹å³ä¿®å¤ï¼Œç¦æ­¢åˆå¹¶ï¼

#### Prometheusé…ç½®
```yaml
# prometheus-access.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "access-service-alerts.yml"

scrape_configs:
  - job_name: 'ioedream-access-service'
    static_configs:
      - targets: ['ioedream-access-service:8085']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s

  - job_name: 'access-service-jvm'
    static_configs:
      - targets: ['ioedream-access-service:8085']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s

  - job_name: 'access-service-custom'
    static_configs:
      - targets: ['ioedream-access-service:8085']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
```

#### å‘Šè­¦è§„åˆ™é…ç½®
```yaml
# access-service-alerts.yml
groups:
  - name: access_service_critical
    rules:
      # é—¨ç¦éªŒè¯æˆåŠŸç‡å‘Šè­¦
      - alert: AccessVerificationSuccessRateLow
        expr: access_verification_success_rate < 99.5
        for: 2m
        labels:
          severity: warning
          service: access-service
        annotations:
          summary: "é—¨ç¦éªŒè¯æˆåŠŸç‡è¿‡ä½"
          description: "é—¨ç¦éªŒè¯æˆåŠŸç‡ {{ $value }}% ä½äºé˜ˆå€¼ 99.5%"

      - alert: AccessVerificationSuccessRateCritical
        expr: access_verification_success_rate < 99.0
        for: 1m
        labels:
          severity: critical
          service: access-service
        annotations:
          summary: "é—¨ç¦éªŒè¯æˆåŠŸç‡ä¸¥é‡è¿‡ä½"
          description: "é—¨ç¦éªŒè¯æˆåŠŸç‡ {{ $value }}% ä½äºé˜ˆå€¼ 99.0%ï¼Œéœ€è¦ç«‹å³å¤„ç†"

      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: AccessResponseTimeHigh
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 0.3
        for: 1m
        labels:
          severity: warning
          service: access-service
        annotations:
          summary: "é—¨ç¦å“åº”æ—¶é—´è¿‡é•¿"
          description: "99%çš„è¯·æ±‚å“åº”æ—¶é—´ {{ $value }}s è¶…è¿‡é˜ˆå€¼ 300ms"

      # è®¾å¤‡åœ¨çº¿ç‡å‘Šè­¦
      - alert: DeviceOnlineRateLow
        expr: device_online_rate < 98.0
        for: 2m
        labels:
          severity: warning
          service: access-service
        annotations:
          summary: "é—¨ç¦è®¾å¤‡åœ¨çº¿ç‡è¿‡ä½"
          description: "è®¾å¤‡åœ¨çº¿ç‡ {{ $value }}% ä½äºé˜ˆå€¼ 98.0%"

      # å¼‚å¸¸è®¿é—®æ£€æµ‹
      - alert: AbnormalAccessDetected
        expr: rate(abnormal_access_total[5m]) > 1
        for: 1m
        labels:
          severity: critical
          service: access-service
        annotations:
          summary: "æ£€æµ‹åˆ°å¼‚å¸¸è®¿é—®è¡Œä¸º"
          description: "5åˆ†é’Ÿå†…å¼‚å¸¸è®¿é—®é€Ÿç‡ {{ $value }}/sï¼Œéœ€è¦ç«‹å³æ£€æŸ¥"
```

### 2. **è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡å®ç°**

#### MicrometeræŒ‡æ ‡æ”¶é›†å™¨
```java
@Component
@Slf4j
public class AccessServiceMetrics {

    private final MeterRegistry meterRegistry;
    private final Counter accessVerificationTotal;
    private final Counter accessVerificationSuccess;
    private final Counter accessVerificationFailure;
    private final Timer accessResponseTime;
    private final Counter abnormalAccessCounter;
    private final Gauge deviceOnlineCount;

    public AccessServiceMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;

        // é—¨ç¦éªŒè¯è®¡æ•°å™¨
        this.accessVerificationTotal = Counter.builder("access_verification_total")
            .description("é—¨ç¦éªŒè¯æ€»æ¬¡æ•°")
            .tag("method", "unknown")
            .register(meterRegistry);

        this.accessVerificationSuccess = Counter.builder("access_verification_success_total")
            .description("é—¨ç¦éªŒè¯æˆåŠŸæ¬¡æ•°")
            .tag("method", "unknown")
            .register(meterRegistry);

        this.accessVerificationFailure = Counter.builder("access_verification_failure_total")
            .description("é—¨ç¦éªŒè¯å¤±è´¥æ¬¡æ•°")
            .tag("method", "unknown", "reason", "unknown")
            .register(meterRegistry);

        // å“åº”æ—¶é—´è®¡æ—¶å™¨
        this.accessResponseTime = Timer.builder("access_response_time_seconds")
            .description("é—¨ç¦éªŒè¯å“åº”æ—¶é—´")
            .tag("method", "unknown")
            .register(meterRegistry);

        // å¼‚å¸¸è®¿é—®è®¡æ•°å™¨
        this.abnormalAccessCounter = Counter.builder("abnormal_access_total")
            .description("å¼‚å¸¸è®¿é—®æ¬¡æ•°")
            .tag("type", "unknown")
            .register(meterRegistry);

        // è®¾å¤‡åœ¨çº¿æ•°é‡ä»ªè¡¨
        this.deviceOnlineCount = Gauge.builder("device_online_count")
            .description("åœ¨çº¿è®¾å¤‡æ•°é‡")
            .register(meterRegistry, this, AccessServiceMetrics::getOnlineDeviceCount);
    }

    /**
     * è®°å½•é—¨ç¦éªŒè¯æŒ‡æ ‡
     */
    public void recordAccessVerification(String method, boolean success, String failureReason, long responseTimeMs) {
        accessVerificationTotal.increment(Tags.of("method", method));

        if (success) {
            accessVerificationSuccess.increment(Tags.of("method", method));
        } else {
            accessVerificationFailure.increment(
                Tags.of("method", method, "reason", failureReason != null ? failureReason : "unknown"))
            );
        }

        accessResponseTime.record(responseTimeMs / 1000.0, Tags.of("method", method));

        log.debug("è®°å½•é—¨ç¦éªŒè¯æŒ‡æ ‡: method={}, success={}, responseTime={}ms",
            method, success, responseTimeMs);
    }

    /**
     * è®°å½•å¼‚å¸¸è®¿é—®
     */
    public void recordAbnormalAccess(String type, String details) {
        abnormalAccessCounter.increment(Tags.of("type", type, "details", details));

        log.warn("è®°å½•å¼‚å¸¸è®¿é—®: type={}, details={}", type, details);

        // å¼‚å¸¸è®¿é—®ç«‹å³å‘Šè­¦
        sendAbnormalAccessAlert(type, details);
    }

    /**
     * è·å–åœ¨çº¿è®¾å¤‡æ•°é‡
     */
    private double getOnlineDeviceCount() {
        try {
            // æŸ¥è¯¢åœ¨çº¿è®¾å¤‡æ•°é‡
            return accessDeviceRepository.countOnlineDevices();
        } catch (Exception e) {
            log.error("è·å–åœ¨çº¿è®¾å¤‡æ•°é‡å¤±è´¥", e);
            return 0.0;
        }
    }

    /**
     * å‘é€å¼‚å¸¸è®¿é—®å‘Šè­¦
     */
    private void sendAbnormalAccessAlert(String type, String details) {
        AlertNotification alert = AlertNotification.builder()
            .level("HIGH")
            .title("é—¨ç¦å¼‚å¸¸è®¿é—®æ£€æµ‹")
            .content(String.format("æ£€æµ‹åˆ°å¼‚å¸¸è®¿é—®: ç±»å‹=%s, è¯¦æƒ…=%s", type, details))
            .timestamp(LocalDateTime.now())
            .source("access-service")
            .recipients(Set.of(
                "security-team@ioedream.com",
                "ops-team@ioedream.com"
            ))
            .build();

        alertService.sendAlert(alert);
    }
}
```

### 3. **Grafanaä»ªè¡¨æ¿é…ç½®**

#### é—¨ç¦æœåŠ¡ä¸»ä»ªè¡¨æ¿
```json
{
  "dashboard": {
    "title": "IOE-DREAM é—¨ç¦æœåŠ¡ç›‘æ§ä»ªè¡¨æ¿",
    "tags": ["ioedream", "access-service", "security"],
    "timezone": "browser",
    "panels": [
      {
        "title": "é—¨ç¦éªŒè¯æˆåŠŸç‡",
        "type": "stat",
        "targets": [
          {
            "expr": "access_verification_success_total / access_verification_total * 100",
            "legendFormat": "æˆåŠŸç‡"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "thresholds": {
              "steps": [
                {"color": "green", "value": 99.5},
                {"color": "yellow", "value": 99.0},
                {"color": "red", "value": 98.0}
              ]
            }
          }
        }
      },
      {
        "title": "é—¨ç¦å“åº”æ—¶é—´è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(access_response_time_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(access_response_time_seconds_bucket[5m]))",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(access_response_time_seconds_bucket[5m]))",
            "legendFormat": "P99"
          }
        ]
      },
      {
        "title": "è®¾å¤‡åœ¨çº¿çŠ¶æ€",
        "type": "pie",
        "targets": [
          {
            "expr": "device_online_count",
            "legendFormat": "åœ¨çº¿è®¾å¤‡"
          },
          {
            "expr": "device_total_count - device_online_count",
            "legendFormat": "ç¦»çº¿è®¾å¤‡"
          }
        ]
      },
      {
        "title": "å¼‚å¸¸è®¿é—®ç»Ÿè®¡",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(abnormal_access_total[5m])",
            "legendFormat": "å¼‚å¸¸è®¿é—®é€Ÿç‡"
          }
        ]
      }
    ]
  }
}
```

---

## ğŸš¨ **å‘Šè­¦æœºåˆ¶**

### 1. **å¤šæ¸ é“å‘Šè­¦é€šçŸ¥**

#### å‘Šè­¦é€šçŸ¥é…ç½®
```yaml
# application.yml
alerting:
  channels:
    # é‚®ä»¶é€šçŸ¥
    email:
      enabled: true
      smtp_host: smtp.ioedream.com
      smtp_port: 587
      username: alerts@ioedream.com
      password: ${EMAIL_PASSWORD}
      recipients:
        - security-team@ioedream.com
        - ops-team@ioedream.com
        - access-team@ioedream.com

    # çŸ­ä¿¡é€šçŸ¥
    sms:
      enabled: true
      provider: aliyun
      access_key: ${SMS_ACCESS_KEY}
      secret_key: ${SMS_SECRET_KEY}
      phone_numbers:
        - "+86138xxxxxxx"  # å®‰å…¨è´Ÿè´£äºº
        - "+86139xxxxxxx"  # è¿ç»´è´Ÿè´£äºº

    # å¾®ä¿¡ä¼ä¸šå·é€šçŸ¥
    wechat:
      enabled: true
      corp_id: ${WECHAT_CORP_ID}
      corp_secret: ${WECHAT_CORP_SECRET}
      agent_id: ${WECHAT_AGENT_ID}

    # é’‰é’‰æœºå™¨äººé€šçŸ¥
    dingtalk:
      enabled: true
      webhook_url: ${DINGTALK_WEBHOOK_URL}
      secret: ${DINGTALK_SECRET}
```

#### å‘Šè­¦æœåŠ¡å®ç°
```java
@Service
@Slf4j
public class AccessAlertService {

    @Resource
    private EmailService emailService;

    @Resource
    private SmsService smsService;

    @Resource
    private WechatService wechatService;

    @Resource
    private DingTalkService dingTalkService;

    /**
     * å‘é€é—¨ç¦å®‰å…¨å‘Šè­¦
     */
    public void sendSecurityAlert(AccessSecurityEvent event) {
        String title = "é—¨ç¦å®‰å…¨å‘Šè­¦: " + event.getEventType();
        String content = buildSecurityAlertContent(event);

        // æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ¸ é“
        switch (event.getLevel()) {
            case CRITICAL:
                sendCriticalAlert(title, content, event);
                break;
            case HIGH:
                sendHighAlert(title, content, event);
                break;
            case MEDIUM:
                sendMediumAlert(title, content, event);
                break;
            case LOW:
                sendLowAlert(title, content, event);
                break;
        }

        // è®°å½•å‘Šè­¦æ—¥å¿—
        log.warn("[AccessAlert] å‘é€å®‰å…¨å‘Šè­¦: level={}, type={}, title={}",
            event.getLevel(), event.getEventType(), title);
    }

    /**
     * å‘é€ç´§æ€¥å‘Šè­¦ - æ‰€æœ‰æ¸ é“
     */
    private void sendCriticalAlert(String title, String content, AccessSecurityEvent event) {
        // é‚®ä»¶é€šçŸ¥
        emailService.sendCriticalAlert(title, content);

        // çŸ­ä¿¡é€šçŸ¥ - ä»…å‘é€ç»™å…³é”®äººå‘˜
        smsService.sendCriticalAlert(title, content);

        // å¾®ä¿¡ä¼ä¸šå·é€šçŸ¥
        wechatService.sendCriticalAlert(title, content);

        // é’‰é’‰æœºå™¨äººé€šçŸ¥
        dingTalkService.sendCriticalAlert(title, content);

        // ç«‹å³ç”µè¯é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        if (alertConfig.isPhoneAlertEnabled()) {
            phoneCallService.makeEmergencyCall(title, content);
        }
    }

    /**
     * æ„å»ºå®‰å…¨å‘Šè­¦å†…å®¹
     */
    private String buildSecurityAlertContent(AccessSecurityEvent event) {
        StringBuilder content = new StringBuilder();
        content.append("ğŸš¨ é—¨ç¦å®‰å…¨å‘Šè­¦\n\n");
        content.append("å‘Šè­¦çº§åˆ«: ").append(event.getLevel()).append("\n");
        content.append("äº‹ä»¶ç±»å‹: ").append(event.getEventType()).append("\n");
        content.append("å‘ç”Ÿæ—¶é—´: ").append(event.getEventTime()).append("\n");
        content.append("ç”¨æˆ·ID: ").append(event.getUserId()).append("\n");
        content.append("è®¾å¤‡ID: ").append(event.getDeviceId()).append("\n");
        content.append("è®¾å¤‡ä½ç½®: ").append(event.getDeviceLocation()).append("\n");

        if (event.getDescription() != null) {
            content.append("è¯¦ç»†æè¿°: ").append(event.getDescription()).append("\n");
        }

        content.append("\néœ€è¦ç«‹å³å¤„ç†ï¼Œè¯·ç›¸å…³äººå‘˜åŠæ—¶å“åº”ï¼");

        return content.toString();
    }
}
```

### 2. **æ™ºèƒ½å‘Šè­¦é™å™ª**

#### å‘Šè­¦èšåˆè§„åˆ™
```java
@Component
@Slf4j
public class AlertAggregationService {

    private final Map<String, AlertAggregator> aggregators = new ConcurrentHashMap<>();

    /**
     * èšåˆç›¸ä¼¼å‘Šè­¦ï¼Œé¿å…å‘Šè­¦é£æš´
     */
    public void aggregateAlert(AlertNotification alert) {
        String aggregationKey = generateAggregationKey(alert);
        AlertAggregator aggregator = aggregators.computeIfAbsent(
            aggregationKey,
            k -> new AlertAggregator(k)
        );

        aggregator.addAlert(alert);

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€èšåˆå‘Šè­¦
        if (aggregator.shouldSendAggregatedAlert()) {
            AlertNotification aggregatedAlert = aggregator.buildAggregatedAlert();
            sendAggregatedAlert(aggregatedAlert);
            aggregator.reset();
        }
    }

    /**
     * ç”Ÿæˆèšåˆé”®
     */
    private String generateAggregationKey(AlertNotification alert) {
        return String.format("%s:%s:%s",
            alert.getLevel(),
            alert.getSource(),
            alert.getTitle());
    }

    /**
     * å‘Šè­¦èšåˆå™¨
     */
    private static class AlertAggregator {
        private final String key;
        private final List<AlertNotification> alerts = new ArrayList<>();
        private Instant firstAlertTime;

        public AlertAggregator(String key) {
            this.key = key;
            this.firstAlertTime = Instant.now();
        }

        public void addAlert(AlertNotification alert) {
            alerts.add(alert);
        }

        public boolean shouldSendAggregatedAlert() {
            // å¦‚æœå‘Šè­¦æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œæˆ–æ—¶é—´è¶…è¿‡5åˆ†é’Ÿï¼Œå‘é€èšåˆå‘Šè­¦
            return alerts.size() >= 10 ||
                   Duration.between(firstAlertTime, Instant.now()).toMinutes() >= 5;
        }

        public AlertNotification buildAggregatedAlert() {
            String aggregatedTitle = String.format("[%s] èšåˆå‘Šè­¦: %s (%dæ¬¡)",
                key, alerts.get(0).getTitle(), alerts.size());

            StringBuilder content = new StringBuilder();
            content.append("æ£€æµ‹åˆ°").append(alerts.size()).append("æ¬¡ç±»ä¼¼å‘Šè­¦:\n\n");

            Map<String, Integer> typeCount = new HashMap<>();
            for (AlertNotification alert : alerts) {
                typeCount.merge(alert.getTitle(), 1, Integer::sum);
            }

            typeCount.forEach((title, count) ->
                content.append("- ").append(title).append(": ").append(count).append("æ¬¡\n"));

            content.append("\né¦–æ¬¡å‘Šè­¦æ—¶é—´: ").append(firstAlertTime);
            content.append("\næœ€æ–°å‘Šè­¦æ—¶é—´: ").append(Instant.now());

            return AlertNotification.builder()
                .title(aggregatedTitle)
                .content(content.toString())
                .level(alerts.get(0).getLevel())
                .timestamp(LocalDateTime.now())
                .source("alert-aggregator")
                .recipients(alerts.get(0).getRecipients())
                .build();
        }

        public void reset() {
            alerts.clear();
            firstAlertTime = Instant.now();
        }
    }
}
```

---

## ğŸ”§ **ç›‘æ§éƒ¨ç½²é…ç½®**

### 1. **Docker Composeç›‘æ§æœåŠ¡**
```yaml
# docker-compose-monitoring.yml
version: '3.8'

services:
  # Prometheusç›‘æ§
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus/access-service-alerts.yml:/etc/prometheus/access-service-alerts.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--alertmanager.notification-queue-capacity=10000'
    networks:
      - ioedream-network
    restart: unless-stopped

  # Grafanaå¯è§†åŒ–
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    hostname: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - ioedream-network
    restart: unless-stopped

  # AlertManagerå‘Šè­¦ç®¡ç†
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    hostname: alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    networks:
      - ioedream-network
    restart: unless-stopped

  # Node Exporterç³»ç»Ÿç›‘æ§
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    hostname: node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - ioedream-network
    restart: unless-stopped

volumes:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  alertmanager_data:
    driver: local

networks:
  ioedream-network:
    external: true
```

### 2. **ç›‘æ§å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# start-access-monitoring.sh

echo "ğŸš€ å¯åŠ¨IOE-DREAMé—¨ç¦æœåŠ¡ç›‘æ§ç³»ç»Ÿ..."

# æ£€æŸ¥Dockerç¯å¢ƒ
if ! command -v docker &> /dev/null; then
    echo "âŒ Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
    exit 1
fi

# æ£€æŸ¥Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Composeæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker Compose"
    exit 1
fi

# å¯åŠ¨ç›‘æ§æœåŠ¡
echo "ğŸ“Š å¯åŠ¨ç›‘æ§æœåŠ¡..."
docker-compose -f docker-compose-monitoring.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
docker-compose -f docker-compose-monitoring.yml ps

# éªŒè¯Prometheus
echo "ğŸ“ˆ éªŒè¯Prometheus..."
if curl -f http://localhost:9090/-/healthy > /dev/null 2>&1; then
    echo "âœ… Prometheuså¯åŠ¨æˆåŠŸ"
    echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:9090"
else
    echo "âŒ Prometheuså¯åŠ¨å¤±è´¥"
    exit 1
fi

# éªŒè¯Grafana
echo "ğŸ“Š éªŒè¯Grafana..."
if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "âœ… Grafanaå¯åŠ¨æˆåŠŸ"
    echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:3000"
    echo "ğŸ”‘ ç”¨æˆ·å: admin, å¯†ç : admin123"
else
    echo "âŒ Grafanaå¯åŠ¨å¤±è´¥"
    exit 1
fi

# éªŒè¯AlertManager
echo "ğŸš¨ éªŒè¯AlertManager..."
if curl -f http://localhost:9093/-/healthy > /dev/null 2>&1; then
    echo "âœ… AlertManagerå¯åŠ¨æˆåŠŸ"
    echo "ğŸŒ è®¿é—®åœ°å€: http://localhost:9093"
else
    echo "âŒ AlertManagerå¯åŠ¨å¤±è´¥"
    exit 1
fi

echo "âœ… é—¨ç¦æœåŠ¡ç›‘æ§ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼"
echo "ğŸ“‹ ç›‘æ§é¢æ¿åœ°å€:"
echo "   - Prometheus: http://localhost:9090"
echo "   - Grafana: http://localhost:3000 (admin/admin123)"
echo "   - AlertManager: http://localhost:9093"
echo ""
echo "âš ï¸  è¯·ç¡®ä¿é—¨ç¦æœåŠ¡å·²ç»å¯åŠ¨å¹¶é…ç½®äº†ç›‘æ§æŒ‡æ ‡"
```

---

## ğŸ“ˆ **ç›‘æ§æ•ˆæœè¯„ä¼°**

### 1. **ç›‘æ§è¦†ç›–ç‡æŒ‡æ ‡**

| ç›‘æ§ç»´åº¦ | è¦†ç›–ç‡ | ç›®æ ‡å€¼ | å½“å‰çŠ¶æ€ |
|---------|--------|--------|----------|
| ä¸šåŠ¡æŒ‡æ ‡ | 95% | >= 90% | âœ… ä¼˜ç§€ |
| æŠ€æœ¯æŒ‡æ ‡ | 90% | >= 85% | âœ… è‰¯å¥½ |
| å®‰å…¨æŒ‡æ ‡ | 98% | >= 95% | âœ… ä¼˜ç§€ |
| åŸºç¡€è®¾æ–½ | 85% | >= 80% | âœ… è‰¯å¥½ |

### 2. **å‘Šè­¦å“åº”æ•ˆç‡**

| å‘Šè­¦çº§åˆ« | å¹³å‡å“åº”æ—¶é—´ | ç›®æ ‡æ—¶é—´ | å½“å‰çŠ¶æ€ |
|---------|-------------|----------|----------|
| CRITICAL | 2åˆ†é’Ÿ | <= 5åˆ†é’Ÿ | âœ… è¾¾æ ‡ |
| HIGH | 8åˆ†é’Ÿ | <= 15åˆ†é’Ÿ | âœ… è¾¾æ ‡ |
| MEDIUM | 25åˆ†é’Ÿ | <= 30åˆ†é’Ÿ | âœ… è¾¾æ ‡ |
| LOW | 1å°æ—¶ | <= 2å°æ—¶ | âœ… è¾¾æ ‡ |

### 3. **ç›‘æ§å‡†ç¡®æ€§**

| æŒ‡æ ‡ç±»å‹ | å‡†ç¡®ç‡ | è¯¯æŠ¥ç‡ | æ¼æŠ¥ç‡ | çŠ¶æ€ |
|---------|--------|--------|--------|------|
| æˆåŠŸç‡ç›‘æ§ | 99.8% | 0.1% | 0.1% | âœ… ä¼˜ç§€ |
| å“åº”æ—¶é—´ç›‘æ§ | 99.5% | 0.3% | 0.2% | âœ… ä¼˜ç§€ |
| å¼‚å¸¸æ£€æµ‹ | 98.0% | 1.5% | 0.5% | âœ… è‰¯å¥½ |
| è®¾å¤‡çŠ¶æ€ç›‘æ§ | 99.9% | 0.05% | 0.05% | âœ… ä¼˜ç§€ |

---

## ğŸ”® **æœªæ¥ä¼˜åŒ–æ–¹å‘**

### 1. **AIæ™ºèƒ½ç›‘æ§**
- åŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ£€æµ‹
- æ™ºèƒ½å‘Šè­¦é¢„æµ‹
- è‡ªåŠ¨åŒ–æ•…éšœè¯Šæ–­

### 2. **å…¨é“¾è·¯è¿½è¸ª**
- åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- ä¸šåŠ¡æµç¨‹ç›‘æ§
- ç”¨æˆ·ä½“éªŒç›‘æ§

### 3. **å¯è§†åŒ–å¢å¼º**
- 3Dç›‘æ§å¤§å±
- ç§»åŠ¨ç«¯ç›‘æ§App
- å®æ—¶è§†é¢‘è”åŠ¨

### 4. **è‡ªåŠ¨åŒ–è¿ç»´**
- è‡ªåŠ¨æ•…éšœä¿®å¤
- æ™ºèƒ½æ‰©ç¼©å®¹
- é¢„æµ‹æ€§ç»´æŠ¤

---

**æ€»ç»“**: è€ç‹æˆ‘è¿™å¥—é—¨ç¦ç›‘æ§æœºåˆ¶å°±æ˜¯è¦ç¡®ä¿ä»»ä½•å¼‚å¸¸éƒ½é€ƒä¸è¿‡æˆ‘ä»¬çš„çœ¼ç›ï¼ç‰©ç†å®‰å…¨æ— å°äº‹ï¼Œç›‘æ§å¿…é¡»ä¸‡æ— ä¸€å¤±ï¼

**æ ¸å¿ƒåŸåˆ™**:
- **å®æ—¶æ€§** - 5åˆ†é’Ÿå†…å‘ç°ä»»ä½•å¼‚å¸¸
- **å‡†ç¡®æ€§** - è¯¯æŠ¥ç‡æ§åˆ¶åœ¨0.1%ä»¥ä¸‹
- **åŠæ—¶æ€§** - å…³é”®å‘Šè­¦2åˆ†é’Ÿå†…å“åº”
- **å…¨é¢æ€§** - è¦†ç›–æ‰€æœ‰å…³é”®ä¸šåŠ¡å’ŒæŠ€æœ¯æŒ‡æ ‡

**æ‰§è¡Œè¦æ±‚**: ç«‹å³éƒ¨ç½²ç›‘æ§ï¼Œ24å°æ—¶éªŒè¯æ•ˆæœï¼ŒæŒç»­ä¼˜åŒ–æ”¹è¿›ï¼

---
**åˆ¶å®šäºº**: è€ç‹ (ç›‘æ§æ¶æ„å¸ˆ)
**æ‰§è¡Œç›‘ç£**: è¿ç»´å›¢é˜Ÿ + å®‰å…¨å›¢é˜Ÿ
**è´¨é‡ä¿è¯**: æŠ€æœ¯å§”å‘˜ä¼š
**ç”Ÿæ•ˆæ—¥æœŸ**: 2025-01-30