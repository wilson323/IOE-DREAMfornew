# ZKBioSecurity-ACC门禁系统 - 事件记录查询模块流程图

## 事件记录查询模块概述

作为门禁系统的专属事件记录中心，专注于处理门禁核心业务事件：
- **门禁打卡事件记录**：刷卡、人脸识别、指纹等所有通行验证事件
- **报警异常记录**：非法通行、设备异常、安全告警等异常事件
- 门禁事件报表生成和分析
- 事件数据的照片、视频预览、导出、打印
- 门禁系统事件审计和追踪

## 门禁事件数据来源

### 事件记录分类

门禁系统事件记录分为两大类：

#### 1. 门禁打卡事件记录
- **刷卡通行事件**：IC卡、ID卡刷卡验证记录
- **生物识别事件**：人脸识别、指纹验证、掌纹识别记录
- **密码输入事件**：密码键盘输入验证记录
- **二维码事件**：手机二维码扫描验证记录
- **多重验证事件**：多种验证方式组合验证记录

#### 2. 报警异常记录
- **非法通行事件**：无权限通行、尾随、胁迫等异常事件
- **设备异常事件**：设备离线、故障、通讯异常等设备告警
- **安全告警事件**：防拆报警、门磁异常、强制开门等安全事件
- **系统异常事件**：验证超时、数据异常、系统错误等系统事件

### 事件数据流程

```mermaid
graph TB
    subgraph 门禁事件数据流
        AccessEvents[门禁设备] --> AccessRecords[通行事件记录]
        AlarmEvents[报警系统] --> AlarmRecords[报警异常记录]

        AccessRecords --> EventDatabase[门禁事件数据库]
        AlarmRecords --> EventDatabase

        EventDatabase --> EventQueryModule[事件记录查询模块]

        DeviceModule[设备管理模块] -.->|产生设备事件| EventDatabase
        AreaModule[区域管理模块] -.->|产生区域事件| EventDatabase
        PersonModule[人员管理模块] -.->|产生人员事件| EventDatabase
    end
```

## 门禁事件记录查询模块流程图
## 📋 IOE-DREAM七微服务架构

**核心架构组成**:
- **Gateway Service (8080)**: API网关
- **Common Service (8088)**: 公共模块微服务
- **DeviceComm Service (8087)**: 设备通讯微服务
- **OA Service (8089)**: OA微服务
- **Access Service (8090)**: 门禁服务
- **Attendance Service (8091)**: 考勤服务
- **Video Service (8092)**: 视频服务
- **Consume Service (8094)**: 消费服务
- **Visitor Service (8095)**: 访客服务

**架构特点**:
- 基于Spring Boot 3.5.8 + Java 17
- 严格遵循企业级微服务规范
- 支持高并发、高可用、水平扩展

**技术栈标准**:
- **数据库**: MySQL 8.0 + Druid连接池
- **缓存**: Redis + Caffeine多级缓存
- **注册中心**: Nacos
- **配置中心**: Nacos Config
- **认证授权**: Sa-Token

## 🏗️ 四层架构规范

**标准架构模式**:
```
Controller (接口控制层)
    ↓
Service (核心业务层)
    ↓
Manager (流程管理层)
    ↓
DAO (数据访问层)
```

**层级职责**:
- **Controller层**: HTTP请求处理、参数验证、权限控制
- **Service层**: 核心业务逻辑、事务管理、业务规则验证
- **Manager层**: 复杂流程编排、多数据组装、第三方服务集成
- **DAO层**: 数据库CRUD操作、SQL查询实现、数据访问边界

**严格禁止跨层访问**: Controller不能直接调用Manager/DAO！
```mermaid
## ⚠️ IOE-DREAM零容忍规则（强制执行）

**必须遵守的架构规则**:
- ✅ **必须使用 @Resource 注入依赖**
- ✅ **必须使用 @Mapper 注解** (禁止@Repository)
- ✅ **必须使用 Dao 后缀** (禁止Repository)
- ✅ **必须使用 @RestController 注解**
- ✅ **必须使用 @Valid 参数校验**
- ✅ **必须返回统一ResponseDTO格式**
- ✅ **必须遵循四层架构边界**

**严格禁止事项**:
- ❌ **禁止使用 @Autowired 注入**
- ❌ **禁止使用 @Repository 注解**
- ❌ **禁止使用 Repository 后缀命名**
- ❌ **禁止跨层访问**
- ❌ **禁止在Controller中包含业务逻辑**
- ❌ **禁止直接访问数据库**

**违规后果**: P0级问题，立即修复，禁止合并！
graph TB
    subgraph 门禁事件记录查询模块 - 专属门禁事件中心
        EventStart(门禁事件查询开始) --> EventType{选择事件类型}

        EventType -->|门禁打卡事件| AccessEvent
        EventType -->|报警异常事件| AlarmEvent
        EventType -->|综合统计分析报表| StatReport

        subgraph 门禁打卡事件查询流程
            AccessEvent --> AccessFilter[门禁事件筛选]
            AccessFilter --> AccessQuery{查询条件}
            AccessQuery -->|验证方式| VerifyTypeFilter[验证方式筛选]
            AccessQuery -->|通行结果| AccessResultFilter[通行结果筛选]
            AccessQuery -->|人员信息| PersonFilter[人员信息筛选]
            AccessQuery -->|设备位置| DeviceLocationFilter[设备位置筛选]
            AccessQuery -->|时间范围| AccessTimeFilter[时间范围筛选]
            VerifyTypeFilter --> AccessEventResult[门禁事件结果]
            AccessResultFilter --> AccessEventResult
            PersonFilter --> AccessEventResult
            DeviceLocationFilter --> AccessEventResult
            AccessTimeFilter --> AccessEventResult
            AccessEventResult --> AccessOperation{操作类型}
            AccessOperation -->|详情查看| AccessDetail[门禁事件详情]
            AccessOperation -->|照片预览| AccessPhotoPreview[通行照片预览]
            AccessOperation -->|视频预览| AccessVideoPreview[监控视频预览]
            AccessOperation -->|导出| AccessExport[导出门禁事件]
            AccessOperation -->|打印| AccessPrint[打印门禁报表]
            AccessDetail --> EventEnd[事件操作完成]
            AccessPhotoPreview --> EventEnd
            AccessVideoPreview --> EventEnd
            AccessExport --> EventEnd
            AccessPrint --> EventEnd
        end

        subgraph 报警异常事件查询流程
            AlarmEvent --> AlarmFilter[报警事件筛选]
            AlarmFilter --> AlarmQuery{查询条件}
            AlarmQuery -->|报警类型| AlarmTypeFilter[报警类型筛选]
            AlarmQuery -->|严重程度| SeverityFilter[严重程度筛选]
            AlarmQuery -->|处理状态| StatusFilter[处理状态筛选]
            AlarmQuery -->|设备区域| AlarmDeviceFilter[设备区域筛选]
            AlarmQuery -->|时间范围| AlarmTimeFilter[时间范围筛选]
            AlarmTypeFilter --> AlarmEventResult[报警事件结果]
            SeverityFilter --> AlarmEventResult
            StatusFilter --> AlarmEventResult
            AlarmDeviceFilter --> AlarmEventResult
            AlarmTimeFilter --> AlarmEventResult
            AlarmEventResult --> AlarmOperation{操作类型}
            AlarmOperation -->|详情查看| AlarmDetail[报警事件详情]
            AlarmOperation -->|现场照片| AlarmPhotoPreview[现场照片预览]
            AlarmOperation -->|处理记录| AlarmHandleRecord[处理记录查看]
            AlarmOperation -->|导出| AlarmExport[导出报警事件]
            AlarmOperation -->|打印| AlarmPrint[打印报警报表]
            AlarmDetail --> EventEnd
            AlarmPhotoPreview --> EventEnd
            AlarmHandleRecord --> EventEnd
            AlarmExport --> EventEnd
            AlarmPrint --> EventEnd
        end

        subgraph 综合统计分析报表流程
            StatReport --> StatConfig[统计配置]
            StatConfig --> StatDimension{统计维度}
            StatDimension -->|时间维度| TimeDim[时间维度统计]
            StatDimension -->|区域维度| AreaDim[区域维度统计]
            StatDimension -->|人员维度| PersonDim[人员维度统计]
            StatDimension -->|设备维度| DeviceDim[设备维度统计]
            StatDimension -->|事件类型| EventTypeDim[事件类型统计]
            TimeDim --> StatCalculate[数据统计计算]
            AreaDim --> StatCalculate
            PersonDim --> StatCalculate
            DeviceDim --> StatCalculate
            EventTypeDim --> StatCalculate
            StatCalculate --> ChartGenerate[图表生成]
            ChartGenerate --> StatOperation{统计操作}
            StatOperation -->|图表预览| ChartPreview[统计图表预览]
            StatOperation -->|数据导出| StatExport[统计数据导出]
            StatOperation -->|报表打印| StatPrint[统计报表打印]
            ChartPreview --> ReportEnd
            StatExport --> ReportEnd
            StatPrint --> ReportEnd
        end
    end

    subgraph 统一功能特性
        CommonFeatures[通用功能] --> KeywordFilter[关键字段筛选]
        CommonFeatures --> MediaPreview[照片视频预览]
        CommonFeatures --> DataExport[数据导出]
        CommonFeatures --> ReportPrint[报表打印]
        CommonFeatures --> PermissionCheck[权限验证]
        KeywordFilter --> FeatureEnd[功能完成]
        MediaPreview --> FeatureEnd
        DataExport --> FeatureEnd
        ReportPrint --> FeatureEnd
        PermissionCheck --> FeatureEnd
    end
```

## 门禁事件类型和功能说明

### 1. 门禁打卡事件查询
**数据来源**：所有门禁设备的通行验证记录
**关键字段筛选**：
- 验证方式（刷卡、人脸、指纹、密码、二维码）
- 通行结果（成功、失败、异常）
- 人员信息（姓名、工号、部门）
- 设备位置（区域、门点、设备名称）
- 时间范围（日期、时间段）
**媒体预览**：通行时的抓拍照片、监控视频片段
**功能**：通行详情查看、照片预览、视频预览、导出、打印

### 2. 报警异常事件查询
**数据来源**：门禁系统产生的所有报警和异常记录
**关键字段筛选**：
- 报警类型（非法通行、设备异常、安全告警、系统异常）
- 严重程度（低、中、高、紧急）
- 处理状态（未处理、处理中、已处理）
- 设备区域（设备编号、所属区域）
- 时间范围（报警时间、处理时间）
**媒体预览**：报警时的现场照片、相关视频片段
**功能**：报警详情查看、现场照片预览、处理记录查看、导出、打印

### 3. 综合统计分析报表
**数据来源**：门禁打卡事件和报警异常事件的汇总统计
**统计维度**：
- 时间维度（按日/周/月/年统计通行量和报警数）
- 区域维度（各区域通行统计、报警分布）
- 人员维度（人员通行频次、异常行为统计）
- 设备维度（设备使用率、故障率统计）
- 事件类型维度（各类事件占比分析）
**功能**：统计图表生成、数据导出、报表打印

## 统一功能特性

### 关键字段筛选功能
1. **多条件组合筛选**：支持多字段组合查询
2. **模糊搜索**：支持关键字模糊匹配
3. **时间范围筛选**：灵活的时间范围选择
4. **快速筛选**：常用条件快捷筛选

### 照片视频预览功能
1. **照片预览**：支持人员照片、通行照片预览
2. **视频预览**：支持监控视频片段在线预览
3. **媒体管理**：支持媒体文件下载、保存
4. **缩略图展示**：列表形式展示缩略图

### 数据导出功能
1. **多格式导出**：支持Excel、PDF、CSV格式
2. **自定义字段**：支持选择导出字段
3. **批量导出**：支持大量数据分批导出
4. **导出权限**：基于用户权限控制导出范围

### 报表打印功能
1. **报表模板**：提供标准报表模板
2. **自定义排版**：支持自定义报表排版
3. **批量打印**：支持批量打印报表
4. **打印权限**：基于用户权限控制打印范围

### 权限验证机制
1. **数据权限**：基于用户角色控制数据访问范围
2. **操作权限**：基于用户权限控制操作功能
3. **字段权限**：控制敏感字段的访问权限
4. **审计日志**：记录所有报表访问和操作日志

## 门禁事件数据来源详细说明

### 门禁打卡事件数据来源
- **门禁设备实时上传**：所有门禁控制器的通行验证记录
- **验证方式记录**：刷卡、人脸识别、指纹验证、密码输入、二维码扫描
- **通行结果记录**：验证成功、失败、异常等结果状态
- **人员信息关联**：验证人员的基本信息和权限信息
- **设备位置信息**：验证设备所在的区域和具体位置
- **时间戳记录**：精确的验证时间和处理时长

### 报警异常事件数据来源
- **非法通行报警**：无权限验证、尾随、胁迫、防拆等安全事件
- **设备异常报警**：设备离线、通讯故障、硬件损坏等设备事件
- **系统异常报警**：验证超时、数据错误、系统故障等系统事件
- **安全告警事件**：门磁异常、强制开门、重复验证等安全事件
- **处理状态跟踪**：报警事件的发现、处理、解决状态记录

### 其他业务模块事件产生
- **设备管理模块**：设备状态变更事件、维护操作事件
- **区域管理模块**：区域权限变更事件、容量异常事件
- **人员管理模块**：人员权限变更事件、异常行为事件

## 重要特性

### 专注门禁核心业务
- **门禁事件专属**：只处理门禁相关的通行和报警事件
- **实时性保证**：门禁事件实时记录和查询
- **准确性要求**：确保门禁事件记录的准确性和完整性

### 功能完整性
- **全流程支持**：从事件记录到统计分析的完整流程
- **媒体集成**：照片和视频预览功能完善
- **报表丰富**：多种维度的统计报表和分析图表

### 查询性能优化
- **大数据量支持**：支持海量门禁事件数据的高效查询
- **索引优化**：针对常用查询字段建立索引
- **缓存机制**：热点数据缓存提升查询速度
- **分页查询**：大结果集分页显示

### 安全控制
- **权限分级**：不同角色查看不同范围的事件记录
- **隐私保护**：敏感信息脱敏处理
- **审计追踪**：所有查询操作都有详细记录
- **数据加密**：重要数据传输和存储加密

### 报表功能
- **关键字段筛选**：所有报表都支持多字段组合筛选
- **照片视频预览**：支持事件相关媒体文件在线预览
- **多格式导出**：支持Excel、PDF、CSV等格式导出
- **自定义打印**：支持报表模板自定义和批量打印