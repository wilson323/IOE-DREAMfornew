# 10-补贴管理模块重构设计

## 📋 模块概述

**重构目标**：构建完整的补贴账户体系，支持灵活的补贴发放和使用规则。

**核心问题**：
- 补贴与现金账户混在一起
- 补贴发放规则不灵活
- 补贴清零策略单一
- 缺乏补贴流水追溯
- **未明确补贴在不同经营模式中的使用规则**

**重构收益**：
- ✅ 补贴与现金账户独立管理
- ✅ 灵活的发放和清零策略
- ✅ 完整的补贴流水记录
- ✅ 支持多种补贴类型
- ✅ **明确不同经营模式的补贴使用策略**

---

## 🏗️ 补贴与经营模式关系

### 核心原则

**补贴适用于所有经营模式，但使用规则有差异**：

| 经营模式 | 补贴适用性 | 使用场景 | 特殊规则 |
|---------|-----------|---------|---------|
| **餐别制<br/>(manage_mode=1)** | ✅ 全面适用 | 餐费补贴、定额补助 | 按餐次使用，可限定餐别 |
| **超市制<br/>(manage_mode=2)** | ✅ 全面适用 | 购物补贴、商品券 | 按商品使用，可限定商品类别 |
| **混合模式<br/>(manage_mode=3)** | ✅ 全面适用 | 综合补贴 | 定值+商品均可使用 |

### 补贴使用规则矩阵

| 场景 | 餐别制 | 超市制 | 混合模式 |
|------|--------|--------|---------|
| **补贴优先级** | 补贴→现金 | 补贴→现金 | 补贴→现金 |
| **限定使用** | 可限定特定餐别 | 可限定商品类别 | 可分别限定 |
| **时间限制** | 就餐时间段内 | 营业时间段内 | 根据消费方式判断 |
| **余额不足处理** | 补贴+现金混合支付 | 补贴+现金混合支付 | 支持混合支付 |

**业务示例**：
- **餐别制**：发放午餐补贴10元，仅在午餐时段使用，定值12元时补贴抵扣10元，现金支付2元
- **超市制**：发放生活用品补贴50元，仅可购买指定类别商品
- **混合模式**：发放综合补贴100元，定值消费和商品消费均可使用

---

## 🔄 业务流程设计
## 📋 IOE-DREAM七微服务架构

**核心架构组成**:
- **Gateway Service (8080)**: API网关
- **Common Service (8088)**: 公共模块微服务
- **DeviceComm Service (8087)**: 设备通讯微服务
- **OA Service (8089)**: OA微服务
- **Access Service (8090)**: 门禁服务
- **Attendance Service (8091)**: 考勤服务
- **Video Service (8092)**: 视频服务
- **Consume Service (8094)**: 消费服务
- **Visitor Service (8095)**: 访客服务

**架构特点**:
- 基于Spring Boot 3.5.8 + Java 17
- 严格遵循企业级微服务规范
- 支持高并发、高可用、水平扩展

**技术栈标准**:
- **数据库**: MySQL 8.0 + Druid连接池
- **缓存**: Redis + Caffeine多级缓存
- **注册中心**: Nacos
- **配置中心**: Nacos Config
- **认证授权**: Sa-Token

## 🏗️ 四层架构规范

**标准架构模式**:
```
Controller (接口控制层)
    ↓
Service (核心业务层)
    ↓
Manager (流程管理层)
    ↓
DAO (数据访问层)
```

**层级职责**:
- **Controller层**: HTTP请求处理、参数验证、权限控制
- **Service层**: 核心业务逻辑、事务管理、业务规则验证
- **Manager层**: 复杂流程编排、多数据组装、第三方服务集成
- **DAO层**: 数据库CRUD操作、SQL查询实现、数据访问边界

**严格禁止跨层访问**: Controller不能直接调用Manager/DAO！
### 1.1 补贴发放流程
## ⚠️ IOE-DREAM零容忍规则（强制执行）

**必须遵守的架构规则**:
- ✅ **必须使用 @Resource 注入依赖**
- ✅ **必须使用 @Mapper 注解** (禁止@Repository)
- ✅ **必须使用 Dao 后缀** (禁止Repository)
- ✅ **必须使用 @RestController 注解**
- ✅ **必须使用 @Valid 参数校验**
- ✅ **必须返回统一ResponseDTO格式**
- ✅ **必须遵循四层架构边界**

**严格禁止事项**:
- ❌ **禁止使用 @Autowired 注入**
- ❌ **禁止使用 @Repository 注解**
- ❌ **禁止使用 Repository 后缀命名**
- ❌ **禁止跨层访问**
- ❌ **禁止在Controller中包含业务逻辑**
- ❌ **禁止直接访问数据库**

**违规后果**: P0级问题，立即修复，禁止合并！

```mermaid
flowchart TD
    A[发起补贴发放] --> B{发放方式}
    
    B -->|按人员| C1[选择人员]
    B -->|按部门| C2[选择部门]
    B -->|按卡类| C3[选择账户类别]
    B -->|批量导入| C4[上传Excel]
    
    C1 --> D[设置发放规则]
    C2 --> D
    C3 --> D
    C4 --> D
    
    D --> E[补贴金额]
    E --> F[补贴类型]
    F --> G[有效期]
    G --> H[使用范围]
    
    H --> I{审批流程}
    I -->|需要审批| J[提交审批]
    I -->|无需审批| K[直接发放]
    
    J --> L{审批结果}
    L -->|通过| K
    L -->|拒绝| M[发放失败]
    
    K --> N[计算发放明细]
    N --> O[批量创建补贴账户]
    O --> P[生成补贴流水]
    P --> Q[发送通知]
    Q --> R[发放完成]
    
    style M fill:#ff6b6b
    style R fill:#51cf66
```

### 1.2 补贴消费扣款顺序

```mermaid
flowchart TD
    A[用户消费] --> B[获取账户信息]
    B --> C[查询可用补贴]
    
    C --> D{有可用补贴?}
    D -->|否| E[扣现金钱包]
    D -->|是| F[补贴排序]
    
    F --> G[按优先级排序]
    G --> H[优先级高的先扣]
    
    H --> I{补贴1-优先扣餐补}
    I --> J{余额充足?}
    J -->|是| K[扣补贴1]
    J -->|否| L[扣部分补贴1]
    
    K --> M[消费完成]
    L --> N{补贴2-其他补贴}
    N --> O{余额充足?}
    O -->|是| P[扣补贴2]
    O -->|否| Q[扣部分补贴2]
    
    P --> M
    Q --> R[继续下一个补贴]
    R --> S{还有补贴?}
    S -->|是| N
    S -->|否| E
    
    E --> T{现金充足?}
    T -->|是| U[扣现金]
    T -->|否| V[余额不足]
    
    U --> M
    
    style V fill:#ff6b6b
    style M fill:#51cf66
```

### 1.3 补贴清零流程

```mermaid
flowchart TD
    A[定时任务触发] --> B[扫描补贴账户]
    B --> C{清零策略}
    
    C -->|按月清零| D1[检查月末]
    C -->|按季清零| D2[检查季末]
    C -->|按年清零| D3[检查年末]
    C -->|到期清零| D4[检查有效期]
    
    D1 --> E{达到清零时间?}
    D2 --> E
    D3 --> E
    D4 --> E
    
    E -->|否| F[继续下一条]
    E -->|是| G[记录清零前余额]
    
    G --> H[生成清零流水]
    H --> I[补贴账户余额清零]
    I --> J[发送清零通知]
    J --> K[记录清零日志]
    K --> F
    
    F --> L{还有数据?}
    L -->|是| C
    L -->|否| M[清零完成]
    
    style M fill:#51cf66
```

### 1.4 补贴转移/退回流程

```mermaid
flowchart TD
    A[补贴转移申请] --> B{转移类型}
    
    B -->|补贴转现金| C1[检查转移规则]
    B -->|补贴退回| C2[检查退回条件]
    B -->|补贴转账| C3[检查目标账户]
    
    C1 --> D{允许转换?}
    C2 --> E{允许退回?}
    C3 --> F{目标有效?}
    
    D -->|否| G[拒绝转移]
    E -->|否| G
    F -->|否| G
    
    D -->|是| H[扣除源账户补贴]
    E -->|是| I[扣除账户补贴]
    F -->|是| J[扣除源账户补贴]
    
    H --> K[增加现金余额]
    I --> L[退回发放账户]
    J --> M[增加目标账户补贴]
    
    K --> N[生成转移流水]
    L --> N
    M --> N
    
    N --> O[发送通知]
    O --> P[转移完成]
    
    style G fill:#ff6b6b
    style P fill:#51cf66
```

---

## 🗄️ 数据库设计

### 2.1 ER关系图

```mermaid
erDiagram
    POSID_ACCOUNT ||--o{ POSID_SUBSIDY_ACCOUNT : "拥有补贴账户"
    POSID_SUBSIDY_TYPE ||--o{ POSID_SUBSIDY_ACCOUNT : "补贴类型"
    POSID_SUBSIDY_ACCOUNT ||--o{ POSID_SUBSIDY_FLOW : "补贴流水"
    POSID_SUBSIDY_GRANT ||--o{ POSID_SUBSIDY_GRANT_DETAIL : "发放明细"
    POSID_SUBSIDY_GRANT_DETAIL }o--|| POSID_ACCOUNT : "发放对象"
    
    POSID_SUBSIDY_TYPE {
        VARCHAR id PK "补贴类型ID"
        VARCHAR code UK "类型编码"
        VARCHAR name "类型名称"
        INT priority "使用优先级"
        VARCHAR clear_strategy "清零策略"
        INT validity_days "有效期天数"
        BOOLEAN allow_transfer "允许转换"
        BOOLEAN allow_refund "允许退回"
        JSON use_scope "使用范围"
    }
    
    POSID_SUBSIDY_ACCOUNT {
        VARCHAR id PK "补贴账户ID"
        VARCHAR account_id FK "关联账户"
        VARCHAR subsidy_type_id FK "补贴类型"
        INT balance "补贴余额"
        DATE expire_date "过期日期"
        VARCHAR status "状态"
        DATETIME create_time "创建时间"
    }
    
    POSID_SUBSIDY_GRANT {
        VARCHAR id PK "发放批次ID"
        VARCHAR grant_no UK "发放单号"
        VARCHAR subsidy_type_id FK "补贴类型"
        VARCHAR grant_mode "发放方式"
        INT total_money "发放总金额"
        INT total_count "发放人数"
        VARCHAR audit_status "审批状态"
        DATETIME grant_time "发放时间"
    }
    
    POSID_SUBSIDY_GRANT_DETAIL {
        VARCHAR id PK "发放明细ID"
        VARCHAR grant_id FK "发放批次"
        VARCHAR account_id FK "账户"
        INT grant_money "发放金额"
        VARCHAR status "状态"
        DATETIME create_time "创建时间"
    }
    
    POSID_SUBSIDY_FLOW {
        VARCHAR id PK "流水ID"
        VARCHAR subsidy_account_id FK "补贴账户"
        VARCHAR flow_type "流水类型"
        INT money "金额"
        INT balance_before "操作前余额"
        INT balance_after "操作后余额"
        VARCHAR business_id "业务ID"
        DATETIME create_time "创建时间"
    }
```

### 2.2 补贴账户体系

```mermaid
graph TB
    subgraph 账户总览
        A[用户账户POSID_ACCOUNT]
    end
    
    subgraph 现金账户
        B[现金余额\nbalance]
    end
    
    subgraph 补贴账户体系
        C1[餐补账户\n优先级1]
        C2[交通补贴\n优先级2]
        C3[通用补贴\n优先级3]
        C4[其他补贴\n优先级N]
    end
    
    A --> B
    A --> C1
    A --> C2
    A --> C3
    A --> C4
    
    style A fill:#4ecdc4
    style B fill:#95e1d3
    style C1 fill:#ff6b6b
    style C2 fill:#ffd93d
    style C3 fill:#74b9ff
    style C4 fill:#a29bfe
```

### 2.3 补贴类型配置示例

```mermaid
mindmap
  root((补贴类型))
    餐补
      按月发放
      月末清零
      只能食堂使用
      不可转现金
      优先级1
    交通补贴
      按月发放
      不清零累积
      指定区域使用
      可转现金
      优先级2
    通用补贴
      一次性发放
      按年清零
      全区域使用
      可转现金
      优先级3
    节日补贴
      临时发放
      60天有效期
      全区域使用
      可退回
      优先级4
```

---

## 💾 缓存策略设计

### 3.1 核心缓存

| 缓存项 | Redis Key | 过期时间 | 说明 |
|-------|-----------|---------|------|
| 账户补贴列表 | `subsidy:list:{accountId}` | 10分钟 | 该账户所有补贴 |
| 可用补贴余额 | `subsidy:available:{accountId}` | 实时更新 | 可用补贴总额 |
| 补贴类型配置 | `subsidy:type:{typeId}` | 1小时 | 补贴类型规则 |
| 发放批次锁 | `lock:subsidy:grant:{batchId}` | 5分钟 | 防重复发放 |

---

## 📊 监控指标

### 4.1 核心指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 补贴发放总额 | 每日发放补贴金额 | 异常波动>50% |
| 补贴使用率 | 已用/已发 | < 60%（浪费） |
| 补贴清零金额 | 每月清零金额 | > 总发放10% |
| 补贴转换率 | 转现金/总补贴 | > 30%（规则问题） |

### 4.2 业务报表

- **补贴发放统计**：按类型、部门、时间统计发放情况
- **补贴使用分析**：使用率、消费场景分布
- **补贴清零报告**：清零金额、清零原因分析
- **补贴余额预警**：即将过期补贴提醒

---

## 🎯 总结

### 关键设计

✅ **多补贴账户**：一个账户可有多个补贴，按优先级扣款  
✅ **灵活发放**：支持按人员/部门/卡类/导入多种方式  
✅ **智能清零**：月清/季清/年清/到期清零多种策略  
✅ **流水追溯**：每笔补贴变动都有流水记录  
✅ **使用限制**：按区域/餐别/时间段限制使用范围

### 支持场景

- 🎓 **校园**：学生餐补月初发放，月末清零
- 🏥 **医院**：医护交通补贴按季发放，可累积
- 🏢 **企业**：员工福利补贴按年发放，全年有效
- 🏭 **工厂**：夜班补贴临时发放，60天有效期

---

## 📝 更新说明

### v2.0 (2025-10-31)
- ✅ 新增"补贴与经营模式关系"章节
- ✅ 明确不同经营模式的补贴使用规则和特殊规则
- ✅ 补充业务示例

---

**文档版本**：v2.0  
**创建时间**：2025-10-31  
**适用版本**：POSID v3.13.1+

