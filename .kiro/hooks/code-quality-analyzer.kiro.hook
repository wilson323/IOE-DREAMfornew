# IOE-DREAM ä»£ç è´¨é‡åˆ†æHook
# ç¡®ä¿æ‰€æœ‰æäº¤çš„ä»£ç ç¬¦åˆé¡¹ç›®ç»Ÿä¸€è§„èŒƒ

hook {
  name: "ä»£ç è´¨é‡åˆ†æå™¨"
  description: "ç³»ç»ŸåŒ–æ£€æŸ¥ä»£ç è´¨é‡ã€è§„èŒƒç¬¦åˆæ€§å’Œä¾èµ–é—®é¢˜"
  priority: "P0"

  # è§¦å‘æ¡ä»¶
  triggers {
    file_patterns {
      # Javaæ–‡ä»¶å˜æ›´
      include: ["**/*.java"]
      # Mavené…ç½®æ–‡ä»¶å˜æ›´
      include: ["**/pom.xml", "**/.m2/**"]
      # æŠ€èƒ½æ–‡æ¡£å˜æ›´
      include: [".claude/skills/*.md"]
      # æ ¸å¿ƒé…ç½®æ–‡ä»¶å˜æ›´
      include: ["CLAUDE.md", "application*.yml"]
    }
  }

  # æ‰§è¡Œé˜¶æ®µ
  stages {
    stage1: {
      name: "è¯­æ³•å’Œç¼–è¯‘æ£€æŸ¥"
      commands: [
        "echo \"ğŸ” Stage 1: è¯­æ³•å’Œç¼–è¯‘æ£€æŸ¥\"",
        "mvn clean compile -q",
        "if [ $? -ne 0 ]; then",
        "  echo \"âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç è¯­æ³•é”™è¯¯\"",
        "  exit 1",
        "fi",
        "echo \"âœ… ç¼–è¯‘æ£€æŸ¥é€šè¿‡\""
      ]
    }

    stage2: {
      name: "ä»£ç è§„èŒƒæ£€æŸ¥"
      commands: [
        "echo \"ğŸ“ Stage 2: ä»£ç è§„èŒƒæ£€æŸ¥\"",
        "# æ£€æŸ¥@Autowiredè¿è§„ä½¿ç”¨",
        "echo \"æ£€æŸ¥@Autowiredè¿è§„ä½¿ç”¨...\"",
        "AUTOWIRED_COUNT=$(git diff --cached --name-only | xargs grep -l '@Autowired' 2>/dev/null | wc -l || echo 0)",
        "if [ \"$AUTOWIRED_COUNT\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°@Autowiredè¿è§„ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨@Resourceæ›¿ä»£\"",
        "  git diff --cached --name-only | xargs grep -H '@Autowired' || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥@Repositoryè¿è§„ä½¿ç”¨",
        "echo \"æ£€æŸ¥@Repositoryè¿è§„ä½¿ç”¨...\"",
        "REPOSITORY_COUNT=$(git diff --cached --name-only | xargs grep -l '@Repository' 2>/dev/null | wc -l || echo 0)",
        "if [ \"$REPOSITORY_COUNT\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°@Repositoryè¿è§„ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨@Mapperæ›¿ä»£\"",
        "  git diff --cached --name-only | xargs grep -H '@Repository' || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥JPAæ³¨è§£è¿è§„ä½¿ç”¨",
        "echo \"æ£€æŸ¥JPAæ³¨è§£è¿è§„ä½¿ç”¨...\"",
        "JPA_VIOLATIONS=$(git diff --cached --name-only | xargs grep -l 'jakarta\.persistence\.' 2>/dev/null | wc -l || echo 0)",
        "if [ \"$JPA_VIOLATIONS\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°JPAæ³¨è§£è¿è§„ä½¿ç”¨ï¼Œé¡¹ç›®å·²è¿ç§»åˆ°MyBatis-Plus\"",
        "  git diff --cached --name-only | xargs grep -H 'jakarta\.persistence\.' || true",
        "  exit 1",
        "fi",
        "",
        "echo \"âœ… ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡\""
      ]
    }

    stage3: {
      name: "ä¾èµ–æ¶æ„æ£€æŸ¥"
      commands: [
        "echo \"ğŸ—ï¸ Stage 3: ä¾èµ–æ¶æ„æ£€æŸ¥\"",
        "# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç¦ç”¨çš„microservices-commonèšåˆä¾èµ–",
        "echo \"æ£€æŸ¥èšåˆä¾èµ–è¿è§„...\"",
        "VIOLATION_COUNT=$(find . -name \"pom.xml\" -exec grep -l \"microservices-common\" {} \; | wc -l || echo 0)",
        "if [ \"$VIOLATION_COUNT\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°microservices-commonèšåˆä¾èµ–è¿è§„ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨ç»†ç²’åº¦æ¨¡å—ä¾èµ–\"",
        "  find . -name \"pom.xml\" -exec grep -H \"microservices-common\" {} + || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥å¾ªç¯ä¾èµ–",
        "echo \"æ£€æŸ¥æ½œåœ¨çš„å¾ªç¯ä¾èµ–...\"",
        "CYCLE_RISK=$(git diff --cached --name-only | grep -E 'ioedream-.*-service' | head -5 | wc -l || echo 0)",
        "if [ \"$CYCLE_RISK\" -gt 1 ]; then",
        "  echo \"âš ï¸ æ£€æµ‹åˆ°å¤šä¸ªå¾®æœåŠ¡å˜æ›´ï¼Œè¯·æ³¨æ„æ£€æŸ¥å¾ªç¯ä¾èµ–é£é™©\"",
        "  git diff --cached --name-only | grep -E 'ioedream-.*-service' || true",
        "fi",
        "",
        "echo \"âœ… ä¾èµ–æ¶æ„æ£€æŸ¥é€šè¿‡\""
      ]
    }

    stage4: {
      name: "æŠ€èƒ½æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥"
      commands: [
        "echo \"ğŸ“š Stage 4: æŠ€èƒ½æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥\"",
        "# æ£€æŸ¥æŠ€èƒ½æ–‡æ¡£ä¸­çš„æŠ€æœ¯æ ˆä¸€è‡´æ€§",
        "echo \"æ£€æŸ¥æŠ€èƒ½æ–‡æ¡£æŠ€æœ¯æ ˆä¸€è‡´æ€§...\"",
        "TECH_STACK_VIOLATIONS=$(find .claude/skills -name \"*.md\" -exec grep -l \"javax\.persistence\.Entity\" {} \; 2>/dev/null | wc -l || echo 0)",
        "if [ \"$TECH_STACK_VIOLATIONS\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°æŠ€èƒ½æ–‡æ¡£ä¸­çš„æŠ€æœ¯æ ˆè¿è§„ï¼Œéœ€è¦æ›´æ–°ä¸ºMyBatis-Plusæ³¨è§£\"",
        "  find .claude/skills -name \"*.md\" -exec grep -H \"javax\.persistence\.Entity\" {} + 2>/dev/null || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥æŠ€èƒ½æ–‡æ¡£ç‰ˆæœ¬å·ä¸€è‡´æ€§",
        "echo \"æ£€æŸ¥æŠ€èƒ½æ–‡æ¡£ç‰ˆæœ¬å·ä¸€è‡´æ€§...\"",
        "VERSION_VIOLATIONS=$(find .claude/skills -name \"*.md\" -exec grep -l \"Spring Boot 3.5.8\" {} \; | wc -l || echo 0)",
        "REQUIRED_COUNT=$(find .claude/skills -name \"*.md\" | wc -l)",
        "if [ \"$VERSION_VIOLATIONS\" -lt \"$REQUIRED_COUNT\" ]; then",
        "  echo \"âš ï¸ éƒ¨åˆ†æŠ€èƒ½æ–‡æ¡£ç¼ºå°‘Spring Boot 3.5.8ç‰ˆæœ¬å£°æ˜ï¼Œå»ºè®®æ·»åŠ \"",
        "fi",
        "",
        "echo \"âœ… æŠ€èƒ½æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡\""
      ]
    }

    stage5: {
      name: "æ ¼å¼å’Œè´¨é‡æ£€æŸ¥"
      commands: [
        "echo \"ğŸ¨ Stage 5: æ ¼å¼å’Œè´¨é‡æ£€æŸ¥\"",
        "# æ£€æŸ¥æ–‡ä»¶ç¼–ç ï¼ˆæ— BOMï¼‰",
        "echo \"æ£€æŸ¥æ–‡ä»¶ç¼–ç ...\"",
        "BOM_FILES=$(find . -name \"*.java\" -exec file {} \; | grep -c \"UTF-8 Unicode (with BOM)\" || echo 0)",
        "if [ \"$BOM_FILES\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°UTF-8 BOMæ–‡ä»¶ï¼Œè¯·ç§»é™¤BOMå­—ç¬¦\"",
        "  find . -name \"*.java\" -exec file {} \; | grep \"UTF-8 Unicode (with BOM)\" || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥åŒ…åè§„èŒƒ",
        "echo \"æ£€æŸ¥åŒ…åè§„èŒƒ...\"",
        "PACKAGE_VIOLATIONS=$(find . -name \"*.java\" -exec grep -l \"^package.*\.\.\.\" {} \; 2>/dev/null | wc -l || echo 0)",
        "if [ \"$PACKAGE_VIOLATIONS\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°åŒ…åä¸è§„èŒƒï¼Œç¦æ­¢ä»¥comå¼€å¤´\"",
        "  find . -name \"*.java\" -exec grep -H \"^package.*\.\.\.\" {} + 2>/dev/null || true",
        "  exit 1",
        "fi",
        "",
        "echo \"âœ… æ ¼å¼å’Œè´¨é‡æ£€æŸ¥é€šè¿‡\""
      ]
    }
  }

  # æˆåŠŸæ¶ˆæ¯
  success {
    message: "âœ… ä»£ç è´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼ğŸ‰"
    details: [
      "- ç¼–è¯‘æ£€æŸ¥: é€šè¿‡",
      "- ä»£ç è§„èŒƒ: æ— @Autowiredã€@Repositoryã€JPAè¿è§„",
      "- ä¾èµ–æ¶æ„: æ— èšåˆä¾èµ–è¿è§„",
      "- æŠ€èƒ½æ–‡æ¡£: æŠ€æœ¯æ ˆä¸€è‡´",
      "- æ ¼å¼è´¨é‡: æ— BOMã€åŒ…åè§„èŒƒ"
    ]
  }

  # å¤±è´¥æ¶ˆæ¯å’Œå»ºè®®
  failure {
    message: "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤åé‡è¯•"
    suggestions: [
      "1. ä½¿ç”¨@Resourceæ›¿ä»£@Autowired",
      "2. ä½¿ç”¨@Mapperæ›¿ä»£@Repository",
      "3. ä½¿ç”¨MyBatis-Plusæ³¨è§£æ›¿ä»£JPAæ³¨è§£",
      "4. ä½¿ç”¨ç»†ç²’åº¦æ¨¡å—ä¾èµ–æ›¿ä»£microservices-common",
      "5. ä½¿ç”¨/call-skills global-dependency-managerè¿›è¡Œä¾èµ–åˆ†æ",
      "6. ä½¿ç”¨/call-skills compilation-error-fixerè¿›è¡Œç¼–è¯‘å¼‚å¸¸ä¿®å¤"
    ]
    blocking: true
  }

  # ä¾‹å¤–æƒ…å†µï¼ˆå…è®¸ç‰¹å®šåœºæ™¯è·³è¿‡éƒ¨åˆ†æ£€æŸ¥ï¼‰
  exceptions {
    scenarios: [
      {
        condition: "æ–‡ä»¶åŒ…å«migrationå…³é”®å­—",
        patterns: ["*migration*", "*migrate*"],
        allowed_checks: ["syntax", "format"],
        reason: "è¿ç§»æ–‡ä»¶å¯èƒ½ä¸´æ—¶åŒ…å«æ—§æ³¨è§£"
      },
      {
        condition: "æµ‹è¯•æ–‡ä»¶æˆ–ç¤ºä¾‹ä»£ç ",
        patterns: ["*Test.java", "*Example.java", "*example*"],
        allowed_checks: ["syntax"],
        reason: "æµ‹è¯•æ–‡ä»¶å¯èƒ½æœ‰ç‰¹æ®Šæµ‹è¯•éœ€æ±‚"
      }
    ]
  }

  # è¾“å‡ºé…ç½®
  output {
    verbose: true
    color: true
    log_file: ".kiro/logs/code-quality-$(date +%Y%m%d-%H%M%S).log"
    metrics: true
  }
}
