# IOE-DREAM Mavenæ„å»ºè´¨é‡Hook
# åœ¨Mavenæ„å»ºé˜¶æ®µè¿›è¡Œç³»ç»Ÿæ€§è´¨é‡æ£€æŸ¥

hook {
  name: "Mavenæ„å»ºè´¨é‡æ£€æŸ¥å™¨"
  description: "åœ¨Mavenæ„å»ºè¿‡ç¨‹ä¸­æ‰§è¡Œå…¨é¢çš„è´¨é‡é—¨ç¦æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç ç¬¦åˆä¼ä¸šçº§æ ‡å‡†"
  priority: "P0"

  # è§¦å‘æ¡ä»¶
  triggers {
    build_phases {
      phases: ["compile", "test", "package", "install"]
      maven_goals: ["clean", "compile", "test", "package", "install", "verify"]
    }

    file_patterns {
      # Mavené…ç½®æ–‡ä»¶å˜æ›´
      include: ["**/pom.xml"]
      # Javaä»£ç å˜æ›´
      include: ["**/*.java"]
      # æµ‹è¯•æ–‡ä»¶å˜æ›´
      include: ["**/*Test.java", "**/*Tests.java"]
      # èµ„æºæ–‡ä»¶å˜æ›´
      include: ["**/src/main/resources/**"]
    }
  }

  # æ‰§è¡Œé˜¶æ®µ
  stages {
    pre-compile: {
      name: "é¢„ç¼–è¯‘è´¨é‡æ£€æŸ¥"
      commands: [
        "echo \"ğŸ” Pre-Compile: è´¨é‡é¢„æ£€æŸ¥\"",
        "",
        "# æ£€æŸ¥Javaæ–‡ä»¶ç¼–ç ï¼ˆæ— BOMï¼‰",
        "echo \"æ£€æŸ¥æ–‡ä»¶ç¼–ç æ ¼å¼...\"",
        "BOM_FILES=$(find . -name \"*.java\" -exec file {} \\; | grep -c \"UTF-8 Unicode (with BOM)\" || echo 0)",
        "if [ \"$BOM_FILES\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°UTF-8 BOMæ–‡ä»¶ï¼Œè¯·ç§»é™¤BOMå­—ç¬¦\"",
        "  find . -name \"*.java\" -exec file {} \\; | grep \"UTF-8 Unicode (with BOM)\" || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥åŒ…åè§„èŒƒ",
        "echo \"æ£€æŸ¥åŒ…åè§„èŒƒ...\"",
        "PACKAGE_VIOLATIONS=$(find . -name \"*.java\" -exec grep -l \"^package.*com\\.\" {} \\; 2>/dev/null | wc -l || echo 0)",
        "if [ \"$PACKAGE_VIOLATIONS\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°åŒ…åä»¥comå¼€å¤´ï¼Œåº”ä½¿ç”¨net.lab1024.sa\"",
        "  find . -name \"*.java\" -exec grep -H \"^package.*com\\.\" {} + 2>/dev/null || true",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥æ³¨è§£è¿è§„ä½¿ç”¨",
        "echo \"æ£€æŸ¥æ³¨è§£è¿è§„ä½¿ç”¨...\"",
        "AUTOWIRED_COUNT=$(find . -name \"*.java\" -exec grep -l \"@Autowired\" {} \\; 2>/dev/null | wc -l || echo 0)",
        "if [ \"$AUTOWIRED_COUNT\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°@Autowiredè¿è§„ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨@Resourceæ›¿ä»£\"",
        "  echo \"è¿è§„æ–‡ä»¶æ•°é‡: $AUTOWIRED_COUNT\"",
        "  exit 1",
        "fi",
        "",
        "REPOSITORY_COUNT=$(find . -name \"*.java\" -exec grep -l \"@Repository\" {} \\; 2>/dev/null | wc -l || echo 0)",
        "if [ \"$REPOSITORY_COUNT\" -gt 0 ]; then",
        "  echo \"âŒ å‘ç°@Repositoryè¿è§„ä½¿ç”¨ï¼Œå¿…é¡»ä½¿ç”¨@Mapperæ›¿ä»£\"",
        "  echo \"è¿è§„æ–‡ä»¶æ•°é‡: $REPOSITORY_COUNT\"",
        "  exit 1",
        "fi",
        "",
        "echo \"âœ… Pre-Compileè´¨é‡æ£€æŸ¥é€šè¿‡\""
      ]
    }

    compile: {
      name: "ç¼–è¯‘é˜¶æ®µè´¨é‡æ£€æŸ¥"
      commands: [
        "echo \"ğŸ”¨ Compile: ç¼–è¯‘è´¨é‡æ£€æŸ¥\"",
        "",
        "# æ‰§è¡ŒMavenç¼–è¯‘",
        "echo \"æ‰§è¡ŒMavenç¼–è¯‘...\"",
        "mvn clean compile -q",
        "COMPILE_RESULT=$?",
        "",
        "if [ $COMPILE_RESULT -ne 0 ]; then",
        "  echo \"âŒ Mavenç¼–è¯‘å¤±è´¥\"",
        "  echo \"è¯·æ£€æŸ¥ï¼š\"",
        "  echo \"1. ä¾èµ–æ˜¯å¦æ­£ç¡®é…ç½®\"",
        "  echo \"2. Javaè¯­æ³•æ˜¯å¦æ­£ç¡®\"",
        "  echo \"3. ç±»è·¯å¾„æ˜¯å¦å®Œæ•´\"",
        "  echo \"4. ä½¿ç”¨/call-skills compilation-error-fixerè¿›è¡Œç¼–è¯‘å¼‚å¸¸ä¿®å¤\"",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥ç¼–è¯‘äº§ç‰©",
        "echo \"æ£€æŸ¥ç¼–è¯‘äº§ç‰©...\"",
        "if [ ! -d \"target\" ]; then",
        "  echo \"âŒ æœªæ‰¾åˆ°targetç›®å½•ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥\"",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥classæ–‡ä»¶æ•°é‡",
        "CLASS_COUNT=$(find target -name \"*.class\" 2>/dev/null | wc -l || echo 0)",
        "echo \"ç¼–è¯‘ç”Ÿæˆclassæ–‡ä»¶æ•°é‡: $CLASS_COUNT\"",
        "if [ \"$CLASS_COUNT\" -eq 0 ]; then",
        "  echo \"âš ï¸ è­¦å‘Šï¼šæœªç”Ÿæˆclassæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ç¼–è¯‘é…ç½®\"",
        "fi",
        "",
        "echo \"âœ… Compileç¼–è¯‘è´¨é‡æ£€æŸ¥é€šè¿‡\""
      ]
    }

    test: {
      name: "æµ‹è¯•é˜¶æ®µè´¨é‡æ£€æŸ¥"
      commands: [
        "echo \"ğŸ§ª Test: æµ‹è¯•è´¨é‡æ£€æŸ¥\"",
        "",
        "# æ‰§è¡Œå•å…ƒæµ‹è¯•",
        "echo \"æ‰§è¡Œå•å…ƒæµ‹è¯•...\"",
        "mvn test -q",
        "TEST_RESULT=$?",
        "",
        "if [ $TEST_RESULT -ne 0 ]; then",
        "  echo \"âŒ å•å…ƒæµ‹è¯•å¤±è´¥\"",
        "  echo \"è¯·æ£€æŸ¥ï¼š\"",
        "  echo \"1. æµ‹è¯•ç”¨ä¾‹æ˜¯å¦æ­£ç¡®ç¼–å†™\"",
        "  echo \"2. æµ‹è¯•æ•°æ®æ˜¯å¦å®Œæ•´\"",
        "  echo \"3. æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­£ç¡®é…ç½®\"",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡",
        "echo \"æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡...\"",
        "if command -v mvn >/dev/null 2>&1; then",
        "  # å¦‚æœæœ‰JaCoCoæ’ä»¶ï¼Œæ£€æŸ¥è¦†ç›–ç‡æŠ¥å‘Š",
        "  if grep -q \"jacoco-maven-plugin\" pom.xml 2>/dev/null; then",
        "    echo \"ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š...\"",
        "    mvn jacoco:report -q",
        "    if [ -f \"target/site/jacoco/index.html\" ]; then",
        "      echo \"âœ… æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ\"",
        "    fi",
        "  fi",
        "fi",
        "",
        "# æ£€æŸ¥æµ‹è¯•ç»“æœæ–‡ä»¶",
        "if [ -d \"target/surefire-reports\" ]; then",
        "  TEST_REPORTS=$(find target/surefire-reports -name \"*.xml\" 2>/dev/null | wc -l || echo 0)",
        "  echo \"æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶æ•°é‡: $TEST_REPORTS\"",
        "fi",
        "",
        "echo \"âœ… Testæµ‹è¯•è´¨é‡æ£€æŸ¥é€šè¿‡\""
      ]
    }

    package: {
      name: "æ‰“åŒ…é˜¶æ®µè´¨é‡æ£€æŸ¥"
      commands: [
        "echo "ğŸ“¦ Package: æ‰“åŒ…è´¨é‡æ£€æŸ¥\"",
        "",
        "# æ‰§è¡ŒMavenæ‰“åŒ…",
        "echo \"æ‰§è¡ŒMavenæ‰“åŒ…...\"",
        "mvn package -DskipTests -q",
        "PACKAGE_RESULT=$?",
        "",
        "if [ $PACKAGE_RESULT -ne 0 ]; then",
        "  echo \"âŒ Mavenæ‰“åŒ…å¤±è´¥\"",
        "  echo \"è¯·æ£€æŸ¥ï¼š\"",
        "  echo \"1. èµ„æºæ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®",
        "  echo \"2. æ‰“åŒ…é…ç½®æ˜¯å¦æ­£ç¡®",
        "  echo \"3. ä¾èµ–æ˜¯å¦å®Œæ•´",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥æ‰“åŒ…äº§ç‰©",
        "echo \"æ£€æŸ¥æ‰“åŒ…äº§ç‰©...\"",
        "JAR_COUNT=$(find target -name \"*.jar\" 2>/dev/null | wc -l || echo 0)",
        "echo \"ç”ŸæˆJARæ–‡ä»¶æ•°é‡: $JAR_COUNT\"",
        "",
        "if [ \"$JAR_COUNT\" -eq 0 ]; then",
        "  echo \"âŒ æœªç”ŸæˆJARæ–‡ä»¶ï¼Œæ‰“åŒ…å¤±è´¥\"",
        "  exit 1",
        "fi",
        "",
        "# æ£€æŸ¥JARæ–‡ä»¶å¤§å°",
        "for jar in target/*.jar; do",
        "  if [ -f \"$jar\" ]; then",
        "    SIZE=$(stat -c%s \"$jar\" 2>/dev/null || stat -f%z \"$jar\" 2>/dev/null || echo 0)",
        "    echo \"JARæ–‡ä»¶: $(basename $jar), å¤§å°: $SIZE bytes\"",
        "    if [ \"$SIZE\" -lt 1000 ]; then",
        "      echo \"âš ï¸ è­¦å‘Šï¼šJARæ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½æ‰“åŒ…ä¸å®Œæ•´\"",
        "    fi",
        "  fi",
        "done",
        "",
        "echo \"âœ… Packageæ‰“åŒ…è´¨é‡æ£€æŸ¥é€šè¿‡\""
      ]
    }

    install: {
      name: "å®‰è£…é˜¶æ®µè´¨é‡æ£€æŸ¥"
      commands: [
        "echo "ğŸ—ï¸ Install: å®‰è£…è´¨é‡æ£€æŸ¥\"",
        "",
        "# æ‰§è¡ŒMavenå®‰è£…åˆ°æœ¬åœ°ä»“åº“",
        "echo \"æ‰§è¡ŒMavenå®‰è£…...\"",
        "mvn install -DskipTests -q",
        "INSTALL_RESULT=$?",
        "",
        "if [ $INSTALL_RESULT -ne 0 ]; then",
        "  echo \"âŒ Mavenå®‰è£…å¤±è´¥\"",
        "  echo \"è¯·æ£€æŸ¥ï¼š\"",
        "  echo \"1. æœ¬åœ°Mavenä»“åº“æƒé™\",
        "  echo \"2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\",
        "  echo \"3. Mavené…ç½®æ˜¯å¦æ­£ç¡®\",
        "  exit 1",
        "fi",
        "",
        "# éªŒè¯å®‰è£…ç»“æœ",
        "echo \"éªŒè¯æœ¬åœ°ä»“åº“å®‰è£…...\"",
        "if [ -f \"pom.xml\" ]; then",
        "  # è·å–artifactä¿¡æ¯",
        "  GROUP_ID=$(grep -o '<groupId>[^<]*' pom.xml | head -1 | sed 's/<groupId>//' 2>/dev/null || echo \"\")",
        "  ARTIFACT_ID=$(grep -o '<artifactId>[^<]*' pom.xml | head -1 | sed 's/<artifactId>//' 2>/dev/null || echo \"\")",
        "  VERSION=$(grep -o '<version>[^<]*' pom.xml | head -1 | sed 's/<version>//' 2>/dev/null || echo \"\")",
        "  ",
        "  if [ ! -z \"$GROUP_ID\" ] && [ ! -z \"$ARTIFACT_ID\" ] && [ ! -z \"$VERSION\" ]; then",
        "    LOCAL_JAR_PATH=\"$HOME/.m2/repository/${GROUP_ID//./}/$ARTIFACT_ID/$VERSION/$ARTIFACT_ID-$VERSION.jar\"",
        "    if [ -f \"$LOCAL_JAR_PATH\" ]; then",
        "      echo \"âœ… JARæ–‡ä»¶å·²æˆåŠŸå®‰è£…åˆ°æœ¬åœ°ä»“åº“\"",
        "      echo \"è·¯å¾„: $LOCAL_JAR_PATH\"",
        "    else",
        "      echo \"âŒ JARæ–‡ä»¶æœªåœ¨æœ¬åœ°ä»“åº“ä¸­æ‰¾åˆ°\"",
        "      echo \"é¢„æœŸè·¯å¾„: $LOCAL_JAR_PATH\"",
        "    fi",
        "  fi",
        "fi",
        "",
        "echo \"âœ… Installå®‰è£…è´¨é‡æ£€æŸ¥é€šè¿‡\""
      ]
    }
  }

  # æˆåŠŸæ¶ˆæ¯
  success {
    message: "âœ… Mavenæ„å»ºè´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼ğŸš€"
    details: [
      "- é¢„ç¼–è¯‘æ£€æŸ¥: ç¼–ç è§„èŒƒã€åŒ…åè§„èŒƒã€æ³¨è§£åˆè§„",
      "- ç¼–è¯‘æ£€æŸ¥: Mavenç¼–è¯‘æˆåŠŸã€äº§ç‰©å®Œæ•´",
      "- æµ‹è¯•æ£€æŸ¥: å•å…ƒæµ‹è¯•é€šè¿‡ã€è¦†ç›–ç‡è¾¾æ ‡",
      "- æ‰“åŒ…æ£€æŸ¥: JARæ–‡ä»¶ç”Ÿæˆã€å¤§å°æ­£å¸¸",
      "- å®‰è£…æ£€æŸ¥: æœ¬åœ°ä»“åº“å®‰è£…æˆåŠŸ"
    ]
  }

  # å¤±è´¥æ¶ˆæ¯å’Œå»ºè®®
  failure {
    message: "âŒ Mavenæ„å»ºè´¨é‡æ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤åé‡è¯•"
    suggestions: [
      "1. ç§»é™¤UTF-8 BOMå­—ç¬¦",
      "2. ä¿®æ­£åŒ…åä¸ºnet.lab1024.saæ ¼å¼",
      "3. ä½¿ç”¨@Resourceæ›¿ä»£@Autowired",
      "4. ä½¿ç”¨@Mapperæ›¿ä»£@Repository",
      "5. æ£€æŸ¥Mavenä¾èµ–é…ç½®",
      "6. ä¿®å¤ç¼–è¯‘é”™è¯¯",
      "7. ç¡®ä¿æµ‹è¯•ç”¨ä¾‹é€šè¿‡",
      "8. ä½¿ç”¨/call-skills compilation-error-fixerè¿›è¡Œç¼–è¯‘å¼‚å¸¸ä¿®å¤",
      "9. ä½¿ç”¨/call-skills global-dependency-managerè¿›è¡Œä¾èµ–ç®¡ç†"
    ]
    blocking: true
  }

  # è¾“å‡ºé…ç½®
  output {
    verbose: true
    color: true
    log_file: ".kiro/logs/maven-build-quality-$(date +%Y%m%d-%H%M%S).log"
    metrics: true
  }
}