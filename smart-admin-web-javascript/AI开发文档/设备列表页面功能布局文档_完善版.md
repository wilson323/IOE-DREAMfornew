# 设备列表管理页面功能与布局文档

## 页面概述
设备列表管理页面是智能视频监控系统中的核心管理界面，用于统一管理系统中所有视频监控设备的注册、配置、状态监控和维护。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供完整的设备全生命周期管理功能，包括设备查询、添加、编辑、删除、批量操作、设备同步、订阅管理等功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue

### 项目文件组织结构
```
src/views/business/smart-video/
├── device-list.vue                  # 设备列表主页面
├── components/
│   ├── DeviceForm.vue              # 设备表单组件（新增/编辑）
│   ├── DeviceConfigModal.vue      # 设备配置弹窗组件
│   ├── DeviceInfoDrawer.vue       # 设备详情抽屉组件
│   └── DeviceImportModal.vue      # 设备批量导入组件
├── mock/
│   └── device-mock-data.js         # 模拟数据
└── api/
    └── device-api.js                # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/device-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const deviceApi = {
  // 查询设备列表
  queryDeviceList: (params) => postRequest('/device/query', params),

  // 添加设备
  addDevice: (params) => postRequest('/device/add', params),

  // 更新设备
  updateDevice: (params) => postRequest('/device/update', params),

  // 删除设备
  deleteDevice: (id) => getRequest(`/device/delete/${id}`),

  // 批量删除设备
  batchDeleteDevice: (ids) => postRequest('/device/batch/delete', ids),

  // 搜索在线设备（从网络搜索发现设备）
  searchOnlineDevices: (params) => postRequest('/device/search', params),

  // 同步设备信息（从设备同步最新信息）
  syncDevice: (id) => postRequest(`/device/sync/${id}`),

  // 批量同步设备
  batchSyncDevices: (ids) => postRequest('/device/batch/sync', ids),

  // 订阅设备事件
  subscribeDevice: (params) => postRequest('/device/subscribe', params),

  // 取消订阅设备事件
  unsubscribeDevice: (params) => postRequest('/device/unsubscribe', params),

  // 同步设备时间
  syncDeviceTime: (id) => postRequest(`/device/sync-time/${id}`),

  // 获取设备详细信息
  getDeviceInfo: (id) => getRequest(`/device/info/${id}`),

  // 获取设备配置
  getDeviceConfig: (id) => getRequest(`/device/config/${id}`),

  // 更新设备配置
  updateDeviceConfig: (params) => postRequest('/device/config/update', params),

  // 设备维护管理
  deviceMaintenance: (params) => postRequest('/device/maintenance', params),

  // 获取设备分组树
  getDeviceGroupTree: () => getRequest('/device/group/tree'),

  // 导入设备
  importDevices: (file) => postRequest('/device/import', file),

  // 导出设备
  exportDevices: (params) => postRequest('/device/export', params),

  // 测试设备连接
  testConnection: (params) => postRequest('/device/test', params),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="设备管理">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="设备管理"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { DeviceOutlined } from '@ant-design/icons-vue';  // ❌ 可能不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  SearchOutlined,        // ✅ 搜索
  ReloadOutlined,        // ✅ 重置/刷新
  PlusOutlined,          // ✅ 新增
  DeleteOutlined,        // ✅ 删除
  SyncOutlined,          // ✅ 同步
  BellOutlined,          // ✅ 订阅/通知
  ClockCircleOutlined,   // ✅ 时间
  ToolOutlined,          // ✅ 工具/维护
  InfoCircleOutlined,    // ✅ 信息
  UnorderedListOutlined, // ✅ 列表
  VideoCameraOutlined,   // ✅ 摄像机
  DesktopOutlined,       // ✅ 设备
  EditOutlined,          // ✅ 编辑
  SettingOutlined,       // ✅ 配置
  EyeOutlined,           // ✅ 查看
} from '@ant-design/icons-vue';
</script>
```

### 3. API导入路径注意事项

#### ✅ 正确：使用项目标准导入路径
```javascript
// 正确：使用项目中实际的axios文件
import { postRequest, getRequest } from '/@/lib/axios';
```

### 4. 设备类型枚举定义

#### ✅ 标准设备类型枚举
```javascript
// src/constants/business/device-const.js
export const DEVICE_TYPE_ENUM = {
  IPC: {
    value: 'ipc',
    label: '网络摄像机',
    icon: 'VideoCameraOutlined',
  },
  NVR: {
    value: 'nvr',
    label: 'NVR',
    icon: 'DesktopOutlined',
  },
  DVR: {
    value: 'dvr',
    label: 'DVR',
    icon: 'DesktopOutlined',
  },
  DECODER: {
    value: 'decoder',
    label: '解码器',
    icon: 'DesktopOutlined',
  },
};

export const DEVICE_STATUS_ENUM = {
  ONLINE: {
    value: 'online',
    label: '在线',
    color: 'success',
  },
  OFFLINE: {
    value: 'offline',
    label: '离线',
    color: 'error',
  },
};

export const DEVICE_MANUFACTURER_ENUM = {
  HIKVISION: {
    value: 'hikvision',
    label: '海康威视',
  },
  DAHUA: {
    value: 'dahua',
    label: '大华',
  },
  UNIVIEW: {
    value: 'uniview',
    label: '宇视',
  },
  TIANDY: {
    value: 'tiandy',
    label: '天地伟业',
  },
};
```

## 核心功能模块

### 1. 搜索与筛选功能
**位置**: 页面顶部工具栏区域

**技术实现**:
```vue
<template>
  <div class="smart-query-table-form">
    <a-row :gutter="16">
      <a-col :span="6">
        <a-form-item label="设备名称">
          <a-input
            v-model:value="queryForm.deviceName"
            placeholder="请输入设备名称"
            allowClear
          />
        </a-form-item>
      </a-col>

      <a-col :span="4">
        <a-form-item label="状态">
          <a-select
            v-model:value="queryForm.status"
            placeholder="请选择状态"
            allowClear
          >
            <a-select-option value="">全部</a-select-option>
            <a-select-option value="online">在线</a-select-option>
            <a-select-option value="offline">离线</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>

      <a-col :span="5">
        <a-form-item label="设备类型">
          <a-select
            v-model:value="queryForm.deviceType"
            placeholder="请选择设备类型"
            allowClear
          >
            <a-select-option value="">全部类型</a-select-option>
            <a-select-option value="ipc">网络摄像机</a-select-option>
            <a-select-option value="nvr">NVR</a-select-option>
            <a-select-option value="dvr">DVR</a-select-option>
            <a-select-option value="decoder">解码器</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>

      <a-col :span="9">
        <a-form-item>
          <a-space>
            <a-button type="primary" @click="queryData">
              <template #icon><SearchOutlined /></template>
              查询
            </a-button>
            <a-button @click="resetQuery">
              <template #icon><ReloadOutlined /></template>
              重置
            </a-button>
          </a-space>
        </a-form-item>
      </a-col>
    </a-row>
  </div>
</template>

<script setup>
import { reactive } from 'vue';
import { SearchOutlined, ReloadOutlined } from '@ant-design/icons-vue';

const queryForm = reactive({
  deviceName: '',
  status: '',
  deviceType: '',
});

const queryData = () => {
  console.log('查询设备', queryForm);
  // 调用API查询
};

const resetQuery = () => {
  Object.assign(queryForm, {
    deviceName: '',
    status: '',
    deviceType: '',
  });
  queryData();
};
</script>
```

### 2. 主操作按钮区
**位置**: 搜索区域下方

**功能说明**:
- **新增设备**: 手动添加单个设备
- **删除**: 批量删除选中的设备
- **搜索设备**: 从网络中自动搜索发现在线设备
- **同步设备**: 同步选中设备的最新状态和配置信息

**技术实现**:
```vue
<template>
  <div class="smart-query-table-operation">
    <a-space>
      <a-button type="primary" @click="showAddModal">
        <template #icon><PlusOutlined /></template>
        新增设备
      </a-button>

      <a-button
        danger
        @click="batchDelete"
        :disabled="selectedRowKeys.length === 0"
      >
        <template #icon><DeleteOutlined /></template>
        删除
      </a-button>

      <a-button @click="searchDevices">
        <template #icon><SearchOutlined /></template>
        搜索设备
      </a-button>

      <a-button @click="syncDevices">
        <template #icon><SyncOutlined /></template>
        同步设备
      </a-button>

      <a-button @click="exportDevices">
        <template #icon><DownloadOutlined /></template>
        导出
      </a-button>

      <a-button @click="importDevices">
        <template #icon><UploadOutlined /></template>
        导入
      </a-button>
    </a-space>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { message, Modal } from 'ant-design-vue';
import {
  PlusOutlined,
  DeleteOutlined,
  SearchOutlined,
  SyncOutlined,
  DownloadOutlined,
  UploadOutlined,
} from '@ant-design/icons-vue';

const selectedRowKeys = ref([]);

const showAddModal = () => {
  // 显示新增设备弹窗
};

const batchDelete = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要删除的设备');
    return;
  }

  Modal.confirm({
    title: '确认删除',
    content: `确定要删除选中的 ${selectedRowKeys.value.length} 个设备吗？`,
    onOk: async () => {
      try {
        // await deviceApi.batchDeleteDevice(selectedRowKeys.value);
        message.success('删除成功');
        selectedRowKeys.value = [];
        queryData();
      } catch (error) {
        message.error('删除失败');
      }
    },
  });
};

const searchDevices = () => {
  // 打开搜索设备弹窗，从网络中发现新设备
  message.info('正在搜索在线设备...');
};

const syncDevices = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要同步的设备');
    return;
  }

  message.loading('正在同步设备信息...', 0);
  // await deviceApi.batchSyncDevices(selectedRowKeys.value);
};
</script>
```

### 3. 更多操作区
**位置**: 主操作按钮区下方

**功能说明**:
- **订阅**: 订阅设备的事件通知（如报警、状态变化等）
- **取消订阅**: 取消设备的事件订阅
- **同步时间**: 将系统时间同步到设备
- **维护管理**: 设备维护操作（重启、恢复出厂设置等）
- **查看信息**: 查看设备的详细信息和运行状态
- **目标名单库**: 管理设备关联的人脸/车辆识别名单库

**技术实现**:
```vue
<template>
  <div class="smart-query-table-operation" style="margin-top: 16px;">
    <a-space>
      <span style="color: #999;">更多操作:</span>

      <a-button size="small" @click="subscribeDevices">
        <template #icon><BellOutlined /></template>
        订阅
      </a-button>

      <a-button size="small" @click="unsubscribeDevices">
        <template #icon><BellOutlined /></template>
        取消订阅
      </a-button>

      <a-button size="small" @click="syncTime">
        <template #icon><ClockCircleOutlined /></template>
        同步时间
      </a-button>

      <a-button size="small" @click="maintenanceManage">
        <template #icon><ToolOutlined /></template>
        维护管理
      </a-button>

      <a-button size="small" @click="viewDeviceInfo">
        <template #icon><InfoCircleOutlined /></template>
        查看信息
      </a-button>

      <a-button size="small" @click="targetList">
        <template #icon><UnorderedListOutlined /></template>
        目标名单库
      </a-button>
    </a-space>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { message } from 'ant-design-vue';
import {
  BellOutlined,
  ClockCircleOutlined,
  ToolOutlined,
  InfoCircleOutlined,
  UnorderedListOutlined,
} from '@ant-design/icons-vue';

const selectedRowKeys = ref([]);

const subscribeDevices = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要订阅的设备');
    return;
  }
  // 调用订阅API
  message.success('订阅成功');
};

const unsubscribeDevices = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要取消订阅的设备');
    return;
  }
  // 调用取消订阅API
  message.success('取消订阅成功');
};

const syncTime = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要同步时间的设备');
    return;
  }
  // 批量同步时间
  message.success('时间同步成功');
};

const maintenanceManage = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择要维护的设备');
    return;
  }
  // 打开维护管理弹窗
};

const viewDeviceInfo = () => {
  if (selectedRowKeys.value.length !== 1) {
    message.warning('请选择一个设备查看信息');
    return;
  }
  // 打开设备详情抽屉
};

const targetList = () => {
  if (selectedRowKeys.value.length === 0) {
    message.warning('请选择设备');
    return;
  }
  // 打开目标名单库管理弹窗
};
</script>
```

### 4. 设备列表表格
**位置**: 操作区域下方

**表格列配置**:
```vue
<template>
  <a-card class="smart-margin-top10">
    <a-table
      :columns="columns"
      :data-source="tableData"
      :pagination="pagination"
      :loading="tableLoading"
      :row-selection="rowSelection"
      :scroll="{ x: 1400 }"
      row-key="id"
      bordered
      @change="handleTableChange"
    >
      <template #bodyCell="{ column, record, text }">
        <!-- 设备类型 -->
        <template v-if="column.dataIndex === 'deviceType'">
          <a-tag :color="getDeviceTypeColor(record.deviceType)">
            {{ getDeviceTypeLabel(record.deviceType) }}
          </a-tag>
        </template>

        <!-- 状态 -->
        <template v-else-if="column.dataIndex === 'status'">
          <a-tag :color="record.status === 'online' ? 'success' : 'error'">
            <template #icon>
              <CheckCircleOutlined v-if="record.status === 'online'" />
              <CloseCircleOutlined v-else />
            </template>
            {{ record.status === 'online' ? '在线' : '离线' }}
          </a-tag>
        </template>

        <!-- 操作 -->
        <template v-else-if="column.dataIndex === 'action'">
          <div class="smart-table-operate">
            <a-button type="link" size="small" @click="editDevice(record)">
              <template #icon><EditOutlined /></template>
              编辑
            </a-button>

            <a-button type="link" size="small" @click="configDevice(record)">
              <template #icon><SettingOutlined /></template>
              配置
            </a-button>

            <a-button type="link" size="small" @click="viewDevice(record)">
              <template #icon><EyeOutlined /></template>
              查看
            </a-button>

            <a-popconfirm
              title="确定要删除该设备吗？"
              @confirm="deleteDevice(record)"
            >
              <a-button type="link" size="small" danger>
                <template #icon><DeleteOutlined /></template>
                删除
              </a-button>
            </a-popconfirm>
          </div>
        </template>
      </template>
    </a-table>
  </a-card>
</template>

<script setup>
import { ref, reactive, computed } from 'vue';
import {
  EditOutlined,
  SettingOutlined,
  EyeOutlined,
  DeleteOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
} from '@ant-design/icons-vue';

const columns = [
  {
    title: '序号',
    dataIndex: 'index',
    key: 'index',
    width: 80,
    customRender: ({ index }) => index + 1,
  },
  {
    title: '设备名称',
    dataIndex: 'deviceName',
    key: 'deviceName',
    width: 180,
    ellipsis: true,
  },
  {
    title: '设备编码',
    dataIndex: 'deviceCode',
    key: 'deviceCode',
    width: 150,
  },
  {
    title: '设备类型',
    dataIndex: 'deviceType',
    key: 'deviceType',
    width: 120,
  },
  {
    title: 'IP地址',
    dataIndex: 'ipAddress',
    key: 'ipAddress',
    width: 140,
  },
  {
    title: '端口',
    dataIndex: 'port',
    key: 'port',
    width: 80,
  },
  {
    title: '状态',
    dataIndex: 'status',
    key: 'status',
    width: 100,
  },
  {
    title: '所属分组',
    dataIndex: 'groupName',
    key: 'groupName',
    width: 120,
    ellipsis: true,
  },
  {
    title: '注册时间',
    dataIndex: 'registerTime',
    key: 'registerTime',
    width: 160,
  },
  {
    title: '最后心跳',
    dataIndex: 'lastHeartbeat',
    key: 'lastHeartbeat',
    width: 160,
  },
  {
    title: '操作',
    dataIndex: 'action',
    key: 'action',
    width: 240,
    fixed: 'right',
  },
];

const tableData = ref([]);
const tableLoading = ref(false);
const selectedRowKeys = ref([]);

const pagination = reactive({
  current: 1,
  pageSize: 20,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  pageSizeOptions: ['10', '20', '50', '100'],
  showTotal: (total) => `共 ${total} 条`,
});

const rowSelection = computed(() => ({
  selectedRowKeys: selectedRowKeys.value,
  onChange: (keys) => {
    selectedRowKeys.value = keys;
  },
}));

const getDeviceTypeLabel = (type) => {
  const typeMap = {
    ipc: '网络摄像机',
    nvr: 'NVR',
    dvr: 'DVR',
    decoder: '解码器',
  };
  return typeMap[type] || type;
};

const getDeviceTypeColor = (type) => {
  const colorMap = {
    ipc: 'blue',
    nvr: 'purple',
    dvr: 'cyan',
    decoder: 'green',
  };
  return colorMap[type] || 'default';
};
</script>
```

### 5. 设备表单组件（新增/编辑）
**组件路径**: `src/views/business/smart-video/components/DeviceForm.vue`

**技术实现**:
```vue
<template>
  <a-modal
    :open="visible"
    :title="isEdit ? '编辑设备' : '新增设备'"
    width="900px"
    @ok="handleSubmit"
    @cancel="handleCancel"
    :confirmLoading="loading"
    :maskClosable="false"
  >
    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
    >
      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="设备名称" name="deviceName">
            <a-input
              v-model:value="formData.deviceName"
              placeholder="请输入设备名称"
            />
          </a-form-item>
        </a-col>

        <a-col :span="12">
          <a-form-item label="设备编码" name="deviceCode">
            <a-input
              v-model:value="formData.deviceCode"
              placeholder="请输入设备编码（国标编码）"
            />
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="设备类型" name="deviceType">
            <a-select
              v-model:value="formData.deviceType"
              placeholder="请选择设备类型"
            >
              <a-select-option value="ipc">网络摄像机</a-select-option>
              <a-select-option value="nvr">NVR</a-select-option>
              <a-select-option value="dvr">DVR</a-select-option>
              <a-select-option value="decoder">解码器</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>

        <a-col :span="12">
          <a-form-item label="厂商" name="manufacturer">
            <a-select
              v-model:value="formData.manufacturer"
              placeholder="请选择厂商"
            >
              <a-select-option value="hikvision">海康威视</a-select-option>
              <a-select-option value="dahua">大华</a-select-option>
              <a-select-option value="uniview">宇视</a-select-option>
              <a-select-option value="tiandy">天地伟业</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="IP地址" name="ipAddress">
            <a-input
              v-model:value="formData.ipAddress"
              placeholder="请输入IP地址"
            />
          </a-form-item>
        </a-col>

        <a-col :span="12">
          <a-form-item label="端口" name="port">
            <a-input-number
              v-model:value="formData.port"
              placeholder="请输入端口"
              :min="1"
              :max="65535"
              style="width: 100%"
            />
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="用户名" name="username">
            <a-input
              v-model:value="formData.username"
              placeholder="请输入用户名"
            />
          </a-form-item>
        </a-col>

        <a-col :span="12">
          <a-form-item label="密码" name="password">
            <a-input-password
              v-model:value="formData.password"
              placeholder="请输入密码"
            />
          </a-form-item>
        </a-col>
      </a-row>

      <a-row :gutter="16">
        <a-col :span="12">
          <a-form-item label="所属分组" name="groupId">
            <a-tree-select
              v-model:value="formData.groupId"
              :tree-data="groupTreeData"
              placeholder="请选择所属分组"
              allowClear
              tree-default-expand-all
            />
          </a-form-item>
        </a-col>

        <a-col :span="12">
          <a-form-item label="安装位置" name="location">
            <a-input
              v-model:value="formData.location"
              placeholder="请输入安装位置"
            />
          </a-form-item>
        </a-col>
      </a-row>

      <a-form-item label="设备描述" name="description">
        <a-textarea
          v-model:value="formData.description"
          placeholder="请输入设备描述"
          :rows="3"
        />
      </a-form-item>

      <a-form-item label="连接测试" v-if="!isEdit">
        <a-button @click="testConnection" :loading="testing">
          <template #icon><ApiOutlined /></template>
          测试连接
        </a-button>
        <span v-if="testResult" :style="{ marginLeft: '12px', color: testResult.success ? '#52c41a' : '#ff4d4f' }">
          {{ testResult.message }}
        </span>
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';
import { ApiOutlined } from '@ant-design/icons-vue';
import { deviceApi } from '/@/api/business/smart-video/device-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  isEdit: {
    type: Boolean,
    default: false,
  },
  deviceData: {
    type: Object,
    default: () => ({}),
  },
  groupTreeData: {
    type: Array,
    default: () => [],
  },
});

const emit = defineEmits(['update:visible', 'success', 'cancel']);

const formRef = ref();
const loading = ref(false);
const testing = ref(false);
const testResult = ref(null);

const formData = reactive({
  deviceName: '',
  deviceCode: '',
  deviceType: '',
  manufacturer: '',
  ipAddress: '',
  port: 8000,
  username: '',
  password: '',
  groupId: undefined,
  location: '',
  description: '',
});

const formRules = {
  deviceName: [
    { required: true, message: '请输入设备名称', trigger: 'blur' },
  ],
  deviceCode: [
    { required: true, message: '请输入设备编码', trigger: 'blur' },
  ],
  deviceType: [
    { required: true, message: '请选择设备类型', trigger: 'change' },
  ],
  manufacturer: [
    { required: true, message: '请选择厂商', trigger: 'change' },
  ],
  ipAddress: [
    { required: true, message: '请输入IP地址', trigger: 'blur' },
    {
      pattern: /^(\d{1,3}\.){3}\d{1,3}$/,
      message: '请输入正确的IP地址',
      trigger: 'blur',
    },
  ],
  port: [
    { required: true, message: '请输入端口', trigger: 'blur' },
  ],
  username: [
    { required: true, message: '请输入用户名', trigger: 'blur' },
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
  ],
};

// 监听编辑数据变化
watch(
  () => props.deviceData,
  (newVal) => {
    if (newVal && Object.keys(newVal).length > 0) {
      Object.assign(formData, newVal);
    }
  },
  { immediate: true, deep: true }
);

// 测试连接
const testConnection = async () => {
  try {
    await formRef.value.validateFields(['ipAddress', 'port', 'username', 'password']);

    testing.value = true;
    testResult.value = null;

    const result = await deviceApi.testConnection({
      ipAddress: formData.ipAddress,
      port: formData.port,
      username: formData.username,
      password: formData.password,
    });

    if (result.code === 1) {
      testResult.value = {
        success: true,
        message: '连接成功！',
      };
      message.success('设备连接测试成功');
    } else {
      testResult.value = {
        success: false,
        message: result.msg || '连接失败',
      };
    }
  } catch (error) {
    console.error('连接测试失败:', error);
    testResult.value = {
      success: false,
      message: '连接测试失败',
    };
  } finally {
    testing.value = false;
  }
};

// 提交表单
const handleSubmit = async () => {
  try {
    await formRef.value.validate();

    loading.value = true;

    const apiMethod = props.isEdit ? deviceApi.updateDevice : deviceApi.addDevice;
    const result = await apiMethod(formData);

    if (result.code === 1) {
      message.success(props.isEdit ? '编辑成功' : '新增成功');
      emit('success');
      handleCancel();
    } else {
      message.error(result.msg || '操作失败');
    }
  } catch (error) {
    console.error('表单提交失败:', error);
  } finally {
    loading.value = false;
  }
};

// 取消
const handleCancel = () => {
  formRef.value?.resetFields();
  testResult.value = null;
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/device-mock-data.js
export const mockDeviceList = [
  {
    id: 1,
    deviceName: '前门摄像头-001',
    deviceCode: 'CAM-001-20240101',
    deviceType: 'ipc',
    manufacturer: 'hikvision',
    ipAddress: '192.168.1.101',
    port: 8000,
    username: 'admin',
    status: 'online',
    groupId: 'office-1f',
    groupName: '办公区域-一楼',
    location: '公司前门入口',
    registerTime: '2024-01-15 10:30:25',
    lastHeartbeat: '2024-01-30 14:35:12',
    description: '监控前门进出人员',
  },
  {
    id: 2,
    deviceName: '大厅摄像头-002',
    deviceCode: 'CAM-002-20240102',
    deviceType: 'ipc',
    manufacturer: 'dahua',
    ipAddress: '192.168.1.102',
    port: 8000,
    username: 'admin',
    status: 'online',
    groupId: 'office-1f',
    groupName: '办公区域-一楼',
    location: '公司大厅中央',
    registerTime: '2024-01-15 10:32:18',
    lastHeartbeat: '2024-01-30 14:35:15',
    description: '监控大厅区域',
  },
  {
    id: 3,
    deviceName: '走廊摄像头-003',
    deviceCode: 'CAM-003-20240103',
    deviceType: 'ipc',
    manufacturer: 'uniview',
    ipAddress: '192.168.1.103',
    port: 8000,
    username: 'admin',
    status: 'offline',
    groupId: 'office-2f',
    groupName: '办公区域-二楼',
    location: '二楼走廊',
    registerTime: '2024-01-15 10:35:42',
    lastHeartbeat: '2024-01-30 12:20:35',
    description: '监控二楼走廊',
  },
  {
    id: 4,
    deviceName: 'NVR存储设备-01',
    deviceCode: 'NVR-001-20240104',
    deviceType: 'nvr',
    manufacturer: 'hikvision',
    ipAddress: '192.168.1.200',
    port: 8000,
    username: 'admin',
    status: 'online',
    groupId: 'office-3f',
    groupName: '办公区域-三楼',
    location: '监控中心机房',
    registerTime: '2024-01-14 16:20:10',
    lastHeartbeat: '2024-01-30 14:35:20',
    description: '视频存储录像设备',
  },
  {
    id: 5,
    deviceName: '停车场摄像头-01',
    deviceCode: 'CAM-005-20240105',
    deviceType: 'ipc',
    manufacturer: 'tiandy',
    ipAddress: '192.168.1.104',
    port: 8000,
    username: 'admin',
    status: 'online',
    groupId: 'parking',
    groupName: '停车区域',
    location: '地下停车场入口',
    registerTime: '2024-01-15 11:00:35',
    lastHeartbeat: '2024-01-30 14:35:18',
    description: '监控停车场车辆',
  },
];

export const mockGroupTreeData = [
  {
    title: '全部设备',
    key: 'root',
    value: 'root',
    children: [
      {
        title: '办公区域',
        key: 'office',
        value: 'office',
        children: [
          { title: '一楼', key: 'office-1f', value: 'office-1f' },
          { title: '二楼', key: 'office-2f', value: 'office-2f' },
          { title: '三楼', key: 'office-3f', value: 'office-3f' },
        ],
      },
      {
        title: '生产区域',
        key: 'production',
        value: 'production',
        children: [
          { title: '车间A', key: 'production-a', value: 'production-a' },
          { title: '车间B', key: 'production-b', value: 'production-b' },
          { title: '仓库', key: 'production-warehouse', value: 'production-warehouse' },
        ],
      },
      {
        title: '停车区域',
        key: 'parking',
        value: 'parking',
        children: [
          { title: '地下停车场', key: 'parking-underground', value: 'parking-underground' },
          { title: '露天停车场', key: 'parking-outdoor', value: 'parking-outdoor' },
        ],
      },
      {
        title: '公共区域',
        key: 'public',
        value: 'public',
        children: [
          { title: '餐厅', key: 'public-canteen', value: 'public-canteen' },
          { title: '会议室', key: 'public-meeting', value: 'public-meeting' },
        ],
      },
      {
        title: '周界防范',
        key: 'security',
        value: 'security',
      },
    ],
  },
];

// Mock API实现
export default {
  // 查询设备列表
  mockQueryDeviceList: (params) => {
    let list = [...mockDeviceList];

    // 筛选条件
    if (params.deviceName) {
      list = list.filter(item =>
        item.deviceName.includes(params.deviceName) ||
        item.deviceCode.includes(params.deviceName)
      );
    }

    if (params.status) {
      list = list.filter(item => item.status === params.status);
    }

    if (params.deviceType) {
      list = list.filter(item => item.deviceType === params.deviceType);
    }

    // 分页
    const pageNum = params.pageNum || 1;
    const pageSize = params.pageSize || 20;
    const total = list.length;
    const start = (pageNum - 1) * pageSize;
    const end = start + pageSize;

    return {
      code: 1,
      msg: '查询成功',
      data: {
        list: list.slice(start, end),
        total,
        pageNum,
        pageSize,
      },
    };
  },

  // 获取分组树
  mockGetGroupTree: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockGroupTreeData,
    };
  },
};
```

## 路由配置

### ✅ 正确的路由配置
```javascript
// src/router/business/smart-video.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/device-list',
        name: 'SmartVideoDeviceList',
        component: () => import('/@/views/business/smart-video/device-list.vue'),
        meta: {
          title: '智能视频 - 设备列表',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'VideoCameraOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

### ✅ 主路由文件集成
```javascript
// src/router/routers.js
import { smartVideoRouters } from './business/smart-video';

export const routerArray = [
  // ...其他路由
  ...smartVideoRouters,
  // ...更多路由
];
```

## 菜单配置

### ✅ 动态菜单注入
```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  // 智能视频父菜单
  const smartVideoMenu = {
    menuId: maxMenuId + 1000,
    menuName: '智能视频',
    menuTitle: '智能视频',
    menuType: MENU_TYPE_ENUM.CATALOG.value,
    parentId: 0,
    path: '/business/smart-video',
    icon: 'VideoCameraOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: false,
    frameFlag: false,
    frameUrl: '',
    sort: 10,
    updateTime: new Date().toISOString(),
  };

  // 设备列表子菜单
  const deviceListMenu = {
    menuId: maxMenuId + 1001,
    menuName: '设备列表',
    menuTitle: '设备列表',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/device-list',
    component: '/business/smart-video/device-list.vue',
    icon: 'DesktopOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 1,
    updateTime: new Date().toISOString(),
  };

  menuList.push(smartVideoMenu, deviceListMenu);
  return smartVideoMenu.menuId;
}
```

## Pinia Store状态管理

```javascript
// src/store/modules/business/device.js
import { defineStore } from 'pinia';
import { message } from 'ant-design-vue';
import { deviceApi } from '/@/api/business/smart-video/device-api';

export const useDeviceStore = defineStore('device', {
  state: () => ({
    deviceList: [],
    groupTreeData: [],
    loading: false,
    currentDevice: null,
  }),

  getters: {
    onlineDeviceCount(state) {
      return state.deviceList.filter(d => d.status === 'online').length;
    },

    offlineDeviceCount(state) {
      return state.deviceList.filter(d => d.status === 'offline').length;
    },

    deviceTypeStats(state) {
      const stats = {};
      state.deviceList.forEach(device => {
        stats[device.deviceType] = (stats[device.deviceType] || 0) + 1;
      });
      return stats;
    },
  },

  actions: {
    async fetchDeviceList(params = {}, useMock = true) {
      this.loading = true;
      try {
        let response;
        if (useMock) {
          // 开发阶段使用mock数据
          const deviceMockData = await import('/@/views/business/smart-video/mock/device-mock-data');
          response = deviceMockData.default.mockQueryDeviceList(params);
        } else {
          // 生产环境使用真实API
          response = await deviceApi.queryDeviceList(params);
        }

        if (response.code === 1) {
          this.deviceList = response.data.list;
          return response.data;
        } else {
          message.error(response.msg || '获取数据失败');
          return null;
        }
      } catch (error) {
        console.error('获取设备列表失败:', error);
        message.error('获取数据失败');
        return null;
      } finally {
        this.loading = false;
      }
    },

    async fetchGroupTree(useMock = true) {
      try {
        let response;
        if (useMock) {
          const deviceMockData = await import('/@/views/business/smart-video/mock/device-mock-data');
          response = deviceMockData.default.mockGetGroupTree();
        } else {
          response = await deviceApi.getDeviceGroupTree();
        }

        if (response.code === 1) {
          this.groupTreeData = response.data;
          return response.data;
        }
      } catch (error) {
        console.error('获取分组树失败:', error);
        return [];
      }
    },

    async addDevice(deviceData) {
      try {
        const response = await deviceApi.addDevice(deviceData);
        if (response.code === 1) {
          message.success('添加设备成功');
          return true;
        } else {
          message.error(response.msg || '添加设备失败');
          return false;
        }
      } catch (error) {
        console.error('添加设备失败:', error);
        message.error('添加设备失败');
        return false;
      }
    },

    async updateDevice(deviceData) {
      try {
        const response = await deviceApi.updateDevice(deviceData);
        if (response.code === 1) {
          message.success('更新设备成功');
          return true;
        } else {
          message.error(response.msg || '更新设备失败');
          return false;
        }
      } catch (error) {
        console.error('更新设备失败:', error);
        message.error('更新设备失败');
        return false;
      }
    },

    async deleteDevice(deviceId) {
      try {
        const response = await deviceApi.deleteDevice(deviceId);
        if (response.code === 1) {
          message.success('删除设备成功');
          return true;
        } else {
          message.error(response.msg || '删除设备失败');
          return false;
        }
      } catch (error) {
        console.error('删除设备失败:', error);
        message.error('删除设备失败');
        return false;
      }
    },

    setCurrentDevice(device) {
      this.currentDevice = device;
    },
  },
});
```

## 常见错误排查清单

### 1. 控制台报错排查
- [ ] 图标导入错误：检查 `@ant-design/icons-vue` 中是否存在该图标
- [ ] API导入错误：确认导入路径是否为 `/@/lib/axios`
- [ ] v-model错误：检查是否在props上使用了v-model
- [ ] 树形选择器错误：确保`tree-data`数据格式正确（包含title、key、value字段）

### 2. 页面无法访问排查
- [ ] 路由配置：检查路由是否正确添加到 `routerArray`
- [ ] 菜单配置：检查菜单是否正确注入到菜单列表
- [ ] 组件路径：确认组件路径是否正确
- [ ] 文件存在：确认所有引用的组件文件都存在

### 3. 功能异常排查
- [ ] Store状态：检查Pinia store是否正确定义和使用
- [ ] API调用：确认API接口路径和参数是否正确
- [ ] 数据格式：检查mock数据格式是否符合预期
- [ ] 事件绑定：确认事件监听器是否正确绑定
- [ ] 表单验证：确保表单规则配置正确

### 4. 设备操作相关排查
- [ ] 连接测试：确保IP地址和端口格式正确
- [ ] 设备同步：检查设备是否在线且可访问
- [ ] 批量操作：确认已选中设备且操作权限正确
- [ ] 分组关联：确保分组树数据加载完成

## 最佳实践总结

### ✅ 推荐的开发流程
1. **先创建基础组件** - 确保每个组件可以独立运行
2. **逐步集成功能** - 从简单到复杂，逐步添加功能
3. **Mock数据优先** - 先用mock数据开发，后期对接真实API
4. **及时测试验证** - 每添加一个功能就进行测试
5. **遵循项目规范** - 使用项目既定的命名和结构规范

### ✅ 代码质量保证
1. **使用TypeScript类型检查**（如果项目支持）
2. **遵循ESLint和Prettier规范**
3. **编写单元测试**（重要功能）
4. **添加适当的注释**，特别是复杂逻辑
5. **保持组件单一职责**，避免过度复杂

### ✅ 性能优化建议
1. **使用懒加载**：路由和组件按需加载
2. **合理使用computed和watch**
3. **避免不必要的重新渲染**
4. **使用虚拟滚动**处理大数据列表（设备数量超过1000时）
5. **添加防抖和节流**优化用户交互（如搜索输入）

### ✅ 安全性建议
1. **密码字段加密传输**
2. **敏感信息不在前端存储**
3. **API接口添加权限校验**
4. **防止SQL注入和XSS攻击**
5. **设备凭证使用加密存储**

## 特殊功能实现说明

### 1. 设备搜索功能（网络自动发现）
```javascript
// 从网络中自动搜索并发现在线设备
const searchDevices = async () => {
  const modal = Modal.info({
    title: '正在搜索设备...',
    content: '正在网络中搜索可用的设备，请稍候...',
    okText: '停止搜索',
  });

  try {
    const response = await deviceApi.searchOnlineDevices({
      networkSegment: '192.168.1.0/24', // 指定网段
      timeout: 5000,
    });

    modal.destroy();

    if (response.code === 1 && response.data.length > 0) {
      // 显示搜索结果弹窗，让用户选择要添加的设备
      showSearchResultModal(response.data);
    } else {
      message.info('未搜索到可用设备');
    }
  } catch (error) {
    modal.destroy();
    message.error('搜索失败');
  }
};
```

### 2. 设备批量导入功能
```vue
<template>
  <a-upload
    name="file"
    :before-upload="beforeUpload"
    :show-upload-list="false"
  >
    <a-button>
      <template #icon><UploadOutlined /></template>
      选择Excel文件
    </a-button>
  </a-upload>
</template>

<script setup>
import { message } from 'ant-design-vue';
import { UploadOutlined } from '@ant-design/icons-vue';
import { deviceApi } from '/@/api/business/smart-video/device-api';

const beforeUpload = (file) => {
  const isExcel = file.type === 'application/vnd.ms-excel' ||
                  file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

  if (!isExcel) {
    message.error('只能上传Excel文件！');
    return false;
  }

  const formData = new FormData();
  formData.append('file', file);

  message.loading('正在导入设备...', 0);

  deviceApi.importDevices(formData)
    .then(response => {
      message.destroy();
      if (response.code === 1) {
        message.success(`成功导入 ${response.data.successCount} 个设备`);
        queryData();
      } else {
        message.error(response.msg || '导入失败');
      }
    })
    .catch(error => {
      message.destroy();
      message.error('导入失败');
    });

  return false; // 阻止默认上传
};
</script>
```

### 3. 设备心跳监控（实时状态更新）
```javascript
// 使用WebSocket或轮询方式实时更新设备状态
let heartbeatTimer = null;

onMounted(() => {
  // 开启心跳监控
  startHeartbeatMonitor();
});

onUnmounted(() => {
  // 停止心跳监控
  stopHeartbeatMonitor();
});

const startHeartbeatMonitor = () => {
  heartbeatTimer = setInterval(() => {
    // 刷新设备列表，获取最新状态
    queryData({ silent: true }); // silent表示静默刷新，不显示loading
  }, 30000); // 每30秒刷新一次
};

const stopHeartbeatMonitor = () => {
  if (heartbeatTimer) {
    clearInterval(heartbeatTimer);
    heartbeatTimer = null;
  }
};
```

## 总结

通过遵循本文档的技术规范和注意事项，可以有效避免开发过程中的常见错误，确保设备列表管理页面能够顺利开发和部署。

关键要点：
- ✅ **避免在props上使用v-model**，改用属性绑定和事件监听
- ✅ **验证图标存在性**，使用实际存在于`@ant-design/icons-vue`中的图标
- ✅ **使用正确的API导入路径**：`/@/lib/axios`
- ✅ **标准化设备类型和状态**，使用枚举常量定义
- ✅ **完善的表单验证**，特别是IP地址、端口等网络配置
- ✅ **实现连接测试功能**，确保设备配置正确后再保存
- ✅ **支持批量操作**，提高管理效率
- ✅ **树形分组管理**，便于设备组织和查找
- ✅ **实时状态监控**，及时发现设备离线问题

通过这些规范和最佳实践，可以确保开发过程顺利进行，减少调试时间，提高开发效率。
