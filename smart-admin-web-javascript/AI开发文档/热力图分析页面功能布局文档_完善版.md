# 热力图分析页面功能与布局文档

## 页面概述
热力图分析页面是智能视频监控系统的高级数据可视化界面,用于展示监控区域的人员活动热度分布和温度分布数据。该页面基于SmartAdmin前端框架构建,采用Vue3 + Ant Design Vue + ECharts技术栈,支持时间热力图和空间热力图两种展示模式,提供区域热度分析、时间段统计、热点识别、数据导出等完整功能,为管理人员提供直观的数据分析和决策支持。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **可视化库**: Apache ECharts 5.5.0
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **Canvas绘图**: 原生Canvas API

### 热力图技术方案

#### 方案一: ECharts热力图 (推荐用于时间维度热力图)
**优势**:
- 内置热力图组件,配置简单
- 支持多种颜色渐变方案
- 交互功能完善(tooltip、zoom等)
- 性能优异,支持大数据量

**适用场景**:
- 时间维度的热力图(24小时、7天、30天)
- 矩阵式数据展示
- 需要交互式数据探索

#### 方案二: Canvas热力图 (推荐用于空间维度热力图)
**优势**:
- 可叠加到视频背景上
- 灵活的渐变效果控制
- 支持自定义热点形状和大小
- 实时绘制性能好

**适用场景**:
- 监控画面叠加热力图
- 空间位置热度分布
- 需要与视频流结合展示

#### 方案三: heatmap.js库 (可选高级方案)
**优势**:
- 专业的热力图渲染库
- 支持多种渐变配色方案
- 性能优化好
- 易于集成

**安装**:
```bash
npm install heatmap.js
```

**适用场景**:
- 需要高性能热力图渲染
- 复杂的热点叠加效果
- 需要导出热力图图片

### 项目文件组织结构
```
src/views/business/smart-video/
├── heat-statistics.vue              # 热力图统计主页面
├── components/
│   ├── TimeHeatmapChart.vue        # 时间热力图组件
│   ├── SpaceHeatmapCanvas.vue      # 空间热力图Canvas组件
│   ├── HeatmapLegend.vue           # 热力图图例组件
│   ├── HeatmapControls.vue         # 热力图控制面板组件
│   ├── HeatDataTable.vue           # 热力数据表格组件
│   └── HeatmapExport.vue           # 热力图导出组件
├── hooks/
│   ├── useHeatmapData.js           # 热力图数据处理Hook
│   ├── useCanvasHeatmap.js         # Canvas热力图绘制Hook
│   └── useHeatmapColors.js         # 热力图配色方案Hook
├── utils/
│   ├── heatmap-calculator.js       # 热力图数据计算工具
│   ├── canvas-renderer.js          # Canvas渲染工具
│   └── color-gradient.js           # 颜色渐变生成工具
├── mock/
│   └── heatmap-mock-data.js        # 模拟数据
└── api/
    └── heatmap-api.js               # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/heatmap-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const heatmapApi = {
  // 获取时间热力图数据
  getTimeHeatmapData: (params) => postRequest('/heatmap/time/data', params),

  // 获取空间热力图数据
  getSpaceHeatmapData: (params) => postRequest('/heatmap/space/data', params),

  // 获取热点区域分析
  getHotspotAnalysis: (params) => postRequest('/heatmap/hotspot/analysis', params),

  // 获取设备通道列表
  getDeviceChannels: (deviceId) => getRequest(`/heatmap/device/${deviceId}/channels`),

  // 获取历史热力图数据
  getHistoryHeatmapData: (params) => postRequest('/heatmap/history/data', params),

  // 导出热力图数据
  exportHeatmapData: (params) => postRequest('/heatmap/export', params, {
    responseType: 'blob'
  }),

  // 获取热力图配置
  getHeatmapConfig: () => getRequest('/heatmap/config'),

  // 保存热力图配置
  saveHeatmapConfig: (config) => postRequest('/heatmap/config/save', config),

  // 获取监控画面截图
  getVideoSnapshot: (channelId) => getRequest(`/heatmap/video/snapshot/${channelId}`),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Canvas热力图绘制注意事项

#### ❌ 错误用法：未正确设置Canvas尺寸
```vue
<!-- 错误：Canvas尺寸与显示尺寸不匹配 -->
<template>
  <canvas ref="canvasRef" style="width: 800px; height: 600px;"></canvas>
</template>

<script setup>
onMounted(() => {
  const canvas = canvasRef.value;
  const ctx = canvas.getContext('2d');
  // ❌ 未设置canvas.width和canvas.height，导致图像模糊
  ctx.fillRect(0, 0, 800, 600);
});
</script>
```

#### ✅ 正确用法：正确设置Canvas尺寸和分辨率
```vue
<template>
  <div ref="containerRef" class="heatmap-container">
    <canvas ref="canvasRef" class="heatmap-canvas"></canvas>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';

const containerRef = ref(null);
const canvasRef = ref(null);

const initCanvas = () => {
  const canvas = canvasRef.value;
  const container = containerRef.value;

  if (!canvas || !container) return;

  // ✅ 获取容器实际尺寸
  const rect = container.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  // ✅ 设置Canvas实际尺寸(考虑设备像素比)
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;

  // ✅ 设置Canvas显示尺寸
  canvas.style.width = `${rect.width}px`;
  canvas.style.height = `${rect.height}px`;

  // ✅ 缩放上下文以匹配设备像素比
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
};

onMounted(() => {
  initCanvas();
  window.addEventListener('resize', initCanvas);
});

onUnmounted(() => {
  window.removeEventListener('resize', initCanvas);
});
</script>

<style scoped lang="less">
.heatmap-container {
  position: relative;
  width: 100%;
  height: 500px;
}

.heatmap-canvas {
  position: absolute;
  top: 0;
  left: 0;
}
</style>
```

### 2. 热力图颜色渐变注意事项

#### ❌ 错误用法：硬编码颜色值
```javascript
// 错误：颜色值硬编码，不易维护和调整
const getColor = (value) => {
  if (value > 40) return 'red';
  if (value > 30) return 'orange';
  return 'yellow';
};
```

#### ✅ 正确用法：使用配置化的颜色渐变方案
```javascript
// src/utils/color-gradient.js
export const ColorGradients = {
  // 温度渐变 (蓝-绿-黄-红)
  temperature: [
    { offset: 0, color: 'rgba(0, 0, 255, 0.6)' },    // 蓝色 - 冷
    { offset: 0.33, color: 'rgba(0, 255, 0, 0.6)' }, // 绿色
    { offset: 0.66, color: 'rgba(255, 255, 0, 0.6)' }, // 黄色
    { offset: 1, color: 'rgba(255, 0, 0, 0.8)' }      // 红色 - 热
  ],

  // 人流密度渐变 (绿-黄-橙-红)
  density: [
    { offset: 0, color: 'rgba(76, 175, 80, 0.5)' },   // 绿色 - 稀疏
    { offset: 0.4, color: 'rgba(255, 235, 59, 0.6)' }, // 黄色
    { offset: 0.7, color: 'rgba(255, 152, 0, 0.7)' },  // 橙色
    { offset: 1, color: 'rgba(244, 67, 54, 0.8)' }     // 红色 - 密集
  ],

  // 活跃度渐变 (灰-蓝-紫-红)
  activity: [
    { offset: 0, color: 'rgba(158, 158, 158, 0.4)' }, // 灰色 - 低活跃
    { offset: 0.33, color: 'rgba(33, 150, 243, 0.6)' }, // 蓝色
    { offset: 0.66, color: 'rgba(156, 39, 176, 0.7)' }, // 紫色
    { offset: 1, color: 'rgba(233, 30, 99, 0.8)' }      // 红色 - 高活跃
  ]
};

// 创建Canvas渐变
export const createCanvasGradient = (ctx, x0, y0, x1, y1, gradientColors) => {
  const gradient = ctx.createLinearGradient(x0, y0, x1, y1);

  gradientColors.forEach(({ offset, color }) => {
    gradient.addColorStop(offset, color);
  });

  return gradient;
};

// 根据数值获取插值颜色
export const interpolateColor = (value, min, max, gradientColors) => {
  const normalized = (value - min) / (max - min);
  const clampedValue = Math.max(0, Math.min(1, normalized));

  // 找到对应的颜色区间
  for (let i = 0; i < gradientColors.length - 1; i++) {
    const start = gradientColors[i];
    const end = gradientColors[i + 1];

    if (clampedValue >= start.offset && clampedValue <= end.offset) {
      const segmentProgress = (clampedValue - start.offset) / (end.offset - start.offset);
      return blendColors(start.color, end.color, segmentProgress);
    }
  }

  return gradientColors[gradientColors.length - 1].color;
};

// 颜色混合函数
const blendColors = (color1, color2, ratio) => {
  const c1 = parseRGBA(color1);
  const c2 = parseRGBA(color2);

  const r = Math.round(c1.r + (c2.r - c1.r) * ratio);
  const g = Math.round(c1.g + (c2.g - c1.g) * ratio);
  const b = Math.round(c1.b + (c2.b - c1.b) * ratio);
  const a = c1.a + (c2.a - c1.a) * ratio;

  return `rgba(${r}, ${g}, ${b}, ${a})`;
};

// 解析RGBA颜色
const parseRGBA = (color) => {
  const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+),?\s*([\d.]+)?\)/);
  return {
    r: parseInt(match[1]),
    g: parseInt(match[2]),
    b: parseInt(match[3]),
    a: parseFloat(match[4] || 1)
  };
};
```

### 3. ECharts热力图配置注意事项

#### ✅ 正确：时间热力图配置
```javascript
// src/utils/echarts-heatmap-config.js
export const createTimeHeatmapOption = (data, config = {}) => {
  const {
    title = '24小时热力分布',
    xAxisData = [],
    yAxisData = [],
    seriesData = [],
    colorRange = ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8',
                  '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
  } = config;

  return {
    title: {
      text: title,
      left: 'center',
      textStyle: {
        fontSize: 16,
        color: '#333',
        fontWeight: 500
      }
    },
    tooltip: {
      position: 'top',
      formatter: (params) => {
        const { data } = params;
        return `${xAxisData[data[0]]} ${yAxisData[data[1]]}<br/>热度值: ${data[2]}`;
      }
    },
    grid: {
      left: 80,
      right: 40,
      top: 80,
      bottom: 40
    },
    xAxis: {
      type: 'category',
      data: xAxisData,
      splitArea: {
        show: true
      },
      axisLabel: {
        color: '#666',
        fontSize: 12
      }
    },
    yAxis: {
      type: 'category',
      data: yAxisData,
      splitArea: {
        show: true
      },
      axisLabel: {
        color: '#666',
        fontSize: 12
      }
    },
    visualMap: {
      min: 0,
      max: 100,
      calculable: true,
      orient: 'horizontal',
      left: 'center',
      bottom: 0,
      inRange: {
        color: colorRange
      },
      textStyle: {
        color: '#666'
      }
    },
    series: [{
      name: '热度值',
      type: 'heatmap',
      data: seriesData,
      label: {
        show: true,
        formatter: (params) => params.value[2]
      },
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }]
  };
};
```

### 4. 图标使用注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import {
  HeatmapOutlined,     // ❌ 不存在
  TemperatureOutlined, // ❌ 不存在
  HotspotOutlined      // ❌ 不存在
} from '@ant-design/icons-vue';
</script>
```

#### ✅ 正确：使用实际存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  FireOutlined,           // ✅ 热力/火焰图标
  DashboardOutlined,      // ✅ 仪表盘/热力图
  EnvironmentOutlined,    // ✅ 位置/空间热力图
  ClockCircleOutlined,    // ✅ 时间热力图
  AreaChartOutlined,      // ✅ 区域图表
  HeatMapOutlined,        // ✅ 热力图(注意拼写)
  FilterOutlined,         // ✅ 筛选
  ReloadOutlined,         // ✅ 刷新
  DownloadOutlined,       // ✅ 导出
  SettingOutlined,        // ✅ 设置
  EyeOutlined,            // ✅ 查看
  FullscreenOutlined,     // ✅ 全屏
  CameraOutlined,         // ✅ 摄像机
  PlayCircleOutlined,     // ✅ 播放
  PauseCircleOutlined,    // ✅ 暂停
} from '@ant-design/icons-vue';
</script>
```

### 5. Canvas性能优化注意事项

#### ✅ 正确：优化Canvas绘制性能
```javascript
// src/hooks/useCanvasHeatmap.js
import { ref, onMounted, onUnmounted } from 'vue';

export const useCanvasHeatmap = (canvasRef, options = {}) => {
  const {
    gradientColors = ColorGradients.density,
    blurRadius = 15,
    maxOpacity = 0.8,
    minOpacity = 0.3
  } = options;

  let offscreenCanvas = null;
  let offscreenCtx = null;

  // 初始化离屏Canvas (性能优化)
  const initOffscreenCanvas = (width, height) => {
    offscreenCanvas = document.createElement('canvas');
    offscreenCanvas.width = width;
    offscreenCanvas.height = height;
    offscreenCtx = offscreenCanvas.getContext('2d');
  };

  // 绘制热点 (使用径向渐变)
  const drawHotspot = (ctx, x, y, value, radius) => {
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);

    // 根据value值调整不透明度
    const opacity = minOpacity + (maxOpacity - minOpacity) * (value / 100);

    gradient.addColorStop(0, `rgba(255, 0, 0, ${opacity})`);
    gradient.addColorStop(0.5, `rgba(255, 100, 0, ${opacity * 0.5})`);
    gradient.addColorStop(1, `rgba(255, 200, 0, 0)`);

    ctx.fillStyle = gradient;
    ctx.fillRect(x - radius, y - radius, radius * 2, radius * 2);
  };

  // 应用模糊效果
  const applyBlur = (ctx, width, height) => {
    ctx.globalAlpha = 1;
    ctx.filter = `blur(${blurRadius}px)`;
  };

  // 批量绘制热点 (性能优化)
  const drawHeatpoints = (heatpoints) => {
    if (!canvasRef.value || !offscreenCanvas) return;

    const canvas = canvasRef.value;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    // 清空画布
    ctx.clearRect(0, 0, width, height);
    offscreenCtx.clearRect(0, 0, width, height);

    // 在离屏Canvas上绘制热点
    offscreenCtx.globalCompositeOperation = 'lighter';
    heatpoints.forEach(point => {
      drawHotspot(offscreenCtx, point.x, point.y, point.value, point.radius || 50);
    });

    // 应用模糊
    applyBlur(offscreenCtx, width, height);

    // 将离屏Canvas绘制到主Canvas
    ctx.drawImage(offscreenCanvas, 0, 0);
  };

  // 使用requestAnimationFrame优化动画
  let animationFrameId = null;
  const scheduleRender = (heatpoints) => {
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
    }

    animationFrameId = requestAnimationFrame(() => {
      drawHeatpoints(heatpoints);
      animationFrameId = null;
    });
  };

  onUnmounted(() => {
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
    }
  });

  return {
    drawHeatpoints,
    scheduleRender,
    initOffscreenCanvas
  };
};
```

## 核心功能模块

### 1. 查询条件区域

**位置**: 页面顶部

**功能说明**:
- 设备选择：选择监控设备
- 通道选择：选择设备下的具体通道
- 统计方式：日报/周报/月报
- 统计日期：选择统计的时间范围
- 热度图类型：时间热度图/空间热度图切换

**技术实现**:
```vue
<!-- src/views/business/smart-video/heat-statistics.vue -->
<template>
  <div class="heat-statistics-page">
    <!-- 页面标题 -->
    <div class="page-header">
      <h2 class="page-title">
        <FireOutlined class="title-icon" />
        热力图分析
      </h2>
      <div class="header-actions">
        <a-button @click="handleRefresh" :loading="refreshing">
          <template #icon><ReloadOutlined /></template>
          刷新
        </a-button>
      </div>
    </div>

    <!-- 查询条件区域 -->
    <a-card :bordered="false" class="query-card">
      <template #title>
        <FilterOutlined class="card-icon" />
        统计条件
      </template>

      <a-form layout="inline" :model="queryForm">
        <a-row :gutter="[16, 16]" style="width: 100%;">
          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="设备名称" name="deviceId">
              <a-select
                v-model:value="queryForm.deviceId"
                placeholder="请选择设备"
                @change="handleDeviceChange"
                style="width: 100%;"
              >
                <a-select-option
                  v-for="device in deviceList"
                  :key="device.id"
                  :value="device.id"
                >
                  {{ device.name }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="通道名称" name="channelId">
              <a-select
                v-model:value="queryForm.channelId"
                placeholder="请选择通道"
                :disabled="!queryForm.deviceId"
                style="width: 100%;"
              >
                <a-select-option
                  v-for="channel in channelList"
                  :key="channel.id"
                  :value="channel.id"
                >
                  {{ channel.name }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="统计方式" name="statisticsType">
              <a-select v-model:value="queryForm.statisticsType" style="width: 100%;">
                <a-select-option value="day">日报</a-select-option>
                <a-select-option value="week">周报</a-select-option>
                <a-select-option value="month">月报</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="统计日期" name="statisticsDate">
              <a-date-picker
                v-model:value="queryForm.statisticsDate"
                style="width: 100%;"
                format="YYYY-MM-DD"
              />
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="热度图类型" name="heatmapType">
              <a-select v-model:value="queryForm.heatmapType" @change="handleHeatmapTypeChange" style="width: 100%;">
                <a-select-option value="time">
                  <ClockCircleOutlined /> 时间热度图
                </a-select-option>
                <a-select-option value="space">
                  <EnvironmentOutlined /> 空间热度图
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :lg="4">
            <a-space>
              <a-button type="primary" @click="handleQuery" :loading="loading">
                <template #icon><SearchOutlined /></template>
                查询统计
              </a-button>
              <a-button @click="handleReset">
                <template #icon><RedoOutlined /></template>
                重置
              </a-button>
              <a-button type="primary" ghost @click="handleExport" :loading="exporting">
                <template #icon><DownloadOutlined /></template>
                导出
              </a-button>
            </a-space>
          </a-col>
        </a-row>
      </a-form>
    </a-card>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import dayjs from 'dayjs';
import {
  FireOutlined,
  FilterOutlined,
  ReloadOutlined,
  SearchOutlined,
  RedoOutlined,
  DownloadOutlined,
  ClockCircleOutlined,
  EnvironmentOutlined,
} from '@ant-design/icons-vue';
import { heatmapApi } from '/@/api/business/smart-video/heatmap-api';

// 查询表单
const queryForm = reactive({
  deviceId: undefined,
  channelId: undefined,
  statisticsType: 'day',
  statisticsDate: dayjs(),
  heatmapType: 'time'
});

// 设备列表
const deviceList = ref([]);
const channelList = ref([]);

// 加载状态
const loading = ref(false);
const refreshing = ref(false);
const exporting = ref(false);

// 加载设备列表
const loadDeviceList = async () => {
  try {
    const response = await heatmapApi.getDeviceList();
    deviceList.value = response.data || [];
  } catch (error) {
    console.error('加载设备列表失败:', error);
    message.error('加载设备列表失败');
  }
};

// 设备变化处理
const handleDeviceChange = async (deviceId) => {
  queryForm.channelId = undefined;
  channelList.value = [];

  if (!deviceId) return;

  try {
    const response = await heatmapApi.getDeviceChannels(deviceId);
    channelList.value = response.data || [];
  } catch (error) {
    console.error('加载通道列表失败:', error);
    message.error('加载通道列表失败');
  }
};

// 热度图类型变化处理
const handleHeatmapTypeChange = (type) => {
  console.log('切换热度图类型:', type);
};

// 查询处理
const handleQuery = async () => {
  if (!queryForm.deviceId || !queryForm.channelId) {
    message.warning('请选择设备和通道');
    return;
  }

  loading.value = true;
  try {
    if (queryForm.heatmapType === 'time') {
      await loadTimeHeatmapData();
    } else {
      await loadSpaceHeatmapData();
    }
  } catch (error) {
    console.error('查询失败:', error);
    message.error('查询失败');
  } finally {
    loading.value = false;
  }
};

// 重置处理
const handleReset = () => {
  queryForm.deviceId = undefined;
  queryForm.channelId = undefined;
  queryForm.statisticsType = 'day';
  queryForm.statisticsDate = dayjs();
  queryForm.heatmapType = 'time';
  channelList.value = [];
};

// 刷新处理
const handleRefresh = async () => {
  refreshing.value = true;
  try {
    await handleQuery();
    message.success('刷新成功');
  } finally {
    refreshing.value = false;
  }
};

// 导出处理
const handleExport = async () => {
  if (!queryForm.deviceId || !queryForm.channelId) {
    message.warning('请先查询数据');
    return;
  }

  exporting.value = true;
  try {
    const response = await heatmapApi.exportHeatmapData({
      deviceId: queryForm.deviceId,
      channelId: queryForm.channelId,
      statisticsType: queryForm.statisticsType,
      statisticsDate: queryForm.statisticsDate.format('YYYY-MM-DD'),
      heatmapType: queryForm.heatmapType
    });

    // 创建下载链接
    const blob = new Blob([response], { type: 'application/vnd.ms-excel' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `热力图数据_${dayjs().format('YYYYMMDDHHmmss')}.xlsx`;
    link.click();
    window.URL.revokeObjectURL(url);

    message.success('导出成功');
  } catch (error) {
    console.error('导出失败:', error);
    message.error('导出失败');
  } finally {
    exporting.value = false;
  }
};

onMounted(() => {
  loadDeviceList();
});
</script>

<style scoped lang="less">
.heat-statistics-page {
  padding: 16px;
  background: #f0f2f5;
  min-height: 100vh;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.page-title {
  font-size: 24px;
  font-weight: 600;
  color: #262626;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;

  .title-icon {
    color: #ff6b6b;
    font-size: 28px;
  }
}

.query-card {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 16px;

  .card-icon {
    color: #1890ff;
    margin-right: 8px;
  }
}
</style>
```

### 2. 时间热力图组件

**位置**: 统计结果区域

**功能说明**:
- 展示24小时、7天或30天的温度/热度变化趋势
- 使用ECharts折线图+面积图展示
- 支持平均线和警戒线标注
- 支持图表交互(tooltip、zoom等)

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/TimeHeatmapChart.vue -->
<template>
  <a-card :bordered="false" class="chart-card">
    <template #title>
      <ClockCircleOutlined class="card-icon" />
      时间热度图
    </template>

    <div v-if="!hasData" class="empty-container">
      <a-empty description="暂无数据，请选择条件后查询" />
    </div>

    <div v-else ref="chartRef" class="chart-container"></div>
  </a-card>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch } from 'vue';
import * as echarts from 'echarts';
import { ClockCircleOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  data: {
    type: Object,
    default: () => ({
      hours: [],
      temperatures: []
    })
  },
  loading: {
    type: Boolean,
    default: false
  }
});

const chartRef = ref(null);
let chartInstance = null;
const hasData = ref(false);

// 初始化图表
const initChart = () => {
  if (!chartRef.value) return;

  chartInstance = echarts.init(chartRef.value);

  const option = {
    title: {
      text: '24小时温度变化趋势',
      left: 'center',
      textStyle: {
        fontSize: 16,
        color: '#333',
        fontWeight: 500
      }
    },
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(0, 0, 0, 0.8)',
      borderColor: 'transparent',
      textStyle: {
        color: '#fff'
      },
      formatter: (params) => {
        const time = params[0].axisValue;
        const temp = params[0].value;
        return `${time}<br/>温度: ${temp}°C`;
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '10%',
      top: '15%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: props.data.hours,
      boundaryGap: false,
      axisLabel: {
        rotate: 45,
        color: '#666',
        fontSize: 11
      },
      axisLine: {
        lineStyle: {
          color: '#e8e8e8'
        }
      }
    },
    yAxis: {
      type: 'value',
      name: '温度(°C)',
      nameLocation: 'middle',
      nameGap: 50,
      nameTextStyle: {
        color: '#666',
        fontSize: 12
      },
      axisLabel: {
        color: '#666',
        fontSize: 11
      },
      axisLine: {
        show: false
      },
      splitLine: {
        lineStyle: {
          color: '#f0f0f0'
        }
      }
    },
    series: [{
      name: '温度',
      type: 'line',
      smooth: true,
      symbol: 'circle',
      symbolSize: 6,
      data: props.data.temperatures,
      lineStyle: {
        color: '#ff6b6b',
        width: 3
      },
      itemStyle: {
        color: '#ff6b6b',
        borderColor: '#fff',
        borderWidth: 2
      },
      areaStyle: {
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: 'rgba(255, 107, 107, 0.3)' },
          { offset: 1, color: 'rgba(255, 107, 107, 0.05)' }
        ])
      },
      markLine: {
        silent: true,
        symbol: 'none',
        label: {
          position: 'end',
          formatter: '{b}: {c}°C'
        },
        data: [
          {
            type: 'average',
            name: '平均温度',
            lineStyle: {
              color: '#52c41a',
              type: 'dashed',
              width: 2
            },
            label: {
              color: '#52c41a'
            }
          },
          {
            yAxis: 37.3,
            name: '警戒线',
            lineStyle: {
              color: '#ff9800',
              type: 'dashed',
              width: 2
            },
            label: {
              color: '#ff9800'
            }
          }
        ]
      },
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(255, 107, 107, 0.5)'
        }
      }
    }]
  };

  chartInstance.setOption(option);
};

// 更新图表数据
const updateChart = () => {
  if (!chartInstance || !props.data.hours.length) return;

  hasData.value = props.data.hours.length > 0;

  chartInstance.setOption({
    xAxis: {
      data: props.data.hours
    },
    series: [{
      data: props.data.temperatures
    }]
  }, { notMerge: false });
};

// 监听窗口大小变化
const handleResize = () => {
  chartInstance?.resize();
};

// 监听数据变化
watch(() => props.data, () => {
  if (props.data.hours.length > 0) {
    if (!chartInstance) {
      initChart();
    }
    updateChart();
  }
}, { deep: true });

onMounted(() => {
  if (props.data.hours.length > 0) {
    hasData.value = true;
    initChart();
  }
  window.addEventListener('resize', handleResize);
});

onUnmounted(() => {
  if (chartInstance) {
    chartInstance.dispose();
    chartInstance = null;
  }
  window.removeEventListener('resize', handleResize);
});
</script>

<style scoped lang="less">
.chart-card {
  height: 100%;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

  .card-icon {
    color: #1890ff;
    margin-right: 8px;
  }
}

.empty-container {
  height: 400px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.chart-container {
  width: 100%;
  height: 400px;
}
</style>
```

### 3. 空间热力图组件

**位置**: 统计结果区域

**功能说明**:
- 在监控画面背景上叠加热力图
- 显示空间位置的热度分布
- 支持自定义热点大小和颜色
- 显示热度图例说明

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/SpaceHeatmapCanvas.vue -->
<template>
  <a-card :bordered="false" class="chart-card">
    <template #title>
      <EnvironmentOutlined class="card-icon" />
      空间热度图
    </template>

    <div class="heatmap-wrapper">
      <div v-if="!hasData" class="empty-container">
        <a-empty description="暂无数据，请选择条件后查询" />
      </div>

      <div v-else class="heatmap-container">
        <!-- 背景图片 -->
        <img
          ref="bgImageRef"
          :src="backgroundImage"
          alt="监控画面"
          class="background-image"
          @load="handleImageLoad"
        />

        <!-- 热力图Canvas -->
        <canvas
          ref="canvasRef"
          class="heatmap-canvas"
        ></canvas>

        <!-- 热度图例 -->
        <div class="heatmap-legend">
          <div class="legend-title">热度分布</div>
          <div class="legend-gradient"></div>
          <div class="legend-labels">
            <span>低</span>
            <span>中</span>
            <span>高</span>
          </div>
        </div>

        <!-- 控制按钮 -->
        <div class="heatmap-controls">
          <a-space>
            <a-button size="small" @click="handleToggleHeatmap">
              <template #icon>
                <EyeOutlined v-if="showHeatmap" />
                <EyeInvisibleOutlined v-else />
              </template>
              {{ showHeatmap ? '隐藏' : '显示' }}热力图
            </a-button>
            <a-button size="small" @click="handleDownloadImage">
              <template #icon><DownloadOutlined /></template>
              下载图片
            </a-button>
          </a-space>
        </div>
      </div>
    </div>
  </a-card>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  EnvironmentOutlined,
  EyeOutlined,
  EyeInvisibleOutlined,
  DownloadOutlined
} from '@ant-design/icons-vue';
import { useCanvasHeatmap } from '/@/hooks/useCanvasHeatmap';
import { ColorGradients } from '/@/utils/color-gradient';

const props = defineProps({
  data: {
    type: Object,
    default: () => ({
      backgroundImage: '',
      heatpoints: []
    })
  },
  loading: {
    type: Boolean,
    default: false
  }
});

const bgImageRef = ref(null);
const canvasRef = ref(null);
const hasData = ref(false);
const showHeatmap = ref(true);
const backgroundImage = ref('');

const { drawHeatpoints, initOffscreenCanvas } = useCanvasHeatmap(canvasRef, {
  gradientColors: ColorGradients.density,
  blurRadius: 20,
  maxOpacity: 0.8
});

// 图片加载完成处理
const handleImageLoad = () => {
  if (!bgImageRef.value || !canvasRef.value) return;

  const img = bgImageRef.value;
  const canvas = canvasRef.value;

  // 设置Canvas尺寸与图片一致
  const rect = img.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.style.width = `${rect.width}px`;
  canvas.style.height = `${rect.height}px`;

  // 初始化离屏Canvas
  initOffscreenCanvas(canvas.width, canvas.height);

  // 绘制热力图
  if (props.data.heatpoints.length > 0) {
    renderHeatmap();
  }
};

// 渲染热力图
const renderHeatmap = () => {
  if (!canvasRef.value || !props.data.heatpoints.length) return;

  const canvas = canvasRef.value;
  const dpr = window.devicePixelRatio || 1;

  // 转换热点坐标(考虑设备像素比)
  const scaledHeatpoints = props.data.heatpoints.map(point => ({
    x: point.x * dpr,
    y: point.y * dpr,
    value: point.value,
    radius: (point.radius || 50) * dpr
  }));

  drawHeatpoints(scaledHeatpoints);
};

// 切换热力图显示
const handleToggleHeatmap = () => {
  showHeatmap.value = !showHeatmap.value;

  if (canvasRef.value) {
    canvasRef.value.style.display = showHeatmap.value ? 'block' : 'none';
  }
};

// 下载图片
const handleDownloadImage = () => {
  if (!canvasRef.value || !bgImageRef.value) return;

  try {
    // 创建临时Canvas合并背景和热力图
    const tempCanvas = document.createElement('canvas');
    const bgImg = bgImageRef.value;

    tempCanvas.width = bgImg.naturalWidth;
    tempCanvas.height = bgImg.naturalHeight;

    const ctx = tempCanvas.getContext('2d');

    // 绘制背景图片
    ctx.drawImage(bgImg, 0, 0);

    // 绘制热力图
    if (showHeatmap.value) {
      ctx.drawImage(canvasRef.value, 0, 0, tempCanvas.width, tempCanvas.height);
    }

    // 转换为下载链接
    tempCanvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `热力图_${Date.now()}.png`;
      link.click();
      URL.revokeObjectURL(url);

      message.success('图片下载成功');
    }, 'image/png');
  } catch (error) {
    console.error('下载图片失败:', error);
    message.error('下载图片失败');
  }
};

// 监听窗口大小变化
const handleResize = () => {
  if (bgImageRef.value) {
    handleImageLoad();
  }
};

// 监听数据变化
watch(() => props.data, (newData) => {
  if (newData.backgroundImage && newData.heatpoints.length > 0) {
    hasData.value = true;
    backgroundImage.value = newData.backgroundImage;
  }
}, { deep: true });

onMounted(() => {
  if (props.data.backgroundImage && props.data.heatpoints.length > 0) {
    hasData.value = true;
    backgroundImage.value = props.data.backgroundImage;
  }

  window.addEventListener('resize', handleResize);
});

onUnmounted(() => {
  window.removeEventListener('resize', handleResize);
});

defineExpose({
  renderHeatmap
});
</script>

<style scoped lang="less">
.chart-card {
  height: 100%;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

  .card-icon {
    color: #52c41a;
    margin-right: 8px;
  }
}

.heatmap-wrapper {
  min-height: 500px;
}

.empty-container {
  height: 500px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.heatmap-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #000;
  border-radius: 4px;
  overflow: hidden;
}

.background-image {
  display: block;
  max-width: 100%;
  max-height: 600px;
  object-fit: contain;
}

.heatmap-canvas {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.heatmap-legend {
  position: absolute;
  top: 16px;
  right: 16px;
  background: rgba(255, 255, 255, 0.95);
  padding: 12px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  min-width: 100px;

  .legend-title {
    font-size: 12px;
    font-weight: 500;
    color: #333;
    margin-bottom: 8px;
    text-align: center;
  }

  .legend-gradient {
    width: 30px;
    height: 120px;
    background: linear-gradient(
      to bottom,
      rgba(255, 0, 0, 0.8),
      rgba(255, 152, 0, 0.7),
      rgba(255, 235, 59, 0.6),
      rgba(76, 175, 80, 0.5)
    );
    border-radius: 4px;
    margin: 0 auto 8px;
  }

  .legend-labels {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    color: #666;
    text-align: center;

    span:first-child {
      order: 3;
    }

    span:nth-child(2) {
      order: 2;
    }

    span:last-child {
      order: 1;
    }
  }
}

.heatmap-controls {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
</style>
```

### 4. 热力图数据Hook

**功能说明**:
- 封装热力图数据处理逻辑
- 提供数据获取和转换方法
- 支持数据缓存和更新

**技术实现**:
```javascript
// src/hooks/useHeatmapData.js
import { ref, reactive } from 'vue';
import { message } from 'ant-design-vue';
import { heatmapApi } from '/@/api/business/smart-video/heatmap-api';

export const useHeatmapData = () => {
  const loading = ref(false);

  const timeHeatmapData = reactive({
    hours: [],
    temperatures: []
  });

  const spaceHeatmapData = reactive({
    backgroundImage: '',
    heatpoints: []
  });

  // 加载时间热力图数据
  const loadTimeHeatmapData = async (params) => {
    loading.value = true;

    try {
      const response = await heatmapApi.getTimeHeatmapData(params);

      if (response.code === 0 && response.data) {
        timeHeatmapData.hours = response.data.hours || [];
        timeHeatmapData.temperatures = response.data.temperatures || [];

        return true;
      } else {
        message.error(response.message || '获取数据失败');
        return false;
      }
    } catch (error) {
      console.error('加载时间热力图数据失败:', error);
      message.error('加载数据失败');
      return false;
    } finally {
      loading.value = false;
    }
  };

  // 加载空间热力图数据
  const loadSpaceHeatmapData = async (params) => {
    loading.value = true;

    try {
      const response = await heatmapApi.getSpaceHeatmapData(params);

      if (response.code === 0 && response.data) {
        spaceHeatmapData.backgroundImage = response.data.backgroundImage || '';
        spaceHeatmapData.heatpoints = response.data.heatpoints || [];

        return true;
      } else {
        message.error(response.message || '获取数据失败');
        return false;
      }
    } catch (error) {
      console.error('加载空间热力图数据失败:', error);
      message.error('加载数据失败');
      return false;
    } finally {
      loading.value = false;
    }
  };

  // 生成模拟时间热力图数据
  const generateMockTimeData = () => {
    const hours = [];
    const temperatures = [];

    for (let i = 0; i < 24; i++) {
      hours.push(`${i.toString().padStart(2, '0')}:00`);

      // 模拟温度数据 - 早上和晚上较低，中午较高
      const temp = 35 + Math.sin((i - 6) * Math.PI / 12) * 8 + Math.random() * 3;
      temperatures.push(parseFloat(temp.toFixed(1)));
    }

    timeHeatmapData.hours = hours;
    timeHeatmapData.temperatures = temperatures;
  };

  // 生成模拟空间热力图数据
  const generateMockSpaceData = () => {
    // 使用模拟图片
    spaceHeatmapData.backgroundImage = 'https://picsum.photos/seed/heatmap/800/600';

    // 生成随机热点
    const heatpoints = [];
    const pointCount = 8 + Math.floor(Math.random() * 5);

    for (let i = 0; i < pointCount; i++) {
      heatpoints.push({
        x: 100 + Math.random() * 600,
        y: 100 + Math.random() * 400,
        value: 30 + Math.random() * 70,
        radius: 40 + Math.random() * 30
      });
    }

    spaceHeatmapData.heatpoints = heatpoints;
  };

  // 清空数据
  const clearData = () => {
    timeHeatmapData.hours = [];
    timeHeatmapData.temperatures = [];
    spaceHeatmapData.backgroundImage = '';
    spaceHeatmapData.heatpoints = [];
  };

  return {
    loading,
    timeHeatmapData,
    spaceHeatmapData,
    loadTimeHeatmapData,
    loadSpaceHeatmapData,
    generateMockTimeData,
    generateMockSpaceData,
    clearData
  };
};
```

## 完整页面组装

```vue
<!-- src/views/business/smart-video/heat-statistics.vue -->
<template>
  <div class="heat-statistics-page">
    <!-- 页面标题 -->
    <div class="page-header">
      <h2 class="page-title">
        <FireOutlined class="title-icon" />
        热力图分析
      </h2>
      <div class="header-actions">
        <a-space>
          <a-button @click="handleRefresh" :loading="refreshing">
            <template #icon><ReloadOutlined /></template>
            刷新
          </a-button>
          <a-button type="primary" ghost @click="handleSettings">
            <template #icon><SettingOutlined /></template>
            设置
          </a-button>
        </a-space>
      </div>
    </div>

    <!-- 查询条件区域 -->
    <a-card :bordered="false" class="query-card">
      <template #title>
        <FilterOutlined class="card-icon" />
        统计条件
      </template>

      <a-form layout="inline" :model="queryForm">
        <a-row :gutter="[16, 16]" style="width: 100%;">
          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="设备名称" name="deviceId">
              <a-select
                v-model:value="queryForm.deviceId"
                placeholder="请选择设备"
                @change="handleDeviceChange"
                style="width: 100%;"
              >
                <a-select-option
                  v-for="device in deviceList"
                  :key="device.id"
                  :value="device.id"
                >
                  {{ device.name }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="通道名称" name="channelId">
              <a-select
                v-model:value="queryForm.channelId"
                placeholder="请选择通道"
                :disabled="!queryForm.deviceId"
                style="width: 100%;"
              >
                <a-select-option
                  v-for="channel in channelList"
                  :key="channel.id"
                  :value="channel.id"
                >
                  {{ channel.name }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="统计方式" name="statisticsType">
              <a-select v-model:value="queryForm.statisticsType" style="width: 100%;">
                <a-select-option value="day">日报</a-select-option>
                <a-select-option value="week">周报</a-select-option>
                <a-select-option value="month">月报</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="统计日期" name="statisticsDate">
              <a-date-picker
                v-model:value="queryForm.statisticsDate"
                style="width: 100%;"
                format="YYYY-MM-DD"
              />
            </a-form-item>
          </a-col>

          <a-col :xs="24" :sm="12" :md="8" :lg="4">
            <a-form-item label="热度图类型" name="heatmapType">
              <a-select v-model:value="queryForm.heatmapType" style="width: 100%;">
                <a-select-option value="time">
                  <ClockCircleOutlined /> 时间热度图
                </a-select-option>
                <a-select-option value="space">
                  <EnvironmentOutlined /> 空间热度图
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>

          <a-col :xs="24" :lg="4">
            <a-space>
              <a-button type="primary" @click="handleQuery" :loading="loading">
                <template #icon><SearchOutlined /></template>
                查询
              </a-button>
              <a-button @click="handleReset">
                <template #icon><RedoOutlined /></template>
                重置
              </a-button>
              <a-button type="primary" ghost @click="handleExport" :loading="exporting">
                <template #icon><DownloadOutlined /></template>
                导出
              </a-button>
            </a-space>
          </a-col>
        </a-row>
      </a-form>
    </a-card>

    <!-- 统计结果区域 -->
    <a-card :bordered="false" class="result-card">
      <template #title>
        <BarChartOutlined class="card-icon" />
        统计结果 - <span class="result-type">{{ resultTypeText }}</span>
      </template>

      <!-- 时间热力图 -->
      <TimeHeatmapChart
        v-if="queryForm.heatmapType === 'time'"
        :data="timeHeatmapData"
        :loading="loading"
      />

      <!-- 空间热力图 -->
      <SpaceHeatmapCanvas
        v-else
        :data="spaceHeatmapData"
        :loading="loading"
      />
    </a-card>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import dayjs from 'dayjs';
import {
  FireOutlined,
  FilterOutlined,
  ReloadOutlined,
  SettingOutlined,
  SearchOutlined,
  RedoOutlined,
  DownloadOutlined,
  ClockCircleOutlined,
  EnvironmentOutlined,
  BarChartOutlined,
} from '@ant-design/icons-vue';
import TimeHeatmapChart from './components/TimeHeatmapChart.vue';
import SpaceHeatmapCanvas from './components/SpaceHeatmapCanvas.vue';
import { useHeatmapData } from '/@/hooks/useHeatmapData';

// 使用热力图数据Hook
const {
  loading,
  timeHeatmapData,
  spaceHeatmapData,
  loadTimeHeatmapData,
  loadSpaceHeatmapData,
  generateMockTimeData,
  generateMockSpaceData,
  clearData
} = useHeatmapData();

// 查询表单
const queryForm = reactive({
  deviceId: undefined,
  channelId: undefined,
  statisticsType: 'day',
  statisticsDate: dayjs(),
  heatmapType: 'time'
});

// 设备列表
const deviceList = ref([
  { id: 'device001', name: '主楼-NVR800' },
  { id: 'device002', name: '仓库区-IVS1800' },
  { id: 'device003', name: '停车场-ZKNVR' }
]);

const channelList = ref([]);

// 加载状态
const refreshing = ref(false);
const exporting = ref(false);

// 结果类型文本
const resultTypeText = computed(() => {
  return queryForm.heatmapType === 'time' ? '时间热度图' : '空间热度图';
});

// 设备变化处理
const handleDeviceChange = (deviceId) => {
  queryForm.channelId = undefined;

  const channelMap = {
    'device001': [
      { id: 'ch001', name: 'Camera-001 前门' },
      { id: 'ch002', name: 'Camera-002 大厅' },
      { id: 'ch003', name: 'Camera-003 走廊' }
    ],
    'device002': [
      { id: 'ch016', name: 'Camera-016 仓库入口' },
      { id: 'ch017', name: 'Camera-017 仓储区A' }
    ],
    'device003': [
      { id: 'ch020', name: 'Camera-020 停车场入口' },
      { id: 'ch021', name: 'Camera-021 停车场出口' }
    ]
  };

  channelList.value = channelMap[deviceId] || [];
};

// 查询处理
const handleQuery = async () => {
  if (!queryForm.deviceId || !queryForm.channelId) {
    message.warning('请选择设备和通道');
    return;
  }

  // 这里使用模拟数据，实际项目中应调用API
  if (queryForm.heatmapType === 'time') {
    generateMockTimeData();
    message.success('时间热力图数据加载成功');
  } else {
    generateMockSpaceData();
    message.success('空间热力图数据加载成功');
  }
};

// 重置处理
const handleReset = () => {
  queryForm.deviceId = undefined;
  queryForm.channelId = undefined;
  queryForm.statisticsType = 'day';
  queryForm.statisticsDate = dayjs();
  queryForm.heatmapType = 'time';
  channelList.value = [];
  clearData();
};

// 刷新处理
const handleRefresh = async () => {
  if (!queryForm.deviceId || !queryForm.channelId) {
    message.warning('请先选择设备和通道');
    return;
  }

  refreshing.value = true;
  try {
    await handleQuery();
  } finally {
    refreshing.value = false;
  }
};

// 导出处理
const handleExport = async () => {
  if (!queryForm.deviceId || !queryForm.channelId) {
    message.warning('请先查询数据');
    return;
  }

  exporting.value = true;
  try {
    // 模拟导出
    await new Promise(resolve => setTimeout(resolve, 1500));
    message.success('导出成功');
  } catch (error) {
    message.error('导出失败');
  } finally {
    exporting.value = false;
  }
};

// 设置处理
const handleSettings = () => {
  message.info('设置功能开发中...');
};

onMounted(() => {
  // 初始化
});
</script>

<style scoped lang="less">
.heat-statistics-page {
  padding: 16px;
  background: #f0f2f5;
  min-height: 100vh;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.page-title {
  font-size: 24px;
  font-weight: 600;
  color: #262626;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;

  .title-icon {
    color: #ff6b6b;
    font-size: 28px;
  }
}

.query-card,
.result-card {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin-bottom: 16px;

  .card-icon {
    margin-right: 8px;
  }
}

.result-type {
  color: #1890ff;
  font-weight: 500;
}
</style>
```

## 路由配置

```javascript
// src/router/modules/business.js
export default [
  {
    path: '/business/smart-video',
    name: 'SmartVideo',
    component: () => import('/@/layout/index.vue'),
    meta: {
      title: '智能视频',
      icon: 'VideoCameraOutlined',
    },
    children: [
      {
        path: 'heat-statistics',
        name: 'HeatStatistics',
        component: () => import('/@/views/business/smart-video/heat-statistics.vue'),
        meta: {
          title: '热力图分析',
          icon: 'FireOutlined',
          keepAlive: true
        },
      },
      // 其他子路由...
    ],
  },
];
```

## 菜单配置

```javascript
// src/constants/menu-const.js
export const MENU_CONFIG = [
  {
    menuKey: 'smart-video',
    menuName: '智能视频',
    icon: 'VideoCameraOutlined',
    children: [
      {
        menuKey: 'heat-statistics',
        menuName: '热力图分析',
        path: '/business/smart-video/heat-statistics',
        icon: 'FireOutlined',
      },
      // 其他菜单项...
    ],
  },
];
```

## Mock数据示例

```javascript
// src/mock/business/smart-video/heatmap-mock.js
import { defineMock } from '/@/mock/base';

export default defineMock([
  {
    url: '/heatmap/time/data',
    method: 'post',
    response: ({ body }) => {
      const { statisticsType } = body;

      let hours = [];
      let temperatures = [];

      if (statisticsType === 'day') {
        // 24小时数据
        for (let i = 0; i < 24; i++) {
          hours.push(`${i.toString().padStart(2, '0')}:00`);
          const temp = 35 + Math.sin((i - 6) * Math.PI / 12) * 8 + Math.random() * 3;
          temperatures.push(parseFloat(temp.toFixed(1)));
        }
      } else if (statisticsType === 'week') {
        // 7天数据
        const days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
        hours = days;
        temperatures = days.map(() =>
          parseFloat((35 + Math.random() * 10).toFixed(1))
        );
      } else if (statisticsType === 'month') {
        // 30天数据
        for (let i = 1; i <= 30; i++) {
          hours.push(`${i}日`);
          temperatures.push(parseFloat((35 + Math.random() * 10).toFixed(1)));
        }
      }

      return {
        code: 0,
        message: 'success',
        data: {
          hours,
          temperatures
        }
      };
    }
  },
  {
    url: '/heatmap/space/data',
    method: 'post',
    response: () => {
      // 生成随机热点
      const heatpoints = [];
      const pointCount = 8 + Math.floor(Math.random() * 5);

      for (let i = 0; i < pointCount; i++) {
        heatpoints.push({
          x: 100 + Math.random() * 600,
          y: 100 + Math.random() * 400,
          value: 30 + Math.random() * 70,
          radius: 40 + Math.random() * 30
        });
      }

      return {
        code: 0,
        message: 'success',
        data: {
          backgroundImage: 'https://picsum.photos/seed/heatmap/800/600',
          heatpoints
        }
      };
    }
  },
  {
    url: '/heatmap/hotspot/analysis',
    method: 'post',
    response: () => {
      return {
        code: 0,
        message: 'success',
        data: {
          hotspots: [
            {
              id: 1,
              name: '区域A',
              x: 200,
              y: 150,
              avgValue: 85.5,
              maxValue: 92.3,
              frequency: 156
            },
            {
              id: 2,
              name: '区域B',
              x: 500,
              y: 300,
              avgValue: 72.8,
              maxValue: 81.2,
              frequency: 98
            }
          ]
        }
      };
    }
  },
  {
    url: '/heatmap/export',
    method: 'post',
    response: () => {
      // 实际应返回文件流
      return {
        code: 0,
        message: 'success'
      };
    }
  }
]);
```

## 最佳实践建议

### 1. Canvas性能优化
- **离屏Canvas**: 使用离屏Canvas进行复杂绘制，减少主Canvas的重绘次数
- **requestAnimationFrame**: 使用RAF优化动画渲染，避免掉帧
- **绘制缓存**: 对静态内容进行缓存，避免重复绘制
- **分层绘制**: 将背景图和热力图分层绘制，提高性能

### 2. 热力图可视化优化
- **颜色方案**: 选择合适的颜色渐变方案，确保视觉效果清晰
- **透明度控制**: 合理设置热点透明度，避免遮挡背景细节
- **模糊效果**: 适度使用模糊效果，使热力图更加自然
- **图例说明**: 提供清晰的图例说明，帮助用户理解数据

### 3. 数据处理优化
- **数据预处理**: 在前端进行必要的数据预处理和格式转换
- **数据缓存**: 对历史数据进行缓存，减少重复请求
- **增量更新**: 实时数据采用增量更新方式，提高效率
- **数据压缩**: 大量热点数据传输时考虑压缩

### 4. 用户体验优化
- **加载提示**: 数据加载时显示友好的加载动画
- **空状态**: 无数据时显示引导性的空状态提示
- **交互反馈**: 所有操作都应有明确的反馈
- **响应式设计**: 适配不同屏幕尺寸和设备

### 5. 导出功能优化
- **多格式支持**: 支持导出PNG、JPG、PDF等多种格式
- **自定义分辨率**: 允许用户选择导出图片的分辨率
- **数据导出**: 同时支持导出原始数据(Excel、CSV)
- **批量导出**: 支持批量导出多个时间段的热力图

## 常见问题与解决方案

### 问题1：Canvas绘制的热力图模糊
**原因**:
- 未考虑设备像素比(DPR)
- Canvas尺寸设置不正确

**解决方案**:
```javascript
const dpr = window.devicePixelRatio || 1;
canvas.width = container.width * dpr;
canvas.height = container.height * dpr;
canvas.style.width = `${container.width}px`;
canvas.style.height = `${container.height}px`;
ctx.scale(dpr, dpr);
```

### 问题2：热力图颜色渐变不自然
**原因**:
- 颜色节点设置不合理
- 未使用径向渐变

**解决方案**:
```javascript
// 使用径向渐变创建自然的热点效果
const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
gradient.addColorStop(0, 'rgba(255, 0, 0, 0.8)');
gradient.addColorStop(0.5, 'rgba(255, 100, 0, 0.5)');
gradient.addColorStop(1, 'rgba(255, 200, 0, 0)');
ctx.fillStyle = gradient;
```

### 问题3：热力图与背景图尺寸不匹配
**原因**:
- Canvas尺寸未与背景图同步
- 热点坐标未按比例缩放

**解决方案**:
```javascript
// 监听图片加载完成
img.onload = () => {
  const rect = img.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;

  // 按比例缩放热点坐标
  const scaleX = rect.width / img.naturalWidth;
  const scaleY = rect.height / img.naturalHeight;

  scaledHeatpoints = heatpoints.map(point => ({
    x: point.x * scaleX,
    y: point.y * scaleY,
    value: point.value,
    radius: point.radius * Math.min(scaleX, scaleY)
  }));
};
```

### 问题4：ECharts热力图数据显示不正确
**原因**:
- 数据格式不符合ECharts要求
- visualMap配置不正确

**解决方案**:
```javascript
// ECharts热力图数据格式: [x轴索引, y轴索引, 值]
const seriesData = [];
for (let i = 0; i < xAxisData.length; i++) {
  for (let j = 0; j < yAxisData.length; j++) {
    const value = dataMatrix[j][i]; // 注意行列顺序
    seriesData.push([i, j, value]);
  }
}

// visualMap配置
visualMap: {
  min: 0,
  max: 100,
  calculable: true,
  inRange: {
    color: ['#313695', '#4575b4', '#74add1', '#fee090', '#f46d43', '#a50026']
  }
}
```

### 问题5：热力图导出图片失败
**原因**:
- Canvas被跨域图片污染
- 未正确合并背景图和热力图

**解决方案**:
```javascript
// 使用CORS加载背景图
const img = new Image();
img.crossOrigin = 'anonymous';
img.src = backgroundUrl;

// 合并背景图和热力图导出
const tempCanvas = document.createElement('canvas');
const ctx = tempCanvas.getContext('2d');
tempCanvas.width = img.width;
tempCanvas.height = img.height;

// 绘制背景
ctx.drawImage(img, 0, 0);

// 绘制热力图
ctx.drawImage(heatmapCanvas, 0, 0, tempCanvas.width, tempCanvas.height);

// 导出
tempCanvas.toBlob(blob => {
  const url = URL.createObjectURL(blob);
  // 下载...
});
```

## 总结

热力图分析页面是智能视频监控系统的重要数据可视化工具,通过直观的热力图展示帮助用户快速识别热点区域和活动规律。在开发过程中需要特别注意:

1. **Canvas绘制优化** - 正确处理设备像素比、使用离屏Canvas提升性能
2. **颜色渐变设计** - 选择合适的配色方案,确保视觉效果清晰自然
3. **数据处理** - 合理处理热点数据,支持实时更新和历史回放
4. **交互体验** - 提供完善的交互功能(切换、导出、放大等)
5. **性能优化** - 优化Canvas绘制性能,确保流畅运行

遵循本文档的规范和最佳实践,可以快速开发出高质量、高性能的热力图分析页面,为用户提供强大的数据分析能力。
