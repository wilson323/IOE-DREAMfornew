# 视频回放页面功能与布局文档

## 页面概述
视频回放页面是智能视频监控系统中的核心功能界面，用于查询、检索和播放历史录像。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供完整的历史视频检索、播放、下载、剪辑等功能，支持多种时间范围查询、视频时间轴控制、播放进度管理等专业视频回放能力。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **视频播放器**: Video.js 8.x 或 西瓜播放器(XGPlayer) 3.x

### 项目文件组织结构
```
src/views/business/smart-video/
├── video-playback.vue                # 视频回放主页面
├── components/
│   ├── VideoPlayer.vue              # 视频播放器组件
│   ├── VideoTimeline.vue            # 视频时间轴组件
│   ├── RecordingSearchPanel.vue     # 录像搜索面板组件
│   ├── RecordingListItem.vue        # 录像列表项组件
│   ├── VideoClipModal.vue           # 视频剪辑弹窗组件
│   ├── BookmarkManageModal.vue      # 书签管理弹窗组件
│   └── DownloadTaskDrawer.vue       # 下载任务抽屉组件
├── mock/
│   └── playback-mock-data.js        # 模拟数据
└── api/
    └── playback-api.js              # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/playback-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const playbackApi = {
  // 查询录像列表
  queryRecordingList: (params) => postRequest('/recording/query', params),

  // 获取录像文件详情
  getRecordingDetail: (id) => getRequest(`/recording/detail/${id}`),

  // 获取录像播放地址
  getPlaybackUrl: (params) => postRequest('/recording/playback-url', params),

  // 搜索录像文件
  searchRecordings: (params) => postRequest('/recording/search', params),

  // 获取设备列表（用于下拉选择）
  getDeviceList: () => getRequest('/device/list'),

  // 下载录像文件
  downloadRecording: (params) => postRequest('/recording/download', params),

  // 创建剪辑任务
  createClipTask: (params) => postRequest('/recording/clip', params),

  // 添加书签
  addBookmark: (params) => postRequest('/recording/bookmark/add', params),

  // 删除书签
  deleteBookmark: (id) => getRequest(`/recording/bookmark/delete/${id}`),

  // 查询书签列表
  getBookmarkList: (params) => postRequest('/recording/bookmark/query', params),

  // 获取录像时间轴数据（某天某设备的录像时间段）
  getTimelineData: (params) => postRequest('/recording/timeline', params),

  // 获取下载任务列表
  getDownloadTasks: () => getRequest('/recording/download/tasks'),

  // 取消下载任务
  cancelDownloadTask: (taskId) => postRequest(`/recording/download/cancel/${taskId}`),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-drawer v-model:open="visible" title="下载任务">
    <!-- 内容 -->
  </a-drawer>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-drawer
    :open="visible"
    title="下载任务"
    @close="handleClose"
  >
    <!-- 内容 -->
  </a-drawer>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};
</script>
```

### 2. 图标导入注意事项

#### ✅ 正确：使用存在的图标
```vue
<script setup>
import {
  SearchOutlined,        // ✅ 搜索
  PlayCircleOutlined,    // ✅ 播放
  PauseCircleOutlined,   // ✅ 暂停
  DownloadOutlined,      // ✅ 下载
  ScissorOutlined,       // ✅ 剪辑
  BookOutlined,          // ✅ 书签
  ClockCircleOutlined,   // ✅ 时间
  CalendarOutlined,      // ✅ 日历
  VideoCameraOutlined,   // ✅ 摄像机
  SoundOutlined,         // ✅ 音量
  ExpandOutlined,        // ✅ 全屏
  CompressOutlined,      // ✅ 退出全屏
  FastForwardOutlined,   // ✅ 快进
  FastBackwardOutlined,  // ✅ 快退
  StepForwardOutlined,   // ✅ 下一帧
  StepBackwardOutlined,  // ✅ 上一帧
} from '@ant-design/icons-vue';
</script>
```

### 3. 日期时间选择器注意事项

#### ✅ 正确：使用Ant Design Vue的日期时间组件
```vue
<template>
  <!-- 日期选择 -->
  <a-date-picker
    v-model:value="searchForm.date"
    placeholder="请选择日期"
    format="YYYY-MM-DD"
    :disabled-date="disabledDate"
    style="width: 100%"
  />

  <!-- 时间范围选择 -->
  <a-time-range-picker
    v-model:value="searchForm.timeRange"
    format="HH:mm:ss"
    :placeholder="['开始时间', '结束时间']"
    style="width: 100%"
  />

  <!-- 或者分开使用两个时间选择器 -->
  <a-time-picker
    v-model:value="searchForm.startTime"
    placeholder="开始时间"
    format="HH:mm:ss"
  />
  <a-time-picker
    v-model:value="searchForm.endTime"
    placeholder="结束时间"
    format="HH:mm:ss"
  />
</template>

<script setup>
import { ref } from 'vue';
import dayjs from 'dayjs';

const searchForm = ref({
  date: dayjs(),
  timeRange: [dayjs().startOf('day'), dayjs().endOf('day')],
  startTime: dayjs().startOf('day'),
  endTime: dayjs().endOf('day'),
});

// 禁用未来日期
const disabledDate = (current) => {
  return current && current > dayjs().endOf('day');
};
</script>
```

### 4. 视频播放器集成注意事项

#### ✅ Video.js 集成方案
```vue
<template>
  <div class="video-player-wrapper">
    <video
      ref="videoRef"
      class="video-js vjs-default-skin"
      controls
      preload="auto"
      :poster="posterUrl"
    >
      <source :src="videoUrl" type="application/x-mpegURL" />
      您的浏览器不支持视频播放
    </video>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch } from 'vue';
import videojs from 'video.js';
import 'video.js/dist/video-js.css';

const props = defineProps({
  videoUrl: {
    type: String,
    required: true,
  },
  posterUrl: {
    type: String,
    default: '',
  },
  autoplay: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(['timeupdate', 'ended', 'error']);

const videoRef = ref(null);
let player = null;

onMounted(() => {
  if (videoRef.value) {
    // 初始化Video.js播放器
    player = videojs(videoRef.value, {
      controls: true,
      autoplay: props.autoplay,
      preload: 'auto',
      fluid: true,
      language: 'zh-CN',
      playbackRates: [0.5, 1, 1.5, 2], // 播放倍速
    });

    // 监听播放器事件
    player.on('timeupdate', () => {
      emit('timeupdate', player.currentTime());
    });

    player.on('ended', () => {
      emit('ended');
    });

    player.on('error', (error) => {
      emit('error', error);
    });
  }
});

onUnmounted(() => {
  if (player) {
    player.dispose();
  }
});

// 监听视频URL变化
watch(() => props.videoUrl, (newUrl) => {
  if (player && newUrl) {
    player.src({ src: newUrl, type: 'application/x-mpegURL' });
  }
});

// 暴露播放器控制方法
defineExpose({
  play: () => player?.play(),
  pause: () => player?.pause(),
  seek: (time) => player?.currentTime(time),
  getPlayer: () => player,
});
</script>

<style scoped lang="less">
.video-player-wrapper {
  width: 100%;
  height: 100%;
  background: #000;
}
</style>
```

#### ✅ 西瓜播放器(XGPlayer)集成方案（备选）
```vue
<template>
  <div ref="playerContainer" class="xgplayer-container"></div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch } from 'vue';
import Player from 'xgplayer';
import 'xgplayer/dist/index.min.css';

const props = defineProps({
  videoUrl: {
    type: String,
    required: true,
  },
  autoplay: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(['timeupdate', 'ended', 'error']);

const playerContainer = ref(null);
let player = null;

onMounted(() => {
  if (playerContainer.value && props.videoUrl) {
    player = new Player({
      el: playerContainer.value,
      url: props.videoUrl,
      autoplay: props.autoplay,
      playbackRate: [0.5, 1, 1.5, 2],
      lang: 'zh-cn',
      fluid: true,
    });

    player.on('timeupdate', () => {
      emit('timeupdate', player.currentTime);
    });

    player.on('ended', () => {
      emit('ended');
    });

    player.on('error', (error) => {
      emit('error', error);
    });
  }
});

onUnmounted(() => {
  if (player) {
    player.destroy();
  }
});

watch(() => props.videoUrl, (newUrl) => {
  if (player && newUrl) {
    player.src = newUrl;
  }
});

defineExpose({
  play: () => player?.play(),
  pause: () => player?.pause(),
  seek: (time) => { player.currentTime = time; },
});
</script>

<style scoped lang="less">
.xgplayer-container {
  width: 100%;
  height: 100%;
}
</style>
```

## 核心功能模块

### 1. 录像搜索面板（左侧）
**位置**: 页面左侧固定区域，宽度约320px

**功能说明**:
- 设备选择：支持下拉选择要查看录像的设备
- 时间范围：支持日期选择和时间段选择
- 快速时间选择：今天、昨天、近7天、近30天
- 搜索按钮：根据条件查询录像文件

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/RecordingSearchPanel.vue -->
<template>
  <a-card class="recording-search-panel" :bordered="false">
    <div class="search-header">
      <h3 class="search-title">
        <SearchOutlined />
        录像搜索
      </h3>
    </div>

    <a-form :model="searchForm" layout="vertical">
      <!-- 设备选择 -->
      <a-form-item label="选择设备">
        <a-select
          v-model:value="searchForm.deviceId"
          placeholder="请选择设备"
          show-search
          :filter-option="filterDevice"
          allowClear
        >
          <a-select-option
            v-for="device in deviceList"
            :key="device.id"
            :value="device.id"
          >
            <VideoCameraOutlined />
            {{ device.deviceName }}
          </a-select-option>
        </a-select>
      </a-form-item>

      <!-- 日期选择 -->
      <a-form-item label="选择日期">
        <a-date-picker
          v-model:value="searchForm.date"
          placeholder="请选择日期"
          format="YYYY-MM-DD"
          :disabled-date="disabledDate"
          style="width: 100%"
        />
      </a-form-item>

      <!-- 时间范围 -->
      <a-form-item label="时间范围">
        <a-space direction="vertical" style="width: 100%;" :size="8">
          <a-time-picker
            v-model:value="searchForm.startTime"
            placeholder="开始时间"
            format="HH:mm:ss"
            style="width: 100%"
          />
          <div style="text-align: center; color: #999;">至</div>
          <a-time-picker
            v-model:value="searchForm.endTime"
            placeholder="结束时间"
            format="HH:mm:ss"
            style="width: 100%"
          />
        </a-space>
      </a-form-item>

      <!-- 快速时间选择 -->
      <a-form-item label="快速选择">
        <a-row :gutter="[8, 8]">
          <a-col :span="12">
            <a-button block size="small" @click="setQuickTime('today')">
              今天
            </a-button>
          </a-col>
          <a-col :span="12">
            <a-button block size="small" @click="setQuickTime('yesterday')">
              昨天
            </a-button>
          </a-col>
          <a-col :span="12">
            <a-button block size="small" @click="setQuickTime('week')">
              近7天
            </a-button>
          </a-col>
          <a-col :span="12">
            <a-button block size="small" @click="setQuickTime('month')">
              近30天
            </a-button>
          </a-col>
        </a-row>
      </a-form-item>

      <!-- 搜索按钮 -->
      <a-form-item>
        <a-button
          type="primary"
          block
          @click="handleSearch"
          :loading="searching"
        >
          <template #icon><SearchOutlined /></template>
          搜索录像
        </a-button>
      </a-form-item>
    </a-form>

    <!-- 搜索结果列表 -->
    <div class="search-results">
      <div class="results-header">
        <h4>搜索结果</h4>
        <a-badge
          :count="recordingList.length"
          :number-style="{ backgroundColor: '#1890ff' }"
        />
      </div>

      <div class="results-list">
        <a-spin :spinning="searching">
          <a-empty
            v-if="!searching && recordingList.length === 0"
            description="暂无录像数据"
            :image="Empty.PRESENTED_IMAGE_SIMPLE"
          />

          <RecordingListItem
            v-for="recording in recordingList"
            :key="recording.id"
            :recording="recording"
            :selected="selectedRecordingId === recording.id"
            @click="handleSelectRecording(recording)"
          />
        </a-spin>
      </div>
    </div>
  </a-card>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message, Empty } from 'ant-design-vue';
import dayjs from 'dayjs';
import {
  SearchOutlined,
  VideoCameraOutlined,
} from '@ant-design/icons-vue';
import RecordingListItem from './RecordingListItem.vue';
import { playbackApi } from '/@/api/business/smart-video/playback-api';

const emit = defineEmits(['select-recording', 'search']);

const deviceList = ref([]);
const recordingList = ref([]);
const searching = ref(false);
const selectedRecordingId = ref(null);

const searchForm = reactive({
  deviceId: undefined,
  date: dayjs(),
  startTime: dayjs().startOf('day'),
  endTime: dayjs().endOf('day'),
});

// 禁用未来日期
const disabledDate = (current) => {
  return current && current > dayjs().endOf('day');
};

// 设备过滤
const filterDevice = (input, option) => {
  const text = option.children[1]?.children || '';
  return text.toLowerCase().includes(input.toLowerCase());
};

// 快速时间选择
const setQuickTime = (type) => {
  const now = dayjs();
  switch (type) {
    case 'today':
      searchForm.date = now;
      searchForm.startTime = now.startOf('day');
      searchForm.endTime = now.endOf('day');
      break;
    case 'yesterday':
      searchForm.date = now.subtract(1, 'day');
      searchForm.startTime = now.subtract(1, 'day').startOf('day');
      searchForm.endTime = now.subtract(1, 'day').endOf('day');
      break;
    case 'week':
      searchForm.date = now.subtract(7, 'day');
      searchForm.startTime = now.subtract(7, 'day').startOf('day');
      searchForm.endTime = now.endOf('day');
      break;
    case 'month':
      searchForm.date = now.subtract(30, 'day');
      searchForm.startTime = now.subtract(30, 'day').startOf('day');
      searchForm.endTime = now.endOf('day');
      break;
  }
};

// 搜索录像
const handleSearch = async () => {
  if (!searchForm.deviceId) {
    message.warning('请选择设备');
    return;
  }

  searching.value = true;
  try {
    const params = {
      deviceId: searchForm.deviceId,
      startTime: dayjs(searchForm.date).hour(searchForm.startTime.hour()).minute(searchForm.startTime.minute()).second(searchForm.startTime.second()).format('YYYY-MM-DD HH:mm:ss'),
      endTime: dayjs(searchForm.date).hour(searchForm.endTime.hour()).minute(searchForm.endTime.minute()).second(searchForm.endTime.second()).format('YYYY-MM-DD HH:mm:ss'),
    };

    const response = await playbackApi.searchRecordings(params);

    if (response.code === 1) {
      recordingList.value = response.data || [];
      emit('search', response.data);

      if (recordingList.value.length === 0) {
        message.info('未找到录像文件');
      } else {
        message.success(`找到 ${recordingList.value.length} 个录像文件`);
      }
    } else {
      message.error(response.msg || '搜索失败');
    }
  } catch (error) {
    console.error('搜索录像失败:', error);
    message.error('搜索失败');
  } finally {
    searching.value = false;
  }
};

// 选择录像
const handleSelectRecording = (recording) => {
  selectedRecordingId.value = recording.id;
  emit('select-recording', recording);
};

// 获取设备列表
const fetchDeviceList = async () => {
  try {
    const response = await playbackApi.getDeviceList();
    if (response.code === 1) {
      deviceList.value = response.data || [];
    }
  } catch (error) {
    console.error('获取设备列表失败:', error);
  }
};

onMounted(() => {
  fetchDeviceList();
});
</script>

<style scoped lang="less">
.recording-search-panel {
  height: 100%;
  display: flex;
  flex-direction: column;

  .search-header {
    margin-bottom: 16px;

    .search-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;

      .anticon {
        margin-right: 8px;
        color: #1890ff;
      }
    }
  }

  .search-results {
    margin-top: 24px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;

      h4 {
        margin: 0;
        font-size: 14px;
        color: #666;
      }
    }

    .results-list {
      flex: 1;
      overflow-y: auto;
    }
  }
}
</style>
```

### 2. 录像列表项组件
```vue
<!-- src/views/business/smart-video/components/RecordingListItem.vue -->
<template>
  <div
    class="recording-list-item"
    :class="{ selected: selected }"
    @click="handleClick"
  >
    <div class="item-header">
      <VideoCameraOutlined class="item-icon" />
      <span class="item-device">{{ recording.deviceName }}</span>
    </div>
    <div class="item-info">
      <div class="info-row">
        <ClockCircleOutlined />
        <span>{{ recording.startTime }} - {{ recording.endTime }}</span>
      </div>
      <div class="info-row">
        <span>时长: {{ recording.duration }}</span>
        <span>大小: {{ recording.fileSize }}</span>
      </div>
    </div>
  </div>
</template>

<script setup>
import {
  VideoCameraOutlined,
  ClockCircleOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  recording: {
    type: Object,
    required: true,
  },
  selected: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(['click']);

const handleClick = () => {
  emit('click');
};
</script>

<style scoped lang="less">
.recording-list-item {
  padding: 12px;
  border: 1px solid #f0f0f0;
  border-radius: 6px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.3s;

  &:hover {
    border-color: #1890ff;
    background: #f0f8ff;
  }

  &.selected {
    border-color: #1890ff;
    background: #e6f7ff;
  }

  .item-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;

    .item-icon {
      color: #1890ff;
      font-size: 16px;
    }

    .item-device {
      font-weight: 500;
      color: #333;
    }
  }

  .item-info {
    font-size: 13px;
    color: #666;

    .info-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 4px;

      &:last-child {
        margin-bottom: 0;
        justify-content: space-between;
      }

      .anticon {
        font-size: 12px;
      }
    }
  }
}
</style>
```

### 3. 视频播放器区域（右侧）
**位置**: 页面右侧主区域，自适应宽度

**技术实现**:
```vue
<!-- src/views/business/smart-video/video-playback.vue -->
<template>
  <div class="video-playback-page">
    <a-row :gutter="24" style="height: 100%;">
      <!-- 左侧搜索面板 -->
      <a-col :span="6" style="height: 100%;">
        <RecordingSearchPanel
          @select-recording="handleSelectRecording"
          @search="handleSearch"
        />
      </a-col>

      <!-- 右侧播放器 -->
      <a-col :span="18" style="height: 100%;">
        <a-card :bordered="false" style="height: 100%; display: flex; flex-direction: column;">
          <!-- 工具栏 -->
          <div class="playback-toolbar">
            <div class="toolbar-left">
              <PlayCircleOutlined class="toolbar-icon" />
              <span class="toolbar-title">录像回放</span>
            </div>
            <div class="toolbar-right">
              <a-space>
                <a-button
                  size="small"
                  @click="handleDownload"
                  :disabled="!currentRecording"
                >
                  <template #icon><DownloadOutlined /></template>
                  下载
                </a-button>
                <a-button
                  size="small"
                  @click="handleClip"
                  :disabled="!currentRecording"
                >
                  <template #icon><ScissorOutlined /></template>
                  剪辑
                </a-button>
                <a-button
                  size="small"
                  @click="handleAddBookmark"
                  :disabled="!currentRecording || !isPlaying"
                >
                  <template #icon><BookOutlined /></template>
                  书签
                </a-button>
              </a-space>
            </div>
          </div>

          <!-- 视频播放器 -->
          <div class="video-player-container">
            <VideoPlayer
              v-if="playbackUrl"
              ref="playerRef"
              :video-url="playbackUrl"
              :autoplay="true"
              @timeupdate="handleTimeUpdate"
              @ended="handlePlayEnded"
              @error="handlePlayError"
            />
            <a-empty
              v-else
              description="请选择录像文件进行播放"
              :image="Empty.PRESENTED_IMAGE_SIMPLE"
            />
          </div>

          <!-- 播放信息栏 -->
          <div class="playback-info-bar">
            <div class="info-item">
              <VideoCameraOutlined />
              设备: <span>{{ currentRecording?.deviceName || '未选择' }}</span>
            </div>
            <div class="info-item">
              <ClockCircleOutlined />
              时间: <span>{{ currentRecording?.startTime || '--' }}</span>
            </div>
            <div class="info-item">
              <span>分辨率: {{ currentRecording?.resolution || '--' }}</span>
            </div>
            <div class="info-item">
              <span>当前时间: {{ formatPlayTime(currentTime) }}</span>
            </div>
          </div>
        </a-card>
      </a-col>
    </a-row>

    <!-- 视频剪辑弹窗 -->
    <VideoClipModal
      :visible="clipModalVisible"
      :recording="currentRecording"
      :current-time="currentTime"
      @update:visible="clipModalVisible = $event"
      @success="handleClipSuccess"
    />

    <!-- 书签管理弹窗 -->
    <BookmarkManageModal
      :visible="bookmarkModalVisible"
      :recording="currentRecording"
      @update:visible="bookmarkModalVisible = $event"
    />

    <!-- 下载任务抽屉 -->
    <DownloadTaskDrawer
      :visible="downloadDrawerVisible"
      @update:visible="downloadDrawerVisible = $event"
    />
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { message, Empty } from 'ant-design-vue';
import {
  PlayCircleOutlined,
  DownloadOutlined,
  ScissorOutlined,
  BookOutlined,
  VideoCameraOutlined,
  ClockCircleOutlined,
} from '@ant-design/icons-vue';
import RecordingSearchPanel from './components/RecordingSearchPanel.vue';
import VideoPlayer from './components/VideoPlayer.vue';
import VideoClipModal from './components/VideoClipModal.vue';
import BookmarkManageModal from './components/BookmarkManageModal.vue';
import DownloadTaskDrawer from './components/DownloadTaskDrawer.vue';
import { playbackApi } from '/@/api/business/smart-video/playback-api';

const playerRef = ref(null);
const currentRecording = ref(null);
const playbackUrl = ref('');
const currentTime = ref(0);
const isPlaying = ref(false);

const clipModalVisible = ref(false);
const bookmarkModalVisible = ref(false);
const downloadDrawerVisible = ref(false);

// 选择录像
const handleSelectRecording = async (recording) => {
  currentRecording.value = recording;

  try {
    // 获取播放地址
    const response = await playbackApi.getPlaybackUrl({
      recordingId: recording.id,
    });

    if (response.code === 1) {
      playbackUrl.value = response.data.url;
      isPlaying.value = true;
    } else {
      message.error(response.msg || '获取播放地址失败');
    }
  } catch (error) {
    console.error('获取播放地址失败:', error);
    message.error('获取播放地址失败');
  }
};

// 搜索录像
const handleSearch = (recordings) => {
  console.log('搜索到录像:', recordings);
};

// 时间更新
const handleTimeUpdate = (time) => {
  currentTime.value = time;
};

// 播放结束
const handlePlayEnded = () => {
  isPlaying.value = false;
  message.info('录像播放完毕');
};

// 播放错误
const handlePlayError = (error) => {
  console.error('播放错误:', error);
  message.error('视频播放失败');
  isPlaying.value = false;
};

// 下载录像
const handleDownload = () => {
  if (!currentRecording.value) {
    message.warning('请先选择录像');
    return;
  }

  downloadDrawerVisible.value = true;

  // 创建下载任务
  playbackApi.downloadRecording({
    recordingId: currentRecording.value.id,
  }).then(response => {
    if (response.code === 1) {
      message.success('已添加到下载任务');
    } else {
      message.error(response.msg || '添加下载任务失败');
    }
  }).catch(error => {
    console.error('下载失败:', error);
    message.error('添加下载任务失败');
  });
};

// 剪辑录像
const handleClip = () => {
  if (!currentRecording.value) {
    message.warning('请先选择录像');
    return;
  }
  clipModalVisible.value = true;
};

// 添加书签
const handleAddBookmark = async () => {
  if (!currentRecording.value || !isPlaying.value) {
    message.warning('请先播放录像');
    return;
  }

  try {
    const response = await playbackApi.addBookmark({
      recordingId: currentRecording.value.id,
      time: currentTime.value,
      description: `书签 - ${formatPlayTime(currentTime.value)}`,
    });

    if (response.code === 1) {
      message.success('书签添加成功');
    } else {
      message.error(response.msg || '书签添加失败');
    }
  } catch (error) {
    console.error('添加书签失败:', error);
    message.error('书签添加失败');
  }
};

// 剪辑成功
const handleClipSuccess = () => {
  message.success('剪辑任务已创建');
  clipModalVisible.value = false;
};

// 格式化播放时间
const formatPlayTime = (seconds) => {
  if (!seconds) return '00:00:00';
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
};
</script>

<style scoped lang="less">
.video-playback-page {
  padding: 24px;
  height: calc(100vh - 64px); // 减去顶部导航栏高度

  .playback-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 16px;

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;

      .toolbar-icon {
        color: #1890ff;
        font-size: 20px;
      }

      .toolbar-title {
        font-size: 16px;
        font-weight: 500;
        color: #333;
      }
    }
  }

  .video-player-container {
    flex: 1;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
  }

  .playback-info-bar {
    display: flex;
    align-items: center;
    gap: 24px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
    margin-top: 16px;
    font-size: 13px;
    color: #666;

    .info-item {
      display: flex;
      align-items: center;
      gap: 4px;

      .anticon {
        color: #1890ff;
      }

      span {
        color: #333;
        font-weight: 500;
      }
    }
  }
}
</style>
```

### 4. 视频剪辑弹窗组件
```vue
<!-- src/views/business/smart-video/components/VideoClipModal.vue -->
<template>
  <a-modal
    :open="visible"
    title="视频剪辑"
    width="600px"
    @ok="handleSubmit"
    @cancel="handleCancel"
    :confirmLoading="loading"
  >
    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
    >
      <a-form-item label="录像名称">
        <a-input :value="recording?.deviceName" disabled />
      </a-form-item>

      <a-form-item label="开始时间" name="startTime">
        <a-time-picker
          v-model:value="formData.startTime"
          format="HH:mm:ss"
          style="width: 100%"
        />
      </a-form-item>

      <a-form-item label="结束时间" name="endTime">
        <a-time-picker
          v-model:value="formData.endTime"
          format="HH:mm:ss"
          style="width: 100%"
        />
      </a-form-item>

      <a-form-item label="当前位置">
        <a-button size="small" @click="useCurrentTime">
          使用当前播放时间
        </a-button>
        <span style="margin-left: 8px; color: #666;">
          {{ formatTime(currentTime) }}
        </span>
      </a-form-item>

      <a-form-item label="剪辑名称" name="clipName">
        <a-input
          v-model:value="formData.clipName"
          placeholder="请输入剪辑片段名称"
        />
      </a-form-item>

      <a-form-item label="备注">
        <a-textarea
          v-model:value="formData.description"
          placeholder="请输入备注信息"
          :rows="3"
        />
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';
import dayjs from 'dayjs';
import { playbackApi } from '/@/api/business/smart-video/playback-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  recording: {
    type: Object,
    default: () => ({}),
  },
  currentTime: {
    type: Number,
    default: 0,
  },
});

const emit = defineEmits(['update:visible', 'success']);

const formRef = ref();
const loading = ref(false);

const formData = reactive({
  startTime: dayjs().startOf('day'),
  endTime: dayjs().startOf('day').add(1, 'minute'),
  clipName: '',
  description: '',
});

const formRules = {
  startTime: [
    { required: true, message: '请选择开始时间', trigger: 'change' },
  ],
  endTime: [
    { required: true, message: '请选择结束时间', trigger: 'change' },
  ],
  clipName: [
    { required: true, message: '请输入剪辑名称', trigger: 'blur' },
  ],
};

const formatTime = (seconds) => {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
};

const useCurrentTime = () => {
  const time = dayjs().startOf('day').add(props.currentTime, 'second');
  formData.startTime = time;
};

const handleSubmit = async () => {
  try {
    await formRef.value.validate();

    loading.value = true;

    const params = {
      recordingId: props.recording.id,
      startTime: formData.startTime.format('HH:mm:ss'),
      endTime: formData.endTime.format('HH:mm:ss'),
      clipName: formData.clipName,
      description: formData.description,
    };

    const response = await playbackApi.createClipTask(params);

    if (response.code === 1) {
      message.success('剪辑任务创建成功');
      emit('success');
      handleCancel();
    } else {
      message.error(response.msg || '创建失败');
    }
  } catch (error) {
    console.error('创建剪辑任务失败:', error);
  } finally {
    loading.value = false;
  }
};

const handleCancel = () => {
  formRef.value?.resetFields();
  emit('update:visible', false);
};
</script>
```

### 5. 下载任务抽屉组件
```vue
<!-- src/views/business/smart-video/components/DownloadTaskDrawer.vue -->
<template>
  <a-drawer
    :open="visible"
    title="下载任务"
    width="500px"
    placement="right"
    @close="handleClose"
  >
    <a-list
      :data-source="taskList"
      :loading="loading"
    >
      <template #renderItem="{ item }">
        <a-list-item>
          <a-list-item-meta>
            <template #title>
              {{ item.fileName }}
            </template>
            <template #description>
              <div>{{ item.deviceName }} - {{ item.recordingTime }}</div>
              <a-progress
                :percent="item.progress"
                :status="item.status === 'completed' ? 'success' : item.status === 'failed' ? 'exception' : 'active'"
              />
            </template>
          </a-list-item-meta>
          <template #actions>
            <a-button
              v-if="item.status === 'downloading'"
              type="link"
              danger
              size="small"
              @click="handleCancelTask(item.id)"
            >
              取消
            </a-button>
          </template>
        </a-list-item>
      </template>
    </a-list>
  </a-drawer>
</template>

<script setup>
import { ref, watch } from 'vue';
import { message } from 'ant-design-vue';
import { playbackApi } from '/@/api/business/smart-video/playback-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
});

const emit = defineEmits(['update:visible']);

const taskList = ref([]);
const loading = ref(false);

const fetchTasks = async () => {
  loading.value = true;
  try {
    const response = await playbackApi.getDownloadTasks();
    if (response.code === 1) {
      taskList.value = response.data || [];
    }
  } catch (error) {
    console.error('获取下载任务失败:', error);
  } finally {
    loading.value = false;
  }
};

const handleCancelTask = async (taskId) => {
  try {
    const response = await playbackApi.cancelDownloadTask(taskId);
    if (response.code === 1) {
      message.success('已取消下载');
      fetchTasks();
    } else {
      message.error(response.msg || '取消失败');
    }
  } catch (error) {
    console.error('取消下载失败:', error);
    message.error('取消失败');
  }
};

const handleClose = () => {
  emit('update:visible', false);
};

watch(() => props.visible, (newVal) => {
  if (newVal) {
    fetchTasks();
  }
});
</script>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/playback-mock-data.js

export const mockRecordingList = [
  {
    id: 1,
    deviceId: 'CAM001',
    deviceName: 'CAM001 - 办公区域前门',
    startTime: '2024-01-30 09:00:00',
    endTime: '2024-01-30 10:00:00',
    duration: '60分钟',
    fileSize: '2.3 GB',
    resolution: '1920×1080',
    filePath: '/recordings/2024/01/30/CAM001_090000.mp4',
  },
  {
    id: 2,
    deviceId: 'CAM002',
    deviceName: 'CAM002 - 大厅中央',
    startTime: '2024-01-30 10:00:00',
    endTime: '2024-01-30 11:00:00',
    duration: '60分钟',
    fileSize: '2.1 GB',
    resolution: '1920×1080',
    filePath: '/recordings/2024/01/30/CAM002_100000.mp4',
  },
  {
    id: 3,
    deviceId: 'CAM003',
    deviceName: 'CAM003 - 走廊东侧',
    startTime: '2024-01-30 11:00:00',
    endTime: '2024-01-30 12:00:00',
    duration: '60分钟',
    fileSize: '2.5 GB',
    resolution: '2560×1440',
    filePath: '/recordings/2024/01/30/CAM003_110000.mp4',
  },
  {
    id: 4,
    deviceId: 'CAM001',
    deviceName: 'CAM001 - 办公区域前门',
    startTime: '2024-01-30 14:00:00',
    endTime: '2024-01-30 15:00:00',
    duration: '60分钟',
    fileSize: '2.4 GB',
    resolution: '1920×1080',
    filePath: '/recordings/2024/01/30/CAM001_140000.mp4',
  },
  {
    id: 5,
    deviceId: 'CAM002',
    deviceName: 'CAM002 - 大厅中央',
    startTime: '2024-01-30 15:00:00',
    endTime: '2024-01-30 16:00:00',
    duration: '60分钟',
    fileSize: '2.2 GB',
    resolution: '1920×1080',
    filePath: '/recordings/2024/01/30/CAM002_150000.mp4',
  },
];

export const mockDeviceList = [
  { id: 'CAM001', deviceName: 'CAM001 - 办公区域前门', deviceCode: 'CAM-001' },
  { id: 'CAM002', deviceName: 'CAM002 - 大厅中央', deviceCode: 'CAM-002' },
  { id: 'CAM003', deviceName: 'CAM003 - 走廊东侧', deviceCode: 'CAM-003' },
  { id: 'CAM004', deviceName: 'CAM004 - 会议室001', deviceCode: 'CAM-004' },
  { id: 'CAM005', deviceName: 'CAM005 - 电梯前厅', deviceCode: 'CAM-005' },
];

export const mockDownloadTasks = [
  {
    id: 1,
    fileName: 'CAM001_20240130_090000.mp4',
    deviceName: 'CAM001 - 办公区域前门',
    recordingTime: '2024-01-30 09:00:00',
    progress: 45,
    status: 'downloading',
  },
  {
    id: 2,
    fileName: 'CAM002_20240130_100000.mp4',
    deviceName: 'CAM002 - 大厅中央',
    recordingTime: '2024-01-30 10:00:00',
    progress: 100,
    status: 'completed',
  },
];

// Mock API实现
export default {
  // 搜索录像
  mockSearchRecordings: (params) => {
    let list = [...mockRecordingList];

    // 按设备筛选
    if (params.deviceId) {
      list = list.filter(item => item.deviceId === params.deviceId);
    }

    // 按时间范围筛选
    if (params.startTime && params.endTime) {
      list = list.filter(item => {
        return item.startTime >= params.startTime && item.endTime <= params.endTime;
      });
    }

    return {
      code: 1,
      msg: '查询成功',
      data: list,
    };
  },

  // 获取设备列表
  mockGetDeviceList: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockDeviceList,
    };
  },

  // 获取播放地址
  mockGetPlaybackUrl: (params) => {
    const recording = mockRecordingList.find(r => r.id === params.recordingId);
    return {
      code: 1,
      msg: '获取成功',
      data: {
        url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8', // 示例HLS流
        type: 'hls',
      },
    };
  },

  // 下载录像
  mockDownloadRecording: (params) => {
    return {
      code: 1,
      msg: '下载任务已创建',
      data: {
        taskId: Date.now(),
      },
    };
  },

  // 创建剪辑任务
  mockCreateClipTask: (params) => {
    return {
      code: 1,
      msg: '剪辑任务已创建',
      data: {
        taskId: Date.now(),
      },
    };
  },

  // 添加书签
  mockAddBookmark: (params) => {
    return {
      code: 1,
      msg: '书签添加成功',
      data: {
        bookmarkId: Date.now(),
      },
    };
  },

  // 获取下载任务
  mockGetDownloadTasks: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockDownloadTasks,
    };
  },

  // 取消下载任务
  mockCancelDownloadTask: (taskId) => {
    return {
      code: 1,
      msg: '取消成功',
      data: null,
    };
  },
};
```

## 路由配置

```javascript
// src/router/business/smart-video.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/video-playback',
        name: 'SmartVideoPlayback',
        component: () => import('/@/views/business/smart-video/video-playback.vue'),
        meta: {
          title: '智能视频 - 视频回放',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'PlayCircleOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

## 菜单配置

```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  // 智能视频父菜单
  const smartVideoMenu = {
    menuId: maxMenuId + 1000,
    menuName: '智能视频',
    menuTitle: '智能视频',
    menuType: MENU_TYPE_ENUM.CATALOG.value,
    parentId: 0,
    path: '/business/smart-video',
    icon: 'VideoCameraOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: false,
    frameFlag: false,
    frameUrl: '',
    sort: 10,
    updateTime: new Date().toISOString(),
  };

  // 视频回放子菜单
  const playbackMenu = {
    menuId: maxMenuId + 1004,
    menuName: '视频回放',
    menuTitle: '视频回放',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/video-playback',
    component: '/business/smart-video/video-playback.vue',
    icon: 'PlayCircleOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 4,
    updateTime: new Date().toISOString(),
  };

  menuList.push(smartVideoMenu, playbackMenu);
  return smartVideoMenu.menuId;
}
```

## Pinia Store状态管理

```javascript
// src/store/modules/business/playback.js
import { defineStore } from 'pinia';
import { message } from 'ant-design-vue';
import { playbackApi } from '/@/api/business/smart-video/playback-api';

export const usePlaybackStore = defineStore('playback', {
  state: () => ({
    recordingList: [],
    currentRecording: null,
    playbackUrl: '',
    currentTime: 0,
    bookmarkList: [],
    downloadTasks: [],
    loading: false,
  }),

  getters: {
    isPlaying(state) {
      return !!state.playbackUrl;
    },

    recordingCount(state) {
      return state.recordingList.length;
    },

    downloadingTaskCount(state) {
      return state.downloadTasks.filter(t => t.status === 'downloading').length;
    },
  },

  actions: {
    async searchRecordings(params, useMock = true) {
      this.loading = true;
      try {
        let response;
        if (useMock) {
          const playbackMockData = await import('/@/views/business/smart-video/mock/playback-mock-data');
          response = playbackMockData.default.mockSearchRecordings(params);
        } else {
          response = await playbackApi.searchRecordings(params);
        }

        if (response.code === 1) {
          this.recordingList = response.data || [];
          return response.data;
        } else {
          message.error(response.msg || '搜索失败');
          return [];
        }
      } catch (error) {
        console.error('搜索录像失败:', error);
        message.error('搜索失败');
        return [];
      } finally {
        this.loading = false;
      }
    },

    async getPlaybackUrl(recordingId, useMock = true) {
      try {
        let response;
        if (useMock) {
          const playbackMockData = await import('/@/views/business/smart-video/mock/playback-mock-data');
          response = playbackMockData.default.mockGetPlaybackUrl({ recordingId });
        } else {
          response = await playbackApi.getPlaybackUrl({ recordingId });
        }

        if (response.code === 1) {
          this.playbackUrl = response.data.url;
          return response.data.url;
        } else {
          message.error(response.msg || '获取播放地址失败');
          return null;
        }
      } catch (error) {
        console.error('获取播放地址失败:', error);
        message.error('获取播放地址失败');
        return null;
      }
    },

    setCurrentRecording(recording) {
      this.currentRecording = recording;
    },

    updateCurrentTime(time) {
      this.currentTime = time;
    },

    clearPlayback() {
      this.playbackUrl = '';
      this.currentRecording = null;
      this.currentTime = 0;
    },
  },
});
```

## 常见错误排查清单

### 1. 视频播放相关
- [ ] 视频无法播放：检查视频URL格式是否正确（HLS需要.m3u8格式）
- [ ] 播放器初始化失败：确认Video.js或XGPlayer依赖已正确安装
- [ ] 视频加载慢：检查网络带宽和视频编码格式
- [ ] 跨域问题：确认视频服务器已配置CORS

### 2. 时间选择器问题
- [ ] 日期选择器值绑定：使用dayjs对象而非字符串
- [ ] 时间格式不匹配：统一使用'YYYY-MM-DD HH:mm:ss'格式
- [ ] 禁用日期不生效：检查disabledDate函数逻辑

### 3. 录像搜索问题
- [ ] 搜索无结果：检查时间范围是否正确
- [ ] 设备列表为空：确认设备API已正确调用
- [ ] 搜索条件重置失败：检查reactive对象赋值方式

### 4. 下载和剪辑功能
- [ ] 下载任务创建失败：检查录像文件是否存在
- [ ] 剪辑时间无效：确保开始时间早于结束时间
- [ ] 进度条不更新：需要轮询或WebSocket实时更新

## 最佳实践总结

### ✅ 推荐的开发流程
1. **先搭建基础布局** - 左右分栏结构
2. **集成视频播放器** - 选择合适的播放器库
3. **实现搜索功能** - 支持多条件组合查询
4. **添加播放控制** - 播放、暂停、进度控制
5. **扩展高级功能** - 下载、剪辑、书签

### ✅ 性能优化建议
1. **视频流优化**：使用HLS或DASH自适应流
2. **懒加载**：录像列表使用虚拟滚动
3. **缓存策略**：缓存设备列表和常用查询
4. **预加载**：预加载下一个录像片段
5. **分片下载**：大文件采用分片下载

### ✅ 用户体验优化
1. **快速时间选择**：提供常用时间范围快捷按钮
2. **播放状态提示**：显示加载、缓冲、错误状态
3. **键盘快捷键**：支持空格播放/暂停、方向键跳转
4. **进度预览**：鼠标悬停显示预览图
5. **书签跳转**：支持一键跳转到书签位置

### ✅ 安全性建议
1. **播放权限验证**：验证用户是否有权查看该录像
2. **URL防盗链**：播放URL添加时效性token
3. **下载限制**：限制下载频率和并发数
4. **敏感信息过滤**：录像内容脱敏处理

## 视频播放器选型对比

| 特性 | Video.js | XGPlayer | DPlayer |
|------|----------|----------|---------|
| 开源协议 | Apache 2.0 | MIT | MIT |
| 文件大小 | ~250KB | ~200KB | ~150KB |
| HLS支持 | 需要插件 | 原生支持 | 需要插件 |
| 多语言 | 支持 | 支持 | 支持 |
| 自定义UI | 容易 | 容易 | 较难 |
| 移动端 | 良好 | 优秀 | 良好 |
| 社区活跃度 | 高 | 中 | 中 |
| 推荐场景 | 通用场景 | 监控回放 | 在线视频 |

### 推荐选择
- **Video.js**: 功能全面，社区活跃，插件丰富，适合大多数场景
- **XGPlayer**: 国产播放器，对HLS支持好，适合监控视频回放
- **DPlayer**: 轻量级，适合简单场景

## 总结

通过遵循本文档的技术规范和注意事项，可以有效开发出功能完善的视频回放页面。

关键要点：
- ✅ **选择合适的视频播放器**，根据业务需求选择Video.js或XGPlayer
- ✅ **正确使用日期时间组件**，使用dayjs处理时间
- ✅ **优化视频加载性能**，使用HLS自适应流
- ✅ **完善的错误处理**，视频加载失败、播放错误等
- ✅ **用户体验优化**，快捷操作、进度预览、书签管理
- ✅ **支持高级功能**，视频下载、剪辑、导出
- ✅ **遵循SmartAdmin规范**，保持代码风格一致

通过这些规范和最佳实践，可以确保视频回放页面开发顺利进行，提供流畅的视频回放体验。
