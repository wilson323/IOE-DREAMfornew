# 视频监控预览页面功能与布局文档

## 页面概述
视频监控预览页面是智能视频监控系统的核心实时监控界面,用于同时查看多路视频流的实时画面。该页面基于SmartAdmin前端框架构建,采用Vue3 + Ant Design Vue技术栈,集成专业视频播放器(jessibuca/video.js),支持多种分屏布局(1/4/9/16画面及1+7主次布局),提供实时视频流播放、云台控制、截图录像、自动轮播等完整的视频监控功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **视频播放器**: jessibuca 3.x / video.js 8.x (推荐jessibuca用于低延迟流媒体)

### 视频播放器选型建议

#### 方案一: Jessibuca (推荐用于低延迟实时流)
**优势**:
- 支持WebSocket-FLV、WebRTC、HLS等多种协议
- 超低延迟(可低至200-500ms)
- 硬解码支持,性能优异
- 专为安防监控场景设计
- 支持H.264/H.265编码

**安装**:
```bash
npm install jessibuca
```

**适用场景**:
- 需要低延迟的实时监控
- GB28181国标平台对接
- 安防监控专业场景
- 需要WebRTC/WebSocket-FLV协议

#### 方案二: Video.js (通用视频播放方案)
**优势**:
- 成熟稳定,社区活跃
- 插件生态丰富
- 支持HLS、DASH等标准协议
- 界面可定制性强

**安装**:
```bash
npm install video.js
npm install @videojs/http-streaming  # HLS支持
```

**适用场景**:
- 标准HLS/DASH流媒体
- 需要丰富的UI定制
- 对延迟要求不高(2-10秒可接受)

### 项目文件组织结构
```
src/views/business/smart-video/
├── monitor-preview.vue              # 监控预览主页面
├── components/
│   ├── VideoPlayer.vue             # 视频播放器组件
│   ├── VideoGrid.vue               # 视频网格布局组件
│   ├── PTZControl.vue              # 云台控制组件
│   ├── LayoutSelector.vue          # 布局选择组件
│   ├── DeviceTreePanel.vue         # 设备树面板组件
│   └── ToolbarActions.vue          # 工具栏操作组件
├── mock/
│   └── monitor-mock-data.js         # 模拟数据
├── api/
│   └── monitor-api.js               # API接口定义
└── utils/
    ├── video-player-manager.js      # 视频播放器管理工具
    └── video-stream-helper.js       # 视频流处理工具
```

### API接口设计
```javascript
// src/api/business/smart-video/monitor-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const monitorApi = {
  // 获取设备树列表
  getDeviceTree: (params) => getRequest('/monitor/device/tree', params),

  // 获取视频流地址
  getVideoStreamUrl: (deviceId, channelId) =>
    getRequest(`/monitor/stream/url/${deviceId}/${channelId}`),

  // 开始播放视频
  startPlay: (params) => postRequest('/monitor/play/start', params),

  // 停止播放视频
  stopPlay: (params) => postRequest('/monitor/play/stop', params),

  // 云台控制
  ptzControl: (params) => postRequest('/monitor/ptz/control', params),

  // 截图
  captureSnapshot: (params) => postRequest('/monitor/capture/snapshot', params),

  // 开始录像
  startRecord: (params) => postRequest('/monitor/record/start', params),

  // 停止录像
  stopRecord: (params) => postRequest('/monitor/record/stop', params),

  // 获取预置位列表
  getPresetList: (deviceId) => getRequest(`/monitor/ptz/preset/${deviceId}`),

  // 调用预置位
  gotoPreset: (params) => postRequest('/monitor/ptz/preset/goto', params),

  // 获取监控场景配置
  getSceneConfig: (sceneId) => getRequest(`/monitor/scene/config/${sceneId}`),

  // 保存监控场景配置
  saveSceneConfig: (params) => postRequest('/monitor/scene/config/save', params),

  // 获取设备统计信息
  getDeviceStatistics: () => getRequest('/monitor/device/statistics'),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="云台控制">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="云台控制"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { ExpandArrowsAltOutlined } from '@ant-design/icons-vue';  // ❌ 不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  CameraOutlined,          // ✅ 拍照/截图
  VideoCameraOutlined,     // ✅ 录像/摄像机
  ExpandOutlined,          // ✅ 展开/云台控制
  AppstoreOutlined,        // ✅ 网格/布局
  FullscreenOutlined,      // ✅ 全屏
  PlayCircleOutlined,      // ✅ 播放
  PauseCircleOutlined,     // ✅ 暂停
  SoundOutlined,           // ✅ 音量
  SettingOutlined,         // ✅ 设置
  ReloadOutlined,          // ✅ 刷新
  ZoomInOutlined,          // ✅ 放大
  ZoomOutOutlined,         // ✅ 缩小
  ArrowUpOutlined,         // ✅ 上
  ArrowDownOutlined,       // ✅ 下
  ArrowLeftOutlined,       // ✅ 左
  ArrowRightOutlined,      // ✅ 右
} from '@ant-design/icons-vue';
</script>
```

### 3. 视频播放器内存泄漏防范

#### ❌ 错误：未正确销毁播放器
```javascript
// 错误：组件销毁时未清理播放器
onUnmounted(() => {
  // 没有清理播放器实例
});
```

#### ✅ 正确：完整的播放器生命周期管理
```javascript
import { ref, onMounted, onUnmounted } from 'vue';

const playerInstances = ref([]);

onMounted(() => {
  // 初始化播放器
  initPlayers();
});

onUnmounted(() => {
  // 销毁所有播放器实例
  playerInstances.value.forEach(player => {
    if (player) {
      player.pause();      // 暂停播放
      player.destroy();    // 销毁实例
    }
  });
  playerInstances.value = [];
});

// 切换布局时也要清理旧播放器
const changeLayout = (newLayout) => {
  // 先清理现有播放器
  playerInstances.value.forEach(player => {
    if (player) {
      player.pause();
      player.destroy();
    }
  });
  playerInstances.value = [];

  // 再创建新布局的播放器
  currentLayout.value = newLayout;
  nextTick(() => {
    initPlayers();
  });
};
```

### 4. 视频流URL管理注意事项

#### ✅ 正确的流地址管理
```javascript
// 支持多种流媒体协议
const STREAM_PROTOCOL = {
  RTMP: 'rtmp',
  RTSP: 'rtsp',
  HLS: 'hls',
  FLV: 'flv',
  WEBRTC: 'webrtc',
  WS_FLV: 'ws-flv',
};

// 根据播放器类型和协议生成正确的流地址
const getStreamUrl = (device, protocol) => {
  const baseUrl = device.streamBaseUrl;
  const channelId = device.channelId;

  switch (protocol) {
    case STREAM_PROTOCOL.HLS:
      return `${baseUrl}/live/${channelId}.m3u8`;
    case STREAM_PROTOCOL.FLV:
      return `${baseUrl}/live/${channelId}.flv`;
    case STREAM_PROTOCOL.WS_FLV:
      return `ws://${baseUrl}/live/${channelId}.flv`;
    case STREAM_PROTOCOL.WEBRTC:
      return `${baseUrl}/webrtc/${channelId}`;
    default:
      return baseUrl;
  }
};
```

### 5. 响应式布局注意事项

#### ✅ 使用CSS Grid实现灵活布局
```vue
<style scoped lang="less">
.video-grid {
  display: grid;
  gap: 8px;
  width: 100%;
  height: 100%;
  background: #000;
  padding: 8px;

  // 1画面布局
  &.grid-1 {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }

  // 4画面布局 (2x2)
  &.grid-4 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
  }

  // 9画面布局 (3x3)
  &.grid-9 {
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
  }

  // 16画面布局 (4x4)
  &.grid-16 {
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }

  // 1+7布局 (主次画面)
  &.grid-1-7 {
    grid-template-columns: 3fr 1fr;
    grid-template-rows: repeat(3, 1fr);

    .video-cell:first-child {
      grid-row: span 3;
    }
  }
}

.video-cell {
  position: relative;
  background: #000;
  border-radius: 4px;
  overflow: hidden;
  aspect-ratio: 16/9; // 保持16:9宽高比

  &:hover {
    outline: 2px solid #1890ff;
  }
}
</style>
```

## 核心功能模块

### 1. 设备树面板
**位置**: 页面左侧固定面板
**宽度**: 280px

**功能说明**:
- 显示所有监控设备的树形结构
- 支持按状态筛选(全部/在线/离线)
- 支持按区域分组展示
- 支持按设备类型分组展示
- 显示设备数量统计

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/DeviceTreePanel.vue -->
<template>
  <div class="device-tree-panel">
    <div class="panel-header">
      <DesktopOutlined />
      <span>设备列表</span>
    </div>

    <!-- 快速筛选 -->
    <div class="quick-filter">
      <div
        class="filter-item"
        :class="{ active: filterType === 'all' }"
        @click="handleFilter('all')"
      >
        <VideoCameraOutlined />
        <span>所有设备 ({{ statistics.totalCount }})</span>
      </div>

      <div
        class="filter-item"
        :class="{ active: filterType === 'online' }"
        @click="handleFilter('online')"
      >
        <CheckCircleOutlined style="color: #52c41a;" />
        <span>在线设备 ({{ statistics.onlineCount }})</span>
      </div>

      <div
        class="filter-item"
        :class="{ active: filterType === 'offline' }"
        @click="handleFilter('offline')"
      >
        <CloseCircleOutlined style="color: #ff4d4f;" />
        <span>离线设备 ({{ statistics.offlineCount }})</span>
      </div>
    </div>

    <a-divider style="margin: 12px 0;" />

    <!-- 区域分组 -->
    <div class="group-section">
      <div class="section-title">按区域分组</div>
      <div
        v-for="area in areaGroups"
        :key="area.id"
        class="filter-item"
        @click="handleAreaSelect(area)"
      >
        <component :is="area.icon" style="color: #1890ff;" />
        <span>{{ area.name }} ({{ area.count }})</span>
      </div>
    </div>

    <a-divider style="margin: 12px 0;" />

    <!-- 类型分组 -->
    <div class="group-section">
      <div class="section-title">按类型分组</div>
      <div
        v-for="type in typeGroups"
        :key="type.id"
        class="filter-item"
        @click="handleTypeSelect(type)"
      >
        <component :is="type.icon" style="color: #faad14;" />
        <span>{{ type.name }} ({{ type.count }})</span>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import {
  DesktopOutlined,
  VideoCameraOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  BuildOutlined,
  HomeOutlined,
  CarOutlined,
  ShopOutlined,
  CameraOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  statistics: {
    type: Object,
    default: () => ({
      totalCount: 0,
      onlineCount: 0,
      offlineCount: 0,
    }),
  },
});

const emit = defineEmits(['filter-change', 'area-select', 'type-select']);

const filterType = ref('all');

const areaGroups = ref([
  { id: 'office', name: '办公区', count: 45, icon: BuildOutlined },
  { id: 'factory', name: '厂区', count: 68, icon: ShopOutlined },
  { id: 'parking', name: '停车场', count: 23, icon: CarOutlined },
  { id: 'dormitory', name: '宿舍区', count: 22, icon: HomeOutlined },
]);

const typeGroups = ref([
  { id: 'ipc', name: '网络摄像头', count: 120, icon: CameraOutlined },
  { id: 'nvr', name: 'NVR设备', count: 25, icon: DesktopOutlined },
  { id: 'analog', name: '模拟摄像头', count: 13, icon: VideoCameraOutlined },
]);

const handleFilter = (type) => {
  filterType.value = type;
  emit('filter-change', type);
};

const handleAreaSelect = (area) => {
  emit('area-select', area);
};

const handleTypeSelect = (type) => {
  emit('type-select', type);
};
</script>

<style scoped lang="less">
.device-tree-panel {
  width: 280px;
  height: 100%;
  background: #fff;
  border-right: 1px solid #f0f0f0;
  overflow-y: auto;
  flex-shrink: 0;

  .panel-header {
    padding: 16px;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .quick-filter {
    padding: 0 12px;
  }

  .filter-item {
    padding: 10px 12px;
    margin-bottom: 4px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;

    &:hover {
      background: #f5f5f5;
    }

    &.active {
      background: #e6f7ff;
      color: #1890ff;
    }

    span {
      font-size: 14px;
    }
  }

  .group-section {
    padding: 0 12px;

    .section-title {
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
      padding-left: 12px;
    }
  }
}
</style>
```

### 2. 工具栏操作区
**位置**: 视频区域顶部

**功能说明**:
- 拍照截图
- 开始/停止录像
- 云台控制
- 自定义布局
- 自动轮播开关

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/ToolbarActions.vue -->
<template>
  <div class="toolbar-actions">
    <div class="toolbar-left">
      <span class="toolbar-label">预览操作:</span>

      <a-button size="small" @click="handleCapture">
        <template #icon><CameraOutlined /></template>
        拍照
      </a-button>

      <a-button
        size="small"
        :type="isRecording ? 'primary' : 'default'"
        :danger="isRecording"
        @click="handleRecord"
      >
        <template #icon><VideoCameraOutlined /></template>
        {{ isRecording ? '停止录像' : '录像' }}
      </a-button>

      <a-button size="small" @click="handleOpenPTZ">
        <template #icon><ExpandOutlined /></template>
        云台
      </a-button>

      <a-button size="small" @click="handleOpenLayout">
        <template #icon><AppstoreOutlined /></template>
        自定义排版
      </a-button>
    </div>

    <div class="toolbar-right">
      <a-checkbox v-model:checked="autoSwitch" @change="handleAutoSwitch">
        自动轮播
      </a-checkbox>

      <a-select
        v-if="autoSwitch"
        v-model:value="switchInterval"
        size="small"
        style="width: 100px; margin-left: 8px;"
      >
        <a-select-option :value="5">5秒</a-select-option>
        <a-select-option :value="10">10秒</a-select-option>
        <a-select-option :value="30">30秒</a-select-option>
        <a-select-option :value="60">60秒</a-select-option>
      </a-select>
    </div>
  </div>
</template>

<script setup>
import { ref, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  CameraOutlined,
  VideoCameraOutlined,
  ExpandOutlined,
  AppstoreOutlined,
} from '@ant-design/icons-vue';

const emit = defineEmits([
  'capture',
  'record-start',
  'record-stop',
  'open-ptz',
  'open-layout',
  'auto-switch-change',
]);

const isRecording = ref(false);
const autoSwitch = ref(false);
const switchInterval = ref(10);

// 拍照
const handleCapture = () => {
  emit('capture');
  message.success('截图成功');
};

// 录像
const handleRecord = () => {
  if (isRecording.value) {
    emit('record-stop');
    message.success('录像已保存');
  } else {
    emit('record-start');
    message.success('开始录像');
  }
  isRecording.value = !isRecording.value;
};

// 云台控制
const handleOpenPTZ = () => {
  emit('open-ptz');
};

// 自定义布局
const handleOpenLayout = () => {
  emit('open-layout');
};

// 自动轮播
const handleAutoSwitch = (e) => {
  emit('auto-switch-change', {
    enabled: e.target.checked,
    interval: switchInterval.value,
  });
};

watch(switchInterval, (newVal) => {
  if (autoSwitch.value) {
    emit('auto-switch-change', {
      enabled: true,
      interval: newVal,
    });
  }
});
</script>

<style scoped lang="less">
.toolbar-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #fff;
  border-bottom: 1px solid #f0f0f0;

  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 8px;

    .toolbar-label {
      font-size: 14px;
      color: #999;
      margin-right: 8px;
    }
  }

  .toolbar-right {
    display: flex;
    align-items: center;
  }
}
</style>
```

### 3. 视频播放器组件 (Jessibuca)

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/VideoPlayer.vue -->
<template>
  <div class="video-player-wrapper">
    <div ref="playerContainer" class="video-player-container"></div>

    <!-- 视频信息叠加层 -->
    <div class="video-overlay">
      <div class="video-title">
        <CheckCircleOutlined v-if="isOnline" style="color: #52c41a;" />
        <CloseCircleOutlined v-else style="color: #ff4d4f;" />
        <span>{{ deviceName }}</span>
      </div>

      <div class="video-time">{{ currentTime }}</div>
    </div>

    <!-- 加载状态 -->
    <div v-if="loading" class="video-loading">
      <a-spin size="large" />
      <div>加载中...</div>
    </div>

    <!-- 错误提示 -->
    <div v-if="error" class="video-error">
      <ExclamationCircleOutlined style="font-size: 48px; color: #ff4d4f;" />
      <div>{{ errorMessage }}</div>
      <a-button size="small" @click="handleRetry">重试</a-button>
    </div>

    <!-- 控制按钮 -->
    <div class="video-controls" v-show="showControls">
      <a-button
        type="text"
        size="small"
        @click="handleFullscreen"
      >
        <template #icon><FullscreenOutlined /></template>
      </a-button>

      <a-button
        type="text"
        size="small"
        @click="handleSound"
      >
        <template #icon>
          <SoundOutlined v-if="isMuted" />
          <SoundOutlined v-else />
        </template>
      </a-button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  CheckCircleOutlined,
  CloseCircleOutlined,
  ExclamationCircleOutlined,
  FullscreenOutlined,
  SoundOutlined,
} from '@ant-design/icons-vue';
import Jessibuca from 'jessibuca';

const props = defineProps({
  deviceName: {
    type: String,
    default: '未知设备',
  },
  streamUrl: {
    type: String,
    required: true,
  },
  autoPlay: {
    type: Boolean,
    default: true,
  },
});

const playerContainer = ref(null);
const player = ref(null);
const loading = ref(false);
const error = ref(false);
const errorMessage = ref('');
const isOnline = ref(true);
const currentTime = ref('');
const showControls = ref(false);
const isMuted = ref(true);

let timeInterval = null;

onMounted(() => {
  initPlayer();
  startTimeUpdate();
});

onUnmounted(() => {
  destroyPlayer();
  stopTimeUpdate();
});

// 监听流地址变化
watch(() => props.streamUrl, (newUrl) => {
  if (newUrl && player.value) {
    player.value.play(newUrl);
  }
});

// 初始化播放器
const initPlayer = () => {
  if (!playerContainer.value) return;

  try {
    loading.value = true;
    error.value = false;

    player.value = new Jessibuca({
      container: playerContainer.value,
      videoBuffer: 0.2,        // 缓存时长
      isResize: true,          // 自动调整大小
      isFullResize: true,
      loadingText: '加载中',
      hasAudio: true,
      hasVideo: true,
      operateBtns: {
        fullscreen: false,     // 隐藏默认全屏按钮
        screenshot: false,     // 隐藏默认截图按钮
        play: false,
        audio: false,
      },
      controlAutoHide: true,
      forceNoOffscreen: true,
      isNotMute: false,        // 默认静音
    });

    // 监听播放器事件
    player.value.on('play', () => {
      loading.value = false;
      isOnline.value = true;
      console.log('播放开始:', props.deviceName);
    });

    player.value.on('pause', () => {
      console.log('播放暂停:', props.deviceName);
    });

    player.value.on('error', (err) => {
      loading.value = false;
      error.value = true;
      isOnline.value = false;
      errorMessage.value = '视频加载失败';
      console.error('播放器错误:', err);
    });

    player.value.on('timeout', () => {
      error.value = true;
      isOnline.value = false;
      errorMessage.value = '连接超时';
      message.error(`${props.deviceName} 连接超时`);
    });

    // 开始播放
    if (props.autoPlay && props.streamUrl) {
      player.value.play(props.streamUrl);
    }
  } catch (err) {
    console.error('初始化播放器失败:', err);
    error.value = true;
    errorMessage.value = '播放器初始化失败';
  }
};

// 销毁播放器
const destroyPlayer = () => {
  if (player.value) {
    try {
      player.value.pause();
      player.value.destroy();
      player.value = null;
    } catch (err) {
      console.error('销毁播放器失败:', err);
    }
  }
};

// 开始时间更新
const startTimeUpdate = () => {
  timeInterval = setInterval(() => {
    const now = new Date();
    currentTime.value = now.toLocaleTimeString('zh-CN', { hour12: false });
  }, 1000);
};

// 停止时间更新
const stopTimeUpdate = () => {
  if (timeInterval) {
    clearInterval(timeInterval);
    timeInterval = null;
  }
};

// 重试
const handleRetry = () => {
  error.value = false;
  destroyPlayer();
  initPlayer();
};

// 全屏
const handleFullscreen = () => {
  if (playerContainer.value) {
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      playerContainer.value.requestFullscreen();
    }
  }
};

// 音量控制
const handleSound = () => {
  if (player.value) {
    isMuted.value = !isMuted.value;
    player.value.setMute(isMuted.value);
  }
};

// 暴露截图方法
const captureSnapshot = () => {
  if (player.value) {
    const base64 = player.value.screenshot('png', 'base64', 1);
    return base64;
  }
  return null;
};

defineExpose({
  captureSnapshot,
  player,
});
</script>

<style scoped lang="less">
.video-player-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  background: #000;

  .video-player-container {
    width: 100%;
    height: 100%;
  }

  .video-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 8px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
    pointer-events: none;

    .video-title {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #fff;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .video-time {
      position: absolute;
      bottom: 8px;
      right: 8px;
      color: #fff;
      font-size: 12px;
      background: rgba(0,0,0,0.6);
      padding: 4px 8px;
      border-radius: 4px;
    }
  }

  .video-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #fff;

    div {
      margin-top: 12px;
    }
  }

  .video-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #fff;

    div {
      margin: 12px 0;
    }
  }

  .video-controls {
    position: absolute;
    bottom: 8px;
    left: 8px;
    display: flex;
    gap: 4px;

    .ant-btn {
      color: #fff;

      &:hover {
        color: #1890ff;
      }
    }
  }

  &:hover .video-controls {
    display: flex;
  }
}
</style>
```

### 4. 视频网格布局组件

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/VideoGrid.vue -->
<template>
  <div class="video-grid" :class="gridClass">
    <div
      v-for="(item, index) in gridItems"
      :key="item.id || index"
      class="video-cell"
      :class="{ 'is-main': index === 0 && layout === '1+7' }"
      @click="handleCellClick(item, index)"
    >
      <VideoPlayer
        v-if="item.streamUrl"
        :ref="el => setPlayerRef(el, index)"
        :device-name="item.deviceName"
        :stream-url="item.streamUrl"
        :auto-play="true"
      />

      <!-- 空白单元格 -->
      <div v-else class="empty-cell">
        <PlusOutlined style="font-size: 32px; color: #999;" />
        <div>点击添加设备</div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue';
import { PlusOutlined } from '@ant-design/icons-vue';
import VideoPlayer from './VideoPlayer.vue';

const props = defineProps({
  layout: {
    type: String,
    default: '4',
    validator: (val) => ['1', '4', '9', '16', '1+7'].includes(val),
  },
  devices: {
    type: Array,
    default: () => [],
  },
});

const emit = defineEmits(['cell-click', 'add-device']);

const playerRefs = ref([]);

const gridClass = computed(() => {
  return `grid-${props.layout.replace('+', '-')}`;
});

const gridItems = computed(() => {
  const count = props.layout === '1+7' ? 8 : parseInt(props.layout);
  const items = [];

  for (let i = 0; i < count; i++) {
    items.push(props.devices[i] || { id: `empty-${i}` });
  }

  return items;
});

const setPlayerRef = (el, index) => {
  if (el) {
    playerRefs.value[index] = el;
  }
};

const handleCellClick = (item, index) => {
  if (item.streamUrl) {
    emit('cell-click', { item, index });
  } else {
    emit('add-device', index);
  }
};

// 截图所有视频
const captureAll = () => {
  const snapshots = [];
  playerRefs.value.forEach((player, index) => {
    if (player && player.captureSnapshot) {
      const snapshot = player.captureSnapshot();
      if (snapshot) {
        snapshots.push({
          index,
          data: snapshot,
          deviceName: props.devices[index]?.deviceName,
        });
      }
    }
  });
  return snapshots;
};

defineExpose({
  captureAll,
  playerRefs,
});
</script>

<style scoped lang="less">
.video-grid {
  display: grid;
  gap: 8px;
  width: 100%;
  height: 100%;
  background: #000;
  padding: 8px;

  &.grid-1 {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
  }

  &.grid-4 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
  }

  &.grid-9 {
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
  }

  &.grid-16 {
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
  }

  &.grid-1-7 {
    grid-template-columns: 3fr 1fr;
    grid-template-rows: repeat(3, 1fr);

    .video-cell.is-main {
      grid-row: span 3;
    }
  }

  .video-cell {
    position: relative;
    background: #1a1a1a;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;

    &:hover {
      outline: 2px solid #1890ff;
      transform: scale(1.02);
      z-index: 10;
    }

    .empty-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;

      div {
        margin-top: 12px;
        font-size: 14px;
      }
    }
  }
}
</style>
```

### 5. 布局选择器组件

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/LayoutSelector.vue -->
<template>
  <a-modal
    :open="visible"
    title="自定义预览排版"
    width="900px"
    @ok="handleConfirm"
    @cancel="handleCancel"
  >
    <div class="layout-selector">
      <div class="selector-description">
        <label>选择预览布局</label>
        <p>选择下方布局样式后,点击"确定"应用新布局</p>
      </div>

      <div class="layout-options">
        <div
          v-for="option in layoutOptions"
          :key="option.value"
          class="layout-option"
          :class="{ selected: selectedLayout === option.value }"
          @click="selectLayout(option.value)"
        >
          <h4>{{ option.title }}</h4>
          <p>{{ option.description }}</p>
          <div class="layout-preview" :style="option.style">
            <div
              v-for="i in option.cellCount"
              :key="i"
              class="preview-cell"
              :class="{ 'is-main': i === 1 && option.value === '1+7' }"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </a-modal>
</template>

<script setup>
import { ref, computed } from 'vue';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  currentLayout: {
    type: String,
    default: '4',
  },
});

const emit = defineEmits(['update:visible', 'confirm', 'cancel']);

const selectedLayout = ref(props.currentLayout);

const layoutOptions = [
  {
    value: '1',
    title: '1×1 单画面',
    description: '适合重点监控单个画面',
    cellCount: 1,
    style: {
      display: 'grid',
      gridTemplateColumns: '1fr',
      gridTemplateRows: '1fr',
    },
  },
  {
    value: '4',
    title: '2×2 四画面',
    description: '可同时查看4个画面',
    cellCount: 4,
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(2, 1fr)',
      gridTemplateRows: 'repeat(2, 1fr)',
    },
  },
  {
    value: '9',
    title: '3×3 九画面',
    description: '可同时查看9个画面',
    cellCount: 9,
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(3, 1fr)',
      gridTemplateRows: 'repeat(3, 1fr)',
    },
  },
  {
    value: '16',
    title: '4×4 十六画面',
    description: '可同时查看16个画面',
    cellCount: 16,
    style: {
      display: 'grid',
      gridTemplateColumns: 'repeat(4, 1fr)',
      gridTemplateRows: 'repeat(4, 1fr)',
    },
  },
  {
    value: '1+7',
    title: '1+7 主次画面',
    description: '1个大画面 + 7个小画面',
    cellCount: 8,
    style: {
      display: 'grid',
      gridTemplateColumns: '3fr 1fr',
      gridTemplateRows: 'repeat(3, 1fr)',
    },
  },
];

const selectLayout = (value) => {
  selectedLayout.value = value;
};

const handleConfirm = () => {
  emit('confirm', selectedLayout.value);
  emit('update:visible', false);
};

const handleCancel = () => {
  selectedLayout.value = props.currentLayout;
  emit('update:visible', false);
  emit('cancel');
};
</script>

<style scoped lang="less">
.layout-selector {
  .selector-description {
    margin-bottom: 20px;

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    p {
      font-size: 13px;
      color: #999;
      margin: 0;
    }
  }

  .layout-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;

    .layout-option {
      padding: 16px;
      border: 2px solid #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;

      &:hover {
        border-color: #1890ff;
        box-shadow: 0 2px 8px rgba(24, 144, 255, 0.2);
      }

      &.selected {
        border-color: #1890ff;
        background: #e6f7ff;

        h4 {
          color: #1890ff;
        }
      }

      h4 {
        font-size: 16px;
        margin: 0 0 8px 0;
      }

      p {
        font-size: 13px;
        color: #999;
        margin: 0 0 16px 0;
      }

      .layout-preview {
        width: 100%;
        height: 120px;
        gap: 4px;
        background: #f5f5f5;
        padding: 4px;
        border-radius: 4px;

        .preview-cell {
          background: #d9d9d9;
          border-radius: 2px;

          &.is-main {
            grid-row: span 3;
          }
        }
      }
    }
  }
}
</style>
```

### 6. 云台控制组件

**技术实现**:
```vue
<!-- src/views/business/smart-video/components/PTZControl.vue -->
<template>
  <a-modal
    :open="visible"
    title="云台控制"
    width="600px"
    @cancel="handleCancel"
    :footer="null"
  >
    <div class="ptz-control">
      <div class="ptz-direction">
        <div class="direction-title">方向控制</div>
        <div class="direction-pad">
          <!-- 上 -->
          <a-button
            class="btn-up"
            @mousedown="handlePTZ('up', 'start')"
            @mouseup="handlePTZ('up', 'stop')"
            @mouseleave="handlePTZ('up', 'stop')"
          >
            <template #icon><ArrowUpOutlined /></template>
          </a-button>

          <!-- 左 -->
          <a-button
            class="btn-left"
            @mousedown="handlePTZ('left', 'start')"
            @mouseup="handlePTZ('left', 'stop')"
            @mouseleave="handlePTZ('left', 'stop')"
          >
            <template #icon><ArrowLeftOutlined /></template>
          </a-button>

          <!-- 中心/自动 -->
          <a-button
            class="btn-center"
            @click="handleAutoScan"
          >
            自动
          </a-button>

          <!-- 右 -->
          <a-button
            class="btn-right"
            @mousedown="handlePTZ('right', 'start')"
            @mouseup="handlePTZ('right', 'stop')"
            @mouseleave="handlePTZ('right', 'stop')"
          >
            <template #icon><ArrowRightOutlined /></template>
          </a-button>

          <!-- 下 -->
          <a-button
            class="btn-down"
            @mousedown="handlePTZ('down', 'start')"
            @mouseup="handlePTZ('down', 'stop')"
            @mouseleave="handlePTZ('down', 'stop')"
          >
            <template #icon><ArrowDownOutlined /></template>
          </a-button>
        </div>
      </div>

      <div class="ptz-zoom">
        <div class="zoom-title">变焦控制</div>
        <div class="zoom-controls">
          <a-button
            @mousedown="handleZoom('in', 'start')"
            @mouseup="handleZoom('in', 'stop')"
            @mouseleave="handleZoom('in', 'stop')"
          >
            <template #icon><ZoomInOutlined /></template>
            放大
          </a-button>

          <a-button
            @mousedown="handleZoom('out', 'start')"
            @mouseup="handleZoom('out', 'stop')"
            @mouseleave="handleZoom('out', 'stop')"
          >
            <template #icon><ZoomOutOutlined /></template>
            缩小
          </a-button>
        </div>
      </div>

      <div class="ptz-preset">
        <div class="preset-title">预置位</div>
        <div class="preset-controls">
          <a-select
            v-model:value="selectedPreset"
            placeholder="选择预置位"
            style="width: 200px;"
          >
            <a-select-option
              v-for="preset in presetList"
              :key="preset.id"
              :value="preset.id"
            >
              {{ preset.name }}
            </a-select-option>
          </a-select>

          <a-button
            type="primary"
            @click="handleGotoPreset"
            :disabled="!selectedPreset"
          >
            调用
          </a-button>

          <a-button @click="handleSetPreset">
            设置
          </a-button>
        </div>
      </div>

      <div class="ptz-speed">
        <div class="speed-title">速度</div>
        <a-slider
          v-model:value="ptzSpeed"
          :min="1"
          :max="7"
          :marks="{ 1: '慢', 4: '中', 7: '快' }"
        />
      </div>
    </div>
  </a-modal>
</template>

<script setup>
import { ref } from 'vue';
import { message } from 'ant-design-vue';
import {
  ArrowUpOutlined,
  ArrowDownOutlined,
  ArrowLeftOutlined,
  ArrowRightOutlined,
  ZoomInOutlined,
  ZoomOutOutlined,
} from '@ant-design/icons-vue';
import { monitorApi } from '/@/api/business/smart-video/monitor-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  deviceId: {
    type: String,
    default: '',
  },
});

const emit = defineEmits(['update:visible', 'cancel']);

const selectedPreset = ref(null);
const ptzSpeed = ref(4);
const presetList = ref([
  { id: 1, name: '预置位1 - 前门' },
  { id: 2, name: '预置位2 - 停车场' },
  { id: 3, name: '预置位3 - 大厅' },
]);

// 云台控制
const handlePTZ = async (direction, action) => {
  try {
    await monitorApi.ptzControl({
      deviceId: props.deviceId,
      command: direction,
      action: action,
      speed: ptzSpeed.value,
    });
  } catch (error) {
    console.error('云台控制失败:', error);
  }
};

// 变焦控制
const handleZoom = async (type, action) => {
  try {
    await monitorApi.ptzControl({
      deviceId: props.deviceId,
      command: type === 'in' ? 'zoomIn' : 'zoomOut',
      action: action,
      speed: ptzSpeed.value,
    });
  } catch (error) {
    console.error('变焦控制失败:', error);
  }
};

// 自动扫描
const handleAutoScan = async () => {
  try {
    await monitorApi.ptzControl({
      deviceId: props.deviceId,
      command: 'autoScan',
      action: 'start',
    });
    message.success('已开启自动扫描');
  } catch (error) {
    console.error('自动扫描失败:', error);
    message.error('开启自动扫描失败');
  }
};

// 调用预置位
const handleGotoPreset = async () => {
  if (!selectedPreset.value) return;

  try {
    await monitorApi.gotoPreset({
      deviceId: props.deviceId,
      presetId: selectedPreset.value,
    });
    message.success('已调用预置位');
  } catch (error) {
    console.error('调用预置位失败:', error);
    message.error('调用预置位失败');
  }
};

// 设置预置位
const handleSetPreset = () => {
  message.info('设置预置位功能开发中');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>

<style scoped lang="less">
.ptz-control {
  padding: 20px;

  .ptz-direction {
    margin-bottom: 30px;

    .direction-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .direction-pad {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      grid-template-rows: repeat(3, 60px);
      gap: 8px;
      justify-content: center;

      .btn-up {
        grid-column: 2;
        grid-row: 1;
      }

      .btn-left {
        grid-column: 1;
        grid-row: 2;
      }

      .btn-center {
        grid-column: 2;
        grid-row: 2;
      }

      .btn-right {
        grid-column: 3;
        grid-row: 2;
      }

      .btn-down {
        grid-column: 2;
        grid-row: 3;
      }

      .ant-btn {
        width: 60px;
        height: 60px;
      }
    }
  }

  .ptz-zoom {
    margin-bottom: 30px;

    .zoom-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .zoom-controls {
      display: flex;
      justify-content: center;
      gap: 12px;

      .ant-btn {
        width: 120px;
      }
    }
  }

  .ptz-preset {
    margin-bottom: 30px;

    .preset-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 16px;
    }

    .preset-controls {
      display: flex;
      gap: 12px;
    }
  }

  .ptz-speed {
    .speed-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 16px;
    }
  }
}
</style>
```

### 7. 主页面集成

**技术实现**:
```vue
<!-- src/views/business/smart-video/monitor-preview.vue -->
<template>
  <div class="monitor-preview-page">
    <div class="page-container">
      <!-- 左侧设备树 -->
      <DeviceTreePanel
        :statistics="deviceStatistics"
        @filter-change="handleFilterChange"
        @area-select="handleAreaSelect"
        @type-select="handleTypeSelect"
      />

      <!-- 右侧视频区域 -->
      <div class="video-section">
        <!-- 工具栏 -->
        <ToolbarActions
          @capture="handleCapture"
          @record-start="handleRecordStart"
          @record-stop="handleRecordStop"
          @open-ptz="handleOpenPTZ"
          @open-layout="handleOpenLayout"
          @auto-switch-change="handleAutoSwitchChange"
        />

        <!-- 视频网格 -->
        <div class="video-container">
          <VideoGrid
            ref="videoGridRef"
            :layout="currentLayout"
            :devices="currentDevices"
            @cell-click="handleCellClick"
            @add-device="handleAddDevice"
          />
        </div>
      </div>
    </div>

    <!-- 布局选择器 -->
    <LayoutSelector
      v-model:visible="layoutModalVisible"
      :current-layout="currentLayout"
      @confirm="handleLayoutConfirm"
    />

    <!-- 云台控制 -->
    <PTZControl
      v-model:visible="ptzModalVisible"
      :device-id="currentDeviceId"
    />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted } from 'vue';
import { message } from 'ant-design-vue';
import DeviceTreePanel from './components/DeviceTreePanel.vue';
import ToolbarActions from './components/ToolbarActions.vue';
import VideoGrid from './components/VideoGrid.vue';
import LayoutSelector from './components/LayoutSelector.vue';
import PTZControl from './components/PTZControl.vue';
import { monitorApi } from '/@/api/business/smart-video/monitor-api';

// 状态定义
const videoGridRef = ref(null);
const currentLayout = ref('4');
const layoutModalVisible = ref(false);
const ptzModalVisible = ref(false);
const currentDeviceId = ref('');

const deviceStatistics = reactive({
  totalCount: 158,
  onlineCount: 156,
  offlineCount: 2,
});

const currentDevices = ref([
  {
    id: '1',
    deviceName: '前门摄像头',
    streamUrl: 'ws://localhost:8080/live/camera1.flv',
  },
  {
    id: '2',
    deviceName: '大厅摄像头',
    streamUrl: 'ws://localhost:8080/live/camera2.flv',
  },
  {
    id: '3',
    deviceName: '走廊摄像头',
    streamUrl: 'ws://localhost:8080/live/camera3.flv',
  },
  {
    id: '4',
    deviceName: '停车场摄像头',
    streamUrl: 'ws://localhost:8080/live/camera4.flv',
  },
]);

let autoSwitchTimer = null;

onMounted(() => {
  loadDeviceData();
});

onUnmounted(() => {
  stopAutoSwitch();
});

// 加载设备数据
const loadDeviceData = async () => {
  try {
    // const res = await monitorApi.getDeviceTree();
    // 处理设备数据
  } catch (error) {
    console.error('加载设备数据失败:', error);
  }
};

// 筛选变化
const handleFilterChange = (type) => {
  console.log('筛选类型:', type);
  // 重新加载设备列表
};

// 区域选择
const handleAreaSelect = (area) => {
  console.log('选择区域:', area);
  // 加载该区域的设备
};

// 类型选择
const handleTypeSelect = (type) => {
  console.log('选择类型:', type);
  // 加载该类型的设备
};

// 截图
const handleCapture = () => {
  if (videoGridRef.value) {
    const snapshots = videoGridRef.value.captureAll();
    if (snapshots.length > 0) {
      message.success(`成功截取 ${snapshots.length} 个画面`);
      // 保存截图
      snapshots.forEach(snapshot => {
        const link = document.createElement('a');
        link.download = `${snapshot.deviceName}_${Date.now()}.png`;
        link.href = snapshot.data;
        link.click();
      });
    }
  }
};

// 开始录像
const handleRecordStart = () => {
  message.success('开始录像');
  // 调用录像API
};

// 停止录像
const handleRecordStop = () => {
  message.success('停止录像');
  // 调用停止录像API
};

// 打开云台控制
const handleOpenPTZ = () => {
  if (!currentDeviceId.value) {
    message.warning('请先选择一个设备');
    return;
  }
  ptzModalVisible.value = true;
};

// 打开布局选择
const handleOpenLayout = () => {
  layoutModalVisible.value = true;
};

// 布局确认
const handleLayoutConfirm = (layout) => {
  currentLayout.value = layout;
  message.success('布局已切换');
};

// 自动轮播
const handleAutoSwitchChange = ({ enabled, interval }) => {
  if (enabled) {
    startAutoSwitch(interval);
  } else {
    stopAutoSwitch();
  }
};

const startAutoSwitch = (interval) => {
  stopAutoSwitch();
  autoSwitchTimer = setInterval(() => {
    // 切换到下一组设备
    console.log('自动切换设备');
  }, interval * 1000);
};

const stopAutoSwitch = () => {
  if (autoSwitchTimer) {
    clearInterval(autoSwitchTimer);
    autoSwitchTimer = null;
  }
};

// 单元格点击
const handleCellClick = ({ item, index }) => {
  currentDeviceId.value = item.id;
  console.log('选中设备:', item);
};

// 添加设备
const handleAddDevice = (index) => {
  message.info('添加设备功能');
};
</script>

<style scoped lang="less">
.monitor-preview-page {
  width: 100%;
  height: 100vh;
  overflow: hidden;

  .page-container {
    display: flex;
    height: 100%;

    .video-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;

      .video-container {
        flex: 1;
        overflow: hidden;
      }
    }
  }
}
</style>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/monitor-mock-data.js

export const mockDeviceTree = {
  all: {
    total: 158,
    online: 156,
    offline: 2,
  },
  areas: [
    {
      id: 'office',
      name: '办公区',
      count: 45,
      devices: [
        {
          id: 'device-001',
          deviceName: '办公区-前门',
          deviceCode: 'CAM-OFFICE-001',
          status: 'online',
          streamUrl: 'ws://localhost:8080/live/office-001.flv',
        },
      ],
    },
    {
      id: 'factory',
      name: '厂区',
      count: 68,
      devices: [],
    },
  ],
};

export const mockStreamUrls = {
  'device-001': {
    hls: 'http://localhost:8080/live/device-001.m3u8',
    flv: 'http://localhost:8080/live/device-001.flv',
    wsFlv: 'ws://localhost:8080/live/device-001.flv',
    webrtc: 'webrtc://localhost:8080/live/device-001',
  },
};

export default {
  mockDeviceTree,
  mockStreamUrls,
};
```

## 路由配置

```javascript
// src/router/business/smart-video.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/monitor-preview',
        name: 'SmartVideoMonitorPreview',
        component: () => import('/@/views/business/smart-video/monitor-preview.vue'),
        meta: {
          title: '智能视频 - 监控预览',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'VideoCameraOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

## 菜单配置

```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  const monitorPreviewMenu = {
    menuId: maxMenuId + 1002,
    menuName: '监控预览',
    menuTitle: '监控预览',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/monitor-preview',
    component: '/business/smart-video/monitor-preview.vue',
    icon: 'VideoCameraOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 2,
    updateTime: new Date().toISOString(),
  };

  menuList.push(monitorPreviewMenu);
}
```

## 常见错误排查清单

### 1. 视频播放相关错误
- [ ] 流地址格式错误：检查流协议和地址是否正确
- [ ] 跨域问题：确保流媒体服务器配置了CORS
- [ ] 播放器未销毁：检查组件卸载时是否正确清理
- [ ] 内存泄漏：监控内存使用，确保播放器实例被释放

### 2. 布局切换问题
- [ ] 播放器残留：切换布局前未清理旧播放器
- [ ] CSS Grid兼容性：确保浏览器支持CSS Grid
- [ ] 响应式问题：检查容器高度设置

### 3. 云台控制问题
- [ ] 设备未选中：确保操作前已选中设备
- [ ] 命令格式错误：检查云台命令参数
- [ ] 权限不足：确认用户有云台控制权限

### 4. 性能问题
- [ ] 同时播放视频过多：建议最多16路同时播放
- [ ] 未使用硬解码：启用浏览器硬件加速
- [ ] 缓冲区设置不当：调整videoBuffer参数

## 最佳实践建议

### ✅ 视频播放优化
1. **使用WebSocket-FLV协议** - 低延迟,适合监控场景
2. **启用硬解码** - 减少CPU占用
3. **合理设置缓冲区** - 平衡延迟和流畅度
4. **分辨率自适应** - 根据窗格大小调整码率
5. **错误重连机制** - 网络波动时自动重连

### ✅ 内存管理
1. **及时销毁播放器** - 组件卸载时清理
2. **限制同时播放数** - 避免内存溢出
3. **使用对象池** - 复用播放器实例
4. **监控内存使用** - 定期检查是否泄漏

### ✅ 用户体验优化
1. **加载状态提示** - 显示加载动画
2. **错误友好提示** - 明确告知错误原因
3. **快捷键支持** - 全屏、截图等快捷操作
4. **保存用户偏好** - 记住布局选择
5. **响应式设计** - 适配不同屏幕尺寸

### ✅ 安全性建议
1. **流地址加密传输** - 使用WSS/HTTPS
2. **token鉴权** - 防止未授权访问
3. **防盗链** - 限制流地址访问来源
4. **录像加密存储** - 本地录像文件加密

## 总结

视频监控预览页面是监控系统的核心功能模块,需要特别注意:

- ✅ **选择合适的视频播放器** - Jessibuca适合低延迟实时流
- ✅ **完善的播放器生命周期管理** - 防止内存泄漏
- ✅ **灵活的多分屏布局** - 支持1/4/9/16及1+7布局
- ✅ **完整的云台控制功能** - 方向、变焦、预置位
- ✅ **截图录像功能** - 方便取证保存
- ✅ **自动轮播机制** - 无人值守监控
- ✅ **性能优化** - 合理控制同时播放数量
- ✅ **错误处理** - 网络异常重连机制

通过遵循本文档的技术规范,可以开发出高性能、低延迟、功能完善的视频监控预览系统。
