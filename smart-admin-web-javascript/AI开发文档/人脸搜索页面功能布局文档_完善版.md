# 人脸搜索页面功能与布局文档

## 页面概述
人脸搜索页面（以图搜图）是智能视频监控系统中的核心AI应用界面，用于通过上传的人脸图片在海量视频监控数据中快速检索匹配的人脸记录。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，集成人脸识别算法，支持多种图片上传方式（本地上传、拖拽上传、摄像头抓拍）、图片质量检测、相似度阈值设置、搜索结果展示、人脸特征分析等完整的以图搜图功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **图片处理库**:
  - cropperjs 1.6.1 (图片裁剪)
  - compressorjs 1.2.1 (图片压缩)
- **工具库**:
  - dayjs 1.11.10 (日期时间处理)
  - lodash-es 4.17.21 (工具函数)

### 项目文件组织结构
```
src/views/business/smart-video/
├── face-search.vue                  # 人脸搜索主页面
├── components/
│   ├── FaceUploadPanel.vue         # 人脸图片上传面板组件
│   ├── FaceImageCropper.vue        # 图片裁剪组件
│   ├── FaceQualityDetector.vue     # 人脸质量检测组件
│   ├── SearchConditionForm.vue     # 搜索条件表单组件
│   ├── FaceSearchProgress.vue      # 搜索进度组件
│   ├── FaceResultGrid.vue          # 搜索结果网格组件
│   ├── FaceResultCard.vue          # 单个搜索结果卡片组件
│   ├── FaceDetailModal.vue         # 人脸详情弹窗组件
│   ├── FaceFeaturePanel.vue        # 人脸特征分析面板组件
│   ├── SearchHistoryPanel.vue      # 搜索历史面板组件
│   └── SimilarityAnalysis.vue      # 相似度分析组件
├── mock/
│   └── face-search-mock-data.js    # 模拟数据
├── api/
│   └── face-search-api.js          # API接口定义
├── utils/
│   ├── face-image-processor.js     # 人脸图片处理工具
│   ├── face-quality-checker.js     # 人脸质量检测工具
│   └── similarity-calculator.js    # 相似度计算工具
└── constants/
    └── face-search-const.js        # 常量定义
```

### API接口设计
```javascript
// src/api/business/smart-video/face-search-api.js
import { postRequest, getRequest, uploadRequest } from '/@/lib/axios';

export const faceSearchApi = {
  // 上传人脸图片
  uploadFaceImage: (formData) => uploadRequest('/face/search/upload', formData),

  // 人脸质量检测
  detectFaceQuality: (params) => postRequest('/face/quality/detect', params),

  // 提取人脸特征
  extractFaceFeatures: (params) => postRequest('/face/features/extract', params),

  // 开始以图搜图
  startFaceSearch: (params) => postRequest('/face/search/start', params),

  // 获取搜索进度
  getSearchProgress: (taskId) => getRequest(`/face/search/progress/${taskId}`),

  // 获取搜索结果
  getSearchResults: (params) => postRequest('/face/search/results', params),

  // 获取人脸详情
  getFaceDetail: (faceId) => getRequest(`/face/detail/${faceId}`),

  // 获取搜索历史
  getSearchHistory: (params) => postRequest('/face/search/history', params),

  // 删除搜索历史
  deleteSearchHistory: (historyId) => postRequest(`/face/search/history/delete/${historyId}`),

  // 清空搜索历史
  clearSearchHistory: () => postRequest('/face/search/history/clear'),

  // 导出搜索结果
  exportSearchResults: (params) => postRequest('/face/search/export', params, { responseType: 'blob' }),

  // 加入人脸库
  addToFaceLibrary: (params) => postRequest('/face/library/add', params),

  // 生成人员卡
  createPersonCard: (params) => postRequest('/face/person-card/create', params),

  // 设置告警
  setFaceAlert: (params) => postRequest('/face/alert/set', params),

  // 获取人脸库列表
  getFaceLibraryList: () => getRequest('/face/library/list'),

  // 获取设备列表（用于搜索范围选择）
  getDeviceList: () => getRequest('/face/search/devices'),

  // 获取相似度算法列表
  getSimilarityAlgorithms: () => getRequest('/face/similarity/algorithms'),

  // 播放关联视频
  playRelatedVideo: (params) => postRequest('/face/video/play', params),

  // 下载人脸图片
  downloadFaceImage: (faceId) => getRequest(`/face/image/download/${faceId}`, { responseType: 'blob' }),

  // 批量下载搜索结果
  batchDownloadResults: (params) => postRequest('/face/search/batch-download', params, { responseType: 'blob' }),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="人脸详情">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="人脸详情"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { FaceOutlined, ScanOutlined } from '@ant-design/icons-vue';  // ❌ 可能不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  CameraOutlined,           // ✅ 摄像头/拍照
  PictureOutlined,          // ✅ 图片
  UploadOutlined,           // ✅ 上传
  SearchOutlined,           // ✅ 搜索
  ReloadOutlined,           // ✅ 重新搜索
  DeleteOutlined,           // ✅ 删除
  DownloadOutlined,         // ✅ 下载
  ExportOutlined,           // ✅ 导出
  EyeOutlined,              // ✅ 查看
  PlayCircleOutlined,       // ✅ 播放
  UserOutlined,             // ✅ 用户/人脸
  TeamOutlined,             // ✅ 人脸库
  HistoryOutlined,          // ✅ 历史记录
  CloseCircleOutlined,      // ✅ 关闭/移除
  CheckCircleOutlined,      // ✅ 确认/成功
  ExclamationCircleOutlined,// ✅ 警告
  InfoCircleOutlined,       // ✅ 信息
  SettingOutlined,          // ✅ 设置
  FilterOutlined,           // ✅ 筛选
  CalendarOutlined,         // ✅ 日历/时间范围
  ClockCircleOutlined,      // ✅ 时间
  EnvironmentOutlined,      // ✅ 地点/位置
  PercentageOutlined,       // ✅ 百分比/相似度
  DatabaseOutlined,         // ✅ 数据库
  IdcardOutlined,           // ✅ 身份卡
  BellOutlined,             // ✅ 告警
  FolderOpenOutlined,       // ✅ 文件夹
  FileImageOutlined,        // ✅ 图片文件
  ZoomInOutlined,           // ✅ 放大
  ZoomOutOutlined,          // ✅ 缩小
  FullscreenOutlined,       // ✅ 全屏
  SyncOutlined,             // ✅ 同步/刷新
  RedoOutlined,             // ✅ 重做
} from '@ant-design/icons-vue';
</script>
```

### 3. 图片上传和处理注意事项

#### ✅ 正确的图片上传处理流程
```vue
<template>
  <div>
    <!-- 支持多种上传方式 -->
    <a-upload
      name="file"
      :multiple="false"
      :show-upload-list="false"
      :before-upload="beforeUpload"
      :custom-request="handleUpload"
      accept="image/jpeg,image/jpg,image/png,image/bmp"
    >
      <a-button>
        <UploadOutlined />
        上传图片
      </a-button>
    </a-upload>

    <!-- 拖拽上传区域 -->
    <div
      class="upload-dragger"
      @drop.prevent="handleDrop"
      @dragover.prevent="handleDragOver"
      @dragleave.prevent="handleDragLeave"
    >
      <p class="upload-icon">
        <CameraOutlined :style="{ fontSize: '48px' }" />
      </p>
      <p class="upload-text">点击或拖拽图片到此区域上传</p>
      <p class="upload-hint">支持 JPG、PNG、BMP 格式，最大 10MB</p>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { message } from 'ant-design-vue';
import { UploadOutlined, CameraOutlined } from '@ant-design/icons-vue';

const imageUrl = ref('');
const imageFile = ref(null);

// 上传前验证
const beforeUpload = (file) => {
  // 检查文件类型
  const isImage = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp'].includes(file.type);
  if (!isImage) {
    message.error('只支持 JPG、PNG、BMP 格式的图片！');
    return false;
  }

  // 检查文件大小（10MB）
  const isLt10M = file.size / 1024 / 1024 < 10;
  if (!isLt10M) {
    message.error('图片大小不能超过 10MB！');
    return false;
  }

  return true;
};

// 自定义上传处理
const handleUpload = async ({ file }) => {
  try {
    // 读取图片为Base64
    const reader = new FileReader();
    reader.onload = (e) => {
      imageUrl.value = e.target.result;
      imageFile.value = file;

      // 进行人脸质量检测
      detectFaceQuality(e.target.result);
    };
    reader.readAsDataURL(file);
  } catch (error) {
    message.error('图片上传失败：' + error.message);
  }
};

// 处理拖拽
const handleDragOver = (e) => {
  e.currentTarget.classList.add('dragover');
};

const handleDragLeave = (e) => {
  e.currentTarget.classList.remove('dragover');
};

const handleDrop = (e) => {
  e.currentTarget.classList.remove('dragover');

  const files = e.dataTransfer.files;
  if (files.length > 0) {
    const file = files[0];
    if (beforeUpload(file)) {
      handleUpload({ file });
    }
  }
};

// 人脸质量检测
const detectFaceQuality = async (imageData) => {
  try {
    const result = await faceSearchApi.detectFaceQuality({ imageData });
    if (result.data.quality < 0.6) {
      message.warning('人脸图片质量较低，可能影响搜索准确率');
    }
  } catch (error) {
    console.error('人脸质量检测失败：', error);
  }
};
</script>

<style lang="less" scoped>
.upload-dragger {
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;

  &:hover,
  &.dragover {
    border-color: #1890ff;
    background-color: #f0f5ff;
  }
}

.upload-icon {
  color: #d9d9d9;
  margin-bottom: 16px;
}

.upload-text {
  font-size: 16px;
  color: rgba(0, 0, 0, 0.85);
  margin-bottom: 8px;
}

.upload-hint {
  font-size: 14px;
  color: rgba(0, 0, 0, 0.45);
}
</style>
```

### 4. 图片裁剪功能实现

#### ✅ 使用 Cropper.js 实现图片裁剪
```vue
<template>
  <a-modal
    :open="visible"
    title="裁剪人脸图片"
    width="800px"
    @cancel="handleCancel"
    @ok="handleConfirm"
  >
    <div class="cropper-container">
      <img ref="imageRef" :src="imageSrc" alt="裁剪图片" />
    </div>

    <div class="cropper-toolbar">
      <a-space>
        <a-button @click="cropper?.rotate(-90)">
          <RedoOutlined :rotate="180" />
          左旋转
        </a-button>
        <a-button @click="cropper?.rotate(90)">
          <RedoOutlined />
          右旋转
        </a-button>
        <a-button @click="cropper?.scaleX(-1)">
          水平翻转
        </a-button>
        <a-button @click="cropper?.scaleY(-1)">
          垂直翻转
        </a-button>
        <a-button @click="cropper?.reset()">
          <ReloadOutlined />
          重置
        </a-button>
      </a-space>
    </div>
  </a-modal>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch } from 'vue';
import Cropper from 'cropperjs';
import 'cropperjs/dist/cropper.css';
import { RedoOutlined, ReloadOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  visible: Boolean,
  imageSrc: String,
});

const emit = defineEmits(['update:visible', 'confirm', 'cancel']);

const imageRef = ref(null);
const cropper = ref(null);

// 初始化裁剪器
const initCropper = () => {
  if (!imageRef.value) return;

  cropper.value = new Cropper(imageRef.value, {
    aspectRatio: 1, // 1:1 比例（人脸图片）
    viewMode: 2,
    dragMode: 'move',
    autoCropArea: 0.8,
    restore: false,
    guides: true,
    center: true,
    highlight: true,
    cropBoxMovable: true,
    cropBoxResizable: true,
    toggleDragModeOnDblclick: false,
  });
};

// 销毁裁剪器
const destroyCropper = () => {
  if (cropper.value) {
    cropper.value.destroy();
    cropper.value = null;
  }
};

// 确认裁剪
const handleConfirm = () => {
  if (!cropper.value) return;

  // 获取裁剪后的图片
  const canvas = cropper.value.getCroppedCanvas({
    width: 400,
    height: 400,
    imageSmoothingQuality: 'high',
  });

  canvas.toBlob((blob) => {
    const croppedImage = new File([blob], 'cropped-face.jpg', {
      type: 'image/jpeg',
      lastModified: Date.now(),
    });

    emit('confirm', croppedImage, canvas.toDataURL('image/jpeg'));
    emit('update:visible', false);
  }, 'image/jpeg', 0.9);
};

// 取消裁剪
const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};

// 监听visible变化
watch(() => props.visible, (newVal) => {
  if (newVal && props.imageSrc) {
    setTimeout(() => {
      initCropper();
    }, 100);
  } else {
    destroyCropper();
  }
});

onUnmounted(() => {
  destroyCropper();
});
</script>

<style lang="less" scoped>
.cropper-container {
  max-height: 500px;
  overflow: hidden;

  img {
    max-width: 100%;
    display: block;
  }
}

.cropper-toolbar {
  margin-top: 16px;
  text-align: center;
}
</style>
```

### 5. 搜索进度实时更新

#### ✅ 使用轮询或WebSocket更新搜索进度
```vue
<script setup>
import { ref, onUnmounted } from 'vue';
import { faceSearchApi } from '/@/api/business/smart-video/face-search-api';

const searchProgress = ref(0);
const processedFrames = ref(0);
const totalFrames = ref(0);
const matchedCount = ref(0);
const searchTaskId = ref('');
const progressTimer = ref(null);

// 开始搜索
const startSearch = async (searchParams) => {
  try {
    // 调用搜索API
    const result = await faceSearchApi.startFaceSearch(searchParams);
    searchTaskId.value = result.data.taskId;

    // 开始轮询搜索进度
    startProgressPolling();
  } catch (error) {
    message.error('搜索启动失败：' + error.message);
  }
};

// 开始轮询进度
const startProgressPolling = () => {
  progressTimer.value = setInterval(async () => {
    try {
      const result = await faceSearchApi.getSearchProgress(searchTaskId.value);
      const progress = result.data;

      searchProgress.value = progress.progress;
      processedFrames.value = progress.processedFrames;
      totalFrames.value = progress.totalFrames;
      matchedCount.value = progress.matchedCount;

      // 搜索完成
      if (progress.progress >= 100) {
        stopProgressPolling();
        loadSearchResults();
      }
    } catch (error) {
      console.error('获取搜索进度失败：', error);
      stopProgressPolling();
    }
  }, 500); // 每500ms轮询一次
};

// 停止轮询
const stopProgressPolling = () => {
  if (progressTimer.value) {
    clearInterval(progressTimer.value);
    progressTimer.value = null;
  }
};

// 加载搜索结果
const loadSearchResults = async () => {
  try {
    const result = await faceSearchApi.getSearchResults({
      taskId: searchTaskId.value,
    });
    // 处理搜索结果...
  } catch (error) {
    message.error('加载搜索结果失败：' + error.message);
  }
};

// 组件卸载时清理定时器
onUnmounted(() => {
  stopProgressPolling();
});
</script>
```

### 6. 相似度阈值设置

#### ✅ 实时更新相似度阈值
```vue
<template>
  <div class="similarity-threshold">
    <div class="threshold-header">
      <span class="label">相似度阈值</span>
      <span class="value">{{ threshold }}%</span>
    </div>

    <a-slider
      v-model:value="threshold"
      :min="60"
      :max="95"
      :step="1"
      :marks="marks"
      :tooltip-visible="true"
      @change="handleThresholdChange"
    />

    <div class="threshold-tips">
      <a-alert
        v-if="threshold < 70"
        type="warning"
        message="阈值较低，可能出现较多误匹配"
        show-icon
      />
      <a-alert
        v-else-if="threshold > 90"
        type="info"
        message="阈值较高，可能遗漏部分匹配结果"
        show-icon
      />
      <a-alert
        v-else
        type="success"
        message="推荐阈值范围，匹配效果较好"
        show-icon
      />
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';

const threshold = ref(80);

const marks = {
  60: '60%',
  70: '70%',
  80: {
    style: {
      color: '#52c41a',
    },
    label: '推荐',
  },
  90: '90%',
  95: '95%',
};

const emit = defineEmits(['change']);

const handleThresholdChange = (value) => {
  emit('change', value);
};
</script>

<style lang="less" scoped>
.similarity-threshold {
  padding: 16px;

  .threshold-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;

    .label {
      font-weight: 500;
      color: rgba(0, 0, 0, 0.85);
    }

    .value {
      font-size: 18px;
      font-weight: 600;
      color: #1890ff;
    }
  }

  .threshold-tips {
    margin-top: 16px;
  }
}
</style>
```

### 7. API导入路径注意事项

#### ✅ 正确：使用项目标准导入路径
```javascript
// 正确的导入路径（使用@别名）
import { faceSearchApi } from '/@/api/business/smart-video/face-search-api';
import { useFaceSearchStore } from '/@/store/modules/business/face-search-store';
import { FACE_SEARCH_CONST } from '/@/constants/business/face-search-const';
```

#### ❌ 错误：使用相对路径
```javascript
// 错误：使用相对路径，维护困难
import { faceSearchApi } from '../../../api/business/smart-video/face-search-api';
import { useFaceSearchStore } from '../../../store/modules/business/face-search-store';
```

### 8. 大数据量搜索结果处理

#### ✅ 使用虚拟滚动优化性能
```vue
<template>
  <div class="result-list-container">
    <a-list
      :data-source="searchResults"
      :pagination="{
        current: currentPage,
        pageSize: pageSize,
        total: totalResults,
        showSizeChanger: true,
        showQuickJumper: true,
        showTotal: (total) => `共 ${total} 条结果`,
      }"
      @change="handlePageChange"
    >
      <template #renderItem="{ item }">
        <a-list-item>
          <FaceResultCard :data="item" @view="handleViewDetail" />
        </a-list-item>
      </template>
    </a-list>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import FaceResultCard from './FaceResultCard.vue';

const searchResults = ref([]);
const currentPage = ref(1);
const pageSize = ref(20);
const totalResults = ref(0);

const handlePageChange = (page, size) => {
  currentPage.value = page;
  pageSize.value = size;
  loadSearchResults();
};

const loadSearchResults = async () => {
  // 加载当前页的搜索结果
  // ...
};
</script>
```

## 页面布局结构

### 整体布局
```vue
<template>
  <div class="face-search-page">
    <!-- 顶部工具栏 -->
    <div class="page-header">
      <div class="header-left">
        <h1 class="page-title">
          <UserOutlined />
          以图搜图
        </h1>
        <a-tag color="processing">
          <SyncOutlined :spin="isSearching" />
          {{ searchStatus }}
        </a-tag>
      </div>

      <div class="header-right">
        <a-space>
          <a-button @click="clearHistory">
            <DeleteOutlined />
            清空历史
          </a-button>
          <a-button type="primary" @click="exportResults">
            <ExportOutlined />
            导出结果
          </a-button>
        </a-space>
      </div>
    </div>

    <!-- 主体内容 -->
    <div class="page-content">
      <!-- 左侧上传面板 -->
      <div class="left-panel">
        <FaceUploadPanel
          v-model:image="searchImage"
          @upload="handleImageUpload"
          @quality-check="handleQualityCheck"
        />

        <SearchConditionForm
          v-if="searchImage"
          v-model:conditions="searchConditions"
          @search="handleStartSearch"
        />
      </div>

      <!-- 中间结果展示区 -->
      <div class="center-panel">
        <!-- 搜索进度 -->
        <FaceSearchProgress
          v-if="isSearching"
          :progress="searchProgress"
          :processed="processedFrames"
          :total="totalFrames"
          :matched="matchedCount"
        />

        <!-- 搜索结果统计 -->
        <div v-if="!isSearching && searchResults.length > 0" class="results-summary">
          <a-card :bordered="false">
            <a-statistic-group>
              <a-statistic title="匹配结果" :value="totalResults" suffix="个" />
              <a-statistic title="搜索用时" :value="searchTime" suffix="秒" />
              <a-statistic title="准确率" :value="96.5" suffix="%" />
            </a-statistic-group>
          </a-card>
        </div>

        <!-- 搜索结果网格 -->
        <FaceResultGrid
          v-if="!isSearching"
          :results="searchResults"
          :loading="loading"
          @view-detail="handleViewDetail"
          @play-video="handlePlayVideo"
        />

        <!-- 空状态 -->
        <a-empty
          v-if="!isSearching && !searchImage"
          description="请上传人脸图片开始搜索"
        >
          <template #image>
            <UserOutlined :style="{ fontSize: '64px', color: '#d9d9d9' }" />
          </template>
        </a-empty>
      </div>

      <!-- 右侧功能面板 -->
      <div class="right-panel">
        <!-- 搜索历史 -->
        <SearchHistoryPanel
          :history="searchHistory"
          @replay="handleReplaySearch"
          @delete="handleDeleteHistory"
        />

        <!-- 人脸特征分析 -->
        <FaceFeaturePanel
          v-if="searchImage"
          :features="faceFeatures"
        />

        <!-- 相似度分析 -->
        <SimilarityAnalysis
          v-model:algorithm="similarityAlgorithm"
          v-model:weights="featureWeights"
        />

        <!-- 快速操作 -->
        <div class="quick-actions">
          <h3 class="panel-title">快速操作</h3>
          <a-space direction="vertical" :style="{ width: '100%' }">
            <a-button block @click="handleAddToLibrary">
              <DatabaseOutlined />
              加入人脸库
            </a-button>
            <a-button block @click="handleCreatePersonCard">
              <IdcardOutlined />
              生成人员卡
            </a-button>
            <a-button block @click="handleSetAlert">
              <BellOutlined />
              设置告警
            </a-button>
            <a-button block @click="handleExportFaceData">
              <ExportOutlined />
              导出数据
            </a-button>
          </a-space>
        </div>
      </div>
    </div>

    <!-- 人脸详情弹窗 -->
    <FaceDetailModal
      :open="detailModalVisible"
      :face-data="selectedFace"
      @update:open="detailModalVisible = $event"
      @play-video="handlePlayVideo"
    />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import {
  UserOutlined,
  SyncOutlined,
  DeleteOutlined,
  ExportOutlined,
  DatabaseOutlined,
  IdcardOutlined,
  BellOutlined,
} from '@ant-design/icons-vue';
import { faceSearchApi } from '/@/api/business/smart-video/face-search-api';
import FaceUploadPanel from './components/FaceUploadPanel.vue';
import SearchConditionForm from './components/SearchConditionForm.vue';
import FaceSearchProgress from './components/FaceSearchProgress.vue';
import FaceResultGrid from './components/FaceResultGrid.vue';
import SearchHistoryPanel from './components/SearchHistoryPanel.vue';
import FaceFeaturePanel from './components/FaceFeaturePanel.vue';
import SimilarityAnalysis from './components/SimilarityAnalysis.vue';
import FaceDetailModal from './components/FaceDetailModal.vue';

// 状态管理
const searchImage = ref('');
const searchConditions = reactive({
  threshold: 80,
  timeRange: 7,
  devices: [],
  faceLibraries: [],
});
const isSearching = ref(false);
const searchStatus = ref('准备搜索');
const searchProgress = ref(0);
const processedFrames = ref(0);
const totalFrames = ref(0);
const matchedCount = ref(0);
const searchResults = ref([]);
const totalResults = ref(0);
const searchTime = ref(0);
const loading = ref(false);
const searchHistory = ref([]);
const faceFeatures = ref(null);
const similarityAlgorithm = ref('cosine');
const featureWeights = reactive({
  face: 70,
  eyes: 20,
  mouth: 10,
});
const detailModalVisible = ref(false);
const selectedFace = ref(null);

// 图片上传处理
const handleImageUpload = async (imageData) => {
  try {
    searchImage.value = imageData;
    // 提取人脸特征
    const result = await faceSearchApi.extractFaceFeatures({ imageData });
    faceFeatures.value = result.data;
  } catch (error) {
    message.error('图片上传失败：' + error.message);
  }
};

// 人脸质量检测
const handleQualityCheck = async (imageData) => {
  try {
    const result = await faceSearchApi.detectFaceQuality({ imageData });
    if (result.data.quality < 0.6) {
      message.warning('人脸图片质量较低，建议重新上传更清晰的图片');
    }
  } catch (error) {
    console.error('质量检测失败：', error);
  }
};

// 开始搜索
const handleStartSearch = async () => {
  if (!searchImage.value) {
    message.warning('请先上传人脸图片');
    return;
  }

  try {
    isSearching.value = true;
    searchStatus.value = '正在搜索...';

    const startTime = Date.now();

    // 调用搜索API
    await startSearch({
      imageData: searchImage.value,
      ...searchConditions,
      algorithm: similarityAlgorithm.value,
      weights: featureWeights,
    });

    searchTime.value = ((Date.now() - startTime) / 1000).toFixed(2);
  } catch (error) {
    message.error('搜索失败：' + error.message);
  } finally {
    isSearching.value = false;
    searchStatus.value = '搜索完成';
  }
};

// 查看详情
const handleViewDetail = (face) => {
  selectedFace.value = face;
  detailModalVisible.value = true;
};

// 播放视频
const handlePlayVideo = async (face) => {
  try {
    await faceSearchApi.playRelatedVideo({
      faceId: face.id,
      timestamp: face.timestamp,
    });
  } catch (error) {
    message.error('播放视频失败：' + error.message);
  }
};

// 重播搜索
const handleReplaySearch = (historyItem) => {
  searchImage.value = historyItem.imageData;
  searchConditions.threshold = historyItem.threshold;
  searchConditions.timeRange = historyItem.timeRange;
  handleStartSearch();
};

// 删除历史
const handleDeleteHistory = async (historyId) => {
  try {
    await faceSearchApi.deleteSearchHistory(historyId);
    loadSearchHistory();
    message.success('删除成功');
  } catch (error) {
    message.error('删除失败：' + error.message);
  }
};

// 清空历史
const clearHistory = async () => {
  try {
    await faceSearchApi.clearSearchHistory();
    searchHistory.value = [];
    message.success('历史记录已清空');
  } catch (error) {
    message.error('清空失败：' + error.message);
  }
};

// 导出结果
const exportResults = async () => {
  if (searchResults.value.length === 0) {
    message.warning('没有可导出的搜索结果');
    return;
  }

  try {
    const blob = await faceSearchApi.exportSearchResults({
      results: searchResults.value,
    });

    // 创建下载链接
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `face-search-results-${Date.now()}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);

    message.success('导出成功');
  } catch (error) {
    message.error('导出失败：' + error.message);
  }
};

// 加入人脸库
const handleAddToLibrary = () => {
  if (!searchImage.value) {
    message.warning('请先上传人脸图片');
    return;
  }
  // 打开加入人脸库弹窗
  // ...
};

// 生成人员卡
const handleCreatePersonCard = () => {
  // 打开生成人员卡弹窗
  // ...
};

// 设置告警
const handleSetAlert = () => {
  // 打开设置告警弹窗
  // ...
};

// 导出人脸数据
const handleExportFaceData = () => {
  // 导出人脸数据
  // ...
};

// 加载搜索历史
const loadSearchHistory = async () => {
  try {
    const result = await faceSearchApi.getSearchHistory({
      pageNo: 1,
      pageSize: 10,
    });
    searchHistory.value = result.data.list;
  } catch (error) {
    console.error('加载搜索历史失败：', error);
  }
};

onMounted(() => {
  loadSearchHistory();
});
</script>

<style lang="less" scoped>
.face-search-page {
  height: 100%;
  display: flex;
  flex-direction: column;
  background-color: #f0f2f5;

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    background-color: #fff;
    border-bottom: 1px solid #e8e8e8;

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;

      .page-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
    }
  }

  .page-content {
    flex: 1;
    display: flex;
    overflow: hidden;

    .left-panel {
      width: 320px;
      background-color: #fff;
      border-right: 1px solid #e8e8e8;
      overflow-y: auto;
      padding: 16px;
    }

    .center-panel {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .right-panel {
      width: 320px;
      background-color: #fff;
      border-left: 1px solid #e8e8e8;
      overflow-y: auto;
      padding: 16px;

      .panel-title {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 16px;
      }

      .quick-actions {
        margin-top: 24px;
      }
    }
  }

  .results-summary {
    margin-bottom: 16px;
  }
}
</style>
```

## 核心组件实现

### 1. 人脸上传面板组件 (FaceUploadPanel.vue)

```vue
<template>
  <div class="face-upload-panel">
    <h3 class="panel-title">上传搜索图片</h3>

    <!-- 上传区域 -->
    <div
      v-if="!imageUrl"
      class="upload-area"
      :class="{ dragover: isDragging }"
      @click="handleClickUpload"
      @drop.prevent="handleDrop"
      @dragover.prevent="handleDragOver"
      @dragleave.prevent="handleDragLeave"
    >
      <input
        ref="fileInputRef"
        type="file"
        accept="image/jpeg,image/jpg,image/png,image/bmp"
        style="display: none"
        @change="handleFileSelect"
      />

      <div class="upload-content">
        <div class="upload-icon">
          <CameraOutlined :style="{ fontSize: '48px' }" />
        </div>
        <p class="upload-text">点击或拖拽上传图片</p>
        <p class="upload-hint">支持 JPG、PNG、BMP 格式</p>
        <p class="upload-hint">最大文件大小: 10MB</p>
      </div>

      <a-divider>或</a-divider>

      <a-space direction="vertical" :style="{ width: '100%' }">
        <a-button block @click.stop="handleCameraCapture">
          <VideoCameraOutlined />
          摄像头抓拍
        </a-button>
        <a-button block @click.stop="handleSelectFromHistory">
          <HistoryOutlined />
          从历史选择
        </a-button>
      </a-space>
    </div>

    <!-- 预览区域 -->
    <div v-else class="preview-area">
      <div class="preview-header">
        <span class="preview-title">搜索图片预览</span>
        <a-space>
          <a-button size="small" @click="handleCropImage">
            <ScissorOutlined />
            裁剪
          </a-button>
          <a-button size="small" danger @click="handleRemoveImage">
            <DeleteOutlined />
            移除
          </a-button>
        </a-space>
      </div>

      <div class="preview-image-container">
        <img :src="imageUrl" alt="预览图片" class="preview-image" />

        <!-- 人脸质量指示器 -->
        <div v-if="qualityScore !== null" class="quality-indicator">
          <a-progress
            type="circle"
            :percent="qualityScore"
            :width="60"
            :stroke-color="getQualityColor(qualityScore)"
          />
          <span class="quality-label">质量评分</span>
        </div>
      </div>

      <!-- 图片信息 -->
      <div class="image-info">
        <a-descriptions :column="1" size="small" bordered>
          <a-descriptions-item label="文件名">
            {{ fileName }}
          </a-descriptions-item>
          <a-descriptions-item label="文件大小">
            {{ formatFileSize(fileSize) }}
          </a-descriptions-item>
          <a-descriptions-item label="图片尺寸">
            {{ imageWidth }} × {{ imageHeight }}
          </a-descriptions-item>
          <a-descriptions-item v-if="faceDetected" label="人脸检测">
            <a-tag color="success">
              <CheckCircleOutlined />
              已检测到人脸
            </a-tag>
          </a-descriptions-item>
        </a-descriptions>
      </div>
    </div>

    <!-- 图片裁剪弹窗 -->
    <FaceImageCropper
      :open="cropperVisible"
      :image-src="imageUrl"
      @update:open="cropperVisible = $event"
      @confirm="handleCropConfirm"
    />

    <!-- 摄像头抓拍弹窗 -->
    <CameraCaptureModal
      :open="cameraVisible"
      @update:open="cameraVisible = $event"
      @capture="handleCameraConfirm"
    />

    <!-- 历史图片选择弹窗 -->
    <HistoryImageSelector
      :open="historyVisible"
      @update:open="historyVisible = $event"
      @select="handleHistorySelect"
    />
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { message } from 'ant-design-vue';
import {
  CameraOutlined,
  VideoCameraOutlined,
  HistoryOutlined,
  ScissorOutlined,
  DeleteOutlined,
  CheckCircleOutlined,
} from '@ant-design/icons-vue';
import FaceImageCropper from './FaceImageCropper.vue';
import CameraCaptureModal from './CameraCaptureModal.vue';
import HistoryImageSelector from './HistoryImageSelector.vue';

const props = defineProps({
  image: String,
});

const emit = defineEmits(['update:image', 'upload', 'quality-check']);

const fileInputRef = ref(null);
const imageUrl = ref('');
const fileName = ref('');
const fileSize = ref(0);
const imageWidth = ref(0);
const imageHeight = ref(0);
const qualityScore = ref(null);
const faceDetected = ref(false);
const isDragging = ref(false);
const cropperVisible = ref(false);
const cameraVisible = ref(false);
const historyVisible = ref(false);

// 点击上传
const handleClickUpload = () => {
  fileInputRef.value?.click();
};

// 文件选择
const handleFileSelect = (e) => {
  const file = e.target.files[0];
  if (file) {
    processFile(file);
  }
};

// 拖拽相关
const handleDragOver = () => {
  isDragging.value = true;
};

const handleDragLeave = () => {
  isDragging.value = false;
};

const handleDrop = (e) => {
  isDragging.value = false;
  const files = e.dataTransfer.files;
  if (files.length > 0) {
    processFile(files[0]);
  }
};

// 处理文件
const processFile = (file) => {
  // 验证文件类型
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp'];
  if (!validTypes.includes(file.type)) {
    message.error('只支持 JPG、PNG、BMP 格式的图片！');
    return;
  }

  // 验证文件大小（10MB）
  if (file.size > 10 * 1024 * 1024) {
    message.error('图片大小不能超过 10MB！');
    return;
  }

  fileName.value = file.name;
  fileSize.value = file.size;

  // 读取图片
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      imageWidth.value = img.width;
      imageHeight.value = img.height;
      imageUrl.value = e.target.result;

      // 触发上传事件
      emit('update:image', e.target.result);
      emit('upload', e.target.result);

      // 进行人脸质量检测
      detectFaceQuality(e.target.result);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
};

// 人脸质量检测
const detectFaceQuality = async (imageData) => {
  try {
    // 调用API进行质量检测
    // const result = await faceSearchApi.detectFaceQuality({ imageData });

    // 模拟质量检测结果
    setTimeout(() => {
      qualityScore.value = Math.floor(Math.random() * 30) + 70; // 70-100
      faceDetected.value = true;

      emit('quality-check', imageData);
    }, 500);
  } catch (error) {
    console.error('质量检测失败：', error);
  }
};

// 移除图片
const handleRemoveImage = () => {
  imageUrl.value = '';
  fileName.value = '';
  fileSize.value = 0;
  imageWidth.value = 0;
  imageHeight.value = 0;
  qualityScore.value = null;
  faceDetected.value = false;

  emit('update:image', '');

  if (fileInputRef.value) {
    fileInputRef.value.value = '';
  }
};

// 裁剪图片
const handleCropImage = () => {
  cropperVisible.value = true;
};

const handleCropConfirm = (file, dataUrl) => {
  imageUrl.value = dataUrl;
  emit('update:image', dataUrl);
  emit('upload', dataUrl);

  // 重新检测质量
  detectFaceQuality(dataUrl);
};

// 摄像头抓拍
const handleCameraCapture = () => {
  cameraVisible.value = true;
};

const handleCameraConfirm = (imageData) => {
  processFile(imageData);
};

// 从历史选择
const handleSelectFromHistory = () => {
  historyVisible.value = true;
};

const handleHistorySelect = (historyItem) => {
  imageUrl.value = historyItem.imageData;
  fileName.value = historyItem.fileName;
  emit('update:image', historyItem.imageData);
  emit('upload', historyItem.imageData);
};

// 工具函数
const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
};

const getQualityColor = (score) => {
  if (score >= 80) return '#52c41a';
  if (score >= 60) return '#faad14';
  return '#ff4d4f';
};
</script>

<style lang="less" scoped>
.face-upload-panel {
  .panel-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 16px;
  }

  .upload-area {
    border: 2px dashed #d9d9d9;
    border-radius: 8px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;

    &:hover,
    &.dragover {
      border-color: #1890ff;
      background-color: #f0f5ff;
    }

    .upload-content {
      .upload-icon {
        color: #d9d9d9;
        margin-bottom: 16px;
      }

      .upload-text {
        font-size: 16px;
        color: rgba(0, 0, 0, 0.85);
        margin-bottom: 8px;
      }

      .upload-hint {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.45);
        margin: 4px 0;
      }
    }
  }

  .preview-area {
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;

      .preview-title {
        font-weight: 500;
      }
    }

    .preview-image-container {
      position: relative;
      margin-bottom: 16px;

      .preview-image {
        width: 100%;
        border-radius: 8px;
        display: block;
      }

      .quality-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-align: center;

        .quality-label {
          display: block;
          margin-top: 8px;
          font-size: 12px;
          color: rgba(0, 0, 0, 0.65);
        }
      }
    }

    .image-info {
      margin-top: 16px;
    }
  }
}
</style>
```

### 2. 搜索条件表单组件 (SearchConditionForm.vue)

```vue
<template>
  <div class="search-condition-form">
    <a-divider>搜索条件</a-divider>

    <a-form layout="vertical">
      <!-- 相似度阈值 -->
      <a-form-item label="相似度阈值 (%)">
        <div class="threshold-control">
          <a-slider
            v-model:value="formData.threshold"
            :min="60"
            :max="95"
            :marks="thresholdMarks"
          />
          <div class="threshold-value">{{ formData.threshold }}%</div>
        </div>

        <a-alert
          v-if="formData.threshold < 70"
          type="warning"
          message="阈值较低，可能出现较多误匹配"
          show-icon
          :style="{ marginTop: '8px' }"
        />
      </a-form-item>

      <!-- 搜索时间范围 -->
      <a-form-item label="搜索时间范围">
        <a-select v-model:value="formData.timeRange" :style="{ width: '100%' }">
          <a-select-option :value="1">最近1天</a-select-option>
          <a-select-option :value="7">最近7天</a-select-option>
          <a-select-option :value="30">最近30天</a-select-option>
          <a-select-option :value="90">最近3个月</a-select-option>
          <a-select-option :value="0">全部时间</a-select-option>
        </a-select>
      </a-form-item>

      <!-- 自定义时间范围 -->
      <a-form-item v-if="formData.timeRange === 0" label="自定义时间">
        <a-range-picker
          v-model:value="customTimeRange"
          :style="{ width: '100%' }"
          :show-time="true"
          format="YYYY-MM-DD HH:mm:ss"
        />
      </a-form-item>

      <!-- 搜索设备 -->
      <a-form-item label="搜索设备">
        <a-tree-select
          v-model:value="formData.devices"
          :tree-data="deviceTreeData"
          :style="{ width: '100%' }"
          tree-checkable
          :show-checked-strategy="TreeSelect.SHOW_PARENT"
          placeholder="请选择设备"
          allow-clear
          tree-default-expand-all
        />
      </a-form-item>

      <!-- 人脸库选择 -->
      <a-form-item label="人脸库选择">
        <a-checkbox-group v-model:value="formData.faceLibraries" :style="{ width: '100%' }">
          <a-row>
            <a-col :span="24" v-for="library in faceLibraries" :key="library.id">
              <a-checkbox :value="library.id">
                {{ library.name }}
                <a-tag size="small" :style="{ marginLeft: '8px' }">
                  {{ library.count }} 人
                </a-tag>
              </a-checkbox>
            </a-col>
          </a-row>
        </a-checkbox-group>
      </a-form-item>

      <!-- 高级选项 -->
      <a-collapse :bordered="false" :style="{ marginBottom: '16px' }">
        <a-collapse-panel key="1" header="高级选项">
          <!-- 最大返回结果数 -->
          <a-form-item label="最大返回结果数">
            <a-input-number
              v-model:value="formData.maxResults"
              :min="10"
              :max="1000"
              :step="10"
              :style="{ width: '100%' }"
            />
          </a-form-item>

          <!-- 人脸角度限制 -->
          <a-form-item label="人脸角度限制">
            <a-checkbox-group v-model:value="formData.faceAngles">
              <a-row>
                <a-col :span="12">
                  <a-checkbox value="front">正面</a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="side">侧面</a-checkbox>
                </a-col>
                <a-col :span="12">
                  <a-checkbox value="oblique">斜面</a-checkbox>
                </a-col>
              </a-row>
            </a-checkbox-group>
          </a-form-item>

          <!-- 人脸质量要求 -->
          <a-form-item label="人脸质量要求">
            <a-select v-model:value="formData.qualityLevel" :style="{ width: '100%' }">
              <a-select-option value="low">低 (>40分)</a-select-option>
              <a-select-option value="medium">中 (>60分)</a-select-option>
              <a-select-option value="high">高 (>80分)</a-select-option>
            </a-select>
          </a-form-item>

          <!-- 去重设置 -->
          <a-form-item label="结果去重">
            <a-switch v-model:checked="formData.deduplication" />
            <span :style="{ marginLeft: '8px', fontSize: '12px', color: 'rgba(0,0,0,0.45)' }">
              自动过滤相似度极高的重复结果
            </span>
          </a-form-item>
        </a-collapse-panel>
      </a-collapse>

      <!-- 搜索按钮 -->
      <a-button
        type="primary"
        size="large"
        block
        :loading="searching"
        @click="handleSearch"
      >
        <SearchOutlined v-if="!searching" />
        开始搜索
      </a-button>
    </a-form>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue';
import { TreeSelect } from 'ant-design-vue';
import { SearchOutlined } from '@ant-design/icons-vue';

const props = defineProps({
  conditions: Object,
  searching: Boolean,
});

const emit = defineEmits(['update:conditions', 'search']);

const formData = reactive({
  threshold: 80,
  timeRange: 7,
  devices: [],
  faceLibraries: [],
  maxResults: 100,
  faceAngles: ['front', 'side', 'oblique'],
  qualityLevel: 'medium',
  deduplication: true,
});

const customTimeRange = ref([]);
const deviceTreeData = ref([]);
const faceLibraries = ref([]);

const thresholdMarks = {
  60: '60',
  70: '70',
  80: {
    style: { color: '#52c41a' },
    label: '推荐',
  },
  90: '90',
  95: '95',
};

// 搜索处理
const handleSearch = () => {
  emit('update:conditions', formData);
  emit('search');
};

// 加载设备树
const loadDeviceTree = async () => {
  // 模拟数据
  deviceTreeData.value = [
    {
      title: '全部设备',
      value: 'all',
      key: 'all',
      children: [
        {
          title: '主入口',
          value: 'entrance-1',
          key: 'entrance-1',
        },
        {
          title: '停车场',
          value: 'parking-1',
          key: 'parking-1',
        },
        {
          title: '大厅',
          value: 'hall-1',
          key: 'hall-1',
        },
      ],
    },
  ];
};

// 加载人脸库列表
const loadFaceLibraries = async () => {
  // 模拟数据
  faceLibraries.value = [
    { id: 'lib-1', name: '重点关注人员', count: 128 },
    { id: 'lib-2', name: '访客库', count: 456 },
    { id: 'lib-3', name: '员工库', count: 892 },
  ];
};

onMounted(() => {
  loadDeviceTree();
  loadFaceLibraries();
});
</script>

<style lang="less" scoped>
.search-condition-form {
  margin-top: 16px;

  .threshold-control {
    position: relative;
    padding-right: 60px;

    .threshold-value {
      position: absolute;
      right: 0;
      top: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1890ff;
    }
  }
}
</style>
```

### 3. 搜索结果网格组件 (FaceResultGrid.vue)

```vue
<template>
  <div class="face-result-grid">
    <a-spin :spinning="loading">
      <div v-if="results.length > 0" class="result-grid">
        <FaceResultCard
          v-for="result in results"
          :key="result.id"
          :data="result"
          @view="handleView"
          @play="handlePlay"
        />
      </div>

      <a-empty
        v-else
        description="未找到匹配结果"
      >
        <template #image>
          <UserOutlined :style="{ fontSize: '64px', color: '#d9d9d9' }" />
        </template>
        <template #description>
          <p>未找到匹配的人脸记录</p>
          <p :style="{ fontSize: '12px', color: 'rgba(0,0,0,0.45)' }">
            请尝试降低相似度阈值或使用更清晰的照片
          </p>
        </template>
      </a-empty>

      <!-- 分页 -->
      <a-pagination
        v-if="results.length > 0"
        v-model:current="currentPage"
        v-model:page-size="pageSize"
        :total="total"
        :show-size-changer="true"
        :show-quick-jumper="true"
        :show-total="(total) => `共 ${total} 条结果`"
        :style="{ marginTop: '24px', textAlign: 'right' }"
        @change="handlePageChange"
      />
    </a-spin>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { UserOutlined } from '@ant-design/icons-vue';
import FaceResultCard from './FaceResultCard.vue';

const props = defineProps({
  results: {
    type: Array,
    default: () => [],
  },
  loading: Boolean,
  total: {
    type: Number,
    default: 0,
  },
});

const emit = defineEmits(['view-detail', 'play-video', 'page-change']);

const currentPage = ref(1);
const pageSize = ref(20);

const handleView = (result) => {
  emit('view-detail', result);
};

const handlePlay = (result) => {
  emit('play-video', result);
};

const handlePageChange = (page, size) => {
  emit('page-change', page, size);
};
</script>

<style lang="less" scoped>
.face-result-grid {
  .result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
}
</style>
```

### 4. 搜索结果卡片组件 (FaceResultCard.vue)

```vue
<template>
  <div class="face-result-card" @click="handleView">
    <div class="card-image">
      <img :src="data.thumbnail || getPlaceholderImage()" alt="人脸照片" />

      <!-- 相似度标签 -->
      <div class="similarity-badge">
        <PercentageOutlined />
        {{ data.similarity }}%
      </div>

      <!-- 置信度标签 -->
      <div class="confidence-badge">
        置信度: {{ data.confidence }}%
      </div>
    </div>

    <div class="card-content">
      <!-- 设备和时间 -->
      <div class="info-row">
        <span class="device-name">
          <EnvironmentOutlined />
          {{ data.deviceName }}
        </span>
        <span class="timestamp">
          <ClockCircleOutlined />
          {{ formatTime(data.timestamp) }}
        </span>
      </div>

      <!-- 人脸属性 -->
      <div class="face-attributes">
        <a-row :gutter="8">
          <a-col :span="12">
            <span class="attr-label">性别:</span>
            <span class="attr-value">{{ data.gender || '未知' }}</span>
          </a-col>
          <a-col :span="12">
            <span class="attr-label">年龄:</span>
            <span class="attr-value">{{ data.age || '未知' }}</span>
          </a-col>
        </a-row>
      </div>

      <!-- 相似度进度条 -->
      <div class="similarity-progress">
        <div class="progress-header">
          <span class="progress-label">匹配度</span>
          <span class="progress-value">{{ data.similarity }}%</span>
        </div>
        <a-progress
          :percent="data.similarity"
          :show-info="false"
          :stroke-color="getSimilarityColor(data.similarity)"
        />
      </div>

      <!-- 操作按钮 -->
      <div class="card-actions">
        <a-button size="small" type="primary" ghost @click.stop="handleView">
          <EyeOutlined />
          详情
        </a-button>
        <a-button size="small" @click.stop="handlePlay">
          <PlayCircleOutlined />
          播放
        </a-button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue';
import dayjs from 'dayjs';
import {
  PercentageOutlined,
  EnvironmentOutlined,
  ClockCircleOutlined,
  EyeOutlined,
  PlayCircleOutlined,
} from '@ant-design/icons-vue';

const props = defineProps({
  data: {
    type: Object,
    required: true,
  },
});

const emit = defineEmits(['view', 'play']);

const handleView = () => {
  emit('view', props.data);
};

const handlePlay = () => {
  emit('play', props.data);
};

const formatTime = (timestamp) => {
  return dayjs(timestamp).format('MM-DD HH:mm:ss');
};

const getSimilarityColor = (similarity) => {
  if (similarity >= 90) return '#52c41a';
  if (similarity >= 80) return '#1890ff';
  if (similarity >= 70) return '#faad14';
  return '#ff4d4f';
};

const getPlaceholderImage = () => {
  return `https://picsum.photos/seed/${props.data.id}/400/400.jpg`;
};
</script>

<style lang="less" scoped>
.face-result-card {
  background: #fff;
  border-radius: 8px;
  border: 1px solid #e8e8e8;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s;

  &:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }

  .card-image {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .similarity-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .confidence-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: #1890ff;
      color: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
  }

  .card-content {
    padding: 12px;

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 13px;

      .device-name {
        font-weight: 500;
        color: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .timestamp {
        color: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        gap: 4px;
      }
    }

    .face-attributes {
      margin-bottom: 12px;
      font-size: 12px;

      .attr-label {
        color: rgba(0, 0, 0, 0.45);
      }

      .attr-value {
        color: rgba(0, 0, 0, 0.85);
        margin-left: 4px;
      }
    }

    .similarity-progress {
      margin-bottom: 12px;

      .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 12px;

        .progress-label {
          color: rgba(0, 0, 0, 0.45);
        }

        .progress-value {
          font-weight: 600;
          color: rgba(0, 0, 0, 0.85);
        }
      }
    }

    .card-actions {
      display: flex;
      gap: 8px;

      button {
        flex: 1;
      }
    }
  }
}
</style>
```

## Store状态管理

### Face Search Store (face-search-store.js)

```javascript
// src/store/modules/business/face-search-store.js
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import { faceSearchApi } from '/@/api/business/smart-video/face-search-api';

export const useFaceSearchStore = defineStore('face-search', () => {
  // 状态
  const searchImage = ref('');
  const searchConditions = ref({
    threshold: 80,
    timeRange: 7,
    devices: [],
    faceLibraries: [],
    maxResults: 100,
    faceAngles: ['front', 'side', 'oblique'],
    qualityLevel: 'medium',
    deduplication: true,
  });
  const searchResults = ref([]);
  const searchHistory = ref([]);
  const isSearching = ref(false);
  const searchProgress = ref({
    progress: 0,
    processedFrames: 0,
    totalFrames: 0,
    matchedCount: 0,
  });
  const faceFeatures = ref(null);
  const deviceList = ref([]);
  const faceLibraries = ref([]);

  // 计算属性
  const hasSearchImage = computed(() => !!searchImage.value);
  const searchResultCount = computed(() => searchResults.value.length);
  const recentSearchHistory = computed(() => searchHistory.value.slice(0, 10));

  // 方法

  // 上传搜索图片
  const uploadSearchImage = async (imageData) => {
    try {
      const result = await faceSearchApi.uploadFaceImage(imageData);
      searchImage.value = result.data.imageUrl;
      return result;
    } catch (error) {
      console.error('上传图片失败：', error);
      throw error;
    }
  };

  // 提取人脸特征
  const extractFaceFeatures = async (imageData) => {
    try {
      const result = await faceSearchApi.extractFaceFeatures({ imageData });
      faceFeatures.value = result.data;
      return result;
    } catch (error) {
      console.error('提取人脸特征失败：', error);
      throw error;
    }
  };

  // 开始搜索
  const startSearch = async (params) => {
    try {
      isSearching.value = true;
      const result = await faceSearchApi.startFaceSearch(params);
      return result;
    } catch (error) {
      console.error('开始搜索失败：', error);
      throw error;
    } finally {
      isSearching.value = false;
    }
  };

  // 更新搜索进度
  const updateSearchProgress = (progress) => {
    searchProgress.value = progress;
  };

  // 设置搜索结果
  const setSearchResults = (results) => {
    searchResults.value = results;
  };

  // 加载搜索历史
  const loadSearchHistory = async () => {
    try {
      const result = await faceSearchApi.getSearchHistory({
        pageNo: 1,
        pageSize: 20,
      });
      searchHistory.value = result.data.list;
      return result;
    } catch (error) {
      console.error('加载搜索历史失败：', error);
      throw error;
    }
  };

  // 删除搜索历史
  const deleteSearchHistory = async (historyId) => {
    try {
      await faceSearchApi.deleteSearchHistory(historyId);
      searchHistory.value = searchHistory.value.filter(item => item.id !== historyId);
    } catch (error) {
      console.error('删除搜索历史失败：', error);
      throw error;
    }
  };

  // 清空搜索历史
  const clearSearchHistory = async () => {
    try {
      await faceSearchApi.clearSearchHistory();
      searchHistory.value = [];
    } catch (error) {
      console.error('清空搜索历史失败：', error);
      throw error;
    }
  };

  // 加载设备列表
  const loadDeviceList = async () => {
    try {
      const result = await faceSearchApi.getDeviceList();
      deviceList.value = result.data;
      return result;
    } catch (error) {
      console.error('加载设备列表失败：', error);
      throw error;
    }
  };

  // 加载人脸库列表
  const loadFaceLibraries = async () => {
    try {
      const result = await faceSearchApi.getFaceLibraryList();
      faceLibraries.value = result.data;
      return result;
    } catch (error) {
      console.error('加载人脸库列表失败：', error);
      throw error;
    }
  };

  // 重置搜索状态
  const resetSearch = () => {
    searchImage.value = '';
    searchResults.value = [];
    isSearching.value = false;
    searchProgress.value = {
      progress: 0,
      processedFrames: 0,
      totalFrames: 0,
      matchedCount: 0,
    };
    faceFeatures.value = null;
  };

  return {
    // 状态
    searchImage,
    searchConditions,
    searchResults,
    searchHistory,
    isSearching,
    searchProgress,
    faceFeatures,
    deviceList,
    faceLibraries,
    // 计算属性
    hasSearchImage,
    searchResultCount,
    recentSearchHistory,
    // 方法
    uploadSearchImage,
    extractFaceFeatures,
    startSearch,
    updateSearchProgress,
    setSearchResults,
    loadSearchHistory,
    deleteSearchHistory,
    clearSearchHistory,
    loadDeviceList,
    loadFaceLibraries,
    resetSearch,
  };
});
```

## 路由配置

```javascript
// src/router/modules/business/smart-video-router.js

export default {
  path: '/smart-video',
  name: 'SmartVideo',
  component: () => import('/@/layout/index.vue'),
  meta: {
    title: '智能视频',
    icon: 'VideoCameraOutlined',
  },
  children: [
    // ... 其他路由
    {
      path: 'face-search',
      name: 'FaceSearch',
      component: () => import('/@/views/business/smart-video/face-search.vue'),
      meta: {
        title: '以图搜图',
        icon: 'UserOutlined',
        keepAlive: true,
      },
    },
  ],
};
```

## 菜单配置

```javascript
// 菜单配置示例
{
  menuName: '以图搜图',
  menuType: 1, // 1-菜单 2-目录 3-按钮
  path: '/smart-video/face-search',
  component: 'business/smart-video/face-search.vue',
  icon: 'UserOutlined',
  parentId: 'smart-video-menu-id',
  visible: true,
  perms: 'smart-video:face-search:view',
  sort: 5,
}
```

## Mock数据示例

```javascript
// src/mock/business/smart-video/face-search-mock.js

export const mockFaceSearchData = {
  // 人脸质量检测结果
  faceQuality: {
    quality: 85,
    faceDetected: true,
    faceCount: 1,
    facePosition: {
      x: 120,
      y: 80,
      width: 160,
      height: 200,
    },
    attributes: {
      clarity: 0.88,
      brightness: 0.75,
      angle: 'front',
      expression: 'normal',
    },
  },

  // 人脸特征数据
  faceFeatures: {
    featurePoints: 68,
    featureVector: [], // 128维特征向量
    attributes: {
      gender: '男',
      age: '25-35',
      expression: '正常',
      angle: '正面',
      hasGlasses: false,
      hasMask: false,
    },
  },

  // 搜索结果
  searchResults: {
    taskId: 'search-task-123456',
    total: 35,
    searchTime: 2.5,
    list: [
      {
        id: 1,
        faceId: 'face-001',
        deviceId: 'device-001',
        deviceName: '主入口',
        channelId: 'channel-001',
        timestamp: '2024-01-30 14:25:36',
        similarity: 95.5,
        confidence: 92.3,
        thumbnail: 'https://picsum.photos/400/400?random=1',
        gender: '男',
        age: '30-35',
        hasGlasses: false,
        hasMask: false,
        location: {
          longitude: 120.123456,
          latitude: 30.654321,
        },
        videoClip: {
          url: 'rtmp://example.com/live/stream1',
          startTime: '2024-01-30 14:25:30',
          endTime: '2024-01-30 14:25:40',
        },
      },
      {
        id: 2,
        faceId: 'face-002',
        deviceId: 'device-002',
        deviceName: '停车场',
        channelId: 'channel-002',
        timestamp: '2024-01-30 13:15:20',
        similarity: 92.8,
        confidence: 89.5,
        thumbnail: 'https://picsum.photos/400/400?random=2',
        gender: '男',
        age: '25-30',
        hasGlasses: false,
        hasMask: false,
        location: {
          longitude: 120.123456,
          latitude: 30.654321,
        },
        videoClip: {
          url: 'rtmp://example.com/live/stream2',
          startTime: '2024-01-30 13:15:15',
          endTime: '2024-01-30 13:15:25',
        },
      },
    ],
  },

  // 搜索历史
  searchHistory: [
    {
      id: 'history-001',
      searchTime: '2024-01-30 14:25:00',
      imageData: 'data:image/jpeg;base64,...',
      fileName: 'face-search-1.jpg',
      threshold: 85,
      timeRange: 7,
      resultCount: 15,
      searchDuration: 2.3,
    },
    {
      id: 'history-002',
      searchTime: '2024-01-30 13:15:00',
      imageData: 'data:image/jpeg;base64,...',
      fileName: 'face-search-2.jpg',
      threshold: 92,
      timeRange: 30,
      resultCount: 8,
      searchDuration: 3.1,
    },
  ],

  // 设备列表
  deviceList: [
    {
      id: 'device-001',
      name: '主入口',
      type: 'camera',
      status: 'online',
      location: '1楼主入口',
    },
    {
      id: 'device-002',
      name: '停车场',
      type: 'camera',
      status: 'online',
      location: '地下停车场',
    },
    {
      id: 'device-003',
      name: '大厅',
      type: 'camera',
      status: 'online',
      location: '1楼大厅',
    },
  ],

  // 人脸库列表
  faceLibraries: [
    {
      id: 'lib-001',
      name: '重点关注人员',
      count: 128,
      createTime: '2024-01-01',
    },
    {
      id: 'lib-002',
      name: '访客库',
      count: 456,
      createTime: '2024-01-01',
    },
    {
      id: 'lib-003',
      name: '员工库',
      count: 892,
      createTime: '2024-01-01',
    },
  ],

  // 相似度算法列表
  similarityAlgorithms: [
    {
      id: 'cosine',
      name: '余弦相似度',
      description: '基于特征向量夹角计算相似度',
    },
    {
      id: 'euclidean',
      name: '欧氏距离',
      description: '基于特征向量距离计算相似度',
    },
    {
      id: 'manhattan',
      name: '曼哈顿距离',
      description: '基于特征向量曼哈顿距离计算相似度',
    },
  ],
};
```

## 常量定义

```javascript
// src/constants/business/face-search-const.js

// 人脸质量等级
export const FACE_QUALITY_LEVEL = {
  LOW: {
    value: 'low',
    label: '低质量',
    range: [0, 40],
    color: '#ff4d4f',
  },
  MEDIUM: {
    value: 'medium',
    label: '中等质量',
    range: [40, 70],
    color: '#faad14',
  },
  HIGH: {
    value: 'high',
    label: '高质量',
    range: [70, 100],
    color: '#52c41a',
  },
};

// 人脸角度类型
export const FACE_ANGLE_TYPE = {
  FRONT: { value: 'front', label: '正面' },
  SIDE: { value: 'side', label: '侧面' },
  OBLIQUE: { value: 'oblique', label: '斜面' },
};

// 相似度算法类型
export const SIMILARITY_ALGORITHM = {
  COSINE: { value: 'cosine', label: '余弦相似度' },
  EUCLIDEAN: { value: 'euclidean', label: '欧氏距离' },
  MANHATTAN: { value: 'manhattan', label: '曼哈顿距离' },
};

// 时间范围选项
export const TIME_RANGE_OPTIONS = [
  { value: 1, label: '最近1天' },
  { value: 7, label: '最近7天' },
  { value: 30, label: '最近30天' },
  { value: 90, label: '最近3个月' },
  { value: 0, label: '全部时间' },
];

// 上传图片限制
export const UPLOAD_IMAGE_LIMIT = {
  MAX_SIZE: 10 * 1024 * 1024, // 10MB
  ALLOWED_TYPES: ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp'],
  ALLOWED_EXTENSIONS: ['.jpg', '.jpeg', '.png', '.bmp'],
};

// 搜索状态
export const SEARCH_STATUS = {
  IDLE: { value: 'idle', label: '准备搜索' },
  SEARCHING: { value: 'searching', label: '正在搜索' },
  COMPLETED: { value: 'completed', label: '搜索完成' },
  FAILED: { value: 'failed', label: '搜索失败' },
};
```

## 最佳实践建议

### 1. 图片上传优化
- 在上传前进行图片压缩，减少网络传输时间
- 使用Base64编码时注意内存占用，大图片建议使用FormData上传
- 提供图片裁剪功能，让用户选择人脸区域

### 2. 搜索性能优化
- 使用异步搜索，避免阻塞UI
- 实现搜索进度实时反馈
- 对搜索结果进行分页，避免一次加载过多数据
- 使用虚拟滚动优化大量结果的渲染性能

### 3. 用户体验优化
- 提供相似度阈值建议值
- 显示人脸质量评分，帮助用户了解图片质量
- 提供搜索历史快速重播功能
- 支持结果导出和批量下载

### 4. 错误处理
- 图片上传失败时提供明确的错误提示
- 搜索超时时自动重试或提示用户
- 网络异常时保存搜索条件，方便用户重新搜索

### 5. 安全性考虑
- 限制上传图片的大小和格式
- 对人脸数据进行脱敏处理
- 实现访问权限控制
- 记录搜索日志，方便审计

### 6. 性能监控
- 监控搜索响应时间
- 统计搜索成功率
- 分析用户搜索习惯，优化默认参数

## 常见问题与解决方案

### Q1: 图片上传后无法检测到人脸
**解决方案**:
- 检查图片清晰度，确保人脸区域清晰可见
- 确认人脸角度，正面照片效果最好
- 检查光照条件，避免过暗或过曝
- 确保人脸未被遮挡（口罩、墨镜等）

### Q2: 搜索结果相似度较低
**解决方案**:
- 降低相似度阈值
- 使用更清晰的搜索图片
- 检查人脸特征提取是否正常
- 尝试不同的相似度算法

### Q3: 搜索速度慢
**解决方案**:
- 缩小搜索时间范围
- 减少搜索设备数量
- 限制最大返回结果数
- 优化后端索引和查询算法

### Q4: 大量重复结果
**解决方案**:
- 启用结果去重功能
- 调整去重相似度阈值
- 按时间或设备进行结果聚合

### Q5: 内存占用过高
**解决方案**:
- 使用虚拟滚动减少DOM节点
- 限制同时显示的结果数量
- 及时清理不需要的图片缓存
- 使用缩略图代替原图展示

---

**文档版本**: v1.0.0
**最后更新**: 2024-01-30
**文档维护**: SmartAdmin开发团队
