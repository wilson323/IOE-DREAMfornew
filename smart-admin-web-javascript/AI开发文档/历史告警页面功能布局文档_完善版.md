# 历史告警管理页面功能与布局文档

## 页面概述
历史告警管理页面是智能视频监控系统中的核心运维界面，用于管理和查询系统中所有历史告警记录，包括移动侦测、入侵检测、人脸识别、车牌识别等多种告警类型。该页面基于SmartAdmin前端框架构建，采用Vue3 + Ant Design Vue技术栈，提供完整的告警查询、处理、统计分析等功能。

## 技术架构规范

### 前端技术栈
- **核心框架**: Vue 3.4.27 (Composition API)
- **UI组件库**: Ant Design Vue 4.2.5
- **状态管理**: Pinia 2.1.7
- **路由管理**: Vue Router 4.3.2
- **HTTP客户端**: Axios 1.6.8
- **样式预处理器**: Less 4.2.0
- **图标库**: @ant-design/icons-vue
- **图表库**: ECharts 5.4.3 (用于告警统计图表)

### 项目文件组织结构
```
src/views/business/smart-video/
├── history-alarm.vue                # 历史告警管理主页面
├── components/
│   ├── AlarmFilter.vue             # 告警筛选组件
│   ├── AlarmDetailModal.vue        # 告警详情弹窗组件
│   ├── AlarmProcessModal.vue       # 告警处理弹窗组件
│   ├── AlarmStatisticsChart.vue    # 告警统计图表组件
│   └── AlarmMediaViewer.vue        # 告警媒体文件查看器（图片/视频）
├── mock/
│   └── alarm-mock-data.js          # 模拟数据
└── api/
    └── alarm-api.js                # API接口定义
```

### API接口设计
```javascript
// src/api/business/smart-video/alarm-api.js
import { postRequest, getRequest } from '/@/lib/axios';

export const alarmApi = {
  // 查询历史告警列表
  queryAlarmList: (params) => postRequest('/alarm/history/query', params),

  // 获取告警详情
  getAlarmDetail: (alarmId) => getRequest(`/alarm/detail/${alarmId}`),

  // 处理告警
  processAlarm: (params) => postRequest('/alarm/process', params),

  // 批量处理告警
  batchProcessAlarm: (params) => postRequest('/alarm/batch/process', params),

  // 忽略告警
  ignoreAlarm: (alarmId, reason) => postRequest('/alarm/ignore', { alarmId, reason }),

  // 批量忽略告警
  batchIgnoreAlarm: (params) => postRequest('/alarm/batch/ignore', params),

  // 清空告警
  clearAlarms: (params) => postRequest('/alarm/clear', params),

  // 导出告警记录
  exportAlarms: (params) => postRequest('/alarm/export', params, { responseType: 'blob' }),

  // 获取告警统计数据
  getAlarmStatistics: (params) => postRequest('/alarm/statistics', params),

  // 获取告警级别分布
  getAlarmLevelDistribution: (params) => postRequest('/alarm/statistics/level', params),

  // 获取告警类型分布
  getAlarmTypeDistribution: (params) => postRequest('/alarm/statistics/type', params),

  // 获取告警趋势数据
  getAlarmTrend: (params) => postRequest('/alarm/statistics/trend', params),

  // 获取设备告警排名
  getDeviceAlarmRanking: (params) => postRequest('/alarm/statistics/device-ranking', params),

  // 获取告警媒体文件（图片/视频）
  getAlarmMedia: (alarmId, mediaType) => getRequest(`/alarm/media/${alarmId}/${mediaType}`),

  // 播放告警录像
  playAlarmVideo: (alarmId) => postRequest(`/alarm/video/play/${alarmId}`),

  // 下载告警媒体文件
  downloadAlarmMedia: (alarmId, mediaType) => getRequest(`/alarm/media/download/${alarmId}/${mediaType}`, { responseType: 'blob' }),
};
```

## ⚠️ 开发注意事项与常见错误避免

### 1. Vue 3 组件开发注意事项

#### ❌ 错误用法：在 props 上使用 v-model
```vue
<!-- 错误：不能在props上使用v-model -->
<template>
  <a-modal v-model:open="visible" title="告警详情">
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean  // props是只读的，不能直接绑定v-model
});
</script>
```

#### ✅ 正确用法：使用 :open 绑定和事件
```vue
<!-- 正确：使用属性绑定和事件监听 -->
<template>
  <a-modal
    :open="visible"
    title="告警详情"
    @close="handleClose"
    @cancel="handleCancel"
  >
    <!-- 内容 -->
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
});

const emit = defineEmits(['update:visible', 'close', 'cancel']);

const handleClose = () => {
  emit('update:visible', false);
  emit('close');
};

const handleCancel = () => {
  emit('update:visible', false);
  emit('cancel');
};
</script>
```

### 2. 图标导入注意事项

#### ❌ 错误：使用不存在的图标
```vue
<!-- 错误：某些图标可能不存在 -->
<script setup>
import { AlarmOutlined } from '@ant-design/icons-vue';  // ❌ 可能不存在
</script>
```

#### ✅ 正确：使用存在的图标
```vue
<!-- 正确：使用实际存在的图标 -->
<script setup>
import {
  SearchOutlined,           // ✅ 搜索
  ReloadOutlined,           // ✅ 重置/刷新
  ExportOutlined,           // ✅ 导出
  DeleteOutlined,           // ✅ 删除
  SyncOutlined,             // ✅ 刷新
  FilterOutlined,           // ✅ 筛选
  DownOutlined,             // ✅ 下拉
  UpOutlined,               // ✅ 上拉
  UnorderedListOutlined,    // ✅ 列表
  BarChartOutlined,         // ✅ 图表
  EyeOutlined,              // ✅ 查看
  CheckCircleOutlined,      // ✅ 确认/在线
  CloseCircleOutlined,      // ✅ 关闭/离线
  ExclamationCircleOutlined,// ✅ 警告/告警
  InfoCircleOutlined,       // ✅ 信息
  PlayCircleOutlined,       // ✅ 播放
  CameraOutlined,           // ✅ 摄像机/抓拍
  BellOutlined,             // ✅ 告警铃铛
  WarningOutlined,          // ✅ 警告
  CalendarOutlined,         // ✅ 日历
  ClockCircleOutlined,      // ✅ 时间
  DownloadOutlined,         // ✅ 下载
} from '@ant-design/icons-vue';
</script>
```

### 3. 告警级别和类型枚举定义

#### ✅ 标准告警枚举常量
```javascript
// src/constants/business/alarm-const.js

// 告警级别枚举
export const ALARM_LEVEL_ENUM = {
  CRITICAL: {
    value: 'critical',
    label: '紧急',
    color: '#ef4444',      // 红色
    bgColor: '#fee2e2',    // 浅红背景
    textColor: '#991b1b',  // 深红文字
    icon: 'ExclamationCircleOutlined',
  },
  MAJOR: {
    value: 'major',
    label: '重要',
    color: '#f97316',      // 橙色
    bgColor: '#ffedd5',    // 浅橙背景
    textColor: '#9a3412',  // 深橙文字
    icon: 'WarningOutlined',
  },
  MINOR: {
    value: 'minor',
    label: '一般',
    color: '#eab308',      // 黄色
    bgColor: '#fef9c3',    // 浅黄背景
    textColor: '#854d0e',  // 深黄文字
    icon: 'InfoCircleOutlined',
  },
  INFO: {
    value: 'info',
    label: '提示',
    color: '#3b82f6',      // 蓝色
    bgColor: '#dbeafe',    // 浅蓝背景
    textColor: '#1e3a8a',  // 深蓝文字
    icon: 'BellOutlined',
  },
};

// 告警类型枚举
export const ALARM_TYPE_ENUM = {
  MOTION: {
    value: 'motion',
    label: '移动侦测',
    icon: 'EyeOutlined',
  },
  INTRUSION: {
    value: 'intrusion',
    label: '入侵检测',
    icon: 'WarningOutlined',
  },
  FACE: {
    value: 'face',
    label: '人脸识别',
    icon: 'UserOutlined',
  },
  LICENSE: {
    value: 'license',
    label: '车牌识别',
    icon: 'CarOutlined',
  },
  LINE: {
    value: 'line',
    label: '越线检测',
    icon: 'BorderOutlined',
  },
  CROWD: {
    value: 'crowd',
    label: '人群聚集',
    icon: 'TeamOutlined',
  },
  DEVICE: {
    value: 'device',
    label: '设备异常',
    icon: 'ExclamationCircleOutlined',
  },
};

// 告警处理状态枚举
export const ALARM_PROCESS_STATUS_ENUM = {
  PENDING: {
    value: 'pending',
    label: '待处理',
    color: 'default',
    bgColor: '#f3f4f6',
    textColor: '#6b7280',
  },
  PROCESSING: {
    value: 'processing',
    label: '处理中',
    color: 'processing',
    bgColor: '#dbeafe',
    textColor: '#1e40af',
  },
  RESOLVED: {
    value: 'resolved',
    label: '已处理',
    color: 'success',
    bgColor: '#dcfce7',
    textColor: '#166534',
  },
  IGNORED: {
    value: 'ignored',
    label: '已忽略',
    color: 'error',
    bgColor: '#fee2e2',
    textColor: '#991b1b',
  },
};
```

### 4. API导入路径注意事项

#### ✅ 正确：使用项目标准导入路径
```javascript
// 正确：使用项目中实际的axios文件
import { postRequest, getRequest } from '/@/lib/axios';
```

## 核心功能模块

### 1. 搜索与筛选功能
**位置**: 页面顶部工具栏区域

**功能说明**:
- **基础筛选**: 开始时间、结束时间、告警级别、告警类型
- **高级筛选**: 设备名称、通道名称、处理状态（可展开/收起）
- **快捷时间选择**: 今天、昨天、近7天、近30天

**技术实现**:
```vue
<template>
  <div class="smart-query-table-form">
    <!-- 标题栏 -->
    <div class="filter-header">
      <div class="filter-title">
        <FilterOutlined />
        <span>查询条件</span>
      </div>
      <a-button type="link" size="small" @click="toggleMoreFilters">
        <template #icon>
          <DownOutlined v-if="!showMoreFilters" />
          <UpOutlined v-else />
        </template>
        {{ showMoreFilters ? '收起' : '更多' }}
      </a-button>
    </div>

    <!-- 基础筛选条件 -->
    <a-row :gutter="16" class="filter-row">
      <a-col :span="6">
        <a-form-item label="开始时间">
          <a-date-picker
            v-model:value="queryForm.startTime"
            show-time
            placeholder="请选择开始时间"
            format="YYYY-MM-DD HH:mm:ss"
            style="width: 100%"
            allowClear
          />
        </a-form-item>
      </a-col>

      <a-col :span="6">
        <a-form-item label="结束时间">
          <a-date-picker
            v-model:value="queryForm.endTime"
            show-time
            placeholder="请选择结束时间"
            format="YYYY-MM-DD HH:mm:ss"
            style="width: 100%"
            allowClear
          />
        </a-form-item>
      </a-col>

      <a-col :span="4">
        <a-form-item label="告警级别">
          <a-select
            v-model:value="queryForm.alarmLevel"
            placeholder="全部级别"
            allowClear
          >
            <a-select-option value="">全部级别</a-select-option>
            <a-select-option value="critical">紧急</a-select-option>
            <a-select-option value="major">重要</a-select-option>
            <a-select-option value="minor">一般</a-select-option>
            <a-select-option value="info">提示</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>

      <a-col :span="4">
        <a-form-item label="告警类型">
          <a-select
            v-model:value="queryForm.alarmType"
            placeholder="全部类型"
            allowClear
          >
            <a-select-option value="">全部类型</a-select-option>
            <a-select-option value="motion">移动侦测</a-select-option>
            <a-select-option value="intrusion">入侵检测</a-select-option>
            <a-select-option value="face">人脸识别</a-select-option>
            <a-select-option value="license">车牌识别</a-select-option>
            <a-select-option value="line">越线检测</a-select-option>
            <a-select-option value="crowd">人群聚集</a-select-option>
            <a-select-option value="device">设备异常</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>

      <a-col :span="4">
        <a-form-item>
          <a-space>
            <a-button type="primary" @click="queryData">
              <template #icon><SearchOutlined /></template>
              查询
            </a-button>
            <a-button @click="resetQuery">
              <template #icon><ReloadOutlined /></template>
              重置
            </a-button>
          </a-space>
        </a-form-item>
      </a-col>
    </a-row>

    <!-- 高级筛选条件（可展开） -->
    <a-row v-if="showMoreFilters" :gutter="16" class="filter-row more-filters">
      <a-col :span="6">
        <a-form-item label="设备名称">
          <a-input
            v-model:value="queryForm.deviceName"
            placeholder="请输入设备名称"
            allowClear
          />
        </a-form-item>
      </a-col>

      <a-col :span="6">
        <a-form-item label="通道名称">
          <a-input
            v-model:value="queryForm.channelName"
            placeholder="请输入通道名称"
            allowClear
          />
        </a-form-item>
      </a-col>

      <a-col :span="4">
        <a-form-item label="处理状态">
          <a-select
            v-model:value="queryForm.processStatus"
            placeholder="全部状态"
            allowClear
          >
            <a-select-option value="">全部状态</a-select-option>
            <a-select-option value="pending">待处理</a-select-option>
            <a-select-option value="processing">处理中</a-select-option>
            <a-select-option value="resolved">已处理</a-select-option>
            <a-select-option value="ignored">已忽略</a-select-option>
          </a-select>
        </a-form-item>
      </a-col>
    </a-row>

    <!-- 快捷时间选择 -->
    <div class="quick-time-selector">
      <span class="label">快捷选择：</span>
      <a-space>
        <a-button size="small" @click="selectQuickTime('today')">今天</a-button>
        <a-button size="small" @click="selectQuickTime('yesterday')">昨天</a-button>
        <a-button size="small" @click="selectQuickTime('week')">近7天</a-button>
        <a-button size="small" @click="selectQuickTime('month')">近30天</a-button>
      </a-space>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { message } from 'ant-design-vue';
import dayjs from 'dayjs';
import {
  FilterOutlined,
  DownOutlined,
  UpOutlined,
  SearchOutlined,
  ReloadOutlined,
} from '@ant-design/icons-vue';

const showMoreFilters = ref(false);

const queryForm = reactive({
  startTime: null,
  endTime: null,
  alarmLevel: '',
  alarmType: '',
  deviceName: '',
  channelName: '',
  processStatus: '',
});

const toggleMoreFilters = () => {
  showMoreFilters.value = !showMoreFilters.value;
};

const selectQuickTime = (type) => {
  const now = dayjs();
  switch (type) {
    case 'today':
      queryForm.startTime = now.startOf('day');
      queryForm.endTime = now.endOf('day');
      break;
    case 'yesterday':
      queryForm.startTime = now.subtract(1, 'day').startOf('day');
      queryForm.endTime = now.subtract(1, 'day').endOf('day');
      break;
    case 'week':
      queryForm.startTime = now.subtract(7, 'day').startOf('day');
      queryForm.endTime = now.endOf('day');
      break;
    case 'month':
      queryForm.startTime = now.subtract(30, 'day').startOf('day');
      queryForm.endTime = now.endOf('day');
      break;
  }
  message.success('已选择时间范围');
};

const queryData = () => {
  console.log('查询告警', queryForm);
  // 调用API查询
};

const resetQuery = () => {
  Object.assign(queryForm, {
    startTime: null,
    endTime: null,
    alarmLevel: '',
    alarmType: '',
    deviceName: '',
    channelName: '',
    processStatus: '',
  });
  queryData();
};
</script>

<style lang="less" scoped>
.smart-query-table-form {
  background: #fff;
  padding: 16px;
  margin-bottom: 16px;
  border-radius: 8px;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);

  .filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0;

    .filter-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #1890ff;
    }
  }

  .filter-row {
    margin-bottom: 0;
  }

  .more-filters {
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
    animation: slideDown 0.3s ease-in-out;
  }

  .quick-time-selector {
    display: flex;
    align-items: center;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;

    .label {
      color: #999;
      margin-right: 8px;
    }
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
```

### 2. 主操作按钮区
**位置**: 筛选区域下方

**功能说明**:
- **刷新**: 刷新告警列表数据
- **清空告警**: 清空所有或筛选后的告警记录
- **导出**: 导出告警记录为Excel文件
- **视图切换**: 列表视图/图表统计视图切换

**技术实现**:
```vue
<template>
  <div class="alarm-operation-bar">
    <div class="left-operations">
      <a-space>
        <a-button type="primary" @click="refreshData">
          <template #icon><SyncOutlined :spin="loading" /></template>
          刷新
        </a-button>

        <a-popconfirm
          title="确定要清空所有告警记录吗？此操作不可恢复！"
          ok-text="确定"
          cancel-text="取消"
          @confirm="clearAllAlarms"
        >
          <a-button danger>
            <template #icon><DeleteOutlined /></template>
            清空告警
          </a-button>
        </a-popconfirm>

        <a-button @click="exportAlarms">
          <template #icon><DownloadOutlined /></template>
          导出
        </a-button>
      </a-space>
    </div>

    <div class="right-operations">
      <a-space>
        <span class="total-count">
          共 <span class="count-number">{{ totalCount }}</span> 条告警
        </span>

        <a-button-group>
          <a-button
            :type="currentView === 'list' ? 'primary' : 'default'"
            @click="switchView('list')"
          >
            <template #icon><UnorderedListOutlined /></template>
            列表
          </a-button>
          <a-button
            :type="currentView === 'chart' ? 'primary' : 'default'"
            @click="switchView('chart')"
          >
            <template #icon><BarChartOutlined /></template>
            图表
          </a-button>
        </a-button-group>
      </a-space>
    </div>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { message, Modal } from 'ant-design-vue';
import {
  SyncOutlined,
  DeleteOutlined,
  DownloadOutlined,
  UnorderedListOutlined,
  BarChartOutlined,
} from '@ant-design/icons-vue';
import { alarmApi } from '/@/api/business/smart-video/alarm-api';

const loading = ref(false);
const currentView = ref('list');
const totalCount = ref(0);

const emit = defineEmits(['refresh', 'view-change']);

const refreshData = async () => {
  loading.value = true;
  try {
    emit('refresh');
    message.success('数据刷新成功');
  } finally {
    setTimeout(() => {
      loading.value = false;
    }, 500);
  }
};

const clearAllAlarms = async () => {
  try {
    const response = await alarmApi.clearAlarms({});
    if (response.code === 1) {
      message.success('清空成功');
      emit('refresh');
    } else {
      message.error(response.msg || '清空失败');
    }
  } catch (error) {
    console.error('清空告警失败:', error);
    message.error('清空失败');
  }
};

const exportAlarms = async () => {
  try {
    message.loading('正在导出，请稍候...', 0);
    const response = await alarmApi.exportAlarms({});
    message.destroy();

    // 创建下载链接
    const blob = new Blob([response], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `告警记录_${new Date().getTime()}.xlsx`;
    link.click();
    window.URL.revokeObjectURL(url);

    message.success('导出成功');
  } catch (error) {
    message.destroy();
    console.error('导出失败:', error);
    message.error('导出失败');
  }
};

const switchView = (view) => {
  currentView.value = view;
  emit('view-change', view);
};
</script>

<style lang="less" scoped>
.alarm-operation-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #fff;
  margin-bottom: 16px;
  border-radius: 8px;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);

  .right-operations {
    .total-count {
      color: #666;

      .count-number {
        font-size: 18px;
        font-weight: 600;
        color: #1890ff;
        margin: 0 4px;
      }
    }
  }
}
</style>
```

### 3. 告警列表表格（列表视图）
**位置**: 操作区域下方

**表格列配置**:
```vue
<template>
  <a-card v-show="currentView === 'list'" class="alarm-table-card">
    <a-table
      :columns="columns"
      :data-source="tableData"
      :pagination="pagination"
      :loading="tableLoading"
      :row-selection="rowSelection"
      :scroll="{ x: 1600, y: 'calc(100vh - 450px)' }"
      row-key="id"
      bordered
      @change="handleTableChange"
    >
      <template #bodyCell="{ column, record, text }">
        <!-- 复选框列 -->
        <template v-if="column.dataIndex === 'selection'">
          <a-checkbox v-model:checked="record.selected" />
        </template>

        <!-- 告警级别 -->
        <template v-else-if="column.dataIndex === 'alarmLevel'">
          <a-tag :color="getAlarmLevelConfig(record.alarmLevel).color">
            <template #icon>
              <component :is="getAlarmLevelConfig(record.alarmLevel).icon" />
            </template>
            {{ getAlarmLevelConfig(record.alarmLevel).label }}
          </a-tag>
        </template>

        <!-- 告警类型 -->
        <template v-else-if="column.dataIndex === 'alarmType'">
          <span>{{ getAlarmTypeLabel(record.alarmType) }}</span>
        </template>

        <!-- 设备/通道 -->
        <template v-else-if="column.dataIndex === 'device'">
          <div class="device-info">
            <div class="device-name">{{ record.deviceName }}</div>
            <div class="channel-name">{{ record.channelName }}</div>
          </div>
        </template>

        <!-- 告警内容 -->
        <template v-else-if="column.dataIndex === 'content'">
          <a-tooltip :title="record.content">
            <div class="alarm-content">{{ record.content }}</div>
          </a-tooltip>
        </template>

        <!-- 处理状态 -->
        <template v-else-if="column.dataIndex === 'status'">
          <a-tag :color="getProcessStatusConfig(record.status).color">
            {{ getProcessStatusConfig(record.status).label }}
          </a-tag>
        </template>

        <!-- 文件列 -->
        <template v-else-if="column.dataIndex === 'media'">
          <a-space>
            <a-tooltip v-if="record.hasVideo" title="播放录像">
              <a-button
                type="link"
                size="small"
                @click="playVideo(record)"
              >
                <template #icon><PlayCircleOutlined /></template>
              </a-button>
            </a-tooltip>

            <a-tooltip v-if="record.hasCapture" title="查看抓拍">
              <a-button
                type="link"
                size="small"
                @click="viewCapture(record)"
              >
                <template #icon><CameraOutlined /></template>
              </a-button>
            </a-tooltip>

            <span v-if="!record.hasVideo && !record.hasCapture" class="no-media">-</span>
          </a-space>
        </template>

        <!-- 操作列 -->
        <template v-else-if="column.dataIndex === 'action'">
          <div class="smart-table-operate">
            <a-button type="link" size="small" @click="viewDetail(record)">
              <template #icon><EyeOutlined /></template>
              查看
            </a-button>

            <a-button
              v-if="record.status === 'pending'"
              type="link"
              size="small"
              @click="processAlarm(record)"
            >
              <template #icon><CheckCircleOutlined /></template>
              处理
            </a-button>

            <a-popconfirm
              v-if="record.status === 'pending'"
              title="确定要忽略该告警吗？"
              @confirm="ignoreAlarm(record)"
            >
              <a-button type="link" size="small" danger>
                <template #icon><CloseCircleOutlined /></template>
                忽略
              </a-button>
            </a-popconfirm>
          </div>
        </template>
      </template>
    </a-table>
  </a-card>
</template>

<script setup>
import { ref, reactive, computed, h } from 'vue';
import { message } from 'ant-design-vue';
import {
  PlayCircleOutlined,
  CameraOutlined,
  EyeOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ExclamationCircleOutlined,
  WarningOutlined,
  InfoCircleOutlined,
  BellOutlined,
} from '@ant-design/icons-vue';
import { ALARM_LEVEL_ENUM, ALARM_TYPE_ENUM, ALARM_PROCESS_STATUS_ENUM } from '/@/constants/business/alarm-const';

const currentView = ref('list');
const tableData = ref([]);
const tableLoading = ref(false);
const selectedRowKeys = ref([]);

const columns = [
  {
    title: '告警时间',
    dataIndex: 'alarmTime',
    key: 'alarmTime',
    width: 180,
    fixed: 'left',
  },
  {
    title: '告警级别',
    dataIndex: 'alarmLevel',
    key: 'alarmLevel',
    width: 120,
  },
  {
    title: '告警类型',
    dataIndex: 'alarmType',
    key: 'alarmType',
    width: 120,
  },
  {
    title: '设备/通道',
    dataIndex: 'device',
    key: 'device',
    width: 200,
  },
  {
    title: '告警内容',
    dataIndex: 'content',
    key: 'content',
    width: 250,
    ellipsis: true,
  },
  {
    title: '处理状态',
    dataIndex: 'status',
    key: 'status',
    width: 120,
  },
  {
    title: '文件',
    dataIndex: 'media',
    key: 'media',
    width: 100,
  },
  {
    title: '操作',
    dataIndex: 'action',
    key: 'action',
    width: 180,
    fixed: 'right',
  },
];

const pagination = reactive({
  current: 1,
  pageSize: 25,
  total: 0,
  showSizeChanger: true,
  showQuickJumper: true,
  pageSizeOptions: ['25', '50', '100', '200'],
  showTotal: (total) => `共 ${total} 条`,
});

const rowSelection = computed(() => ({
  selectedRowKeys: selectedRowKeys.value,
  onChange: (keys) => {
    selectedRowKeys.value = keys;
  },
}));

const getAlarmLevelConfig = (level) => {
  const config = ALARM_LEVEL_ENUM[level.toUpperCase()];
  return {
    ...config,
    icon: getIconComponent(config.icon),
  };
};

const getIconComponent = (iconName) => {
  const iconMap = {
    ExclamationCircleOutlined,
    WarningOutlined,
    InfoCircleOutlined,
    BellOutlined,
  };
  return iconMap[iconName] || InfoCircleOutlined;
};

const getAlarmTypeLabel = (type) => {
  const typeConfig = ALARM_TYPE_ENUM[type.toUpperCase()];
  return typeConfig?.label || type;
};

const getProcessStatusConfig = (status) => {
  return ALARM_PROCESS_STATUS_ENUM[status.toUpperCase()] || {};
};

const handleTableChange = (pag, filters, sorter) => {
  pagination.current = pag.current;
  pagination.pageSize = pag.pageSize;
  // 重新加载数据
};

const viewDetail = (record) => {
  console.log('查看详情', record);
  // 打开详情弹窗
};

const processAlarm = (record) => {
  console.log('处理告警', record);
  // 打开处理弹窗
};

const ignoreAlarm = async (record) => {
  try {
    // await alarmApi.ignoreAlarm(record.id, '用户手动忽略');
    message.success('已忽略告警');
    // 重新加载数据
  } catch (error) {
    message.error('操作失败');
  }
};

const playVideo = (record) => {
  console.log('播放录像', record);
  // 打开视频播放器
};

const viewCapture = (record) => {
  console.log('查看抓拍', record);
  // 打开图片查看器
};
</script>

<style lang="less" scoped>
.alarm-table-card {
  margin-bottom: 16px;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);

  .device-info {
    .device-name {
      font-weight: 500;
      color: #333;
    }

    .channel-name {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }
  }

  .alarm-content {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .no-media {
    color: #d9d9d9;
  }
}
</style>
```

### 4. 告警统计图表（图表视图）
**位置**: 操作区域下方（当视图切换到图表时显示）

**技术实现**:
```vue
<template>
  <div v-show="currentView === 'chart'" class="alarm-statistics-view">
    <!-- 统计卡片 -->
    <a-row :gutter="16" class="statistics-cards">
      <a-col :span="6">
        <a-card class="stat-card critical-card">
          <a-statistic
            title="紧急告警"
            :value="statistics.criticalCount"
            :value-style="{ color: '#ef4444' }"
          >
            <template #prefix>
              <ExclamationCircleOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>

      <a-col :span="6">
        <a-card class="stat-card major-card">
          <a-statistic
            title="重要告警"
            :value="statistics.majorCount"
            :value-style="{ color: '#f97316' }"
          >
            <template #prefix>
              <WarningOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>

      <a-col :span="6">
        <a-card class="stat-card minor-card">
          <a-statistic
            title="一般告警"
            :value="statistics.minorCount"
            :value-style="{ color: '#eab308' }"
          >
            <template #prefix>
              <InfoCircleOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>

      <a-col :span="6">
        <a-card class="stat-card info-card">
          <a-statistic
            title="提示信息"
            :value="statistics.infoCount"
            :value-style="{ color: '#3b82f6' }"
          >
            <template #prefix>
              <BellOutlined />
            </template>
          </a-statistic>
        </a-card>
      </a-col>
    </a-row>

    <!-- 图表区域 -->
    <a-row :gutter="16" class="charts-row">
      <a-col :span="12">
        <a-card title="告警级别分布" class="chart-card">
          <div ref="levelChartRef" class="chart-container"></div>
        </a-card>
      </a-col>

      <a-col :span="12">
        <a-card title="告警类型统计" class="chart-card">
          <div ref="typeChartRef" class="chart-container"></div>
        </a-card>
      </a-col>
    </a-row>

    <a-row :gutter="16" class="charts-row">
      <a-col :span="12">
        <a-card title="每日告警趋势（近7天）" class="chart-card">
          <div ref="trendChartRef" class="chart-container"></div>
        </a-card>
      </a-col>

      <a-col :span="12">
        <a-card title="设备告警TOP5" class="chart-card">
          <div ref="deviceChartRef" class="chart-container"></div>
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted, watch } from 'vue';
import * as echarts from 'echarts';
import {
  ExclamationCircleOutlined,
  WarningOutlined,
  InfoCircleOutlined,
  BellOutlined,
} from '@ant-design/icons-vue';

const currentView = ref('chart');
const levelChartRef = ref();
const typeChartRef = ref();
const trendChartRef = ref();
const deviceChartRef = ref();

let levelChart = null;
let typeChart = null;
let trendChart = null;
let deviceChart = null;

const statistics = reactive({
  criticalCount: 128,
  majorCount: 356,
  minorCount: 672,
  infoCount: 300,
});

const initCharts = () => {
  // 告警级别分布饼图
  levelChart = echarts.init(levelChartRef.value);
  levelChart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} ({d}%)',
    },
    legend: {
      orient: 'vertical',
      right: 10,
      top: 'center',
    },
    series: [
      {
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2,
        },
        label: {
          show: false,
          position: 'center',
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 20,
            fontWeight: 'bold',
          },
        },
        labelLine: {
          show: false,
        },
        data: [
          { value: 128, name: '紧急', itemStyle: { color: '#ef4444' } },
          { value: 356, name: '重要', itemStyle: { color: '#f97316' } },
          { value: 672, name: '一般', itemStyle: { color: '#eab308' } },
          { value: 300, name: '提示', itemStyle: { color: '#3b82f6' } },
        ],
      },
    ],
  });

  // 告警类型统计柱状图
  typeChart = echarts.init(typeChartRef.value);
  typeChart.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow',
      },
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true,
    },
    xAxis: {
      type: 'category',
      data: ['移动侦测', '入侵检测', '人脸识别', '车牌识别', '越线检测', '人群聚集'],
      axisLabel: {
        rotate: 45,
      },
    },
    yAxis: {
      type: 'value',
    },
    series: [
      {
        name: '告警数量',
        type: 'bar',
        data: [245, 189, 156, 142, 128, 95],
        itemStyle: {
          color: '#3b82f6',
          borderRadius: [5, 5, 0, 0],
        },
      },
    ],
  });

  // 每日告警趋势折线图
  trendChart = echarts.init(trendChartRef.value);
  trendChart.setOption({
    tooltip: {
      trigger: 'axis',
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true,
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: ['12-25', '12-26', '12-27', '12-28', '12-29', '12-30', '12-31'],
    },
    yAxis: {
      type: 'value',
    },
    series: [
      {
        name: '告警数量',
        type: 'line',
        smooth: true,
        data: [185, 212, 198, 234, 256, 289, 245],
        itemStyle: {
          color: '#3b82f6',
        },
        areaStyle: {
          color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
            { offset: 0, color: 'rgba(59, 130, 246, 0.3)' },
            { offset: 1, color: 'rgba(59, 130, 246, 0.05)' },
          ]),
        },
      },
    ],
  });

  // 设备告警排名横向柱状图
  deviceChart = echarts.init(deviceChartRef.value);
  deviceChart.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow',
      },
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true,
    },
    xAxis: {
      type: 'value',
    },
    yAxis: {
      type: 'category',
      data: ['摄像头001-主入口', '摄像头008-停车场', '摄像头015-大厅', '摄像头023-走廊', '摄像头031-后门'],
    },
    series: [
      {
        name: '告警次数',
        type: 'bar',
        data: [
          { value: 89, itemStyle: { color: '#ef4444' } },
          { value: 76, itemStyle: { color: '#f97316' } },
          { value: 68, itemStyle: { color: '#eab308' } },
          { value: 54, itemStyle: { color: '#3b82f6' } },
          { value: 47, itemStyle: { color: '#8b5cf6' } },
        ],
        itemStyle: {
          borderRadius: [0, 5, 5, 0],
        },
      },
    ],
  });

  // 监听窗口大小变化
  window.addEventListener('resize', handleResize);
};

const handleResize = () => {
  levelChart?.resize();
  typeChart?.resize();
  trendChart?.resize();
  deviceChart?.resize();
};

const destroyCharts = () => {
  levelChart?.dispose();
  typeChart?.dispose();
  trendChart?.dispose();
  deviceChart?.dispose();
  window.removeEventListener('resize', handleResize);
};

watch(() => currentView.value, (newView) => {
  if (newView === 'chart') {
    // 延迟初始化图表，确保DOM已渲染
    setTimeout(() => {
      initCharts();
    }, 100);
  } else {
    destroyCharts();
  }
});

onMounted(() => {
  if (currentView.value === 'chart') {
    initCharts();
  }
});

onUnmounted(() => {
  destroyCharts();
});
</script>

<style lang="less" scoped>
.alarm-statistics-view {
  .statistics-cards {
    margin-bottom: 16px;

    .stat-card {
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      border-radius: 8px;

      &.critical-card {
        border-left: 4px solid #ef4444;
      }

      &.major-card {
        border-left: 4px solid #f97316;
      }

      &.minor-card {
        border-left: 4px solid #eab308;
      }

      &.info-card {
        border-left: 4px solid #3b82f6;
      }
    }
  }

  .charts-row {
    margin-bottom: 16px;

    .chart-card {
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      border-radius: 8px;

      .chart-container {
        height: 300px;
        width: 100%;
      }
    }
  }
}
</style>
```

### 5. 告警详情弹窗组件
**组件路径**: `src/views/business/smart-video/components/AlarmDetailModal.vue`

**技术实现**:
```vue
<template>
  <a-modal
    :open="visible"
    title="告警详情"
    width="1000px"
    :footer="null"
    @cancel="handleClose"
  >
    <a-spin :spinning="loading">
      <a-descriptions :column="2" bordered>
        <a-descriptions-item label="告警时间">
          {{ alarmData.alarmTime }}
        </a-descriptions-item>

        <a-descriptions-item label="告警级别">
          <a-tag :color="getAlarmLevelConfig(alarmData.alarmLevel).color">
            {{ getAlarmLevelConfig(alarmData.alarmLevel).label }}
          </a-tag>
        </a-descriptions-item>

        <a-descriptions-item label="告警类型">
          {{ getAlarmTypeLabel(alarmData.alarmType) }}
        </a-descriptions-item>

        <a-descriptions-item label="处理状态">
          <a-tag :color="getProcessStatusConfig(alarmData.status).color">
            {{ getProcessStatusConfig(alarmData.status).label }}
          </a-tag>
        </a-descriptions-item>

        <a-descriptions-item label="设备名称" :span="2">
          {{ alarmData.deviceName }}
        </a-descriptions-item>

        <a-descriptions-item label="通道名称" :span="2">
          {{ alarmData.channelName }}
        </a-descriptions-item>

        <a-descriptions-item label="安装位置" :span="2">
          {{ alarmData.location }}
        </a-descriptions-item>

        <a-descriptions-item label="告警内容" :span="2">
          {{ alarmData.content }}
        </a-descriptions-item>

        <a-descriptions-item label="置信度">
          <a-progress
            :percent="alarmData.confidence"
            :stroke-color="{
              '0%': '#108ee9',
              '100%': '#87d068',
            }"
          />
        </a-descriptions-item>

        <a-descriptions-item label="处理人">
          {{ alarmData.operator || '-' }}
        </a-descriptions-item>

        <a-descriptions-item label="处理时间" :span="2">
          {{ alarmData.processTime || '-' }}
        </a-descriptions-item>

        <a-descriptions-item label="处理备注" :span="2">
          {{ alarmData.processRemark || '-' }}
        </a-descriptions-item>
      </a-descriptions>

      <!-- 告警抓拍图片 -->
      <div v-if="alarmData.hasCapture" class="alarm-media-section">
        <h4>告警抓拍</h4>
        <div class="capture-images">
          <a-image
            v-for="(img, index) in alarmData.captureImages"
            :key="index"
            :width="200"
            :src="img"
            :preview="{
              visible: previewVisible,
              onVisibleChange: (vis) => (previewVisible = vis),
            }"
          />
        </div>
      </div>

      <!-- 告警录像 -->
      <div v-if="alarmData.hasVideo" class="alarm-media-section">
        <h4>告警录像</h4>
        <div class="video-player">
          <video
            ref="videoPlayerRef"
            controls
            width="100%"
            height="400"
            :src="alarmData.videoUrl"
          >
            您的浏览器不支持视频播放
          </video>
        </div>
      </div>

      <!-- 处理记录 -->
      <div v-if="alarmData.processHistory?.length" class="alarm-media-section">
        <h4>处理记录</h4>
        <a-timeline>
          <a-timeline-item
            v-for="(record, index) in alarmData.processHistory"
            :key="index"
            :color="record.type === 'process' ? 'green' : 'blue'"
          >
            <template #dot>
              <CheckCircleOutlined v-if="record.type === 'process'" />
              <ClockCircleOutlined v-else />
            </template>
            <p class="timeline-time">{{ record.time }}</p>
            <p class="timeline-operator">操作人: {{ record.operator }}</p>
            <p class="timeline-action">{{ record.action }}</p>
            <p v-if="record.remark" class="timeline-remark">备注: {{ record.remark }}</p>
          </a-timeline-item>
        </a-timeline>
      </div>
    </a-spin>
  </a-modal>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';
import {
  CheckCircleOutlined,
  ClockCircleOutlined,
} from '@ant-design/icons-vue';
import { alarmApi } from '/@/api/business/smart-video/alarm-api';
import { ALARM_LEVEL_ENUM, ALARM_TYPE_ENUM, ALARM_PROCESS_STATUS_ENUM } from '/@/constants/business/alarm-const';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  alarmId: {
    type: String,
    default: '',
  },
});

const emit = defineEmits(['update:visible', 'close']);

const loading = ref(false);
const previewVisible = ref(false);
const videoPlayerRef = ref();

const alarmData = reactive({
  alarmTime: '',
  alarmLevel: '',
  alarmType: '',
  status: '',
  deviceName: '',
  channelName: '',
  location: '',
  content: '',
  confidence: 0,
  operator: '',
  processTime: '',
  processRemark: '',
  hasCapture: false,
  hasVideo: false,
  captureImages: [],
  videoUrl: '',
  processHistory: [],
});

const getAlarmLevelConfig = (level) => {
  return ALARM_LEVEL_ENUM[level?.toUpperCase()] || {};
};

const getAlarmTypeLabel = (type) => {
  const typeConfig = ALARM_TYPE_ENUM[type?.toUpperCase()];
  return typeConfig?.label || type;
};

const getProcessStatusConfig = (status) => {
  return ALARM_PROCESS_STATUS_ENUM[status?.toUpperCase()] || {};
};

const loadAlarmDetail = async () => {
  if (!props.alarmId) return;

  loading.value = true;
  try {
    const response = await alarmApi.getAlarmDetail(props.alarmId);
    if (response.code === 1) {
      Object.assign(alarmData, response.data);
    } else {
      message.error(response.msg || '获取告警详情失败');
    }
  } catch (error) {
    console.error('获取告警详情失败:', error);
    message.error('获取告警详情失败');
  } finally {
    loading.value = false;
  }
};

const handleClose = () => {
  emit('update:visible', false);
  emit('close');

  // 停止视频播放
  if (videoPlayerRef.value) {
    videoPlayerRef.value.pause();
  }
};

watch(
  () => props.visible,
  (newVal) => {
    if (newVal && props.alarmId) {
      loadAlarmDetail();
    }
  }
);
</script>

<style lang="less" scoped>
.alarm-media-section {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid #f0f0f0;

  h4 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #333;
  }

  .capture-images {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .video-player {
    width: 100%;
  }

  .timeline-time {
    font-size: 14px;
    color: #999;
    margin-bottom: 4px;
  }

  .timeline-operator {
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
  }

  .timeline-action {
    color: #666;
    margin-bottom: 4px;
  }

  .timeline-remark {
    color: #999;
    font-size: 12px;
  }
}
</style>
```

### 6. 告警处理弹窗组件
**组件路径**: `src/views/business/smart-video/components/AlarmProcessModal.vue`

**技术实现**:
```vue
<template>
  <a-modal
    :open="visible"
    title="处理告警"
    width="600px"
    @ok="handleSubmit"
    @cancel="handleCancel"
    :confirmLoading="loading"
  >
    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      :label-col="{ span: 6 }"
      :wrapper-col="{ span: 18 }"
    >
      <a-form-item label="告警信息">
        <div class="alarm-info">
          <p><strong>告警时间:</strong> {{ alarmInfo.alarmTime }}</p>
          <p><strong>设备名称:</strong> {{ alarmInfo.deviceName }}</p>
          <p><strong>告警内容:</strong> {{ alarmInfo.content }}</p>
        </div>
      </a-form-item>

      <a-form-item label="处理方式" name="processType">
        <a-radio-group v-model:value="formData.processType">
          <a-radio value="resolved">已处理</a-radio>
          <a-radio value="ignored">忽略</a-radio>
        </a-radio-group>
      </a-form-item>

      <a-form-item label="处理结果" name="processResult">
        <a-select
          v-model:value="formData.processResult"
          placeholder="请选择处理结果"
        >
          <a-select-option value="normal">正常处理</a-select-option>
          <a-select-option value="false_alarm">误报</a-select-option>
          <a-select-option value="confirmed">确认异常</a-select-option>
          <a-select-option value="escalated">已上报</a-select-option>
        </a-select>
      </a-form-item>

      <a-form-item label="处理备注" name="remark">
        <a-textarea
          v-model:value="formData.remark"
          placeholder="请输入处理备注"
          :rows="4"
        />
      </a-form-item>

      <a-form-item label="上传附件">
        <a-upload
          v-model:file-list="fileList"
          list-type="picture"
          :before-upload="() => false"
        >
          <a-button>
            <template #icon><UploadOutlined /></template>
            上传文件
          </a-button>
        </a-upload>
      </a-form-item>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, watch } from 'vue';
import { message } from 'ant-design-vue';
import { UploadOutlined } from '@ant-design/icons-vue';
import { alarmApi } from '/@/api/business/smart-video/alarm-api';

const props = defineProps({
  visible: {
    type: Boolean,
    default: false,
  },
  alarmInfo: {
    type: Object,
    default: () => ({}),
  },
});

const emit = defineEmits(['update:visible', 'success', 'cancel']);

const formRef = ref();
const loading = ref(false);
const fileList = ref([]);

const formData = reactive({
  processType: 'resolved',
  processResult: '',
  remark: '',
});

const formRules = {
  processType: [
    { required: true, message: '请选择处理方式', trigger: 'change' },
  ],
  processResult: [
    { required: true, message: '请选择处理结果', trigger: 'change' },
  ],
  remark: [
    { required: true, message: '请输入处理备注', trigger: 'blur' },
    { min: 5, message: '处理备注至少5个字符', trigger: 'blur' },
  ],
};

const handleSubmit = async () => {
  try {
    await formRef.value.validate();

    loading.value = true;

    const params = {
      alarmId: props.alarmInfo.id,
      processType: formData.processType,
      processResult: formData.processResult,
      remark: formData.remark,
      attachments: fileList.value.map(f => f.originFileObj),
    };

    const response = await alarmApi.processAlarm(params);

    if (response.code === 1) {
      message.success('处理成功');
      emit('success');
      handleCancel();
    } else {
      message.error(response.msg || '处理失败');
    }
  } catch (error) {
    console.error('处理告警失败:', error);
  } finally {
    loading.value = false;
  }
};

const handleCancel = () => {
  formRef.value?.resetFields();
  fileList.value = [];
  emit('update:visible', false);
  emit('cancel');
};

watch(
  () => props.visible,
  (newVal) => {
    if (!newVal) {
      formRef.value?.resetFields();
      fileList.value = [];
    }
  }
);
</script>

<style lang="less" scoped>
.alarm-info {
  padding: 12px;
  background: #f5f5f5;
  border-radius: 4px;

  p {
    margin-bottom: 8px;
    color: #666;

    &:last-child {
      margin-bottom: 0;
    }

    strong {
      color: #333;
    }
  }
}
</style>
```

## Mock数据示例

```javascript
// src/views/business/smart-video/mock/alarm-mock-data.js

// 告警级别
const ALARM_LEVELS = ['critical', 'major', 'minor', 'info'];

// 告警类型
const ALARM_TYPES = ['motion', 'intrusion', 'face', 'license', 'line', 'crowd', 'device'];

// 处理状态
const PROCESS_STATUSES = ['pending', 'processing', 'resolved', 'ignored'];

// 告警内容模板
const ALARM_CONTENTS = {
  motion: '检测到移动物体',
  intrusion: '检测到入侵行为',
  face: '识别到陌生人员',
  license: '识别到可疑车辆',
  line: '检测到越线行为',
  crowd: '检测到人群聚集',
  device: '设备运行异常',
};

// 生成模拟告警数据
export const generateMockAlarmList = (count = 100) => {
  const alarms = [];
  const now = new Date();

  for (let i = 0; i < count; i++) {
    const level = ALARM_LEVELS[Math.floor(Math.random() * ALARM_LEVELS.length)];
    const type = ALARM_TYPES[Math.floor(Math.random() * ALARM_TYPES.length)];
    const status = PROCESS_STATUSES[Math.floor(Math.random() * PROCESS_STATUSES.length)];

    // 随机生成时间（最近7天内）
    const randomDays = Math.floor(Math.random() * 7);
    const alarmTime = new Date(now.getTime() - randomDays * 24 * 60 * 60 * 1000);
    const timeStr = alarmTime.toISOString().replace('T', ' ').substring(0, 19);

    alarms.push({
      id: `alarm_${String(i + 1).padStart(6, '0')}`,
      alarmTime: timeStr,
      alarmLevel: level,
      alarmType: type,
      deviceName: `摄像头-${String(Math.floor(Math.random() * 50) + 1).padStart(3, '0')}`,
      deviceCode: `CAM-${String(Math.floor(Math.random() * 50) + 1).padStart(3, '0')}`,
      channelName: `通道-${Math.floor(Math.random() * 20) + 1}`,
      channelCode: `CH-${Math.floor(Math.random() * 20) + 1}`,
      location: ['前门入口', '大厅中央', '停车场', '走廊', '办公区', '会议室'][Math.floor(Math.random() * 6)],
      content: ALARM_CONTENTS[type] + ` #${i + 1}`,
      confidence: Math.floor(Math.random() * 30) + 70, // 70-100
      status: status,
      hasVideo: Math.random() > 0.5,
      hasCapture: Math.random() > 0.3,
      operator: status === 'resolved' ? ['张三', '李四', '王五'][Math.floor(Math.random() * 3)] : '',
      processTime: status === 'resolved' ? timeStr : '',
      processRemark: status === 'resolved' ? '已确认处理，情况正常' : '',
    });
  }

  // 按时间降序排序
  return alarms.sort((a, b) => new Date(b.alarmTime) - new Date(a.alarmTime));
};

// 模拟告警详情数据
export const mockAlarmDetail = {
  id: 'alarm_000001',
  alarmTime: '2024-01-30 14:35:12',
  alarmLevel: 'critical',
  alarmType: 'intrusion',
  status: 'resolved',
  deviceName: '摄像头-001',
  deviceCode: 'CAM-001',
  channelName: '通道-1',
  channelCode: 'CH-1',
  location: '前门入口',
  content: '检测到入侵行为',
  confidence: 95,
  operator: '张三',
  processTime: '2024-01-30 14:40:25',
  processRemark: '已确认处理，为外来访客，已登记',
  hasVideo: true,
  hasCapture: true,
  captureImages: [
    'https://via.placeholder.com/400x300/FF6B6B/FFFFFF?text=Capture+1',
    'https://via.placeholder.com/400x300/4ECDC4/FFFFFF?text=Capture+2',
    'https://via.placeholder.com/400x300/45B7D1/FFFFFF?text=Capture+3',
  ],
  videoUrl: 'https://www.w3schools.com/html/mov_bbb.mp4',
  processHistory: [
    {
      time: '2024-01-30 14:40:25',
      operator: '张三',
      type: 'process',
      action: '处理告警',
      remark: '已确认处理，为外来访客，已登记',
    },
    {
      time: '2024-01-30 14:36:10',
      operator: '系统',
      type: 'update',
      action: '告警状态变更为：处理中',
      remark: '',
    },
    {
      time: '2024-01-30 14:35:12',
      operator: '系统',
      type: 'create',
      action: '告警产生',
      remark: '检测到入侵行为',
    },
  ],
};

// 模拟统计数据
export const mockAlarmStatistics = {
  criticalCount: 128,
  majorCount: 356,
  minorCount: 672,
  infoCount: 300,
  totalCount: 1456,
  pendingCount: 85,
  processingCount: 23,
  resolvedCount: 1298,
  ignoredCount: 50,
};

// 模拟告警级别分布
export const mockLevelDistribution = [
  { level: 'critical', label: '紧急', count: 128, percentage: 8.8 },
  { level: 'major', label: '重要', count: 356, percentage: 24.5 },
  { level: 'minor', label: '一般', count: 672, percentage: 46.2 },
  { level: 'info', label: '提示', count: 300, percentage: 20.6 },
];

// 模拟告警类型分布
export const mockTypeDistribution = [
  { type: 'motion', label: '移动侦测', count: 245 },
  { type: 'intrusion', label: '入侵检测', count: 189 },
  { type: 'face', label: '人脸识别', count: 156 },
  { type: 'license', label: '车牌识别', count: 142 },
  { type: 'line', label: '越线检测', count: 128 },
  { type: 'crowd', label: '人群聚集', count: 95 },
  { type: 'device', label: '设备异常', count: 68 },
];

// 模拟告警趋势（近7天）
export const mockAlarmTrend = [
  { date: '12-25', count: 185 },
  { date: '12-26', count: 212 },
  { date: '12-27', count: 198 },
  { date: '12-28', count: 234 },
  { date: '12-29', count: 256 },
  { date: '12-30', count: 289 },
  { date: '12-31', count: 245 },
];

// 模拟设备告警排名TOP5
export const mockDeviceAlarmRanking = [
  { deviceName: '摄像头001-主入口', count: 89 },
  { deviceName: '摄像头008-停车场', count: 76 },
  { deviceName: '摄像头015-大厅', count: 68 },
  { deviceName: '摄像头023-走廊', count: 54 },
  { deviceName: '摄像头031-后门', count: 47 },
];

// Mock API实现
export default {
  // 查询告警列表
  mockQueryAlarmList: (params) => {
    let list = generateMockAlarmList(100);

    // 筛选条件
    if (params.startTime && params.endTime) {
      list = list.filter(item => {
        const alarmTime = new Date(item.alarmTime);
        return alarmTime >= new Date(params.startTime) && alarmTime <= new Date(params.endTime);
      });
    }

    if (params.alarmLevel) {
      list = list.filter(item => item.alarmLevel === params.alarmLevel);
    }

    if (params.alarmType) {
      list = list.filter(item => item.alarmType === params.alarmType);
    }

    if (params.processStatus) {
      list = list.filter(item => item.status === params.processStatus);
    }

    if (params.deviceName) {
      list = list.filter(item =>
        item.deviceName.includes(params.deviceName) ||
        item.deviceCode.includes(params.deviceName)
      );
    }

    if (params.channelName) {
      list = list.filter(item =>
        item.channelName.includes(params.channelName) ||
        item.channelCode.includes(params.channelName)
      );
    }

    // 分页
    const pageNum = params.pageNum || 1;
    const pageSize = params.pageSize || 25;
    const total = list.length;
    const start = (pageNum - 1) * pageSize;
    const end = start + pageSize;

    return {
      code: 1,
      msg: '查询成功',
      data: {
        list: list.slice(start, end),
        total,
        pageNum,
        pageSize,
      },
    };
  },

  // 获取告警详情
  mockGetAlarmDetail: (alarmId) => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockAlarmDetail,
    };
  },

  // 获取统计数据
  mockGetStatistics: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockAlarmStatistics,
    };
  },

  // 获取级别分布
  mockGetLevelDistribution: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockLevelDistribution,
    };
  },

  // 获取类型分布
  mockGetTypeDistribution: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockTypeDistribution,
    };
  },

  // 获取告警趋势
  mockGetAlarmTrend: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockAlarmTrend,
    };
  },

  // 获取设备排名
  mockGetDeviceRanking: () => {
    return {
      code: 1,
      msg: '查询成功',
      data: mockDeviceAlarmRanking,
    };
  },
};
```

## 路由配置

### ✅ 正确的路由配置
```javascript
// src/router/business/smart-video-alarm.js
import SmartLayout from '/@/layout/index.vue';
import { MENU_TYPE_ENUM } from '/@/constants/system/menu-const';

export const smartVideoAlarmRouters = [
  {
    path: '/',
    component: SmartLayout,
    children: [
      {
        path: '/business/smart-video/history-alarm',
        name: 'SmartVideoHistoryAlarm',
        component: () => import('/@/views/business/smart-video/history-alarm.vue'),
        meta: {
          title: '智能视频 - 历史告警',
          menuType: MENU_TYPE_ENUM.MENU.value,
          icon: 'BellOutlined',
          hideInMenu: false,
          keepAlive: true,
        },
      },
    ],
  },
];
```

### ✅ 主路由文件集成
```javascript
// src/router/routers.js
import { smartVideoAlarmRouters } from './business/smart-video-alarm';

export const routerArray = [
  // ...其他路由
  ...smartVideoAlarmRouters,
  // ...更多路由
];
```

## 菜单配置

### ✅ 动态菜单注入
```javascript
// src/store/modules/system/user.js
function addSmartVideoMenu(menuList) {
  const maxMenuId = Math.max(...menuList.map(item => item.menuId || 0));

  // 智能视频父菜单
  const smartVideoMenu = {
    menuId: maxMenuId + 1000,
    menuName: '智能视频',
    menuTitle: '智能视频',
    menuType: MENU_TYPE_ENUM.CATALOG.value,
    parentId: 0,
    path: '/business/smart-video',
    icon: 'VideoCameraOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: false,
    frameFlag: false,
    frameUrl: '',
    sort: 10,
    updateTime: new Date().toISOString(),
  };

  // 历史告警子菜单
  const historyAlarmMenu = {
    menuId: maxMenuId + 1004,
    menuName: '历史告警',
    menuTitle: '历史告警',
    menuType: MENU_TYPE_ENUM.MENU.value,
    parentId: smartVideoMenu.menuId,
    path: '/business/smart-video/history-alarm',
    component: '/business/smart-video/history-alarm.vue',
    icon: 'BellOutlined',
    visibleFlag: true,
    disabledFlag: false,
    cacheFlag: true,
    frameFlag: false,
    frameUrl: '',
    sort: 4,
    updateTime: new Date().toISOString(),
  };

  menuList.push(smartVideoMenu, historyAlarmMenu);
  return smartVideoMenu.menuId;
}
```

## Pinia Store状态管理

```javascript
// src/store/modules/business/alarm.js
import { defineStore } from 'pinia';
import { message } from 'ant-design-vue';
import { alarmApi } from '/@/api/business/smart-video/alarm-api';

export const useAlarmStore = defineStore('alarm', {
  state: () => ({
    alarmList: [],
    statistics: {
      criticalCount: 0,
      majorCount: 0,
      minorCount: 0,
      infoCount: 0,
      totalCount: 0,
      pendingCount: 0,
      processingCount: 0,
      resolvedCount: 0,
      ignoredCount: 0,
    },
    loading: false,
    currentAlarm: null,
  }),

  getters: {
    // 未处理告警数量
    pendingAlarmCount(state) {
      return state.alarmList.filter(a => a.status === 'pending').length;
    },

    // 紧急告警数量
    criticalAlarmCount(state) {
      return state.alarmList.filter(a => a.alarmLevel === 'critical').length;
    },

    // 告警级别分布
    levelDistribution(state) {
      const distribution = {
        critical: 0,
        major: 0,
        minor: 0,
        info: 0,
      };

      state.alarmList.forEach(alarm => {
        if (distribution.hasOwnProperty(alarm.alarmLevel)) {
          distribution[alarm.alarmLevel]++;
        }
      });

      return distribution;
    },

    // 告警类型分布
    typeDistribution(state) {
      const distribution = {};

      state.alarmList.forEach(alarm => {
        if (!distribution[alarm.alarmType]) {
          distribution[alarm.alarmType] = 0;
        }
        distribution[alarm.alarmType]++;
      });

      return distribution;
    },
  },

  actions: {
    // 获取告警列表
    async fetchAlarmList(params = {}, useMock = true) {
      this.loading = true;
      try {
        let response;
        if (useMock) {
          const alarmMockData = await import('/@/views/business/smart-video/mock/alarm-mock-data');
          response = alarmMockData.default.mockQueryAlarmList(params);
        } else {
          response = await alarmApi.queryAlarmList(params);
        }

        if (response.code === 1) {
          this.alarmList = response.data.list;
          return response.data;
        } else {
          message.error(response.msg || '获取数据失败');
          return null;
        }
      } catch (error) {
        console.error('获取告警列表失败:', error);
        message.error('获取数据失败');
        return null;
      } finally {
        this.loading = false;
      }
    },

    // 获取统计数据
    async fetchStatistics(useMock = true) {
      try {
        let response;
        if (useMock) {
          const alarmMockData = await import('/@/views/business/smart-video/mock/alarm-mock-data');
          response = alarmMockData.default.mockGetStatistics();
        } else {
          response = await alarmApi.getAlarmStatistics();
        }

        if (response.code === 1) {
          this.statistics = response.data;
          return response.data;
        }
      } catch (error) {
        console.error('获取统计数据失败:', error);
        return null;
      }
    },

    // 处理告警
    async processAlarm(params) {
      try {
        const response = await alarmApi.processAlarm(params);
        if (response.code === 1) {
          message.success('处理成功');
          return true;
        } else {
          message.error(response.msg || '处理失败');
          return false;
        }
      } catch (error) {
        console.error('处理告警失败:', error);
        message.error('处理失败');
        return false;
      }
    },

    // 批量处理告警
    async batchProcessAlarms(params) {
      try {
        const response = await alarmApi.batchProcessAlarm(params);
        if (response.code === 1) {
          message.success(`成功处理 ${params.alarmIds.length} 条告警`);
          return true;
        } else {
          message.error(response.msg || '批量处理失败');
          return false;
        }
      } catch (error) {
        console.error('批量处理失败:', error);
        message.error('批量处理失败');
        return false;
      }
    },

    // 忽略告警
    async ignoreAlarm(alarmId, reason) {
      try {
        const response = await alarmApi.ignoreAlarm(alarmId, reason);
        if (response.code === 1) {
          message.success('已忽略告警');
          return true;
        } else {
          message.error(response.msg || '操作失败');
          return false;
        }
      } catch (error) {
        console.error('忽略告警失败:', error);
        message.error('操作失败');
        return false;
      }
    },

    // 设置当前告警
    setCurrentAlarm(alarm) {
      this.currentAlarm = alarm;
    },
  },
});
```

## 常见错误排查清单

### 1. 控制台报错排查
- [ ] 图标导入错误：检查 `@ant-design/icons-vue` 中是否存在该图标
- [ ] API导入错误：确认导入路径是否为 `/@/lib/axios`
- [ ] v-model错误：检查是否在props上使用了v-model
- [ ] 日期时间选择器错误：确保使用dayjs处理日期
- [ ] ECharts错误：确保在DOM渲染完成后初始化图表

### 2. 页面无法访问排查
- [ ] 路由配置：检查路由是否正确添加到 `routerArray`
- [ ] 菜单配置：检查菜单是否正确注入到菜单列表
- [ ] 组件路径：确认组件路径是否正确
- [ ] 文件存在：确认所有引用的组件文件都存在

### 3. 功能异常排查
- [ ] Store状态：检查Pinia store是否正确定义和使用
- [ ] API调用：确认API接口路径和参数是否正确
- [ ] 数据格式：检查mock数据格式是否符合预期
- [ ] 事件绑定：确认事件监听器是否正确绑定
- [ ] 表单验证：确保表单规则配置正确

### 4. 告警相关特殊排查
- [ ] 时间范围查询：确保开始时间小于结束时间
- [ ] 媒体文件加载：检查图片/视频URL是否正确
- [ ] 图表显示异常：确保在视图切换时正确初始化/销毁图表
- [ ] 批量操作：确认已选中告警且操作权限正确
- [ ] 统计数据：确保统计API返回正确的数据格式

## 最佳实践总结

### ✅ 推荐的开发流程
1. **先创建基础组件** - 确保每个组件可以独立运行
2. **逐步集成功能** - 从简单到复杂，逐步添加功能
3. **Mock数据优先** - 先用mock数据开发，后期对接真实API
4. **及时测试验证** - 每添加一个功能就进行测试
5. **遵循项目规范** - 使用项目既定的命名和结构规范

### ✅ 代码质量保证
1. **使用TypeScript类型检查**（如果项目支持）
2. **遵循ESLint和Prettier规范**
3. **编写单元测试**（重要功能）
4. **添加适当的注释**，特别是复杂逻辑
5. **保持组件单一职责**，避免过度复杂

### ✅ 性能优化建议
1. **使用懒加载**：路由和组件按需加载
2. **合理使用computed和watch**
3. **避免不必要的重新渲染**
4. **使用虚拟滚动**处理大数据列表（告警数量超过1000时）
5. **添加防抖和节流**优化用户交互（如搜索输入）
6. **图表按需初始化**：只在显示时初始化，切换视图时及时销毁

### ✅ 安全性建议
1. **敏感数据脱敏**：告警详情中的敏感信息适当脱敏
2. **权限控制**：根据用户角色显示不同操作按钮
3. **操作确认**：删除、清空等危险操作需要二次确认
4. **防止XSS攻击**：告警内容显示时注意转义特殊字符
5. **媒体文件安全**：图片/视频URL使用签名或token验证

## 特殊功能实现说明

### 1. 快捷时间选择
```javascript
// 提供今天、昨天、近7天、近30天等快捷选项
const selectQuickTime = (type) => {
  const now = dayjs();
  switch (type) {
    case 'today':
      queryForm.startTime = now.startOf('day');
      queryForm.endTime = now.endOf('day');
      break;
    case 'yesterday':
      queryForm.startTime = now.subtract(1, 'day').startOf('day');
      queryForm.endTime = now.subtract(1, 'day').endOf('day');
      break;
    case 'week':
      queryForm.startTime = now.subtract(7, 'day').startOf('day');
      queryForm.endTime = now.endOf('day');
      break;
    case 'month':
      queryForm.startTime = now.subtract(30, 'day').startOf('day');
      queryForm.endTime = now.endOf('day');
      break;
  }
};
```

### 2. 告警媒体文件查看
```javascript
// 支持查看告警抓拍图片和播放告警录像
const viewCapture = async (record) => {
  try {
    const response = await alarmApi.getAlarmMedia(record.id, 'capture');
    if (response.code === 1) {
      // 使用Ant Design的Image预览组件
      Modal.info({
        title: '告警抓拍',
        width: 800,
        content: h('img', {
          src: response.data.imageUrl,
          style: { width: '100%' },
        }),
      });
    }
  } catch (error) {
    message.error('获取抓拍图片失败');
  }
};

const playVideo = async (record) => {
  try {
    const response = await alarmApi.playAlarmVideo(record.id);
    if (response.code === 1) {
      // 打开视频播放弹窗
      showVideoPlayerModal(response.data.videoUrl);
    }
  } catch (error) {
    message.error('播放录像失败');
  }
};
```

### 3. 告警实时更新（WebSocket）
```javascript
// 使用WebSocket实时接收新告警通知
let ws = null;

const initWebSocket = () => {
  ws = new WebSocket('ws://your-server/alarm/realtime');

  ws.onmessage = (event) => {
    const newAlarm = JSON.parse(event.data);

    // 在列表顶部插入新告警
    tableData.value.unshift(newAlarm);

    // 显示通知
    notification.warning({
      message: '新告警',
      description: `${newAlarm.deviceName}: ${newAlarm.content}`,
      duration: 5,
    });

    // 播放告警声音
    playAlarmSound();
  };

  ws.onerror = (error) => {
    console.error('WebSocket错误:', error);
  };

  ws.onclose = () => {
    console.log('WebSocket连接关闭');
    // 自动重连
    setTimeout(() => {
      initWebSocket();
    }, 5000);
  };
};

onMounted(() => {
  initWebSocket();
});

onUnmounted(() => {
  if (ws) {
    ws.close();
  }
});
```

### 4. 告警导出Excel
```javascript
// 支持导出筛选后的告警记录为Excel文件
const exportAlarms = async () => {
  try {
    message.loading('正在导出，请稍候...', 0);

    const response = await alarmApi.exportAlarms({
      ...queryForm,
      format: 'xlsx',
    });

    message.destroy();

    // 创建Blob对象并下载
    const blob = new Blob([response], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    });

    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `告警记录_${dayjs().format('YYYYMMDD_HHmmss')}.xlsx`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);

    message.success('导出成功');
  } catch (error) {
    message.destroy();
    console.error('导出失败:', error);
    message.error('导出失败');
  }
};
```

## 总结

通过遵循本文档的技术规范和注意事项，可以有效避免开发过程中的常见错误，确保历史告警管理页面能够顺利开发和部署。

关键要点：
- ✅ **避免在props上使用v-model**，改用属性绑定和事件监听
- ✅ **验证图标存在性**，使用实际存在于`@ant-design/icons-vue`中的图标
- ✅ **使用正确的API导入路径**：`/@/lib/axios`
- ✅ **标准化告警级别和类型**，使用枚举常量定义
- ✅ **完善的时间筛选功能**，支持快捷时间选择
- ✅ **支持列表和图表双视图**，提供多维度数据展示
- ✅ **实现告警处理流程**，包括详情查看、处理、忽略等
- ✅ **媒体文件查看**，支持查看告警抓拍图片和播放录像
- ✅ **实时告警推送**，使用WebSocket接收新告警通知
- ✅ **数据导出功能**，支持导出Excel格式告警记录

通过这些规范和最佳实践，可以确保开发过程顺利进行，减少调试时间，提高开发效率。
