<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒºåŸŸç®¡ç† - æ¶ˆè´¹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../js/menu.js" defer></script>
    <link rel="stylesheet" href="../css/main.css">

    <style>
        .regions-container {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .container-header {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
            flex-wrap: wrap;
            background: var(--gray-50);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .header-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--gray-900);
            white-space: nowrap;
        }

        .view-toggle {
            display: flex;
            gap: var(--space-xs);
            background: var(--gray-100);
            padding: var(--space-xs);
            border-radius: var(--radius-md);
        }

        .view-toggle-btn {
            padding: var(--space-xs) var(--space-md);
            border: none;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: var(--radius);
            transition: all var(--transition);
            font-size: var(--text-sm);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .view-toggle-btn.active {
            background: white;
            color: var(--primary-600);
            box-shadow: var(--shadow-sm);
        }

        /* åˆ—è¡¨æ¨¡å¼æ ·å¼ */
        .list-view {
            display: none;
        }

        .list-view.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: var(--space-lg) var(--space-2xl);
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: var(--text-sm);
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: var(--space-lg) var(--space-2xl);
            border-bottom: 1px solid var(--gray-100);
            font-size: var(--text-sm);
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        /* æ ‘å½¢æ¨¡å¼æ ·å¼ */
        .tree-view {
            display: none;
            padding: var(--space-xl);
        }

        .tree-view.active {
            display: block;
        }

        .tree-node {
            margin-left: var(--space-xl);
        }

        .tree-node:first-child {
            margin-left: 0;
        }

        .node-item {
            display: flex;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            transition: background var(--transition);
            margin-bottom: var(--space-xs);
        }

        .node-item:hover {
            background: var(--gray-50);
        }

        .node-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--gray-400);
            margin-right: var(--space-sm);
        }

        .node-toggle.empty {
            visibility: hidden;
        }

        .node-toggle i {
            transition: transform var(--transition);
            font-size: var(--text-xs);
        }

        .node-item.expanded .node-toggle i {
            transform: rotate(90deg);
        }

        .node-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            margin-right: var(--space-sm);
            font-size: var(--text-sm);
        }

        .node-icon.level-1 {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .node-icon.level-2 {
            background: var(--success-light);
            color: var(--success);
        }

        .node-icon.level-3 {
            background: var(--warning-light);
            color: var(--warning);
        }

        .node-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .node-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .node-code {
            font-size: var(--text-xs);
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 2px var(--space-xs);
            border-radius: var(--radius);
        }

        .node-info {
            display: flex;
            gap: var(--space-md);
            font-size: var(--text-xs);
            color: var(--gray-500);
        }

        .node-actions {
            display: flex;
            gap: var(--space-xs);
            opacity: 0;
            transition: opacity var(--transition);
        }

        .node-item:hover .node-actions {
            opacity: 1;
        }

        .node-children {
            display: none;
            margin-left: var(--space-2xl);
        }

        .node-item.expanded + .node-children {
            display: block;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius);
            font-size: var(--text-xs);
            font-weight: 500;
        }

        .status-badge.active {
            background: var(--success-light);
            color: var(--success);
        }

        .action-btn {
            padding: var(--space-xs) var(--space-sm);
            border: none;
            background: transparent;
            color: var(--gray-500);
            cursor: pointer;
            border-radius: var(--radius);
            transition: all var(--transition);
            font-size: var(--text-sm);
        }

        .action-btn:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .action-btn.delete:hover {
            background: var(--error-light);
            color: var(--error);
        }

        /* æŠ½å±‰æ ·å¼ */
        .drawer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drawer-overlay.show {
            display: block;
            opacity: 1;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            max-width: 90vw;
            height: 100vh;
            background: white;
            box-shadow: var(--shadow-xl);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .drawer.show {
            right: 0;
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xl);
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .drawer-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--gray-900);
        }

        .drawer-close {
            background: none;
            border: none;
            font-size: var(--text-xl);
            color: var(--gray-500);
            cursor: pointer;
            padding: var(--space-xs);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all var(--transition);
        }

        .drawer-close:hover {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-xl);
        }

        .drawer-footer {
            padding: var(--space-xl);
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }

        /* æœç´¢æ æ ·å¼ - æ•´åˆåˆ°headerä¸­ */
        .search-bar {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            flex-wrap: wrap;
            flex: 1;
        }

        .search-field {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .search-field label {
            font-size: var(--text-xs);
            color: var(--gray-600);
            font-weight: 500;
            white-space: nowrap;
        }

        .search-field input,
        .search-field select {
            padding: 5px 8px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            background: white;
            transition: border-color var(--transition);
            width: 110px;
        }

        .search-field input:focus,
        .search-field select:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        .search-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .search-actions .btn {
            padding: 5px 10px;
            font-size: var(--text-sm);
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            color: var(--gray-700);
            font-size: var(--text-sm);
        }

        .form-label .required {
            color: var(--error);
            margin-left: 2px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            transition: all var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }

        .form-hint {
            font-size: var(--text-xs);
            color: var(--gray-500);
            margin-top: var(--space-xs);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-utensils fa-lg"></i>
                <div>
                    <div class="sidebar-title">æ¶ˆè´¹ç®¡ç†ç³»ç»Ÿ</div>
                    <div class="sidebar-subtitle">Consumption Hub</div>
                </div>
            </div>
            <div class="sidebar-menu">
                <!-- èœå•å°†ç”± menu.js è‡ªåŠ¨ç”Ÿæˆ -->
            </div>
        </nav>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <header class="header">
                <h1>åŒºåŸŸç®¡ç†</h1>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-bell"></i>
                        é€šçŸ¥
                    </button>
                    <div class="user-info">
                        <div>
                            <div style="font-weight: 600;">ç³»ç»Ÿç®¡ç†å‘˜</div>
                            <div style="font-size: 12px; color: var(--gray-500);">åœ¨çº¿</div>
                        </div>
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ä¸»è¦å†…å®¹ -->
            <div class="content">
                <!-- åŒºåŸŸç®¡ç†å®¹å™¨ -->
                <section class="regions-container">
                    <div class="container-header">
                        <div class="header-left">
                            <h2 class="header-title">åŒºåŸŸç®¡ç†</h2>
                            <div class="view-toggle">
                                <button class="view-toggle-btn active" onclick="switchView('list')">
                                    <i class="fas fa-list"></i>
                                    åˆ—è¡¨æ¨¡å¼
                                </button>
                                <button class="view-toggle-btn" onclick="switchView('tree')">
                                    <i class="fas fa-sitemap"></i>
                                    æ ‘å½¢æ¨¡å¼
                                </button>
                            </div>
                        </div>
                        
                        <!-- æœç´¢æ æ•´åˆ -->
                        <div class="search-bar">
                            <div class="search-field">
                                <label>åŒºåŸŸåç§°</label>
                                <input type="text" id="searchName" placeholder="åç§°">
                            </div>
                            <div class="search-field">
                                <label>åŒºåŸŸä»£ç </label>
                                <input type="text" id="searchCode" placeholder="ä»£ç ">
                            </div>
                            <div class="search-field">
                                <label>åŒºåŸŸç±»å‹</label>
                                <select id="searchType">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="canteen">é£Ÿå ‚</option>
                                    <option value="supermarket">è¶…å¸‚</option>
                                    <option value="floor">æ¥¼å±‚</option>
                                    <option value="area">åŒºåŸŸ</option>
                                    <option value="counter">æ¡£å£</option>
                                </select>
                            </div>
                            <div class="search-field">
                                <label>ç»è¥æ¨¡å¼</label>
                                <select id="searchMode">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="meal">é¤åˆ«æ¨¡å¼</option>
                                    <option value="product">å•†å“æ¨¡å¼</option>
                                </select>
                            </div>
                            <div class="search-actions">
                                <button class="btn btn-primary" onclick="searchRegions()">
                                    <i class="fas fa-search"></i>
                                    æŸ¥è¯¢
                                </button>
                                <button class="btn btn-outline" onclick="resetSearch()">
                                    <i class="fas fa-redo"></i>
                                    é‡ç½®
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="openDrawer('add')">
                            <i class="fas fa-plus"></i>
                            æ–°å¢åŒºåŸŸ
                        </button>
                    </div>

                    <!-- åˆ—è¡¨æ¨¡å¼ -->
                    <div class="list-view active" id="listView">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>åŒºåŸŸåç§°</th>
                                <th>åŒºåŸŸä»£ç </th>
                                <th>åŒºåŸŸç±»å‹</th>
                                    <th>ç»è¥æ¨¡å¼</th>
                                    <th>ç‰¹æ®ŠåŠŸèƒ½</th>
                                <th>è®¾å¤‡æ•°é‡</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                            <tbody id="listTableBody">
                                <!-- æ•°æ®å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- æ ‘å½¢æ¨¡å¼ -->
                    <div class="tree-view" id="treeView">
                        <div id="treeContainer">
                            <!-- æ ‘å½¢æ•°æ®å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- é®ç½©å±‚ -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

    <!-- å³ä¾§æŠ½å±‰ -->
    <div class="drawer" id="regionDrawer">
        <div class="drawer-header">
            <h3 class="drawer-title" id="drawerTitle">æ–°å¢åŒºåŸŸ</h3>
            <button class="drawer-close" onclick="closeDrawer()">
                <i class="fas fa-times"></i>
                                        </button>
                                    </div>
        
        <div class="drawer-body">
            <form id="regionForm">
                <div class="form-group">
                    <label class="form-label">åŒºåŸŸåç§° <span class="required">*</span></label>
                    <input type="text" class="form-input" id="regionName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€é£Ÿå ‚" required>
                </div>

                <div class="form-group">
                    <label class="form-label">åŒºåŸŸä»£ç  <span class="required">*</span></label>
                    <input type="text" class="form-input" id="regionCode" placeholder="ä¾‹å¦‚ï¼šCANTEEN01" required>
                    <div class="form-hint">åŒºåŸŸä»£ç å¿…é¡»å”¯ä¸€</div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä¸Šçº§åŒºåŸŸ</label>
                    <select class="form-select" id="parentRegion">
                        <option value="">æ— ï¼ˆä½œä¸ºä¸€çº§åŒºåŸŸï¼‰</option>
                        <!-- é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <div class="form-hint">é€‰æ‹©ä¸Šçº§åŒºåŸŸåï¼Œè¯¥åŒºåŸŸå°†ä½œä¸ºå­åŒºåŸŸ</div>
                </div>

                <div class="form-group">
                    <label class="form-label">åŒºåŸŸç±»å‹ <span class="required">*</span></label>
                    <select class="form-select" id="regionType" required onchange="handleRegionTypeChange()">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="canteen">é£Ÿå ‚</option>
                        <option value="supermarket">è¶…å¸‚</option>
                        <option value="floor">æ¥¼å±‚</option>
                        <option value="area">åŒºåŸŸ</option>
                        <option value="counter">æ¡£å£</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ç»è¥æ¨¡å¼ <span class="required">*</span></label>
                    <select class="form-select" id="businessMode" required onchange="handleBusinessModeChange()">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="meal">é¤åˆ«æ¨¡å¼</option>
                        <option value="product">å•†å“æ¨¡å¼</option>
                    </select>
                    <div class="form-hint">é¤åˆ«æ¨¡å¼ï¼šæŒ‰æ—©ä¸­æ™šé¤ç®¡ç†ï¼›å•†å“æ¨¡å¼ï¼šæŒ‰å•†å“é”€å”®ç®¡ç†</div>
                </div>

                <!-- é£Ÿå ‚ç±»å‹ä¸“å±å­—æ®µ -->
                <div class="form-group" id="canteenOptions" style="display: none;">
                    <label class="form-label">è®¢é¤æ‰£æ¬¾</label>
                    <div style="display: flex; gap: var(--space-lg); margin-top: var(--space-sm);">
                        <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: pointer;">
                            <input type="radio" name="orderDeduction" value="1" style="cursor: pointer;">
                            <span>å¯ç”¨è®¢é¤æ‰£æ¬¾</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: pointer;">
                            <input type="radio" name="orderDeduction" value="0" checked style="cursor: pointer;">
                            <span>ä¸å¯ç”¨</span>
                        </label>
                    </div>
                    <div class="form-hint">å¯ç”¨åï¼Œç”¨æˆ·å¯ä»¥é¢„è®¢é¤é£Ÿå¹¶è‡ªåŠ¨æ‰£æ¬¾</div>
                </div>

                <!-- è¶…å¸‚ç±»å‹ä¸“å±å­—æ®µ -->
                <div class="form-group" id="supermarketOptions" style="display: none;">
                    <label class="form-label">è¿›é”€å­˜ç®¡ç†</label>
                    <div style="display: flex; gap: var(--space-lg); margin-top: var(--space-sm);">
                        <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: pointer;">
                            <input type="radio" name="inventoryManagement" value="1" style="cursor: pointer;">
                            <span>å¯ç”¨è¿›é”€å­˜</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: var(--space-xs); cursor: pointer;">
                            <input type="radio" name="inventoryManagement" value="0" checked style="cursor: pointer;">
                            <span>ä¸å¯ç”¨</span>
                        </label>
                    </div>
                    <div class="form-hint">å¯ç”¨åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç®¡ç†å•†å“åº“å­˜ã€è¿›è´§ã€é”€å”®ç­‰</div>
                </div>

                <div class="form-group">
                    <label class="form-label">æ’åº</label>
                    <input type="number" class="form-input" id="regionSort" placeholder="æ•°å­—è¶Šå°è¶Šé å‰" value="0">
                </div>

                <div class="form-group">
                    <label class="form-label">æè¿°è¯´æ˜</label>
                    <textarea class="form-input" id="regionDescription" rows="3" placeholder="è¾“å…¥åŒºåŸŸçš„æè¿°ä¿¡æ¯"></textarea>
                </div>
            </form>
        </div>

        <div class="drawer-footer">
            <button type="button" class="btn btn-outline" onclick="closeDrawer()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="submitForm()">
                <i class="fas fa-check"></i>
                ä¿å­˜
                                        </button>
                                    </div>
    </div>

    <script>
        // æ¨¡æ‹ŸåŒºåŸŸæ•°æ®
        let regionsData = [
            {
                id: 1,
                name: 'ç¬¬ä¸€é£Ÿå ‚',
                code: 'CANTEEN01',
                type: 'canteen',
                businessMode: 'meal',
                orderDeduction: true,
                parentId: null,
                level: 1,
                devices: 0,
                sort: 1,
                children: [
                    {
                        id: 11,
                        name: 'ä¸€æ¥¼ä¸»é£ŸåŒº',
                        code: 'C01-F1',
                        type: 'floor',
                        parentId: 1,
                        level: 2,
                        devices: 4,
                        sort: 1,
                        children: []
                    },
                    {
                        id: 12,
                        name: 'äºŒæ¥¼é¢é£ŸåŒº',
                        code: 'C01-F2',
                        type: 'floor',
                        parentId: 1,
                        level: 2,
                        devices: 5,
                        sort: 2,
                        children: []
                    },
                    {
                        id: 13,
                        name: 'ä¸‰æ¥¼å°åƒåŒº',
                        code: 'C01-F3',
                        type: 'floor',
                        parentId: 1,
                        level: 2,
                        devices: 3,
                        sort: 3,
                        children: []
                    }
                ]
            },
            {
                id: 2,
                name: 'ç¬¬äºŒé£Ÿå ‚',
                code: 'CANTEEN02',
                type: 'canteen',
                businessMode: 'meal',
                orderDeduction: false,
                parentId: null,
                level: 1,
                devices: 0,
                sort: 2,
                children: [
                    {
                        id: 21,
                        name: 'ä¸€æ¥¼çª—å£åŒº',
                        code: 'C02-F1',
                        type: 'floor',
                        parentId: 2,
                        level: 2,
                        devices: 4,
                        sort: 1,
                        children: []
                    },
                    {
                        id: 22,
                        name: 'äºŒæ¥¼è‡ªé€‰åŒº',
                        code: 'C02-F2',
                        type: 'floor',
                        parentId: 2,
                        level: 2,
                        devices: 4,
                        sort: 2,
                        children: []
                    }
                ]
            },
            {
                id: 3,
                name: 'è¶…å¸‚ä¾¿åˆ©åº—',
                code: 'SUPERMARKET01',
                type: 'supermarket',
                businessMode: 'product',
                inventoryManagement: true,
                parentId: null,
                level: 1,
                devices: 0,
                sort: 3,
                children: [
                    {
                        id: 31,
                        name: 'æ—¥ç”¨å“åŒº',
                        code: 'SM01-DAILY',
                        type: 'area',
                        parentId: 3,
                        level: 2,
                        devices: 2,
                        sort: 1,
                        children: []
                    },
                    {
                        id: 32,
                        name: 'é£Ÿå“é¥®æ–™åŒº',
                        code: 'SM01-FOOD',
                        type: 'area',
                        parentId: 3,
                        level: 2,
                        devices: 3,
                        sort: 2,
                        children: []
                    }
                ]
            },
            {
                id: 4,
                name: 'å‘˜å·¥é¤å…',
                code: 'RESTAURANT01',
                type: 'canteen',
                businessMode: 'meal',
                orderDeduction: false,
                parentId: null,
                level: 1,
                devices: 4,
                sort: 4,
                children: []
            }
        ];

        let currentEditId = null;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderListView();
            renderTreeView();
            console.log('åŒºåŸŸç®¡ç†é¡µé¢åŠ è½½å®Œæˆ');
        });

        // åˆ‡æ¢è§†å›¾æ¨¡å¼
        function switchView(mode) {
            const listView = document.getElementById('listView');
            const treeView = document.getElementById('treeView');
            const buttons = document.querySelectorAll('.view-toggle-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (mode === 'list') {
                listView.classList.add('active');
                treeView.classList.remove('active');
                buttons[0].classList.add('active');
            } else {
                listView.classList.remove('active');
                treeView.classList.add('active');
                buttons[1].classList.add('active');
            }
        }

        // æ¸²æŸ“åˆ—è¡¨è§†å›¾
        function renderListView() {
            const tbody = document.getElementById('listTableBody');
            const flatData = flattenRegions(regionsData);
            
            tbody.innerHTML = flatData.map(region => `
                <tr>
                            <td>${'ã€€'.repeat((region.level - 1) * 2)}${region.name}</td>
                            <td>${region.code}</td>
                            <td>${getRegionTypeName(region.type)}</td>
                            <td>${getBusinessModeName(region.businessMode)}</td>
                            <td>${getExtraFeatures(region)}</td>
                            <td>${region.devices || 0}</td>
                                <td>
                                    <span class="status-badge active">
                                        <i class="fas fa-check-circle"></i>
                                        å¯ç”¨
                                    </span>
                                </td>
                                <td>
                                    <div class="table-actions">
                            ${region.level < 3 ? `<button class="action-btn" onclick="openDrawer('add-child', ${region.id})" title="æ·»åŠ å­åŒºåŸŸ">
                                <i class="fas fa-plus"></i>
                            </button>` : ''}
                            <button class="action-btn" onclick="openDrawer('edit', ${region.id})" title="ç¼–è¾‘">
                                            <i class="fas fa-edit"></i>
                                        </button>
                            <button class="action-btn delete" onclick="deleteRegion(${region.id})" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
            `).join('');
        }

        // æ¸²æŸ“æ ‘å½¢è§†å›¾
        function renderTreeView() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = regionsData.map(region => renderTreeNode(region)).join('');
        }

        // æ¸²æŸ“æ ‘èŠ‚ç‚¹
        function renderTreeNode(node) {
            const hasChildren = node.children && node.children.length > 0;
            const iconClass = `level-${node.level}`;
            const icon = getNodeIcon(node.type);
            
            return `
                <div class="tree-node">
                    <div class="node-item" data-id="${node.id}">
                        <div class="node-toggle ${hasChildren ? '' : 'empty'}" onclick="toggleNode(${node.id})">
                            ${hasChildren ? '<i class="fas fa-chevron-right"></i>' : ''}
                        </div>
                        <div class="node-icon ${iconClass}">
                            <i class="${icon}"></i>
                        </div>
                        <div class="node-content">
                            <div>
                                <span class="node-name">${node.name}</span>
                                <span class="node-code">${node.code}</span>
                            </div>
                            <div class="node-info">
                                <span><i class="fas fa-layer-group"></i> ç¬¬${node.level}çº§</span>
                                <span><i class="fas fa-desktop"></i> ${node.devices || 0}å°è®¾å¤‡</span>
                            </div>
                        </div>
                        <div class="node-actions">
                            ${node.level < 3 ? `<button class="action-btn" onclick="openDrawer('add-child', ${node.id})" title="æ·»åŠ å­åŒºåŸŸ">
                                <i class="fas fa-plus"></i>
                            </button>` : ''}
                            <button class="action-btn" onclick="openDrawer('edit', ${node.id})" title="ç¼–è¾‘">
                                            <i class="fas fa-edit"></i>
                                        </button>
                            <button class="action-btn delete" onclick="deleteRegion(${node.id})" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                    </div>
                    ${hasChildren ? `
                        <div class="node-children">
                            ${node.children.map(child => renderTreeNode(child)).join('')}
            </div>
                    ` : ''}
    </div>
            `;
        }

        // åˆ‡æ¢æ ‘èŠ‚ç‚¹å±•å¼€/æ”¶èµ·
        function toggleNode(id) {
            const nodeItem = document.querySelector(`.node-item[data-id="${id}"]`);
            if (nodeItem) {
                nodeItem.classList.toggle('expanded');
            }
        }

        // è·å–èŠ‚ç‚¹å›¾æ ‡
        function getNodeIcon(type) {
            const icons = {
                canteen: 'fas fa-building',
                supermarket: 'fas fa-shopping-cart',
                floor: 'fas fa-layer-group',
                area: 'fas fa-th-large',
                counter: 'fas fa-store'
            };
            return icons[type] || 'fas fa-map-marker-alt';
        }

        // è·å–åŒºåŸŸç±»å‹åç§°
        function getRegionTypeName(type) {
            const names = {
                canteen: 'é£Ÿå ‚',
                supermarket: 'è¶…å¸‚',
                floor: 'æ¥¼å±‚',
                area: 'åŒºåŸŸ',
                counter: 'æ¡£å£'
            };
            return names[type] || '-';
        }

        // è·å–ç»è¥æ¨¡å¼åç§°
        function getBusinessModeName(mode) {
            const names = {
                meal: 'é¤åˆ«æ¨¡å¼',
                product: 'å•†å“æ¨¡å¼'
            };
            return names[mode] || '-';
        }

        // è·å–é¢å¤–åŠŸèƒ½
        function getExtraFeatures(region) {
            const features = [];
            if (region.type === 'canteen' && region.orderDeduction) {
                features.push('<span style="color: var(--success); font-size: var(--text-xs);">ğŸ“… è®¢é¤æ‰£æ¬¾</span>');
            }
            if (region.type === 'supermarket' && region.inventoryManagement) {
                features.push('<span style="color: var(--info); font-size: var(--text-xs);">ğŸ“¦ è¿›é”€å­˜</span>');
            }
            return features.length > 0 ? features.join(' ') : '-';
        }

        // å¤„ç†åŒºåŸŸç±»å‹å˜åŒ–
        function handleRegionTypeChange() {
            const type = document.getElementById('regionType').value;
            const canteenOptions = document.getElementById('canteenOptions');
            const supermarketOptions = document.getElementById('supermarketOptions');
            
            // éšè—æ‰€æœ‰ä¸“å±é€‰é¡¹
            canteenOptions.style.display = 'none';
            supermarketOptions.style.display = 'none';
            
            // æ ¹æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”é€‰é¡¹
            if (type === 'canteen') {
                canteenOptions.style.display = 'block';
            } else if (type === 'supermarket') {
                supermarketOptions.style.display = 'block';
            }
        }

        // å¤„ç†ç»è¥æ¨¡å¼å˜åŒ–
        function handleBusinessModeChange() {
            const mode = document.getElementById('businessMode').value;
            // å¯ä»¥æ ¹æ®ç»è¥æ¨¡å¼åšè¿›ä¸€æ­¥å¤„ç†
            console.log('ç»è¥æ¨¡å¼å·²é€‰æ‹©:', mode);
        }

        // æ‰å¹³åŒ–åŒºåŸŸæ•°æ®
        function flattenRegions(regions, parentName = null) {
            let result = [];
            regions.forEach(region => {
                result.push({
                    ...region,
                    parentName: parentName
                });
                if (region.children && region.children.length > 0) {
                    result = result.concat(flattenRegions(region.children, region.name));
                }
            });
            return result;
        }

        // æŸ¥æ‰¾åŒºåŸŸ
        function findRegion(id, data = regionsData) {
            for (let region of data) {
                if (region.id === id) return region;
                if (region.children) {
                    const found = findRegion(id, region.children);
                    if (found) return found;
                }
            }
            return null;
        }

        // æ‰“å¼€æŠ½å±‰
        function openDrawer(mode, id = null) {
            const drawer = document.getElementById('regionDrawer');
            const overlay = document.getElementById('drawerOverlay');
            const title = document.getElementById('drawerTitle');
            const form = document.getElementById('regionForm');
            const parentSelect = document.getElementById('parentRegion');
            
            form.reset();
            currentEditId = null;
            
            // å¡«å……ä¸Šçº§åŒºåŸŸé€‰é¡¹
            parentSelect.innerHTML = '<option value="">æ— ï¼ˆä½œä¸ºä¸€çº§åŒºåŸŸï¼‰</option>';
            const flatData = flattenRegions(regionsData).filter(r => r.level < 3);
            flatData.forEach(region => {
                if (mode === 'edit' && region.id === id) return;
                parentSelect.innerHTML += `
                    <option value="${region.id}">${'ã€€'.repeat((region.level - 1) * 2)}${region.name}</option>
                `;
            });
            
            if (mode === 'add') {
                title.textContent = 'æ–°å¢åŒºåŸŸ';
            } else if (mode === 'add-child') {
                title.textContent = 'æ–°å¢å­åŒºåŸŸ';
                document.getElementById('parentRegion').value = id;
            } else if (mode === 'edit') {
                title.textContent = 'ç¼–è¾‘åŒºåŸŸ';
                currentEditId = id;
                const region = findRegion(id);
                if (region) {
                    document.getElementById('regionName').value = region.name;
                    document.getElementById('regionCode').value = region.code;
                    document.getElementById('parentRegion').value = region.parentId || '';
                    document.getElementById('regionType').value = region.type;
                    document.getElementById('businessMode').value = region.businessMode || '';
                    document.getElementById('regionSort').value = region.sort;
                    document.getElementById('regionDescription').value = region.description || '';
                    
                    // è®¾ç½®è®¢é¤æ‰£æ¬¾
                    if (region.orderDeduction !== undefined) {
                        const radios = document.querySelectorAll('input[name="orderDeduction"]');
                        radios.forEach(radio => {
                            radio.checked = radio.value === (region.orderDeduction ? '1' : '0');
                        });
                    }
                    
                    // è®¾ç½®è¿›é”€å­˜
                    if (region.inventoryManagement !== undefined) {
                        const radios = document.querySelectorAll('input[name="inventoryManagement"]');
                        radios.forEach(radio => {
                            radio.checked = radio.value === (region.inventoryManagement ? '1' : '0');
                        });
                    }
                    
                    // è§¦å‘ç±»å‹å˜åŒ–ä»¥æ˜¾ç¤ºå¯¹åº”é€‰é¡¹
                    handleRegionTypeChange();
                }
            }
            
            overlay.classList.add('show');
            setTimeout(() => drawer.classList.add('show'), 10);
        }

        // å…³é—­æŠ½å±‰
        function closeDrawer() {
            const drawer = document.getElementById('regionDrawer');
            const overlay = document.getElementById('drawerOverlay');
            
            drawer.classList.remove('show');
            setTimeout(() => overlay.classList.remove('show'), 300);
        }

        // æäº¤è¡¨å•
        function submitForm() {
            const form = document.getElementById('regionForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {
                id: currentEditId || Date.now(),
                name: document.getElementById('regionName').value,
                code: document.getElementById('regionCode').value,
                parentId: document.getElementById('parentRegion').value || null,
                type: document.getElementById('regionType').value,
                businessMode: document.getElementById('businessMode').value,
                sort: parseInt(document.getElementById('regionSort').value) || 0,
                description: document.getElementById('regionDescription').value,
                devices: 0,
                children: []
            };
            
            // æ ¹æ®ç±»å‹æ·»åŠ ä¸“å±å±æ€§
            if (formData.type === 'canteen') {
                const orderDeduction = document.querySelector('input[name="orderDeduction"]:checked');
                formData.orderDeduction = orderDeduction ? orderDeduction.value === '1' : false;
            }
            
            if (formData.type === 'supermarket') {
                const inventoryManagement = document.querySelector('input[name="inventoryManagement"]:checked');
                formData.inventoryManagement = inventoryManagement ? inventoryManagement.value === '1' : false;
            }
            
            if (currentEditId) {
                // æ›´æ–°é€»è¾‘
                updateRegionInTree(regionsData, formData);
                alert('åŒºåŸŸä¿¡æ¯å·²æ›´æ–°ï¼');
            } else {
                // æ–°å¢é€»è¾‘
                formData.level = formData.parentId ? getRegionLevel(formData.parentId) + 1 : 1;
                addRegionToTree(regionsData, formData);
                alert('åŒºåŸŸå·²æ·»åŠ ï¼');
            }
            
            renderListView();
            renderTreeView();
            closeDrawer();
        }

        // æ·»åŠ åŒºåŸŸåˆ°æ ‘
        function addRegionToTree(tree, newRegion) {
            if (!newRegion.parentId) {
                tree.push(newRegion);
                return true;
            }
            
            for (let region of tree) {
                if (region.id == newRegion.parentId) {
                    if (!region.children) region.children = [];
                    region.children.push(newRegion);
                    return true;
                }
                if (region.children && addRegionToTree(region.children, newRegion)) {
                    return true;
                }
            }
            return false;
        }

        // æ›´æ–°åŒºåŸŸ
        function updateRegionInTree(tree, updatedRegion) {
            for (let i = 0; i < tree.length; i++) {
                if (tree[i].id === updatedRegion.id) {
                    tree[i] = { ...tree[i], ...updatedRegion };
                    return true;
                }
                if (tree[i].children && updateRegionInTree(tree[i].children, updatedRegion)) {
                    return true;
                }
            }
            return false;
        }

        // è·å–åŒºåŸŸå±‚çº§
        function getRegionLevel(id) {
            const region = findRegion(id);
            return region ? region.level : 0;
        }

        // åˆ é™¤åŒºåŸŸ
        function deleteRegion(id) {
            const region = findRegion(id);
            if (!region) return;
            
            if (region.children && region.children.length > 0) {
                alert('è¯¥åŒºåŸŸä¸‹è¿˜æœ‰å­åŒºåŸŸï¼Œæ— æ³•åˆ é™¤ï¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åŒºåŸŸ"${region.name}"å—ï¼Ÿ`)) {
                return;
            }
            
            deleteRegionFromTree(regionsData, id);
            renderListView();
            renderTreeView();
            alert('åŒºåŸŸå·²åˆ é™¤ï¼');
        }

        // ä»æ ‘ä¸­åˆ é™¤åŒºåŸŸ
        function deleteRegionFromTree(tree, id) {
            for (let i = 0; i < tree.length; i++) {
                if (tree[i].id === id) {
                    tree.splice(i, 1);
                    return true;
                }
                if (tree[i].children && deleteRegionFromTree(tree[i].children, id)) {
                    return true;
                }
            }
            return false;
        }

        // ESCé”®å…³é—­æŠ½å±‰
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const drawer = document.getElementById('regionDrawer');
                if (drawer.classList.contains('show')) {
                    closeDrawer();
                }
            }
        });

        // æœç´¢åŒºåŸŸ
        function searchRegions() {
            const name = document.getElementById('searchName').value.toLowerCase();
            const code = document.getElementById('searchCode').value.toLowerCase();
            const type = document.getElementById('searchType').value;
            const mode = document.getElementById('searchMode').value;
            
            // è¿‡æ»¤æ•°æ®
            const filteredData = flattenRegions(regionsData).filter(region => {
                const matchName = !name || region.name.toLowerCase().includes(name);
                const matchCode = !code || region.code.toLowerCase().includes(code);
                const matchType = !type || region.type === type;
                const matchMode = !mode || region.businessMode === mode;
                return matchName && matchCode && matchType && matchMode;
            });
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            const tbody = document.getElementById('listTableBody');
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: var(--space-xl); color: var(--gray-500);">æœªæ‰¾åˆ°åŒ¹é…çš„åŒºåŸŸ</td></tr>';
            } else {
                tbody.innerHTML = filteredData.map(region => `
                    <tr>
                        <td>${'ã€€'.repeat((region.level - 1) * 2)}${region.name}</td>
                        <td>${region.code}</td>
                        <td>${getRegionTypeName(region.type)}</td>
                        <td>${getBusinessModeName(region.businessMode)}</td>
                        <td>${getExtraFeatures(region)}</td>
                        <td>${region.devices || 0}</td>
                        <td>
                            <span class="status-badge active">
                                <i class="fas fa-check-circle"></i>
                                å¯ç”¨
                            </span>
                        </td>
                        <td>
                            <div class="table-actions">
                                ${region.level < 3 ? `<button class="action-btn" onclick="openDrawer('add-child', ${region.id})" title="æ·»åŠ å­åŒºåŸŸ">
                                    <i class="fas fa-plus"></i>
                                </button>` : ''}
                                <button class="action-btn" onclick="openDrawer('edit', ${region.id})" title="ç¼–è¾‘">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteRegion(${region.id})" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            console.log(`æ‰¾åˆ° ${filteredData.length} æ¡åŒ¹é…è®°å½•`);
        }

        // é‡ç½®æœç´¢
        function resetSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchCode').value = '';
            document.getElementById('searchType').value = '';
            document.getElementById('searchMode').value = '';
            renderListView();
        }
    </script>
</body>
</html>
