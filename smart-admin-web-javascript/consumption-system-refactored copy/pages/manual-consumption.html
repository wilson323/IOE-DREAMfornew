<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手工补消费 - 消费管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../js/menu.js" defer></script>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .content-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--space-xl);
        }
        .form-section {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-lg);
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        .form-group label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: var(--text-sm);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: var(--space-sm);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            background: white;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-2xl);
        }
        .step {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-200);
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--text-sm);
        }
        .step.active .step-number {
            background: var(--primary-500);
            color: white;
        }
        .step.completed .step-number {
            background: var(--success);
            color: white;
        }
        .step-line {
            width: 60px;
            height: 2px;
            background: var(--gray-200);
        }
        .alert {
            padding: var(--space-md);
            border-radius: var(--radius);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .alert-warning {
            background: var(--warning-100);
            color: var(--warning-700);
            border: 1px solid var(--warning-200);
        }
        .alert-success {
            background: var(--success-100);
            color: var(--success-700);
            border: 1px solid var(--success-200);
        }
        .btn-group {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            margin-top: var(--space-xl);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-utensils fa-lg"></i>
                <div>
                    <div class="sidebar-title">消费管理系统</div>
                    <div class="sidebar-subtitle">Consumption Hub</div>
                </div>
            </div>
            <div class="sidebar-menu">
                <!-- 菜单将由 menu.js 自动生成 -->
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 顶部导航栏 -->
            <header class="header">
                <h1>手工补消费</h1>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-bell"></i>
                        通知
                    </button>
                    <div class="user-info">
                        <div>
                            <div style="font-weight: 600;">系统管理员</div>
                            <div style="font-size: 12px; color: var(--gray-500);">在线</div>
                        </div>
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- 主要内容 -->
            <div class="content">
                <!-- 警告提示 -->
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>注意：</strong>手工补消费是特殊操作，仅用于处理设备故障、网络异常等特殊情况下的消费记录补录。请确保操作的合规性和准确性。
                    </div>
                </div>

                <!-- 步骤指示器 -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <span>选择账户</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <span>填写消费信息</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <span>确认提交</span>
                    </div>
                </div>

                <!-- 步骤1：选择账户 -->
                <section class="content-card" id="accountStep">
                    <h2 style="font-size: var(--text-xl); font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-xl);">步骤1：选择消费账户</h2>

                    <div class="form-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>账户编号 <span style="color: var(--danger);">*</span></label>
                                <input type="text" placeholder="请输入账户编号或刷卡" id="accountNumber">
                            </div>
                            <div class="form-group">
                                <label>持卡人姓名</label>
                                <input type="text" placeholder="自动查询" id="accountName" readonly>
                            </div>
                            <div class="form-group">
                                <label>账户类型</label>
                                <input type="text" placeholder="自动查询" id="accountType" readonly>
                            </div>
                            <div class="form-group">
                                <label>当前余额</label>
                                <input type="text" placeholder="自动查询" id="currentBalance" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="searchAccount()">
                            <i class="fas fa-search"></i>
                            查询账户
                        </button>
                        <button class="btn btn-secondary" onclick="nextStep()" id="nextStep1" disabled>
                            下一步
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </section>

                <!-- 步骤2：填写消费信息 -->
                <section class="content-card" id="infoStep" style="display: none;">
                    <h2 style="font-size: var(--text-xl); font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-xl);">步骤2：填写消费信息</h2>

                    <div class="form-section">
                        <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--gray-800); margin-bottom: var(--space-lg);">基本信息</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>消费时间 <span style="color: var(--danger);">*</span></label>
                                <input type="datetime-local" id="consumeTime">
                            </div>
                            <div class="form-group">
                                <label>消费地点 <span style="color: var(--danger);">*</span></label>
                                <select id="consumeLocation">
                                    <option value="">请选择消费地点</option>
                                    <option value="第一食堂-1号窗口">第一食堂-1号窗口</option>
                                    <option value="第一食堂-2号窗口">第一食堂-2号窗口</option>
                                    <option value="第二食堂-1号窗口">第二食堂-1号窗口</option>
                                    <option value="第二食堂-2号窗口">第二食堂-2号窗口</option>
                                    <option value="餐厅">餐厅</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>设备编号</label>
                                <input type="text" placeholder="请输入设备编号" id="deviceNumber">
                            </div>
                            <div class="form-group">
                                <label>操作员</label>
                                <input type="text" placeholder="请输入操作员工号" id="operator">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--gray-800); margin-bottom: var(--space-lg);">消费详情</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>消费金额 <span style="color: var(--danger);">*</span></label>
                                <input type="number" placeholder="0.00" step="0.01" id="consumeAmount">
                            </div>
                            <div class="form-group">
                                <label>商品名称 <span style="color: var(--danger);">*</span></label>
                                <select id="productName">
                                    <option value="">请选择商品</option>
                                    <option value="经典汉堡套餐">经典汉堡套餐 - ¥28.00</option>
                                    <option value="意大利披萨">意大利披萨 - ¥35.00</option>
                                    <option value="营养套餐">营养套餐 - ¥18.00</option>
                                    <option value="精品套餐">精品套餐 - ¥25.00</option>
                                    <option value="饮料">饮料 - ¥5.00</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>支付方式 <span style="color: var(--danger);">*</span></label>
                                <select id="paymentMethod">
                                    <option value="">请选择支付方式</option>
                                    <option value="现金钱包">现金钱包</option>
                                    <option value="补贴钱包">补贴钱包</option>
                                    <option value="优惠钱包">优惠钱包</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>餐别</label>
                                <select id="mealType">
                                    <option value="">请选择餐别</option>
                                    <option value="早餐">早餐</option>
                                    <option value="午餐">午餐</option>
                                    <option value="晚餐">晚餐</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: var(--space-lg);">
                            <label>补消费原因 <span style="color: var(--danger);">*</span></label>
                            <textarea placeholder="请详细说明补消费的原因..." id="reason"></textarea>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i>
                            上一步
                        </button>
                        <button class="btn btn-primary" onclick="nextStep()">
                            下一步
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </section>

                <!-- 步骤3：确认提交 -->
                <section class="content-card" id="confirmStep" style="display: none;">
                    <h2 style="font-size: var(--text-xl); font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-xl);">步骤3：确认提交</h2>

                    <div class="alert alert-success">
                        <i class="fas fa-info-circle"></i>
                        <div>请仔细核对以下消费信息，确认无误后提交</div>
                    </div>

                    <div class="form-section">
                        <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--gray-800); margin-bottom: var(--space-lg);">账户信息</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
                            <div><strong>账户编号：</strong><span id="confirmAccountNumber"></span></div>
                            <div><strong>持卡人：</strong><span id="confirmAccountName"></span></div>
                            <div><strong>账户类型：</strong><span id="confirmAccountType"></span></div>
                            <div><strong>当前余额：</strong><span id="confirmCurrentBalance"></span></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 style="font-size: var(--text-lg); font-weight: 600; color: var(--gray-800); margin-bottom: var(--space-lg);">消费信息</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
                            <div><strong>消费时间：</strong><span id="confirmConsumeTime"></span></div>
                            <div><strong>消费地点：</strong><span id="confirmConsumeLocation"></span></div>
                            <div><strong>设备编号：</strong><span id="confirmDeviceNumber"></span></div>
                            <div><strong>操作员：</strong><span id="confirmOperator"></span></div>
                            <div><strong>消费金额：</strong><span id="confirmConsumeAmount" style="color: var(--danger); font-weight: 600;"></span></div>
                            <div><strong>商品名称：</strong><span id="confirmProductName"></span></div>
                            <div><strong>支付方式：</strong><span id="confirmPaymentMethod"></span></div>
                            <div><strong>餐别：</strong><span id="confirmMealType"></span></div>
                        </div>
                        <div style="margin-top: var(--space-md);">
                            <strong>补消费原因：</strong><p id="confirmReason" style="margin-top: var(--space-xs); color: var(--gray-600);"></p>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-outline" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i>
                            上一步
                        </button>
                        <button class="btn btn-primary" onclick="submitManualConsumption()">
                            <i class="fas fa-check"></i>
                            确认提交
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        let currentStep = 1;
        let accountData = null;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('手工补消费页面加载完成');

            // 设置默认消费时间为当前时间
            const now = new Date();
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('consumeTime').value = timeString;
        });

        // 查询账户
        function searchAccount() {
            const accountNumber = document.getElementById('accountNumber').value.trim();
            if (!accountNumber) {
                alert('请输入账户编号');
                return;
            }

            // 模拟查询账户信息
            accountData = {
                accountNumber: accountNumber,
                accountName: '张三',
                accountType: '学生卡',
                currentBalance: '¥128.50'
            };

            // 填充账户信息
            document.getElementById('accountName').value = accountData.accountName;
            document.getElementById('accountType').value = accountData.accountType;
            document.getElementById('currentBalance').value = accountData.currentBalance;

            // 启用下一步按钮
            document.getElementById('nextStep1').disabled = false;

            console.log('查询账户信息:', accountData);
        }

        // 下一步
        function nextStep() {
            if (currentStep === 1 && !accountData) {
                alert('请先查询账户信息');
                return;
            }

            if (currentStep === 2) {
                // 验证表单
                if (!validateForm()) {
                    return;
                }
                // 填充确认信息
                fillConfirmInfo();
            }

            // 隐藏当前步骤
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(getStepElementId(currentStep)).style.display = 'none';

            // 显示下一步骤
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(getStepElementId(currentStep)).style.display = 'block';

            console.log('进入步骤', currentStep);
        }

        // 上一步
        function prevStep() {
            // 隐藏当前步骤
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(getStepElementId(currentStep)).style.display = 'none';

            // 显示上一步骤
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(getStepElementId(currentStep)).style.display = 'block';

            console.log('返回步骤', currentStep);
        }

        // 获取步骤元素ID
        function getStepElementId(step) {
            switch(step) {
                case 1: return 'accountStep';
                case 2: return 'infoStep';
                case 3: return 'confirmStep';
                default: return '';
            }
        }

        // 验证表单
        function validateForm() {
            const consumeTime = document.getElementById('consumeTime').value;
            const consumeLocation = document.getElementById('consumeLocation').value;
            const consumeAmount = document.getElementById('consumeAmount').value;
            const productName = document.getElementById('productName').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const reason = document.getElementById('reason').value.trim();

            if (!consumeTime || !consumeLocation || !consumeAmount || !productName || !paymentMethod || !reason) {
                alert('请填写所有必填项');
                return false;
            }

            if (parseFloat(consumeAmount) <= 0) {
                alert('消费金额必须大于0');
                return false;
            }

            return true;
        }

        // 填充确认信息
        function fillConfirmInfo() {
            document.getElementById('confirmAccountNumber').textContent = accountData.accountNumber;
            document.getElementById('confirmAccountName').textContent = accountData.accountName;
            document.getElementById('confirmAccountType').textContent = accountData.accountType;
            document.getElementById('confirmCurrentBalance').textContent = accountData.currentBalance;

            document.getElementById('confirmConsumeTime').textContent = new Date(document.getElementById('consumeTime').value).toLocaleString();
            document.getElementById('confirmConsumeLocation').textContent = document.getElementById('consumeLocation').value;
            document.getElementById('confirmDeviceNumber').textContent = document.getElementById('deviceNumber').value || '未填写';
            document.getElementById('confirmOperator').textContent = document.getElementById('operator').value || '未填写';
            document.getElementById('confirmConsumeAmount').textContent = '¥' + document.getElementById('consumeAmount').value;
            document.getElementById('confirmProductName').textContent = document.getElementById('productName').value;
            document.getElementById('confirmPaymentMethod').textContent = document.getElementById('paymentMethod').value;
            document.getElementById('confirmMealType').textContent = document.getElementById('mealType').value || '未选择';
            document.getElementById('confirmReason').textContent = document.getElementById('reason').value;
        }

        // 提交手工补消费
        function submitManualConsumption() {
            console.log('提交手工补消费记录');

            // 模拟提交
            setTimeout(() => {
                alert('手工补消费记录提交成功！\n记录编号：MC' + Date.now());

                // 重置表单
                resetForm();
            }, 1000);
        }

        // 重置表单
        function resetForm() {
            // 重置步骤
            currentStep = 1;
            accountData = null;

            // 重置UI
            document.getElementById('step3').classList.remove('active');
            document.getElementById('confirmStep').style.display = 'none';
            document.getElementById('step1').classList.add('active');
            document.getElementById('accountStep').style.display = 'block';

            // 清空表单
            document.getElementById('accountNumber').value = '';
            document.getElementById('accountName').value = '';
            document.getElementById('accountType').value = '';
            document.getElementById('currentBalance').value = '';
            document.getElementById('consumeAmount').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('reason').value = '';
            document.getElementById('nextStep1').disabled = true;

            // 重置时间
            const now = new Date();
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('consumeTime').value = timeString;
        }
    </script>
</body>
</html>