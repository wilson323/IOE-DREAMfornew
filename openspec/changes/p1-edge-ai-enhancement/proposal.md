# P1阶段：边缘AI架构增强 - 提案

**变更ID**: p1-edge-ai-enhancement
**状态**: 提案中 (Proposed)
**创建日期**: 2025-01-30
**优先级**: P1（高优先级）
**预计工期**: 4周
**相关变更**: [refactor-video-edge-ai-architecture](../refactor-video-edge-ai-architecture/)

---

## 1. 摘要（Abstract）

本提案旨在完成IOE-DREAM视频服务边缘计算架构的**P1阶段增强**，在P0阶段完成核心架构修复的基础上，进一步完善系统功能，实现生产级别的可用性。

**核心目标**：
1. ✅ 实现AI模型版本管理和远程更新机制
2. ✅ 实现实时事件推送（WebSocket）
3. ✅ 实现前端事件展示和告警管理页面
4. ✅ 完善单元测试、集成测试和性能测试

**预期收益**：
- 🚀 系统可用性：从P0的"核心功能"提升到"生产级别"
- 📊 运维效率：AI模型远程更新，无需人工干预
- ⚡ 用户体验：实时事件推送，< 500ms延迟
- 🎯 质量保障：测试覆盖率 > 80%，性能达标

---

## 2. 问题陈述（Problem Statement）

### 2.1 当前状态（P0阶段完成后）

✅ **已完成的工作**：
- 架构修复：删除服务器端AI分析，实现边缘计算架构
- 设备事件接收：DeviceAIEventReceiver 已实现
- 告警规则引擎：AlarmRuleEngine 已实现并集成
- 数据库设计：3个新表已创建
- 编译验证：BUILD SUCCESS，架构合规性100%

### 2.2 存在的不足

❌ **P1阶段需要解决的问题**：

1. **AI模型管理缺失**
   - 无法管理设备端AI模型版本
   - 无法远程更新AI模型
   - 无法监控设备端模型性能

2. **实时性不足**
   - 设备事件无法实时推送
   - 前端需要轮询获取事件
   - 告警延迟 > 3秒（WebSocket可降至 < 500ms）

3. **前端展示缺失**
   - 无设备AI事件展示页面
   - 无告警管理页面
   - 无实时监控面板

4. **测试覆盖不足**
   - 新创建的代码无单元测试
   - 无集成测试
   - 无性能压测

### 2.3 业务影响

⚠️ **当前风险**：
- AI模型更新需要人工操作，效率低下
- 运维人员无法实时监控设备状态
- 管理员无法可视化查看告警事件
- 系统稳定性未经充分测试验证

---

## 3. 解决方案（Solution）

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    P1阶段增强架构                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐      ┌──────────────┐               │
│  │ AI模型管理   │      │ WebSocket    │               │
│  │              │      │ 实时推送      │               │
│  │ - 版本管理   │      │ - 事件推送    │               │
│  │ - 远程更新   │      │ - 告警推送    │               │
│  │ - 设备同步   │      │ - 心跳检测    │               │
│  └──────────────┘      └──────────────┘               │
│          │                      │                       │
│          ▼                      ▼                       │
│  ┌────────────────────────────────────────┐           │
│  │      核心业务层（P0已完成）            │           │
│  │  - DeviceAIEventManager              │           │
│  │  - AlarmRuleEngine                   │           │
│  └────────────────────────────────────────┘           │
│          │                      │                       │
│          ▼                      ▼                       │
│  ┌──────────────┐      ┌──────────────┐               │
│  │  前端应用     │      │  测试体系    │               │
│  │              │      │              │               │
│  │ - 事件展示   │      │ - 单元测试    │               │
│  │ - 告警管理   │      │ - 集成测试    │               │
│  │ - 实时监控   │      │ - 性能测试    │               │
│  └──────────────┘      └──────────────┘               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 技术选型

| 模块 | 技术栈 | 说明 |
|------|--------|------|
| **AI模型管理** | Spring Boot + MinIO + MyBatis-Plus | 模型文件存储、版本管理 |
| **实时推送** | WebSocket + STOMP协议 | Spring WebSocket集成 |
| **前端展示** | Vue 3 + Ant Design Vue + ECharts | 实时图表、告警列表 |
| **单元测试** | JUnit 5 + Mockito | > 80% 覆盖率 |
| **集成测试** | TestContainers + RestAssured | 容器化测试 |
| **性能测试** | JMeter + Gatling | 压力测试 |

---

## 4. 能力分解（Capabilities）

### 4.1 AI模型管理能力

**目标**：实现设备端AI模型的统一管理和远程更新

**核心功能**：
1. 模型版本管理
   - 模型上传、版本号管理
   - 模型元数据（版本、大小、MD5、支持的事件类型）
   - 模型状态（草稿、发布、废弃）

2. 设备模型同步
   - 主动推送模型到设备
   - 设备拉取最新模型
   - 版本兼容性检查

3. 模型远程更新
   - OTA（Over-The-Air）更新机制
   - 断点续传支持
   - 更新失败回滚

4. 模型性能监控
   - 设备端模型性能指标
   - 识别准确率统计
   - 误报率分析

**用户故事**：
```
作为系统管理员，
我希望能够远程更新设备AI模型，
以便优化识别准确率，无需人工到现场。

运维人员：
- 上传新版AI模型到服务器
- 指定目标设备群组
- 执行远程更新
- 查看更新进度和结果

设备：
- 接收模型更新通知
- 下载模型文件
- 验证模型完整性
- 应用新模型
- 上报更新结果
```

### 4.2 实时事件推送能力

**目标**：实现设备AI事件和告警的实时推送

**核心功能**：
1. WebSocket连接管理
   - 连接建立、心跳检测
   - 认证和授权
   - 断线重连机制

2. 事件推送
   - 设备AI事件实时推送
   - 告警事件实时推送
   - 推送过滤（用户权限、设备权限）

3. 消息队列
   - Redis Pub/Sub 消息转发
   - 消息持久化（离线消息）
   - 消息优先级

4. 推送优化
   - 消息批量推送
   - 推送限流（防止消息风暴）
   - 消息压缩

**用户故事**：
```
作为监控中心管理员，
我希望能够实时接收设备AI事件和告警，
以便及时处理异常情况。

前端应用：
- 建立WebSocket连接
- 订阅设备事件和告警
- 实时展示事件列表
- 播放告警音效

后端服务：
- 接收设备AI事件
- 匹配告警规则
- 通过WebSocket推送
- 处理连接管理
```

### 4.3 前端事件展示能力

**目标**：实现设备AI事件和告警的可视化管理

**核心功能**：
1. 事件展示页面
   - 事件列表（分页、筛选、排序）
   - 事件详情（图片、置信度、边界框）
   - 事件统计（按类型、按设备、按时间）

2. 告警管理页面
   - 告警列表（待处理、处理中、已处理）
   - 告警处理（分配、备注、关闭）
   - 告警统计（趋势图、TOP设备）

3. 实时监控面板
   - 实时事件流（WebSocket）
   - 设备状态监控
   - 告警级别分布

4. 数据导出
   - 事件数据导出（Excel）
   - 告警报告生成（PDF）

**用户故事**：
```
作为安全管理员，
我希望能够查看和管理设备AI事件和告警，
以便快速响应和处理异常情况。

主要功能：
- 查看实时事件列表
- 筛选重要告警
- 处理告警（分配、备注）
- 导出告警报告
- 查看事件统计趋势
```

### 4.4 测试完善能力

**目标**：建立完整的测试体系，保障代码质量和系统性能

**核心功能**：
1. 单元测试
   - Manager层测试 > 80% 覆盖率
   - Service层测试 > 75% 覆盖率
   - Controller层测试 > 60% 覆盖率

2. 集成测试
   - API集成测试
   - 数据库集成测试
   - WebSocket集成测试

3. 性能测试
   - 并发设备接入测试（1000路）
   - 事件接收吞吐量测试（10000事件/秒）
   - WebSocket推送性能测试

4. 压力测试
   - 长时间稳定性测试（72小时）
   - 峰值流量测试
   - 故障恢复测试

---

## 5. 实施计划（Implementation Plan）

### 5.1 时间规划

```
Week 1: AI模型管理模块
├─ Day 1-2: 数据库设计和DAO层
├─ Day 3-4: Manager和Service层
├─ Day 5: Controller和API接口
└─ Day 6-7: 单元测试和文档

Week 2: 实时事件推送
├─ Day 1-2: WebSocket配置和连接管理
├─ Day 3-4: 事件推送服务
├─ Day 5: Redis Pub/Sub集成
└─ Day 6-7: 集成测试和文档

Week 3: 前端展示页面
├─ Day 1-2: 事件展示页面
├─ Day 3-4: 告警管理页面
├─ Day 5: 实时监控面板
└─ Day 6-7: 前端集成测试

Week 4: 测试完善和优化
├─ Day 1-2: 单元测试补充
├─ Day 3-4: 集成测试和性能测试
├─ Day 5: 压力测试和优化
└─ Day 6-7: 文档完善和验收
```

### 5.2 依赖关系

```
AI模型管理模块 (独立)
    ↓
实时事件推送 (独立)
    ↓
前端展示页面 (依赖实时推送)
    ↓
测试完善 (依赖所有模块)
```

### 5.3 里程碑

| 里程碑 | 交付物 | 完成日期 |
|--------|--------|----------|
| M1: AI模型管理完成 | 模型管理API、文档、测试 | Week 1 |
| M2: 实时推送完成 | WebSocket服务、文档、测试 | Week 2 |
| M3: 前端展示完成 | Vue页面、API集成、测试 | Week 3 |
| M4: P1阶段完成 | 所有模块、测试、文档 | Week 4 |

---

## 6. 风险评估（Risk Assessment）

### 6.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| WebSocket连接不稳定 | 高 | 中 | 心跳机制、断线重连、消息持久化 |
| AI模型更新失败 | 中 | 低 | 版本回滚、断点续传、事务机制 |
| 前端性能问题 | 中 | 中 | 虚拟滚动、分页加载、数据缓存 |
| 测试覆盖不足 | 高 | 低 | 强制测试门禁、自动化测试流水线 |

### 6.2 业务风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 用户不接受新界面 | 中 | 低 | UI原型评审、用户培训、反馈收集 |
| 性能不达标 | 高 | 中 | 早期性能测试、持续优化、降级方案 |
| 设备兼容性问题 | 中 | 中 | 设备测试矩阵、适配器模式、兼容层 |

---

## 7. 成功指标（Success Criteria）

### 7.1 功能指标

- ✅ AI模型远程更新成功率 > 95%
- ✅ WebSocket消息推送延迟 < 500ms
- ✅ 前端页面加载时间 < 2秒
- ✅ 单元测试覆盖率 > 80%

### 7.2 性能指标

- ✅ 支持1000路设备同时在线
- ✅ 事件接收吞吐量 > 10000事件/秒
- ✅ WebSocket并发连接数 > 500
- ✅ API响应时间 P95 < 200ms

### 7.3 质量指标

- ✅ 集成测试通过率 = 100%
- ✅ 压力测试无内存泄漏
- ✅ 72小时稳定性测试无宕机
- ✅ 代码审查通过率 = 100%

---

## 8. 相关变更（Related Changes）

- **依赖**: [refactor-video-edge-ai-architecture](../refactor-video-edge-ai-architecture/) - P0阶段核心架构修复
- **前置**: 必须完成P0阶段所有任务
- **后续**: P2阶段（离线支持、监控体系、A/B测试）

---

## 9. 资源需求（Resource Requirements）

### 9.1 人力资源

| 角色 | 人数 | 工期 | 职责 |
|------|------|------|------|
| 后端开发工程师 | 2 | 4周 | AI模型管理、WebSocket推送 |
| 前端开发工程师 | 1 | 2周 | 前端展示页面 |
| 测试工程师 | 1 | 4周 | 测试体系建设、性能测试 |
| 架构师 | 1 | 兼职 | 架构设计、技术评审 |
| 产品经理 | 1 | 兼职 | 需求澄清、验收测试 |

### 9.2 技术资源

| 资源 | 配置 | 用途 |
|------|------|------|
| 开发环境 | 4核8G | 开发调试 |
| 测试环境 | 8核16G | 集成测试、性能测试 |
| MinIO存储 | 100GB | AI模型文件存储 |
| Redis | 4GB | WebSocket消息队列 |

---

## 10. 验收标准（Acceptance Criteria）

### 10.1 AI模型管理模块

- [ ] 管理员可以上传AI模型文件
- [ ] 系统自动记录模型版本和元数据
- [ ] 管理员可以指定目标设备进行远程更新
- [ ] 设备能够接收并应用新模型
- [ ] 更新失败时能够回滚到旧版本
- [ ] 所有API有完整的单元测试

### 10.2 实时事件推送模块

- [ ] 前端可以建立WebSocket连接
- [ ] 设备AI事件可以实时推送到前端
- [ ] 告警事件可以实时推送到前端
- [ ] 连接断开时自动重连
- [ ] 支持消息过滤（按权限、按设备）
- [ ] 所有功能有集成测试

### 10.3 前端展示模块

- [ ] 展示设备AI事件列表（分页、筛选）
- [ ] 展示告警列表（待处理、已处理）
- [ ] 管理员可以处理告警（分配、备注、关闭）
- [ ] 实时监控面板显示最新事件
- [ ] 支持数据导出（Excel、PDF）
- [ ] 所有功能有E2E测试

### 10.4 测试完善

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过率 = 100%
- [ ] 性能测试达到预期指标
- [ ] 压力测试无重大问题
- [ ] 所有测试自动化（CI/CD）

---

## 11. 附录（Appendix）

### 11.1 参考资料

- [CLAUDE.md - Mode 5: 边缘AI计算](../../CLAUDE.md)
- [ADR-001: 边缘计算架构决策](../refactor-video-edge-ai-architecture/docs/ADR-001-edge-computing-architecture.md)
- [Spring WebSocket文档](https://docs.spring.io/spring-framework/reference/web/websocket.html)
- [Vue 3文档](https://vuejs.org/)

### 11.2 术语表

| 术语 | 解释 |
|------|------|
| 边缘计算 | 设备端完成AI分析，服务器端管理事件 |
| AI模型 | 设备端运行的神经网络模型（如YOLO、ResNet） |
| OTA更新 | Over-The-Air，远程无线更新 |
| WebSocket | 全双工通信协议，支持实时推送 |
| 单元测试 | 对最小可测试单元（函数、类）的测试 |
| 集成测试 | 对多个模块协作的测试 |
| 性能测试 | 测试系统在特定负载下的性能表现 |

---

**提案人**: IOE-DREAM 架构委员会
**创建日期**: 2025-01-30
**状态**: ⏳ 待评审
**预计开始**: 2025-01-31
**预计完成**: 2025-02-27
