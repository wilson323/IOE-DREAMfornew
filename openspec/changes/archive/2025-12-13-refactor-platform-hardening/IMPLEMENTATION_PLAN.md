# Refactor Platform Hardening 实施计划

## 概述

本文档定义 `refactor-platform-hardening` 提案的详细实施计划，分阶段推进平台安全加固和质量提升。

## 实施阶段

### 阶段 1：P0 必做项（当前迭代）

#### 1.1 收敛白名单/匿名接口为单一真源

**目标**：以网关为主，统一维护白名单清单

**任务**：
- [ ] 1.1.1 生成全量白名单清单（网关 + 各服务）
- [ ] 1.1.2 在网关配置中统一定义白名单
- [ ] 1.1.3 删除各服务中的重复白名单配置
- [ ] 1.1.4 生成白名单审计清单

**产物**：
- `openspec/changes/refactor-platform-hardening/artifacts/whitelist-inventory.txt`
- 网关配置更新

**验证**：
- 所有白名单路径在网关中定义
- 各服务中的白名单配置已删除或标记为过期
- 白名单清单与实际路由一致

#### 1.2 鉴权与权限模型统一

**目标**：以 `permissions → hasAuthority` 为授权基线，角色仅作为补充

**任务**：
- [ ] 1.2.1 梳理当前权限模型（角色/权限/资源）
- [ ] 1.2.2 定义统一的权限模型规范
- [ ] 1.2.3 更新 Spring Security 配置以支持权限检查
- [ ] 1.2.4 更新各服务的权限检查代码

**产物**：
- `documentation/security/PERMISSION-MODEL-SPECIFICATION.md`
- Spring Security 配置更新

**验证**：
- 所有权限检查使用统一模型
- 权限与资源的映射清晰
- 测试覆盖权限检查场景

#### 1.3 配置默认口令/默认密钥清理

**目标**：所有部署清单禁止默认口令占位；生产环境缺失密钥 Fail-Fast

**任务**：
- [ ] 1.3.1 扫描代码库中的默认口令/密钥
- [ ] 1.3.2 删除所有默认口令占位
- [ ] 1.3.3 更新部署配置以强制从环境变量注入敏感信息
- [ ] 1.3.4 添加 Fail-Fast 校验（生产环境）

**产物**：
- 更新的 Docker/K8s 部署配置
- 环境变量配置模板

**验证**：
- 代码库中无默认口令
- 部署配置中无硬编码敏感信息
- 生产环境缺失配置时启动失败

### 阶段 2：P1 分阶段推进（后续迭代）

#### 2.1 microservices-common 边界拆分

**目标**：将"纯公共能力"与"业务域能力"拆开

**任务**：
- [ ] 2.1.1 分析 microservices-common 中的业务域对象
- [ ] 2.1.2 规划拆分方案（哪些下沉到各服务）
- [ ] 2.1.3 逐步下沉业务域 DAO/Entity/Manager
- [ ] 2.1.4 更新依赖关系

**产物**：
- 拆分方案文档
- 更新的 pom.xml 依赖

**验证**：
- microservices-common 仅包含纯公共能力
- 各服务的业务域对象已下沉
- 编译和测试通过

#### 2.2 前端 TODO 闭环

**目标**：按业务域拉通 API 契约，补齐页面调用

**任务**：
- [ ] 2.2.1 扫描前端代码中的 TODO
- [ ] 2.2.2 按业务域分类 TODO
- [ ] 2.2.3 补齐页面与后端接口的对接
- [ ] 2.2.4 端到端功能测试

**产物**：
- 前端代码更新
- 端到端测试用例

**验证**：
- 所有 TODO 已解决
- 前端页面与后端接口一致
- 端到端功能测试通过

## 实施时间表

| 阶段 | 任务 | 预计周期 | 状态 |
|------|------|---------|------|
| P0 | 1.1 白名单收敛 | 1 周 | 待开始 |
| P0 | 1.2 权限模型统一 | 2 周 | 待开始 |
| P0 | 1.3 配置清理 | 1 周 | 待开始 |
| P1 | 2.1 common 拆分 | 3-4 周 | 待开始 |
| P1 | 2.2 前端闭环 | 2-3 周 | 待开始 |

## 风险与缓解

| 风险 | 缓解方案 |
|------|---------|
| 白名单收敛导致路由冲突 | 制定路由优先级规则，提供自动化验证脚本 |
| 权限模型变更影响现有功能 | 兼容旧模型，逐步迁移，充分测试 |
| 配置清理影响本地开发 | 开发环境允许本地 `.env` 文件，仅生产环境强制 |
| common 拆分导致循环依赖 | 严格遵循依赖方向，使用接口隔离 |

## 验证与质量门禁

- [ ] 所有 P0 任务完成且通过验证
- [ ] `mvn -pl microservices -am test` 通过
- [ ] `mvn -pl microservices -am verify` 通过（Jacoco 覆盖率 ≥ 70%）
- [ ] 白名单清单与实际路由一致
- [ ] 无默认口令/密钥在代码库中
- [ ] 前端 TODO 全部闭环

## 相关文档

- [API 契约基线](../../documentation/api/API-CONTRACT-BASELINE.md)
- [网关安全基线](../../documentation/security/GATEWAY-SECURITY-BASELINE.md)
- [权限模型规范](../../documentation/security/PERMISSION-MODEL-SPECIFICATION.md)
