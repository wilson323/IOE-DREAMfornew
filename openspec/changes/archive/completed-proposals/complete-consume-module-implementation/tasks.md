# 完善消费模块核心功能实施清单

## Phase 1: 核心架构修复（1-2周）

### 1. 消费模式策略架构重构
- [ ] 1.1 创建`ConsumeModeEnum`枚举，添加5种缺失模式
  - [ ] FIXED_AMOUNT（定值消费）
  - [ ] FREE_AMOUNT（免费金额）
  - [ ] METERED（计量计费）
  - [ ] PRODUCT（商品消费）
  - [ ] ORDER（订餐消费）
  - [ ] INTELLIGENCE（智能消费）
- [ ] 1.2 创建`ConsumptionModeStrategy`接口
  - [ ] 定义统一的策略接口方法
  - [ ] 包含验证、处理、计算、配置等方法
- [ ] 1.3 实现6个策略实现类
  - [ ] FixedAmountModeStrategy（定值消费策略）
  - [ ] FreeAmountModeStrategy（免费金额策略）
  - [ ] MeteredModeStrategy（计量计费策略）
  - [ ] ProductModeStrategy（商品消费策略）
  - [ ] OrderModeStrategy（订餐消费策略）
  - [ ] IntelligenceModeStrategy（智能消费策略）
- [ ] 1.4 重构`ConsumptionModeEngineManager`
  - [ ] 使用策略模式管理不同消费模式
  - [ ] 实现策略自动注册和选择机制
  - [ ] 添加异常处理和日志记录

### 2. 区域管理核心字段支持
- [ ] 2.1 确认区域管理服务位置和公共AreaEntity
- [ ] 2.2 添加5个核心字段支持
  - [ ] manage_mode（经营模式：1-餐别制 2-超市制 3-混合模式）
  - [ ] area_sub_type（区域细分类型）
  - [ ] fixed_value_config（定值配置JSON）
  - [ ] meal_categories（可用餐别分类JSON数组）
  - [ ] inventory_flag（是否启用进销存）
- [ ] 2.3 创建`AreaManager`（使用公共模块）
  - [ ] 实现通过GatewayServiceClient调用区域服务
  - [ ] 实现多级缓存策略（L1本地+L2网关）
  - [ ] 实现区域消费配置解析（从extendedAttributes）
- [ ] 2.4 创建`AreaConsumeConfigDTO`
  - [ ] 定义区域消费配置数据结构
  - [ ] 实现JSON解析和映射

## Phase 2: 核心业务功能（2-3周）

### 3. 7步标准消费流程实现
- [ ] 3.1 创建`ConsumeManager`
  - [ ] 实现7步标准消费流程编排
  - [ ] 添加异常处理和回滚机制
- [ ] 3.2 实现身份识别服务`IdentityService`
  - [ ] 支持刷卡/刷脸/扫码三种识别方式
  - [ ] 集成CardReaderService、FaceRecognitionService、QRCodeService
- [ ] 3.3 实现权限验证服务`PermissionValidator`
  - [ ] 区域权限验证
  - [ ] 餐别权限验证
  - [ ] 时间窗口验证
- [ ] 3.4 实现场景识别服务`SceneRecognizer`
  - [ ] 基于manage_mode判断消费方式
  - [ ] 支持餐别制/超市制/混合模式场景
- [ ] 3.5 实现金额计算器`AmountCalculator`
  - [ ] 支持多种消费模式金额计算
  - [ ] 集成定值计算逻辑
- [ ] 3.6 实现余额扣除服务`BalanceDeductionService`
  - [ ] 补贴优先→现金扣除顺序
  - [ ] SAGA分布式事务支持
- [ ] 3.7 实现交易记录器`TransactionRecorder`
  - [ ] 完整的业务字段记录
  - [ ] 交易流水号生成
- [ ] 3.8 实现小票打印器`ReceiptPrinter`
  - [ ] 支持多种小票格式
  - [ ] 设备驱动集成

### 4. 定值金额计算逻辑实现
- [ ] 4.1 创建`FixedAmountCalculator`
  - [ ] 实现三级优先级：账户类别→区域→系统默认
  - [ ] 支持SIMPLE/KEYVALUE/SECTION三种定值类型
- [ ] 4.2 实现账户类别定值逻辑
  - [ ] 解析AccountKindEntity.mode_config JSON
  - [ ] 支持时间段和餐别配置
- [ ] 4.3 实现区域定值逻辑
  - [ ] 解析AreaEntity.fixed_value_config JSON
  - [ ] 支持全局和局部配置
- [ ] 4.4 实现系统默认定值
  - [ ] 系统级配置管理
  - [ ] 兜底方案保障

### 5. 商品管理模块完善
- [ ] 5.1 创建商品实体和相关Dao
- [ ] 5.2 实现商品查询和管理接口
- [ ] 5.3 集成进销存管理（可选）
- [ ] 5.4 实现商品条码扫描功能

## Phase 3: 扩展功能（3-4周）

### 6. 离线消费模块实现
- [ ] 6.1 创建离线消费数据结构
- [ ] 6.2 实现离线数据缓存机制
- [ ] 6.3 实现数据同步逻辑
- [ ] 6.4 添加冲突解决策略

### 7. 订餐管理模块实现
- [ ] 7.1 创建订餐相关实体
- [ ] 7.2 实现订餐流程管理
- [ ] 7.3 实现取餐核销功能
- [ ] 7.4 集成支付和退款流程

### 8. 补贴管理模块实现
- [ ] 8.1 创建补贴策略引擎
- [ ] 8.2 实现多种补贴类型
- [ ] 8.3 实现补贴发放和使用统计
- [ ] 8.4 添加补贴报表功能

## Phase 4: 企业级高可用（1-2周）

### 9. 设备识别验证流程实现
- [ ] 9.1 创建`DeviceRecognitionResultDTO`和`DeviceConsumeRequestDTO`
- [ ] 9.2 实现`ConsumeVerificationService`
  - [ ] 9步完整验证流程
  - [ ] 设备状态验证
  - [ ] 账户状态验证
  - [ ] 权限验证
  - [ ] 场景识别
  - [ ] 金额计算
  - [ ] 余额检查
- [ ] 9.3 创建`DeviceConsumeController`
  - [ ] 设备消费验证API接口
  - [ ] 参数验证和异常处理

### 10. 分布式事务和高可用实现
- [ ] 10.1 实现`ConsumeSagaTransactionManager`
  - [ ] SAGA分布式事务管理
  - [ ] 补偿事务设计
  - [ ] 事务状态跟踪
- [ ] 10.2 实现`ConsumeDegradationManager`
  - [ ] 服务降级策略
  - [ ] 缓存降级机制
  - [ ] 默认行为定义
- [ ] 10.3 实现`ConsumeRetryManager`
  - [ ] 指数退避重试
  - [ ] 重试次数限制
  - [ ] 重试状态管理
- [ ] 10.4 实现`ConsumeMonitorManager`
  - [ ] 关键指标监控
  - [ ] 告警机制
  - [ ] 性能指标收集

## Phase 5: 权限和准确性（1周）

### 11. 权限验证完善
- [ ] 11.1 完善区域权限验证
- [ ] 11.2 完善餐别权限验证
- [ ] 11.3 实现时间窗口验证
- [ ] 11.4 添加权限缓存机制

### 12. 数据准确性保障
- [ ] 12.1 实现数据一致性检查
- [ ] 12.2 添加数据对账功能
- [ ] 12.3 实现异常数据修复
- [ ] 12.4 添加数据审计日志

## Phase 6: 接口和测试（1周）

### 13. 前后端移动端接口实现
- [ ] 13.1 实现前端管理接口
  - [ ] 消费模式列表查询
  - [ ] 消费模式详情查询
  - [ ] 消费记录管理
  - [ ] 报表统计接口
- [ ] 13.2 实现移动端接口
  - [ ] 快速消费接口
  - [ ] 账户余额查询
  - [ ] 消费历史查询
  - [ ] 个人设置接口
- [ ] 13.3 统一ResponseDTO格式
- [ ] 13.4 添加API文档（Knife4j）

### 14. 测试和质量保障
- [ ] 14.1 单元测试
  - [ ] Controller层测试（覆盖率≥80%）
  - [ ] Service层测试（覆盖率≥85%）
  - [ ] Manager层测试（覆盖率≥80%）
  - [ ] Repository层测试（覆盖率≥75%）
- [ ] 14.2 集成测试
  - [ ] 完整消费流程测试
  - [ ] 设备验证流程测试
  - [ ] 分布式事务测试
- [ ] 14.3 性能测试
  - [ ] 高并发消费测试
  - [ ] 缓存性能测试
  - [ ] 数据库性能测试
- [ ] 14.4 代码质量检查
  - [ ] SonarQube代码质量扫描
  - [ ] 架构合规性检查
  - [ ] 编码规范检查

## Phase 7: 部署和文档（1周）

### 15. 部署准备
- [ ] 15.1 数据库迁移脚本
- [ ] 15.2 配置文件更新
- [ ] 15.3 部署文档编写
- [ ] 15.4 回滚方案制定

### 16. 文档和培训
- [ ] 16.1 API接口文档完善
- [ ] 16.2 使用手册编写
- [ ] 16.3 运维手册编写
- [ ] 16.4 开发人员培训材料

## 总体验收标准

### 功能验收
- [ ] 6种消费模式全部正常工作
- [ ] 7步消费流程完整实现
- [ ] 设备识别验证流程稳定可用
- [ ] 前后端移动端接口完全可用

### 质量验收
- [ ] 单元测试覆盖率≥80%
- [ ] 集成测试全部通过
- [ ] 性能测试达到要求（1000TPS）
- [ ] 代码质量扫描通过

### 可用性验收
- [ ] 系统可用性≥99.9%
- [ ] 响应时间≤500ms（95%请求）
- [ ] 错误率≤0.1%
- [ ] 监控告警机制完善

**总预计工作量**: 60-90人天（约3-4个月，2-3人团队）