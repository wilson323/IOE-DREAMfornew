# Refactor for SRP and Global Consistency 实施计划

## 概述

本文档定义 `refactor-srp-and-global-consistency` 提案的详细实施计划，分阶段推进代码质量和架构一致性的长期演进。

## 实施阶段

### 阶段 1：SRP 重构（代码质量提升）

#### 1.1 超大类拆解

**目标**：按"编排层（Service/Manager）+ 适配层（Adapter/Strategy/Client）+ 领域组件（Domain）"拆解超大类

**关键类**：
- `PaymentService`（1k–4k+ 行）
- `DeviceSyncService`（超大类）
- `AlertManager`（超大类）
- `UnifiedAuthenticationManager`（超大类）

**任务**：
- [ ] 1.1.1 分析 PaymentService 的职责边界
- [ ] 1.1.2 拆解为 PaymentOrchestrationService + PaymentAdapter + PaymentDomain
- [ ] 1.1.3 逐步拆解其他超大类
- [ ] 1.1.4 更新单元测试和集成测试

**产物**：
- 拆解后的服务类
- 适配层和领域组件
- 更新的测试用例

**验证**：
- 每个类的行数 < 500 行
- 职责清晰，遵循单一职责原则
- 测试覆盖率 ≥ 70%
- PMD/Sonar 质量指标改善

#### 1.2 包结构重整

**目标**：按有界上下文重整包结构

**任务**：
- [ ] 1.2.1 定义有界上下文（支付、设备、告警、认证等）
- [ ] 1.2.2 重整包结构以反映有界上下文
- [ ] 1.2.3 更新导入和依赖关系
- [ ] 1.2.4 验证包结构的一致性

**产物**：
- 新的包结构
- 包结构文档

**验证**：
- 包结构清晰，反映业务域
- 无循环依赖
- 编译通过

### 阶段 2：公共库边界收敛

#### 2.1 microservices-common 拆分规划

**目标**：按有界上下文拆分 microservices-common

**任务**：
- [ ] 2.1.1 分析 microservices-common 中的各个模块
- [ ] 2.1.2 规划拆分为多个 JAR 子模块
- [ ] 2.1.3 定义模块间的依赖关系
- [ ] 2.1.4 制定分阶段迁移计划

**产物**：
- 拆分规划文档
- 模块依赖关系图

**验证**：
- 拆分方案清晰
- 无循环依赖
- 各模块职责明确

#### 2.2 公共库逐步拆分

**目标**：逐步拆分 microservices-common 为多 JAR 子模块

**任务**：
- [ ] 2.2.1 创建 common-core 子模块（基础能力）
- [ ] 2.2.2 创建 common-auth 子模块（认证授权）
- [ ] 2.2.3 创建 common-tracing 子模块（链路追踪）
- [ ] 2.2.4 创建 common-gateway 子模块（网关客户端）
- [ ] 2.2.5 逐步迁移代码到各子模块
- [ ] 2.2.6 更新各服务的依赖

**产物**：
- 拆分后的子模块
- 更新的 pom.xml 依赖

**验证**：
- 子模块编译通过
- 各服务依赖正确
- 测试通过

### 阶段 3：依赖治理

#### 3.1 版本统一管理

**目标**：消除子模块版本覆盖，实现单一真相源

**任务**：
- [ ] 3.1.1 扫描所有子模块的版本覆盖
- [ ] 3.1.2 在父 POM 中统一定义版本
- [ ] 3.1.3 删除子模块中的版本覆盖
- [ ] 3.1.4 验证版本一致性

**产物**：
- 更新的父 POM
- 版本一致性报告

**验证**：
- 无版本覆盖
- 所有依赖版本一致
- 编译通过

#### 3.2 Gateway 依赖瘦身

**目标**：Gateway 依赖瘦身为纯反应式网关定位

**任务**：
- [ ] 3.2.1 分析 Gateway 的所有依赖
- [ ] 3.2.2 移除非反应式依赖（如阻塞型 DB）
- [ ] 3.2.3 优化依赖配置
- [ ] 3.2.4 验证 Gateway 的反应式特性

**产物**：
- 更新的 Gateway pom.xml
- 依赖分析报告

**验证**：
- 无阻塞型依赖
- Gateway 启动时间改善
- 性能指标改善

### 阶段 4：构建单一真相源

#### 4.1 Maven 为唯一构建入口

**目标**：明确 Maven 为唯一构建入口，冻结或移除 Gradle 配置

**任务**：
- [ ] 4.1.1 分析当前 Gradle 配置的用途
- [ ] 4.1.2 将 Gradle 配置迁移到 Maven
- [ ] 4.1.3 删除或冻结 build.gradle
- [ ] 4.1.4 更新构建文档

**产物**：
- 更新的 pom.xml
- 构建文档

**验证**：
- 仅使用 Maven 构建
- 构建结果一致
- CI/CD 流程正常

#### 4.2 依赖版本校验

**目标**：在父 POM 引入强制版本和依赖校验

**任务**：
- [ ] 4.2.1 配置 Maven Enforcer Plugin
- [ ] 4.2.2 定义版本规则和依赖规则
- [ ] 4.2.3 验证规则生效
- [ ] 4.2.4 更新 CI/CD 流程

**产物**：
- 更新的父 POM
- 校验规则文档

**验证**：
- 版本校验生效
- 依赖校验生效
- 违规时构建失败

### 阶段 5：内部调用混合治理

#### 5.1 直连白名单管理

**目标**：建立服务间直连白名单，支持热路径直连

**任务**：
- [ ] 5.1.1 定义直连白名单规范
- [ ] 5.1.2 建立直连白名单审计机制
- [ ] 5.1.3 创建 DirectServiceClient 配置
- [ ] 5.1.4 更新服务间调用规范

**产物**：
- 直连白名单规范文档
- DirectServiceClient 配置

**验证**：
- 白名单清晰
- 审计机制完善
- 规范文档完整

#### 5.2 直连客户端增强

**目标**：为 DirectServiceClient 添加超时、重试、熔断、限流、观测

**任务**：
- [ ] 5.2.1 集成 Resilience4j 库
- [ ] 5.2.2 实现超时和重试机制
- [ ] 5.2.3 实现熔断和限流机制
- [ ] 5.2.4 集成链路追踪和监控
- [ ] 5.2.5 编写测试用例

**产物**：
- 增强的 DirectServiceClient
- 测试用例

**验证**：
- 超时和重试生效
- 熔断和限流生效
- 链路追踪完整
- 测试覆盖率 ≥ 70%

#### 5.3 服务间鉴权

**目标**：实现服务到服务的鉴权

**任务**：
- [ ] 5.3.1 定义服务间鉴权规范
- [ ] 5.3.2 实现服务间令牌生成和验证
- [ ] 5.3.3 更新 DirectServiceClient 以支持服务间鉴权
- [ ] 5.3.4 编写测试用例

**产物**：
- 服务间鉴权规范文档
- 鉴权实现代码

**验证**：
- 服务间鉴权生效
- 未授权请求被拒绝
- 测试通过

### 阶段 6：规范与文档更新

#### 6.1 更新 .cursorrules 和 CLAUDE.md

**目标**：同步更新规范以保持治理一致性

**任务**：
- [ ] 6.1.1 更新 .cursorrules 中的 SRP 要求
- [ ] 6.1.2 更新 CLAUDE.md 中的包结构规范
- [ ] 6.1.3 更新服务间调用规范
- [ ] 6.1.4 更新依赖治理规范

**产物**：
- 更新的 .cursorrules
- 更新的 CLAUDE.md

**验证**：
- 规范文档完整
- 规范与代码一致

## 实施时间表

| 阶段 | 任务 | 预计周期 | 状态 |
|------|------|---------|------|
| 1 | SRP 重构 | 4-6 周 | 待开始 |
| 2 | 公共库拆分 | 3-4 周 | 待开始 |
| 3 | 依赖治理 | 2-3 周 | 待开始 |
| 4 | 构建单一真相源 | 1-2 周 | 待开始 |
| 5 | 内部调用混合治理 | 3-4 周 | 待开始 |
| 6 | 规范更新 | 1 周 | 待开始 |

## 风险与缓解

| 风险 | 缓解方案 |
|------|---------|
| SRP 重构导致编译错误 | 分批重构，充分测试，保持兼容 |
| 公共库拆分导致循环依赖 | 严格遵循依赖方向，使用接口隔离 |
| 直连调用增加复杂性 | 建立白名单审计，明确规范 |
| 版本冲突 | 统一管理版本，定期检查 |

## 验证与质量门禁

- [ ] 所有类的行数 < 500 行
- [ ] 测试覆盖率 ≥ 70%
- [ ] PMD/Sonar 质量指标达到目标
- [ ] `mvn -pl microservices -am test` 通过
- [ ] `mvn -pl microservices -am verify` 通过
- [ ] 无循环依赖
- [ ] 版本一致
- [ ] 规范文档完整

## 相关文档

- [代码规范](../../documentation/technical/UNIFIED_DEVELOPMENT_STANDARDS.md)
- [架构设计](../../documentation/architecture/)
- [API 契约基线](../../documentation/api/API-CONTRACT-BASELINE.md)
