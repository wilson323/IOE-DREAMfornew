# Design Document: 七微服务架构重构技术设计

## Context
IOE-DREAM项目当前存在13个分散微服务，用户要求严格重构为7微服务架构。这是一个重大的架构调整，涉及服务整合、数据库重构、API重新设计等多个方面。需要确保企业级质量，同时严格遵循"绝不超限"的约束。

## Goals / Non-Goals
- **Goals**:
  - 整合13个微服务到7个核心微服务
  - 建立统一的技术架构和标准
  - 实现企业级高可用性和可扩展性
  - 确保100%功能无遗漏整合
  - 建立完整的监控运维体系

- **Non-Goals**:
  - 不重新实现已有业务逻辑
  - 不改变核心业务功能需求
  - 不降低现有服务质量
  - 不影响现有业务数据

## Architecture Design

### 1. 七微服务架构定义

```
┌─────────────────────────────────────────────────────────────┐
│                     API Gateway (8080)                      │
├─────────────────────────────────────────────────────────────┤
│                   七微服务核心架构                            │
├───────────┬───────────┬───────────┬───────────┬─────────────┤
│ 公共模块   │ 设备通讯   │   OA微服务 │ 考勤微服务 │ 门禁微服务   │
│  8088     │  8087     │  8089     │  8091     │  8090       │
├───────────┼───────────┼───────────┼───────────┼─────────────┤
│ 消费微服务 │ 访客微服务 │ 视频微服务 │                                    │
│  8094     │  8095     │  8092     │                                    │
└───────────┴───────────┴───────────┴───────────┴─────────────┘
```

### 2. 服务整合映射

#### 2.1 公共模块微服务 (ioedream-common-service:8088)
**整合来源**: auth-service + identity-service + notification-service + audit-service + monitor-service + scheduler-service + system-service

**核心功能**:
- 统一认证授权 (Sa-Token)
- 用户身份管理 (RBAC)
- 通知服务 (邮件/短信/系统通知)
- 审计日志 (操作记录)
- 系统监控 (性能/指标)
- 任务调度 (定时任务)
- 系统配置 (参数管理)

#### 2.2 设备通讯微服务 (ioedream-device-comm-service:8087)
**整合来源**: device-service (转型)

**核心功能**:
- 设备连接管理 (TCP/UDP/HTTP/MQTT)
- 协议适配器 (海康威视/大华/ZKTeco)
- 设备状态监控
- 设备数据采集
- 设备指令下发
- 生物特征模板下发

#### 2.3 OA微服务 (ioedream-oa-service:8089)
**整合来源**: enterprise-service + infrastructure-service

**核心功能**:
- 文档管理 (创建/审批/版本)
- 工作流引擎 (流程设计/执行)
- 企业信息管理 (组织架构)
- 知识库管理
- 会议管理
- 系统基础功能

#### 2.4 业务微服务保持 (5个)
- **考勤微服务** (8091): 考勤记录/规则/统计
- **门禁微服务** (8090): 门禁控制/权限/记录
- **消费微服务** (8094): 消费交易/账户/报表
- **访客微服务** (8095): 访客预约/登记/权限
- **视频微服务** (8092): 视频监控/录像/回放

### 3. 数据库架构设计

#### 3.1 数据库整合原则
- **按业务域拆分**: 7个微服务对应7个独立数据库
- **公共数据集中**: 用户、权限、配置等公共数据集中在公共模块数据库
- **设备数据独立**: 设备基础信息在设备通讯微服务，业务设备数据在业务微服务
- **事务边界清晰**: 跨服务数据通过SAGA事务保证一致性

#### 3.2 数据库分配
```
ioedream_common_db     - 公共模块微服务 (用户/权限/配置/日志)
ioedream_device_comm_db- 设备通讯微服务 (设备连接/协议/状态)
ioedream_oa_db         - OA微服务 (文档/工作流/企业信息)
ioedream_attendance_db - 考勤微服务 (考勤记录/规则/统计)
ioedream_access_db     - 门禁微服务 (门禁控制/权限/记录)
ioedream_consume_db    - 消费微服务 (消费交易/账户/报表)
ioedream_visitor_db    - 访客微服务 (访客信息/预约/权限)
ioedream_video_db      - 视频微服务 (视频设备/录像/告警)
```

### 4. 技术架构统一

#### 4.1 技术栈标准
```yaml
Framework:
  Java: 17 (LTS)
  Spring Boot: 3.5.4
  Spring Cloud: 2023.0.0
  Jakarta EE: 9+ (100%合规)

Architecture:
  Pattern: 四层架构 (Controller → Service → Manager → DAO)
  DI: @Resource (100%统一)
  ORM: MyBatis-Plus 3.5.7
  Database: MySQL 8.0.33
  Cache: Redis 6.0+ (db=0)
  Connection Pool: Druid 1.2.21

Enterprise Features:
  Auth: Sa-Token 1.37.0
  Service Discovery: Nacos 2.x
  Configuration: Nacos Config
  Message Queue: Kafka 3.x
  Distributed Transaction: SAGA
  Monitoring: Prometheus + Grafana
  Container: Docker + Kubernetes
```

#### 4.2 企业级特性实现
- **SAGA分布式事务**: 跨服务数据一致性保障
- **降级熔断**: Hystrix/Sentinel服务容错
- **多级缓存**: L1本地 + L2 Redis + L3网关缓存
- **监控告警**: Micrometer + Prometheus + Grafana
- **链路追踪**: Spring Cloud Sleuth
- **API网关**: Spring Cloud Gateway + 负载均衡
- **容器化部署**: Docker + Kubernetes

## Decisions

### Decision 1: 服务整合策略
- **What**: 将13个微服务整合为7个核心微服务
- **Why**: 降低运维复杂度，减少服务间调用，提高系统稳定性
- **How**: 按业务域进行服务整合，公共功能集中化，业务功能专业化

### Decision 2: 数据库架构设计
- **What**: 7个微服务对应7个独立数据库
- **Why**: 保证服务数据独立性，避免跨服务数据库访问
- **How**: 按业务域拆分数据库，公共数据集中管理

### Decision 3: 技术栈统一
- **What**: 统一使用Spring Boot 3.x + Jakarta EE
- **Why**: 避免技术栈碎片化，降低维护成本
- **How**: 所有微服务统一技术栈，建立标准化脚手架

### Decision 4: 企业级特性
- **What**: 实现完整的企业级微服务特性
- **Why**: 确保系统高可用、高性能、可扩展
- **How**: 集成SAGA事务、监控告警、降级熔断等企业级组件

## Risks / Trade-offs

### Risk 1: 服务整合复杂度
- **Risk**: 整合13个服务到7个服务涉及大量代码迁移和重构
- **Mitigation**: 分阶段实施，先整合公共模块，再重构业务服务

### Risk 2: 数据迁移风险
- **Risk**: 数据库重新设计可能导致数据丢失或迁移失败
- **Mitigation**: 制定详细的数据迁移方案，分批迁移，完整备份

### Risk 3: 业务中断风险
- **Risk**: 大规模架构调整可能影响现有业务
- **Mitigation**: 采用蓝绿部署策略，确保业务不中断

### Trade-off 1: 复杂度 vs 可维护性
- **Trade-off**: 服务数量减少降低了运维复杂度，但单个服务复杂度增加
- **Balance**: 通过良好的模块化设计保证单个服务内聚性

### Trade-off 2: 性能 vs 一致性
- **Trade-off**: 分布式事务保证一致性但可能影响性能
- **Balance**: 优化SAGA事务实现，使用异步处理提高性能

## Migration Plan

### Phase 1: 基础设施准备 (2周)
1. **环境搭建**: 搭建7微服务的基础环境
2. **数据库设计**: 创建7个新数据库和表结构
3. **配置中心**: 配置Nacos服务注册和配置管理
4. **CI/CD流水线**: 建立自动化部署流水线

### Phase 2: 公共模块整合 (3周)
1. **ioedream-common-service建设**: 整合7个公共服务
2. **统一认证授权**: 实现Sa-Token统一认证
3. **用户权限管理**: 整合RBAC权限体系
4. **通知监控服务**: 实现通知和监控功能

### Phase 3: 设备通讯重构 (2周)
1. **ioedream-device-comm-service重构**: 专注设备通讯功能
2. **协议适配器**: 统一设备协议适配
3. **设备连接管理**: 实现设备连接和状态监控
4. **数据采集下发**: 实现设备数据采集和指令下发

### Phase 4: OA服务新建 (3周)
1. **ioedream-oa-service新建**: 整合企业和基础设施服务
2. **文档管理系统**: 实现文档生命周期管理
3. **工作流引擎**: 实现流程设计和执行
4. **企业信息管理**: 实现组织架构和信息管理

### Phase 5: 业务服务适配 (2周)
1. **现有业务服务调整**: 适配7微服务架构
2. **API接口重构**: 重新设计API路径和规范
3. **服务间调用调整**: 适配新的服务架构
4. **功能验证**: 确保所有功能正常工作

### Phase 6: 数据迁移 (2周)
1. **数据备份**: 完整备份现有数据
2. **数据迁移**: 将13个数据库数据迁移到7个数据库
3. **数据验证**: 验证数据迁移的完整性和准确性
4. **性能测试**: 测试新架构下的系统性能

### Phase 7: 切换上线 (1周)
1. **灰度发布**: 逐步切换到新架构
2. **监控验证**: 全面监控系统运行状态
3. **问题修复**: 快速修复发现的问题
4. **正式上线**: 完全切换到新架构

## Open Questions

### Question 1: 服务拆分粒度
- **Question**: 7微服务的拆分粒度是否合适，是否需要进一步细化？
- **Consideration**: 需要平衡服务数量和单服务复杂度

### Question 2: 数据一致性策略
- **Question**: SAGA事务的实现复杂度如何，是否有更简单的方案？
- **Consideration**: 可以考虑最终一致性方案

### Question 3: 性能影响评估
- **Question**: 服务整合后对系统性能的影响有多大？
- **Consideration**: 需要进行详细的性能测试和评估

### Question 4: 团队技能匹配
- **Question**: 团队是否具备实施这种大规模架构调整的技能？
- **Consideration**: 可能需要外部技术支持和培训

## Validation Criteria

### Functional Validation
- [ ] 所有13个服务功能完整整合到7个服务
- [ ] 所有业务流程在新架构下正常工作
- [ ] 所有API接口功能正常
- [ ] 所有数据库操作正确

### Performance Validation
- [ ] 系统响应时间不超过现有架构
- [ ] 系统吞吐量不低于现有架构
- [ ] 系统资源使用合理
- [ ] 压力测试通过

### Architecture Validation
- [ ] 四层架构严格执行
- [ ] 服务边界清晰合理
- [ ] 企业级特性正常工作
- [ ] 监控告警体系完善

### Quality Validation
- [ ] 代码质量符合规范
- [ ] 测试覆盖率≥80%
- [ ] 安全性测试通过
- [ ] 文档完整准确