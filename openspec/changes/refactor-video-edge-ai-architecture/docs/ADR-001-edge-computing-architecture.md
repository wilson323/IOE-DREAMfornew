# ADR 001: 边缘计算架构决策 - 设备端AI分析

**状态**: 已批准 (Approved)
**日期**: 2025-01-30
**决策者**: IOE-DREAM 架构委员会
**相关提案**: [refactor-video-edge-ai-architecture](../proposal.md)

---

## 1. 状态（Status）

**已批准 (Approved)** - 2025-01-30

此架构决策已由架构委员会审批通过，并开始实施。

---

## 2. 上下文（Context）

### 2.1 问题描述

IOE-DREAM 视频服务在之前的架构中存在严重的设计缺陷：

- ❌ **服务器端AI分析**：设备将原始视频帧发送到服务器进行AI分析
- ❌ **带宽消耗巨大**：每路视频流占用 2-8 Mbps 带宽
- ❌ **服务器负载过高**：AI模型推理占用大量CPU/GPU资源
- ❌ **告警延迟高**：分析延迟 3-5 秒，影响实时性
- ❌ **扩展性差**：增加设备需要线性增加服务器资源

**代码证据**：

```java
// ❌ 错误架构：服务器端接收原始视频帧进行AI分析
public FallDetectionResult detectFall(String cameraId, byte[] frameData) {
    // 服务器端运行AI模型分析视频帧
    // 违反边缘计算原则
}
```

### 2.2 驱动因素

1. **性能要求**：告警响应时间需要 < 1 秒
2. **成本控制**：服务器带宽和计算成本过高
3. **可扩展性**：支持 1000+ 设备同时接入
4. **隐私保护**：原始视频不上传服务器，符合隐私法规

### 2.3 考虑的方案

#### 方案 A：服务器端AI分析（当前方案）
- ✅ 实现简单
- ✅ 模型集中管理
- ❌ 带宽消耗大
- ❌ 服务器负载高
- ❌ 扩展性差

#### 方案 B：设备端AI分析（推荐方案）
- ✅ 带宽节省 95%
- ✅ 服务器负载降低 70%
- ✅ 告警延迟降低 70% (< 1秒)
- ✅ 支持大规模扩展
- ⚠️ 需要设备支持AI芯片

#### 方案 C：混合模式
- ✅ 灵活性高
- ✅ 可根据设备能力选择
- ❌ 架构复杂度高
- ❌ 维护成本高

---

## 3. 决策（Decision）

**选择方案 B：设备端AI分析 + 服务器端事件管理**

### 3.1 核心架构原则

```
【边缘计算架构】设备端识别，服务器端管理

设备端 AI 分析：
├─ 视频采集
├─ AI 模型推理（人脸检测、行为分析）
├─ 结构化事件生成（eventType, confidence, bbox, snapshot）
└─ 上报结构化事件

服务器端事件管理：
├─ 接收设备AI事件
├─ 告警规则匹配
├─ 告警记录创建
├─ 实时事件推送
└─ 数据统计分析
```

### 3.2 技术架构

#### 设备端职责

```java
// ✅ 正确架构：设备端完成AI分析，上报结构化事件
{
  "deviceId": "CAM001",
  "deviceCode": "camera_001",
  "eventType": "FALL_DETECTION",
  "confidence": 0.95,
  "bbox": "{\"x\":100,\"y\":150,\"width\":200,\"height\":300}",
  "snapshot": "base64_encoded_image",
  "eventTime": "2025-01-30T10:30:00"
}
```

#### 服务器端职责

```java
// ✅ 服务器端接收结构化事件，不进行AI分析
@Component
public class DeviceAIEventManager {
    public DeviceAIEventEntity receiveDeviceAIEvent(DeviceAIEventForm form) {
        // 1. 存储事件
        // 2. 触发告警规则匹配
        // 3. 推送实时事件
    }
}
```

### 3.3 数据流

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  AI摄像头   │         │  视频服务   │         │  前端应用   │
│  (边缘端)   │         │  (服务器)   │         │  (客户端)   │
└──────┬──────┘         └──────┬──────┘         └──────┬──────┘
       │                       │                       │
       │ 1. 视频采集          │                       │
       ├──────────────────────>│                       │
       │ (原始视频流)          │                       │
       │                       │                       │
       │ 2. AI分析            │                       │
       │ (人脸/行为识别)       │                       │
       │                       │                       │
       │ 3. 上报事件          │                       │
       ├──────────────────────>│                       │
       │ (结构化事件)          │                       │
       │                       │                       │
       │                       │ 4. 规则匹配          │
       │                       ├──────────────────────>│
       │                       │ (告警推送)            │
       │                       │                       │
       │                       │ 5. 回调视频          │
       │<──────────────────────┤ (仅告警时)            │
       │                       │                       │
```

---

## 4. 后果（Consequences）

### 4.1 积极影响

| 指标 | 改进前 | 改进后 | 提升幅度 |
|------|-------|--------|----------|
| **带宽消耗** | 2-8 Mbps/路 | 50-100 Kbps/路 | **降低 95%** |
| **服务器负载** | 100% | 30% | **降低 70%** |
| **告警延迟** | 3-5 秒 | < 1 秒 | **降低 70%** |
| **并发设备数** | ~100 路 | 1000+ 路 | **提升 10 倍** |
| **隐私保护** | 原始视频上传 | 仅事件+快照 | **符合法规** |

### 4.2 消极影响

1. **设备要求提高**：
   - 设备必须支持 AI 芯片
   - 需要定期更新 AI 模型
   - 设备成本增加 10-20%

2. **开发复杂度增加**：
   - 需要管理设备端 AI 模型版本
   - 需要实现模型远程更新机制
   - 需要处理离线降级场景

3. **运维成本增加**：
   - 需要监控设备端 AI 性能
   - 需要管理模型版本发布
   - 需要定期维护设备端算法

### 4.3 风险和缓解措施

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 设备不支持AI | 高 | 中 | 逐步替换设备，支持降级模式 |
| 模型更新失败 | 中 | 低 | 版本管理机制，回滚支持 |
| 误报率上升 | 中 | 中 | 置信度阈值优化，规则引擎 |
| 离线事件丢失 | 低 | 中 | 设备端缓存，网络恢复补录 |

---

## 5. 实施计划

### 5.1 阶段划分

**P0 阶段**（1周）：核心架构修复
- ✅ 删除服务器端 AI 分析代码
- ✅ 创建设备事件接收服务
- ✅ 创建告警规则引擎
- ✅ 数据库表设计

**P1 阶段**（4周）：功能完善
- ⏳ AI 模型管理模块
- ⏳ 实时事件推送（WebSocket）
- ⏳ 前端事件展示页面
- ⏳ 单元测试和集成测试

**P2 阶段**（持续优化）：
- 模型版本管理
- 设备性能监控
- 离线降级支持
- 告警效果分析

### 5.2 兼容性策略

**向后兼容**：
- 保留现有 API 接口（标记为 @Deprecated）
- 支持旧设备逐步迁移
- 提供适配器模式

**设备适配**：
```
智能设备（支持AI） → 边缘计算架构
传统设备（不支持AI） → 保留服务器端分析（标记为Legacy）
```

---

## 6. 相关决策

### 6.1 相关 ADR

- [ADR-002] AI模型版本管理策略（待创建）
- [ADR-003] 设备离线降级方案（待创建）

### 6.2 相关文档

- [OpenSpec 提案](../proposal.md)
- [架构设计文档](../design.md)
- [实施任务列表](../tasks.md)
- [CLAUDE.md - Mode 5: 边缘AI计算](../../../CLAUDE.md)

### 6.3 参考资料

- [边缘计算最佳实践](https://aws.amazon.com/edge-computing/)
- [AI模型部署策略](https://cloud.google.com/edge-architecture)
- [视频监控架构设计](https://www.vidéo-surveillance.com/)

---

## 7. 审批记录

| 角色 | 姓名 | 日期 | 状态 |
|------|------|------|------|
| 首席架构师 | - | 2025-01-30 | ✅ 批准 |
| 技术负责人 | - | 2025-01-30 | ✅ 批准 |
| 产品负责人 | - | 2025-01-30 | ✅ 批准 |

---

## 8. 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 1.0.0 | 2025-01-30 | 初始版本，架构决策记录 | IOE-DREAM 架构委员会 |

---

**签名**: IOE-DREAM 架构委员会
**批准日期**: 2025-01-30
**下次审查**: 2025-02-28（实施1个月后）
