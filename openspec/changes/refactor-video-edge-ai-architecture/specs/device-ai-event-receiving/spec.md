# Spec Delta: è®¾å¤‡AIäº‹ä»¶æ¥æ”¶èƒ½åŠ›

**å˜æ›´ID**: refactor-video-edge-ai-architecture
**èƒ½åŠ›**: device-ai-event-receiving
**çŠ¶æ€**: ğŸŸ¡ ææ¡ˆé˜¶æ®µ
**åˆ›å»ºæ—¥æœŸ**: 2025-01-30

---

## ADDED Requirements

### REQ-DEVICE-AI-EVENT-001: æ¥æ”¶è®¾å¤‡ä¸ŠæŠ¥çš„AIäº‹ä»¶

**ä¼˜å…ˆçº§**: P0
**æè¿°**: æœåŠ¡å™¨å¿…é¡»èƒ½å¤Ÿæ¥æ”¶è¾¹ç¼˜è®¾å¤‡ä¸ŠæŠ¥çš„ç»“æ„åŒ–AIäº‹ä»¶æ•°æ®

**åœºæ™¯**:

#### Scenario: è®¾å¤‡ä¸ŠæŠ¥è·Œå€’æ£€æµ‹äº‹ä»¶
**Given** æ‘„åƒå¤´è®¾å¤‡ç«¯å®ŒæˆAIè·Œå€’åˆ†æ
**When** è®¾å¤‡é€šè¿‡APIä¸ŠæŠ¥ç»“æ„åŒ–äº‹ä»¶
```json
{
  "eventId": "evt_20250130_001",
  "deviceId": "camera_001",
  "eventType": "FALL_DETECTION",
  "confidence": 0.95,
  "bbox": {"x": 100, "y": 150, "width": 200, "height": 300},
  "snapshot": "base64_encoded_image",
  "timestamp": "2025-01-30T10:30:00Z"
}
```
**Then** æœåŠ¡å™¨æˆåŠŸæ¥æ”¶å¹¶å­˜å‚¨äº‹ä»¶
**And** äº‹ä»¶åŒ…å«å®Œæ•´çš„å…ƒæ•°æ®ï¼ˆeventType, confidence, bboxï¼‰
**And** äº‹ä»¶è¢«æ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€

#### Scenario: è®¾å¤‡ä¸ŠæŠ¥å¼‚å¸¸è¡Œä¸ºäº‹ä»¶
**Given** æ‘„åƒå¤´è®¾å¤‡ç«¯æ£€æµ‹åˆ°å¾˜å¾Šè¡Œä¸º
**When** è®¾å¤‡é€šè¿‡APIä¸ŠæŠ¥ç»“æ„åŒ–äº‹ä»¶
```json
{
  "eventId": "evt_20250130_002",
  "deviceId": "camera_002",
  "eventType": "LOITERING_DETECTION",
  "confidence": 0.87,
  "bbox": {"x": 50, "y": 100, "width": 150, "height": 200},
  "snapshot": "base64_encoded_image",
  "timestamp": "2025-01-30T10:35:00Z",
  "duration": 120
}
```
**Then** æœåŠ¡å™¨æˆåŠŸæ¥æ”¶å¹¶å­˜å‚¨äº‹ä»¶
**And** äº‹ä»¶åŒ…å«å¾˜å¾Šæ—¶é•¿ç­‰æ‰©å±•å­—æ®µ
**And** è§¦å‘å‘Šè­¦è§„åˆ™åŒ¹é…æµç¨‹

---

### REQ-DEVICE-AI-EVENT-002: å­˜å‚¨å’Œç´¢å¼•AIäº‹ä»¶

**ä¼˜å…ˆçº§**: P0
**æè¿°**: æ‰€æœ‰AIäº‹ä»¶å¿…é¡»æŒä¹…åŒ–å­˜å‚¨å¹¶æ”¯æŒå¿«é€Ÿæ£€ç´¢

**åœºæ™¯**:

#### Scenario: æŒä¹…åŒ–å­˜å‚¨AIäº‹ä»¶
**Given** æ¥æ”¶åˆ°è®¾å¤‡AIäº‹ä»¶
**When** äº‹ä»¶å†™å…¥æ•°æ®åº“
**Then** äº‹ä»¶å­˜å‚¨åˆ° `t_video_device_ai_event` è¡¨
**And** åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  - `event_id` (VARCHAR): äº‹ä»¶å”¯ä¸€ID
  - `device_id` (VARCHAR): è®¾å¤‡ID
  - `event_type` (VARCHAR): äº‹ä»¶ç±»å‹
  - `confidence` (DECIMAL): ç½®ä¿¡åº¦
  - `bbox` (JSON): è¾¹ç•Œæ¡†åæ ‡
  - `snapshot` (LONGBLOB): æŠ“æ‹å›¾ç‰‡
  - `event_time` (DATETIME): äº‹ä»¶æ—¶é—´
  - `create_time` (DATETIME): åˆ›å»ºæ—¶é—´
**And** å»ºç«‹ç´¢å¼•ï¼š
  - `idx_event_device_time`: (device_id, event_time)
  - `idx_event_type_time`: (event_type, event_time)

#### Scenario: æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢AIäº‹ä»¶
**Given** æ•°æ®åº“ä¸­æœ‰1000æ¡AIäº‹ä»¶
**When** æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„äº‹ä»¶
**Then** æŸ¥è¯¢å“åº”æ—¶é—´ < 100ms
**And** è¿”å›ç»“æœæŒ‰æ—¶é—´å€’åºæ’åˆ—
**And** åŒ…å«äº‹ä»¶è¯¦æƒ…å’ŒæŠ“æ‹å›¾ç‰‡

---

### REQ-DEVICE-AI-EVENT-003: å®æ—¶äº‹ä»¶æ¨é€

**ä¼˜å…ˆçº§**: P0
**æè¿°**: AIäº‹ä»¶å¿…é¡»å®æ—¶æ¨é€ç»™è®¢é˜…çš„å®¢æˆ·ç«¯

**åœºæ™¯**:

#### Scenario: WebSocketå®æ—¶æ¨é€AIäº‹ä»¶
**Given** Webå®¢æˆ·ç«¯è®¢é˜…AIäº‹ä»¶
**When** è®¾å¤‡ä¸ŠæŠ¥æ–°çš„AIäº‹ä»¶
**Then** æœåŠ¡å™¨åœ¨1ç§’å†…æ¨é€äº‹ä»¶åˆ°å®¢æˆ·ç«¯
**And** æ¨é€æ ¼å¼ï¼š
```json
{
  "type": "AI_EVENT",
  "data": {
    "eventId": "evt_20250130_001",
    "eventType": "FALL_DETECTION",
    "confidence": 0.95,
    "snapshotUrl": "/api/v1/video/events/evt_20250130_001/snapshot"
  },
  "timestamp": "2025-01-30T10:30:01Z"
}
```
**And** å®¢æˆ·ç«¯èƒ½æ­£å¸¸æ¥æ”¶å¹¶æ˜¾ç¤ºäº‹ä»¶

#### Scenario: ç§»åŠ¨ç«¯å®æ—¶å‘Šè­¦æ¨é€
**Given** ç§»åŠ¨ç«¯è®¢é˜…AIå‘Šè­¦
**When** è®¾å¤‡ä¸ŠæŠ¥è·Œå€’æ£€æµ‹äº‹ä»¶
**Then** ç§»åŠ¨ç«¯æ”¶åˆ°æ¨é€é€šçŸ¥
**And** é€šçŸ¥åŒ…å«ï¼š
  - å‘Šè­¦ç±»å‹ï¼š"æ£€æµ‹åˆ°äººå‘˜è·Œå€’"
  - ç½®ä¿¡åº¦ï¼š95%
  - æŠ“æ‹å›¾ç‰‡ç¼©ç•¥å›¾
  - å‘ç”Ÿæ—¶é—´ï¼š10:30
**And** ç”¨æˆ·ç‚¹å‡»é€šçŸ¥å¯æŸ¥çœ‹è¯¦æƒ…

---

### REQ-DEVICE-AI-EVENT-004: äº‹ä»¶æŸ¥è¯¢å’Œå¯¼å‡º

**ä¼˜å…ˆçº§**: P1
**æè¿°**: æä¾›å®Œæ•´çš„äº‹ä»¶æŸ¥è¯¢ã€ç»Ÿè®¡å’Œå¯¼å‡ºåŠŸèƒ½

**åœºæ™¯**:

#### Scenario: æŒ‰è®¾å¤‡æŸ¥è¯¢AIäº‹ä»¶
**Given** ç³»ç»Ÿä¸­æœ‰å¤šä¸ªæ‘„åƒå¤´
**When** ç®¡ç†å‘˜æŸ¥è¯¢æŒ‡å®šè®¾å¤‡çš„äº‹ä»¶
**Then** è¿”å›è¯¥è®¾å¤‡æ‰€æœ‰å†å²äº‹ä»¶
**And** æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
**And** æ”¯æŒæŒ‰äº‹ä»¶ç±»å‹è¿‡æ»¤
**And** åˆ†é¡µå±•ç¤ºï¼Œæ¯é¡µ20æ¡

#### Scenario: äº‹ä»¶ç»Ÿè®¡åˆ†æ
**Given** ç³»ç»Ÿä¸­æœ‰1000æ¡AIäº‹ä»¶
**When** ç®¡ç†å‘˜æŸ¥çœ‹äº‹ä»¶ç»Ÿè®¡
**Then** æ˜¾ç¤ºï¼š
  - å„ç±»å‹äº‹ä»¶æ•°é‡åˆ†å¸ƒ
  - å„è®¾å¤‡äº‹ä»¶æ•°é‡åˆ†å¸ƒ
  - äº‹ä»¶æ—¶é—´åˆ†å¸ƒçƒ­åŠ›å›¾
  - å¹³å‡ç½®ä¿¡åº¦ç»Ÿè®¡
**And** æ”¯æŒå¯¼å‡ºExcelæŠ¥è¡¨

---

## MODIFIED Requirements

### MODIFIED-REQ-VIDEO-001: è§†é¢‘æœåŠ¡æ¶æ„

**åŸéœ€æ±‚**: æœåŠ¡å™¨ç«¯æ¥æ”¶åŸå§‹è§†é¢‘å¸§è¿›è¡ŒAIåˆ†æ

**æ–°éœ€æ±‚**: æœåŠ¡å™¨ç«¯åªæ¥æ”¶è®¾å¤‡ä¸ŠæŠ¥çš„ç»“æ„åŒ–AIäº‹ä»¶

**åœºæ™¯**:

#### Scenario: è®¾å¤‡ç«¯AIåˆ†æï¼ŒæœåŠ¡å™¨ç«¯ç®¡ç†
**Given** æ‘„åƒå¤´è®¾å¤‡æ”¯æŒAIèŠ¯ç‰‡
**When** è§†é¢‘æµä¸­å‘ç”Ÿè·Œå€’äº‹ä»¶
**Then** è®¾å¤‡ç«¯å®ŒæˆAIåˆ†æ
**And** è®¾å¤‡ç«¯æå–æŠ“æ‹å›¾ç‰‡
**And** è®¾å¤‡ç«¯ä¸ŠæŠ¥ç»“æ„åŒ–äº‹ä»¶åˆ°æœåŠ¡å™¨
**And** æœåŠ¡å™¨ç«¯åªè´Ÿè´£ï¼š
  - æ¥æ”¶å’Œå­˜å‚¨äº‹ä»¶
  - è§„åˆ™åŒ¹é…å’Œå‘Šè­¦
  - äº‹ä»¶æŸ¥è¯¢å’Œç»Ÿè®¡
  - è§†é¢‘å›è°ƒï¼ˆæŒ‰éœ€ï¼‰

**æ¶æ„å˜æ›´**:
```yaml
å˜æ›´å‰:
  æ‘„åƒå¤´ â†’ RTSPæµ â†’ æœåŠ¡å™¨æ¥æ”¶ â†’ è§£ç  â†’ é€å¸§åˆ†æ â†’ AIæ¨ç† â†’ å‘Šè­¦

å˜æ›´å:
  æ‘„åƒå¤´ â†’ AIèŠ¯ç‰‡åˆ†æ â†’ æå–ç»“æ„åŒ–æ•°æ® â†’ ä¸ŠæŠ¥æœåŠ¡å™¨ â†’ è§„åˆ™åŒ¹é… â†’ å‘Šè­¦
                            â†“
                        è®¾å¤‡ç«¯å­˜å‚¨åŸå§‹è§†é¢‘ï¼ˆ7-30å¤©ï¼‰
```

---

## REMOVED Requirements

### REMOVED-REQ-VIDEO-AI-001: æœåŠ¡å™¨ç«¯AIæ¨ç†

**åŸéœ€æ±‚**: æœåŠ¡å™¨ç«¯é›†æˆAIæ¨¡å‹è¿›è¡Œè·Œå€’æ£€æµ‹ã€å¼‚å¸¸è¡Œä¸ºæ£€æµ‹

**ç§»é™¤åŸå› **: è¿èƒŒè¾¹ç¼˜è®¡ç®—æ¶æ„åŸåˆ™

**å½±å“èŒƒå›´**:
- åˆ é™¤ `BehaviorDetectionManager.detectFall(byte[] frameData)` æ–¹æ³•
- åˆ é™¤ `BehaviorDetectionManager.detectAbnormalBehaviors(byte[] frameData)` æ–¹æ³•
- åˆ é™¤æ‰€æœ‰æœåŠ¡å™¨ç«¯AIæ¨ç†ç›¸å…³ä»£ç 

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] èƒ½æˆåŠŸæ¥æ”¶è®¾å¤‡AIäº‹ä»¶
- [ ] äº‹ä»¶æ­£ç¡®å­˜å‚¨åˆ°æ•°æ®åº“
- [ ] äº‹ä»¶ç´¢å¼•å»ºç«‹å®Œæˆ
- [ ] WebSocketå®æ—¶æ¨é€æ­£å¸¸
- [ ] ç§»åŠ¨ç«¯æ¨é€é€šçŸ¥æ­£å¸¸
- [ ] äº‹ä»¶æŸ¥è¯¢åŠŸèƒ½å®Œæ•´
- [ ] äº‹ä»¶ç»Ÿè®¡å’Œå¯¼å‡ºåŠŸèƒ½æ­£å¸¸

### æ€§èƒ½éªŒæ”¶
- [ ] äº‹ä»¶æ¥æ”¶å“åº”æ—¶é—´ < 100ms
- [ ] äº‹ä»¶å­˜å‚¨å“åº”æ—¶é—´ < 50ms
- [ ] äº‹ä»¶æŸ¥è¯¢å“åº”æ—¶é—´ < 100ms
- [ ] å®æ—¶æ¨é€å»¶è¿Ÿ < 1s
- [ ] æ”¯æŒ500è·¯è§†é¢‘å¹¶å‘

### æ¶æ„éªŒæ”¶
- [ ] ä»£ç å®ç°ç¬¦åˆè¾¹ç¼˜è®¡ç®—æ¶æ„
- [ ] æ— æœåŠ¡å™¨ç«¯AIåˆ†æä»£ç 
- [ ] é€šè¿‡æ¶æ„å®¡æŸ¥å§”å‘˜ä¼šè¯„å®¡

---

**ğŸ“… åˆ›å»ºæ—¶é—´**: 2025-01-30
**ğŸ‘¤ è´Ÿè´£äºº**: è§†é¢‘æœåŠ¡å›¢é˜Ÿ
**ğŸ”— ç›¸å…³Spec**: ai-model-management, alarm-rule-engine
