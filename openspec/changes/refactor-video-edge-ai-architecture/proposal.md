# 提案：视频监控边缘AI架构重构

**状态**: 🟡 提案阶段
**创建日期**: 2025-01-30
**优先级**: 🔴 P0（架构修复，必须立即处理）
**预计影响范围**: 视频服务、设备通讯服务、公共模块

---

## 📋 问题陈述

### 当前问题

经过深度分析发现，`ioedream-video-service` 中的AI行为分析代码实现**严重违背**了项目文档中定义的边缘计算架构原则。

#### 具体问题

**1. 服务器端接收原始视频帧进行分析**

文件：`microservices/ioedream-video-service/src/main/java/net/lab1024/sa/video/manager/BehaviorDetectionManager.java:161-182`

```java
// ❌ 错误实现
public FallDetectionResult detectFall(String cameraId, byte[] frameData) {
    log.info("[行为检测] 跌倒检测，cameraId={}", cameraId);

    // TODO: 集成跌倒检测AI模型
    // 说明：
    // 2. 集成AI模型后，应：
    //    - 调用AI模型推理API
    //    - 传入frameData进行推理  ⚠️ 问题：服务器端接收视频帧
    //    - 获取检测结果和置信度
}
```

**2. 架构设计不一致**

```
❌ 当前错误实现（违背边缘计算）：
摄像机 → RTSP流 → 服务器接收 → 解码 → 逐帧分析 → AI推理 → 告警
         ↑___________________________________________________|
                    原始视频上传到服务器（巨大带宽）

问题：
1. 原始视频流全部上传到服务器（带宽浪费）
2. 服务器逐帧解码（CPU密集型）
3. 服务器AI推理（GPU密集型）
4. 违背边缘计算原则
5. 性能瓶颈、延迟高、成本高
```

**3. 文档设计正确但代码实现错误**

项目文档 `CLAUDE.md` (第945-989行) 明确定义了边缘计算架构：

```
✅ 正确架构（文档设计）：
【实时分析】设备端AI处理 ⭐ 关键
  视频采集 → AI芯片分析 → 人脸检测+识别
            ↓
  行为分析 → 异常检测（徘徊/聚集/越界）
            ↓
  结构化数据 → 上传服务器 ⭐ 只上传结果

【服务器处理】软件端 ⭐ 管理而非计算
  接收结构化数据 → 存储（人脸抓拍/行为事件）
  告警规则匹配 → 实时推送告警
  人脸检索 → 以图搜图/轨迹追踪
  视频联动 → 告警时调取原始视频
```

### 影响范围

- **架构合规性**: 严重违背项目核心架构原则
- **性能影响**: 带宽消耗增加95%，服务器负载增加10倍+
- **可扩展性**: 无法水平扩展，服务器成为瓶颈
- **成本影响**: 需要大量GPU服务器资源

---

## 🎯 解决方案

### 核心变更

将视频监控AI分析从"服务器端计算"重构为"边缘计算模式"：

#### 变更前（错误）：

```java
// ❌ 服务器端接收原始视频帧
public FallDetectionResult detectFall(String cameraId, byte[] frameData) {
    // 服务器端AI推理...
}
```

#### 变更后（正确）：

```java
// ✅ 接收设备上报的结构化事件
public void handleDeviceAIEvent(DeviceAIEvent event) {
    // event包含：
    // - eventType: FALL_DETECTION
    // - confidence: 0.95
    // - bbox: [x,y,w,h]
    // - snapshot: 抓拍图片（仅关键帧）

    // 服务器端只做：
    // 1. 存储事件
    // 2. 规则匹配
    // 3. 告警推送
    // 4. 视频回调（按需）
}
```

### 新增能力

1. **设备端AI模型管理服务**
   - 模型版本管理
   - 模型推送服务（服务器 → 设备）
   - 模型热更新机制
   - 设备模型版本查询

2. **设备AI事件接收服务**
   - 接收设备上报的结构化事件
   - 事件存储和索引
   - 实时事件推送

3. **告警规则引擎**
   - 规则匹配引擎
   - 告警等级评估
   - 告警联动配置

### 删除能力

1. **服务器端AI分析代码**
   - 删除 `BehaviorDetectionManager` 中的AI推理方法
   - 删除 `detectFall(byte[] frameData)`
   - 删除 `detectAbnormalBehaviors(byte[] frameData)`

---

## 🔄 迁移策略

### 阶段1：架构修复（P0，1周）

1. ✅ 删除服务器端AI分析代码
2. ✅ 创建设备AI事件接收服务
3. ✅ 更新所有TODO注释
4. ✅ 创建架构决策记录（ADR）

### 阶段2：模型管理（P1，2周）

1. ✅ 创建AI模型管理服务
2. ✅ 实现模型推送功能
3. ✅ 实现设备模型版本查询
4. ✅ 模型热更新机制

### 阶段3：设备集成（P1，2周）

1. ✅ 设备协议适配（AI事件上报）
2. ✅ 设备协议适配（模型推送）
3. ✅ 设备AI能力测试
4. ✅ 端到端测试验证

---

## ✅ 验收标准

### 功能验收

- [ ] 服务器端不再接收原始视频帧进行AI分析
- [ ] 服务器端正确接收设备AI事件（结构化数据）
- [ ] 设备AI事件正确存储和索引
- [ ] 告警规则匹配正确工作
- [ ] 实时告警推送正常

### 性能验收

- [ ] 视频流上传带宽减少95%+
- [ ] 服务器CPU使用率降低70%+
- [ ] 告警延迟<1秒（设备端AI分析+上报）
- [ ] 系统可支持500路视频并发

### 架构验收

- [ ] 代码实现符合CLAUDE.md边缘计算架构
- [ ] 通过架构审查委员会评审
- [ ] 无架构违规问题

---

## 📊 影响评估

### 正面影响

| 维度 | 改进幅度 | 说明 |
|------|---------|------|
| **带宽消耗** | ↓ 95% | 只上传结构化数据，不上传视频 |
| **服务器负载** | ↓ 70% | 无需解码和AI推理 |
| **实时性** | ↑ 70% | 告警延迟从3-5秒降至<1秒 |
| **可扩展性** | ✅ 线性扩展 | 设备端AI，服务器无瓶颈 |
| **成本** | ↓ 60% | 无需大量GPU服务器 |

### 负面影响

| 维度 | 影响 | 缓解措施 |
|------|------|---------|
| **设备要求** | 设备需支持AI芯片 | 选用支持AI的智能摄像头 |
| **开发时间** | 需要2-3周 | 分阶段实施 |
| **设备成本** | 单台设备成本略高 | 长期运营成本更低 |

---

## 🚫 风险与依赖

### 风险

1. **设备AI能力不足**
   - 风险：现有设备不支持AI分析
   - 缓解：选用支持AI的智能摄像头，或采用混合模式过渡

2. **开发时间紧张**
   - 风险：架构修复时间超出预期
   - 缓解：分阶段实施，优先修复架构问题

3. **设备协议兼容性**
   - 风险：不同设备厂商协议不统一
   - 缓解：通过设备通讯服务抽象协议差异

### 依赖

- **设备通讯服务**: 需要扩展支持AI事件上报和模型推送
- **数据库服务**: 需要新增AI事件表结构
- **网关服务**: 需要支持WebSocket实时推送

---

## 📚 相关文档

- [CLAUDE.md](../CLAUDE.md) - 项目架构规范（第945-989行：Mode 5 边缘AI计算）
- [EDGE_AI_ARCHITECTURE_ANALYSIS.md](../EDGE_AI_ARCHITECTURE_ANALYSIS.md) - 边缘计算架构深度分析
- [documentation/业务模块/05-视频管理模块/00-模块概述/README.md](../documentation/业务模块/05-视频管理模块/00-模块概述/README.md)
- [documentation/业务模块/05-视频管理模块/04-行为分析/README.md](../documentation/业务模块/05-视频管理模块/04-行为分析/README.md)

---

## 🗓️ 时间表

| 阶段 | 任务 | 预计时间 | 负责人 |
|------|------|---------|--------|
| **提案阶段** | OpenSpec提案和评审 | 2天 | 架构师 |
| **阶段1** | 架构修复（代码重构） | 1周 | 后端团队 |
| **阶段2** | 模型管理服务开发 | 2周 | 视频团队 |
| **阶段3** | 设备集成和测试 | 2周 | 设备团队 |
| **总计** | - | **5周** | - |

---

## ✍️ 签批

| 角色 | 姓名 | 签批 | 日期 |
|------|------|------|------|
| **提案人** | Claude AI | 待签批 | 2025-01-30 |
| **架构师** | 待定 | 待签批 | - |
| **技术负责人** | 待定 | 待签批 | - |
| **产品负责人** | 待定 | 待签批 | - |
