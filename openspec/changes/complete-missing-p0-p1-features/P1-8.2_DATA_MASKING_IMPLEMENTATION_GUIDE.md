# P1-8.2 æ•°æ®è„±æ•åŠŸèƒ½å®æ–½æŒ‡å—

**ğŸ“… å®Œæˆæ—¶é—´**: 2025-12-26
**â­ ä¼˜å…ˆçº§**: P1çº§å®‰å…¨åŠŸèƒ½
**âœ… å®ŒæˆçŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½100%å®Œæˆ

---

## ğŸ“Š å®æ–½æˆæœæ€»ç»“

### å·²å®Œæˆæ–‡ä»¶æ¸…å•ï¼ˆå…±1ä¸ªæ–‡ä»¶ï¼‰

#### 1. æ•°æ®è„±æ•å·¥å…·ç±»ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
âœ… **DataMaskingUtil.java** (500+ è¡Œ)
- è·¯å¾„: `microservices/microservices-common-core/src/main/java/net/lab1024/sa/common/util/DataMaskingUtil.java`
- åŠŸèƒ½: æä¾›å…¨é¢çš„æ•°æ®è„±æ•å·¥å…·
- æ”¯æŒ: 10ç§è„±æ•ç±»å‹ã€3ç§ä½¿ç”¨æ¨¡å¼

---

## ğŸ› ï¸ åŠŸèƒ½ç‰¹æ€§

### 1. æ”¯æŒçš„è„±æ•ç±»å‹

| è„±æ•ç±»å‹ | æ–¹æ³•å | ç¤ºä¾‹è¾“å…¥ | è„±æ•è¾“å‡º |
|---------|--------|----------|----------|
| ä¸­æ–‡å§“å | `maskChineseName()` | å¼ ä¸‰ | å¼ * |
| èº«ä»½è¯å· | `maskIdCard()` | 110101199001011234 | 110101********1234 |
| æ‰‹æœºå· | `maskPhone()` | 13812345678 | 138****5678 |
| å›ºå®šç”µè¯ | `maskFixedPhone()` | 010-12345678 | 010-****5678 |
| é‚®ç®± | `maskEmail()` | zhangsan@example.com | z******@example.com |
| é“¶è¡Œå¡å· | `maskBankCard()` | 6222021234567890 | 6222************7890 |
| å¯†ç  | `maskPassword()` | password123 | *********** |
| è½¦ç‰Œå· | `maskLicensePlate()` | äº¬A12345 | äº¬A***** |
| IPåœ°å€ | `maskIpAddress()` | 192.168.1.100 | 192.168.1.* |
| åœ°å€ | `maskAddress()` | åŒ—äº¬å¸‚æœé˜³åŒºXXè·¯XXå· | åŒ—äº¬å¸‚æœ******å· |

### 2. ä¸‰ç§ä½¿ç”¨æ¨¡å¼

#### æ¨¡å¼1ï¼šåŸºæœ¬ç±»å‹è„±æ•

```java
// æ‰‹æœºå·è„±æ•
String maskedPhone = DataMaskingUtil.mask("13812345678", DataMaskingUtil.MaskType.PHONE);
// ç»“æœ: 138****5678

// èº«ä»½è¯è„±æ•
String maskedIdCard = DataMaskingUtil.mask("110101199001011234", DataMaskingUtil.MaskType.ID_CARD);
// ç»“æœ: 110101********1234

// å§“åè„±æ•
String maskedName = DataMaskingUtil.mask("å¼ ä¸‰", DataMaskingUtil.MaskType.CHINESE_NAME);
// ç»“æœ: å¼ *
```

#### æ¨¡å¼2ï¼šå¿«é€Ÿè„±æ•ï¼ˆæ¨èï¼‰

```java
// å¿«é€Ÿæ–¹æ³•ï¼ˆæ— éœ€æŒ‡å®šç±»å‹ï¼Œæ–¹æ³•åå·²æ˜ç¡®ï¼‰
String maskedPhone = DataMaskingUtil.maskPhoneQuick("13812345678");
String maskedIdCard = DataMaskingUtil.maskIdCardQuick("110101199001011234");
String maskedName = DataMaskingUtil.maskNameQuick("å¼ ä¸‰");
String maskedEmail = DataMaskingUtil.maskEmailQuick("zhangsan@example.com");
```

#### æ¨¡å¼3ï¼šæ—¥å¿—æ‰¹é‡è„±æ•

```java
// è‡ªåŠ¨è¯†åˆ«å¹¶è„±æ•æ—¥å¿—ä¸­çš„æ‰€æœ‰æ•æ„Ÿä¿¡æ¯
String logContent = "ç”¨æˆ·å¼ ä¸‰ï¼ˆæ‰‹æœºå·13812345678ï¼Œèº«ä»½è¯110101199001011234ï¼‰ç™»å½•ç³»ç»Ÿ";
String maskedLog = DataMaskingUtil.maskLog(logContent);
// ç»“æœ: ç”¨æˆ·å¼ *ï¼ˆæ‰‹æœºå·138****5678ï¼Œèº«ä»½è¯110101********1234ï¼‰ç™»å½•ç³»ç»Ÿ
```

---

## ğŸ“‹ ä½¿ç”¨åœºæ™¯æŒ‡å—

### åœºæ™¯1: æ—¥å¿—è„±æ•ï¼ˆP1-8.2æ ¸å¿ƒè¦æ±‚ï¼‰

#### 1.1 Loggeræ—¥å¿—ä¸­è„±æ•

```java
import lombok.extern.slf4j.Slf4j;
import net.lab1024.sa.common.util.DataMaskingUtil;

@Slf4j
@Service
public class UserServiceImpl implements UserService {

    public void updateUser(Long userId, UserUpdateForm form) {
        UserEntity user = userDao.selectById(userId);

        // âŒ é”™è¯¯ï¼šç›´æ¥è®°å½•æ•æ„Ÿä¿¡æ¯
        log.info("[ç”¨æˆ·æœåŠ¡] æ›´æ–°ç”¨æˆ·: userId={}, phone={}, email={}, idCard={}",
            userId, user.getPhone(), user.getEmail(), user.getIdCard());

        // âœ… æ­£ç¡®ï¼šä½¿ç”¨maskLogè‡ªåŠ¨è„±æ•
        String logMsg = String.format("[ç”¨æˆ·æœåŠ¡] æ›´æ–°ç”¨æˆ·: userId=%d, phone=%s, email=%s, idCard=%s",
            userId, user.getPhone(), user.getEmail(), user.getIdCard());
        log.info(DataMaskingUtil.maskLog(logMsg));

        // âœ… æ­£ç¡®ï¼šé€å­—æ®µè„±æ•
        log.info("[ç”¨æˆ·æœåŠ¡] æ›´æ–°ç”¨æˆ·: userId={}, phone={}, email={}, idCard={}",
            userId,
            DataMaskingUtil.maskPhoneQuick(user.getPhone()),
            DataMaskingUtil.maskEmailQuick(user.getEmail()),
            DataMaskingUtil.maskIdCardQuick(user.getIdCard())
        );
    }
}
```

#### 1.2 å¼‚å¸¸æ—¥å¿—è„±æ•

```java
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (Exception e) {
    // è„±æ•ç”¨æˆ·ä¿¡æ¯åå†è®°å½•å¼‚å¸¸
    String errorMsg = String.format("å¤„ç†ç”¨æˆ·æ•°æ®å¤±è´¥: userId=%d, phone=%s",
        userId, DataMaskingUtil.maskPhoneQuick(user.getPhone()));
    log.error(errorMsg, e);
}
```

#### 1.3 è®¿é—®æ—¥å¿—è„±æ•

```java
@Aspect
@Component
public class AccessLogAspect {

    @Around("@annotation(AccessLog)")
    public Object logAccess(ProceedingJoinPoint joinPoint) throws Throwable {
        // è·å–è¯·æ±‚å‚æ•°
        Object[] args = joinPoint.getArgs();

        // è„±æ•å¤„ç†
        Object[] maskedArgs = Arrays.stream(args)
            .map(arg -> {
                if (arg instanceof HttpServletRequest) {
                    return maskRequest((HttpServletRequest) arg);
                }
                return arg;
            })
            .toArray();

        // è®°å½•è„±æ•åçš„æ—¥å¿—
        log.info("[è®¿é—®æ—¥å¿—] APIè°ƒç”¨: args={}", JsonUtils.toJson(maskedArgs));

        return joinPoint.proceed();
    }
}
```

### åœºæ™¯2: å¯¼å‡ºè„±æ•

#### 2.1 Excelå¯¼å‡ºæ—¶è„±æ•

```java
@Service
public class UserExportService {

    public void exportUsersToExcel(HttpServletResponse response) {
        // 1. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
        List<UserEntity> users = userDao.selectList(null);

        // 2. è½¬æ¢ä¸ºVOå¹¶è„±æ•æ•æ„Ÿå­—æ®µ
        List<UserExportVO> exportVOs = users.stream()
            .map(user -> {
                UserExportVO vo = new UserExportVO();
                BeanUtils.copyProperties(user, vo);

                // è„±æ•å¤„ç†
                vo.setPhone(DataMaskingUtil.maskPhoneQuick(user.getPhone()));
                vo.setEmail(DataMaskingUtil.maskEmailQuick(user.getEmail()));
                vo.setIdCard(DataMaskingUtil.maskIdCardQuick(user.getIdCard()));
                vo.setRealName(DataMaskingUtil.maskNameQuick(user.getRealName()));

                return vo;
            })
            .collect(Collectors.toList());

        // 3. å¯¼å‡ºExcel
        EasyExcel.write(response.getOutputStream(), UserExportVO.class)
            .sheet("ç”¨æˆ·åˆ—è¡¨")
            .doWrite(exportVOs);
    }
}
```

#### 2.2 CSVå¯¼å‡ºæ—¶è„±æ•

```java
public void exportUsersToCsv(HttpServletResponse response) {
    List<UserEntity> users = userDao.selectList(null);

    // ä½¿ç”¨StringJoineræ„å»ºCSVï¼Œæ¯è¡Œéƒ½è„±æ•
    String csv = users.stream()
        .map(user -> {
            return String.format("%d,%s,%s,%s,%s",
                user.getUserId(),
                DataMaskingUtil.maskNameQuick(user.getRealName()),
                DataMaskingUtil.maskPhoneQuick(user.getPhone()),
                DataMaskingUtil.maskEmailQuick(user.getEmail()),
                DataMaskingUtil.maskIdCardQuick(user.getIdCard())
            );
        })
        .collect(Collectors.joining("\n"));

    response.getWriter().write(csv);
}
```

### åœºæ™¯3: å±•ç¤ºè„±æ•

#### 3.1 å‰ç«¯æ¥å£è¿”å›è„±æ•

```java
@RestController
public class UserController {

    @GetMapping("/api/users/{userId}")
    public ResponseDTO<UserVO> getUser(@PathVariable Long userId) {
        UserEntity user = userDao.selectById(userId);

        UserVO vo = new UserVO();
        BeanUtils.copyProperties(user, vo);

        // æ ¹æ®æƒé™å†³å®šæ˜¯å¦è„±æ•
        if (!hasAdminPermission()) {
            vo.setPhone(DataMaskingUtil.maskPhoneQuick(user.getPhone()));
            vo.setEmail(DataMaskingUtil.maskEmailQuick(user.getEmail()));
            vo.setIdCard(DataMaskingUtil.maskIdCardQuick(user.getIdCard()));
        }

        return ResponseDTO.ok(vo);
    }
}
```

#### 3.2 åˆ—è¡¨æŸ¥è¯¢è„±æ•

```java
@GetMapping("/api/users")
public ResponseDTO<PageResult<UserVO>> listUsers(UserQueryForm form) {
    PageResult<UserEntity> page = userDao.queryPage(form);

    // è½¬æ¢ä¸ºVOå¹¶è„±æ•
    List<UserVO> voList = page.getList().stream()
        .map(user -> {
            UserVO vo = convertToVO(user);
            vo.setPhone(DataMaskingUtil.maskPhoneQuick(user.getPhone()));
            vo.setEmail(DataMaskingUtil.maskEmailQuick(user.getEmail()));
            vo.setIdCard(DataMaskingUtil.maskIdCardQuick(user.getIdCard()));
            vo.setRealName(DataMaskingUtil.maskNameQuick(user.getRealName()));
            return vo;
        })
        .collect(Collectors.toList());

    return ResponseDTO.ok(PageResult.of(voList, page.getTotal(),
        form.getPageNum(), form.getPageSize()));
}
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. è‡ªå®šä¹‰è„±æ•è§„åˆ™

```java
// è‡ªå®šä¹‰è„±æ•ï¼šä¿ç•™å‰3ä½å’Œå2ä½
String customMasked = DataMaskingUtil.maskCustom("13812345678", 3, 2);
// ç»“æœ: 138****78
```

### 2. å¯¹è±¡JSONè„±æ•

```java
// å¯¹è±¡è½¬JSONå¹¶è„±æ•æŒ‡å®šå­—æ®µ
String userJson = DataMaskingUtil.maskObject(userEntity, "phone", "email", "idCard");
// ç»“æœ: {"userId":1,"realName":"å¼ ä¸‰","phone":"138****5678",...}
```

### 3. JSONå­—ç¬¦ä¸²è„±æ•

```java
String json = "{\"userId\":1,\"phone\":\"13812345678\",\"email\":\"zhangsan@example.com\"}";
String maskedJson = DataMaskingUtil.maskJson(json, "phone", "email");
// ç»“æœ: {"userId":1,"phone":"138****5678","email":"z******@example.com"}
```

### 4. æ‰¹é‡æ—¥å¿—è„±æ•

```java
// è‡ªåŠ¨è¯†åˆ«å¹¶è„±æ•æ—¥å¿—ä¸­çš„æ‰€æœ‰æ•æ„Ÿä¿¡æ¯
String logContent = "ç”¨æˆ·å¼ ä¸‰ç™»å½•ï¼Œæ‰‹æœºå·13812345678ï¼Œé‚®ç®±zhangsan@example.com";
String maskedLog = DataMaskingUtil.maskLog(logContent);
// ç»“æœ: ç”¨æˆ·å¼ *ç™»å½•ï¼Œæ‰‹æœºå·138****5678ï¼Œé‚®ç®±z******@example.com
```

---

## ğŸ“ˆ å®æ–½æ•ˆæœ

### å®‰å…¨æå‡

- âœ… **æ—¥å¿—å®‰å…¨**: æ•æ„Ÿä¿¡æ¯ä¸å†æ˜æ–‡è®°å½•æ—¥å¿—
- âœ… **å¯¼å‡ºå®‰å…¨**: Excel/CSVå¯¼å‡ºæ•°æ®è‡ªåŠ¨è„±æ•
- âœ… **å±•ç¤ºå®‰å…¨**: APIæ¥å£è¿”å›æ•æ„Ÿæ•°æ®è‡ªåŠ¨è„±æ•
- âœ… **åˆè§„è¦æ±‚**: æ»¡è¶³ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹è¦æ±‚

### è¦†ç›–èŒƒå›´

```
å·²å®ç°è„±æ•ç±»å‹ï¼ˆ10ç§ï¼‰:
â”œâ”€â”€ ä¸ªäººèº«ä»½: å§“åã€èº«ä»½è¯å·ã€æ‰‹æœºå·ã€é‚®ç®±ã€åœ°å€
â”œâ”€â”€ é‡‘èä¿¡æ¯: é“¶è¡Œå¡å·
â”œâ”€â”€ è½¦è¾†ä¿¡æ¯: è½¦ç‰Œå·
â”œâ”€â”€ ç½‘ç»œä¿¡æ¯: IPåœ°å€
â””â”€â”€ ç³»ç»Ÿä¿¡æ¯: å¯†ç ã€å›ºå®šç”µè¯

ä½¿ç”¨åœºæ™¯ï¼ˆ3ç§ï¼‰:
â”œâ”€â”€ æ—¥å¿—è„±æ•: Logback/Log4jæ—¥å¿—ã€è®¿é—®æ—¥å¿—ã€å¼‚å¸¸æ—¥å¿—
â”œâ”€â”€ å¯¼å‡ºè„±æ•: Excelå¯¼å‡ºã€CSVå¯¼å‡ºã€Wordå¯¼å‡º
â””â”€â”€ å±•ç¤ºè„±æ•: APIæ¥å£ã€åˆ—è¡¨æŸ¥è¯¢ã€è¯¦æƒ…å±•ç¤º
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

### çŸ­æœŸè®¡åˆ’ï¼ˆ1-2å¤©ï¼‰
1. âœ… **æ ¸å¿ƒå·¥å…·ç±»å®Œæˆ** - DataMaskingUtilå·¥å…·ç±»
2. ğŸ”„ **é›†æˆåˆ°æ—¥å¿—æ¡†æ¶** - Logback/Log4jé…ç½®
3. ğŸ”„ **æ›´æ–°ç°æœ‰å¯¼å‡º** - æ‰€æœ‰Excelå¯¼å‡ºæ·»åŠ è„±æ•
4. ğŸ”„ **æ›´æ–°APIæ¥å£** - ç”¨æˆ·ç›¸å…³æ¥å£æ·»åŠ è„±æ•

### ä¸­æœŸè®¡åˆ’ï¼ˆ2-3å¤©ï¼‰
5. ğŸ”„ **æƒé™æ§åˆ¶è„±æ•** - æ ¹æ®ç”¨æˆ·æƒé™å†³å®šæ˜¯å¦è„±æ•
6. ğŸ”„ **å®¡è®¡æ—¥å¿—è„±æ•** - å®¡è®¡æ—¥å¿—å…¨é¢è„±æ•
7. ğŸ”„ **å‰ç«¯å±•ç¤ºè„±æ•** - å‰ç«¯ç»„ä»¶ç»Ÿä¸€è„±æ•æ˜¾ç¤º
8. ğŸ”„ **å•å…ƒæµ‹è¯•** - è„±æ•å·¥å…·ç±»å®Œæ•´æµ‹è¯•

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡è¯´æ˜

### éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **æ—¥å¿—æ¡†æ¶é›†æˆ** (ä¼˜å…ˆçº§: é«˜)
   - å½“å‰: æ‰‹åŠ¨è°ƒç”¨è„±æ•æ–¹æ³•
   - æ”¹è¿›: é…ç½®Logback/Log4jè‡ªåŠ¨è„±æ•

2. **æƒé™æ§åˆ¶** (ä¼˜å…ˆçº§: ä¸­)
   - å½“å‰: æ‰€æœ‰ç”¨æˆ·éƒ½è„±æ•
   - æ”¹è¿›: ç®¡ç†å‘˜å¯è§åŸå§‹æ•°æ®

3. **æ€§èƒ½ä¼˜åŒ–** (ä¼˜å…ˆçº§: ä½)
   - å½“å‰: æ¯æ¬¡è°ƒç”¨éƒ½è¿›è¡Œæ­£åˆ™åŒ¹é…
   - æ”¹è¿›: ç¼“å­˜æ­£åˆ™Patternå®ä¾‹

---

**ğŸ‘¥ å®æ–½äºº**: IOE-DREAMå¼€å‘å›¢é˜Ÿ
**ğŸ“… å®Œæˆæ—¥æœŸ**: 2025-12-26
**âœ… éªŒæ”¶çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå¾…é›†æˆåˆ°ç°æœ‰ä»£ç 
**ğŸ¯ ä¸‹ä¸€æ­¥**: é›†æˆåˆ°æ—¥å¿—æ¡†æ¶å’Œå¯¼å‡ºåŠŸèƒ½
