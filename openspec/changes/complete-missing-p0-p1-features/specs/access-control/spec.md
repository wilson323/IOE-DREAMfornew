# Access Control Capability Specification Delta

## ADDED Requirements

### Requirement: 设备自动发现功能
门禁系统SHALL提供自动网络发现功能，能够扫描并识别网络中的门禁设备。

#### Scenario: TCP/UDP多播扫描
- **GIVEN** 管理员启动设备自动发现
- **WHEN** 系统执行TCP/UDP多播扫描
- **THEN** 应在3分钟内完成扫描
- **AND** 返回设备IP、MAC、型号、固件版本

#### Scenario: 设备去重
- **GIVEN** 扫描发现重复设备
- **WHEN** 系统检测到重复IP或MAC
- **THEN** 应自动去重
- **AND** 保留设备信息最完整的记录

#### Scenario: 批量添加
- **GIVEN** 扫描完成发现100台设备
- **WHEN** 管理员点击一键批量添加
- **THEN** 应批量添加所有发现的设备
- **AND** 显示添加进度和结果

### Requirement: 批量设备导入功能
系统SHALL支持Excel批量导入门禁设备。

#### Scenario: Excel导入成功
- **GIVEN** 管理员上传包含1000条设备信息的Excel
- **WHEN** 系统解析并验证数据
- **THEN** 应在30秒内完成导入
- **AND** 显示导入成功统计

#### Scenario: Excel导入错误处理
- **GIVEN** Excel包含必填字段缺失或格式错误
- **WHEN** 系统验证数据
- **THEN** 应生成详细错误报告
- **AND** 指出错误行和错误原因
- **AND** 允许修正后重新导入

### Requirement: 固件升级管理功能
系统SHALL支持门禁设备固件版本管理和远程升级。

#### Scenario: 固件上传和校验
- **GIVEN** 管理员上传新固件文件
- **WHEN** 系统接收固件
- **THEN** 应计算MD5校验和
- **AND** 验证固件完整性
- **AND** 保存固件版本信息

#### Scenario: 批量固件升级
- **GIVEN** 管理员选择固件和100台设备
- **WHEN** 启动批量升级任务
- **THEN** 应并行升级设备（最大并发10台）
- **AND** 实时显示升级进度
- **AND** 记录升级结果和日志

#### Scenario: 固件升级失败回滚
- **GIVEN** 设备固件升级失败
- **WHEN** 升级失败
- **THEN** 应自动回滚到旧版本
- **AND** 记录失败原因
- **AND** 发送告警通知

### Requirement: 全局反潜回功能
系统SHALL提供4种反潜回模式，防止卡片在短时间内多次使用。

#### Scenario: 全局反潜回检测
- **GIVEN** 启用全局反潜回模式
- **WHEN** 用户在5分钟内在不同区域刷卡
- **THEN** 应检测到反潜回违规
- **AND** 阻止通行或触发告警（根据模式）
- **AND** 响应时间<100ms

#### Scenario: 区域反潜回检测
- **GIVEN** 启用区域反潜回模式
- **WHEN** 用户在5分钟内在同一区域刷卡
- **THEN** 应检测到反潜回违规
- **AND** 仅在区域内生效

#### Scenario: 软反潜回告警
- **GIVEN** 启用软反潜回模式
- **WHEN** 检测到反潜回违规
- **THEN** 应允许通行
- **AND** 发送告警通知
- **AND** 记录违规日志

#### Scenario: 硬反潜回阻止
- **GIVEN** 启用硬反潜回模式
- **WHEN** 检测到反潜回违规
- **THEN** 应阻止通行
- **AND** 发送紧急告警
- **AND** 记录违规日志

### Requirement: 实时监控告警功能
系统SHALL提供设备实时监控和多通道告警通知。

#### Scenario: 设备离线告警
- **GIVEN** 设备正常在线
- **WHEN** 设备突然离线
- **THEN** 应立即检测到离线
- **AND** 发送告警（短信+邮件+推送）
- **AND** 记录离线时间

#### Scenario: 门常开告警
- **GIVEN** 门磁传感器监控门状态
- **WHEN** 门持续打开超过5分钟
- **THEN** 应触发门常开告警
- **AND** 推送到安保人员

#### Scenario: 强行进入告警
- **GIVEN** 门禁状态正常
- **WHEN** 检测到强行进入（破门、暴力破坏）
- **THEN** 应立即触发紧急告警
- **AND** 通知安保中心
- **AND** 联动视频监控

#### Scenario: 胁迫码告警
- **GIVEN** 用户输入胁迫码
- **WHEN** 系统识别胁迫码
- **THEN** 应静默允许通行
- **AND** 触发静默告警到安保中心
- **AND** 显示用户处于胁迫状态

### Requirement: 多因子认证增强
系统SHALL支持多种生物识别和卡片组合认证。

#### Scenario: 卡片+人脸认证
- **GIVEN** 启用卡片+人脸双因子认证
- **WHEN** 用户刷卡后进行人脸识别
- **THEN** 应验证两个因子都通过
- **AND** 允许通行

#### Scenario: 卡片+密码认证
- **GIVEN** 启用卡片+密码双因子认证
- **WHEN** 用户刷卡后输入密码
- **THEN** 应验证卡片和密码都正确
- **AND** 允许通行

#### Scenario: 人脸+指纹认证
- **GIVEN** 启用人脸+指纹双因子认证
- **WHEN** 用户进行人脸识别和指纹验证
- **THEN** 应验证两个生物识别都匹配
- **AND** 允许通行

### Requirement: 电子地图集成
系统SHALL在电子地图上实时显示设备状态和通行事件。
系统应在地图上实时显示设备状态和通行事件。

#### Scenario: 地图设备标注
- **GIVEN** 加载电子地图
- **WHEN** 地图初始化完成
- **THEN** 应显示所有门禁设备标注
- **AND** 用不同颜色表示设备状态（在线/离线/告警）

#### Scenario: 地图事件展示
- **GIVEN** 发生通行事件
- **WHEN** 用户刷卡通行
- **THEN** 应在地图上显示事件位置
- **AND** 点击事件可查看详情

#### Scenario: 告警联动
- **GIVEN** 设备触发告警
- **WHEN** 告警发生
- **THEN** 地图上对应设备应闪烁
- **AND** 点击可查看告警详情

### Requirement: 通行记录优化
系统SHALL支持百万级记录快速查询。

#### Scenario: 大数据量查询
- **GIVEN** 数据库中有100万条通行记录
- **WHEN** 用户查询最近30天记录
- **THEN** 应在500ms内返回结果
- **AND** 支持分页显示

#### Scenario: 数据压缩存储
- **GIVEN** 每天产生10万条通行记录
- **WHEN** 存储通行记录
- **THEN** 应使用数据压缩技术
- **AND** 减少50%存储空间

#### Scenario: 分区表优化
- **GIVEN** 通行记录表数据增长
- **WHEN** 查询历史数据
- **THEN** 应使用分区表优化查询
- **AND** 按月分区
