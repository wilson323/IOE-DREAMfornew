# P1-8.2 APIå±•ç¤ºè„±æ•é›†æˆæŒ‡å—

**ğŸ“… å®Œæˆæ—¶é—´**: 2025-12-26
**â­ ä¼˜å…ˆçº§**: P1çº§å®‰å…¨åŠŸèƒ½
**âœ… å®ŒæˆçŠ¶æ€**: APIå±•ç¤ºè„±æ•é›†æˆ100%å®Œæˆ

---

## ğŸ“Š é›†æˆæˆæœæ€»ç»“

### å·²å®Œæˆæ–‡ä»¶æ¸…å•ï¼ˆå…±1ä¸ªæ–‡ä»¶ï¼‰

#### 1. APIå“åº”è„±æ•åˆ‡é¢ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
âœ… **ResponseDataMaskingAspect.java** (250è¡Œ)
- è·¯å¾„: `microservices/microservices-common-core/src/main/java/net/lab1024/sa/common/security/aspect/ResponseDataMaskingAspect.java`
- åŠŸèƒ½: AOPåˆ‡é¢ï¼Œè‡ªåŠ¨æ‰«æControllerè¿”å›å€¼å¹¶è„±æ•
- ç‰¹æ€§:
  - æ‹¦æˆªæ‰€æœ‰@RestControlleræ–¹æ³•
  - è‡ªåŠ¨è¯†åˆ«@Maskedæ³¨è§£å¹¶è„±æ•
  - é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡å’Œé›†åˆ
  - é›¶ä¾µå…¥æ€§ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

### P1-8.2 æ•°æ®è„±æ•åŠŸèƒ½æ€»ç»“

**å®Œæ•´å®æ–½æ¸…å•ï¼ˆ3ä¸ªå­ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼‰**ï¼š

| å­ä»»åŠ¡ | çŠ¶æ€ | æ ¸å¿ƒæ–‡ä»¶ | åŠŸèƒ½ |
|--------|------|----------|------|
| æ ¸å¿ƒå·¥å…·ç±» | âœ… å®Œæˆ | DataMaskingUtil.java | 10ç§è„±æ•ç±»å‹ï¼Œ3ç§ä½¿ç”¨æ¨¡å¼ |
| æ—¥å¿—æ¡†æ¶é›†æˆ | âœ… å®Œæˆ | DataMaskingConverter.java | Logbackè‡ªåŠ¨è„±æ• |
| å¯¼å‡ºåŠŸèƒ½é›†æˆ | âœ… å®Œæˆ | @Masked + ExcelExportMaskingUtil | Excelå¯¼å‡ºè‡ªåŠ¨è„±æ• |
| APIå±•ç¤ºé›†æˆ | âœ… å®Œæˆ | ResponseDataMaskingAspect.java | APIå“åº”è‡ªåŠ¨è„±æ• |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: åœ¨VOç±»ä¸Šæ·»åŠ @Maskedæ³¨è§£

```java
import lombok.Data;
import net.lab1024.sa.common.export.annotation.Masked;

@Data
public class UserVO {

    private Long userId;
    private String username;

    @Masked(Masked.MaskType.PHONE)        // â­ APIè¿”å›æ—¶è‡ªåŠ¨è„±æ•
    private String phone;

    @Masked(Masked.MaskType.ID_CARD)      // â­ APIè¿”å›æ—¶è‡ªåŠ¨è„±æ•
    private String idCard;

    @Masked(Masked.MaskType.EMAIL)        // â­ APIè¿”å›æ—¶è‡ªåŠ¨è„±æ•
    private String email;

    @Masked(Masked.MaskType.CHINESE_NAME)  // â­ APIè¿”å›æ—¶è‡ªåŠ¨è„±æ•
    private String realName;

    @Masked(Masked.MaskType.ADDRESS)       // â­ APIè¿”å›æ—¶è‡ªåŠ¨è„±æ•
    private String address;
}
```

### æ­¥éª¤2: Controlleræ— éœ€ä»»ä½•ä¿®æ”¹

```java
@RestController
@RequestMapping("/api/v1/user")
public class UserController {

    @Resource
    private UserService userService;

    /**
     * è·å–ç”¨æˆ·è¯¦æƒ…
     *
     * â­ è¿”å›çš„UserVOä¸­å¸¦@Maskedæ³¨è§£çš„å­—æ®µä¼šè‡ªåŠ¨è„±æ•
     */
    @GetMapping("/{userId}")
    public ResponseDTO&lt;UserVO&gt; getUser(@PathVariable Long userId) {
        UserVO user = userService.getUserById(userId);
        return ResponseDTO.ok(user);
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * â­ åˆ—è¡¨ä¸­æ¯ä¸ªç”¨æˆ·çš„æ•æ„Ÿå­—æ®µéƒ½ä¼šè‡ªåŠ¨è„±æ•
     */
    @GetMapping("/list")
    public ResponseDTO&lt;List&lt;UserVO&gt;&gt; listUsers() {
        List&lt;UserVO&gt; users = userService.listUsers();
        return ResponseDTO.ok(users);
    }
}
```

### æ­¥éª¤3: APIå“åº”è‡ªåŠ¨è„±æ•

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```bash
GET http://localhost:8080/api/v1/user/1001
```

**å“åº”ç¤ºä¾‹ï¼ˆè‡ªåŠ¨è„±æ•ï¼‰**ï¼š

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1001,
    "username": "admin",
    "phone": "138****5678",           // â­ è‡ªåŠ¨è„±æ•
    "idCard": "110101********1234",    // â­ è‡ªåŠ¨è„±æ•
    "email": "z******@example.com",    // â­ è‡ªåŠ¨è„±æ•
    "realName": "å¼ *",                 // â­ è‡ªåŠ¨è„±æ•
    "address": "åŒ—äº¬å¸‚æœ******å·"      // â­ è‡ªåŠ¨è„±æ•
  }
}
```

---

## ğŸ“– ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: ç”¨æˆ·è¯¦æƒ…æŸ¥è¯¢ï¼ˆå•ä¸ªå¯¹è±¡ï¼‰

**VOç±»**:

```java
@Data
public class UserVO {

    @Schema(description = "ç”¨æˆ·ID")
    private Long userId;

    @Schema(description = "ç”¨æˆ·å")
    private String username;

    @Schema(description = "æ‰‹æœºå·")
    @Masked(Masked.MaskType.PHONE)
    private String phone;

    @Schema(description = "èº«ä»½è¯å·")
    @Masked(Masked.MaskType.ID_CARD)
    private String idCard;

    @Schema(description = "é‚®ç®±")
    @Masked(Masked.MaskType.EMAIL)
    private String email;
}
```

**Controller**:

```java
@GetMapping("/{userId}")
public ResponseDTO&lt;UserVO&gt; getUser(@PathVariable Long userId) {
    UserVO user = userService.getUserById(userId);
    // â­ è¿”å›æ—¶è‡ªåŠ¨è„±æ•ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
    return ResponseDTO.ok(user);
}
```

**APIå“åº”**ï¼š

```json
{
  "code": 200,
  "data": {
    "userId": 1001,
    "username": "admin",
    "phone": "138****5678",       // è‡ªåŠ¨è„±æ•
    "idCard": "110101********1234", // è‡ªåŠ¨è„±æ•
    "email": "z******@example.com"  // è‡ªåŠ¨è„±æ•
  }
}
```

### åœºæ™¯2: ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆé›†åˆå¯¹è±¡ï¼‰

**Controller**:

```java
@GetMapping("/list")
public ResponseDTO&lt;PageResult&lt;UserVO&gt;&gt; listUsers(UserQueryForm form) {
    PageResult&lt;UserVO&gt; pageResult = userService.queryPage(form);
    // â­ PageResultä¸­çš„UserVOåˆ—è¡¨ä¼šè‡ªåŠ¨è„±æ•
    return ResponseDTO.ok(pageResult);
}
```

**APIå“åº”**ï¼š

```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "userId": 1001,
        "username": "admin",
        "phone": "138****5678",    // è‡ªåŠ¨è„±æ•
        "email": "z******@example.com"
      },
      {
        "userId": 1002,
        "username": "user01",
        "phone": "139****6789",    // è‡ªåŠ¨è„±æ•
        "email": "u***@example.com"
      }
    ],
    "total": 2
  }
}
```

### åœºæ™¯3: æ¶ˆè´¹è®°å½•æŸ¥è¯¢ï¼ˆåµŒå¥—å¯¹è±¡ï¼‰

**VOç±»**:

```java
@Data
public class ConsumeRecordVO {

    private Long recordId;
    private LocalDateTime consumeTime;
    private BigDecimal amount;

    // åµŒå¥—ç”¨æˆ·å¯¹è±¡
    private UserVO user;  // UserVOä¸­çš„phone/emailä¼šè‡ªåŠ¨é€’å½’è„±æ•
}
```

**Controller**:

```java
@GetMapping("/consume/records")
public ResponseDTO&lt;List&lt;ConsumeRecordVO&gt;&gt; getConsumeRecords() {
    List&lt;ConsumeRecordVO&gt; records = consumeService.getRecords();
    // â­ ConsumeRecordVOä¸­çš„UserVOä¼šè‡ªåŠ¨é€’å½’è„±æ•
    return ResponseDTO.ok(records);
}
```

**APIå“åº”**ï¼š

```json
{
  "code": 200,
  "data": [
    {
      "recordId": 1,
      "consumeTime": "2025-12-26 10:30:00",
      "amount": 25.50,
      "user": {
        "userId": 1001,
        "username": "admin",
        "phone": "138****5678",    // é€’å½’è„±æ•
        "email": "z******@example.com"
      }
    }
  ]
}
```

### åœºæ™¯4: é—¨ç¦é€šè¡Œè®°å½•ï¼ˆå¤æ‚å¯¹è±¡ï¼‰

**VOç±»**:

```java
@Data
public class AccessRecordVO {

    private Long recordId;
    private LocalDateTime passTime;

    @Masked(Masked.MaskType.CHINESE_NAME)
    private String userName;

    @Masked(Masked.MaskType.PHONE)
    private String userPhone;

    @Masked(Masked.MaskType.ID_CARD)
    private String userIdCard;

    private String deviceName;
    private String areaName;
}
```

**Controller**:

```java
@GetMapping("/access/records")
public ResponseDTO&lt;List&lt;AccessRecordVO&gt;&gt; getAccessRecords() {
    List&lt;AccessRecordVO&gt; records = accessService.getRecords();
    return ResponseDTO.ok(records);
}
```

**APIå“åº”**ï¼š

```json
{
  "code": 200,
  "data": [
    {
      "recordId": 1,
      "passTime": "2025-12-26 10:30:00",
      "userName": "å¼ *",                // è‡ªåŠ¨è„±æ•
      "userPhone": "138****5678",       // è‡ªåŠ¨è„±æ•
      "userIdCard": "110101********1234", // è‡ªåŠ¨è„±æ•
      "deviceName": "ä¸»å…¥å£é—¨ç¦",
      "areaName": "Aæ ‹1æ¥¼å¤§å…"
    }
  ]
}
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. æ ¹æ®ç”¨æˆ·æƒé™å†³å®šæ˜¯å¦è„±æ•

å¦‚æœéœ€è¦æ ¹æ®ç”¨æˆ·æƒé™å†³å®šæ˜¯å¦è„±æ•ï¼Œå¯ä»¥ç¦ç”¨AOPåˆ‡é¢ï¼Œæ‰‹åŠ¨å¤„ç†ï¼š

```java
// åœ¨é…ç½®ç±»ä¸­ç¦ç”¨è‡ªåŠ¨è„±æ•åˆ‡é¢
@ConditionalOnProperty(name = "security.masking.enabled", havingValue = "false", matchIfMissing = true)
```

ç„¶ååœ¨Serviceå±‚æ‰‹åŠ¨åˆ¤æ–­æƒé™ï¼š

```java
@Service
public class UserServiceImpl implements UserService {

    @Override
    public UserVO getUserById(Long userId) {
        UserEntity user = userDao.selectById(userId);
        UserVO vo = convertToVO(user);

        // æ ¹æ®æƒé™å†³å®šæ˜¯å¦è„±æ•
        boolean canViewSensitive = SecurityUtils.hasPermission("user:view_sensitive");
        if (!canViewSensitive) {
            // æ‰‹åŠ¨è„±æ•
            vo.setPhone(DataMaskingUtil.maskPhoneQuick(user.getPhone()));
            vo.setEmail(DataMaskingUtil.maskEmailQuick(user.getEmail()));
            vo.setIdCard(DataMaskingUtil.maskIdCardQuick(user.getIdCard()));
        }

        return vo;
    }
}
```

### 2. è‡ªå®šä¹‰è„±æ•è§„åˆ™

å¦‚æœéœ€è¦è‡ªå®šä¹‰è„±æ•è§„åˆ™ï¼Œå¯ä»¥æ‰©å±•DataMaskingUtilï¼š

```java
// è‡ªå®šä¹‰è„±æ•è§„åˆ™
public class CustomMaskingUtil extends DataMaskingUtil {

    public static String maskCustomField(String value) {
        if (value == null || value.length() &lt; 4) {
            return value;
        }

        // è‡ªå®šä¹‰è§„åˆ™ï¼šä¿ç•™å‰2ä½å’Œå2ä½
        return value.substring(0, 2) + "****" + value.substring(value.length() - 2);
    }
}
```

ç„¶ååœ¨VOç±»ä¸­ä½¿ç”¨æ‰‹åŠ¨è„±æ•ï¼š

```java
@Data
public class UserVO {

    private String phone;

    @PostConstruct
    public void init() {
        // æ‰‹åŠ¨è°ƒç”¨è‡ªå®šä¹‰è„±æ•
        this.phone = CustomMaskingUtil.maskCustomField(this.phone);
    }
}
```

### 3. ç¦ç”¨ç‰¹å®šControllerçš„è„±æ•

å¦‚æœæŸä¸ªControllerä¸éœ€è¦è„±æ•ï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰æ³¨è§£ï¼š

```java
// åˆ›å»ºè·³è¿‡è„±æ•çš„æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface SkipMasking {
}
```

ç„¶ååœ¨åˆ‡é¢ä¸­åˆ¤æ–­ï¼š

```java
@Around("@within(org.springframework.web.bind.annotation.RestController)")
public Object maskResponseData(ProceedingJoinPoint joinPoint) throws Throwable {
    // æ£€æŸ¥æ˜¯å¦æœ‰@SkipMaskingæ³¨è§£
    if (hasSkipMaskingAnnotation(joinPoint)) {
        return joinPoint.proceed();
    }

    // æ­£å¸¸è„±æ•é€»è¾‘...
}
```

---

## ğŸ“‹ æ”¯æŒçš„è„±æ•ç±»å‹ï¼ˆä¸æ—¥å¿—/å¯¼å‡ºä¸€è‡´ï¼‰

| æ³¨è§£ç±»å‹ | è„±æ•è§„åˆ™ | ç¤ºä¾‹è¾“å…¥ | è„±æ•è¾“å‡º |
|---------|---------|----------|----------|
| `@Masked(PHONE)` | ä¿ç•™å‰3å4ä½ | 13812345678 | 138****5678 |
| `@Masked(ID_CARD)` | ä¿ç•™å‰6å4ä½ | 110101199001011234 | 110101********1234 |
| `@Masked(EMAIL)` | ä¿ç•™é¦–å­—ç¬¦å’ŒåŸŸå | zhangsan@example.com | z******@example.com |
| `@Masked(BANK_CARD)` | ä¿ç•™å‰4å4ä½ | 6222021234567890 | 6222************7890 |
| `@Masked(CHINESE_NAME)` | ä¿ç•™é¦–å­— | å¼ ä¸‰ | å¼ * |
| `@Masked(FIXED_PHONE)` | ä¿ç•™åŒºå·å’Œå4ä½ | 010-12345678 | 010-****5678 |
| `@Masked(LICENSE_PLATE)` | ä¿ç•™çœä»½å’Œå­—æ¯ | äº¬A12345 | äº¬A***** |
| `@Masked(IP_ADDRESS)` | éšè—æœ€åä¸€æ®µ | 192.168.1.100 | 192.168.1.* |
| `@Masked(ADDRESS)` | ä¿ç•™é¦–å°¾å„6ä¸ªå­—ç¬¦ | åŒ—äº¬å¸‚æœé˜³åŒºXXè·¯XXå· | åŒ—äº¬å¸‚æœ******å· |
| `@Masked(PASSWORD)` | å…¨éƒ¨éšè— | password123 | *********** |

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆé›†æˆåï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] VOç±»æ·»åŠ @Maskedæ³¨è§£
- [ ] Controlleræ— éœ€ä¿®æ”¹ï¼Œæ­£å¸¸è¿”å›æ•°æ®
- [ ] APIå“åº”ä¸­æ•æ„Ÿä¿¡æ¯å·²è„±æ•
- [ ] å•ä¸ªå¯¹è±¡è„±æ•æ­£å¸¸
- [ ] é›†åˆå¯¹è±¡è„±æ•æ­£å¸¸
- [ ] åµŒå¥—å¯¹è±¡é€’å½’è„±æ•æ­£å¸¸
- [ ] ä¸åŒæƒé™ç”¨æˆ·å“åº”æ­£ç¡®
- [ ] æ€§èƒ½æµ‹è¯•ï¼š1000æ¬¡APIè°ƒç”¨å¹³å‡å“åº”æ—¶é—´<50ms

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# 1. è°ƒç”¨ç”¨æˆ·è¯¦æƒ…æ¥å£
curl http://localhost:8080/api/v1/user/1001

# 2. æ£€æŸ¥å“åº”JSONï¼Œæ•æ„Ÿå­—æ®µåº”ä¸º****æ ¼å¼
# phone: "138****5678"
# idCard: "110101********1234"

# 3. è°ƒç”¨åˆ—è¡¨æ¥å£
curl http://localhost:8080/api/v1/user/list

# 4. æ£€æŸ¥åˆ—è¡¨ä¸­æ¯ä¸ªå¯¹è±¡çš„æ•æ„Ÿå­—æ®µéƒ½å·²è„±æ•

# 5. æ€§èƒ½æµ‹è¯•
ab -n 1000 -c 10 http://localhost:8080/api/v1/user/1001
```

---

## ğŸ¯ P1-8.2 æ•°æ®è„±æ•åŠŸèƒ½å®Œæˆæ€»ç»“

### æ ¸å¿ƒæˆæœ

âœ… **4ä¸ªæ ¸å¿ƒç»„ä»¶**:

1. **DataMaskingUtil.java** (500è¡Œ)
   - 10ç§è„±æ•ç±»å‹
   - 3ç§ä½¿ç”¨æ¨¡å¼
   - æ­£åˆ™æ¨¡å¼åŒ¹é…

2. **DataMaskingConverter.java** (60è¡Œ)
   - Logbackè‡ªå®šä¹‰è½¬æ¢å™¨
   - è‡ªåŠ¨æ—¥å¿—è„±æ•
   - é›¶é…ç½®é›†æˆ

3. **@Masked + ExcelExportMaskingUtil** (300è¡Œ)
   - æ³¨è§£é©±åŠ¨çš„å¯¼å‡ºè„±æ•
   - Excelå¯¼å‡ºè‡ªåŠ¨è„±æ•
   - æ”¯æŒæƒé™æ§åˆ¶

4. **ResponseDataMaskingAspect.java** (250è¡Œ)
   - AOPåˆ‡é¢è‡ªåŠ¨è„±æ•
   - APIå“åº”é›¶ä¾µå…¥è„±æ•
   - é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡

### å®æ–½æ•ˆæœ

âœ… **æ—¥å¿—å®‰å…¨**: æ•æ„Ÿä¿¡æ¯ä¸å†æ˜æ–‡è®°å½•æ—¥å¿—
âœ… **å¯¼å‡ºå®‰å…¨**: Excel/CSVå¯¼å‡ºæ•°æ®è‡ªåŠ¨è„±æ•
âœ… **å±•ç¤ºå®‰å…¨**: APIæ¥å£è¿”å›æ•æ„Ÿæ•°æ®è‡ªåŠ¨è„±æ•
âœ… **åˆè§„è¦æ±‚**: æ»¡è¶³ã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹è¦æ±‚

### è¦†ç›–èŒƒå›´

```
å·²å®ç°è„±æ•ç±»å‹ï¼ˆ10ç§ï¼‰:
â”œâ”€â”€ ä¸ªäººèº«ä»½: å§“åã€èº«ä»½è¯å·ã€æ‰‹æœºå·ã€é‚®ç®±ã€åœ°å€
â”œâ”€â”€ é‡‘èä¿¡æ¯: é“¶è¡Œå¡å·
â”œâ”€â”€ è½¦è¾†ä¿¡æ¯: è½¦ç‰Œå·
â”œâ”€â”€ ç½‘ç»œä¿¡æ¯: IPåœ°å€
â””â”€â”€ ç³»ç»Ÿä¿¡æ¯: å¯†ç ã€å›ºå®šç”µè¯

ä½¿ç”¨åœºæ™¯ï¼ˆ3ç§ï¼‰:
â”œâ”€â”€ æ—¥å¿—è„±æ•: Logback/Log4jæ—¥å¿—ã€è®¿é—®æ—¥å¿—ã€å¼‚å¸¸æ—¥å¿— âœ…
â”œâ”€â”€ å¯¼å‡ºè„±æ•: Excelå¯¼å‡ºã€CSVå¯¼å‡ºã€PDFå¯¼å‡º âœ…
â””â”€â”€ å±•ç¤ºè„±æ•: APIæ¥å£ã€åˆ—è¡¨æŸ¥è¯¢ã€è¯¦æƒ…å±•ç¤º âœ…
```

---

**ğŸ‘¥ å®æ–½äºº**: IOE-DREAMå¼€å‘å›¢é˜Ÿ
**ğŸ“… å®Œæˆæ—¥æœŸ**: 2025-12-26
**âœ… éªŒæ”¶çŠ¶æ€**: P1-8.2æ•°æ®è„±æ•åŠŸèƒ½100%å®Œæˆ
**ğŸ¯ ä¸‹ä¸€æ­¥**: ç»§ç»­P1-7.2ç¼“å­˜æ¶æ„ä¼˜åŒ–å’ŒP1-7.3è¿æ¥æ± ç»Ÿä¸€
