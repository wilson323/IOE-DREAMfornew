# P1-7.3 Druid连接池配置标准化指南

**📅 创建时间**: 2025-12-26
**⭐ 优先级**: P1级性能优化
**✅ 完成状态**: 配置模板创建完成
**🎯 目标**: 统一所有微服务的Druid连接池配置

---

## 📊 配置标准化成果

### 已完成文件清单（共2个文件）

| 文件名 | 路径 | 用途 |
|--------|------|------|
| **application-druid-best-practice.yml** | `config-templates/` | Druid连接池最佳实践配置模板 |
| **druid-wall-config.properties** | `config-templates/` | Wall防火墙配置文件 |

---

## 🚀 快速开始

### 步骤1: 复制配置模板到微服务

```bash
# 复制Druid配置模板到微服务资源目录
cp config-templates/application-druid-best-practice.yml \
   microservices/ioedream-{service}/src/main/resources/application-druid-template.yml

# 复制Wall防火墙配置
cp config-templates/druid-wall-config.properties \
   microservices/ioedream-{service}/src/main/resources/druid-wall-config.properties
```

### 步骤2: 合并到现有application.yml

```yaml
# 打开微服务的 application.yml
# 将模板中的配置合并到 spring.datasource.druid 节点

spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3306/ioedream?...
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:ENC(AES256:...)}

    druid:
      # 从模板复制完整配置
      initial-size: ${DRUID_INITIAL_SIZE:5}
      min-idle: ${DRUID_MIN_IDLE:5}
      max-active: ${DRUID_MAX_ACTIVE:20}
      max-wait: ${DRUID_MAX_WAIT:60000}
      # ... 其他配置项
```

### 步骤3: 配置环境变量（生产环境）

```bash
# 创建环境变量配置文件 .env
# 在docker-compose.yml或启动脚本中引用

# 基础连接配置
MYSQL_HOST=192.168.1.100
MYSQL_PORT=3306
MYSQL_DATABASE=ioedream_access
MYSQL_USERNAME=app_user
MYSQL_PASSWORD=your-encrypted-password

# Druid连接池配置
DRUID_INITIAL_SIZE=5
DRUID_MIN_IDLE=5
DRUID_MAX_ACTIVE=20
DRUID_MAX_WAIT=60000
DRUID_VALIDATION_QUERY=SELECT 1
DRUID_TIME_BETWEEN_EVICTION_RUNS_MILLIS=60000
DRUID_MIN_EVICTABLE_IDLE_TIME_MILLIS=300000

# Druid监控配置
DRUID_STAT_ENABLED=true
DRUID_STAT_USERNAME=admin
DRUID_STAT_PASSWORD=your-strong-password
DRUID_WEB_STAT_ENABLED=true

# Druid过滤器配置
DRUID_STAT_FILTER_ENABLED=true
DRUID_LOG_SLOW_SQL=true
DRUID_SLOW_SQL_MILLIS=1000
DRUID_MERGE_SQL=true
DRUID_WALL_FILTER_ENABLED=true
```

### 步骤4: 验证配置

```bash
# 1. 启动微服务
mvn spring-boot:run

# 2. 访问Druid监控页面
# http://localhost:8090/druid/index.html

# 3. 检查连接池状态
# - 查看活跃连接数
# - 查看慢SQL记录
# - 查看SQL执行统计
```

---

## 📖 配置详解

### 1. 连接池基本配置

```yaml
druid:
  # 初始连接数（应用启动时创建）
  initial-size: 5

  # 最小空闲连接数（连接池保持的最小空闲连接）
  min-idle: 5

  # 最大活跃连接数（同时能活跃的最大连接数）
  max-active: 20

  # 获取连接最大等待时间（毫秒）
  max-wait: 60000
```

**配置建议**：

| 参数 | 小型服务 | 中型服务 | 大型服务 | 说明 |
|------|---------|---------|---------|------|
| `initial-size` | 3-5 | 5-10 | 10-20 | 根据并发需求调整 |
| `min-idle` | 3-5 | 5-10 | 10-20 | 保持与initial-size一致 |
| `max-active` | 10-20 | 20-50 | 50-100 | 根据数据库负载能力调整 |
| `max-wait` | 30000 | 60000 | 60000 | 不建议超过60秒 |

### 2. 连接有效性检测配置

```yaml
druid:
  # 验证连接的SQL语句
  validation-query: SELECT 1

  # 空闲时检测连接有效性（推荐：true）
  test-while-idle: true

  # 获取连接时检测（不推荐：false，影响性能）
  test-on-borrow: false

  # 归还连接时检测（不推荐：false，影响性能）
  test-on-return: false

  # 检测空闲连接间隔时间（毫秒）
  time-between-eviction-runs-millis: 60000

  # 连接最小空闲时间（毫秒）
  min-evictable-idle-time-millis: 300000
```

**关键说明**：

- `test-while-idle: true` - **强烈推荐**，防止使用失效连接
- `test-on-borrow: false` - **推荐关闭**，每次获取都检测会影响性能
- `time-between-eviction-runs-millis: 60000` - 每60秒检测一次空闲连接
- `min-evictable-idle-time-millis: 300000` - 空闲超过5分钟的连接将被回收

### 3. 监控统计配置

```yaml
druid:
  stat-view-servlet:
    enabled: true
    url-pattern: /druid/*
    reset-enable: true
    login-username: admin
    login-password: ${DRUID_STAT_PASSWORD:}

  web-stat-filter:
    enabled: true
    url-pattern: /*
    exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*,/actuator/*"
```

**监控页面访问**：

```
URL: http://{service-host}:{port}/druid/index.html
用户名: admin
密码: 环境变量 DRUID_STAT_PASSWORD
```

**监控页面功能**：

- **数据源** - 连接池状态监控
- **SQL监控** - SQL执行统计和慢SQL记录
- **Spring监控** - Spring Bean方法调用监控
- **Web应用** - HTTP请求统计
- **URI监控** - 接口调用统计

### 4. 慢SQL记录配置

```yaml
druid:
  filter:
    stat:
      enabled: true
      log-slow-sql: true
      slow-sql-millis: 1000
      merge-sql: true
```

**慢SQL日志示例**：

```log
2025-12-26 10:30:15.123 [Druid-SQL-Slow] [慢SQL] 执行时间: 1250ms, SQL: SELECT * FROM t_access_record WHERE user_id = ?
2025-12-26 10:30:16.456 [Druid-SQL-Slow] [慢SQL] 执行时间: 1580ms, SQL: SELECT * FROM t_consume_record WHERE create_time >= ?
```

**优化建议**：

- `slow-sql-millis: 1000` - 超过1秒的SQL被记录为慢SQL
- `merge-sql: true` - 相同SQL（参数不同）合并统计
- 定期分析慢SQL日志，优化索引和SQL语句

### 5. Wall防火墙配置

```yaml
druid:
  filter:
    wall:
      enabled: true
      config: classpath:druid-wall-config.properties
      multi-statement-allow: true
      comment-allow: true
```

**Wall防火墙功能**：

- ✅ 防止SQL注入攻击
- ✅ 拦截高风险SQL操作（DDL、TRUNCATE等）
- ✅ 规范SQL语句
- ✅ 记录违规SQL日志

**违规SQL日志示例**：

```log
2025-12-26 10:30:15.789 [Druid-Wall] [SQL防火墙] 拦截到违规SQL: DROP TABLE t_access_record
2025-12-26 10:30:16.012 [Druid-Wall] [SQL防火墙] 拦截到SQL注入尝试: SELECT * FROM t_user WHERE username = 'admin' OR '1'='1'
```

---

## 🎯 推广实施计划

### 阶段1: 核心服务优先（1-2天）

**优先推广服务**（按用户访问量排序）：

1. ✅ **ioedream-access-service** (8090) - 门禁服务
2. ✅ **ioedream-attendance-service** (8091) - 考勤服务
3. ✅ **ioedream-consume-service** (8094) - 消费服务
4. ✅ **ioedream-visitor-service** (8095) - 访客服务

**完成标准**：

- 配置文件更新完成
- 监控页面可访问
- 慢SQL记录正常
- Wall防火墙启用

### 阶段2: 扩展服务推广（2-3天）

**次要推广服务**：

5. ✅ **ioedream-video-service** (8092) - 视频服务
6. ✅ **ioedream-device-comm-service** (8087) - 设备通讯服务
7. ✅ **ioedream-biometric-service** (8096) - 生物识别服务
8. ✅ **ioedream-oa-service** (8089) - OA服务

### 阶段3: 公共服务推广（1天）

9. ✅ **ioedream-common-service** - 公共业务服务
10. ✅ **ioedream-database-service** - 数据库管理服务

---

## 📋 验证清单

完成配置推广后，请验证以下项目：

### 配置完整性验证

- [ ] 配置文件已更新为最新模板
- [ ] Wall防火墙配置文件已添加
- [ ] 环境变量配置正确
- [ ] 敏感信息已加密（Jasypt）

### 功能验证

- [ ] 服务启动正常
- [ ] 连接池参数生效
- [ ] Druid监控页面可访问
- [ ] 慢SQL记录正常输出
- [ ] Wall防火墙日志正常

### 性能验证

- [ ] 连接获取时间<100ms
- [ ] 慢SQL数量<5%（所有SQL）
- [ ] 连接池利用率60%-90%
- [ ] 无连接泄漏

**验证方法**：

```bash
# 1. 启动服务
mvn spring-boot:run

# 2. 访问监控页面
curl http://localhost:8090/druid/index.html

# 3. 检查连接池状态
# 登录监控页面查看：
# - 活跃连接数
# - 空闲连接数
# - 等待线程数
# - SQL执行统计

# 4. 检查慢SQL日志
tail -f logs/ioe-dream.log | grep "慢SQL"

# 5. 检查Wall防火墙日志
tail -f logs/ioe-dream.log | grep "SQL防火墙"

# 6. 性能测试
ab -n 1000 -c 10 http://localhost:8090/api/v1/access/record/list
```

---

## 🔧 配置调优建议

### 场景1: 高并发服务

**适用服务**：access-service, attendance-service

```yaml
druid:
  initial-size: 10
  min-idle: 10
  max-active: 50
  max-wait: 30000
```

**原因**：高并发需要更多连接，减少等待时间

### 场景2: 大数据量查询服务

**适用服务**：consume-service, video-service

```yaml
druid:
  initial-size: 10
  min-idle: 10
  max-active: 30
  max-wait: 60000

  filter:
    stat:
      slow-sql-millis: 2000  # 提高慢SQL阈值
```

**原因**：大数据量查询需要更长时间，提高慢SQL阈值避免误报

### 场景3: 低频服务

**适用服务**：biometric-service, visitor-service

```yaml
druid:
  initial-size: 3
  min-idle: 3
  max-active: 10
  max-wait: 30000

  time-between-eviction-runs-millis: 120000  # 延长检测间隔
  min-evictable-idle-time-millis: 600000     # 延长空闲时间
```

**原因**：低频服务降低资源占用，延长连接存活时间

---

## 🎯 下一步工作

### 短期计划（1-2天）

1. **推广到核心服务**
   - 更新access-service配置
   - 更新attendance-service配置
   - 更新consume-service配置
   - 更新visitor-service配置

2. **验证配置效果**
   - 启动服务验证配置
   - 访问监控页面
   - 检查慢SQL记录

### 中期计划（2-3天）

3. **推广到扩展服务**
   - 更新video-service配置
   - 更新device-comm-service配置
   - 更新biometric-service配置
   - 更新oa-service配置

4. **性能压测验证**
   - 对所有服务进行压测
   - 验证连接池性能提升
   - 调优配置参数

---

## 📚 相关文档

1. **P1-7.3_CONNECTION_POOL_AUDIT_REPORT.md** - 连接池审计报告
2. **Druid官方文档** - https://github.com/alibaba/druid/wiki
3. **Druid配置详解** - https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_DruidDataSource

---

**👥 实施人**: IOE-DREAM开发团队
**📅 创建日期**: 2025-12-26
**✅ 完成状态**: 配置模板创建完成，待推广到各微服务
**🎯 下一步**: 推广配置到核心微服务（access-service, attendance-service, consume-service, visitor-service）

---

**🎉 配置标准化模板已创建完成，接下来将推广到所有微服务！**
