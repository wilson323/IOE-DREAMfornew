# P1-8.2 å¯¼å‡ºè„±æ•é›†æˆæŒ‡å—

**ğŸ“… å®Œæˆæ—¶é—´**: 2025-12-26
**â­ ä¼˜å…ˆçº§**: P1çº§å®‰å…¨åŠŸèƒ½
**âœ… å®ŒæˆçŠ¶æ€**: å¯¼å‡ºè„±æ•é›†æˆ100%å®Œæˆ

---

## ğŸ“Š é›†æˆæˆæœæ€»ç»“

### å·²å®Œæˆæ–‡ä»¶æ¸…å•ï¼ˆå…±2ä¸ªæ–‡ä»¶ï¼‰

#### 1. è„±æ•æ³¨è§£ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
âœ… **@Maskedæ³¨è§£** (90è¡Œ)
- è·¯å¾„: `microservices/microservices-common-export/src/main/java/net/lab1024/sa/common/export/annotation/Masked.java`
- åŠŸèƒ½: æ ‡è®°éœ€è¦è„±æ•çš„Excelå¯¼å‡ºå­—æ®µ
- æ”¯æŒ: 10ç§è„±æ•ç±»å‹

#### 2. Excelå¯¼å‡ºè„±æ•å·¥å…·ï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰
âœ… **ExcelExportMaskingUtil** (200è¡Œ)
- è·¯å¾„: `microservices/microservices-common-export/src/main/java/net/lab1024/sa/common/export/util/ExcelExportMaskingUtil.java`
- åŠŸèƒ½: è‡ªåŠ¨æ‰«æ@Maskedæ³¨è§£å¹¶è„±æ•
- ç‰¹æ€§: åå°„æœºåˆ¶ã€æ·±åº¦å¤åˆ¶ã€ç±»å‹å®‰å…¨

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: åœ¨Excelæ¨¡å‹ä¸Šæ·»åŠ @Maskedæ³¨è§£

```java
import com.alibaba.excel.annotation.ExcelProperty;
import lombok.Data;
import net.lab1024.sa.common.export.annotation.Masked;

@Data
public class UserExportVO {

    @ExcelProperty("ç”¨æˆ·ID")
    private Long userId;

    @ExcelProperty("ç”¨æˆ·å")
    private String username;

    @ExcelProperty("æ‰‹æœºå·")
    @Masked(Masked.MaskType.PHONE)  // â­ å¯¼å‡ºæ—¶è‡ªåŠ¨è„±æ•
    private String phone;

    @ExcelProperty("èº«ä»½è¯å·")
    @Masked(Masked.MaskType.ID_CARD)  // â­ å¯¼å‡ºæ—¶è‡ªåŠ¨è„±æ•
    private String idCard;

    @ExcelProperty("é‚®ç®±")
    @Masked(Masked.MaskType.EMAIL)  // â­ å¯¼å‡ºæ—¶è‡ªåŠ¨è„±æ•
    private String email;

    @ExcelProperty("çœŸå®å§“å")
    @Masked(Masked.MaskType.CHINESE_NAME)  // â­ å¯¼å‡ºæ—¶è‡ªåŠ¨è„±æ•
    private String realName;

    @ExcelProperty("åœ°å€")
    @Masked(Masked.MaskType.ADDRESS)  // â­ å¯¼å‡ºæ—¶è‡ªåŠ¨è„±æ•
    private String address;
}
```

### æ­¥éª¤2: ä½¿ç”¨ExcelExportMaskingUtilå¯¼å‡º

```java
@Slf4j
@Service
public class UserServiceImpl implements UserService {

    @Override
    public void exportUsersToExcel(HttpServletResponse response) throws IOException {
        // 1. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
        List&lt;UserEntity&gt; users = userDao.selectList(null);

        // 2. è½¬æ¢ä¸ºExportVOï¼ˆå¸¦@Maskedæ³¨è§£ï¼‰
        List&lt;UserExportVO&gt; exportVOs = users.stream()
            .map(this::convertToExportVO)
            .collect(Collectors.toList());

        // 3. ä½¿ç”¨è„±æ•å·¥å…·å¯¼å‡ºï¼ˆè‡ªåŠ¨è„±æ•ï¼‰
        ExcelExportMaskingUtil.exportWithMasking(
            response,
            exportVOs,
            UserExportVO.class,
            "ç”¨æˆ·åˆ—è¡¨",
            "ç”¨æˆ·æ•°æ®"
        );

        log.info("[ç”¨æˆ·æœåŠ¡] ç”¨æˆ·æ•°æ®å¯¼å‡ºå®Œæˆ: count={}", exportVOs.size());
    }

    private UserExportVO convertToExportVO(UserEntity user) {
        UserExportVO vo = new UserExportVO();
        BeanUtils.copyProperties(user, vo);
        return vo;
    }
}
```

**å¯¼å‡ºæ•ˆæœ**ï¼š

| ç”¨æˆ·ID | ç”¨æˆ·å | æ‰‹æœºå· | èº«ä»½è¯å· | é‚®ç®± | çœŸå®å§“å | åœ°å€ |
|--------|--------|--------|----------|------|----------|------|
| 1001 | admin | 138****5678 | 110101********1234 | z******@example.com | å¼ * | åŒ—äº¬å¸‚æœ******å· |
| 1002 | user01 | 139****6789 | 110102********2345 | u***@example.com | æ* | ä¸Šæµ·å¸‚æµ¦ä¸œ******å· |

---

## ğŸ“– ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: ç”¨æˆ·æ•°æ®å¯¼å‡ºï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰

**Controllerå±‚**:

```java
@RestController
@RequestMapping("/api/v1/user")
public class UserController {

    @Resource
    private UserService userService;

    /**
     * å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆè‡ªåŠ¨è„±æ•ï¼‰
     */
    @GetMapping("/export")
    public void exportUsers(HttpServletResponse response) throws IOException {
        userService.exportUsersToExcel(response);
    }
}
```

**Serviceå±‚**:

```java
@Slf4j
@Service
public class UserServiceImpl implements UserService {

    @Resource
    private UserDao userDao;

    @Override
    public void exportUsersToExcel(HttpServletResponse response) throws IOException {
        // 1. æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
        List&lt;UserEntity&gt; users = userDao.selectList(null);

        // 2. è½¬æ¢ä¸ºExportVO
        List&lt;UserExportVO&gt; exportVOs = users.stream()
            .map(user -&gt; {
                UserExportVO vo = new UserExportVO();
                BeanUtils.copyProperties(user, vo);
                return vo;
            })
            .collect(Collectors.toList());

        // 3. å¯¼å‡ºï¼ˆè‡ªåŠ¨è„±æ•ï¼‰
        ExcelExportMaskingUtil.exportUsers(response, exportVOs);

        log.info("[ç”¨æˆ·æœåŠ¡] ç”¨æˆ·æ•°æ®å¯¼å‡ºæˆåŠŸ: count={}", exportVOs.size());
    }
}
```

**ExportVOæ¨¡å‹**:

```java
@Data
public class UserExportVO {

    @ExcelProperty("ç”¨æˆ·ID")
    private Long userId;

    @ExcelProperty("ç”¨æˆ·å")
    private String username;

    @ExcelProperty("æ‰‹æœºå·")
    @Masked(Masked.MaskType.PHONE)
    private String phone;

    @ExcelProperty("èº«ä»½è¯å·")
    @Masked(Masked.MaskType.ID_CARD)
    private String idCard;

    @ExcelProperty("é‚®ç®±")
    @Masked(Masked.MaskType.EMAIL)
    private String email;

    @ExcelProperty("çœŸå®å§“å")
    @Masked(Masked.MaskType.CHINESE_NAME)
    private String realName;
}
```

### åœºæ™¯2: æ¶ˆè´¹è®°å½•å¯¼å‡º

**ExportVOæ¨¡å‹**:

```java
@Data
public class ConsumeRecordExportVO {

    @ExcelProperty("æ¶ˆè´¹æ—¶é—´")
    private LocalDateTime consumeTime;

    @ExcelProperty("ç”¨æˆ·å")
    private String username;

    @ExcelProperty("æ‰‹æœºå·")
    @Masked(Masked.MaskType.PHONE)  // è‡ªåŠ¨è„±æ•
    private String userPhone;

    @ExcelProperty("æ¶ˆè´¹é‡‘é¢")
    private BigDecimal amount;

    @ExcelProperty("å•†æˆ·åç§°")
    private String merchantName;

    @ExcelProperty("æ”¯ä»˜æ–¹å¼")
    private String paymentMethod;

    @ExcelProperty("è®¢å•å·")
    private String orderNo;
}
```

**å¯¼å‡ºæ–¹æ³•**:

```java
@Override
public void exportConsumeRecords(HttpServletResponse response) throws IOException {
    // 1. æŸ¥è¯¢æ¶ˆè´¹è®°å½•
    List&lt;ConsumeRecordEntity&gt; records = recordDao.selectList(null);

    // 2. è½¬æ¢ä¸ºExportVO
    List&lt;ConsumeRecordExportVO&gt; exportVOs = records.stream()
        .map(record -&gt; {
            ConsumeRecordExportVO vo = new ConsumeRecordExportVO();
            BeanUtils.copyProperties(record, vo);
            return vo;
        })
        .collect(Collectors.toList());

    // 3. å¯¼å‡ºï¼ˆè‡ªåŠ¨è„±æ•æ‰‹æœºå·ï¼‰
    ExcelExportMaskingUtil.exportConsumeRecords(response, exportVOs);
}
```

### åœºæ™¯3: é—¨ç¦é€šè¡Œè®°å½•å¯¼å‡º

**ExportVOæ¨¡å‹**:

```java
@Data
public class AccessRecordExportVO {

    @ExcelProperty("é€šè¡Œæ—¶é—´")
    private LocalDateTime passTime;

    @ExcelProperty("ç”¨æˆ·å")
    private String userName;

    @ExcelProperty("æ‰‹æœºå·")
    @Masked(Masked.MaskType.PHONE)  // è‡ªåŠ¨è„±æ•
    private String userPhone;

    @ExcelProperty("èº«ä»½è¯å·")
    @Masked(Masked.MaskType.ID_CARD)  // è‡ªåŠ¨è„±æ•
    private String userIdCard;

    @ExcelProperty("è®¾å¤‡åç§°")
    private String deviceName;

    @ExcelProperty("é€šè¡ŒçŠ¶æ€")
    private String passStatus;

    @ExcelProperty("åŒºåŸŸåç§°")
    private String areaName;
}
```

### åœºæ™¯4: è€ƒå‹¤æ‰“å¡è®°å½•å¯¼å‡º

**ExportVOæ¨¡å‹**:

```java
@Data
public class AttendanceRecordExportVO {

    @ExcelProperty("æ‰“å¡æ—¶é—´")
    private LocalDateTime checkTime;

    @ExcelProperty("å‘˜å·¥å§“å")
    @Masked(Masked.MaskType.CHINESE_NAME)  // è‡ªåŠ¨è„±æ•
    private String employeeName;

    @ExcelProperty("æ‰‹æœºå·")
    @Masked(Masked.MaskType.PHONE)  // è‡ªåŠ¨è„±æ•
    private String phone;

    @ExcelProperty("éƒ¨é—¨")
    private String departmentName;

    @ExcelProperty("è€ƒå‹¤çŠ¶æ€")
    private String attendanceStatus;

    @ExcelProperty("æ‰“å¡åœ°ç‚¹")
    private String location;
}
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. æ‰‹åŠ¨è„±æ•å¯¼å‡ºï¼ˆä¸ä½¿ç”¨æ³¨è§£ï¼‰

å¦‚æœä¸ä½¿ç”¨@Maskedæ³¨è§£ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨è„±æ•ï¼š

```java
@Override
public void exportUsersManual(HttpServletResponse response) throws IOException {
    // 1. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
    List&lt;UserEntity&gt; users = userDao.selectList(null);

    // 2. æ‰‹åŠ¨è„±æ•å¹¶è½¬æ¢ä¸ºExportVO
    List&lt;UserExportVO&gt; exportVOs = users.stream()
        .map(user -&gt; {
            UserExportVO vo = new UserExportVO();
            BeanUtils.copyProperties(user, vo);

            // æ‰‹åŠ¨è„±æ•
            vo.setPhone(DataMaskingUtil.maskPhoneQuick(user.getPhone()));
            vo.setEmail(DataMaskingUtil.maskEmailQuick(user.getEmail()));
            vo.setIdCard(DataMaskingUtil.maskIdCardQuick(user.getIdCard()));
            vo.setRealName(DataMaskingUtil.maskNameQuick(user.getRealName()));

            return vo;
        })
        .collect(Collectors.toList());

    // 3. ä½¿ç”¨æ™®é€šEasyExcelå¯¼å‡º
    EasyExcel.write(response.getOutputStream(), UserExportVO.class)
        .sheet("ç”¨æˆ·åˆ—è¡¨")
        .doWrite(exportVOs);
}
```

### 2. æ¡ä»¶è„±æ•ï¼ˆæ ¹æ®æƒé™ï¼‰

```java
@Override
public void exportUsersWithPermission(HttpServletResponse response) throws IOException {
    // è·å–å½“å‰ç”¨æˆ·æƒé™
    boolean isAdmin = SecurityUtils.isAdmin();
    boolean canViewSensitive = SecurityUtils.hasPermission("user:view_sensitive");

    List&lt;UserEntity&gt; users = userDao.selectList(null);
    List&lt;UserExportVO&gt; exportVOs = users.stream()
        .map(user -&gt; {
            UserExportVO vo = new UserExportVO();
            BeanUtils.copyProperties(user, vo);

            // æ ¹æ®æƒé™å†³å®šæ˜¯å¦è„±æ•
            if (!canViewSensitive) {
                vo.setPhone(DataMaskingUtil.maskPhoneQuick(user.getPhone()));
                vo.setEmail(DataMaskingUtil.maskEmailQuick(user.getEmail()));
                vo.setIdCard(DataMaskingUtil.maskIdCardQuick(user.getIdCard()));
            }

            return vo;
        })
        .collect(Collectors.toList());

    ExcelExportMaskingUtil.exportUsers(response, exportVOs);
}
```

### 3. CSVå¯¼å‡ºè„±æ•

```java
@Override
public void exportUsersToCsv(HttpServletResponse response) throws IOException {
    List&lt;UserEntity&gt; users = userDao.selectList(null);

    // è®¾ç½®CSVå“åº”å¤´
    response.setContentType("text/csv");
    response.setHeader("Content-Disposition",
        "attachment; filename=" + URLEncoder.encode("ç”¨æˆ·æ•°æ®.csv", "UTF-8"));

    // å†™å…¥CSVï¼ˆæ‰‹åŠ¨è„±æ•ï¼‰
    PrintWriter writer = response.getWriter();
    writer.println("ç”¨æˆ·ID,ç”¨æˆ·å,æ‰‹æœºå·,èº«ä»½è¯å·,é‚®ç®±");

    for (UserEntity user : users) {
        writer.println(String.format("%d,%s,%s,%s,%s",
            user.getUserId(),
            user.getUsername(),
            DataMaskingUtil.maskPhoneQuick(user.getPhone()),
            DataMaskingUtil.maskIdCardQuick(user.getIdCard()),
            DataMaskingUtil.maskEmailQuick(user.getEmail())
        ));
    }

    writer.flush();
}
```

---

## ğŸ“‹ æ”¯æŒçš„è„±æ•ç±»å‹

| æ³¨è§£ç±»å‹ | è„±æ•è§„åˆ™ | ç¤ºä¾‹è¾“å…¥ | è„±æ•è¾“å‡º |
|---------|---------|----------|----------|
| `@Masked(PHONE)` | ä¿ç•™å‰3å4ä½ | 13812345678 | 138****5678 |
| `@Masked(ID_CARD)` | ä¿ç•™å‰6å4ä½ | 110101199001011234 | 110101********1234 |
| `@Masked(EMAIL)` | ä¿ç•™é¦–å­—ç¬¦å’ŒåŸŸå | zhangsan@example.com | z******@example.com |
| `@Masked(BANK_CARD)` | ä¿ç•™å‰4å4ä½ | 6222021234567890 | 6222************7890 |
| `@Masked(CHINESE_NAME)` | ä¿ç•™é¦–å­— | å¼ ä¸‰ | å¼ * |
| `@Masked(FIXED_PHONE)` | ä¿ç•™åŒºå·å’Œå4ä½ | 010-12345678 | 010-****5678 |
| `@Masked(LICENSE_PLATE)` | ä¿ç•™çœä»½å’Œå­—æ¯ | äº¬A12345 | äº¬A***** |
| `@Masked(IP_ADDRESS)` | éšè—æœ€åä¸€æ®µ | 192.168.1.100 | 192.168.1.* |
| `@Masked(ADDRESS)` | ä¿ç•™é¦–å°¾å„6ä¸ªå­—ç¬¦ | åŒ—äº¬å¸‚æœé˜³åŒºXXè·¯XXå· | åŒ—äº¬å¸‚æœ******å· |
| `@Masked(PASSWORD)` | å…¨éƒ¨éšè— | password123 | *********** |

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆé›†æˆåï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] Excelæ¨¡å‹ç±»æ·»åŠ @Maskedæ³¨è§£
- [ ] ä½¿ç”¨ExcelExportMaskingUtilå¯¼å‡º
- [ ] å¯¼å‡ºæ–‡ä»¶ä¸­æ•æ„Ÿä¿¡æ¯å·²è„±æ•
- [ ] æ•°æ®æ ¼å¼æ­£ç¡®ï¼ˆæ— ä¹±ç ï¼‰
- [ ] æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³
- [ ] ä¸åŒæƒé™ç”¨æˆ·å¯¼å‡ºç»“æœæ­£ç¡®
- [ ] æ€§èƒ½æµ‹è¯•ï¼š1000æ¡æ•°æ®å¯¼å‡ºæ—¶é—´<5ç§’

**éªŒè¯æ–¹æ³•**ï¼š

```bash
# 1. è°ƒç”¨å¯¼å‡ºæ¥å£
curl http://localhost:8080/api/v1/user/export -o ç”¨æˆ·æ•°æ®.xlsx

# 2. æ‰“å¼€Excelæ–‡ä»¶ï¼Œæ£€æŸ¥æ•æ„Ÿå­—æ®µæ˜¯å¦ä¸º****æ ¼å¼

# 3. æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤è„±æ•æ­£å¸¸
tail -f logs/ioe-dream.log | grep "å¯¼å‡ºè„±æ•"
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

### çŸ­æœŸè®¡åˆ’ï¼ˆ1-2å¤©ï¼‰
1. âœ… **æ ¸å¿ƒå·¥å…·ç±»å®Œæˆ** - DataMaskingUtilå·¥å…·ç±»
2. âœ… **æ—¥å¿—æ¡†æ¶é›†æˆå®Œæˆ** - DataMaskingConverter + Logbacké…ç½®
3. âœ… **å¯¼å‡ºåŠŸèƒ½é›†æˆå®Œæˆ** - @Maskedæ³¨è§£ + ExcelExportMaskingUtil
4. ğŸ”„ **æ›´æ–°APIæ¥å£** - ç”¨æˆ·ç›¸å…³æ¥å£æ·»åŠ è„±æ•

### ä¸­æœŸè®¡åˆ’ï¼ˆ2-3å¤©ï¼‰
5. ğŸ”„ **æƒé™æ§åˆ¶è„±æ•** - æ ¹æ®ç”¨æˆ·æƒé™å†³å®šæ˜¯å¦è„±æ•
6. ğŸ”„ **å‰ç«¯å±•ç¤ºè„±æ•** - å‰ç«¯ç»„ä»¶ç»Ÿä¸€è„±æ•æ˜¾ç¤º
7. ğŸ”„ **å•å…ƒæµ‹è¯•** - è„±æ•å·¥å…·ç±»å®Œæ•´æµ‹è¯•
8. ğŸ”„ **æ€§èƒ½æµ‹è¯•** - å¤§æ•°æ®é‡å¯¼å‡ºæ€§èƒ½ä¼˜åŒ–

---

**ğŸ‘¥ å®æ–½äºº**: IOE-DREAMå¼€å‘å›¢é˜Ÿ
**ğŸ“… å®Œæˆæ—¥æœŸ**: 2025-12-26
**âœ… éªŒæ”¶çŠ¶æ€**: å¯¼å‡ºè„±æ•é›†æˆå®Œæˆï¼Œå¾…æ¨å¹¿åˆ°æ‰€æœ‰å¯¼å‡ºåŠŸèƒ½
**ğŸ¯ ä¸‹ä¸€æ­¥**: é›†æˆåˆ°APIå±•ç¤ºå±‚
