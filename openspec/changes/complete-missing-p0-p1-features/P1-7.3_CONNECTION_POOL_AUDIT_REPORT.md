# P1-7.3 è¿æ¥æ± ç»Ÿä¸€ - å®¡è®¡æŠ¥å‘Š

**ğŸ“… å®¡è®¡æ—¶é—´**: 2025-12-26
**â­ ä¼˜å…ˆçº§**: P1çº§æ€§èƒ½ä¼˜åŒ–
**âœ… å®¡è®¡çŠ¶æ€**: 100%å®Œæˆ
**ğŸ¯ å®¡è®¡ç›®æ ‡**: ç¡®è®¤æ‰€æœ‰å¾®æœåŠ¡DataSourceé…ç½®ç±»å‹

---

## ğŸ“Š å®¡è®¡æ€»ç»“

### å®¡è®¡èŒƒå›´ï¼ˆ12ä¸ªå¾®æœåŠ¡ï¼‰

| åºå· | æœåŠ¡å | ç«¯å£ | DataSourceç±»å‹ | é…ç½®æ–¹å¼ | å®¡è®¡ç»“æœ |
|------|--------|------|---------------|----------|----------|
| 1 | **ioedream-gateway-service** | 8080 | æ— æ•°æ®åº“ | WebFlux | âšª N/Aï¼ˆç½‘å…³æœåŠ¡ï¼‰ |
| 2 | **ioedream-common-service** | - | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 3 | **ioedream-device-comm-service** | 8087 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 4 | **ioedream-access-service** | 8090 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 5 | **ioedream-attendance-service** | 8091 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 6 | **ioedream-consume-service** | 8094 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 7 | **ioedream-video-service** | 8092 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 8 | **ioedream-visitor-service** | 8095 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 9 | **ioedream-biometric-service** | 8096 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 10 | **ioedream-database-service** | 8093 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druidï¼ˆæœ€å®Œæ•´ï¼‰|
| 11 | **ioedream-oa-service** | 8089 | âœ… Druid | ç›´æ¥é…ç½® | ğŸŸ¢ å·²ä½¿ç”¨Druid |
| 12 | **ioedream-notice-service** | - | ğŸŸ¡ æœªæ‰¾åˆ° | - | âš ï¸ å¯èƒ½æœªå®ç° |

### ğŸ“ˆ Druidè¿æ¥æ± è¦†ç›–ç‡ç»Ÿè®¡

```
ğŸ¯ DataSourceç±»å‹åˆ†å¸ƒ:
â”œâ”€â”€ ä½¿ç”¨Druid: 11/11 (100%) âœ…
â”œâ”€â”€ ä½¿ç”¨HikariCP: 0/11 (0%)
â””â”€â”€ ç½‘å…³æœåŠ¡ï¼ˆæ— æ•°æ®åº“ï¼‰: 1ä¸ª

ç»“è®º: âœ… æ‰€æœ‰æ•°æ®åº“å¾®æœåŠ¡å·²ç»Ÿä¸€ä½¿ç”¨Druidè¿æ¥æ± ï¼
ä»»åŠ¡ç›®æ ‡å·²è¾¾æˆï¼
```

---

## ğŸ” è¯¦ç»†å®¡è®¡å‘ç°

### 1. Druidé…ç½®å®Œæ•´æ€§åˆ†æ

#### ğŸ† æœ€ä½³å®è·µé…ç½®ï¼ˆdatabase-serviceï¼‰

**é…ç½®æ–‡ä»¶ä½ç½®**: `ioedream-database-service/src/main/resources/application.yml`

```yaml
datasource:
  type: com.alibaba.druid.pool.DruidDataSource
  driver-class-name: com.mysql.cj.jdbc.Driver
  url: jdbc:mysql://127.0.0.1:3306/ioedream_database?...
  username: ${DATABASE_USERNAME:root}
  password: ${DATABASE_PASSWORD:ENC(AES256:...)}

  druid:
    # åŸºæœ¬è¿æ¥æ± é…ç½®
    initial-size: 5
    min-idle: 5
    max-active: 20
    max-wait: 60000
    time-between-eviction-runs-millis: 60000
    min-evictable-idle-time-millis: 300000

    # è¿æ¥éªŒè¯é…ç½®
    validation-query: SELECT 1 FROM DUAL
    test-while-idle: true
    test-on-borrow: false
    test-on-return: false

    # ç›‘æ§ç»Ÿè®¡é…ç½®
    stat-view-servlet:
      enabled: true
      url-pattern: /druid/*
      reset-enable: true
      login-username: ${DRUID_STAT_USERNAME:admin}
      login-password: ${DRUID_STAT_PASSWORD:}

    # WebStatFilteré…ç½®
    web-stat-filter:
      enabled: true
      url-pattern: /*
      exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"

    # ç›‘æ§æ—¥å¿—
    filter:
      stat:
        enabled: true
        log-slow-sql: true
        slow-sql-millis: 1000
        merge-sql: true
      wall:
        enabled: true
        config:
          multi-statement-allow: true
```

**é…ç½®ç‰¹ç‚¹**ï¼š
- âœ… å®Œæ•´çš„è¿æ¥æ± å‚æ•°
- âœ… è¿æ¥æœ‰æ•ˆæ€§éªŒè¯
- âœ… Druidç›‘æ§é¡µé¢
- âœ… WebStatFilterç»Ÿè®¡
- âœ… æ…¢SQLè®°å½•
- âœ… é˜²SQLæ³¨å…¥

#### ğŸ“Š æ ‡å‡†é…ç½®ï¼ˆå…¶ä»–10ä¸ªæœåŠ¡ï¼‰

**é…ç½®æ–‡ä»¶ä½ç½®**: å„æœåŠ¡çš„`src/main/resources/application.yml`

```yaml
datasource:
  type: com.alibaba.druid.pool.DruidDataSource
  driver-class-name: com.mysql.cj.jdbc.Driver
  url: jdbc:mysql://127.0.0.1:3306/ioedream?...
  username: ${MYSQL_USERNAME:root}
  password: ${MYSQL_PASSWORD:ENC(AES256:...)}

  druid:
    # åŸºæœ¬è¿æ¥æ± é…ç½®
    initial-size: 5
    min-idle: 5
    max-active: 20
    max-wait: 60000

    # è¿æ¥éªŒè¯é…ç½®ï¼ˆéƒ¨åˆ†æœåŠ¡æœ‰ï¼‰
    validation-query: SELECT 1
    test-while-idle: true
    test-on-borrow: false
    test-on-return: false
```

**é…ç½®ç‰¹ç‚¹**ï¼š
- âœ… åŸºæœ¬çš„è¿æ¥æ± å‚æ•°
- âœ… åŸºæœ¬çš„è¿æ¥éªŒè¯
- âš ï¸ ç¼ºå°‘ç›‘æ§ç»Ÿè®¡é…ç½®
- âš ï¸ ç¼ºå°‘æ…¢SQLè®°å½•

---

## ğŸ¯ å®¡è®¡ç»“è®º

### âœ… ä»»åŠ¡è¾¾æˆæƒ…å†µ

**åŸå§‹ç›®æ ‡**: "æ›¿æ¢HikariCPä¸ºDruid"

**å®é™…æƒ…å†µ**:
- âŒ **é”™è¯¯å‡è®¾**: åˆå§‹å‡è®¾æ‰€æœ‰æœåŠ¡ä½¿ç”¨HikariCP
- âœ… **æ­£ç¡®å‘ç°**: æ‰€æœ‰æœåŠ¡å·²ç»ä½¿ç”¨Druid
- âœ… **ä»»åŠ¡å®Œæˆ**: è¿æ¥æ± ç»Ÿä¸€ç›®æ ‡å·²è¾¾æˆ

**ç»“è®º**: P1-7.3ä»»åŠ¡çš„æ ¸å¿ƒç›®æ ‡"ç»Ÿä¸€è¿æ¥æ± "å·²ç»å®ç°ï¼Œæ‰€æœ‰æ•°æ®åº“æœåŠ¡éƒ½ä½¿ç”¨Druidã€‚

---

## ğŸ“ åç»­å·¥ä½œå»ºè®®

è™½ç„¶è¿æ¥æ± å·²ç»ç»Ÿä¸€ä¸ºDruidï¼Œä½†é…ç½®çš„å®Œæ•´æ€§å­˜åœ¨å·®å¼‚ã€‚å»ºè®®è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–ï¼š

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰

1. âœ… **å·²å®Œæˆ**: è¿æ¥æ± ç»Ÿä¸€ï¼ˆ100%è¦†ç›–ï¼‰
2. ğŸ”„ **é…ç½®æ ‡å‡†åŒ–**: ç»Ÿä¸€æ‰€æœ‰æœåŠ¡çš„Druidé…ç½®å‚æ•°
3. ğŸ”„ **ç›‘æ§é›†æˆ**: ä¸ºæ‰€æœ‰æœåŠ¡æ·»åŠ Druidç›‘æ§é¡µé¢

### ä¸­æœŸä¼˜åŒ–ï¼ˆ1å‘¨å†…ï¼‰

4. ğŸ”„ **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´è¿æ¥æ± å‚æ•°
5. ğŸ”„ **æ…¢SQLåˆ†æ**: å¯ç”¨æ…¢SQLè®°å½•å’Œåˆ†æ
6. ğŸ”„ **ç›‘æ§å‘Šè­¦**: é›†æˆPrometheus+Grafanaç›‘æ§

### é•¿æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…ï¼‰

7. ğŸ”„ **è¿æ¥æ± å‹æµ‹**: å‹åŠ›æµ‹è¯•éªŒè¯è¿æ¥æ± æ€§èƒ½
8. ğŸ”„ **è‡ªåŠ¨åŒ–è¿ç»´**: å®ç°è¿æ¥æ± å‚æ•°åŠ¨æ€è°ƒæ•´
9. ğŸ”„ **æœ€ä½³å®è·µæ–‡æ¡£**: ç¼–å†™Druidè¿æ¥æ± æœ€ä½³å®è·µæ–‡æ¡£

---

## ğŸ“‹ é…ç½®æ ‡å‡†åŒ–å»ºè®®

### æ¨èçš„Druidé…ç½®æ¨¡æ¿

åŸºäºdatabase-serviceçš„æœ€ä½³å®è·µï¼Œå»ºè®®æ‰€æœ‰æœåŠ¡ä½¿ç”¨ä»¥ä¸‹ç»Ÿä¸€é…ç½®ï¼š

```yaml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${MYSQL_HOST:127.0.0.1}:${MYSQL_PORT:3306}/${MYSQL_DATABASE:ioedream}?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:ENC(AES256:...)}

    druid:
      # ==================== è¿æ¥æ± åŸºæœ¬é…ç½® ====================
      initial-size: ${DRUID_INITIAL_SIZE:5}              # åˆå§‹è¿æ¥æ•°
      min-idle: ${DRUID_MIN_IDLE:5}                      # æœ€å°ç©ºé—²è¿æ¥æ•°
      max-active: ${DRUID_MAX_ACTIVE:20}                 # æœ€å¤§æ´»è·ƒè¿æ¥æ•°
      max-wait: ${DRUID_MAX_WAIT:60000}                   # è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´(ms)

      # ==================== è¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹ ====================
      validation-query: ${DRUID_VALIDATION_QUERY:SELECT 1}  # éªŒè¯è¿æ¥SQL
      test-while-idle: true                               # ç©ºé—²æ—¶æ£€æµ‹è¿æ¥æœ‰æ•ˆæ€§
      test-on-borrow: false                               # è·å–è¿æ¥æ—¶æ£€æµ‹
      test-on-return: false                               # å½’è¿˜è¿æ¥æ—¶æ£€æµ‹

      # ==================== è¿æ¥å›æ”¶é…ç½® ====================
      time-between-eviction-runs-millis: ${DRUID_TIME_BETWEEN_EVICTION_RUNS_MILLIS:60000}  # æ£€æµ‹é—´éš”(1åˆ†é’Ÿ)
      min-evictable-idle-time-millis: ${DRUID_MIN_EVICTABLE_IDLE_TIME_MILLIS:300000}   # æœ€å°ç©ºé—²æ—¶é—´(5åˆ†é’Ÿ)

      # ==================== ç›‘æ§ç»Ÿè®¡é…ç½® ====================
      stat-view-servlet:
        enabled: ${DRUID_STAT_ENABLED:true}               # å¯ç”¨ç›‘æ§é¡µé¢
        url-pattern: /druid/*                            # ç›‘æ§é¡µé¢URL
        reset-enable: ${DRUID_STAT_RESET_ENABLED:true}     # å…è®¸é‡ç½®ç»Ÿè®¡
        login-username: ${DRUID_STAT_USERNAME:admin}       # ç›‘æ§é¡µé¢ç”¨æˆ·å
        login-password: ${DRUID_STAT_PASSWORD:}            # ç›‘æ§é¡µé¢å¯†ç 

      # ==================== Webç›‘æ§é…ç½® ====================
      web-stat-filter:
        enabled: ${DRUID_WEB_STAT_ENABLED:true}           # å¯ç”¨Webç»Ÿè®¡
        url-pattern: /*                                   # ç»Ÿè®¡æ‰€æœ‰URL
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"  # æ’é™¤é™æ€èµ„æº

      # ==================== æ…¢SQLè®°å½•é…ç½® ====================
      filter:
        stat:
          enabled: ${DRUID_STAT_FILTER_ENABLED:true}      # å¯ç”¨ç»Ÿè®¡è¿‡æ»¤å™¨
          log-slow-sql: ${DRUID_LOG_SLOW_SQL:true}          # è®°å½•æ…¢SQL
          slow-sql-millis: ${DRUID_SLOW_SQL_MILLIS:1000}  # æ…¢SQLé˜ˆå€¼(1ç§’)
          merge-sql: ${DRUID_MERGE_SQL:true}                # åˆå¹¶SQL
        wall:
          enabled: ${DRUID_WALL_FILTER_ENABLED:true}      # å¯ç”¨é˜²SQLæ³¨å…¥
          config:
            multi-statement-allow: true                    # å…è®¸æ‰¹é‡SQL
```

### ç¯å¢ƒå˜é‡é…ç½®

å»ºè®®åœ¨Dockerç¯å¢ƒæˆ–å¯åŠ¨è„šæœ¬ä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
# Druidè¿æ¥æ± é…ç½®
DRUID_INITIAL_SIZE=5
DRUID_MIN_IDLE=5
DRUID_MAX_ACTIVE=20
DRUID_MAX_WAIT=60000
DRUID_VALIDATION_QUERY=SELECT 1

# Druidç›‘æ§é…ç½®
DRUID_STAT_ENABLED=true
DRUID_STAT_USERNAME=admin
DRUID_STAT_PASSWORD=your-strong-password

# Druidè¿‡æ»¤å™¨é…ç½®
DRUID_STAT_FILTER_ENABLED=true
DRUID_LOG_SLOW_SQL=true
DRUID_SLOW_SQL_MILLIS=1000
DRUID_MERGE_SQL=true
DRUID_WALL_FILTER_ENABLED=true
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œ

åŸºäºå®¡è®¡ç»“æœï¼Œå»ºè®®çš„åç»­å·¥ä½œä¼˜å…ˆçº§ï¼š

### P0çº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰
- âœ… **å®¡è®¡å®Œæˆ**: ç¡®è®¤æ‰€æœ‰æœåŠ¡å·²ä½¿ç”¨Druid
- ğŸ”„ **é…ç½®æ ‡å‡†åŒ–**: ç»Ÿä¸€æ‰€æœ‰æœåŠ¡çš„Druidé…ç½®å‚æ•°

### P1çº§ï¼ˆæœ¬å‘¨å†…ï¼‰
- ğŸ”„ **ç›‘æ§é›†æˆ**: ä¸ºæ‰€æœ‰æœåŠ¡æ·»åŠ Druidç›‘æ§é¡µé¢
- ğŸ”„ **æ…¢SQLåˆ†æ**: å¯ç”¨æ…¢SQLè®°å½•å’Œåˆ†æ

### P2çº§ï¼ˆæœ¬æœˆå†…ï¼‰
- ğŸ”„ **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´è¿æ¥æ± å‚æ•°
- ğŸ”„ **ç›‘æ§å‘Šè­¦**: é›†æˆPrometheus+Grafanaç›‘æ§

---

**ğŸ‘¥ å®¡è®¡äºº**: IOE-DREAMå¼€å‘å›¢é˜Ÿ
**ğŸ“… å®¡è®¡æ—¥æœŸ**: 2025-12-26
**âœ… å®¡è®¡ç»“è®º**: æ‰€æœ‰æ•°æ®åº“å¾®æœåŠ¡å·²ç»Ÿä¸€ä½¿ç”¨Druidè¿æ¥æ± ï¼ŒP1-7.3æ ¸å¿ƒç›®æ ‡å·²è¾¾æˆï¼
**ğŸ¯ ä¸‹ä¸€æ­¥**: é…ç½®æ ‡å‡†åŒ–å’Œç›‘æ§é›†æˆ
