# 消费模块完整企业级实现 - 任务清单

**Change ID**: consume-module-complete-implementation
**总工作量**: 140人日
**团队配置**: 2后端 + 1DBA + 1前端(配合) + 1测试
**预估时间**: 2.5个月

---

## 阶段一：数据库重构（P0级，20-22人日，3-4周）

### 1.1 核心表结构创建（8人日）

- [ ] **T1.1** 创建POSID_ACCOUNT表（账户主表）
  - 验证：Flyway脚本执行成功，表结构符合ER图
  - 依赖：无
  - 负责：后端开发1

- [ ] **T1.2** 创建POSID_ACCOUNTKIND表（账户类别表，含mode_config JSON字段）
  - 验证：mode_config字段可正确存储JSON数据
  - 依赖：T1.1
  - 负责：后端开发1

- [ ] **T1.3** 创建POSID_AREA表（区域表，含fixed_value_config JSON字段）
  - 验证：fixed_value_config字段可正确存储区域配置
  - 依赖：T1.1
  - 负责：后端开发1

- [ ] **T1.4** 创建POSID_MEAL和POSID_MEAL_CATEGORY表（餐别和餐别分类表）
  - 验证：餐别层级关系正确建立
  - 依赖：T1.1
  - 负责：后端开发2

- [ ] **T1.5** 创建POSID_TRANSACTION表（交易流水表，含月度分区）
  - 验证：分区策略正确，按月自动创建分区
  - 依赖：T1.1
  - 负责：DBA

- [ ] **T1.6** 创建POSID_SUBSIDY_TYPE表（补贴类型表）
  - 验证：补贴类型枚举值正确
  - 依赖：T1.1
  - 负责：后端开发2

- [ ] **T1.7** 创建POSID_SUBSIDY_ACCOUNT表（补贴账户表）
  - 验证：补贴账户与主账户关联正确
  - 依赖：T1.1, T1.6
  - 负责：后端开发2

- [ ] **T1.8** 创建POSID_SUBSIDY_FLOW表（补贴流水表）
  - 验证：补贴流水与补贴账户关联正确
  - 依赖：T1.7
  - 负责：后端开发2

- [ ] **T1.9** 创建POSID_RECHARGE_ORDER表（充值订单表，含月度分区）
  - 验证：分区策略正确，订单状态流转完整
  - 依赖：T1.1
  - 负责：后端开发1

- [ ] **T1.10** 创建POSID_CAPITAL_FLOW表（资金流水表，含月度分区）
  - 验证：分区策略正确，资金流水完整
  - 依赖：T1.1
  - 负责：DBA

### 1.2 JSON配置字段实现（4人日）

- [ ] **T1.11** 实现mode_config JSON字段读写
  - 验证：可正确读写6种消费模式配置
  - 依赖：T1.2
  - 负责：后端开发1

- [ ] **T1.12** 实现area_config JSON字段读写
  - 验证：可正确读写区域权限配置
  - 依赖：T1.3
  - 负责：后端开发1

- [ ] **T1.13** 实现fixed_value_config JSON字段读写
  - 验证：可正确读写定值配置
  - 依赖：T1.3
  - 负责：后端开发1

### 1.3 数据迁移脚本（5人日）

- [ ] **T1.14** 编写t_consume_account → POSID_ACCOUNT迁移脚本
  - 验证：测试环境迁移100条数据无丢失
  - 依赖：T1.1
  - 负责：DBA

- [ ] **T1.15** 编写t_consume_record → POSID_TRANSACTION迁移脚本
  - 验证：测试环境迁移1000条记录无丢失
  - 依赖：T1.5
  - 负责：DBA

- [ ] **T1.16** 编写t_consume_account_transaction → POSID_CAPITAL_FLOW迁移脚本
  - 验证：测试环境迁移500条流水无丢失
  - 依赖：T1.10
  - 负责：DBA

- [ ] **T1.17** 实现双写验证服务
  - 验证：新旧表数据一致性检查通过
  - 依赖：T1.14, T1.15, T1.16
  - 负责：后端开发1

### 1.4 数据迁移执行（3人日）

- [ ] **T1.18** 在测试环境执行完整数据迁移
  - 验证：所有数据迁移成功，无数据丢失
  - 依赖：T1.17
  - 负责：DBA

- [ ] **T1.19** 双写验证期监控（测试环境运行1周）
  - 验证：新旧表数据一致性≥99.9%
  - 依赖：T1.18
  - 负责：后端开发1 + 测试

- [ ] **T1.20** 切换到新表（测试环境）
  - 验证：所有功能正常运行
  - 依赖：T1.19
  - 负责：DBA + 后端开发1

---

## 阶段二：核心业务逻辑（P0级，28-30人日，4-5周）

### 2.1 消费模式策略实现（12人日）

- [ ] **T2.1** 实现ConsumeModeStrategy接口
  - 验证：接口定义正确，包含6种模式方法签名
  - 依赖：T1.20
  - 负责：后端开发1

- [ ] **T2.2** 实现FixedAmountModeStrategy（固定金额模式）
  - 验证：支持SIMPLE/KEYVALUE/SECTION三种子类型
  - 依赖：T2.1
  - 负责：后端开发1

- [ ] **T2.3** 实现FreeAmountModeStrategy（自由金额模式）
  - 验证：支持用户输入任意金额
  - 依赖：T2.1
  - 负责：后端开发1

- [ ] **T2.4** 实现MeteredModeStrategy（计量计费模式）
  - 验证：支持TIMING/COUNTING两种子类型
  - 依赖：T2.1
  - 负责：后端开发2

- [ ] **T2.5** 实现ProductModeStrategy（商品模式）
  - 验证：支持商品价格计算
  - 依赖：T2.1
  - 负责：后端开发2

- [ ] **T2.6** 实现OrderModeStrategy（订餐模式）
  - 验证：支持订餐流程
  - 依赖：T2.1
  - 负责：后端开发2

- [ ] **T2.7** 实现IntelligenceModeStrategy（智能模式）
  - 验证：支持AI推荐菜品
  - 依赖：T2.1
  - 负责：后端开发2

- [ ] **T2.8** 实现ConsumeModeManager（模式管理器）
  - 验证：可正确路由到对应策略
  - 依赖：T2.2~T2.7
  - 负责：后端开发1

### 2.2 定值计算优先级系统（6人日）

- [ ] **T2.9** 实现账户类别mode_config优先级（最高）
  - 验证：账户类别配置优先于区域配置
  - 依赖：T2.8
  - 负责：后端开发1

- [ ] **T2.10** 实现区域fixed_value_config优先级（中等）
  - 验证：区域配置优先于全局配置
  - 依赖：T2.8
  - 负责：后端开发1

- [ ] **T2.11** 实现系统全局默认配置（最低）
  - 验证：全局配置作为兜底
  - 依赖：T2.8
  - 负责：后端开发1

### 2.3 区域经营模式（6人日）

- [ ] **T2.12** 实现餐别制模式（manage_mode=1）
  - 验证：按餐别限制消费
  - 依赖：T2.8
  - 负责：后端开发2

- [ ] **T2.13** 实现超市制模式（manage_mode=2）
  - 验证：无餐别限制
  - 依赖：T2.8
  - 负责：后端开发2

- [ ] **T2.14** 实现混合模式（manage_mode=3）
  - 验证：支持餐别+超市混合
  - 依赖：T2.12, T2.13
  - 负责：后端开发2

### 2.4 权限验证逻辑（4人日）

- [ ] **T2.15** 实现area_config权限验证
  - 验证：可正确解析区域权限JSON
  - 依赖：T2.8
  - 负责：后端开发1

- [ ] **T2.16** 实现includeSubAreas子区域权限
  - 验证：子区域权限继承正确
  - 依赖：T2.15
  - 负责：后端开发1

---

## 阶段三：补贴系统（P0级，21-23人日，3-4周）

### 3.1 补贴账户体系（8人日）

- [ ] **T3.1** 实现补贴账户创建逻辑
  - 验证：可为用户创建多补贴账户
  - 依赖：T2.16
  - 负责：后端开发1

- [ ] **T3.2** 实现补贴账户与主账户关联
  - 验证：关联关系正确建立
  - 依赖：T3.1
  - 负责：后端开发1

- [ ] **T3.3** 实现补贴账户余额管理
  - 验证：余额增减正确
  - 依赖：T3.2
  - 负责：后端开发1

### 3.2 补贴扣款优先级（8人日）

- [ ] **T3.4** 实现SubsidyDeductionManager
  - 验证：可正确处理补贴扣款
  - 依赖：T3.3
  - 负责：后端开发1

- [ ] **T3.5** 实现"最近过期优先"策略
  - 验证：优先扣款即将过期的补贴
  - 依赖：T3.4
  - 负责：后端开发1

- [ ] **T3.6** 实现"金额最小优先"策略
  - 验证：同过期日期时优先扣款小金额
  - 依赖：T3.5
  - 负责：后端开发1

- [ ] **T3.7** 实现现金账户兜底扣款
  - 验证：补贴不足时扣款现金账户
  - 依赖：T3.6
  - 负责：后端开发1

### 3.3 补贴发放和清零（5人日）

- [ ] **T3.8** 实现补贴发放逻辑
  - 验证：补贴正确发放到指定账户
  - 依赖：T3.3
  - 负责：后端开发2

- [ ] **T3.9** 实现补贴清零逻辑
  - 验证：过期补贴正确清零
  - 依赖：T3.8
  - 负责：后端开发2

- [ ] **T3.10** 实现补贴流水记录
  - 验证：所有补贴操作完整记录
  - 依赖：T3.9
  - 负责：后端开发2

---

## 阶段四：分布式事务（P0级，14-16人日，2-3周）

### 4.1 SAGA事务编排器（8人日）

- [ ] **T4.1** 实现SagaTransactionManager
  - 验证：可正确编排SAGA事务
  - 依赖：T3.10
  - 负责：后端开发1

- [ ] **T4.2** 实现Step1：余额检查
  - 验证：余额不足时回滚
  - 依赖：T4.1
  - 负责：后端开发1

- [ ] **T4.3** 实现Step2：扣款
  - 验证：扣款失败时回滚
  - 依赖：T4.2
  - 负责：后端开发1

- [ ] **T4.4** 实现Step3：记录生成
  - 验证：记录生成失败时回滚
  - 依赖：T4.3
  - 负责：后端开发1

- [ ] **T4.5** 实现Step4：通知推送
  - 验证：通知失败不影响主流程
  - 依赖：T4.4
  - 负责：后端开发2

- [ ] **T4.6** 实现Step5：日志记录
  - 验证：日志完整记录
  - 依赖：T4.5
  - 负责：后端开发2

### 4.2 补偿机制（6人日）

- [ ] **T4.7** 实现扣款补偿（退款）
  - 验证：异常时正确退款
  - 依赖：T4.6
  - 负责：后端开发1

- [ ] **T4.8** 实现记录删除补偿
  - 验证：异常时正确删除记录
  - 依赖：T4.7
  - 负责：后端开发1

- [ ] **T4.9** 实现补偿日志记录
  - 验证：补偿操作完整记录
  - 依赖：T4.8
  - 负责：后端开发1

### 4.3 异常处理（2人日）

- [ ] **T4.10** 实现SAGA事务异常捕获
  - 验证：异常正确捕获和处理
  - 依赖：T4.9
  - 负责：后端开发1

- [ ] **T4.11** 实现SAGA事务重试机制
  - 验证：失败事务可重试
  - 依赖：T4.10
  - 负责：后端开发1

---

## 阶段五：性能优化（P1级，14-16人日，2-3周）

### 5.1 多级缓存策略（6人日）

- [ ] **T5.1** 实现账户余额L1本地缓存（Caffeine）
  - 验证：缓存命中率≥95%
  - 依赖：T4.11
  - 负责：后端开发1

- [ ] **T5.2** 实现账户余额L2 Redis缓存
  - 验证：Redis缓存有效期正确
  - 依赖：T5.1
  - 负责：后端开发1

- [ ] **T5.3** 实现账户类别配置缓存
  - 验证：mode_config缓存命中率≥90%
  - 依赖：T5.2
  - 负责：后端开发1

- [ ] **T5.4** 实现区域信息缓存
  - 验证：area_config缓存命中率≥90%
  - 依赖：T5.3
  - 负责：后端开发1

### 5.2 批量处理优化（4人日）

- [ ] **T5.5** 实现异步批量处理（50条/批）
  - 验证：批量处理提升性能≥3倍
  - 依赖：T5.4
  - 负责：后端开发2

- [ ] **T5.6** 实现批量查询优化
  - 验证：批量查询响应时间≤100ms
  - 依赖：T5.5
  - 负责：后端开发2

### 5.3 分布式锁（3人日）

- [ ] **T5.7** 实现Redisson分布式锁
  - 验证：锁超时和重入机制正确
  - 依赖：T5.6
  - 负责：后端开发1

- [ ] **T5.8** 实现账户并发扣锁
  - 验证：并发扣款无数据不一致
  - 依赖：T5.7
  - 负责：后端开发1

- [ ] **T5.9** 实现存折账户分片策略
  - 验证：分片策略均匀分布
  - 依赖：T5.8
  - 负责：后端开发1

### 5.4 性能压测验证（3人日）

- [ ] **T5.10** 编写性能压测脚本
  - 验证：压测场景覆盖完整
  - 依赖：T5.9
  - 负责：测试

- [ ] **T5.11** 执行性能压测（TPS ≥1000）
  - 验证：TPS达到1000+
  - 依赖：T5.10
  - 负责：测试 + 后端开发1

- [ ] **T5.12** 执行响应时间压测（avg ≤50ms, P99 ≤150ms）
  - 验证：响应时间达标
  - 依赖：T5.11
  - 负责：测试 + 后端开发1

---

## 阶段六：完善功能（P2级，14-16人日，2-3周）

### 6.1 统计报表（6人日）

- [ ] **T6.1** 实现日报表统计
  - 验证：日报表数据准确
  - 依赖：T5.12
  - 负责：后端开发2

- [ ] **T6.2** 实现月报表统计
  - 验证：月报表数据准确
  - 依赖：T6.1
  - 负责：后端开发2

- [ ] **T6.3** 实现年报表统计
  - 验证：年报表数据准确
  - 依赖：T6.2
  - 负责：后端开发2

### 6.2 监控指标（5人日）

- [ ] **T6.4** 实现TPS监控指标
  - 验证：TPS指标正确上报
  - 依赖：T6.3
  - 负责：后端开发1

- [ ] **T6.5** 实现成功率监控指标
  - 验证：成功率指标正确上报
  - 依赖：T6.4
  - 负责：后端开发1

- [ ] **T6.6** 实现延迟监控指标
  - 验证：延迟指标正确上报
  - 依赖：T6.5
  - 负责：后端开发1

### 6.3 告警规则（3人日）

- [ ] **T6.7** 实现TPS<500告警
  - 验证：告警正确触发
  - 依赖：T6.6
  - 负责：后端开发1

- [ ] **T6.8** 实现成功率<95%告警
  - 验证：告警正确触发
  - 依赖：T6.7
  - 负责：后端开发1

- [ ] **T6.9** 实现P99延迟>200ms告警
  - 验证：告警正确触发
  - 依赖：T6.8
  - 负责：后端开发1

### 6.4 文档完善（2人日）

- [ ] **T6.10** 更新API接口文档
  - 验证：文档与实现一致
  - 依赖：T6.9
  - 负责：后端开发1

- [ ] **T6.11** 编写运维手册
  - 验证：手册内容完整
  - 依赖：T6.10
  - 负责：后端开发1

---

## 验证标准

### 功能验证
- [ ] 所有9张核心表创建成功
- [ ] 6种消费模式全部实现并可配置
- [ ] 3种区域经营模式全部实现
- [ ] 补贴系统完整实现
- [ ] SAGA分布式事务正常工作
- [ ] 数据迁移100%成功

### 性能验证
- [ ] 消费TPS ≥ 1000
- [ ] 平均响应时间 ≤ 50ms
- [ ] P99响应时间 ≤ 150ms
- [ ] 缓存命中率 ≥ 90%

### 质量验证
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 集成测试覆盖率 ≥ 70%
- [ ] 代码规范检查100%通过
- [ ] 架构合规性检查100%通过

---

## 关键里程碑

| 里程碑 | 完成标准 | 预计完成时间 |
|--------|---------|-------------|
| M1: 数据库重构完成 | 测试环境切换到POSID_*表 | 第4周 |
| M2: 核心业务逻辑完成 | 6种模式+3种经营模式可用 | 第9周 |
| M3: 补贴系统完成 | 补贴账户和扣款优先级可用 | 第13周 |
| M4: 分布式事务完成 | SAGA事务正常工作 | 第16周 |
| M5: 性能优化完成 | 性能指标达标 | 第19周 |
| M6: 功能完善完成 | 所有功能可用，文档完整 | 第22周 |

---

## 并行化建议

### 可并行任务组
1. **T1.1~T1.10**：10个表创建可并行（不同开发人员）
2. **T2.2~T2.7**：6种消费模式可并行实现
3. **T2.12~T2.14**：3种经营模式可并行实现
4. **T3.1~T3.3** 与 **T3.8~T3.10**：账户体系和发放清零可并行

### 关键路径
T1.1 → T1.2~T1.10 → T1.14~T1.16 → T1.18~T1.20 → T2.1 → T2.8 → T2.9~T2.11 → T2.12~T2.14 → T2.15~T2.16 → T3.1~T3.7 → T4.1~T4.11 → T5.1~T5.12 → T6.1~T6.11

---

**备注**: 本任务清单遵循OpenSpec规范，每个任务都是小范围、可验证的工作项，并明确标注了依赖关系和负责人员。
