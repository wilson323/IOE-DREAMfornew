# ============================================================
# IOE-DREAM Zipkin配置文件
#
# @Author:    IOE-DREAM Team
# @Date:      2025-12-09
# @Description: Zipkin服务器详细配置
# ============================================================

# ============================================================
# 存储配置
# ============================================================
# 使用Elasticsearch作为存储后端
STORAGE_TYPE=elasticsearch

# Elasticsearch连接配置
ES_HOSTS=elasticsearch:9200
ES_USERNAME=elastic
ES_PASSWORD=changeme
ES_INDEX=zipkin
ES_INDEX_SHARDS=3
ES_INDEX_REPLICAS=1

# 连接池配置
ES_HTTP_MAX_CONNECTIONS=100
ES_HTTP_MAX_CONNECTIONS_PER_ROUTE=50
ES_CONNECTION_TIMEOUT=30000

# HTTP日志配置
ES_HTTP_LOGGING=body
ES_HTTP_LOGGING_HEADERS=headers
ES_HTTP_LOGGING_BODY=body

# ============================================================
# 服务器配置
# ============================================================
# 服务器端口配置
SERVER_PORT=9411
QUERY_PORT=9410
ADMIN_PORT=9411

# 服务器绑定地址
SERVER_ADDRESS=0.0.0.0

# 管理端点配置
MANAGEMENT_METRICS_EXPORT_ENABLED=true
MANAGEMENT_METRICS_EXPORT_TRACING_ENABLED=true
MANAGEMENT_METRICS_EXPORT_JVM_ENABLED=true

# ============================================================
# 采样配置
# ============================================================
# 全局采样率 (0.0 = 不采样, 1.0 = 100%采样)
# 生产环境建议: 0.1 (10%采样率)
SAMPLER_TYPE=ratelimiting
SAMPLER_PARAM=1

# 采样率限制器配置
SAMPLE_RATE=0.1
QUERY_SAMPLE_RATE=1.0

# ============================================================
# 查询配置
# ============================================================
# 查询超时配置
QUERY_LOOKBACK=86400000  # 24小时 (毫秒)
QUERY_ALLOWED-AGGREGATIONS=base.service
QUERY_DEFAULT-LOOKBACK=1800000  # 30分钟

# 查询限制配置
QUERY_MAX_NUM-AggregATIONS=3
QUERY_MAX_LOG-MESSAGE_LENGTH=1000

# ============================================================
# 存储配置（Elasticsearch特定）
# ============================================================
# Elasticsearch索引模板配置
ES_INDEX_DATE_SEPARATOR=-
ES_INDEX_DATE_PATTERN=yyyy-MM-dd

# 索引生命周期管理
ES_INDEX_LIFECYCLE_ENABLED=true
ES_INDEX_LIFECYCLE_NAME=zipkin-lifecycle
ES_INDEX_LIFECYCLE_ROLLOVER_SIZE=50
ES_INDEX_LIFECYCLE_SHARDS=3
ES_INDEX_LIFECYCLE_REPLICAS=1

# 压缩配置
ES_INDEX_COMPRESSION_ENABLED=true
ES_INDEX_CODEC=zstd

# ============================================================
# 监控和指标配置
# ============================================================
# Micrometer指标配置
management.metrics.export.prometheus.enabled=true
management.metrics.export.prometheus.step=30s

# 自定义指标配置
METRICS_ENABLED=true
METRICS_PORT=9412

# 健康检查配置
HEALTH_CHECK_ENABLED=true

# ============================================================
# 安全配置
# ============================================================
# 跨域配置
CORS_ALLOWED_ORIGINS=*
CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS

# 认证配置（可选）
AUTH_ENABLED=false
AUTH_USERNAME=admin
AUTH_PASSWORD=admin

# ============================================================
# 性能配置
# ============================================================
# JVM参数配置
JAVA_OPTS=-Xms512m -Xmx1024m -Djava.security.egd=file:/dev/./urandom

# 线程池配置
CATALINA_MAXTHREADS=200
CATALINA_MINSPARETHREADS=20

# 连接超时配置
SERVER_CONNECTION-TIMEOUT=20000
SERVER_CONNECTION-TIMEOUT-TOMCAT=20000

# ============================================================
# 日志配置
# ============================================================
# 日志级别
LOG_LEVEL=INFO

# 日志输出配置
LOGGING_LEVEL_ROOT=INFO
LOGGING_LEVEL_ORG_ZIPKIN=INFO
LOGGING_LEVEL_ORG_SPRINGFRAMEWORK=INFO

# 日志文件配置
LOGGING_FILE_NAME=zipkin.log
LOGGING_FILE_MAX-SIZE=100MB
LOGGING_FILE_MAX-HISTORY=30

# ============================================================
# 集成配置
# ============================================================
# 与Prometheus集成
PROMETHEUS_ENABLED=true
PROMETHEUS_PORT=9943

# 与Grafana集成
GRAFANA_DATASOURCE_NAME=Zipkin
GRAFANA_DATASOURCE_TYPE=prometheus

# 与ELK集成
ELK_ENABLED=true
ELK_HOST=elasticsearch:9200
ELK_INDEX_PATTERN=zipkin-*

# ============================================================
# 数据清理配置
# ============================================================
# 自动清理配置
CLEANUP_ENABLED=true
CLEANUP_INITIAL-DELAY=24h
CLEANUP_INTERVAL=24h

# 保留策略
CLEANUP_MAX-TIME-MILLIS=2592000000  # 30天
CLEANUP_MAX-DAYS=30

# ============================================================
# 开发环境配置
# ============================================================
spring:
  profiles:
    active: production

---
# 开发环境配置
spring:
  profiles:
    active: development

# 开发环境采样率更高
SAMPLER_PARAM=10
QUERY_SAMPLE_RATE=10.0

# 开发环境JVM参数
JAVA_OPTS_DEV=-Xms256m -Xmx512m -Djava.security.egd=file:/dev/./urandom

---
# 测试环境配置
spring:
  profiles:
    active: test

# 测试环境采样率中等
SAMPLER_PARAM=5
QUERY_SAMPLE_RATE=5.0

# 测试环境JVM参数
JAVA_OPTS_TEST=-Xms384m -Xmx768m -Djava.security.egd=file:/dev/./urandom