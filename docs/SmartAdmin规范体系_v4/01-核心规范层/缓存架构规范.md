# ç¼“å­˜æ¶æ„è§„èŒƒï¼ˆæƒå¨æ–‡æ¡£ï¼‰

> **ğŸ“‹ æ–‡æ¡£ç‰ˆæœ¬**: v4.0.0 (æ•´åˆç‰ˆ)
> **ğŸ“‹ æ–‡æ¡£èŒè´£**: SmartAdminé¡¹ç›®çš„å”¯ä¸€ç¼“å­˜è§„èŒƒæƒå¨æ¥æºï¼ŒåŸºäºRedisson 3.24.3å’ŒCaffeine 3.1.8ï¼Œè´´åˆé¡¹ç›®å®é™…æƒ…å†µã€‚

## âš ï¸ ç¼“å­˜é“å¾‹ï¼ˆä¸å¯è¿åï¼‰

### ğŸš« ç»å¯¹ç¦æ­¢
```markdown
âŒ ç¦æ­¢ç¼“å­˜æ•°æ®å˜æ›´åä¸æ¸…é™¤ç¼“å­˜
âŒ ç¦æ­¢ä½¿ç”¨ä¸è§„èŒƒç¼“å­˜é”®å‘½å
âŒ ç¦æ­¢ç¼“å­˜å¤§å¯¹è±¡ï¼ˆè¶…è¿‡1MBï¼‰
âŒ ç¦æ­¢ç¼“å­˜æ—¶é—´è®¾ç½®è¿‡é•¿ï¼ˆè¶…è¿‡24å°æ—¶ï¼‰
âŒ ç¦æ­¢ä¸å¤„ç†ç¼“å­˜ç©¿é€ã€é›ªå´©é—®é¢˜
âŒ ç¦æ­¢åœ¨Controllerå±‚ç›´æ¥æ“ä½œç¼“å­˜
âŒ ç¦æ­¢ç¼ºå°‘ç¼“å­˜ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
âŒ ç¦æ­¢ä½¿ç”¨Redis Keyså‘½ä»¤æ‰«ææ‰€æœ‰é”®
```

### âœ… å¿…é¡»æ‰§è¡Œ
```markdown
âœ… å¿…é¡»ä½¿ç”¨å¸¸é‡ç±»ç®¡ç†ç¼“å­˜é”®
âœ… å¿…é¡»åœ¨æ•°æ®å˜æ›´åç«‹å³æ¸…é™¤ç›¸å…³ç¼“å­˜
âœ… å¿…é¡»ä½¿ç”¨Redissonåˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿
âœ… å¿…é¡»ä½¿ç”¨Caffeineä½œä¸ºæœ¬åœ°ç¼“å­˜
âœ… å¿…é¡»è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
âœ… å¿…é¡»ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œæ€§èƒ½æŒ‡æ ‡
âœ… å¿…é¡»æœ‰ç¼“å­˜é™çº§å’Œç†”æ–­æœºåˆ¶
âœ… å¿…é¡»å®šæœŸæ¸…ç†æ— æ•ˆç¼“å­˜æ•°æ®
```

## ğŸ—ï¸ Redisson + Caffeine åŒçº§ç¼“å­˜æ¶æ„

### ç¼“å­˜å±‚æ¬¡ç»“æ„
```markdown
L1ç¼“å­˜ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰ï¼š
- æŠ€æœ¯æ ˆï¼šCaffeine 3.1.8
- ä½œç”¨èŒƒå›´ï¼šå•ä¸ªJVMå®ä¾‹
- ç¼“å­˜å®¹é‡ï¼šæœ€å¤§10000ä¸ªæ¡ç›®
- è¿‡æœŸæ—¶é—´ï¼š5åˆ†é’Ÿ
- ç”¨é€”ï¼šé«˜é¢‘çƒ­ç‚¹æ•°æ®ç¼“å­˜

L2ç¼“å­˜ï¼ˆåˆ†å¸ƒå¼ç¼“å­˜ï¼‰ï¼š
- æŠ€æœ¯æ ˆï¼šRedisson 3.24.3 + Redis 7.0+
- ä½œç”¨èŒƒå›´ï¼šæ•´ä¸ªé›†ç¾¤
- ç¼“å­˜å®¹é‡ï¼šæ ¹æ®Rediså†…å­˜é…ç½®
- è¿‡æœŸæ—¶é—´ï¼š30åˆ†é’Ÿ
- ç”¨é€”ï¼šè·¨å®ä¾‹å…±äº«æ•°æ®ç¼“å­˜

ç¼“å­˜æŸ¥è¯¢æµç¨‹ï¼š
1. å…ˆæŸ¥è¯¢Caffeineæœ¬åœ°ç¼“å­˜
2. æœªå‘½ä¸­åˆ™æŸ¥è¯¢Redissonåˆ†å¸ƒå¼ç¼“å­˜
3. æœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“
4. å›å¡«L2å’ŒL1ç¼“å­˜
```

### Redissoné…ç½®ç±»
```java
@Configuration
@EnableCaching
@Slf4j
public class CacheConfig {

    /**
     * Redissonå®¢æˆ·ç«¯é…ç½®
     */
    @Bean(destroyMethod = "shutdown")
    public RedissonClient redissonClient() {
        Config config = new Config();

        // å•æœºæ¨¡å¼
        config.useSingleServer()
              .setAddress("redis://localhost:6379")
              .setPassword("your_password")
              .setDatabase(0)
              .setConnectionPoolSize(64)
              .setConnectionMinimumIdleSize(10)
              .setIdleConnectionTimeout(10000)
              .setConnectTimeout(10000)
              .setTimeout(3000)
              .setRetryAttempts(3)
              .setRetryInterval(1500);

        // é›†ç¾¤æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
        /*
        config.useClusterServers()
              .addNodeAddress("redis://node1:6379", "redis://node2:6379", "redis://node3:6379")
              .setPassword("your_password")
              .setScanInterval(2000);
        */

        return Redisson.create(config);
    }

    /**
     * Caffeineæœ¬åœ°ç¼“å­˜é…ç½®
     */
    @Bean("caffeineCache")
    public CacheManager caffeineCacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
                .maximumSize(10000)
                .expireAfterWrite(5, TimeUnit.MINUTES)
                .recordStats()
                .removalListener((key, value, cause) -> {
                    log.info("Caffeineç¼“å­˜ç§»é™¤ï¼škey={}, value={}, cause={}", key, value, cause);
                }));
        return cacheManager;
    }

    /**
     * Redissonç¼“å­˜ç®¡ç†å™¨
     */
    @Bean("redissonCache")
    public CacheManager redissonCacheManager(RedissonClient redissonClient) {
        RedissonSpringCacheManager cacheManager = new RedissonSpringCacheManager(redissonClient);

        // é…ç½®ç¼“å­˜é…ç½®
        Map<String, CacheConfig> configMap = new HashMap<>();

        // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ - 30åˆ†é’Ÿè¿‡æœŸ
        configMap.put(SmartAdminCacheConst.USER_INFO,
                     new CacheConfig(30 * 60 * 1000, 10 * 60 * 1000));

        // èœå•æ ‘ç¼“å­˜ - 1å°æ—¶è¿‡æœŸ
        configMap.put(SmartAdminCacheConst.MENU_TREE,
                     new CacheConfig(60 * 60 * 1000, 15 * 60 * 1000));

        // å­—å…¸ç¼“å­˜ - 2å°æ—¶è¿‡æœŸ
        configMap.put(SmartAdminCacheConst.DICT_DATA,
                     new CacheConfig(2 * 60 * 60 * 1000, 30 * 60 * 1000));

        cacheManager.setCacheConfig(configMap);
        return cacheManager;
    }

    /**
     * åŒçº§ç¼“å­˜ç®¡ç†å™¨
     */
    @Bean("dualCacheManager")
    @Primary
    public CacheManager dualCacheManager(RedissonClient redissonClient,
                                       CacheManager caffeineCacheManager,
                                       CacheManager redissonCacheManager) {
        return new DualLevelCacheManager(caffeineCacheManager, redissonCacheManager, redissonClient);
    }
}
```

### åŒçº§ç¼“å­˜ç®¡ç†å™¨å®ç°
```java
@Slf4j
public class DualLevelCacheManager implements CacheManager {

    private final CacheManager l1CacheManager;  // Caffeine
    private final CacheManager l2CacheManager;  // Redisson
    private final RedissonClient redissonClient;

    public DualLevelCacheManager(CacheManager l1CacheManager,
                                CacheManager l2CacheManager,
                                RedissonClient redissonClient) {
        this.l1CacheManager = l1CacheManager;
        this.l2CacheManager = l2CacheManager;
        this.redissonClient = redissonClient;
    }

    @Override
    public Cache getCache(String name) {
        Cache l1Cache = l1CacheManager.getCache(name);
        Cache l2Cache = l2CacheManager.getCache(name);
        return new DualLevelCache(name, l1Cache, l2Cache, redissonClient);
    }

    @Override
    public Collection<String> getCacheNames() {
        Set<String> names = new HashSet<>();
        names.addAll(l1CacheManager.getCacheNames());
        names.addAll(l2CacheManager.getCacheNames());
        return names;
    }
}

@Slf4j
public class DualLevelCache implements Cache {

    private final String name;
    private final Cache l1Cache;  // æœ¬åœ°ç¼“å­˜
    private final Cache l2Cache;  // åˆ†å¸ƒå¼ç¼“å­˜
    private final RedissonClient redissonClient;

    public DualLevelCache(String name, Cache l1Cache, Cache l2Cache, RedissonClient redissonClient) {
        this.name = name;
        this.l1Cache = l1Cache;
        this.l2Cache = l2Cache;
        this.redissonClient = redissonClient;
    }

    @Override
    public String getName() {
        return name;
    }

    @Override
    public Object getNativeCache() {
        return l2Cache.getNativeCache();
    }

    @Override
    public ValueWrapper get(Object key) {
        // 1. å…ˆæŸ¥L1ç¼“å­˜
        ValueWrapper l1Value = l1Cache.get(key);
        if (l1Value != null) {
            log.debug("ç¼“å­˜å‘½ä¸­L1ï¼šcache={}, key={}", name, key);
            return l1Value;
        }

        // 2. é˜²ç¼“å­˜å‡»ç©¿ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”
        RLock lock = redissonClient.getLock("cache_lock:" + name + ":" + key);
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…1ç§’
            if (lock.tryLock(1, TimeUnit.SECONDS)) {
                // 3. æŸ¥L2ç¼“å­˜
                ValueWrapper l2Value = l2Cache.get(key);
                if (l2Value != null) {
                    log.debug("ç¼“å­˜å‘½ä¸­L2ï¼šcache={}, key={}", name, key);
                    // å›å¡«L1ç¼“å­˜
                    l1Cache.put(key, l2Value.get());
                    return l2Value;
                }
            } else {
                // è·å–é”å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•L1ç¼“å­˜
                Thread.sleep(50);
                l1Value = l1Cache.get(key);
                if (l1Value != null) {
                    return l1Value;
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.warn("è·å–ç¼“å­˜é”è¢«ä¸­æ–­ï¼šcache={}, key={}", name, key);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }

        log.debug("ç¼“å­˜æœªå‘½ä¸­ï¼šcache={}, key={}", name, key);
        return null;
    }

    @Override
    public <T> T get(Object key, Class<T> type) {
        ValueWrapper wrapper = get(key);
        return wrapper != null ? (T) wrapper.get() : null;
    }

    @Override
    public <T> T get(Object key, Callable<T> valueLoader) {
        ValueWrapper wrapper = get(key);
        if (wrapper != null) {
            return (T) wrapper.get();
        }

        // ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨valueLoaderåŠ è½½æ•°æ®
        RLock lock = redissonClient.getLock("cache_lock:" + name + ":" + key);
        try {
            if (lock.tryLock(3, TimeUnit.SECONDS)) {
                // åŒé‡æ£€æŸ¥
                wrapper = get(key);
                if (wrapper != null) {
                    return (T) wrapper.get();
                }

                // åŠ è½½æ•°æ®
                T value = valueLoader.call();
                if (value != null) {
                    put(key, value);
                }
                return value;
            } else {
                // è·å–é”å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
                Thread.sleep(100);
                wrapper = get(key);
                return wrapper != null ? (T) wrapper.get() : null;
            }
        } catch (Exception e) {
            log.error("ç¼“å­˜åŠ è½½å¼‚å¸¸ï¼šcache={}, key={}", name, key, e);
            throw new RuntimeException("ç¼“å­˜åŠ è½½å¼‚å¸¸", e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }

    @Override
    public void put(Object key, Object value) {
        if (value == null) {
            return;
        }

        // æ£€æŸ¥ç¼“å­˜å¯¹è±¡å¤§å°
        if (isLargeObject(value)) {
            log.warn("ç¼“å­˜å¯¹è±¡è¿‡å¤§ï¼Œè·³è¿‡ç¼“å­˜ï¼šcache={}, key={}, size={}MB",
                    name, key, getObjectSize(value) / 1024.0 / 1024.0);
            return;
        }

        // åŒæ—¶æ›´æ–°L1å’ŒL2ç¼“å­˜
        l1Cache.put(key, value);
        l2Cache.put(key, value);
        log.debug("ç¼“å­˜æ›´æ–°ï¼šcache={}, key={}", name, key);
    }

    @Override
    public void evict(Object key) {
        // åŒæ—¶æ¸…é™¤L1å’ŒL2ç¼“å­˜
        l1Cache.evict(key);
        l2Cache.evict(key);
        log.debug("ç¼“å­˜æ¸…é™¤ï¼šcache={}, key={}", name, key);
    }

    @Override
    public void clear() {
        l1Cache.clear();
        l2Cache.clear();
        log.info("ç¼“å­˜æ¸…ç©ºï¼šcache={}", name);
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå¤§å¯¹è±¡
     */
    private boolean isLargeObject(Object value) {
        try {
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(baos);
            oos.writeObject(value);
            oos.close();
            return baos.size() > 1024 * 1024; // 1MB
        } catch (Exception e) {
            log.warn("æ£€æŸ¥å¯¹è±¡å¤§å°å¼‚å¸¸", e);
            return true;
        }
    }

    /**
     * è·å–å¯¹è±¡å¤§å°
     */
    private long getObjectSize(Object value) {
        try {
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(baos);
            oos.writeObject(value);
            oos.close();
            return baos.size();
        } catch (Exception e) {
            log.warn("è·å–å¯¹è±¡å¤§å°å¼‚å¸¸", e);
            return 0;
        }
    }
}
```

## ğŸ“ ç¼“å­˜å¸¸é‡è§„èŒƒ

### SmartAdminç¼“å­˜å¸¸é‡ç±»
```java
public class SmartAdminCacheConst {

    // ==================== ç”¨æˆ·ç›¸å…³ç¼“å­˜ ====================
    public static final class User {
        /** ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ - 30åˆ†é’Ÿ */
        public static final String USER_INFO = "USER_INFO";

        /** ç”¨æˆ·æƒé™ç¼“å­˜ - 30åˆ†é’Ÿ */
        public static final String USER_PERMISSION = "USER_PERMISSION";

        /** ç”¨æˆ·è§’è‰²ç¼“å­˜ - 30åˆ†é’Ÿ */
        public static final String USER_ROLE = "USER_ROLE";

        /** ç”¨æˆ·èœå•ç¼“å­˜ - 30åˆ†é’Ÿ */
        public static final String USER_MENU = "USER_MENU";

        /** åœ¨çº¿ç”¨æˆ·ç¼“å­˜ - 24å°æ—¶ */
        public static final String ONLINE_USER = "ONLINE_USER";
    }

    // ==================== èœå•ç›¸å…³ç¼“å­˜ ====================
    public static final class Menu {
        /** èœå•æ ‘ç¼“å­˜ - 1å°æ—¶ */
        public static final String MENU_TREE = "MENU_TREE";

        /** èœå•åˆ—è¡¨ç¼“å­˜ - 1å°æ—¶ */
        public static final String MENU_LIST = "MENU_LIST";

        /** ç”¨æˆ·èœå•æ ‘ç¼“å­˜ - 30åˆ†é’Ÿ */
        public static final String USER_MENU_TREE = "USER_MENU_TREE";
    }

    // ==================== å­—å…¸ç›¸å…³ç¼“å­˜ ====================
    public static final class Dict {
        /** å­—å…¸æ•°æ®ç¼“å­˜ - 2å°æ—¶ */
        public static final String DICT_DATA = "DICT_DATA";

        /** å­—å…¸ç±»å‹ç¼“å­˜ - 2å°æ—¶ */
        public static final String DICT_TYPE = "DICT_TYPE";
    }

    // ==================== éƒ¨é—¨ç›¸å…³ç¼“å­˜ ====================
    public static final class Dept {
        /** éƒ¨é—¨æ ‘ç¼“å­˜ - 1å°æ—¶ */
        public static final String DEPT_TREE = "DEPT_TREE";

        /** éƒ¨é—¨åˆ—è¡¨ç¼“å­˜ - 1å°æ—¶ */
        public static final String DEPT_LIST = "DEPT_LIST";
    }

    // ==================== ç³»ç»Ÿé…ç½®ç¼“å­˜ ====================
    public static final class Config {
        /** ç³»ç»Ÿå‚æ•°ç¼“å­˜ - 2å°æ—¶ */
        public static final String SYS_CONFIG = "SYS_CONFIG";

        /** ç³»ç»Ÿå¸¸é‡ç¼“å­˜ - 2å°æ—¶ */
        public static final String SYS_CONST = "SYS_CONST";
    }

    // ==================== ä¸šåŠ¡æ¨¡å—ç¼“å­˜ ====================
    public static final class Business {
        /** ä¸šåŠ¡æ•°æ®ç¼“å­˜ - 30åˆ†é’Ÿ */
        public static final String BUSINESS_DATA = "BUSINESS_DATA";

        /** ç»Ÿè®¡æ•°æ®ç¼“å­˜ - 10åˆ†é’Ÿ */
        public static final String STATISTICS_DATA = "STATISTICS_DATA";
    }
}
```

## ğŸ”„ Managerå±‚ç¼“å­˜ç®¡ç†è§„èŒƒ

### æ ‡å‡†Manageræ¨¡æ¿
```java
@Service
@Slf4j
public class UserCacheManager {

    @Resource
    private UserDao userDao;

    @Resource
    private RedissonClient redissonClient;

    /**
     * æ¸…é™¤ç”¨æˆ·ç›¸å…³ç¼“å­˜ - æ•°æ®å˜æ›´åå¿…é¡»è°ƒç”¨
     */
    @CacheEvict(value = {
        SmartAdminCacheConst.User.USER_INFO,
        SmartAdminCacheConst.User.USER_PERMISSION,
        SmartAdminCacheConst.User.USER_ROLE,
        SmartAdminCacheConst.User.USER_MENU
    }, allEntries = true)
    public void removeUserCache(Long userId) {
        log.info("æ¸…é™¤ç”¨æˆ·ç¼“å­˜ï¼šuserId={}", userId);

        // æ¸…é™¤ç”¨æˆ·ç›¸å…³çš„åˆ†å¸ƒå¼é”
        String lockKey = "user_lock:" + userId;
        RLock lock = redissonClient.getLock(lockKey);
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¸¦ç¼“å­˜ç©¿é€ä¿æŠ¤ï¼‰
     */
    @Cacheable(value = SmartAdminCacheConst.User.USER_INFO, key = "#userId")
    @CachePenetrationProtect
    public UserEntity queryUserInfo(Long userId) {
        if (userId == null) {
            return null;
        }

        // é˜²æ­¢ç¼“å­˜ç©¿é€ï¼šç¼“å­˜ç©ºå€¼
        UserEntity user = userDao.selectById(userId);
        if (user == null) {
            // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç¼“å­˜ç©¿é€ï¼Œè¿‡æœŸæ—¶é—´è¾ƒçŸ­
            redissonClient.getBucket("user_null:" + userId).setAsync("NULL", 5, TimeUnit.MINUTES);
        }

        return user;
    }

    /**
     * è·å–ç”¨æˆ·æƒé™ç¼“å­˜
     */
    @Cacheable(value = SmartAdminCacheConst.User.USER_PERMISSION, key = "#userId")
    public List<String> queryUserPermission(Long userId) {
        // æŸ¥è¯¢ç”¨æˆ·æƒé™é€»è¾‘
        return userDao.queryUserPermissions(userId);
    }

    /**
     * è·å–ç”¨æˆ·è§’è‰²ç¼“å­˜
     */
    @Cacheable(value = SmartAdminCacheConst.User.USER_ROLE, key = "#userId")
    public List<String> queryUserRole(Long userId) {
        // æŸ¥è¯¢ç”¨æˆ·è§’è‰²é€»è¾‘
        return userDao.queryUserRoles(userId);
    }

    /**
     * æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
     */
    public Map<Long, UserEntity> batchQueryUserInfo(List<Long> userIds) {
        if (CollectionUtils.isEmpty(userIds)) {
            return new HashMap<>();
        }

        // åˆ†æ‰¹æŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æŸ¥è¯¢è¿‡å¤šæ•°æ®
        Map<Long, UserEntity> result = new HashMap<>();
        List<List<Long>> batches = Lists.partition(userIds, 100);

        for (List<Long> batch : batches) {
            List<UserEntity> users = userDao.selectBatchIds(batch);
            users.forEach(user -> result.put(user.getUserId(), user));
        }

        return result;
    }
}
```

### Serviceå±‚ç¼“å­˜åè°ƒæ¨¡å¼
```java
@Service
public class UserService {

    @Resource
    private UserDao userDao;

    @Resource
    private UserQueryService userQueryService;

    @Resource
    private UserCacheManager userCacheManager;

    /**
     * æ·»åŠ ç”¨æˆ· - æ¸…é™¤ç¼“å­˜
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<String> addUser(UserAddForm addForm) {
        try {
            // 1. ä¸šåŠ¡é€»è¾‘å¤„ç†
            UserEntity entity = SmartBeanUtil.copy(addForm, UserEntity.class);
            userDao.insert(entity);

            // 2. æ¸…é™¤ç¼“å­˜ - å¿…é¡»æ‰§è¡Œ
            userCacheManager.removeUserCache(entity.getUserId());

            // 3. æ¸…é™¤ç›¸å…³è”çš„ç¼“å­˜ï¼ˆå¦‚éƒ¨é—¨ç”¨æˆ·åˆ—è¡¨ç­‰ï¼‰
            this.clearRelatedCache(entity.getDeptId());

            log.info("ç”¨æˆ·æ·»åŠ æˆåŠŸï¼šuserId={}, userName={}", entity.getUserId(), entity.getUserName());
            return ResponseDTO.ok(entity.getUserId().toString());

        } catch (Exception e) {
            log.error("ç”¨æˆ·æ·»åŠ å¤±è´¥", e);
            throw new BusinessException("ç”¨æˆ·æ·»åŠ å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * æ›´æ–°ç”¨æˆ· - æ¸…é™¤ç¼“å­˜
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<String> updateUser(UserUpdateForm updateForm) {
        try {
            // 1. è·å–åŸå§‹ç”¨æˆ·ä¿¡æ¯
            UserEntity originalUser = userDao.selectById(updateForm.getUserId());
            if (originalUser == null) {
                throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
            }

            // 2. ä¸šåŠ¡é€»è¾‘å¤„ç†
            UserEntity entity = SmartBeanUtil.copy(updateForm, UserEntity.class);
            entity.setVersion(originalUser.getVersion());
            userDao.updateById(entity);

            // 3. æ¸…é™¤ç¼“å­˜ - å¿…é¡»æ‰§è¡Œ
            userCacheManager.removeUserCache(entity.getUserId());

            // 4. å¦‚æœéƒ¨é—¨å‘ç”Ÿå˜åŒ–ï¼Œæ¸…é™¤æ–°æ—§éƒ¨é—¨çš„ç¼“å­˜
            if (!Objects.equals(originalUser.getDeptId(), updateForm.getDeptId())) {
                this.clearRelatedCache(originalUser.getDeptId());
                this.clearRelatedCache(updateForm.getDeptId());
            }

            log.info("ç”¨æˆ·æ›´æ–°æˆåŠŸï¼šuserId={}, userName={}", entity.getUserId(), entity.getUserName());
            return ResponseDTO.ok();

        } catch (Exception e) {
            log.error("ç”¨æˆ·æ›´æ–°å¤±è´¥", e);
            throw new BusinessException("ç”¨æˆ·æ›´æ–°å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * åˆ é™¤ç”¨æˆ· - æ¸…é™¤ç¼“å­˜
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<String> deleteUser(Long userId) {
        try {
            // 1. è·å–ç”¨æˆ·ä¿¡æ¯
            UserEntity user = userDao.selectById(userId);
            if (user == null) {
                throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
            }

            // 2. ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆè½¯åˆ é™¤ï¼‰
            UserEntity entity = new UserEntity();
            entity.setUserId(userId);
            entity.setDeletedFlag(true);
            entity.setUpdateTime(LocalDateTime.now());
            userDao.updateById(entity);

            // 3. æ¸…é™¤ç¼“å­˜ - å¿…é¡»æ‰§è¡Œ
            userCacheManager.removeUserCache(userId);

            // 4. æ¸…é™¤éƒ¨é—¨ç›¸å…³ç¼“å­˜
            this.clearRelatedCache(user.getDeptId());

            log.info("ç”¨æˆ·åˆ é™¤æˆåŠŸï¼šuserId={}, userName={}", userId, user.getUserName());
            return ResponseDTO.ok();

        } catch (Exception e) {
            log.error("ç”¨æˆ·åˆ é™¤å¤±è´¥", e);
            throw new BusinessException("ç”¨æˆ·åˆ é™¤å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ… - ä½¿ç”¨ç¼“å­˜
     */
    public ResponseDTO<UserVO> queryUserDetail(Long userId) {
        // é€šè¿‡Managerå±‚è·å–ç¼“å­˜æ•°æ®
        UserEntity entity = userCacheManager.queryUserInfo(userId);
        if (entity == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }

        UserVO vo = SmartBeanUtil.copy(entity, UserVO.class);
        return ResponseDTO.ok(vo);
    }

    /**
     * æ¸…é™¤ç›¸å…³ç¼“å­˜
     */
    private void clearRelatedCache(Long deptId) {
        if (deptId != null) {
            // æ¸…é™¤éƒ¨é—¨ç”¨æˆ·åˆ—è¡¨ç¼“å­˜
            String deptUserKey = "dept_users:" + deptId;
            redissonClient.getKeys().deleteByPattern(deptUserKey + "*");
        }
    }
}
```

## ğŸ¯ æ ‘å½¢ç»“æ„ç¼“å­˜ä¼˜åŒ–

### èœå•æ ‘ç¼“å­˜ç®¡ç†
```java
@Service
@Slf4j
public class MenuCacheManager {

    @Resource
    private MenuDao menuDao;

    @Resource
    private RedissonClient redissonClient;

    /**
     * æ¸…é™¤èœå•ç›¸å…³ç¼“å­˜
     */
    @CacheEvict(value = {
        SmartAdminCacheConst.Menu.MENU_TREE,
        SmartAdminCacheConst.Menu.MENU_LIST
    }, allEntries = true)
    public void removeMenuCache() {
        log.info("æ¸…é™¤èœå•ç¼“å­˜");

        // æ¸…é™¤ç”¨æˆ·èœå•æ ‘ç¼“å­˜
        redissonClient.getKeys().deleteByPattern(SmartAdminCacheConst.User.USER_MENU_TREE + ":*");
    }

    /**
     * è·å–èœå•æ ‘ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
     */
    @Cacheable(value = SmartAdminCacheConst.Menu.MENU_TREE,
               key = "#parentId + '_' + #menuType + '_' + #status")
    public List<MenuTreeVO> queryMenuTree(Long parentId, Integer menuType, Boolean status) {
        // 1. ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰ç›¸å…³æ•°æ®ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®
        List<MenuEntity> allMenus = menuDao.queryByCondition(menuType, status, false);

        // 2. å†…å­˜ä¸­æ„å»ºæ ‘å½¢ç»“æ„
        return this.buildMenuTree(parentId, allMenus);
    }

    /**
     * è·å–ç”¨æˆ·èœå•æ ‘
     */
    @Cacheable(value = SmartAdminCacheConst.User.USER_MENU_TREE, key = "#userId")
    public List<MenuTreeVO> queryUserMenuTree(Long userId) {
        // 1. æŸ¥è¯¢ç”¨æˆ·æœ‰æƒé™çš„èœå•IDåˆ—è¡¨
        List<Long> menuIds = menuDao.queryMenuIdsByUserId(userId);

        if (CollectionUtils.isEmpty(menuIds)) {
            return new ArrayList<>();
        }

        // 2. æ‰¹é‡æŸ¥è¯¢èœå•ä¿¡æ¯
        List<MenuEntity> userMenus = menuDao.selectBatchIds(menuIds);

        // 3. è¿‡æ»¤å¹¶æ„å»ºæ ‘
        List<MenuEntity> availableMenus = userMenus.stream()
                .filter(menu -> menu.getStatus())
                .collect(Collectors.toList());

        return this.buildMenuTree(0L, availableMenus);
    }

    /**
     * æ„å»ºèœå•æ ‘ï¼ˆå†…å­˜ä¸­æ“ä½œï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰
     */
    private List<MenuTreeVO> buildMenuTree(Long parentId, List<MenuEntity> allMenus) {
        if (CollectionUtils.isEmpty(allMenus)) {
            return new ArrayList<>();
        }

        // 1. æŒ‰çˆ¶IDåˆ†ç»„ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
        Map<Long, List<MenuEntity>> menuMap = allMenus.stream()
                .collect(Collectors.groupingBy(MenuEntity::getParentId));

        // 2. è·å–ç›´æ¥å­èœå•
        List<MenuEntity> children = menuMap.getOrDefault(parentId, new ArrayList<>());

        // 3. è½¬æ¢ä¸ºVOå¹¶é€’å½’æ„å»ºå­æ ‘
        List<MenuTreeVO> treeList = new ArrayList<>();
        for (MenuEntity menu : children) {
            MenuTreeVO menuTree = SmartBeanUtil.copy(menu, MenuTreeVO.class);
            menuTree.setLabel(menu.getMenuName());
            menuTree.setValue(menu.getMenuId());

            // é€’å½’æ„å»ºå­èœå•
            List<MenuTreeVO> subMenus = this.buildMenuTree(menu.getMenuId(), allMenus);
            menuTree.setChildren(subMenus);

            treeList.add(menuTree);
        }

        // 4. æŒ‰sort_valueæ’åº
        treeList.sort(Comparator.comparing(MenuTreeVO::getSortValue, Comparator.nullsLast(Integer::compareTo)));

        return treeList;
    }
}
```

## ğŸ“Š ç¼“å­˜ç›‘æ§ä¸å‘Šè­¦

### ç¼“å­˜ç›‘æ§æŒ‡æ ‡
```java
@Component
@Slf4j
public class CacheMonitorService {

    @Resource
    private RedissonClient redissonClient;

    @Resource
    private CacheManager dualCacheManager;

    /**
     * ç›‘æ§ç¼“å­˜æŒ‡æ ‡
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void monitorCacheMetrics() {
        try {
            // 1. ç›‘æ§Redisè¿æ¥çŠ¶æ€
            this.monitorRedisConnection();

            // 2. ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
            this.monitorCacheHitRate();

            // 3. ç›‘æ§ç¼“å­˜å¤§å°
            this.monitorCacheSize();

            // 4. ç›‘æ§ç¼“å­˜æ€§èƒ½
            this.monitorCachePerformance();

        } catch (Exception e) {
            log.error("ç¼“å­˜ç›‘æ§å¼‚å¸¸", e);
        }
    }

    /**
     * ç›‘æ§Redisè¿æ¥çŠ¶æ€
     */
    private void monitorRedisConnection() {
        try {
            NodesGroup nodesGroup = redissonClient.getNodesGroup();
            Collection<Node> nodes = nodesGroup.getNodes();

            for (Node node : nodes) {
                boolean connected = node.isConnected();
                if (!connected) {
                    log.error("RedisèŠ‚ç‚¹è¿æ¥æ–­å¼€ï¼š{}", node);
                    alertService.sendAlert("RedisèŠ‚ç‚¹è¿æ¥æ–­å¼€", node.toString());
                }
            }
        } catch (Exception e) {
            log.error("ç›‘æ§Redisè¿æ¥çŠ¶æ€å¼‚å¸¸", e);
        }
    }

    /**
     * ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
     */
    private void monitorCacheHitRate() {
        try {
            // ç›‘æ§Caffeineç¼“å­˜å‘½ä¸­ç‡
            Cache caffeineCache = dualCacheManager.getCache(SmartAdminCacheConst.User.USER_INFO);
            if (caffeineCache instanceof DualLevelCache) {
                DualLevelCache dualCache = (DualLevelCache) caffeineCache;
                // è·å–Caffeineç»Ÿè®¡ä¿¡æ¯
                CacheStats stats = getCaffeineStats(dualCache);

                double hitRate = stats.hitRate();
                if (hitRate < 0.8) { // å‘½ä¸­ç‡ä½äº80%å‘Šè­¦
                    log.warn("ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼šcache={}, hitRate={}",
                            SmartAdminCacheConst.User.USER_INFO, hitRate);
                    alertService.sendAlert("ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½",
                            String.format("ç¼“å­˜ï¼š%sï¼Œå‘½ä¸­ç‡ï¼š%.2f%%",
                                    SmartAdminCacheConst.User.USER_INFO, hitRate * 100));
                }
            }

            // ç›‘æ§Redisç¼“å­˜å‘½ä¸­ç‡
            this.monitorRedisHitRate();

        } catch (Exception e) {
            log.error("ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å¼‚å¸¸", e);
        }
    }

    /**
     * ç›‘æ§ç¼“å­˜å¤§å°
     */
    private void monitorCacheSize() {
        try {
            // è·å–Rediså†…å­˜ä½¿ç”¨æƒ…å†µ
            RedisNodes<Node, RedisNode> redisNodes = redissonClient.getRedisNodes(redissonClient.getConfig().getCodec());

            for (RedisNode node : redisNodes) {
                NodeInfo info = node.getInfo();
                String memoryInfo = info.getMemory();

                // è§£æå†…å­˜ä½¿ç”¨ä¿¡æ¯
                if (memoryInfo.contains("used_memory_human:")) {
                    String usedMemory = memoryInfo.split("used_memory_human:")[1].split("\r")[0];
                    log.debug("Rediså†…å­˜ä½¿ç”¨ï¼šnode={}, usedMemory={}", node, usedMemory);

                    // å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜å‘Šè­¦
                    if (isMemoryUsageHigh(memoryInfo)) {
                        alertService.sendAlert("Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜",
                                "èŠ‚ç‚¹ï¼š" + node + "ï¼Œä½¿ç”¨å†…å­˜ï¼š" + usedMemory);
                    }
                }
            }

        } catch (Exception e) {
            log.error("ç›‘æ§ç¼“å­˜å¤§å°å¼‚å¸¸", e);
        }
    }

    /**
     * æ¸…ç†è¿‡æœŸç¼“å­˜
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void cleanExpiredCache() {
        try {
            log.info("å¼€å§‹æ¸…ç†è¿‡æœŸç¼“å­˜");

            // 1. æ¸…ç†è¿‡æœŸçš„ç©ºå€¼ç¼“å­˜
            this.cleanNullCache();

            // 2. æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶ç¼“å­˜
            this.cleanTempCache();

            // 3. æ¸…ç†å­¤ç«‹çš„ç¼“å­˜é”®
            this.cleanOrphanCache();

            log.info("è¿‡æœŸç¼“å­˜æ¸…ç†å®Œæˆ");

        } catch (Exception e) {
            log.error("æ¸…ç†è¿‡æœŸç¼“å­˜å¼‚å¸¸", e);
        }
    }

    /**
     * æ¸…ç†ç©ºå€¼ç¼“å­˜
     */
    private void cleanNullCache() {
        try {
            // æ¸…ç†è¿‡æœŸçš„ç©ºå€¼ç¼“å­˜
            RKeys keys = redissonClient.getKeys();
            Iterable<String> nullKeys = keys.getKeysByPattern("*_null:*");

            int cleanedCount = 0;
            for (String key : nullKeys) {
                RBucket<String> bucket = redissonClient.getBucket(key);
                if (!bucket.isExists()) {
                    keys.delete(key);
                    cleanedCount++;
                }
            }

            if (cleanedCount > 0) {
                log.info("æ¸…ç†ç©ºå€¼ç¼“å­˜ï¼š{}ä¸ª", cleanedCount);
            }

        } catch (Exception e) {
            log.error("æ¸…ç†ç©ºå€¼ç¼“å­˜å¼‚å¸¸", e);
        }
    }
}
```

### ç¼“å­˜æ€§èƒ½æµ‹è¯•å·¥å…·
```java
@Component
@Slf4j
public class CachePerformanceTest {

    @Resource
    private CacheManager cacheManager;

    /**
     * ç¼“å­˜æ€§èƒ½æµ‹è¯•
     */
    public void performanceTest() {
        String cacheName = SmartAdminCacheConst.User.USER_INFO;
        Cache cache = cacheManager.getCache(cacheName);

        int testCount = 10000;
        Long testKey = 1L;

        // é¢„çƒ­ç¼“å­˜
        cache.put(testKey, new UserEntity());

        // æµ‹è¯•ç¼“å­˜å‘½ä¸­æ€§èƒ½
        long startTime = System.nanoTime();
        for (int i = 0; i < testCount; i++) {
            cache.get(testKey);
        }
        long endTime = System.nanoTime();

        double avgTime = (endTime - startTime) / (double) testCount / 1_000_000; // è½¬æ¢ä¸ºæ¯«ç§’
        log.info("ç¼“å­˜æ€§èƒ½æµ‹è¯•ï¼šcache={}, count={}, avgTime={}ms", cacheName, testCount, avgTime);

        // æ€§èƒ½ä¸è¾¾æ ‡å‘Šè­¦
        if (avgTime > 1.0) { // å¹³å‡å“åº”æ—¶é—´è¶…è¿‡1ms
            alertService.sendAlert("ç¼“å­˜æ€§èƒ½ä¸è¾¾æ ‡",
                    String.format("ç¼“å­˜ï¼š%sï¼Œå¹³å‡å“åº”æ—¶é—´ï¼š%.2fms", cacheName, avgTime));
        }
    }
}
```

---

**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼š
1. **ä¸€è‡´æ€§ç¬¬ä¸€** - æ•°æ®å˜æ›´å¿…é¡»æ¸…é™¤ç¼“å­˜
2. **æ€§èƒ½ä¼˜å…ˆ** - åˆç†ä½¿ç”¨åŒçº§ç¼“å­˜æå‡æ€§èƒ½
3. **é˜²å‡»ç©¿ä¿æŠ¤** - ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿
4. **ç›‘æ§å®Œå–„** - å®æ—¶ç›‘æ§ç¼“å­˜æŒ‡æ ‡å’Œæ€§èƒ½
5. **é™çº§ä¿æŠ¤** - ç¼“å­˜å¼‚å¸¸æ—¶è¦æœ‰é™çº§æœºåˆ¶

**ğŸ“– ç›¸å…³æ–‡æ¡£**ï¼š
- [æ¶æ„è§„èŒƒ](./æ¶æ„è§„èŒƒ.md) - ç¼“å­˜æ¶æ„è®¾è®¡
- [ç¼–ç è§„èŒƒ](./ç¼–ç è§„èŒƒ.md) - ç¼“å­˜ç¼–ç è§„èŒƒ
- [å®‰å…¨è§„èŒƒ](./å®‰å…¨è§„èŒƒ.md) - ç¼“å­˜å®‰å…¨ç›¸å…³è§„èŒƒ
- [æ•°æ®è§„èŒƒ](./æ•°æ®è§„èŒƒ.md) - æ•°æ®ç¼“å­˜è§„èŒƒ