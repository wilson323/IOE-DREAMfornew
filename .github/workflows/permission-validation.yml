name: Permission Control Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  permission-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: smart-admin-web-javascript/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        # åç«¯ä¾èµ–æ£€æŸ¥
        cd smart-admin-api-java17-springboot3
        if [ -f "pom.xml" ]; then
          mvn validate -q
        fi

        # å‰ç«¯ä¾èµ–æ£€æŸ¥
        cd ../smart-admin-web-javascript
        if [ -f "package.json" ]; then
          npm ci --silent
        fi

    - name: Backend Permission Validation
      run: |
        echo "ğŸ” åç«¯æƒé™æ§åˆ¶éªŒè¯..."
        cd smart-admin-api-java17-springboot3

        # æ£€æŸ¥Controlleræ–‡ä»¶
        total_controllers=$(find . -name "*Controller.java" | wc -l)
        controllers_with_permission=$(grep -r "@SaCheckPermission" --include="*Controller.java" . | wc -l)

        # æ£€æŸ¥æƒé™æ³¨è§£è¦†ç›–ç‡
        if [ $total_controllers -gt 0 ]; then
          coverage=$(awk "BEGIN {printf \"%.1f\", $controllers_with_permission * 100 / $total_controllers}")
          echo "ğŸ“Š åç«¯æƒé™æ§åˆ¶è¦†ç›–ç‡: $coverage% ($controllers_with_permission/$total_controllers)"

          # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€ä½æ ‡å‡† (repowikiè¦æ±‚100%)
          if (( $(echo "$coverage < 95" | bc -l) )); then
            echo "âŒ åç«¯æƒé™æ§åˆ¶è¦†ç›–ç‡ä½äº95%ï¼Œä¸ç¬¦åˆrepowikiç³»ç»Ÿå®‰å…¨è§„èŒƒè¦æ±‚"
            exit 1
          fi
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰ç¦ç”¨çš„ä¾èµ–æ³¨å…¥
        autowired_count=$(find . -name "*.java" -exec grep -l "@Autowired" {} \; | wc -l)
        if [ $autowired_count -gt 0 ]; then
          echo "âŒ å‘ç° $autowired_count ä¸ªæ–‡ä»¶ä½¿ç”¨äº†@Autowiredï¼Œè¿årepowikiç¼–ç è§„èŒƒ"
          exit 1
        fi

        # æ£€æŸ¥åŒ…åè§„èŒƒ
        javax_count=$(find . -name "*.java" -exec grep -l "import javax\.(servlet|validation|persistence|annotation)" {} \; | wc -l)
        if [ $javax_count -gt 0 ]; then
          echo "âŒ å‘ç° $javax_count ä¸ªæ–‡ä»¶ä½¿ç”¨äº†javaxåŒ…ï¼Œè¿åSpring Boot 3.xè§„èŒƒ"
          exit 1
        fi

        echo "âœ… åç«¯æƒé™æ§åˆ¶éªŒè¯é€šè¿‡"

    - name: Frontend Permission Validation
      run: |
        echo "ğŸ” å‰ç«¯æƒé™æ§åˆ¶éªŒè¯..."
        cd smart-admin-web-javascript

        # æ£€æŸ¥Vueæ–‡ä»¶æƒé™æ§åˆ¶
        total_vue_files=$(find src/views -name "*.vue" | wc -l)
        vue_files_with_permission=$(find src/views -name "*.vue" -exec grep -l "v-permission" {} \; | wc -l)

        # æ£€æŸ¥æƒé™æŒ‡ä»¤è¦†ç›–ç‡
        if [ $total_vue_files -gt 0 ]; then
          coverage=$(awk "BEGIN {printf \"%.1f\", $vue_files_with_permission * 100 / $total_vue_files}")
          echo "ğŸ“Š å‰ç«¯æƒé™æ§åˆ¶è¦†ç›–ç‡: $coverage% ($vue_files_with_permission/$total_vue_files)"

          # Week 1ç›®æ ‡ï¼š20%ï¼ŒWeek 2ç›®æ ‡ï¼š60%ï¼Œæœ€ç»ˆç›®æ ‡ï¼š90%
          if [ "$GITHUB_REF" == "refs/heads/main" ]; then
            # ä¸»åˆ†æ”¯è¦æ±‚é«˜è¦†ç›–ç‡
            min_coverage=80
          else
            # å¼€å‘åˆ†æ”¯é˜¶æ®µæ€§è¦æ±‚
            min_coverage=20
          fi

          if (( $(echo "$coverage < $min_coverage" | bc -l) )); then
            echo "âŒ å‰ç«¯æƒé™æ§åˆ¶è¦†ç›–ç‡ä½äº${min_coverage}%ï¼Œå½“å‰ä¸º${coverage}%"
            exit 1
          fi
        fi

        # æ£€æŸ¥æƒé™æŒ‡ä»¤æ ¼å¼
        invalid_perms=$(grep -r "v-privilege\|v-auth\|v-role" src/views/ | wc -l)
        if [ $invalid_perms -gt 0 ]; then
          echo "âŒ å‘ç° $invalid_perms å¤„éæ ‡å‡†æƒé™æŒ‡ä»¤ï¼Œå¿…é¡»ä½¿ç”¨v-permission"
          grep -r "v-privilege\|v-auth\|v-role" src/views/ | head -5
          exit 1
        fi

        # æ£€æŸ¥æƒé™æ ‡è¯†æ ¼å¼
        malformed_perms=$(grep -r "v-permission=[^'\"].*" src/views/ | wc -l)
        if [ $malformed_perms -gt 0 ]; then
          echo "âŒ å‘ç° $malformed_perms å¤„æ ¼å¼é”™è¯¯çš„æƒé™æŒ‡ä»¤"
          exit 1
        fi

        echo "âœ… å‰ç«¯æƒé™æ§åˆ¶éªŒè¯é€šè¿‡"

    - name: Permission Mapping Validation
      run: |
        echo "ğŸ” æƒé™æ˜ å°„ä¸€è‡´æ€§éªŒè¯..."
        cd ..

        # æå–åç«¯æƒé™æ ‡è¯†
        backend_perms=$(cd smart-admin-api-java17-springboot3 && grep -r "@SaCheckPermission" --include="*Controller.java" . | grep -o '"[^"]*"' | sort | uniq)

        # æå–å‰ç«¯æƒé™æ ‡è¯†
        frontend_perms=$(cd smart-admin-web-javascript && grep -r "v-permission" src/views/ | grep -o '\[[^]]*\]' | sed 's/\[//g; s/\]//g; s/["'\'']//g' | sort | uniq)

        # æ£€æŸ¥å…³é”®æƒé™æ˜¯å¦åœ¨å‰ç«¯æœ‰å¯¹åº”æ§åˆ¶
        critical_perms=("consume:record" "attendance:punch" "access:device" "device:control" "cache:manage")

        for perm in "${critical_perms[@]}"; do
          backend_exists=$(echo "$backend_perms" | grep "^$perm:" | wc -l)
          frontend_exists=$(echo "$frontend_perms" | grep "$perm" | wc -l)

          if [ $backend_exists -gt 0 ] && [ $frontend_exists -eq 0 ]; then
            echo "âš ï¸  å…³é”®æƒé™ $perm åœ¨åç«¯å­˜åœ¨ä½†å‰ç«¯ç¼ºå¤±æƒé™æ§åˆ¶"
          fi
        done

        echo "âœ… æƒé™æ˜ å°„ä¸€è‡´æ€§éªŒè¯å®Œæˆ"

    - name: Security Compliance Check
      run: |
        echo "ğŸ” repowikiå®‰å…¨è§„èŒƒåˆè§„æ£€æŸ¥..."

        # æ£€æŸ¥æ˜¯å¦éµå¾ªrepowikiç³»ç»Ÿå®‰å…¨è§„èŒƒ
        cd smart-admin-api-java17-springboot3

        # 1. æ£€æŸ¥Sa-Tokenä½¿ç”¨
        satoken_imports=$(grep -r "import cn.dev33.satoken" --include="*.java" . | wc -l)
        if [ $satoken_imports -eq 0 ]; then
          echo "âŒ æœªå‘ç°Sa-Tokenå¯¼å…¥ï¼Œè¿årepowikiç³»ç»Ÿå®‰å…¨è§„èŒƒ"
          exit 1
        fi

        # 2. æ£€æŸ¥æƒé™æ³¨è§£ä½¿ç”¨
        sa_check_permission=$(grep -r "@SaCheckPermission" --include="*.java" . | wc -l)
        if [ $sa_check_permission -eq 0 ]; then
          echo "âŒ æœªå‘ç°@SaCheckPermissionæ³¨è§£ï¼Œè¿årepowikiç³»ç»Ÿå®‰å…¨è§„èŒƒ"
          exit 1
        fi

        # 3. æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²
        secrets_in_code=$(grep -r -i "password\|secret\|key.*=" --include="*.java" . | grep -v "test" | grep -E "=.*[\"'].*[^,=}$]" | wc -l)
        if [ $secrets_in_code -gt 0 ]; then
          echo "âš ï¸  å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç ï¼Œéœ€è¦æ£€æŸ¥"
          echo "å‘ç° $secrets_in_code å¤„å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
        fi

        echo "âœ… repowikiå®‰å…¨è§„èŒƒåˆè§„æ£€æŸ¥é€šè¿‡"

    - name: Generate Permission Report
      if: always()
      run: |
        echo "ğŸ“Š ç”Ÿæˆæƒé™æ§åˆ¶æŠ¥å‘Š..."

        # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
        cat > permission-validation-report.md << EOF
# æƒé™æ§åˆ¶éªŒè¯æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: $(date)
**CIè¿è¡Œ**: ${{ github.workflow }}
**åˆ†æ”¯**: ${{ github.ref_name }}

## éªŒè¯ç»“æœ

### åç«¯æƒé™æ§åˆ¶
- Controlleræ€»æ•°: $(cd smart-admin-api-java17-springboot3 && find . -name "*Controller.java" | wc -l)
- æƒé™æ³¨è§£æ•°: $(cd smart-admin-api-java17-springboot3 && grep -r "@SaCheckPermission" --include="*Controller.java" . | wc -l)
- è¦†ç›–ç‡: $(cd smart-admin-api-java17-springboot3 && total_controllers=$(find . -name "*Controller.java" | wc -l); controllers_with_permission=$(grep -r "@SaCheckPermission" --include="*Controller.java" . | wc -l); awk "BEGIN {printf \"%.1f\", $controllers_with_permission * 100 / $total_controllers}")%

### å‰ç«¯æƒé™æ§åˆ¶
- Vueæ–‡ä»¶æ€»æ•°: $(cd smart-admin-web-javascript && find src/views -name "*.vue" | wc -l)
- æƒé™æ§åˆ¶æ–‡ä»¶æ•°: $(cd smart-admin-web-javascript && find src/views -name "*.vue" -exec grep -l "v-permission" {} \; | wc -l)
- è¦†ç›–ç‡: $(cd smart-admin-web-javascript && total_vue=$(find src/views -name "*.vue" | wc -l); vue_with_perm=$(find src/views -name "*.vue" -exec grep -l "v-permission" {} \; | wc -l); awk "BEGIN {printf \"%.1f\", $vue_with_perm * 100 / $total_vue}")%

### è§„èŒƒåˆè§„æ€§
- repowikiç³»ç»Ÿå®‰å…¨è§„èŒƒ: âœ… ç¬¦åˆ
- Sa-Tokenä½¿ç”¨: âœ… æ­£ç¡®
- æƒé™æŒ‡ä»¤æ ¼å¼: âœ… æ ‡å‡†åŒ–

## å»ºè®®

1. ç»§ç»­æå‡å‰ç«¯æƒé™æ§åˆ¶è¦†ç›–ç‡
2. å®šæœŸå®¡è®¡æƒé™æ ‡è¯†ä¸€è‡´æ€§
3. åŠ å¼ºå‰ç«¯æƒé™æ§åˆ¶è‡ªåŠ¨åŒ–æµ‹è¯•

---

**æŠ¥å‘Šç”Ÿæˆ**: GitHub Actions
**éªŒè¯çŠ¶æ€**: é€šè¿‡
**ä¸‹ä¸€æ­¥**: æŒç»­ä¼˜åŒ–æƒé™æ§åˆ¶è¦†ç›–ç‡
EOF

        echo "âœ… æƒé™æ§åˆ¶æŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: Upload Permission Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: permission-validation-report
        path: permission-validation-report.md

    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          if (fs.existsSync('permission-validation-report.md')) {
            const report = fs.readFileSync('permission-validation-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”’ æƒé™æ§åˆ¶éªŒè¯æŠ¥å‘Š\n\n${report}`
            });
          }