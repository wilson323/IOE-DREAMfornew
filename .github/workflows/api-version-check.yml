name: API Version Check

on:
  push:
    branches: [ main, develop, new-clean-branch ]
  pull_request:
    branches: [ main, develop, new-clean-branch ]

jobs:
  api-version-check:
    runs-on: ubuntu-latest
    name: æ£€æŸ¥APIç‰ˆæœ¬è§„èŒƒ

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ javax.annotation ä½¿ç”¨ï¼ˆåº”ä½¿ç”¨ jakarta.annotationï¼‰
        run: |
          echo "ğŸ” æ£€æŸ¥ javax.annotation ä½¿ç”¨æƒ…å†µ..."
          VIOLATIONS=$(grep -r "import javax\.annotation\." microservices/ --include="*.java" || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ å‘ç°ä½¿ç”¨ javax.annotationï¼Œåº”ä½¿ç”¨ jakarta.annotation"
            echo "$VIOLATIONS"
            echo ""
            echo "ä¿®å¤æ–¹æ³•ï¼š"
            echo "  å°† 'import javax.annotation.Resource;'"
            echo "  æ”¹ä¸º 'import jakarta.annotation.Resource;'"
            exit 1
          fi

          echo "âœ… javax.annotation æ£€æŸ¥é€šè¿‡"

      - name: æ£€æŸ¥ javax.persistence ä½¿ç”¨ï¼ˆåº”ä½¿ç”¨ jakarta.persistenceï¼‰
        run: |
          echo "ğŸ” æ£€æŸ¥ javax.persistence ä½¿ç”¨æƒ…å†µ..."
          VIOLATIONS=$(grep -r "import javax\.persistence\." microservices/ --include="*.java" || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ å‘ç°ä½¿ç”¨ javax.persistenceï¼Œåº”ä½¿ç”¨ jakarta.persistence"
            echo "$VIOLATIONS"
            exit 1
          fi

          echo "âœ… javax.persistence æ£€æŸ¥é€šè¿‡"

      - name: æ£€æŸ¥ javax.validation ä½¿ç”¨ï¼ˆåº”ä½¿ç”¨ jakarta.validationï¼‰
        run: |
          echo "ğŸ” æ£€æŸ¥ javax.validation ä½¿ç”¨æƒ…å†µ..."
          VIOLATIONS=$(grep -r "import javax\.validation\." microservices/ --include="*.java" || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ å‘ç°ä½¿ç”¨ javax.validationï¼Œåº”ä½¿ç”¨ jakarta.validation"
            echo "$VIOLATIONS"
            exit 1
          fi

          echo "âœ… javax.validation æ£€æŸ¥é€šè¿‡"

      - name: æ£€æŸ¥ OpenAPI 3.1 API ä½¿ç”¨ï¼ˆåº”ä½¿ç”¨ OpenAPI 3.0ï¼‰
        run: |
          echo "ğŸ” æ£€æŸ¥ OpenAPI ç‰ˆæœ¬..."
          VIOLATIONS=$(grep -r "requiredMode" microservices/ --include="*.java" || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ å‘ç°ä½¿ç”¨ OpenAPI 3.1 API (requiredMode)ï¼Œåº”ä½¿ç”¨ OpenAPI 3.0 (required)"
            echo "$VIOLATIONS"
            echo ""
            echo "ä¿®å¤æ–¹æ³•ï¼š"
            echo "  å°† '@Schema(requiredMode = Schema.RequiredMode.REQUIRED)'"
            echo "  æ”¹ä¸º '@Schema(required = true)'"
            exit 1
          fi

          echo "âœ… OpenAPI ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡"

      - name: ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“Š APIç‰ˆæœ¬è§„èŒƒæ£€æŸ¥æŠ¥å‘Š"
          echo "====================="
          echo "âœ… Jakarta EE è¿ç§»çŠ¶æ€ï¼šå·²å®Œæˆ"
          echo "âœ… OpenAPI 3.0 ç»Ÿä¸€çŠ¶æ€ï¼šå·²å®Œæˆ"
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼šä»£ç ç¬¦åˆAPIç‰ˆæœ¬è§„èŒƒ"
