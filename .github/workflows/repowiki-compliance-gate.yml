name: repowiki Compliance Quality Gate

on:
  push:
    branches: [main, develop, IOE-DREAMforss]
  pull_request:
    branches: [main, develop]

jobs:
  repowiki-compliance-check:
    runs-on: ubuntu-latest
    name: repowiki è§„èŒƒåˆè§„æ€§æ£€æŸ¥

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run repowiki Quick Compliance Check
        run: |
          echo "ðŸ” å¼€å§‹æ‰§è¡Œ repowiki å¿«é€Ÿåˆè§„æ€§æ£€æŸ¥..."
          chmod +x scripts/repowiki-quick-check.sh
          bash scripts/repowiki-quick-check.sh

          # å¦‚æžœæ£€æŸ¥å¤±è´¥ï¼Œé€€å‡ºç ä¸º1ï¼ŒGitHub Actionsä¼šè‡ªåŠ¨å¤±è´¥
          if [ $? -ne 0 ]; then
            echo "âŒ repowiki åˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼"
            exit 1
          fi

          echo "âœ… repowiki åˆè§„æ€§æ£€æŸ¥é€šè¿‡"

      - name: Run repowiki Comprehensive Compliance Check
        run: |
          echo "ðŸ” å¼€å§‹æ‰§è¡Œ repowiki ç»¼åˆåˆè§„æ€§æ£€æŸ¥..."
          chmod +x scripts/repowiki-comprehensive-compliance-check.sh
          bash scripts/repowiki-comprehensive-compliance-check.sh

          # ç”Ÿæˆåˆè§„æ€§æŠ¥å‘Š
          echo "ðŸ“Š ç”Ÿæˆåˆè§„æ€§æ£€æŸ¥æŠ¥å‘Š..."
          ls -la compliance-reports/

      - name: Upload compliance reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: repowiki-compliance-reports
          path: compliance-reports/
          retention-days: 30

      - name: Compile Java project
        run: |
          echo "ðŸ”¨ ç¼–è¯‘ Java åŽç«¯é¡¹ç›®..."
          cd smart-admin-api-java17-springboot3
          mvn clean compile -DskipTests -q

          if [ $? -ne 0 ]; then
            echo "âŒ Java é¡¹ç›®ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
          fi

          echo "âœ… Java é¡¹ç›®ç¼–è¯‘æˆåŠŸ"

      - name: Check Jakarta EE Compliance
        run: |
          echo "ðŸ“¦ æ£€æŸ¥ Jakarta EE åˆè§„æ€§..."
          cd smart-admin-api-java17-springboot3

          javax_count=$(find . -name "*.java" -exec grep -l "javax\.(annotation|validation|persistence|servlet|jms|transaction|ejb)" {} \; | wc -l)
          if [ $javax_count -ne 0 ]; then
            echo "âŒ å‘çŽ° $javax_count ä¸ª Jakarta EE åˆè§„æ€§é—®é¢˜ï¼š"
            find . -name "*.java" -exec grep -l "javax\.(annotation|validation|persistence|servlet|jms|transaction|ejb)" {} \;
            exit 1
          fi

          echo "âœ… Jakarta EE åˆè§„æ€§æ£€æŸ¥é€šè¿‡"

      - name: Check Dependency Injection Compliance
        run: |
          echo "ðŸ”Œ æ£€æŸ¥ä¾èµ–æ³¨å…¥åˆè§„æ€§..."
          cd smart-admin-api-java17-springboot3

          autowired_count=$(find . -name "*.java" -exec grep -l "@Autowired" {} \; | wc -l)
          if [ $autowired_count -ne 0 ]; then
            echo "âŒ å‘çŽ° $autowired_count ä¸ª @Autowired è¿è§„ä½¿ç”¨ï¼š"
            find . -name "*.java" -exec grep -l "@Autowired" {} \;
            exit 1
          fi

          echo "âœ… ä¾èµ–æ³¨å…¥åˆè§„æ€§æ£€æŸ¥é€šè¿‡"

      - name: Check DAO Naming Convention
        run: |
          echo "ðŸ“ æ£€æŸ¥ DAO å‘½åè§„èŒƒ..."
          cd smart-admin-api-java17-springboot3

          repository_count=$(find . -name "*Repository.java" | wc -l)
          if [ $repository_count -ne 0 ]; then
            echo "âŒ å‘çŽ° $repository_count ä¸ª Repository æ–‡ä»¶éœ€è¦é‡å‘½åä¸º Daoï¼š"
            find . -name "*Repository.java"
            exit 1
          fi

          echo "âœ… DAO å‘½åè§„èŒƒæ£€æŸ¥é€šè¿‡"

      - name: Check Project Structure
        run: |
          echo "ðŸ—‚ï¸ æ£€æŸ¥é¡¹ç›®ç»“æž„è§„èŒƒ..."
          cd smart-admin-api-java17-springboot3

          nested_count=$(find . -path "*module/*/net/*" -type f | wc -l)
          if [ $nested_count -ne 0 ]; then
            echo "âŒ å‘çŽ° $nested_count ä¸ªå¼‚å¸¸åµŒå¥—è·¯å¾„ï¼š"
            find . -path "*module/*/net/*" -type f | head -10
            exit 1
          fi

          echo "âœ… é¡¹ç›®ç»“æž„è§„èŒƒæ£€æŸ¥é€šè¿‡"

      - name: Check Four-Layer Architecture Compliance
        run: |
          echo "ðŸ—ï¸ æ£€æŸ¥å››å±‚æž¶æž„åˆè§„æ€§..."
          cd smart-admin-api-java17-springboot3

          # æ£€æŸ¥ Controller ç›´æŽ¥è®¿é—® DAO
          direct_dao_count=$(grep -r "@Resource.*Dao" --include="*Controller.java" . | wc -l)
          if [ $direct_dao_count -ne 0 ]; then
            echo "âŒ å‘çŽ° $direct_dao_count å¤„ Controller ç›´æŽ¥è®¿é—® DAOï¼š"
            grep -r "@Resource.*Dao" --include="*Controller.java" .
            exit 1
          fi

          echo "âœ… å››å±‚æž¶æž„åˆè§„æ€§æ£€æŸ¥é€šè¿‡"

  frontend-quality-check:
    runs-on: ubuntu-latest
    name: å‰ç«¯è´¨é‡æ£€æŸ¥

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: smart-admin-web-javascript/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd smart-admin-web-javascript
          npm ci

      - name: Check frontend TypeScript
        run: |
          cd smart-admin-web-javascript
          npm run type-check

      - name: Check frontend ESLint
        run: |
          cd smart-admin-web-javascript
          npm run lint

      - name: Check frontend formatting
        run: |
          cd smart-admin-web-javascript
          npm run format:check

      - name: Build frontend project
        run: |
          cd smart-admin-web-javascript
          npm run build:prod

  security-and-performance:
    runs-on: ubuntu-latest
    name: å®‰å…¨ä¸Žæ€§èƒ½æ£€æŸ¥

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run security audit
        run: |
          echo "ðŸ”’ æ‰§è¡Œå®‰å…¨å®¡è®¡..."
          cd smart-admin-api-java17-springboot3

          # æ£€æŸ¥ç¡¬ç¼–ç å¯†ç 
          hardcoded_passwords=$(find . -name "*.java" -exec grep -l "password.*=" {} \; | wc -l)
          if [ $hardcoded_passwords -gt 5 ]; then
            echo "âš ï¸ å‘çŽ° $hardcoded_passwords ä¸ªå¯èƒ½çš„ç¡¬ç¼–ç å¯†ç ï¼Œè¯·æ£€æŸ¥"
            find . -name "*.java" -exec grep -Hn "password.*=" {} \; | head -5
          fi

          # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
          sensitive_info=$(find . -name "*.java" -exec grep -l "secret.*=\|key.*=\|token.*=" {} \; | wc -l)
          if [ $sensitive_info -gt 10 ]; then
            echo "âš ï¸ å‘çŽ° $sensitive_info ä¸ªå¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥"
          fi

      - name: Check code quality metrics
        run: |
          echo "ðŸ“Š æ£€æŸ¥ä»£ç è´¨é‡æŒ‡æ ‡..."
          cd smart-admin-api-java17-springboot3

          # æ£€æŸ¥ System.out ä½¿ç”¨
          systemout_count=$(find . -name "*.java" -exec grep -l "System\.out\.println" {} \; | wc -l)
          if [ $systemout_count -ne 0 ]; then
            echo "âŒ å‘çŽ° $systemout_count å¤„ System.out.println ä½¿ç”¨ï¼š"
            find . -name "*.java" -exec grep -Hn "System\.out\.println" {} \;
            exit 1
          fi

          # æ£€æŸ¥å¤æ‚åº¦ï¼ˆç®€å•çš„è¡Œæ•°æ£€æŸ¥ï¼‰
          high_complexity_files=$(find . -name "*.java" -exec wc -l {} \; | awk '$1 > 300 { print $2 }' | wc -l)
          if [ $high_complexity_files -gt 0 ]; then
            echo "âš ï¸ å‘çŽ° $high_complexity_files ä¸ªå¤§æ–‡ä»¶ï¼ˆ>300è¡Œï¼‰ï¼Œå»ºè®®é‡æž„"
          fi

  compliance-report:
    runs-on: ubuntu-latest
    name: ç”Ÿæˆåˆè§„æ€§æŠ¥å‘Š
    needs: [repowiki-compliance-check, frontend-quality-check, security-and-performance]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary report
        run: |
          echo "ðŸ“‹ ç”Ÿæˆ repowiki åˆè§„æ€§æ£€æŸ¥æ€»ç»“æŠ¥å‘Š..."

          cat > repowiki-compliance-summary.md << EOF
          # IOE-DREAM repowiki åˆè§„æ€§æ£€æŸ¥æŠ¥å‘Š

          ## æ£€æŸ¥æ—¶é—´
          - æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          - åˆ†æ”¯: ${{ github.ref }}
          - æäº¤: ${{ github.sha }}

          ## æ£€æŸ¥ç»“æžœ

          ### åŽç«¯åˆè§„æ€§æ£€æŸ¥
          - [âœ…] Jakarta EE åŒ…ååˆè§„æ€§
          - [âœ…] ä¾èµ–æ³¨å…¥è§„èŒƒ (@Resource)
          - [âœ…] DAO å‘½åè§„èŒƒ
          - [âœ…] é¡¹ç›®ç»“æž„è§„èŒƒ
          - [âœ…] å››å±‚æž¶æž„åˆè§„æ€§
          - [âœ…] Java é¡¹ç›®ç¼–è¯‘

          ### å‰ç«¯è´¨é‡æ£€æŸ¥
          - [âœ…] TypeScript ç±»åž‹æ£€æŸ¥
          - [âœ…] ESLint ä»£ç è§„èŒƒæ£€æŸ¥
          - [âœ…] ä»£ç æ ¼å¼åŒ–æ£€æŸ¥
          - [âœ…] å‰ç«¯é¡¹ç›®æž„å»º

          ### å®‰å…¨ä¸Žæ€§èƒ½æ£€æŸ¥
          - [âœ…] å®‰å…¨å®¡è®¡
          - [âœ…] ä»£ç è´¨é‡æŒ‡æ ‡æ£€æŸ¥

          ## åˆè§„æ€§çŠ¶æ€
          ðŸŽ‰ **æ‰€æœ‰æ£€æŸ¥é¡¹éƒ½å·²é€šè¿‡ï¼é¡¹ç›®ç¬¦åˆ repowiki è§„èŒƒè¦æ±‚ã€‚**

          ## è¯¦ç»†æŠ¥å‘Š
          è¯¦ç»†çš„åˆè§„æ€§æ£€æŸ¥æŠ¥å‘Šè¯·æŸ¥çœ‹ä¸‹è½½çš„æž„ä»¶æ–‡ä»¶ã€‚
          EOF

      - name: Upload summary report
        uses: actions/upload-artifact@v3
        with:
          name: repowiki-compliance-summary
          path: repowiki-compliance-summary.md
          retention-days: 90

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('repowiki-compliance-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });