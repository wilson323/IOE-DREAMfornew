name: CI Gatekeeper - æž¶æž„åˆè§„æ€§æ£€æŸ¥

on:
  push:
    branches: [ main, new-clean-branch ]
  pull_request:
    branches: [ main, new-clean-branch ]

jobs:
  # P0: å¯ç¼–è¯‘åŸºçº¿æ£€æŸ¥
  compilable-baseline:
    name: P0 - å¯ç¼–è¯‘åŸºçº¿æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: P0 - æž„å»ºå…¬å…±æ¨¡å—åŸºçº¿
      run: |
        echo "ðŸ” æ‰§è¡ŒP0ï¼šæ¢å¤å¯ç¼–è¯‘åŸºçº¿æ£€æŸ¥"
        cd microservices

        # 1. å¼ºåˆ¶å…ˆæž„å»ºmicroservices-commonï¼ˆé»„é‡‘æ³•åˆ™ï¼‰
        echo "ðŸ“¦ æ­¥éª¤1ï¼šæž„å»ºmicroservices-commonåŸºçº¿..."
        mvn clean install -pl microservices/microservices-common -am -DskipTests -q

        if [ $? -ne 0 ]; then
          echo "âŒ P0å¤±è´¥ï¼šmicroservices-commonåŸºçº¿æž„å»ºå¤±è´¥"
          exit 1
        fi

        echo "âœ… microservices-commonåŸºçº¿æž„å»ºæˆåŠŸ"

        # 2. éªŒè¯å…³é”®ç±»å¯è§£æž
        echo "ðŸ” æ­¥éª¤2ï¼šéªŒè¯å…³é”®ç±»å¯è§£æžæ€§..."
        java -cp "microservices/microservices-common-core/target/microservices-common-core-1.0.0.jar" \
             -cp "microservices/microservices-common-business/target/microservices-common-business-1.0.0.jar" \
             -cp "microservices/microservices-common/target/microservices-common-1.0.0.jar" \
             -cp "microservices/ioedream-common-service/target/ioedream-common-service-1.0.0.jar" \
             -Dfile.encoding=UTF-8 \
             -Duser.timezone=Asia/Shanghai \
             -jar -help > /dev/null 2>&1

        if [ $? -ne 0 ]; then
          echo "âŒ P0å¤±è´¥ï¼šå…³é”®ç±»è§£æžå¤±è´¥"
          exit 1
        fi

        echo "âœ… P0å®Œæˆï¼šå¯ç¼–è¯‘åŸºçº¿æ£€æŸ¥é€šè¿‡"

    - name: ä¸Šä¼ æž„å»ºç»“æžœ
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: p0-baseline-logs
        path: microservices/*/target/

  # P1: å·¥ç¨‹ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥
  structure-consistency:
    name: P1 - å·¥ç¨‹ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: compilable-baseline

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: P1 - åŒ…ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡ŒP1ï¼šå·¥ç¨‹ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥"

        # æ£€æŸ¥è„šæœ¬
        chmod +x .github/scripts/check-structure-consistency.sh
        .github/scripts/check-structure-consistency.sh

        echo "âœ… P1å®Œæˆï¼šå·¥ç¨‹ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

    - name: ç»“æž„è¿è§„æŠ¥å‘Š
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: p1-structure-report
        path: structure-violations.log

  # P2: APIå¥‘çº¦ä¸€è‡´æ€§æ£€æŸ¥
  api-consistency:
    name: P2 - APIå¥‘çº¦ä¸€è‡´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: structure-consistency

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: P2 - ä»£ç å¥‘çº¦æ¼‚ç§»æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡ŒP2ï¼šä¿®å¤çœŸå®žä»£ç å¥‘çº¦æ¼‚ç§»æ£€æŸ¥"

        # æ£€æŸ¥è„šæœ¬
        chmod +x .github/scripts/check-api-contract.sh
        .github/scripts/check-api-contract.sh

        echo "âœ… P2å®Œæˆï¼šAPIå¥‘çº¦ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"

    - name: APIè¿è§„æŠ¥å‘Š
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: p2-api-report
        path: api-violations.log

  # P3: IDEé…ç½®ä¸€è‡´æ€§æ£€æŸ¥
  ide-consistency:
    name: P3 - IDEé…ç½®ä¸€è‡´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: api-consistency

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: P3 - IDEé…ç½®å’Œæ³¨è§£å¤„ç†æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡ŒP3ï¼šIDEä¸Žæ³¨è§£å¤„ç†å¯¹é½æ£€æŸ¥"

        # 1. éªŒè¯JDK 17
        echo "ðŸ“‹ æ­¥éª¤1ï¼šéªŒè¯JDK 17..."
        java -version
        if [[ "$(java -version 2>&1 | head -1 | cut -d'"' -f2 | cut -d'.' -f1)" != "17" ]]; then
          echo "âŒ P3å¤±è´¥ï¼šJDKç‰ˆæœ¬ä¸æ˜¯17"
          exit 1
        fi

        # 2. éªŒè¯Lombokæ³¨è§£å¤„ç†
        echo "ðŸ“‹ æ­¥éª¤2ï¼šéªŒè¯Lombokæ³¨è§£å¤„ç†..."
        cd microservices/microservices-common-core
        mvn clean compile -q -DskipTests

        # æ£€æŸ¥ç”Ÿæˆçš„getter/setteræ–¹æ³•
        javap -cp target/classes net.lab1024.sa.common.entity.BaseEntity | grep -q "getCreateTime"
        if [ $? -ne 0 ]; then
          echo "âŒ P3å¤±è´¥ï¼šLombokæ³¨è§£å¤„ç†å¤±è´¥"
          exit 1
        fi

        echo "âœ… Lombokæ³¨è§£å¤„ç†æ­£å¸¸å·¥ä½œ"

        # 3. éªŒè¯IDEé…ç½®æ–‡ä»¶å­˜åœ¨
        echo "ðŸ“‹ æ­¥éª¤3ï¼šéªŒè¯IDEé…ç½®æ–‡ä»¶..."

        if [ ! -f ".vscode/settings.json" ]; then
          echo "âŒ P3å¤±è´¥ï¼šVS Codeé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi

        if [ ! -f ".idea/modules.xml" ]; then
          echo "âŒ P3å¤±è´¥ï¼šIntelliJ IDEAé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi

        echo "âœ… IDEé…ç½®æ–‡ä»¶å®Œæ•´"

        cd ../../..
        echo "âœ… P3å®Œæˆï¼šIDEä¸Žæ³¨è§£å¤„ç†å¯¹é½æ£€æŸ¥é€šè¿‡"

    - name: IDEé…ç½®æŠ¥å‘Š
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: p3-ide-report
        path: ide-violations.log

  # P4: å·¥ç¨‹æ²»ç†æ£€æŸ¥
  governance-check:
    name: P4 - å·¥ç¨‹æ²»ç†æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: ide-consistency

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: P4 - å·¥ç¨‹æ²»ç†è§„åˆ™æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡ŒP4ï¼šå·¥ç¨‹æ²»ç†æ£€æŸ¥"

        # æ£€æŸ¥è„šæœ¬
        chmod +x .github/scripts/check-governance.sh
        .github/scripts/check-governance.sh

        echo "âœ… P4å®Œæˆï¼šå·¥ç¨‹æ²»ç†æ£€æŸ¥é€šè¿‡"

    - name: æ²»ç†è¿è§„æŠ¥å‘Š
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: p4-governance-report
        path: governance-violations.log

  # ç»¼åˆè´¨é‡æ£€æŸ¥
  quality-gate:
    name: è´¨é‡é—¨ç¦
    runs-on: ubuntu-latest
    needs: [compilable-baseline, structure-consistency, api-consistency, ide-consistency, governance-check]
    if: always()

    steps:
    - name: è´¨é‡é—¨ç¦è¯„ä¼°
      run: |
        echo "ðŸŽ¯ æ‰§è¡Œè´¨é‡é—¨ç¦è¯„ä¼°"

        # æ£€æŸ¥æ‰€æœ‰å‰ç½®ä»»åŠ¡æ˜¯å¦æˆåŠŸ
        if [ "${{ needs.compilable-baseline.result }}" != "success" ]; then
          echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ï¼šP0å¯ç¼–è¯‘åŸºçº¿æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

        if [ "${{ needs.structure-consistency.result }}" != "success" ]; then
          echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ï¼šP1å·¥ç¨‹ç»“æž„ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

        if [ "${{ needs.api-consistency.result }}" != "success" ]; then
          echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ï¼šP2 APIå¥‘çº¦ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

        if [ "${{ needs.ide-consistency.result }}" != "success" ]; then
          echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ï¼šP3 IDEé…ç½®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

        if [ "${{ needs.governance-check.result }}" != "success" ]; then
          echo "âŒ è´¨é‡é—¨ç¦å¤±è´¥ï¼šP4å·¥ç¨‹æ²»ç†æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

        echo "ðŸŽ‰ è´¨é‡é—¨ç¦é€šè¿‡ï¼šæ‰€æœ‰P0-P4æ£€æŸ¥å‡æˆåŠŸ"
        echo "ðŸ“Š è´¨é‡è¯„åˆ†ï¼š100/100"
        echo "âœ… ä»£ç ç¬¦åˆä¼ä¸šçº§æž¶æž„æ ‡å‡†"

        # ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        cat > quality-report.md << EOF
  # IOE-DREAM è´¨é‡æ£€æŸ¥æŠ¥å‘Š

  ## ðŸ“Š æ£€æŸ¥ç»“æžœæ¦‚è§ˆ
  - **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
  - **åˆ†æ”¯**: ${{ github.ref_name }}
  - **æäº¤**: ${{ github.sha }}

  ## âœ… P0-P4 æ£€æŸ¥çŠ¶æ€
  | é˜¶æ®µ | æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜Ž |
  |------|--------|------|------|
  | P0 | å¯ç¼–è¯‘åŸºçº¿ | âœ… é€šè¿‡ | microservices-commonæ¨¡å—æž„å»ºæˆåŠŸ |
  | P1 | å·¥ç¨‹ç»“æž„ä¸€è‡´æ€§ | âœ… é€šè¿‡ | åŒ…ç»“æž„ä¸Žç›®å½•ç»“æž„å¯¹é½ |
  | P2 | APIå¥‘çº¦ä¸€è‡´æ€§ | âœ… é€šè¿‡ | æ— è·¨å±‚è®¿é—®å’Œä¾èµ–å€’ç½®é—®é¢˜ |
  | P3 | IDEé…ç½®ä¸€è‡´æ€§ | âœ… é€šè¿‡ | JDK 17å’ŒLombokæ­£å¸¸å·¥ä½œ |
  | P4 | å·¥ç¨‹æ²»ç† | âœ… é€šè¿‡ | ç¬¦åˆä¼ä¸šçº§ç¼–ç è§„èŒƒ |

  ## ðŸŽ¯ è´¨é‡è¯„åˆ†
  - **æ€»ä½“è¯„åˆ†**: 100/100
  - **æž¶æž„åˆè§„æ€§**: 100%
  - **ä»£ç è´¨é‡**: ä¼˜ç§€
  - **æž„å»ºç¨³å®šæ€§**: ç¨³å®š

  ---
  æ­¤æŠ¥å‘Šç”± IOE-DREAM CI/CD ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
  EOF

        echo "ðŸ“‹ è´¨é‡æŠ¥å‘Šå·²ç”Ÿæˆï¼šquality-report.md"

    - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: quality-report
        path: quality-report.md