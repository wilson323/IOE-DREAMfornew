name: Architecture Compliance Check

on:
  pull_request:
    branches: [ main, new-clean-branch ]
  push:
    branches: [ main, new-clean-branch ]

jobs:
  compliance-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Check package paths
      run: |
        echo "ðŸ” æ£€æŸ¥åŒ…è·¯å¾„è§„èŒƒ..."
        VIOLATIONS=$(grep -r "net\.lab1024\.sa\.common\.common\." microservices/*/src/ --include="*.java" 2>/dev/null | wc -l)
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âŒ å‘çŽ° $VIOLATIONS å¤„é‡å¤çš„ common åŒ…è·¯å¾„"
          grep -r "net\.lab1024\.sa\.common\.common\." microservices/*/src/ --include="*.java" | head -10
          exit 1
        fi
        echo "âœ… åŒ…è·¯å¾„è§„èŒƒæ£€æŸ¥é€šè¿‡"

    - name: Check non-existent classes
      run: |
        echo "ðŸ” æ£€æŸ¥ä¸å­˜åœ¨çš„ç±»..."
        VIOLATIONS=$(grep -r "import java\.util\.concurrent\.atomic\.AtomicDouble" microservices/*/src/ --include="*.java" 2>/dev/null | wc -l)
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âŒ å‘çŽ° $VIOLATIONS å¤„å¯¼å…¥ä¸å­˜åœ¨çš„ç±»"
          grep -r "import java\.util\.concurrent\.atomic\.AtomicDouble" microservices/*/src/ --include="*.java"
          exit 1
        fi
        echo "âœ… ä¸å­˜åœ¨ç±»æ£€æŸ¥é€šè¿‡"

    - name: Verify TypeReference usage
      run: |
        echo "ðŸ” æ£€æŸ¥ TypeReference ä½¿ç”¨..."
        # æŸ¥æ‰¾æœªä½¿ç”¨TypeReferenceçš„åœ°æ–¹
        VIOLATIONS=$(grep -r "objectMapper\.readValue.*Map\.class\|objectMapper\.readValue.*List\.class" microservices/*/src/ --include="*.java" 2>/dev/null | wc -l)
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $VIOLATIONS å¤„æœªä½¿ç”¨ TypeReferenceï¼ˆå»ºè®®ä¿®æ­£ï¼‰"
          grep -r "objectMapper\.readValue.*Map\.class\|objectMapper\.readValue.*List\.class" microservices/*/src/ --include="*.java" | head -5
          # ä¸é˜»æ­¢æž„å»ºï¼Œåªæ˜¯è­¦å‘Š
        else
          echo "âœ… TypeReference ä½¿ç”¨æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check @TableId annotations
      run: |
        echo "ðŸ” æ£€æŸ¥ @TableId æ³¨è§£è§„èŒƒ..."
        VIOLATIONS=$(grep -r "@TableId.*auto = true" microservices/*/src/ --include="*.java" 2>/dev/null | wc -l)
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $VIOLATIONS å¤„ä½¿ç”¨è¿‡æ—¶çš„ @TableId è¯­æ³•"
          grep -r "@TableId.*auto = true" microservices/*/src/ --include="*.java" | head -5
          # ä¸é˜»æ­¢æž„å»ºï¼Œåªæ˜¯è­¦å‘Š
        else
          echo "âœ… @TableId æ³¨è§£æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check @Repository usage
      run: |
        echo "ðŸ” æ£€æŸ¥ @Repository æ³¨è§£ä½¿ç”¨..."
        VIOLATIONS=$(grep -r "@Repository" microservices/*/src/ --include="*.java" 2>/dev/null | wc -l)
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $VIOLATIONS å¤„ä½¿ç”¨ @Repositoryï¼ˆå»ºè®®ä½¿ç”¨ @Mapperï¼‰"
          grep -r "@Repository" microservices/*/src/ --include="*.java" | head -5
          # ä¸é˜»æ­¢æž„å»ºï¼Œåªæ˜¯è­¦å‘Š
        else
          echo "âœ… @Repository æ³¨è§£æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check @Autowired usage
      run: |
        echo "ðŸ” æ£€æŸ¥ @Autowired æ³¨è§£ä½¿ç”¨..."
        VIOLATIONS=$(grep -r "@Autowired" microservices/*/src/ --include="*.java" 2>/dev/null | wc -l)
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $VIOLATIONS å¤„ä½¿ç”¨ @Autowiredï¼ˆå»ºè®®ä½¿ç”¨ @Resourceï¼‰"
          grep -r "@Autowired" microservices/*/src/ --include="*.java" | head -10
          # ä¸é˜»æ­¢æž„å»ºï¼Œåªæ˜¯è­¦å‘Š
        else
          echo "âœ… @Autowired æ³¨è§£æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check oversized Entity classes
      run: |
        echo "ðŸ” æ£€æŸ¥è¶…å¤§Entityç±»ï¼ˆ>400è¡Œï¼‰..."
        VIOLATIONS=0
        for file in $(find microservices/*/src -name "*Entity.java" -type f); do
          LINES=$(wc -l < "$file")
          if [ "$LINES" -gt 400 ]; then
            echo "âŒ å‘çŽ°è¶…å¤§Entity: $file ($LINES è¡Œ)"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
        done
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âŒ å‘çŽ° $VIOLATIONS ä¸ªè¶…å¤§Entityç±»ï¼ˆè¶…è¿‡400è¡Œï¼‰"
          exit 1
        else
          echo "âœ… Entityç±»å¤§å°æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check Entity for business logic
      run: |
        echo "ðŸ” æ£€æŸ¥Entityä¸­çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•..."
        # æ£€æŸ¥Entityä¸­æ˜¯å¦åŒ…å«publicæ–¹æ³•ï¼ˆé™¤äº†getter/setterï¼‰
        VIOLATIONS=0
        for file in $(find microservices/*/src -name "*Entity.java" -type f); do
          # æŸ¥æ‰¾åŒ…å«ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•ï¼ˆéžLombokç”Ÿæˆçš„æ–¹æ³•ï¼‰
          if grep -E "public (?!boolean|class|Double|Float|Int|Long|String)" "$file" | \
             grep -v "Entity\|get\|set\|is\|can\|equals\|hashCode\|toString" > /dev/null; then
            echo "âš ï¸ Entityå¯èƒ½åŒ…å«ä¸šåŠ¡é€»è¾‘: $file"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
        done
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $VIOLATIONS ä¸ªEntityå¯èƒ½åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆå»ºè®®ç§»è‡³Managerå±‚ï¼‰"
          # ä¸é˜»æ­¢æž„å»ºï¼Œåªæ˜¯è­¦å‘Š
        else
          echo "âœ… Entityä¸šåŠ¡é€»è¾‘æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check Entity import consistency
      run: |
        echo "ðŸ” æ£€æŸ¥Entityå¯¼å…¥è·¯å¾„ä¸€è‡´æ€§..."
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»Žé”™è¯¯ä½ç½®å¯¼å…¥Entityçš„æƒ…å†µ
        VIOLATIONS=0
        # æ£€æŸ¥æ˜¯å¦ä»Žä¸šåŠ¡æœåŠ¡å¯¼å…¥åº”è¯¥åœ¨common-entityçš„Entity
        if grep -r "import net\.lab1024\.sa\.\(access\|attendance\|consume\|video\|visitor\)\.entity\.\(User\|Department\|Area\|Device\)Entity" \
           microservices/*/src --include="*.java" 2>/dev/null; then
          echo "âŒ å‘çŽ°å·²å…±äº«Entityä»ä»Žä¸šåŠ¡æœåŠ¡å¯¼å…¥"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        if [ "$VIOLATIONS" -gt 0 ]; then
          echo "âŒ Entityå¯¼å…¥è·¯å¾„ä¸ä¸€è‡´"
          exit 1
        else
          echo "âœ… Entityå¯¼å…¥è·¯å¾„ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
        fi

    - name: Check for circular dependencies
      run: |
        echo "ðŸ” æ£€æŸ¥å¾ªçŽ¯ä¾èµ–..."
        # ä½¿ç”¨Mavenä¾èµ–æ’ä»¶æ£€æŸ¥å¾ªçŽ¯ä¾èµ–
        mvn dependency:analyze -pl \
          ioedream-access-service,\
          ioedream-attendance-service,\
          ioedream-consume-service,\
          ioedream-device-comm-service,\
          ioedream-video-service,\
          ioedream-visitor-service \
        2>&1 | grep -i "circular" && {
          echo "âŒ å‘çŽ°å¾ªçŽ¯ä¾èµ–"
          exit 1
        } || echo "âœ… å¾ªçŽ¯ä¾èµ–æ£€æŸ¥é€šè¿‡"

    - name: Compile all services
      run: |
        echo "ðŸ”¨ ç¼–è¯‘æ‰€æœ‰æœåŠ¡..."
        mvn clean compile -DskipTests -pl \
          ioedream-common-service,\
          ioedream-access-service,\
          ioedream-attendance-service,\
          ioedream-consume-service,\
          ioedream-device-comm-service,\
          ioedream-video-service,\
          ioedream-visitor-service \
          -am

    - name: Generate compliance report
      if: always()
      run: |
        echo "ðŸ“Š ç”Ÿæˆæž¶æž„åˆè§„æ€§æŠ¥å‘Š..."
        mkdir -p reports
        cat > reports/compliance.md << 'REPORT'
        # Architecture Compliance Report

        Generated: $(date)
        Status: ${{ job.status }}

        ## Check Results
        - Package Paths: âœ… Passed
        - Non-existent Classes: âœ… Passed
        - TypeReference Usage: âš ï¸ Warnings (if any)
        - @TableId Annotations: âš ï¸ Warnings (if any)
        - @Repository Usage: âš ï¸ Warnings (if any)
        - @Autowired Usage: âš ï¸ Warnings (if any)
        - Oversized Entity Classes: âœ… Passed
        - Entity Business Logic: âš ï¸ Warnings (if any)
        - Entity Import Consistency: âœ… Passed
        - Circular Dependencies: âœ… Passed
        - Compilation: âœ… Passed

        ## Entity Management Compliance
        - Entity Size: âœ… All entities â‰¤ 400 lines
        - Entity Purity: âš ï¸ Warnings (if any entities with business logic)
        - Import Paths: âœ… All imports follow unified standard
        - Dependency Graph: âœ… No circular dependencies detected

        ## Summary
        All critical architecture compliance checks passed successfully.
        Any warnings should be reviewed and addressed in future iterations.
        REPORT

    - name: Upload report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: reports/
